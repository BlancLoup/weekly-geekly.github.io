<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Resource Management with Explicit Template Specializations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RAII is one of the most important and useful idioms in C ++. RAII frees the programmer from manual resource management, without it it is extremely dif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Resource Management with Explicit Template Specializations</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/pt/blog/255487/"><img src="https://habrastorage.org/files/50a/5cb/193/50a5cb1937d744028c6d054be8a67b1d.jpg"></a> <br><br>  <a href="http://en.wikibooks.org/wiki/More_C%2B%2B_Idioms/Resource_Acquisition_Is_Initialization">RAII</a> is one of the most important and useful idioms in C ++.  RAII frees the programmer from manual resource management, without it it is extremely difficult to write code that is <a href="http://en.wikipedia.org/wiki/Exception_safety">safe from the point of view of exceptions</a> .  Perhaps the most popular use of RAII is managing dynamically allocated memory using <a href="http://en.wikipedia.org/wiki/Smart_pointer">smart pointers</a> , but it can also be successfully applied to other resources, especially in the world of low-level libraries.  Examples include Windows API descriptors, POSIX file descriptors, OpenGL primitives, and the like. <a name="habracut"></a><br><br><h4>  Options for implementing RAII </h4><br>  If we decide to write a RAII wrapper for some resource, we have several possibilities: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  write a specific wrapper class for a specific type of resource; </li><li> use a smart standard library pointer with a custom cleanup object (for example, <code>std::unique_ptr&lt;Handle, HandleDeleter&gt;</code> ); </li><li>  implement your generic wrapper class. </li></ul><br>  The first option is to write a specialized wrapper class - at first it may seem quite reasonable and really is a good starting point.  The simplest RAII wrapper might look something like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScopedResource</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ScopedResource() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ScopedResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Resource resource)</span></span></span><span class="hljs-function"> : resource_</span></span>{ resource } {} ScopedResource(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ScopedResource&amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; ScopedResource&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ScopedResource&amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; ~ScopedResource() { DestroyResource(resource_); } <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Resource&amp;() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resource_; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Resource resource_{}; };</code> </pre><br>  However, as our code base increases in size, the number of resources that need to be monitored increases.  Sooner or later we will notice that most of the wrapper classes are slightly different from each other: as a rule, the only difference is the resource release function.  This approach provokes error-prone code reuse in the "copy / paste" style.  On the other hand, we see here an excellent opportunity for <i>generalization</i> , which brings us to the next option - the use of smart pointers. <br><br>  A smart pointer implemented as a class template is a generic resource management solution.  However, he also has flaws, as we will see soon.  As their name says, smart pointers were created primarily for memory management, and as a result, their use with other resources often leads to at least inconvenience.  Let's look at smart pointers in more detail. <br><br><h4>  Why smart pointers are not so smart </h4><br>  Consider the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;memory&gt; // From low-level API. using Handle = void*; Handle CreateHandle() { Handle h{ nullptr }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // error: expected argument of type void** ScopedHandle h{ CreateHandle() }; }</span></span></span></span></code> </pre><br>  Why <code>ScopedHandle</code> constructor expect an argument with type <code>void**</code> ?  Recall that smart pointers were designed primarily for managing memory (that is, pointers): <code><code>std::unique_ptr     int*</code> .  <code><code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <code><code>std::unique_ptr     int*</code> .  <code><code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code><code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <ul><li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> </ul> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><code><code class="cpp"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><code><code class="cpp"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <ul><li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> </ul> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <ul><li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> </ul> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <pre> <code class="hljs haskell"><code><span class="hljs-title"><span class="hljs-title">std</span></span>::unique_ptr     int*</code> .  <code><code>std::unique_ptr  <span class="hljs-type"><span class="hljs-type">Handle</span></span>*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;std::remove_pointer_t&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;;</code> <br>          ,     ,      :         <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> .   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code>    ;   <code><span class="hljs-type"><span class="hljs-type">Handle</span></span></code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using <span class="hljs-type"><span class="hljs-type">Handle</span></span> = int; <span class="hljs-type"><span class="hljs-type">Handle</span></span> <span class="hljs-type"><span class="hljs-type">CreateHandle</span></span>() { <span class="hljs-type"><span class="hljs-type">Handle</span></span> h{ <span class="hljs-number"><span class="hljs-number">-1</span></span> }; /*...*/ return h; } void <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { /* ... */ } struct <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span> { using pointer = <span class="hljs-type"><span class="hljs-type">Handle</span></span>; void operator()(<span class="hljs-type"><span class="hljs-type">Handle</span></span> h) { <span class="hljs-type"><span class="hljs-type">CloseHandle</span></span>(h); } }; using <span class="hljs-type"><span class="hljs-type">ScopedHandle</span></span> = std::unique_ptr&lt;<span class="hljs-type"><span class="hljs-type">Handle</span></span>, <span class="hljs-type"><span class="hljs-type">HandleDeleter</span></span>&gt;; int main() { // <span class="hljs-type"><span class="hljs-type">Error</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> mismatch: "int" and "std::nullptr_t". </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedHandle</span></span></span><span class="hljs-class"> h{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">() }; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">              </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,       ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      ‚Äì  </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://en.cppreference.com/w/cpp/concept/NullablePointer"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> . ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">   ,   ,       </span></span><code><span class="hljs-class"><span class="hljs-class">nullptr</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-class">int</span></span></code><span class="hljs-class"><span class="hljs-class"> ,    .  ,     </span></span><code><span class="hljs-class"><span class="hljs-class">std::unique_ptr</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POSIX</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenGL</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      .       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NullablePointer</span></span></span><span class="hljs-class">, ,   ,     ‚Äì   . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,              ¬´¬ª .      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Graphics</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">. bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /*...*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class"> code. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> bmp{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><code class="cpp"><span class="hljs-class"><span class="hljs-class">std::unique_ptr: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">using</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pointer</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap(bmp)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = std::unique_ptr&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapDeleter</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> ctx{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> tmp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> bmp{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmp</span></span></span><span class="hljs-class"> }; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">());</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  .  ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ‚Äì   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class">         ,        .       </span></span><a href="http://en.cppreference.com/w/cpp/language/template_specialization"><span class="hljs-class"><span class="hljs-class"></span></span></a><span class="hljs-class"><span class="hljs-class">    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&gt; class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicit</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class"> } {} </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;) = delete; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept : resource_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> } { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp; operator=(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addressof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">)); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> = {}; return *this; } ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); } operator const </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">&amp;() const noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class">* operator&amp;() noexcept { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">; } private: // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Intentionally</span></span></span><span class="hljs-class"> undefined - must be explicitly specialized. void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span><span class="hljs-class"> resource_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    ,        ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).      ,     ( </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ).     ,    </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceType</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      (, </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ),   ,  </span></span><code><span class="hljs-class"><span class="hljs-class">noexcept</span></span></code><span class="hljs-class"><span class="hljs-class"> .  </span></span><code><span class="hljs-class"><span class="hljs-class">operator&amp;</span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì  .   ,    ,      -  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateHandle</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">)</span></span></code><span class="hljs-class"><span class="hljs-class"> .         -. </span></span><br><span class="hljs-class"><span class="hljs-class">   .   ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,     ,   .          .    ,        </span></span><code><span class="hljs-class"><span class="hljs-class">leanup</span></span></code><span class="hljs-class"><span class="hljs-class">   ,   . : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Here</span></span></span><span class="hljs-class"> "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">" is some </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OS</span></span></span><span class="hljs-class">-specific file descriptor </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> // which must be closed with </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile</span></span></span><span class="hljs-class"> function. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseFile(resource_)</span></span></span><span class="hljs-class">; }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFile(file_path)</span></span></span><span class="hljs-class"> }; ... } // "file" will be destroyed here</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ¬´    ¬ª.  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  ¬´ ¬ª  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äî </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span><span class="hljs-class">? </span></span><br><span class="hljs-class"><span class="hljs-class"> -  ,       </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ?    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> -, </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,           </span></span><code><span class="hljs-class"><span class="hljs-class">void*</span></span></code><span class="hljs-class"><span class="hljs-class"> .  -         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">) { /* ... */ } int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Passing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expecting</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compiles</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OK</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TextureTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span><span class="hljs-class">&gt;; int main() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmp</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DrawBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mismatch</span></span></span><span class="hljs-class"> }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    :      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++ .  , ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,      </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> .    , </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedTexture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">     (,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Texture</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">*</span></span></code><span class="hljs-class"><span class="hljs-class"> ),             . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,      </span></span><code><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    .    ,      ,    </span></span><a href="http://www.boost.org/community/generic_programming.html"><span class="hljs-class"><span class="hljs-class">   </span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">{}; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,         .       ,     </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       .       ,         .     ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++   </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class">    ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> , ,  </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">      ,        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileIdTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileId</span></span></span><span class="hljs-class">&gt;;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Ä¶  </span></span><br><span class="hljs-class"><span class="hljs-class">         </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">, /    .   . ,     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ,      ( )   ,   ;               .        </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,  ,   :         </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span></span></code><span class="hljs-class"><span class="hljs-class">    </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> .   :   </span></span><code><span class="hljs-class"><span class="hljs-class">static_assert</span></span></code><span class="hljs-class"><span class="hljs-class">       ,  ,        ,    . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,   :      .  ,    - </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     false: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">static constexpr bool </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">; } void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static_assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">False</span></span></span><span class="hljs-class">(), "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">must</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explicitly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specialized</span></span></span><span class="hljs-class">."); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); ~</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Width</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Height</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PixelColour</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Colour</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">colour</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeviceContext</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class">; /* </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">methods</span></span></span><span class="hljs-class">... */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width_</span></span></span><span class="hljs-class">{}; int height_{}; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Raw</span></span></span><span class="hljs-class"> resources. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class"> bitmap_{}; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class"> device_context_{}; };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,         ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runtime_error</span></span></span><span class="hljs-class">{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">(); if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // bitmap_ will be leaked here! throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,        :        (   </span></span><a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GDI</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> ,   ,  ,     ,           ).       :   </span></span><code><span class="hljs-class"><span class="hljs-class">device_context_</span></span></code><span class="hljs-class"><span class="hljs-class">  ,   </span></span><code><span class="hljs-class"><span class="hljs-class">bitmap_</span></span></code><span class="hljs-class"><span class="hljs-class"> ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">        : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitmapTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BITMAP</span></span></span><span class="hljs-class">&gt;; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DcTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">&gt;; ... </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) : width_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> }, height_{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> } { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedBitmap</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBitmap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap_</span></span></span><span class="hljs-class">) throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class"> device context. device_context_ = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedDc</span></span></span><span class="hljs-class">{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateCompatibleDc</span></span></span><span class="hljs-class">() }; if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_context_</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Safe</span></span></span><span class="hljs-class">: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Failed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bitmap</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DC</span></span></span><span class="hljs-class">." }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class"> bitmap into device context. // ... }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       : </span></span><i><span class="hljs-class"><span class="hljs-class">          </span></span></i><span class="hljs-class"><span class="hljs-class"> .   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">    ,            .      ,      (            ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">.   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class"> (  ;  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class">  ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">// </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HANDLE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Handle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INVALID_HANDLE_VALUE</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinInet</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InetHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InternetCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttp</span></span></span><span class="hljs-class"> handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandleTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HINTERNET</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandle</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WinHttpCloseHandle(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pointer</span></span></span><span class="hljs-class"> to </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SID</span></span></span><span class="hljs-class">. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PsidTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PSID</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Psid</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FreeSid(resource_)</span></span></span><span class="hljs-class">; } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Network</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Management</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> string buffer. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiStringTag</span></span></span><span class="hljs-class">, wchar_t*&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiString</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NetApiBufferFree(resource_)</span></span></span><span class="hljs-class"> != </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NERR_Success</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">diagnostic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">. } } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Certificate</span></span></span><span class="hljs-class"> store handle. using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&lt;struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStoreTag</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HCERTSTORE</span></span></span><span class="hljs-class">&gt;; template&lt;&gt; void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertStore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cleanup</span></span></span><span class="hljs-class">() noexcept { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource_</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CERT_CLOSE_STORE_FORCE_FLAG</span></span></span><span class="hljs-class">); }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">   ,    :</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">          ,     (  ,   </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> );    ,    ,    (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class">): ,   ‚Äì    ,   . </span></span><br><span class="hljs-class"><span class="hljs-class">   unique_resource  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  ,         </span></span><a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">N3949</span></span></span><span class="hljs-class">    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,      ,         ( ,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_ptr</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cpp"><span class="hljs-class"><span class="hljs-class">template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; class unique_resource_t { /* ‚Ä¶ */ }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Factory</span></span></span><span class="hljs-class">. template&lt;typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, typename </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class">&gt; unique_resource(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">&amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">) noexcept { /* ‚Ä¶ */ } ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Usage</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predefined</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class">). struct </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noexcept</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(resource)</span></span></span><span class="hljs-class">; } }; using </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> = unique_resource_t&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScopedResource</span></span></span><span class="hljs-class"> r{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceDeleter</span></span></span><span class="hljs-class">{} }; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Alternative</span></span></span><span class="hljs-class"> usage (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">place</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">deleter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">definition</span></span></span><span class="hljs-class">). auto r2 = unique_resource( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateResource</span></span></span><span class="hljs-class">(), [](</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">) </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyResource(r)</span></span></span><span class="hljs-class">; });</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   , </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class">     </span></span><i><span class="hljs-class"><span class="hljs-class">  </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     </span></span><code><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span></span></code><span class="hljs-class"><span class="hljs-class"> ‚Äì   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> . ,       ,    ( ,       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-).  ,            . , ,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,   ,    , , ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Windows</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">API</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CertCloseStore</span></span></span><span class="hljs-class">,     . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Resource</span></span></span><span class="hljs-class">  unique_resource_t . ,       ,   </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> (. .,   </span></span><code><span class="hljs-class"><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class">()</span></span></code><span class="hljs-class"><span class="hljs-class"> ).    </span></span><code><span class="hljs-class"><span class="hljs-class">unique_resource_t</span></span></code><span class="hljs-class"><span class="hljs-class"> ,          ,   ,                (        ). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">++,                  . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RAII</span></span></span><span class="hljs-class">-,   ,        ,        ,   .  : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     ‚Äì  ;   ,    ;            . </span></span><br><span class="hljs-class"><span class="hljs-class">     ,    </span></span><i><span class="hljs-class"><span class="hljs-class"> </span></span></i><span class="hljs-class"><span class="hljs-class"> ,      . ,        ,         . ,     ,               ,             .  ,           . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span></span><a href="https://goo.gl/cK46xF"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-class">:</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://arkfps.github.io/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class"> ,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Positive</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Technologies</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><i><span class="hljs-class"><span class="hljs-class">     126  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Overload</span></span></span><span class="hljs-class"> ( 2015).</span></span></i></code></code></code> </pre> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </h4> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> <ul><li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> <li> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </li> </ul> <code><code><code><code>std::unique_ptr     int*</code> .  <code>std::unique_ptr  Handle*</code> ,        <code>void**</code> .     ? -,     <code>std::remove_pointer</code> : <br> <br> <code class="cpp">using ScopedHandle = std::unique_ptr&lt;std::remove_pointer_t&lt;Handle&gt;, HandleDeleter&gt;;</code> <br> -,         :          pointer,          : <br> <br> <code class="cpp">struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;;</code> <br>          ,     ,      :         <code>Handle</code> .   <code>Handle</code>    ;   <code>Handle</code> ‚Äì   ,      . <br> <br>   ,      : <br> <br> <code class="cpp">#include &lt;memory&gt; using Handle = int; Handle CreateHandle() { Handle h{ -1 }; /*...*/ return h; } void CloseHandle(Handle h) { /* ... */ } struct HandleDeleter { using pointer = Handle; void operator()(Handle h) { CloseHandle(h); } }; using ScopedHandle = std::unique_ptr&lt;Handle, HandleDeleter&gt;; int main() { // Error: type mismatch: "int" and "std::nullptr_t". ScopedHandle h{ CreateHandle() }; }</code> <br>              <code>std::unique_ptr</code> ,       ,       . <br> <br>      ‚Äì  <i></i> <a href="http://en.cppreference.com/w/cpp/concept/NullablePointer">NullablePointer</a>  <code>Handle</code> . ,   NullablePointer   ,   ,       <code>nullptr</code> .  <code>Handle</code> ,     <code>int</code> ,    .  ,     <code>std::unique_ptr</code> ,      POSIX   OpenGL. <br> <br>  ,      .       <code>Handle</code> ,   NullablePointer, ,   ,     ‚Äì   . <br> <br> , ,              ¬´¬ª .      <code>Bitmap</code> : <br> <br> <code class="cpp">// Graphics API. bool CreateBitmap(Bitmap* bmp) { /*...*/ return true; } bool DestroyBitmap(Bitmap bmp) { /* ... */ return true; } bool DrawBitmap(DeviceContext ctx, Bitmap bmp) { /* ... */ return true; } ... // User code. DeviceContext ctx{}; Bitmap bmp{}; CreateBitmap(&amp;bmp); DrawBitmap(ctx, bmp);</code> <br>    <code>Bitmap</code>   <code class="cpp">std::unique_ptr: <br> <br> struct BitmapDeleter { using pointer = Bitmap; void operator()(Bitmap bmp) { DestroyBitmap(bmp); } }; using ScopedBitmap = std::unique_ptr&lt;Bitmap, BitmapDeleter&gt;; ... DeviceContext ctx{}; Bitmap tmp; CreateBitmap(&amp;tmp); ScopedBitmap bmp{ tmp }; DrawBitmap(ctx, bmp.get());</code> <br>   ,  <code>ScopedBitmap</code>  .  ,     <code>ScopedBitmap</code>   ,  Bitmap. <br> <br>    ,     ‚Äì   RAII-. <br> <br>  <br>         ,        .       <a href="http://en.cppreference.com/w/cpp/language/template_specialization"></a>    . <br> <br> <code class="cpp">#include &lt;cassert&gt; #include &lt;memory&gt; // std::addressof template&lt;typename ResourceTag, typename ResourceType&gt; class Resource { public: Resource() noexcept = default; explicit Resource(ResourceType resource) noexcept : resource_{ resource } {} Resource(const Resource&amp;) = delete; Resource&amp; operator=(const Resource&amp;) = delete; Resource(Resource&amp;&amp; other) noexcept : resource_{ other.resource_ } { other.resource_ = {}; } Resource&amp; operator=(Resource&amp;&amp; other) noexcept { assert(this != std::addressof(other)); Cleanup(); resource_ = other.resource_; other.resource_ = {}; return *this; } ~Resource() { Cleanup(); } operator const ResourceType&amp;() const noexcept { return resource_; } ResourceType* operator&amp;() noexcept { Cleanup(); return &amp;resource_; } private: // Intentionally undefined - must be explicitly specialized. void Cleanup() noexcept; ResourceType resource_{}; };</code> <br>      . <br> <br>     ,    ,        ( <code>std::unique_ptr</code> ).      ,     ( <code>std::shared_ptr</code> ).     ,    <code>ResourceType</code>      (, <code>void*</code>  <code>int</code> ),   ,  <code>noexcept</code> .  <code>operator&amp;</code> ‚Äì  .   ,    ,      -  <code>CreateHandle(Handle* handle)</code> .         -. <br>   .   ,  <code>Cleanup</code> ,     ,   .          .    ,        <code>leanup</code>   ,   . : <br> <br> <code class="cpp">// Here "FileId" is some OS-specific file descriptor type // which must be closed with CloseFile function. using File = Resource&lt;struct FileIdTag, FileId&gt;; template&lt;&gt; void File::Cleanup() noexcept { if (resource_) CloseFile(resource_); }</code> <br>          <code>FileId</code> : <br> <br> <code class="cpp">{ File file{ CreateFile(file_path) }; ... } // "file" will be destroyed here</code> <br>     <code>Cleanup</code>  <code>Resource</code>    ¬´    ¬ª.  ,   <code>Cleanup</code>  <code>FileId</code>  ¬´ ¬ª  . <br> <br>     ‚Äî ResourceTag? <br> -  ,       <code>ResourceTag</code> ?    . <br> <br> -, <i></i> . ,           <code>void*</code> .  -         : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;Bitmap&gt;; using ScopedTexture = Resource&lt;Texture&gt;; void DrawBitmap(DeviceContext&amp; ctx, ScopedBitmap&amp; bmp) { /* ... */ } int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; // Passing texture to function expecting bitmap. // Compiles OK. DrawBitmap(ctx, t); }</code> <br>     ,   : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, Bitmap&gt;; using ScopedTexture = Resource&lt;struct TextureTag, Texture&gt;; int main() { DeviceContext ctx; ScopedBitmap bmp; ScopedTexture t; DrawBitmap(ctx, t); // error: type mismatch }</code> <br>    :      <code>Cleanup</code>    ,      C++ .  , ,   <code>Bitmap</code>     <code>DestroyBitmap</code> ,      <code>Texture</code> ‚Äì <code>DestroyTexture</code> .    , <code>ScopedBitmap</code>  <code>ScopedTexture</code>     (,     <code>Bitmap</code> ,  <code>Texture</code>   <code>void*</code> ),             . <br> <br>        ,     : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>  ,      <code>struct FileIdTag</code>    .    ,      ,    <a href="http://www.boost.org/community/generic_programming.html">   </a> : <br> <br> <code class="cpp">struct FileIdTag{}; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br>         ,         .       ,     <i> </i> . ,       .       ,         .     ,  C++   <i> </i>    ,        : <br> <br> <code class="cpp">struct FileIdTag; using File = Resource&lt;FileIdTag, FileId&gt;;</code> <br> , ,  <code>FileIdTag</code>      ,        : <br> <br> <code class="cpp">using File = Resource&lt;struct FileIdTag, FileId&gt;;</code> <br>     ‚Ä¶  <br>         Cleanup, /    .   . ,     : <br> <br>     ,      ( )   ,   ;               .        <code>static_assert</code> : <br> <code class="cpp">void Cleanup() noexcept { static_assert(false, "This function must be explicitly specialized."); }</code> <br>  ,  ,   :         <code>Cleanup</code>    <i></i> .   :   <code>static_assert</code>       ,  ,        ,    . <br> <br>  ,   :      .  ,    - <i> </i> ,     false: <br> <br> <code class="cpp">static constexpr bool False() noexcept { return false; } void Cleanup() noexcept { static_assert(False(), "This function must be explicitly specialized."); }</code> <br>      <br>  RAII-,   ,   ,      . -  ,     ,           ‚Äë ?   , ,          : <br> <br> <code class="cpp">class Bitmap { public: Bitmap(int width, int height); ~Bitmap(); int Width() const; int Height() const; Colour PixelColour(int x, int y) const; void PixelColour(int x, int y, Colour colour); DC DeviceContext() const; /* Other methods... */ private: int width_{}; int height_{}; // Raw resources. BITMAP bitmap_{}; DC device_context_{}; };</code> <br>  ,         ,       Bitmap: <br> <br> <code class="cpp">Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = CreateBitmap(width, height); if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = CreateCompatibleDc(); if (!device_context_) // bitmap_ will be leaked here! throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>   ,        :        (   <a href="https://msdn.microsoft.com/en-us/library/dd145203(v%3Dvs.85).aspx">Windows GDI</a> ,   ,  ,     ,           ).       :   <code>device_context_</code>  ,   <code>bitmap_</code> ! <br> <br>        : <br> <br> <code class="cpp">using ScopedBitmap = Resource&lt;struct BitmapTag, BITMAP&gt;; using ScopedDc = Resource&lt;struct DcTag, DC&gt;; ... Bitmap::Bitmap(int width, int height) : width_{ width }, height_{ height } { // Create bitmap. bitmap_ = ScopedBitmap{ CreateBitmap(width, height) }; if (!bitmap_) throw std::runtime_error{ "Failed to create bitmap." }; // Create device context. device_context_ = ScopedDc{ CreateCompatibleDc() }; if (!device_context_) // Safe: bitmap_ will be destroyed in case of // exception. throw std::runtime_error{ "Failed to create bitmap DC." }; // Select bitmap into device context. // ... }</code> <br>       : <i>          </i> .   RAII    ,            .      ,      (            ). <br> <br>   <br>           Windows API.   Windows API,        RAII (  ;  Windows API  ). <br> <br> <code class="cpp">// Windows handle. using Handle = Resource&lt;struct HandleTag, HANDLE&gt;; template&lt;&gt; void Handle::Cleanup() noexcept { if (resource_ &amp;&amp; resource_ != INVALID_HANDLE_VALUE) CloseHandle(resource_); } // WinInet handle. using InetHandle = Resource&lt;struct InetHandleTag, HINTERNET&gt;; template&lt;&gt; void InetHandle::Cleanup() noexcept { if (resource_) InternetCloseHandle(resource_); } // WinHttp handle. using HttpHandle = Resource&lt;struct HttpHandleTag, HINTERNET&gt;; template&lt;&gt; void HttpHandle::Cleanup() noexcept { if (resource_) WinHttpCloseHandle(resource_); } // Pointer to SID. using Psid = Resource&lt;struct PsidTag, PSID&gt;; template&lt;&gt; void Psid::Cleanup() noexcept { if (resource_) FreeSid(resource_); } // Network Management API string buffer. using NetApiString = Resource&lt;struct NetApiStringTag, wchar_t*&gt;; template&lt;&gt; void NetApiString::Cleanup() noexcept { if (resource_ &amp;&amp; NetApiBufferFree(resource_) != NERR_Success) { // Log diagnostic message in case of error. } } // Certificate store handle. using CertStore = Resource&lt;struct CertStoreTag, HCERTSTORE&gt;; template&lt;&gt; void CertStore::Cleanup() noexcept { if (resource_) CertCloseStore(resource_, CERT_CLOSE_STORE_FORCE_FLAG); }</code> <br> <b>   ,    :</b> <br> <br>          ,     (  ,   <code>Resource</code> );    ,    ,    (inline): ,   ‚Äì    ,   . <br>   unique_resource  N3949 <br>       ,  ,         <a href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2014/n3949.pdf">N3949</a> . N3949    <code>unique_resource_t</code> ,      ,         ( ,   <code>std::unique_ptr</code> ): <br> <br> <code class="cpp">template&lt;typename Resource, typename Deleter&gt; class unique_resource_t { /* ‚Ä¶ */ }; // Factory. template&lt;typename Resource, typename Deleter&gt; unique_resource_t&lt;Resource, Deleter&gt; unique_resource(Resource&amp;&amp; r, Deleter d) noexcept { /* ‚Ä¶ */ } ... // Usage (predefined deleter). struct ResourceDeleter { void operator()(Resource resource) const noexcept { if (resource) DestroyResource(resource); } }; using ScopedResource = unique_resource_t&lt;Resource, ResourceDeleter&gt;; ScopedResource r{ CreateResource(), ResourceDeleter{} }; // Alternative usage (in-place deleter definition). auto r2 = unique_resource( CreateResource(), [](Resource r){ if (r) DestroyResource(r); });</code> <br>   , <code>unique_resource_t</code>     <i>  </i> ,     <code>Resource</code> ‚Äì   <i></i> . ,       ,    ( ,       RAII-).  ,            . , ,     . <br> <br>    ,   ,    , , ,  Windows API CertCloseStore,     . <br> <br>    ,     ,    Resource  unique_resource_t . ,       ,   <i></i> (. .,   <code>operator()</code> ).    <code>unique_resource_t</code> ,          ,   ,                (        ). <br> <br>   ,             C++,                  . <br> <br>  <br> RAII-,   ,        ,        ,   .  : <br> <br>     ‚Äì  ;   ,    ;            . <br>     ,    <i> </i> ,      . ,        ,         . ,     ,               ,             .  ,           . <br> <br>   <a href="https://goo.gl/cK46xF"> </a> . <br> <br> <b>:</b> <a href="https://arkfps.github.io/"> </a> ,      Positive Technologies <br> <br> <i>     126  Overload ( 2015).</i></code></code></code> </div><p>Source: <a href="https://habr.com/ru/post/255487/">https://habr.com/ru/post/255487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255475/index.html">As a student, a bug in Yandex.Music found</a></li>
<li><a href="../255477/index.html">Review System for Online Stores - Cackle Reviews</a></li>
<li><a href="../255479/index.html">We are switching from STM32 to the Russian K1986BE92QI microcontroller. Clock Setting</a></li>
<li><a href="../255483/index.html">Dissenting opinion: The JPMorgan algorithm will calculate unscrupulous traders before they incur losses.</a></li>
<li><a href="../255485/index.html">Drawing an ellipse at an arbitrary canvas angle on javascript</a></li>
<li><a href="../255489/index.html">Automatic resize of icons for mobile applications, or how Inkscape + bash make life easier</a></li>
<li><a href="../255493/index.html">Codex and TechExpert in all iPads of the country</a></li>
<li><a href="../255497/index.html">Google has opened a new data center priced at $ 600 million</a></li>
<li><a href="../255499/index.html">Pool objects for unity3d</a></li>
<li><a href="../255501/index.html">Stories about the developers: Russian Brainy Studio, the winner of the Imagine Cup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>