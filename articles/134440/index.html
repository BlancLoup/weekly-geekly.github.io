<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation of processing video files from webcams using shell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It was necessary for the administration to organize in time video surveillance of some things on its own and meet the minimum funding. The task to aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation of processing video files from webcams using shell</h1><div class="post__text post__text-html js-mediator-article">  It was necessary for the administration to organize in time video surveillance of some things on its own and meet the minimum funding.  The task to automate this fell on the shoulders of the system administrator, that is - me. <br>  Given: N - D-Link 2102 video cameras, a physical two-unit server for a video surveillance server and remote file storage. <br>  The result should be the ability to let some users on the video surveillance server online and organize an archive of video recordings. <br><br>  Under the cut there are several scripts that helped me a lot to understand how to write code better, why many things are needed and how they are solved, as well as to put things in order in my head and I really hope that they will help someone else. <br>  The project was written quite difficult - so much I did not study the shell (bash) scripts - there was no need before. <br>  But when the task is set and there is a solution algorithm in my head - all the scripts were reworked so that reading them in half a year I and my successor had no questions and no desire to rewrite everything from scratch. <br><br>  UPD: post periodically updated. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The distribution is selected Ubuntu-Server 10.04.  The server part for online viewing has become ZoneMinder. As I have been writing a lot of documentation for setting up Ubuntu and ZoneMinder, I would like to tell you about the automation of archive maintenance. <br><br>  It was decided that as the main receiver of recordings from cameras (minute videos, it is logically justified from the point of view of minimizing video loss), the server on which ZoneMinder is spinning will be.  The Samba-server is deployed on the server as the best and easiest way to solve the reception of video from cameras and the link between the cameras and the file storage. <br><br>  All files related to the video archive are in / home / ipcamera / camname. <br>  / home / ipcamera / scripts - scripts that run on schedule in / etc / crontab once an hour. <br>  / home / ipcamera / out - mounted from the ball file storage where the processed video is added. <br><br>  In dependencies, we have samba tools for mounting the partition where the archive is stored by samba, and bc, as a console calculator, plus codecs and avimerge. <br><br>  Tasks: <br>  1. Get video from cameras (one minute video) <br>  2. Drain 60 minute clips into one. <br>  3. Upload the received watch video to the file storage. <br>  4. Remove from the video surveillance server all video that is older than 3 days. <br>  5. Periodically delete from the archive video that is older than 3 months. <br>  6. Give access to the archive to those who need and do not give to those who do not need. <br><br>  At the network level, cameras are available for a video surveillance server, can be configured via a web interface, and file storage is also available. <br><br>  All scripts are commented by max. <br><br>  In the settings of the cameras, we set up the ntp server configured in the organization and the time of video recording, for example, from 9 to 18 in the settings of the cameras themselves. <br><br>  Yes, I am aware of the quality of the recording and this issue is not considered in this article, as well as the legality of such self-assembled observation systems. <br><br>  Configuring Samba and Zoneminder are not considered here either, although you cannot do without a piece of the Samba config, and it will. <br><br>  The first config is a piece of the configuration scheduler. <br><br>  It seems that indentation in formatting has disappeared in some places, please forgive me <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat /etc/crontab 5 9-20 * * 1-6 root /home/ITC/ipcamera/scripts/split #    10 9-20 * * 1-6 root /home/ITC/ipcamera/scripts/upload #     - 30 20 * * 1-6 root /home/ITC/ipcamera/scripts/clear #       0 21 * * 6 root /home/ITC/ipcamera/scripts/archieve #  . 0 23 * * * root rm /var/spool/nullmailer/queue/* #      ‚Äì    mail spooler  .</span></span></code> </pre> <br>  Let's go in order: <br>  The configuration file for all this disgrace. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat scripts.conf #         . camshare="/home/ipcamera/" #   filename="*.avi" #      currentdate=`date +%Y%m%d"/"%H` #  ,    ,  smb, -   . outfiles="out/" # Lock-,     . lockfile=`basename $0`".lock" #  . logfile="logfile" #   tmpfile=`basename $0`".tmp" #        upload_share_name="//filearchieve/web_camera_video" #     upload_share_path="/home/ipcamera/out" #        upload_share_user="ipcamerauser" #  upload_share_passwd="ipcamerapassword" #   share_mount_command="mount -t cifs" #   ,  . Age=3</span></span></code> </pre><br>  Function description file to unload scripts and unify variables <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat functions.sh #      . # ver 1.12. ###            . . /home/ipcamera/scripts/scripts.conf #     log_msg() { echo `date +%Y"/"%m"/"%d" "%T`"  "`basename $0`": $1." &gt;&gt; $camshare$logfile } #       -         . lock_on() { # ,    ,   -     . if [ -f $camshare$lockfile ]; then echo `date +%d"/"%m"/"%Y" "%T`"   ,  $0  ?   ." log_msg "  ,   " exit else #     - . touch $camshare$lockfile echo `date +%d"/"%m"/"%Y" "%T`"   " fi } #       . lock_off() { if [ -f $camshare$lockfile ]; then #   . rm $camshare$lockfile echo `date +%d"/"%m"/"%Y" "%T`"    ." else #    ,     . echo `date +%d"/"%m"/"%Y" "%T`"    ." fi } #       . clear_tmp() { if [ -f $camshare$tmpfile ]; then #   . rm $camshare$tmpfile echo `date +%d"/"%m"/"%Y" "%T`"   $tmpfile ." else #    . echo `date +%d"/"%m"/"%Y" "%T`"   $tmpfile  ." fi } #    . upload_share_mount() { # ,     . test=`mount | grep "$upload_share_path"` if [ "$?" -eq "0" ] ; then #   -   . echo " $upload_share_path  ." else #   . `$share_mount_command $upload_share_name $upload_share_path -o user=$upload_share_user"%"$upload_share_passwd` #  . if [ "$?" -eq "0" ] ; then #   . echo " $upload_share_path     ." else #        . echo ":  $upload_share_path   .  ." log_msg ":  $upload_share_path   .  ." exit fi fi } #     . upload_share_umount() { # ,     . test=`mount | grep "$upload_share_path"` if [ "$?" -eq "0" ] ; then #  , . `umount "$upload_share_path"` echo " $upload_share_path     ." else #  ,    . echo " $upload_share_path  ." fi }</span></span></code> </pre><br>  The file that performs the merging of minute videos from cameras (this parameter in the cameras, unfortunately, cannot be changed, but it is advisable from the point of view of minimizing losses during recording and breaking the link between the camera and the receiving server) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat split #!/bin/sh ##          . #ver 1.0. #       . . /home/ipcamera/scripts/functions.sh lock_on log_msg "" #     ,            . find $camshare -type d | awk {'FS="/"} {print"/"$2"/"$3"/"$4"/"$5"/"$6"/"$7"/"$8}' | grep -v '/$' | grep -v '$outfiles' | grep -v $currentdate &gt; $camshare$tmpfile #    ,   ,       . for i in `cat $camshare$tmpfile` ; do cd $i ; [ -f $i.avi ] || avimerge -i `ls | sort` -o $i.avi ; rm -fr $i ; done clear_tmp log_msg "" lock_off</span></span></code> </pre><br>  Script that unloads all processed video to file storage. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat upload #!/bin/sh . /home/ipcamera/scripts/functions.sh ##    ,  ,    . #ver 2.2. lock_on log_msg "" upload_share_mount #      AA.avi,    ,        . find "$camshare" -type f -name '[0-9][0-9].avi' | awk '{FS="/"} {print"/"$2"/"$3"/"$4"/"$5"/"$6"/"$7"/"$8}' | grep -v "/$" | grep -v "$outfiles" | grep -v "$currentdate" &gt; "$camshare$tmpfile" #          / -           . for source in `cat $camshare$tmpfile` ; do city=`echo "$source" | awk -F / '{ print $5 }'` date=`echo "$source" | awk -F / '{ print $7 }'` fname=`echo "$source" | awk -F / '{ print $8 }'` [ -d "$camshare$outfiles$city" ] || mkdir "$camshare$outfiles$city" | echo "  $city ." [ -d "$camshare$outfiles$city/$date" ] || mkdir "$camshare$outfiles$city/$date" | echo " $camshare$outfiles$city/$date ." [ -f "$camshare$outfiles$city/$date/$fname" ] || cp "$source" "$camshare$outfiles$city/$date/$fname" done clear_tmp upload_share_umount log_msg "" lock_off</span></span></code> </pre><br>  Now - cleaning the video surveillance server from files older than 3 days <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat clear #!/bin/sh ## ,     3    . #ver 1.0 #       . . /home/ipcamera/scripts/functions.sh lock_on log_msg "" upload_share_mount #   offset="172800" # 3    .# TODO      unixdate=`date +%s` #    . timediff=`echo "$unixdate"-"$offset" | bc` #        offset'. #      AA.avi,    ,         . find "$camshare" -name '[0-9][0-9].avi' | awk '{FS="/"} {print"/"$2"/"$3"/"$4"/"$5"/"$6"/"$7"/"$8}' | grep -v '/$' | grep -v "$outfiles" | grep -v `date +%Y%m%d` &gt; $camshare$tmpfile #       . for source in `cat "$camshare$tmpfile"` ; do city=`echo "$source" | awk -F / '{ print $5 }'` #    "". date=`echo "$source" | awk -F / '{ print $7 }'` # -"- "". fname=`echo "$source" | awk -F / '{ print $8 }'` # -"- " ". filedate=`ls -l --time-style=long-iso "$source" | awk '{print $6}'` #  . unixfiledate=`date +%s -d"$filedate"` #     . outfilename="$camshare$outfiles$city/$date/$fname" #    . #       ,     ,    timediff',   - . if [ -f "$outfilename" ] ; then echo "$outfilename   ." if [ "$unixfiledate" -lt "$timediff" ] ; then echo "$source ." rm "$source" else echo "$source" "$unixfiledate ." fi else echo " $outfilename  ." fi done #   . find "$camshare" -type d -empty | grep 'video' | xargs rm -fr {} upload_share_umount clear_tmp log_msg "" lock_off</span></span></code> </pre><br>  And for a snack <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat archieve #!/bin/sh ## ,         . #ver 1.0. #       . . /home/ipcamera/scripts/functions.sh lock_on log_msg "" upload_share_mount #  . Year=`date +%Y` Month=`date +%m` Old=`echo "$Month"-"$Age"|bc` find "$camshare" -type d -name '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'| grep "$outfiles" &gt; $camshare$tmpfile #       . for source in `cat "$camshare$tmpfile"` ; do ddate=`echo "$source" | awk -F / '{ print $7 }'` Y=`echo $ddate | head -c4` M=`echo $ddate | head -c6 | tail -c2` D=`echo -n $ddate | tail -c2` if [ $Y -eq `date +%Y` ] ; then # echo "$source    ." if [ "$M" -le "$Old" ] ; then # echo " $source ,  ." rm -rf $source else echo "  $source      ($Age ),  ." fi else # echo " $source          ." # TODO :   mtime  ,  2010   . echo $source &gt;&gt; $camshare/2010.log fi done #TODO         . upload_share_umount clear_tmp log_msg "" lock_off</span></span></code> </pre><br>  The fact is that sometimes the date flies on the cameras and they start writing in 2010, but by the time the files were created you can understand when they were actually created and rename them properly, it‚Äôs not enough for this procedure yet. <br><br>  about resource intensity: <br>  #uptime <br>  17:49:27 up 2:21, 1 user, load average: 4.27, 4.25, 4.24 <br>  more CPU loaded than memory.  This is ZoneMinder trying. <br><br>  By logs: <br>  On the order of 10 cameras, the execution time is now (HP Proliant DL560 G1, 1Gb of memory, Xeon 2x2188.804 MHz): <br><pre> <code class="bash hljs">2011/10/29 20:30:01  clear: . 2011/10/29 20:30:11  clear: . 2011/10/29 21:00:01  archieve: . 2011/10/29 21:00:12  archieve: . 2011/10/31 09:05:01  split: . 2011/10/31 09:05:30  split: . 2011/10/31 09:10:02  upload: . 2011/10/31 09:10:16  upload: .</code> </pre><br>  Creating file balls for each camera <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat mkshare #!/bin/bash ##      . # Version name: 2.0. #        functions.sh. #   . . /home/ipcamera/scripts/functions.sh lock_on log_msg "" #       -   . if [ "$1" != "" ]; then mkdir "$camshare$1" #      chmod 777 "$camshare$1" #    #   - samba   . echo -e "\n[$1]\n comment = $1\n browseable = yes\n path = $camshare$1\n printable = no\n guest ok = yes\n read only =no\n create mask = 0700" &gt;&gt; /etc/samba/smb.conf #  samba. service smbd restart #   . echo "!!!     IP    Samba ACL,          ,   samba : sudo service smbd restart" log_msg "  $1  ." else #         . echo "    $0." fi</span></span></code> </pre><br>  A piece of samba config: <br><pre> <code class="bash hljs">allow hosts = 10.0.0.1, 10.0.0.2 <span class="hljs-comment"><span class="hljs-comment">#         ,     . [camname1] comment = camname1 browseable = yes path = /home/ipcamera/camname1 printable = no guest ok = yes read only = no</span></span></code> </pre><br>  The cameras are now configured with a server by IP address and the name camname. <br><br>  ## TODO list. <br>  1. Check whether the necessary packages are installed, it is possible to build in deb all this disgrace. <br>  2. Monitor camera availability and alert those in charge. <br>  3. Localization of scripts. <br>  4. deb package and normal man / texinfo. <br>  5. Probably it would be worthwhile to remove the output of many messages in &amp;&gt; / dev / null, but I haven‚Äôt figured it out yet. <br>  6. Add code responsible for checking dependencies and requesting installation of them (connection with clause 4 is possible) <br>  7. Since samba is integrated with the domain, it is possible to organize access by employee logins, but since cameras with domain logins do not work very well - does it make sense again. <br>  8. Monitoring of liveliness of the link to them (ping) has not yet been implemented. <br>  9. The monitoring of the fact that the camera was reset or simply did not receive the time via ntp and began to write video in the 2010th year is not implemented yet. <br><br>  The last two stages - localization of variables to different languages, normal documentation and a package didn‚Äôt suffice me either, and does it make sense if the scripts are actually executed automatically and I go to the server well if once a month - when the whole algorithm works in my head , and, accordingly, checking for errors, the operator‚Äôs intervention became almost unnecessary, today the server had uptime of several months, and there was a first reboot for updating the kernel, samba and Kerberos, which are responsible for linking the server to Active Di  rectory. <br><br>  The only thing that confuses me is the overflow of the mail section, because for good all output should be suppressed, except for messages in the log file. <br><br>  Thanks to that, I hope I helped you. <br>  I am pleased to accept recipes for optimizing scripts and developing ideas further. <br><br>  Sources are available here: <a href="https://github.com/foxmuldercp/shell_scripts/tree/master/bash/LinuxVideoControl">on GitHub</a> </div><p>Source: <a href="https://habr.com/ru/post/134440/">https://habr.com/ru/post/134440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134432/index.html">In search of the fat (The Quest For FAT)</a></li>
<li><a href="../134433/index.html">ReactOS Digest # 3: Moving on</a></li>
<li><a href="../134436/index.html">Indicators of the popularity of various mapping systems</a></li>
<li><a href="../134438/index.html">Talk about Docsis?</a></li>
<li><a href="../134439/index.html">Object-Oriented Gin Installer Development</a></li>
<li><a href="../134441/index.html">And we make calculators</a></li>
<li><a href="../134442/index.html">Change the width of the element with a "step" of several pixels</a></li>
<li><a href="../134443/index.html">Fast vector and complex shapes in Illustrator CS5</a></li>
<li><a href="../134446/index.html">Home accounting from the portal FINANCE.UA</a></li>
<li><a href="../134447/index.html">Batch 3D-converter based on 3ds Max</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>