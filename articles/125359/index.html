<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of asterisk with Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some stage of development of our organization, it was decided to switch to VoIP telephony. Asterisk-PBX was unconditionally chosen as the platform....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of asterisk with Active Directory</h1><div class="post__text post__text-html js-mediator-article">  At some stage of development of our organization, it was decided to switch to VoIP telephony.  Asterisk-PBX was unconditionally chosen as the platform.  The terminal equipment took the budget from the affordable - DLink DPH-150. <br>  As a result of the work done, an automated VoIP system was obtained, controlled through the standard MS ActiveDirectory snap-in. <br><br><a name="habracut"></a>  Asterisk 1.8.4 was compiled from sources on Ubuntu 9.04. <br>  Walking through the Internet with the search phrase ‚Äúasterisk active directory‚Äù, it was decided to use partial integration based on perl scripts that create configuration files for asterisk.  Full integration with AD based on the Asterisk kernel looked depressing in view of the meager amount of information about this on the Internet.  The reason for using the selected integration option was one simple perl script (unfortunately, it‚Äôs already impossible to find its sources), which was started by crown and formed the 'users.conf' configuration file, after which the asterisk service was restarted.  After a thorough study of the possibilities of asterisk and the expansion of the functionality of the found script, the following happened. <br><br><h4>  Formation and connection users.conf </h4><br>  The script below finds all users in AD who have the 'phone' attribute specified and lists the users in the config format users.conf to stdout. <br>  In the users.conf configuration file, the script is connected as follows: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#exec /etc/asterisk/scripts/users.pl</span></span></code> </pre> <br>  The script users.pl: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # users.pl v1.1 # # Script to generate asterisk 'users.conf' file from Active Directory (LADP) on users which contains 'phone' attribute # # Using: # 1. Print users to STDOUT: # users.pl # # 2. Print users to file: # users.pl users_custom.conf use strict; use warnings; use Net::LDAP; use Lingua::Translit; ###################### ### BEGIN SETTINGS ### ###################### my $debug = 0; my $warning = 0; # name of Domain my $AD="domain"; # Domain name in format AD # for example mydomain.ru my $ADDC="DC=domain"; # user in Active directory # example: "CN=asterisk,CN=Users,$ADDC" my $ADUserBind="CN=asterisk,CN=Users,$ADDC"; my $ADpass="p@s$w0rd"; # base search tree # example "OU=Users,$ADDC" my $ADUsersSearchBase="OU=Organisation,$ADDC"; # Field in active directory where telephone number, display name, phone stored # "telephonenumber", "displayname", "mail" my $ADfieldTelephone="telephonenumber"; my $ADfieldFullName="displayname"; my $ADfieldMail="mail"; my $ADfieldUser="samaccountname"; # You need to create a dialplan in your asterisk server; my $dialplan="office"; # default settings my $user_static = "context = $dialplan call-limit = 100 type = friend registersip = no host = dynamic callgroup = 1 threewaycalling = no hasdirectory = no callwaiting = no hasmanager = no hasagent = no hassip = yes hasiax = yes nat=yes qualify=yes dtmfmode = rfc2833 insecure = no pickupgroup = 1 autoprov = no label = macaddress = linenumber = 1 LINEKEYS = 1 callcounter = yes disallow = all allow = ulaw,alaw,iLBC,h263,h263p "; ####################### ### END OF SETTINGS ### ####################### my $ldap; # get array DNS names of AD controllers my $dig = "dig -t srv _ldap._tcp.$AD" . '| grep -v "^;\|^$" | grep SRV | awk "{print \$8}"'; my @adControllers = `$dig`; # try connect to AD controllers foreach my $controller (@adControllers){ $controller =~ s/\n//; #INITIALIZING $ldap = Net::LDAP-&gt;new ( $controller ) or next; print STDERR "Connected to AD controller: $controller\n" if $debug &gt; 0; last; } die "$@" unless $ldap; my $mesg = $ldap-&gt;bind ( dn=&gt;$ADUserBind, password =&gt;$ADpass); #PROCESSING - Displaying SEARCH Results # Accessing the data as if in a structure # ie Using the "as_struct" method my $ldapUsers = LDAPsearch ( $ADUsersSearchBase, "$ADfieldTelephone=*", [ $ADfieldFullName, $ADfieldTelephone, $ADfieldMail, $ADfieldUser ] )-&gt;as_struct; # translit RUS module. # GOST 7.79 RUS, reversible, GOST 7.79:2000 (table B), Cyrillic to Latin, Russian my $tr = new Lingua::Translit("GOST 7.79 RUS"); my %hashPhones = (); my $phones = \%hashPhones; my @out; while ( my ($distinguishedName, $attrs) = each(%$ldapUsers) ) { # if not exist phone or name - skipping my $attrPhone = $attrs-&gt;{ "$ADfieldTelephone" } || next; my $attrUser = $attrs-&gt;{ "$ADfieldUser" } || next; my $attrName = $attrs-&gt;{ "$ADfieldFullName" } || next; my $encName = $tr-&gt;translit("@$attrName"); my $attrMail = $attrs-&gt;{ "$ADfieldMail" } || [""]; # check for duplicates phone number if ( $phones -&gt; {"@$attrPhone"} ){ my $currUser = "@$attrName"; my $existUser = $phones -&gt; {"@$attrPhone"}; print STDERR "@$attrPhone alredy exist! Exist:'$existUser' Current:'$currUser'... skipping - '[@$attrPhone] $currUser'\n" if $warning; next; } else { $phones -&gt; {"@$attrPhone"} = "@$attrName"; } # password for SID = (telephonenumber without first digit) + 1 # example: phone=6232 pass=233 #$phsecret =sprintf("%03d",( substr("@$attrVal",1,100)+1)); my $phsecret = "@$attrPhone"; push (@out, "[@$attrPhone]\n" . "fullname = $encName\n" . "email = @$attrMail\n" . "username = @$attrUser\n" #. "mailbox = @$attrPhone\n" . "cid_number = @$attrPhone\n" . "vmsecret = $phsecret\n" . "secret = $phsecret\n" . "transfer = yes\n" . "$user_static\n" ); } # End of that DN # print to file if (@ARGV){ open FILE, "&gt; $ARGV[0]" or die "Error create file '$ARGV[0]': $!"; print STDOUT "Printing to file '$ARGV[0]'"; print FILE @out; close FILE; print STDOUT " ...done!\n"; } # print to STDOUT else{ print @out; } exit 0; #OPERATION - Generating a SEARCH #$base, $searchString, $attrsArray sub LDAPsearch { my ($base, $searchString, $attrs) = @_; my $ret = $ldap-&gt;search ( base =&gt; $base, scope =&gt; "sub", filter =&gt; $searchString, attrs =&gt; $attrs ); LDAPerror("LDAPsearch", $ret) &amp;&amp; die if( $ret-&gt;code ); return $ret; } sub LDAPerror { my ($from, $mesg) = @_; my $err = "[$from] - error" ."\nCode: " . $mesg-&gt;code ."\nError: " . $mesg-&gt;error . " (" . $mesg-&gt;error_name . ")" ."\nDescripton: " . $mesg-&gt;error_desc . ". " . $mesg-&gt;error_text; print STDERR $err if $warning; }</span></span></code> </pre> <br><h5>  Formation of telephone groups based on AD groups </h5><br>  The main numbering plan is painted manually in the extensions.conf configuration file.  But in our organization, quite often employees move from one department to another, because of which they would have to constantly reorganize the extensions.conf config, which together with the human factor would lead to inevitable errors.  The essence of the alternative solution is that in AD, in a specific OU (in the $ ADGroupsSearchBase script), groups are created in which the telephone number of the group is written, and the subscribers to whom the call will be received when dialing the group number are included in the "members". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The script in the config is connected in the same way: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#exec /etc/asterisk/scripts/exten.pl</span></span></code> </pre> <br>  Script: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # exten.pl v1.1 # # Script to generate extensions 'extensions_custom.conf' file, # from Active Directory (LADP) on groups in OU=ADGroupsSearchBase # which groups contains 'description' attribute # # Using: # 1. Print users to STDOUT: # exten.pl # # 2. Print users to file: # exten.pl exten_custom.conf use strict; use warnings; use Net::LDAP; use Lingua::Translit; ###################### ### BEGIN SETTINGS ### ###################### my $debug = 0; my $warning = 1; #name of Domain my $AD="domain"; #Domain name in format AD #for example mydomain.ru my $ADDC="DC=domain"; # user in Active directory # example: "CN=asterisk,CN=Users,$ADDC" my $ADUserBind="CN=asterisk,CN=Users,$ADDC"; my $ADpass="p@s$w0rd"; # base search Groups tree example "OU=Users,$ADDC" my $ADGroupsSearchBase = "OU=asterisk,OU=Groups,OU=Organisation,$ADDC"; # base search Users tree example "OU=Users,$ADDC" my $ADUsersSearchBase = "OU=Organisation,$ADDC"; # default email to send voicemail if email user not set my $defaultEmail = 'asterisk@Organisation.com'; # Field in active directory where telephone number, display name, phone stored ... # "telephonenumber", "displayname", "mail", ... my $ADfieldTelephone = "telephonenumber"; my $ADfieldMember = "member"; my $ADfieldMemberOf = "memberof"; my $ADfieldInfo = "info"; my $ADfieldDescription = "description"; my $ADfieldMail = "mail"; ####################### ### END OF SETTINGS ### ####################### my $ldap; # get array DNS names of AD controllers my @adControllers = `dig -t srv _ldap._tcp.$AD | grep -v '^;\\|^\$' | grep SRV | awk '{print \$8}'`; # try connect to AD controllers foreach my $controller (@adControllers){ $controller =~ s/\n//; #INITIALIZING $ldap = Net::LDAP-&gt;new ( $controller ) or next; print STDERR "Connected to AD controller: $controller\n" if $debug &gt; 0; last; } die "$@" unless $ldap; my $mesg = $ldap-&gt;bind ( dn=&gt;$ADUserBind, password =&gt;$ADpass); #PROCESSING - Displaying SEARCH Results # Accessing the data as if in a structure # ie Using the "as_struct" method my $ldapGroups = LDAPsearch ( $ADGroupsSearchBase, "$ADfieldDescription=*", [ $ADfieldMember, $ADfieldDescription ] )-&gt;as_struct; # translit RUS module. # GOST 7.79 RUS, reversible, GOST 7.79:2000 (table B), Cyrillic to Latin, Russian my $tr = new Lingua::Translit("GOST 7.79 RUS"); my $hash = (); # process each group in $ADGroupsSearchBase with phone while ( my ($distinguishedName, $groupAttrs) = each(%$ldapGroups) ) { print STDERR "Processing GROUP: [$distinguishedName]\n" if $debug &gt; 1; my $attrMembers = $groupAttrs-&gt;{ $ADfieldMember } or next; my $desc = $groupAttrs-&gt;{ $ADfieldDescription } or next; my $groupNumber = "@$desc"; print STDERR "MEMBERS: @$attrMembers\nDESC: $groupNumber (Count=$#$attrMembers+1)" if $debug &gt; 1; # process members in current group foreach my $member (@$attrMembers) { my $ldapMember = LDAPsearch( $ADUsersSearchBase, "$ADfieldTelephone=*", [ $ADfieldTelephone ] ) -&gt; as_struct; my $memberAttrs = $ldapMember-&gt;{$member}; my $memberPhone = $memberAttrs-&gt;{$ADfieldTelephone}[0] or next; print STDERR "\nMEMBER: $member" if $debug &gt; 1; print STDERR "\tPHONE:$memberPhone" if $debug &gt; 1; if ($hash -&gt; {$groupNumber}){ my $a = $hash -&gt; {$groupNumber}; push @$a, $memberPhone; } else { $hash -&gt; {$groupNumber} = [$memberPhone]; } } print STDERR "\n\n" if $debug &gt; 1; } # End of that groups in $ADGroupsSearchBase my @out; while ( my ($groupPhone, $userPhones) = each (%$hash) ) { print STDERR "GROUP: $groupPhone\t PHONES: @$userPhones\n" if $debug &gt; 1; #foreach my $userPhone (@$userPhones) { push (@out, "exten =&gt; $groupPhone,1,Dial(sip/" . join('&amp;sip/', @$userPhones) . ")\n"); } # print to file if (@ARGV){ open FILE, "&gt; $ARGV[0]" or die "Error create file '$ARGV[0]': $!"; print STDOUT "Printing to file '$ARGV[0]'"; print FILE @out; close FILE; print STDOUT " ...done!\n"; } # print to STDOUT else{ print @out; } exit 0; #OPERATION - Generating a SEARCH # $base, $searchString, $attrsArray sub LDAPsearch { my ($base, $searchString, $attrs) = @_; my $ret = $ldap-&gt;search ( base =&gt; $base, scope =&gt; "sub", filter =&gt; $searchString, attrs =&gt; $attrs ); LDAPerror("LDAPsearch", $ret) &amp;&amp; die if( $ret-&gt;code ); return $ret; } sub LDAPerror { my ($from, $mesg) = @_; my $err = "[$from] - error" ."\nCode: " . $mesg-&gt;code ."\nError: " . $mesg-&gt;error . " (" . $mesg-&gt;error_name . ")" ."\nDescripton: " . $mesg-&gt;error_desc . ". " . $mesg-&gt;error_text; print STDERR $err if $warning; #print STDERR "\nServer error: " . $mesg-&gt;server_error if $debug; }</span></span></code> </pre> <br><br>  The output of the script is something like this: <br> <code>exten =&gt; 605,1,Dial(sip/157&amp;sip/130&amp;sip/444&amp;sip/103&amp;sip/119&amp;sip/151&amp;sip/117) <br> exten =&gt; 602,1,Dial(sip/122&amp;sip/110&amp;sip/106) <br> exten =&gt; 607,1,Dial(sip/444&amp;sip/122&amp;sip/110&amp;sip/100&amp;sip/101) <br> exten =&gt; 601,1,Dial(sip/155&amp;sip/101) <br> exten =&gt; 606,1,Dial(sip/444&amp;sip/110&amp;sip/100&amp;sip/101)</code> <br> <br><h5>  Automation </h5><br>  To automatically upload new data from AD to cron, the task of reloading the asterisk configuration has been added: <br><pre> <code class="bash hljs">asterisk -rx reload</code> </pre><br>  With such a reboot, unlike the restart of the entire service, telephone sessions do not terminate. <br><br><h5>  Continuation </h5><br>  If the article is of interest to the community, then I am ready to continue the narration in which I would like to include the following topics: <br><ol><li>  Automatically expand the configuration of DLINK DPH-150 phones, and other devices that support autoprovision </li><li>  Using DialFox software for automatic dialing with NTLM authorization via AD.  In particular, screwing mod_ntlm to apache2 </li></ol><br><br>  Thank you for your attention. <br><br>  PS In the course of writing scripts, I tried to compile all comments in English for universality.  But unfortunately the grammar in the foreign language leaves much to be desired.  I hope the basic meaning of the comments will be clear. <br><br>  <b>UPD:</b> Updated scripts.  Added by: <br>  1. Definition of domain controllers from a DNS server. <br>  2. Ability to run a script with a parameter - the name of the file to which stdout will be written. </div><p>Source: <a href="https://habr.com/ru/post/125359/">https://habr.com/ru/post/125359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125353/index.html">PasteScript based project templates</a></li>
<li><a href="../125354/index.html">HSPL and RSPL for WP7 HTC devices released</a></li>
<li><a href="../125355/index.html">Productive work in vim using snipMate</a></li>
<li><a href="../125356/index.html">Algorithm for determining whether a point hits a contour based on a comprehensive analysis</a></li>
<li><a href="../125358/index.html">History of MySQL database recovery from files (InnoDB)</a></li>
<li><a href="../125360/index.html">Terms of Reference</a></li>
<li><a href="../125362/index.html">Do not use Java7 for anything.</a></li>
<li><a href="../125363/index.html">How we got to the Android Market</a></li>
<li><a href="../125364/index.html">FPGA clock with Quartus II and some Verilog</a></li>
<li><a href="../125366/index.html">A brief report from the development team of the webonmap.ru project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>