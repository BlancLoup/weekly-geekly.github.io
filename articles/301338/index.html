<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Effective dependency injection when scaling Ruby applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our blog on Habr√©, we not only talk about the development of our product - billing for Hydra telecom operators , but also publish materials about w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Effective dependency injection when scaling Ruby applications</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/latera/blog/301338/"><img src="https://habrastorage.org/files/5a9/58b/875/5a958b8754c44b3fb834dd045d8636e2.png"></a> <br><br>  In our blog on Habr√©, we not only talk about the development of our product - <a href="http://www.hydra-billing.ru/">billing for Hydra telecom operators</a> , but also publish materials about working with infrastructure and using technologies from the experience of other companies.  Tim Riley, a programmer and one of the leaders of the Australian development studio Icelab, wrote <a href="http://icelab.com.au/articles/effective-ruby-dependency-injection-at-scale/">an article</a> in the corporate blog about introducing Ruby dependencies - we present to you an adapted version of this material. <a name="habracut"></a><br><br>  In the <a href="http://icelab.com.au/articles/functional-command-objects-in-ruby/">previous part,</a> Riley describes an approach in which dependency injection is used to create small reusable functional objects that implement the " <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Team</a> " pattern.  The implementation turned out to be relatively simple, without bulky pieces of code - only three objects working together.  This example explains the use of not one hundred, but one or two dependencies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for dependency injection to work even with large-scale infrastructure, it is necessary to have a single thing - a container with <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B8%25D1%258F_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">inversion of control</a> . <br><br>  At this point, Riley lists the CreateArticle command code, which uses dependency injection: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateArticle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_article</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">persist_article</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_article</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">persist_article</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_article</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_article</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">persist_article</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">persist_article</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validate_article</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">persist_article</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  This command uses dependency injection in the constructor for working with <code>validate_article</code> and <code>persist_article</code> .  <a href="http://dry-rb.org/gems/dry-container">It</a> explains how dry-container can be used (a simple thread-safe container designed to be used as half the container implementation with inversion control) so that dependencies are available when needed: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"dry-container"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   class MyContainer extend Dry::Container::Mixin end #    MyContainer.register "validate_article" do ValidateArticle.new end MyContainer.register "persist_article" do PersistArticle.new end MyContainer.register "create_article" do CreateArticle.new( MyContainer["validate_article"], MyContainer["persist_article"], ) end #   `CreateArticle`    MyContainer["create_article"].("title" =&gt; "Hello world")</span></span></code> </pre><br>  Tim explains the inversion of control by analogy - imagine one large associative array that controls access to objects in an application.  In the previously presented code fragment, 3 objects were registered using blocks for their subsequent creation upon access.  Delayed calculation of blocks also means that it is still possible to use them to access other objects in the container.  Thus dependencies are transferred when creating <code>create_article</code> . <br><br>  You can call <code>MyApp::Container["create_article"]</code> , and the object will be fully configured and ready to use.  Having a container, you can register objects once and reuse them later. <br><br>  <code>dry-container</code> supports declaring objects without using a namespace in order to facilitate working with a large number of objects.  In real-world applications, the most commonly used namespace is ‚Äúarticles.validate_article‚Äù and ‚Äúpersistence.commands.persist_article‚Äù instead of simple identifiers, which can be found in the example being described. <br><br>  All is well, however, in large applications I would like to avoid a large number of sample code.  This problem can be solved in two stages.  The first one is to use the system of automatic dependency injection into objects.  Here's what it looks like when using <a href="http://dry-rb.org/gems/dry-auto_inject">dry-auto_inject</a> (a mechanism for resolving dependencies on demand): <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"dry-container"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"dry-auto_inject"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   class MyContainer extend Dry::Container::Mixin end #         MyContainer.register "validate_article", -&gt; { ValidateArticle.new } MyContainer.register "persist_article", -&gt; { PersistArticle.new } MyContainer.register "create_article", -&gt; { CreateArticle.new } #   AutoInject    AutoInject = Dry::AutoInject(MyContainer) #    CreateArticle class CreateArticle include AutoInject["validate_article", "persist_article"] # AutoInject    `validate_article` and `persist_article` def call(params) result = validate_article.call(params) if result.success? persist_article.call(params) end end end</span></span></code> </pre><br>  Using the automatic implementation mechanism allows you to reduce the amount of template code when declaring objects with a container.  There is no need to develop a list of dependencies for their transfer to the <code>CreateArticle.new</code> method when it is declared.  Instead, you can define dependencies directly in the class.  A plug-in using <code>AutoInject[*dependencies]</code> defines the <code>.new</code> , <code>#initialize</code> and <code>attr_readers</code> that ‚Äúpull‚Äù dependencies out of the container, and allow them to be used. <br><br>  Declaring dependencies in the place where they will be used is a very powerful castling that allows you to make shared objects understandable without the need to define a constructor.  In addition, you can easily update the list of dependencies - this is useful because the tasks performed by the object change over time. <br><br>  The described method seems rather elegant and efficient, but it is worthwhile to dwell in greater detail on the container declaration method used at the beginning of the last code example.  Such an announcement can be used with the <code>dry-component</code> , a system that has all the necessary dependency management functions and is based on <code>dry-container</code> and <code>dry-auto_inject</code> .  This system itself controls what is needed to use control inversion between all parts of the application. <br><br>  In his material, Riley focuses separately on one aspect of this system - the automatic declaration of dependencies. <br><br>  Suppose that our three objects are defined in the files <code>lib/validate_article.rb</code> , <code>lib/persist_article.rb</code> and <code>lib/create_article.rb</code> .  All of them can be included in the container automatically using the special settings in the top-level file <code>my_app.rb</code> : <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"dry-component"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"dry/component/container"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyApp</span></span></span><span class="hljs-class"> &lt; Dry::Component::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configure</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">root</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pathname</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__FILE__</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">realpath</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dirname</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auto_register</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lib</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#  "lib/"  $LOAD_PATH load_paths! "lib" end #    MyApp.finalize! #       MyApp["validate_article"].("title" =&gt; "Hello world")</span></span></span></span></code> </pre><br>  Now the program no longer contains lines of code of the same type, while the application is still running.  Automatic registration uses simple file and class name conversion.  Directories are converted to namespaces, so the <code>Articles::ValidateArticle</code> class in the <code>lib/articles/validate_article.rb</code> file will be available to the developer in the <code>articles.validate_article</code> container without the need for any additional actions.  This provides a convenient conversion that is similar to the conversion in Ruby on Rails, without any problems with the automatic loading of classes. <br><br>  <code>dry-container</code> , <code>dry-auto_inject</code> , and <code>dry-component</code> is all that is needed to work with small separate components that are easily connected together using dependency injection.  Application of these tools simplifies the creation of applications and, even more importantly, facilitates their support, expansion and redesign. <br><br><h4>  Other technical articles from <a href="http://www.latera.ru/">Latera</a> : </h4><br><ul><li>  <a href="http://blog.hydra-billing.ru/stories/574">We automate the accounting of addresses and bindings in IPoE-networks</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/283548/">Doomsday: What are the hidden errors of asynchronous data processing with increasing load</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/282798/">Working with MySQL: how to scale the data warehouse 20 times in three weeks</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/277331/">DoS on your own: What causes the uncontrolled growth of tables in the database</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/273283/">Open source application architecture: How nginx works</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/267083/">How to improve resiliency of billing: The experience of "Hydra"</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/301338/">https://habr.com/ru/post/301338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301324/index.html">Generating classes from a database using DataGrip</a></li>
<li><a href="../301330/index.html">Calling Java code from Love2D</a></li>
<li><a href="../301332/index.html">So you think you know Const?</a></li>
<li><a href="../301334/index.html">We study Bootmgr. Part 1 - tools and basic principles of debugging the initial stages of loading Windows</a></li>
<li><a href="../301336/index.html">ASP.NET Core RC2: Integrated Modularity Support (application parts)</a></li>
<li><a href="../301340/index.html">The growth of hockey players: analyze the data of all world championships in the current century</a></li>
<li><a href="../301344/index.html">Python: Thinking Programmer</a></li>
<li><a href="../301346/index.html">Informational hiding in PDF documents</a></li>
<li><a href="../301350/index.html">Bootstrapping is a business from scratch. Part 1</a></li>
<li><a href="../301352/index.html">High-tech tools alone cannot increase productivity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>