<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with a COM port in a web project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue 
 One of the clients of our web project wanted to use a barcode scanner to search for orders in the system. But, unfortunately, completely ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with a COM port in a web project</h1><div class="post__text post__text-html js-mediator-article"><h3>  Prologue </h3><br>  One of the clients of our web project wanted to use a barcode scanner to search for orders in the system.  But, unfortunately, completely abandoned the idea of ‚Äã‚Äãworking with them in keyboard imitation mode - only COM port emulation. <br>  Solutions were not very many: <br><ul><li>  a separate native application that would send a request to our server, and the server would give a command to the browser </li><li>  work with COM port directly from the browser </li></ul><br>  Fortunately, there is a way to solve the problem in the second way. <br><br><a name="habracut"></a><br><h3>  Chrome application </h3><br>  If anyone knows, the Chrome Application is a Chrome browser application written in JavaScript.  An <a href="https://developer.chrome.com/apps/serial">API for working with serial ports is</a> available in these applications.  This option is almost perfect for us. <br>  The main problem is that although Chrome Application has the right tools, it cannot work directly with open pages.  Here we come to the aid of extensions that have this opportunity. <br><br>  Next, I will try to describe in more detail how to tie it all together so that it works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">COM port emulation</b> <div class="spoiler_text">  Unfortunately, I did not have the opportunity to work with a real scanner, so I had to emulate it. <br>  For this, I used socat: <br><ol><li>  Run: <br><pre><code class="bash hljs">socat -d -d pty,raw,<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>=0 pty,raw,<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>=0</code> </pre> <br></li><li>  We receive the answer of a type: <br><pre> <code class="bash hljs"> socat[1473] N PTY is /dev/ttys001 socat[1473] N PTY is /dev/ttys002 socat[1473] N starting data transfer loop with FDs [3,3] and [5,5]</code> </pre><br></li><li>  In another window of the terminal we perform: <br><pre> <code class="bash hljs"> cat &gt; /dev/ttys001</code> </pre><br>  instead of / dev / ttys001, specify the path that socat returned <br>  And write any messages. <br></li><li>  For verification, in the third window: <br><pre> <code class="bash hljs"> cat &lt; /dev/ttys002</code> </pre><br>  / dev / ttys002 - the second path from socat. <br>  Having written the message in the second window - we will receive it in the third, if it has come - you can go further. <br></li></ol><br><br></div></div><br><br><h5>  Create application </h5><br>  The <a href="https://developer.chrome.com/apps/first_app">documentation</a> describes the process fairly well, one need only pay attention to the fact that we need access to work with serial ports.  To do this in the file manifest.json specify: <br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"serial"</span></span> ]</code> </pre><br>  The background.js file contains the code for the application itself: <br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> chrome.app.runtime.onLaunched.addListener(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chrome.serial.connect(<span class="hljs-string"><span class="hljs-string">"/dev/ttys004"</span></span>, {<span class="hljs-attr"><span class="hljs-attr">bitrate</span></span>: <span class="hljs-number"><span class="hljs-number">115200</span></span>}, onConnect); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stringReceived = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onConnect = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionInfo</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionId = connectionInfo.connectionId; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onReceiveCallback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.connectionId == connectionId) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str = arrayBufferToString(info.data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str.charAt(str.length<span class="hljs-number"><span class="hljs-number">-1</span></span>) === <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { stringReceived += str.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, str.length<span class="hljs-number"><span class="hljs-number">-1</span></span>); chrome.runtime.sendMessage(<span class="hljs-string"><span class="hljs-string">'dbmjhdcnjkeeopcmhbooojabanopplnd'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-string"><span class="hljs-string">'scanner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">barcode</span></span>: stringReceived } }); stringReceived = <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { stringReceived += str; } } }; chrome.serial.onReceive.addListener(onReceiveCallback); }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arrayBufferToString</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buffer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> string = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>( buffer ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> len = bytes.byteLength; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { string += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode( bytes[ i ] ) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> string; }</code> </pre><br></div></div><br>  We will analyze it in more detail. <br><br>  <b>chrome.app.runtime.onLaunched.addListener</b> - adds a function to the list that runs when the application starts. <br>  <b>chrome.serial.connect ("/ dev / ttys001", {bitrate: 115200}, onConnect)</b> - connect to the port we need, the connection will execute the onConnect function. <br>  <b>chrome.serial.onReceive.addListener (onReceiveCallback)</b> - when a message is received - onReceiveCallback is called <br>  <b>chrome.runtime.sendMessage</b> is a function that sends a message to another application / extension.  The first argument - the unique ID of the extension to which we send the message - can be seen in the list of installed extensions ( <i>chrome: // extensions / - the parser breaks the link</i> ), the second argument is the data itself. <br><br><h4>  Creating an extension </h4><br>  Here, too, everything is easy and described in detail in the <a href="https://developer.chrome.com/extensions/getstarted">documentation.</a> <br>  Key settings from the manifest file: <br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"tabs"</span></span>, <span class="hljs-string"><span class="hljs-string">"file:///*"</span></span> ], <span class="hljs-string"><span class="hljs-string">"content_scripts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"matches"</span></span>: [<span class="hljs-string"><span class="hljs-string">"file:///*"</span></span>], <span class="hljs-string"><span class="hljs-string">"js"</span></span>: [<span class="hljs-string"><span class="hljs-string">"action.js"</span></span>] } ], <span class="hljs-string"><span class="hljs-string">"background"</span></span>: { <span class="hljs-string"><span class="hljs-string">"persistent"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: [<span class="hljs-string"><span class="hljs-string">"js/background.js"</span></span>] }</code> </pre><br>  <b>permissions</b> - indicates that we need access to the tabs, then specify which (for tests - all local files are listed) <br>  <b>content_scripts</b> - describes which additional scripts to run on the pages. <br>  <b>background</b> - describes the extension script that works in the background <br><br>  Background.js contains code that is responsible for receiving a message and sending it to a specific tab. <br><br><div class="spoiler">  <b class="spoiler_title">background.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (data.action) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'scanner'</span></span>: { chrome.tabs.query({<span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///*"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tab</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; tab.length; i++) { chrome.tabs.sendMessage(tab[i].id, data); } }); } } }; chrome.runtime.onMessageExternal.addListener(onMessage);</code> </pre><br></div></div><br><br>  <b>chrome.tabs.query</b> - makes a selection of tabs by the criterion, in our case it is url = "file: /// *" <br>  There are 2 ways to execute js code on the page from the extension <br><ul><li>  <a href="https://developer.chrome.com/extensions/tabs">chrome.tabs.executeScript</a> - directly call js code on the page, in my opinion not the best option in terms of architecture </li><li>  add <b>content_scripts</b> through the manifest - that is, a scrit that will be added to all tabs that meet the conditions described in matches </li></ul><br>  I chose the second option.  It is worth noting that any code executed in the tab from the extension is executed in a special environment.  This means that it will have full access to the DOM elements, but will not have access to any variables created in the tab.  <a href="https://developer.chrome.com/extensions/content_scripts">More details.</a> <a href="https://developer.chrome.com/extensions/content_scripts"><br></a>  <a href="https://developer.chrome.com/extensions/content_scripts">The best way to transfer data from the extension to the tab code is to use</a> <a href="https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent">CustomEvent.</a> <br><br>  In the action.js file, we just get the message from backgroud.js and create an event for the document. <br><div class="spoiler">  <b class="spoiler_title">action.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> chrome.runtime.onMessage.addListener( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomEvent(data.action, {<span class="hljs-attr"><span class="hljs-attr">detail</span></span>: data.data}); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.dispatchEvent(event); } );</code> </pre><br></div></div><br><br><h4>  Accept message </h4><br>  The simplest thing is to accept the message and do the desired actions with it, for example, simply insert it into the input <br><div class="spoiler">  <b class="spoiler_title">index.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.addEventListener(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"scanner"</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">e</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'barcode'</span></span></span><span class="javascript">).value = e.detail.barcode; }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"barcode"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br><h3>  Epilogue </h3><br>  In general, I was pleasantly surprised that chrome provides an API for working with hardware, including not only for reading, but also for writing. <br>  Unfortunately, after almost everything was done, the client said that he would still put the scanners into keyboard simulation mode.  Although in the end this was not useful to us - I hope this material will be useful to someone. <br><br><h3>  PS </h3>  If anyone is interested, I can tell you about how we created and support several one-page large projects using backbone, how we cache the entire layout on the client side. </div><p>Source: <a href="https://habr.com/ru/post/240775/">https://habr.com/ru/post/240775/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240763/index.html">Expel evil spirits from the ReadyNAS</a></li>
<li><a href="../240765/index.html">Openssl closed four dangerous vulnerabilities</a></li>
<li><a href="../240767/index.html">mod_proctitle - Apache module for displaying requests and brief statistics in the program name (output of top and ps)</a></li>
<li><a href="../240769/index.html">Overview of JPA-RS New Features in EclipseLink</a></li>
<li><a href="../240773/index.html">Atom - TypeScript implementation</a></li>
<li><a href="../240779/index.html">Create your own dojo widgets</a></li>
<li><a href="../240781/index.html">KodiCMS architecture</a></li>
<li><a href="../240783/index.html">Finger Trees (Part 1. Introduction)</a></li>
<li><a href="../240785/index.html">Simple Rest Api framework based on Phalcon</a></li>
<li><a href="../240787/index.html">Web application - well, almost without a back-end: Flask, Redis, API via JSONP, JSFiddle.net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>