<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GridFS vs SQL Server vs Local</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For meticulous 
 Recently, in the environment of developers of server applications often arise disputes about how to better manage the files and which...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GridFS vs SQL Server vs Local</h1><div class="post__text post__text-html js-mediator-article"><h2>  For meticulous </h2><br>  Recently, in the environment of developers of server applications often arise disputes about how to better manage the files and which technology provides faster read / write files.  The network began to appear articles and articles about the comparative performance of the local file system and GridFS.  Or about storing files in a relational database as a BLOB versus storage on a hard disk in a file system.  So I decided to get involved in this confrontation.  Today we will compare the performance and overhead of MongoDB 2.6.7 x64 GridFS vs. MS SQL Server Express 2012 v11.0.5058.0 x64 vs. NTFS.  The experiment used the Windows 7 x64 SP1 platform on the AMD Athlon (tm) II X2 250 Processor 3.00 GHz with 4GB of RAM 1033 MHz and the HDD 600 Gb SATA 6Gb / s Western Digital VelociRaptor 10000rpm 32Mb.  After each test, the computer was restarted, and the bases were reset.  Performance will be considered on the example of a file server in C # under .NET 4.5, whose code is <a href="http://files.webfile.ru/file/b5ab5e50da1c9c1accaf2f853f5b8edc">attached</a> to the article. <br><a name="habracut"></a><br><h2>  Closer to the point </h2><br>  During the test, try to save 1000 files of 10,000,000 bytes.  Each downloaded file will be registered in the ‚ÄúFiles‚Äù table: ‚ÄúHash‚Äù is used to check whether such a file has already been downloaded, ‚ÄúNewName‚Äù links the information about the file with its bit image on the server in the ‚ÄúFileMapping‚Äù table.  File server database schema: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f2/972/c83/3f2972c83398a5f21e3b535d372f8a7f.png" alt="image"></div><br><br>  At the same time, we will try to store files in the GridFS using the official MongoDB driver and simply on the hard disk using the FileInfo class from the .NET class library.  To obtain the ability to conveniently build human-readable queries to SQL Server using LINQ technology and lambda expressions, we will use Entity Framework 6.0: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/027/1dc/e3d/0271dce3d56b8b342bc9779f390d4a23.png" alt="image"></div><br><br><h2>  Single threaded recording </h2><br>  To begin with, let's test saving just to disk, loading files in single-threaded mode.  According to the results of five launches, the operations required: 164751, 165095, 164611, 165937 and 166296 milliseconds.  The maximum difference between the results was about 1%.  This means that, on average, the process worked for 165,338 milliseconds of which 52966 is the time to register the file, 12685 is the time to write the file: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ce/52d/a26/8ce52da26e5d01946a3364af8e0691fd.png" alt="image"></div><br><br>  Starting the program with the measurement of the operation time of its parts and without measurement did not lead to obtaining different results.  Running the program with the stream browser showed that the maximum occupied memory size was 59796 KB.  Disk space: approximately 9.3 GB.  For simplicity, I will continue to give immediately the average result of the execution time of operations and in seconds. <br><br>  Now let's test writing files to the SQL Server database.  The size of the resulting database on disk was approximately 9.8 GB.  At the peak, the program ranked 233432 KB, and the DBMS - 1627048 KB.  The program worked an average of 998 seconds.  Of these, 34 seconds to register the file and 823 seconds to write: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e65/ae0/955/e65ae09554a17795b95636b036737f58.png" alt="image"></div><br><br>  Next came the GridFS queue.  The disk space occupied is approximately 12 GB.  Has spent MongoDB all operative memory to which reached.  At the same time, the memory consumption of SQL Server and our server remained within the usual values, which can, in this situation, be neglected.  Everything was completed in about 921 seconds.  For registration - 60 seconds, for recording - 766 seconds: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dfd/0af/a5e/dfd0afa5e0a1c56cf5fb4052f632fc37.png" alt="image"></div><br><br><h2>  Multi-threaded recording </h2><br>  Here we faced the first difficulties: when several threads are exhausted to establish connection with the DBMS at the same time, errors occur.  And if working with MongoDB goes ‚Äúwithout confirmation‚Äù - the driver does not give an error and continues to work and everything runs smoothly, then EF, while calling ‚ÄúCreateIfNotExists‚Äù, shows a bunch of debug information, gives an error that is not caught using try-catch and ends the process with by mistake.  In this case, the error does not appear if you compile and run with the debugger from the development environment.  The problem was solved by synchronizing the threads and establishing connections with the DBMS in turn. <br><br>  Let's perform write operations using for recording 20 streams of 50 files each.  GridFS testing showed a strong scatter: 716259, 623205, 675829, 583331 and 739815 milliseconds, which averaged 668 seconds.  As you can see, with the same overhead, it took less time to complete.  This is due to less downtime, which is shown by the parallelism visualizer on the graphs of using computational CPU cores (execution using parallelism visualizer took much longer): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99a/12f/089/99a12f089d9ba542a2bf068fe29dbed6.png" alt="image"></div><br><br>  When writing files directly to the file system, the spread of the obtained test values ‚Äã‚Äãwas not large and the average value was 170 seconds.  As you can see, the difference between single-threaded and multi-threaded recording to disk was less than 3%.  Therefore, I consider it expedient to omit the graphics of using the CPU for this case. <br><br>  Multi-threaded writing of files to the SQL Server database led to additional problems: During loading, an error occurred in some of the threads due to a waiting timeout.  As a result, the connection was interrupted, the process was terminated with an error, and the database was brought to an inconsistent state.  For a thousand requests, the first attempt ended in failure in about 40 cases.  Of these, about two ended in failure and the second attempt.  The problem was solved by increasing the timeout to 30 seconds and retrying the connection on failure. <br><br>  When multithreaded saving 1000 files using SQL Server, the time spread was less than 5%, and the result was an average of 840 seconds.  This is almost 16% faster than in single-threaded mode: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee9/b78/f29/ee9b78f29820503f8169bbc462516aa3.png" alt="image"></div><br><br><h2>  Reading files </h2><br>  Now let's test reading files from different repositories.  In single-threaded mode, we count all files in a row, and in multi-threaded mode - in 20 streams of 50 random files each.  Traditionally, 5 attempts of each type: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e9a/0d2/4f9/e9a0d24f94dd46167b2b669add27b914.png" alt="image"></div><br><br>  Reading files from the SQL Server database did not go smoothly the first time.  The Entity Framework at each request to the database for a sample of data caches the result on the side of the client application.  And, although the CLR implies automatic ‚Äúgarbage collection‚Äù, the memory is quickly consumed, which leads to an ‚ÄúOutOfMemory‚Äù error and the process crash.  This is due to the fact that EF does not independently handle this type of exceptions and does not delete the data from the ‚Äúcache‚Äù even if all the memory is used up.  And by querying the tables that store the files, this becomes critical.  The problem was resolved by disabling caching in the FileMapping entity collections using the AsNoTracking installation. <br><br><h2>  Total </h2><br>  We have a raped hard drive and the following summary table: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e3/ad7/ce6/6e3ad7ce6f0d2c4a455a88bba806987c.png" alt="image"></div><br><br><h2>  Bonus </h2><br>  Trying to anticipate possible criticism and to answer unasked questions in advance, after a while, I supplement the article with some interesting (I hope) and useful comments.  First: if the base is not reset before each new test, then the performance will not significantly change.  At least, neither at the second, nor at the third and not at repeated multiple (in reasonable aisles) runs it was not possible to get differences in the results.  Therefore, we omit the detailed description of this part of the work as the most boring one. <br><br>  Secondly, many will surely say that when working with a DBMS through sockets, the data for transmission will have to go through the entire stack of network communication protocols back and forth.  Therefore, we consider another option.  In fact, the same version with the class FileInfo, only now we‚Äôll access it using .NET Remouting, if you understand what I mean: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a26/97d/063/a2697d06399ba831f4c323cfda725ef4.png" alt="image"></div></div><p>Source: <a href="https://habr.com/ru/post/253541/">https://habr.com/ru/post/253541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253527/index.html">Transfer of the project to Unity 5. Shaders and light</a></li>
<li><a href="../253533/index.html">Infographics "Traveling money: back and forth in a few seconds"</a></li>
<li><a href="../253535/index.html">How to improve the monetization of games using the CDN</a></li>
<li><a href="../253537/index.html">Application Virtualization with Microsoft App-V for the Undecided</a></li>
<li><a href="../253539/index.html">Store design: multi-brand, personalization, microformats, integration with 1C and marketplaces</a></li>
<li><a href="../253545/index.html">How to catch what is not. Part one. Terms and Definitions</a></li>
<li><a href="../253547/index.html">Akka.NET Bootcamp</a></li>
<li><a href="../253549/index.html">Memo: Five-minute UX guide from Squarespace and MailChimp</a></li>
<li><a href="../253551/index.html">Bolid integration in 1C or how we tamed the access control system</a></li>
<li><a href="../253553/index.html">Checking Vim with PVS-Studio on GNU / Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>