<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our recipe for a fail-safe Linux router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In high-load projects there are always increased requirements for redundancy and reliability. One of the most important links in the infrastructure is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our recipe for a fail-safe Linux router</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/226/b3c/122/226b3c1221214e00ab046b55ee22f616.png"></div><br>  In high-load projects there are always increased requirements for redundancy and reliability.  One of the most important links in the infrastructure is the router, because the availability of the network as a whole depends on its stability.  It is on such nodes that we use one of the schemes for implementing a GNU / Linux fault-tolerant virtual router using iproute2, NetGWM, keepalived, ISC DHCPD, PowerDNS.  How we customize all this, read in this article. <a name="habracut"></a><br><br><h2>  Components </h2><br>  In the ideal scheme of a fault-tolerant router, we reserve all the elements that can lead to network unavailability, that is: <br><br><ul><li>  channels of connection, </li><li>  switches, </li><li>  routers. </li></ul><br>  In general, the scheme (at the L2 level) looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/ef6/39a/3a0/ef639a3a06634c1b8e0f1d4d83129e9f.png"><br><br>  As can be seen from the diagram, we need 2 switches with support for 802.1Q VLAN.  Operator 1 switches to Switch 1 and is assigned a separate VLAN (for example, 110).  Operator 2 is switched to Switch 2 in another VLAN (for example, 120).  Separate VLAN (in our case - 200), is allocated for the local network.  A trunk is established between the switches, and the trunk links both routers, which will be the ‚Äúheart‚Äù of our virtual router ( <a href="https://en.wikipedia.org/wiki/One-armed_router">router-on-a-stick</a> scheme). <br><br>  Such a layout allows the network to remain operational when any component fails: a router, a switch or an operator. <br><br>  Stack of basic components that we use in the work of routers: <br><br><ul><li>  Ubuntu Linux; </li><li>  NetGWM is the primary gateway prioritization utility in the solution.  This is our Open Source-development, about which we are preparing a separate article (for now, I propose to become familiar with the <a href="https://flant.ru/projects/netgwm">basic documentation</a> ) <i>[ <b>Updated 08.08.2017</b> : the article was published as ‚Äú <a href="https://habrahabr.ru/company/flant/blog/335030/">Setting up the main and two backup operators on a Linux-router with NetGWM</a> ‚Äù]</i> ; </li><li>  iproute2 - to create multiple routing tables; </li><li>  keepalived - for implementing the VRRP protocol in Linux; </li><li>  ISC DHCPD - as a horizontally scalable DHCP server; </li><li>  PowerDNS - as a DNS server for the local network. </li></ul><br>  Routers are configured in approximately the same way, except for the configuration of IP addresses and keepalived. <br><br><h2>  Interface Configuration </h2><br>  We configure VLAN.  The configuration of <code>/etc/network/interfaces</code> will look something like this: <br><br><pre> <code class="bash hljs">auto lo iface lo inet loopback post-up bash /etc/network/iprules.sh post-up ip route add blackhole 192.168.0.0/16 dns-nameservers 127.0.0.1 dns-search dz <span class="hljs-comment"><span class="hljs-comment"># lan, wan: trunk dot1q auto eth0 iface eth0 inet manual # lan auto vlan200 iface vlan200 inet static vlan_raw_device eth0 address 192.168.1.2 netmask 255.255.255.0 # Operator1 auto vlan110 iface vlan110 inet static vlan_raw_device eth0 address 1.1.1.2 netmask 255.255.255.252 post-up ip route add default via 1.1.1.1 table oper1 post-up sysctl net.ipv4.conf.$IFACE.rp_filter=0 post-down ip route flush table oper1 # Operator2 auto vlan120 iface vlan120 inet static vlan_raw_device eth0 address 2.2.2.2 netmask 255.255.255.252 post-up ip route add default via 2.2.2.1 table oper2 post-up sysctl net.ipv4.conf.$IFACE.rp_filter=0 post-down ip route flush table oper2</span></span></code> </pre><br>  Highlights: <br><br><ul><li>  set up a blackhole - a good practice for local packets not to fly along the default route towards the provider; </li><li>  <code>net.ipv4.conf.$IFACE.rp_filter=0</code> - needed for multi-wan to work correctly; </li><li>  for each provider we set up a separate routing table with a single default route. </li></ul><br>  Configure packet marking to route to certain tables ‚Äî add rules to iptables: <br><br><pre> <code class="bash hljs">iptables -t mangle -A PREROUTING -i vlan110 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x1/0x3 iptables -t mangle -A PREROUTING -i vlan120 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x2/0x3 iptables -t mangle -A PREROUTING -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff iptables -t mangle -A OUTPUT -o vlan110 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x1/0x3 iptables -t mangle -A OUTPUT -o vlan120 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x2/0x3 iptables -t mangle -A OUTPUT -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff iptables -t mangle -A POSTROUTING -o vlan110 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x1/0x3 iptables -t mangle -A POSTROUTING -o vlan120 -m conntrack --ctstate NEW,RELATED -j CONNMARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-xmark 0x2/0x3</code> </pre><br>  And we will configure the routing rules for the marked packets - we do this by calling the <code>iprules.sh</code> script when running <code>ifup lo</code> (see above in <code>/etc/network/interfaces</code> ).  Inside the script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash /sbin/ip rule flush #operator 1 /sbin/ip rule add priority 8001 iif vlan110 lookup main /sbin/ip rule add priority 10001 fwmark 0x1/0x3 lookup oper1 /sbin/ip rule add from 1.1.1.2 lookup oper1 #operator 2 /sbin/ip rule add priority 8002 iif vlan120 lookup main /sbin/ip rule add priority 10002 fwmark 0x2/0x3 lookup operator2 /sbin/ip rule add from 2.2.2.2 lookup operator2</span></span></code> </pre><br>  These routing tables must be declared in <code>/etc/iproute2/rt_tables</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># reserved values 255 local 254 main 253 default 0 unspec # local 110 oper1 120 oper2</span></span></code> </pre><br><h2>  Main Gateway Balancer </h2><br>  Configure NetGWM, a utility for prioritizing the default gateway.  It will set the default route, choosing operators according to two rules: a) the priority we set, b) the status of the operator (live or not). <br><br>  To install NetGWM, you can use the <a href="https://github.com/flant/netgwm">source code on GitHub</a> or our repository for Ubuntu.  The second way with Ubuntu 14.04 LTS is as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   $ sudo wget https://apt.flant.ru/apt/flant.trusty.common.list -O /etc/apt/sources.list.d/flant.common.list #   $ wget https://apt.flant.ru/apt/archive.key -O- | sudo apt-key add - #  HTTPS- ‚Äî  ,      $ sudo apt-get install apt-transport-https #      netgwm $ sudo apt-get update &amp;&amp; sudo apt-get install netgwm</span></span></code> </pre> <br>  We indicate in the <code>/etc/netgwm/netgwm.yml</code> config that we have 2 operators, default routes for each of them, prioritization and settings for accessibility control: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#          #   ()    gateways: oper1: {ip: 1.1.1.1, priority: 1} oper2: {ip: 2.2.2.1, priority: 2} #  ,      ¬´¬ª #    online,  offline,     # -.     ( ),   # netgwm  ,    min_uptime: 900 #   ,    netgwm  #     check_sites: - 192.5.5.241 - 198.41.0.4</span></span></code> </pre> <br><br>  Note the names <code>oper1</code> and <code>oper2</code> are the names of the routing tables from <code>/etc/iproute2/ip_tables</code> .  Restartn netgwm service to start managing the default gateway for the system: <br><br><pre> <code class="bash hljs">$ sudo service netgwm restart</code> </pre> <br><h2>  Keepalived setting </h2><br>  Keepalived - implementation of the VRRP protocol for Linux.  This protocol allows you to implement a scheme with fault-tolerant routing, creating a virtual IP that will be used as the default route for the served network.  Virtual IP is automatically transferred to the backup server when the primary server fails. <br><br>  At this stage, we determine that Router 2 will play the role of Backup, and Router 1 will play the role of Master.  Configure keepalived by changing the configuration file <code>/etc/keepalived/keepalived.conf</code> : <br><br><pre> <code class="bash hljs">!       ! Configuration File <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> keepalived global_defs { notification_email { admin@fromhabr.ru } notification_email_from keepalived@example.com smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id MY_ROUTER } vrrp_instance VI_1 { interface vlan200 <span class="hljs-comment"><span class="hljs-comment"># VRRP  VLAN   virtual_router_id 17 #   ,    Master  Backup nopreempt #  ,  .  state MASTER #     state BACKUP priority 200 #       ,  100 advert_int 1 #    ‚Äú ‚Äù garp_master_delay 1 garp_master_refresh 60 authentication { auth_type PASS auth_pass qwerty #     } virtual_ipaddress { #  ,          #   ,     VRRP- 192.168.1.1/24 broadcast 192.168.1.255 dev vlan200 } #        Master, Backup, Fault  #   keepalived;      notify_master /etc/keepalived/scripts/master.sh notify_backup /etc/keepalived/scripts/backup.sh notify_stop /etc/keepalived/scripts/stop.sh notify_fault /etc/keepalived/scripts/fault.sh }</span></span></code> </pre> <br>  Since our fault-tolerant router is a multicomponent one, we decided to use the mode in which the backup / master keepalived mode switch occurs only in the event of a master server failure.  For this, just the <code>nopreempt</code> parameter <code>nopreempt</code> . <br><br><h2>  ISC DHCPD setup </h2><br>  ISC DHCPD was chosen by us, as it allows scaling DHCP to multiple servers.  It is easy to configure and has proven itself in practice.  In addition, we liked that the developers of this DHCP server came up with an elegant solution for organizing a replica between servers.  For the primary and secondary servers, different address pools are allocated and the server responds to requests, which managed to do this first, issuing the address from its pool.  At the same time, the leased IP base is synchronized.  In the event that one of the servers fails, the second one continues to issue addresses from its pool as if nothing had happened.  When returning a failed server, it starts issuing from its pool, without collisions. <br><br>  <code>/etc/dhcp/dhcpd.conf</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  DDNS    ddns-updates on; ddns-update-style interim; do-forward-updates on; update-static-leases on; deny client-updates; # ignore, deny, allow update-conflict-detection false; update-optimization false; key "update-key" { algorithm hmac-md5; secret ""; #    .  }; zone 1.168.192.in-addr.arpa. { primary 192.168.1.1; key "update-key"; } zone mynet. { primary 192.168.1.1; key "update-key"; #   failover peer "failover-partner" { primary; #      secondary address 192.168.1.3; #    port 519; peer address 192.168.1.2; #    peer port 520; max-response-delay 60; max-unacked-updates 10; load balance max seconds 3; } default-lease-time 2400; max-lease-time 36000; log-facility local7; authoritative; option ntp-servers 192.168.1.1, ru.pool.ntp.org; #      subnet 192.168.1.0 netmask 255.255.255.0 { range 192.168.1.51 192.168.1.150; #  100 ,  option subnet-mask 255.255.255.0; option broadcast-address 192.168.1.255; option domain-name-servers 192.168.1.1; option routers 192.168.1.1; ddns-domainname "mynet."; # ‚Ä¶    .     pool { failover peer "failover-partner"; range 192.168.1.151 192.168.1.250; } # ‚Ä¶   leases host printer { hardware ethernet 00:26:73:47:94:d8; fixed-address 192.168.1.8; } }</span></span></code> </pre><br>  We will need to generate the <code>update_key</code> key, with which we will update the <code>mynet</code> zone.  Generate it and display: <br><br><pre> <code class="bash hljs">$ dnssec-keygen -r /dev/urandom -a HMAC-MD5 -b 64 -n HOST secret_key Ksecret_key.+157+64663 $ cat Ksecret_key.+*.private | grep ^Key | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> bdvkG1HcHCM=</code> </pre> <br>  Copy the generated key and paste into the configuration file instead of the word KEY. <br><br><h2>  PowerDNS setup </h2><br>  As a DNS server, we preferred PowerDNS, since it has the ability to store zones in MySQL DBMS, which is convenient to replicate between the first and second servers.  In addition, PoweDNS is a productive solution that functions well in a high-loaded router. <br><br>  Setting up PowerDNS start with preparing the database. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   MySQL CLI $ mysql -u root -p #       ,      mysql&gt; CREATE DATABASE IF NOT EXIST powerdns; mysql&gt; GRANT ALL ON powerdns.* TO 'pdns_admin'@'localhost' IDENTIFIED BY 'pdns_password'; mysql&gt; GRANT ALL ON powerdns.* TO 'pdns_admin'@'localhost.localdomain' IDENTIFIED BY 'pdns_password'; mysql&gt; FLUSH PRIVILEGES; #           mysql&gt; USE powerdns;</span></span></code> </pre><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> EXIST <span class="hljs-string"><span class="hljs-string">`domains`</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> auto_increment, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">master</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, last_check <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, notified_serial <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`records`</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> auto_increment, domain_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">content</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ttl <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, prio <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, change_date <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`supermasters`</span></span> ( ip <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, nameserver <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">account</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`domain_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`records`</span></span>(<span class="hljs-string"><span class="hljs-string">`domain_id`</span></span>); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`rec_name_index`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`records`</span></span>(<span class="hljs-string"><span class="hljs-string">`name`</span></span>); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-string"><span class="hljs-string">`nametype_index`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">`records`</span></span>(<span class="hljs-string"><span class="hljs-string">`name`</span></span>,<span class="hljs-string"><span class="hljs-string">`type`</span></span>); mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> name_index<span class="hljs-string"><span class="hljs-string">` ON `</span></span>domains<span class="hljs-string"><span class="hljs-string">`(`</span></span><span class="hljs-keyword"><span class="hljs-keyword">name</span></span><span class="hljs-string"><span class="hljs-string">`);</span></span></code> </pre><br><pre> <code class="bash hljs">quit;</code> </pre> <br>  Now you need to configure PowerDNS and teach it to work with the database.  To do this, you need to install the <code>pdns-backend-mysql</code> package and change the <code>/etc/powerdns/pdns.conf</code> config: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    allow-axfr-ips=127.0.0.0/8,192.168.1.0/24 allow-dnsupdate-from=127.0.0.0/8,192.168.1.0/24 allow-recursion=127.0.0.0/8,192.168.1.0/24 #    config-dir=/etc/powerdns daemon=yes disable-axfr=no dnsupdate=yes guardian=yes local-address=0.0.0.0 local-address-nonexist-fail=no local-port=53 local-ipv6=::1 #         master=yes slave=no recursor=127.0.0.1:5353 setgid=pdns setuid=pdns socket-dir=/var/run version-string=powerdns webserver=no #  MySQL launch=gmysql #    -  ,   keepalived gmysql-host=192.168.1.1 gmysql-port=3306 #    ,      gmysql-user=pdns_admin gmysql-password=pdns_password gmysql-dnssec=yes</span></span></code> </pre> <br>  This completes the basic PowerDNS configuration.  We also need to configure the recursor - a handler for recursive DNS queries, which can significantly improve the performance of the DNS server.  <code>/etc/powerdns/recursor.conf</code> file: <br><br><pre> <code class="bash hljs">daemon=yes forward-zones-file=/etc/powerdns/forward_zones <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-address=127.0.0.1 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-port=5353 quiet=yes setgid=pdns setuid=pdns</code> </pre><br>  <code>forward_zones</code> intranet zones into the <code>forward_zones</code> file that are served by neighboring servers: <br><br><pre> <code class="bash hljs">piter_filial.local=192.168.2.1 2.168.192.in-addr.arpa=192.168.2.1</code> </pre> <br>  At the end of the configuration, we restart the <code>pdns</code> and <code>pdns-recursor</code> . <br><br>  After start we configure a replica of MySQL between servers. <br><br><h2>  Conclusion </h2><br>  We use this solution not only in its pure form.  In most cases, it is complicated by adding VTun, OpenVPN or IPSec tunnels through the main and backup carrier and dynamic routing, which is implemented using Quagga.  Therefore, the scheme proposed in the article, I propose to perceive as a foundation for creating more complex solutions. <br><br>  We will be glad if you ask your questions in the comments or point out places in the scheme that can be improved.  And, of course, subscribe to our hub, so as not to miss new useful materials!  ) </div><p>Source: <a href="https://habr.com/ru/post/331128/">https://habr.com/ru/post/331128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331116/index.html">New plug-in for Sennheiser headsets and free upgrade to 3CX v15.5</a></li>
<li><a href="../331118/index.html">Catch data big and small! (Overview of Data Science courses from the Cognitive Class)</a></li>
<li><a href="../331120/index.html">How to write the most awful backend for a mobile application</a></li>
<li><a href="../331122/index.html">Android: dynamically load fragments from the network</a></li>
<li><a href="../331124/index.html">Terminology OneGet, NuGet, Chocolatey, PowerShellGet - we break it down</a></li>
<li><a href="../331130/index.html">Functional programming in Scala - is it necessary at all?</a></li>
<li><a href="../331132/index.html">It was 2017. Where is UDP fragmentation?</a></li>
<li><a href="../331134/index.html">Emacs Lisp Alternative</a></li>
<li><a href="../331136/index.html">What is the essence of design? I find the answer to the question considering the UI and UX, new terms in the field of web design</a></li>
<li><a href="../331138/index.html">Do not use return in Scala</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>