<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of a productive game server on Netty + Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised, I provide a description of a productive game server on Netty, which I use in my projects. 
 Everything described below is not true in the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of a productive game server on Netty + Java</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://piccy.info/view3/2516552/e19c99af98797b47098f29d75821d4bb/"><img src="https://habrastorage.org/getpro/habr/post_images/a23/296/482/a232964828e360b7f7f2a26be5fb8fec.jpg" alt="Piccy.info - Free Image Hosting"></a> <br><br>  As promised, I provide a description of a productive game server on Netty, which I use in my projects. <br>  Everything described below is not true in the last resort, but only the experience of using technologies in real projects. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Start over. </h4><br><br>  Our task is to make a game server. <br><br>  What are the main tasks of the game server? <br>  In short, then: <br><ul><li>  Receive package from client </li><li>  Process this packet (decryption, deserialization, etc.) </li><li>  Calculate the game situation </li><li>  To send customers changes to the game situation. </li></ul><br>  ... <br><br>  We will not consider working with the database and other things now.  Focusing on the network part. <br><br><h5>  How can Netty help us in this? </h5><br><br>  Netty is a network library that will take over the direct work of sockets.  Connect, disconnect clients.  Reception, sending and fragmentation of packets.  Those.  netty will take care of all the low-level work with sockets. <br><br><h5>  How will netty help us? </h5><br><br>  Netty implements a very convenient architecture.  For example, it allows you to connect multiple input data handlers.  Those.  in the first handler, we divide the incoming data stream into packets, and in the second we are already processing these packets.  At the same time, you can flexibly manage the settings of the library itself, allocate the required number of threads or memory to it, etc ... <br>  A common architecture with Netty might look like this: <br><br> <a href="http://piccy.info/"><img src="https://habrastorage.org/getpro/habr/post_images/fbf/90b/4b1/fbf90b4b171791a62fb11e048483b6aa.png" alt="Piccy.info - Free Image Hosting"></a> <br><br>  We get 3 handlers: <br>  1. <b>Connection handler</b> is a handler that is responsible for connecting / disconnecting clients.  There will be checking the connectivity of clients (black, white lists, IP filters, etc.) as well as the correct disconnection of clients with the closure of all resources used. <br><br>  2. <b>Frame handler</b> is a handler that divides the data stream into separate packets. <br>  For convenience, we assume that the package consists of two parts.  1-header, which describes the length of the packet, and 2-directly data packet. <br><br>  3. <b>Packet handler</b> is a game message handler.  Here we will receive data from the packet and further process it. <br><br>  Let's sort each part in the code. <br><br><h6>  Connection handler </h6><br><pre><code class="java">public class ConnectionHandler extends SimpleChannelHandler
{

    @Override
    public void channelOpen( ChannelHandlerContext ctx, ChannelStateEvent e ) throws Exception
    {
        if(       )
        {
	//  
            e.getChannel().close();
        }
    }
    
    @Override
    public void channelClosed( ChannelHandlerContext ctx, ChannelStateEvent e ) throws Exception
    {
        // ,   ,        .
    }
  
    
    @Override
    public void exceptionCaught( ChannelHandlerContext ctx, ExceptionEvent e ) throws Exception
    {
	//   
        log.error( "message: {}", e.getCause().getMessage() );
    }    
    
}</code></pre><br>
<br>
<h6>Frame handler. </h6><br>
      .     ,    .<br>
<pre><code class="java">public class FrameHandler extends ReplayingDecoder&lt;DecoderState&gt;
{
    public enum DecoderState
    {
        READ_LENGTH,
        READ_CONTENT;
    }  

    private int length;

    public ProtocolPacketFramer()
    {
        super( DecoderState.READ_LENGTH );
    }
    
    @Override
    protected Object decode( ChannelHandlerContext chc, Channel chnl, ChannelBuffer cb, DecoderState state ) throws Exception
    {
        switch ( state )
        {
            case READ_LENGTH:
                length = cb.readInt();
                checkpoint( DecoderState.READ_CONTENT );
                
            case READ_CONTENT:
                ChannelBuffer frame = cb.readBytes( length );
                checkpoint( DecoderState.READ_LENGTH );
                return frame;
                
            default:
                throw new Error( "Shouldn't reach here." );
        }
    }
}</code></pre><br>
<br>
<h6>Packet handler</h6><br>
<pre><code class="java">public class ProtocolPacketHandler extends SimpleChannelHandler
{
    @Override
    public void messageReceived( ChannelHandlerContext ctx, MessageEvent e ) throws Exception
    {
	//  
            byte[] msg = ((ChannelBuffer)e.getMessage()).array();
            
	//     
            Packet packet = new Packet();
            packet.setData( msg );
            packet.setSender( session );

	//      
            session.addReadPacketQueue( packet );

	//      
            Server.getReader().addSessionToProcess( session );
    }
}</code></pre><br>
<br>
 ,      . Packet              .         .<br>
<br>
   .         .    ,            ,     .      .        2 .    TCP ,                 .      .  ,         .       .<br>
      ,  TCP         (   Akka )      .       . TCP   Netty              ,        .<br>
<br>
    .<br>
<br>
<a href="http://piccy.info/"><img src="https://habrastorage.org/getpro/habr/conversation/4b8/02b/e89/4b802be897a0559ff2aec9ee1774702e.png" alt="Piccy.info - Free Image Hosting"></a><br>
<br>
     .          .     TCP   Netty    .            .<br>
<br>
    .    Session         ,      2 ,      . Packet         . Netty   ,                .       ,            .     .        .       . ‚Ä¶  - ))  ,   , .<br>
<br>
     .<br>
<a href="http://piccy.info/"><img src="https://habrastorage.org/getpro/habr/post_images/70f/fbb/6bc/70ffbb6bc4874d65deaf0203df07c4d9.png" alt="Piccy.info - Free Image Hosting"></a><br>
<br>
<h6>  .</h6><br>
<br>
<pre><code class="java">public final class ReadQueueHandler implements Runnable
{
    private final BlockingQueue&lt;Session&gt; sessionQueue;
    private final ExecutorService        threadPool;
    private int                          threadPoolSize;
    
    public ReadQueueHandler( int threadPoolSize )
    {
        this.threadPoolSize = threadPoolSize;
        this.threadPool     = Executors.newFixedThreadPool( threadPoolSize );
        this.sessionQueue   = new LinkedBlockingQueue();
        
        initThreadPool();
    }
    
    private void initThreadPool()
    {
        for ( int i = 0; i &lt; this.threadPoolSize; i++ )
        {
            this.threadPool.execute( this );
        }
    }
    
    //      
    public void addSessionToProcess( Session session )
    {
        if ( session != null )
        {
            this.sessionQueue.add( session );
        }
    }    
    
    @Override
    public void run()
    {
        while ( isActive )
        {
                //     
                Session session = (Session) this.sessionQueue.take();
                
                //     
                //  
                packet = session.getReadPacketQueue().take();

                //       
                data =  packet.getData();
        }
    }    
}</code></pre><br>
<br>
    .   .             .        TCP      .       . Netty   .          .<br>
<br>
     protobuf.      .    ,         )<br>
<br>
  ,    AMD 1.4  (lenovo edge 13),   18-20   .    .<br>
<br>
P.S.   ‚Äî .</div><p>Source: <a href="https://habr.com/ru/post/136765/">https://habr.com/ru/post/136765/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136758/index.html">LRU cache reject method</a></li>
<li><a href="../136759/index.html">Worldwide IPv6 Launch - this time for real</a></li>
<li><a href="../136762/index.html">Criticism of UMI.CMS</a></li>
<li><a href="../136763/index.html">Migrate flash applications to html5. First video tutorial</a></li>
<li><a href="../136764/index.html">Magnet Internet 1 - Magnet</a></li>
<li><a href="../136766/index.html">OOP patterns in metaphors</a></li>
<li><a href="../136768/index.html">Headphone amplifier simple and fast</a></li>
<li><a href="../136771/index.html">How I learned that we have merged traffic</a></li>
<li><a href="../136772/index.html">Events for entrepreneurs: where to go, depending on the goal</a></li>
<li><a href="../136773/index.html">Synchronize contacts between forests</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>