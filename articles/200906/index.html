<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Groupon migrated from monolithic Rails applications to the new Node.js infrastructure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I-tier: monolith splitting 
 We recently completed the annual Grupon web traffic migration project in the USA from the monolithic Ruby on Rails applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Groupon migrated from monolithic Rails applications to the new Node.js infrastructure</h1><div class="post__text post__text-html js-mediator-article"><h4>  I-tier: monolith splitting </h4><br>  We recently completed the annual Grupon web traffic migration project in the USA from the monolithic Ruby on Rails application to the new Node.js stack and obtained significant results. <br><br>  From the very beginning, the entire American frontend Web frontend was a single source for Ruby.  The frontend code developed rapidly, which made it difficult to support and complicated the process of adding new features.  As a solution to the problem with this giant monolith, we decided to restructure the frontend by dividing it into smaller, independent and easier to manage parts.  The basis of this project was the division of the monolithic website into several independent Node.js applications.  We also redesigned the infrastructure to ensure that all applications work together.  The result was Interaction Tier (I-Tier). <br><br>  Here are some of the highlights of this global architectural migration: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ‚Ä¢ Pages on the site load much faster. <br><br>  ‚Ä¢ Our development teams can develop and add new features faster and with less dependence on other teams. <br><br>  ‚Ä¢ We can avoid re-developing the same features in different countries where Grupon is available. <br><br>  This post is the first of a series of posts about how we restructured the site and what huge benefits we see in the future, which will be the basis of the promotion of the Groupon company. <br><a name="habracut"></a><br><h4>  Short story </h4><br>  Initially, Groupon was a one-page site that displayed daily deals to Chicago residents.  An example of such a typical transaction could be a discount to a local restaurant or a ticket to a local concert. <br><br>  Each transaction had a ‚Äútipping point‚Äù - the minimum number of people who had to buy a transaction in order for it to become valid.  If enough people bought a deal that reached a turning point, everyone got a discount.  Otherwise, everyone was the loser. <br><br>  The site was originally created as a Ruby on Rails application.  The Rails application was a good choice to start with, as for our team of developers it was one of the easiest ways to quickly pick up and run a website.  In addition, it was pretty easy to implement new features using Rails;  at that time it was a huge plus for us, as the feature set was constantly increasing. <br><br>  The original Rails architecture was fairly simple: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/143/faf/e5d/143fafe5d2743f4335f2eb652538e0da.png" alt="image"><br><br>  However, we quickly outgrew the ability to serve all of our traffic with a single Rails application directed to a single database cluster.  We added more frontend servers and database replicas and placed everything behind the CDN, but this worked only until records in the database became a critical element.  Order processing has caused a number of entries in the database;  as a result, we decided to move this code from our Rails application to a new service with its separate database cluster. <br><br>  We continued to follow a similar pattern, breaking the existing backend assignment into new services, but everything else on the website (views, controllers, resources, etc.) remained part of the original Rails application: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6f/0a4/f91/a6f0a4f919dfa661324bee795cf15f54.png" alt="image"><br><br>  This architecture change won us some time, but we knew that this was not for long.  The source code could still be managed only by a small team of developers at that time, and this allowed us to keep the site from being overloaded during peak traffic. <br><br><h4>  Globalization </h4><br>  Around this time, Groupon began to expand globally.  In a short period, we have moved from conducting operations only in the United States to operating in 48 different countries.  At this time, we also acquired several international companies, such as CityDeal.  Each acquisition has already included its software stack. <br><br>  CityDeal architecture had common features with Groupon architecture, but it was a completely autonomous implementation created by another team.  As a result, the differences were in design and technology - Java instead of Ruby, Apache instead of nginx, PostgreSQL instead of MySQL. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8c/524/39c/d8c52439c3f6065ed32bf353a3a4c7ec.png" alt="image"><br><br>  As we see, in the case of fast-growing companies, we had to choose between slowing down the pace to integrate different stacks and supporting both systems, knowing that we would be in a technical debt, which would later need to be returned.  For the first time, we made an international decision to keep the American and European sales separate in exchange for a more rapid development of the company.  And the more acquisitions followed, the more complexity was added to the architecture. <br><br><h4>  Mobile applications </h4><br>  We also created mobile clients for the iPhone, iPad, Android and Windows Mobile;  we definitely did not want to create a separate mobile application for each country in which Grupon was available.  Instead, we decided to create an API layer on top of each of our backend software platforms;  Our mobile clients accessed any API endpoint, corresponding to the user's country. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5d3/569/a70/5d3569a70fbedf73e41dc8d97c663fba.png" alt="image"><br><br>  That worked well for our mobile team.  They could build a mobile app that worked in all of our countries. <br><br>  But there was still a snag.  Whenever we created a new product or feature, we first did it for the web and only then created an API, so the feature could be used on a mobile device. <br><br>  Now that our company has become half mobile in the United States, we need to build, first and foremost, a mobile way of thinking.  Accordingly, we want to create an architecture in which a separate backend could serve mobile and desktop clients with minimal development effort. <br><br><h4>  Compound monoliths </h4><br>  While Grupon continued to develop and launch new products, the amount of Ruby frontend source code was increasing.  Too many developers worked on the same code.  This has reached the point where it has become difficult for developers to launch an application locally.  Test suites slowed down, and unreliable tests became a problem.  And since it was one code base, the whole application needed to be deployed urgently.  When the error in production required a rollback, instead of one feature, the changes of each command would be returned.  In short, we had a lot of problems with monolithic code. <br><br>  But we have repeatedly encountered similar problems before.  We not only had to deal with the code in the United States, but we had many of the same problems with the European code.  We needed to completely restructure the frontend. <br><br><h4>  Rewrite all </h4><br>  Rebuilding the whole front end is risky.  It takes a lot of time, involving a lot of different people, and there is a big chance that in the end nothing will come out better than the old system.  Or, worse, it takes a lot of time, and you give up halfway, spending a lot of effort, but not getting any results. <br><br>  But we had tremendous success in the past, when we restructured smaller parts of our infrastructure.  For example, both our mobile website and client portal were rebuilt with excellent results.  This experience gave us a good starting point and from it we began to set goals for our project. <br><br><h4>  Objective 1: Combine our front-ends </h4><br>  With numerous software stacks that implement the same features in different countries, we were not able to move as quickly as we wanted.  We needed to eliminate redundancy in our stack. <br><br><h4>  Goal 2: Put mobile apps on the same level as the web. </h4><br>  Since approximately half of our company in the United States became mobile, we could not afford to create a separate desktop and mobile versions.  We needed an architecture in which the web would be another client that would use the same API as our mobile apps. <br><br><h4>  Goal 3: Make the site faster </h4><br>  Our site was slower than we wanted.  While we were in a hurry trying to control the growth of the site, the US front-end accumulated technical debt, which made it difficult to optimize.  We wanted to find a solution that would not require a large amount of code to serve requests.  We wanted something simple. <br><br><h4>  Goal 4: Allow teams to progress independently </h4><br>  When Grupon was first launched, the site was really simple.  But since then we have added many new products with development teams to support them around the world.  We wanted each team to be able to create and deploy its features independently of other teams and quickly.  We needed to eliminate the interdependence between the teams, the reason for which was that everything was in the same code. <br><br><h4>  An approach </h4><br>  First, we decided to split each main feature of the site into separate web applications: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/62c/9d3/3b5/62c9d33b581b7d9a9decc96981ee03b7.png" alt="image"><br><br>  We built a framework on Node.js, which included the common functionality needed by all applications, so that our teams could easily create these individual applications. <br><br><h4>  Note: why Node.js? </h4><br>  Before building our new frontend layer, we evaluated several different software stacks to see which one would be best for us. <br><br>  We were looking for a solution for a specific task - to efficiently serve a multitude of incoming HTTP requests, to execute parallel API requests to the services of each of these HTTP requests;  and return the results to HTML.  We also wanted something that we could confidently monitor, deploy and maintain. <br><br>  We wrote prototypes using several software stacks and tested them.  We will later post more detailed information with specifics, but in general we found that Node.js is well suited for this particular problem. <br><br><h4>  Approach, continuation ... </h4><br>  Then we added a top routing layer that redirected users to the appropriate application based on the page they were visiting: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a7/bb0/703/7a7bb07030c9324bf733c4e47b17a64e.png" alt="image"><br><br>  We built the Grupon routing services (which we call Grout) as a nginx module.  This allows us to do many interesting things, such as conducting A / B tests between different implementations of the same application on different servers. <br><br>  And in order for all these independent web applications to work properly together, we created separate services for sharing layouts and CSS styles that support common configuration and control A / B test modes.  We will post more details about these services later. <br><br>  All this is located in front of our API and nothing in the frontend layer is allowed to access the database or backend service directly.  This allows us to create a single integrated API layer that serves both our desktop and mobile applications: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f5/f4b/e1c/6f5f4be1c120976325f26bb48a7fcc0d.png" alt="image"><br><br>  We are working on integrating our backend systems, but in the short term, we still need to support our US and European subsystems.  Therefore, at the same time, we developed our frontend, which could work with two backends: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/110/763/a14/110763a1441bcac71374b6089d2225f1.png" alt="image"><br><br><h4>  Results: </h4><br>  We have just completed the transition of our American frontend from Ruby to the new Node.js infrastructure.  The old monolithic frontend was divided into about 20 separate web applications, each of which was completely rewritten.  We currently serve an average of 50 thousand requests per minute, but we expect an increase in this traffic during the holiday season.  And this number will increase significantly, as we move traffic from our other 48 countries. <br><br>  These are the advantages that we have revealed recently: <br><br>  - Pages load faster - usually by 50%.  This is partly due to a change in technology and partly because we had the chance to rewrite all of our web pages to speed up our work.  And we are still planning to make significant progress here, as we make additional changes. <br><br>  - We serve the same amount of traffic with a smaller amount of equipment compared to the old stack. <br><br>  - Teams can deploy changes to their applications independently. <br><br>  - We can make changes to the code of an individual feature much faster than we could have done with our old architecture. <br><br>  In general, this migration made it possible for our development team to load pages faster, with fewer interdependencies, and removed some of the performance limitations of our old platform.  But we plan to make many other improvements in the future, and in the near future we will post details. <br><br>  [ <a href="https://engineering.groupon.com/2013/misc/i-tier-dismantling-the-monoliths/">original article</a> at engineering.groupon.com] </div><p>Source: <a href="https://habr.com/ru/post/200906/">https://habr.com/ru/post/200906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200894/index.html">Information security and certification. If there is no difference - why pay more?</a></li>
<li><a href="../200896/index.html">Compact USB HID Bootloader for ATtiny85</a></li>
<li><a href="../200898/index.html">Fast deserialization of really big JSON responses</a></li>
<li><a href="../200902/index.html">Importing OpenStreetMap to MySQL</a></li>
<li><a href="../200904/index.html">Anatoly Wasserman approves Clouds</a></li>
<li><a href="../200908/index.html">Drupal 7. DIY subscription module</a></li>
<li><a href="../200910/index.html">Algorithm and advantages of CMS automatic update</a></li>
<li><a href="../200912/index.html">Linux - the story of one hacking</a></li>
<li><a href="../200914/index.html">We decode GSM with RTL-SDR for $ 30</a></li>
<li><a href="../200916/index.html">Ajax file uploads using jQuery and CodeIgniter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>