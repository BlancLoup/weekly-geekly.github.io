<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ESET participated in the elimination of the Gamarue botnet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A large-scale operation to eliminate the network of botnets Gamarue (Andromeda), which had been operating for several years, was completed. The operat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ESET participated in the elimination of the Gamarue botnet</h1><div class="post__text post__text-html js-mediator-article">  A large-scale operation to eliminate the network of botnets Gamarue (Andromeda), which had been operating for several years, was completed.  The operation involving ESET, Microsoft and law enforcement agencies lasted more than a year. <br><br><img src="https://habrastorage.org/webt/8l/p6/or/8lp6or2qqz5gvqti1nviejconw8.jpeg"><br><br><h3>  Introduction </h3><br>  Gamarue (Win32 / TrojanDownloader.Wauchos by ESET classification) has been known since the end of 2011 and has been sold in a darkweb called Andromeda bot.  The bot was in demand, which caused the existence of 464 independent botnets at the time of elimination.  In the past, Wauchos was the leader in the number of attacks reflected by ESET products. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As part of the operation, ESET provided technological expertise - we tracked the botnets on the Wauchos network, identified their C &amp; C servers for subsequent neutralization, tracked other malicious programs that were installed in the infected systems. <a name="habracut"></a>  Together with Microsoft, we provided law enforcement with the following information: <br><br>  - 1214 domains and IP addresses of the managing C &amp; C servers of the botnet <br>  - 464 individual botnets <br>  - 80 associated malware families <br><br>  In Figure 1, you can see the Wauchos distribution map, based on our telemetry.  Obviously, Wauchos is a global problem, and the operation to eliminate it was worth the effort.  We present the data of last year - at the peak of Wauchos activity. <br><br><img src="https://habrastorage.org/webt/wi/qv/de/wiqvde3yz7sc5x6idboms3hfcuw.png"><br>  <i>Figure 1. Distribution of Wauchos (December 2016)</i> <br><br>  If you suspect that your Windows computer has been compromised and you are not an ESET user, download and use the free <a href="https://www.esetnod32.ru/home/products/online-scanner/">ESET Online Scanner</a> tool.  It will remove all threats, including Wauchos, by detecting them in the system. <br><br><h3>  What is wauchos? </h3><br>  This common malware has existed since 2011.  We have previously written about him in a blog (see "Sources").  In this section, we look at the basis of Wauchos: what it is and how it is distributed, and then we will describe the technical details of the malicious program. <br><br>  Wauchos is used primarily to steal credentials, as well as to download and execute other malicious programs on the system.  Thus, if the system is compromised by Wauchos, another malware is likely installed in it. <br><br>  Wauchos has a modular architecture.  Its functionality can be expanded by adding the appropriate modules.  Among the known modules are a keylogger, spyware for intercepting entered logins and passwords (formgrabber), rootkit, SOCKS proxy and TeamViewer-bot. <br><br>  There are five major versions of Wauchos based on their own version control scheme: 2.06, 2.07, 2.08, 2.09 and 2.10.  In the first three, the build number is included in the first POST request sent by the bot to the C &amp; C server, so identifying the version is quite simple.  In later versions of Wauchos, the <code>bv</code> parameter in the POST request was removed.  Nevertheless, it is relatively easy to determine the version of the bot, if you look at the row of identifiers sent to the server (3): <br><br><img src="https://habrastorage.org/webt/qo/tj/e4/qotje4vthmnjele8cl4h51iokfm.png"><br>  (* Note the switch to JSON) <br><br>  A typical POST request is shown in Figure 2. The string of identifiers is encrypted using the RC4 algorithm and then encoded with base64. <br><br><img src="https://habrastorage.org/webt/6c/vv/bz/6cvvbz5s-0pc4vavpxaiiiex4cg.png"><br>  <i>Figure 2. Typical POST request</i> <i><br></i> <br>  Since the linker for version 2.06 was publicly available several years ago, we saw quite a few versions of this botnet in the telemetry data.  However, to our knowledge, the most common is the latest version - 2.10. <br><br>  The global nature of the threat is also noted in the diversity of C &amp; C servers that Wauchos operators use.  Throughout the study, we opened new management servers every month.  Figure 3 shows the top-level domains used by C &amp; C servers;  Figure 4 shows the geography of the IP addresses of these servers at the time of connecting to our crawler in November and December 2016. <br><br><img src="https://habrastorage.org/webt/pu/0u/ov/pu0uovkboe_c2ua-sg11jrpkn5e.png"><br>  <i>Figure 3. Top-level domains of C &amp; C servers in November and December 2016</i> <br><br><img src="https://habrastorage.org/webt/vx/ua/08/vxua08hnuqvsfr0ocqslvphny5o.png"><br>  <i>Figure 4. Geography of IP addresses of C &amp; C servers in November and December 2016</i> <br><br>  Interestingly, a number of studied samples check the keyboard settings and stop the attack if the system uses Russian, Belarusian, Ukrainian or Kazakh languages. <br><br><h3>  Infection vector </h3><br>  Because Wauchos is bought and distributed by different operators, different vectors are used for infection.  Historically, Wauchos samples were distributed via social networks, instant messengers, removable media, spam, and exploit kits.  Figure 5 shows a typical letter with a sample of Wauchos in the attachment. <br><br><img src="https://habrastorage.org/webt/sb/3k/0b/sb3k0bx02h0mgq1vadfqgcidiu0.png"><br>  <i>Figure 5. Typical spam with Wauchos in the application.</i> <i><br></i> <br>  <b>Installation under the scheme pay-per-install</b> <br><br>  As stated earlier, Wauchos is primarily used to distribute other malware.  With the help of our automated systems, we collected statistics about Malvari loaded by the Wauchos bots we were tracking.  Figure 6 shows the various modules that were loaded by our search bot when they first connected to C &amp; C. <br><br><img src="https://habrastorage.org/webt/g6/4i/yf/g64iyfinzgpzxsr3guwjzguvlk8.png"><br>  <i>Figure 6. Download Statistics - December 2016</i> <br><br>  The first download is usually the loader module, which we describe in the next section.  Next, other malicious programs are being installed - in December 2016, mainly spam bots were downloaded, in particular, Win32 / Kasidet, Win32 / Kelihos and Win32 / Lethic.  Of course, if we talk about the pay-per-install scheme, the statistics change from time to time.  Wauchos downloaded and other malware, but, according to our telemetry, most often it was the above programs. <br><br><h3>  Technical analysis </h3><br>  In this section, we will present some technical details that have not been publicly discussed before, but create a context against the background of the liquidation of a botnet.  In particular, we describe two modules that provide communication through third-party channels for the botmaster (botmaster), increasing the resilience of the botnet to the dismantling operations. <br><br>  <b>Versions of Wauchos</b> <br><br>  First of all, we would like to help colleagues interested in this malware family, and briefly describe, using the ESET classification, the major versions and their capabilities. <br><br>  Win32 / Wauchos.B is the most common Wauchos component detection version 2.06.  Version 2.10 is usually detected as Win32 / Wauchos.AW.  In addition, the Win32 / Wauchos family includes other modules, packaged versions of the listed versions, and other Wauchos assemblies, including 2.07, 2.08, or 2.09;  According to our telemetry data, they are less common and, therefore, less relevant in the discussion. <br><br>  In the latest version of Wauchos (2.10), the bot supports the following commands: <br><img src="https://habrastorage.org/webt/q4/eh/yy/q4ehyy3eswt_tlzha1yyksoz0p4.png"><br><br>  <b>Modules</b> <br><br>  Wauchos is an extensible bot that allows the operator to create and use custom modules.  However, there are several widely available modules that are found in different botnets.  In this section, we look at the modules that we managed to load using our tracking mechanism. <br><br><img src="https://habrastorage.org/webt/n7/m0/1_/n7m01_t59iwcrubs036w-kvlof8.png"><br><br>  When a bot loads a module, it must first decrypt its header with the RC4 key.  The header contains a unique key needed to decrypt the payload.  After decryption, the last operation is unpacking the module using aPLib.  Next, the malware uses a custom loader to load a binary blob into memory.  Binary blobs can be loaded directly into memory and executed. <br><br>  The number of different RC4 keys collected by our tracking systems in different botnets turned out to be small ‚Äî about 40. This makes it easy to decipher any downloaded components, even those that are not needed for sample analysis. <br><br>  As for C &amp; C communications, all the samples we analyzed to resolve C &amp; C domains directly used Google‚Äôs DNS infrastructure.  Version 2.06 tries to resolve the IP address of the C &amp; C server using UDP sockets up to 8.8.4.4:53.  If this fails, it first returns to the DnsQueryA () API, and then to the gethostbyname () API.  Version 2.10 intercepts GetAddrInfoW () and allows all calls to it using UDP packets up to 8.8.4.4:53, if this fails, then returns to the original API GetAddrInfoW (). <br><br>  <b>New persistence mechanisms</b> <br><br>  In this section, we will talk about the two modules that appeared this year.  We believe that they are designed to prevent dismantling, like the current operation, and to this end provide a third-party communication channel for the botmaster.  This behavior was described in the article under link 4 in the ‚ÄúSources‚Äù section. <br><br>  The first module is a USB spreader (a utility for distributing malware to flash drives).  The second is performing a fileless attack using a bootloader, which is stored in the registry and is launched by the PowerShell script at startup. <br><br>  <b>USB spreader - Win32 / Bundpil.CS</b> <br><br>  The module allows you to intercept the functions of the DNS API, tries to spread through removable media and uses the DGA (Domain Generation Algorithm) to load additional data. <br><br>  One process scans for connected removable media and, upon finding the required one, installs a copy of the malicious program on it. <br><br>  The second function of the module is to intercept the DNS API and replace certain domains with coded ones.  For example, one studied sample redirected all requests for these old Wauchos domains: <br><br>  - designfuture.ru <br>  - disorderstatus.ru <br>  - atomictrivia.ru <br>  - differentia.ru <br><br>  on gvaq70s7he.ru. <br><br>  The module also has a DGA component that tries to connect to automatically generated domains for loading additional data into the compromised system.  The pseudocode of the DGA algorithm can be found on our <a href="https://github.com/eset/malware-ioc/tree/master/gamarue">github page</a> .  The URLs he tries to reach correspond to the following patterns: <br><br>  - &lt;dga_domain&gt; .ru / mod <br>  - ww1. &lt;Dga_domain&gt; .ru / 1 <br>  - ww2. &lt;Dga_domain&gt; .ru / 2 <br><br>  We were able to load a binary blob from the DGA circuit.  What we got was an encrypted blob and started with ‚ÄúMZ‚Äù.  The module will remove these two bytes and save the blob in the Windows registry. <br><br>  The main Wauchos bot decrypts the payload encrypted with RC4, unpacks it with aPLib and loads it as a normal module.  Please note that for this process the same RC4 keys are used as for encrypting modules.  The binary file obtained in this way is an updated version of USB spreader.  We assume that through DNS interception, the botmaster can regain bots control by downloading the latest version of the module from the monitored domain, and then redirect the hard-coded domains mainly to Wauchos. <br><br>  <b>Loader</b> <b><br></b> <br>  The latest module is a small downloader that uses DGA to access the following URLs, depending on the version: <br><br>  - &lt;dga_domain&gt; .ru / ld.so <br>  - &lt;dga_domain&gt; .ru / last.so <br>  - &lt;dga_domain&gt; .ru / nonc.so <br><br>  The module is used to load a binary blob that it stores in the registry.  Blobs can be decrypted using the RC4 key contained in the main Wauchos payload. <br>  One of the variants of malware downloaded by this module is another boot loader detected as TrojanDownloader.Small.AHI.  The malicious program is of interest, since its only task is to download an updated version of the loader module and save it in the registry in encrypted form, but with one nuance. <br><br>  It also adds a startup key with a PowerShell script that decrypts and executes the encrypted binary file from the registry key after each computer startup.  Right now the binary is just being updated.  However, its DGA can be used as a secondary communication channel to install a new payload and regain control over bots if someone tries to intercept it.  The process is shown in Figure 7. <br><br><img src="https://habrastorage.org/webt/qg/tq/gj/qgtqgjdjhxstkh7xg4dcxlyudre.png"><br>  <i>Figure 7. Loader module operation diagram</i> <br><br>  It is interesting to note that we observed the download of Necurs.B through the DGA and this module.  However, in most downloads, Win32 / TrojanDownloader.Small.AHI was installed on the system.  In fact, this program was detected many times, according to our cloud statistics.  The greatest activity of the module was noted using our search bot in August 2016, after which it was reduced to zero.  It is not known whether we were blacklisted, or the Malvari operators simply tested the function for a short period of time. <br><br><h3>  Conclusion </h3><br>  Wauchos (Gamarue / Andromeda) is an old botnet that has been updated for several years.  ESET specialists have been monitoring its infrastructure for years, as well as other threats.  Monitoring is important for tracking any changes in the behavior of a malicious program, as well as for subsequent elimination. <br><br>  Wauchos uses old methods to compromise new systems.  Users should take care when opening files on removable media, as well as files received via email, social networks or instant messengers.  If you think your system is infected with Wauchos, use the free <a href="https://www.esetnod32.ru/home/products/online-scanner/">tool</a> to check and remove Malvari. <br><br>  Information about the botnet was collected using the telemetry service <a href="https://www.esetnod32.ru/business/services/eti/">ESET Threat Intelligence</a> .  ESET products detect thousands of variants of Wauchos modules and other malware families distributed by the botnet. <br><br>  <i>Thank you for your help in researching Juraj J√°no≈°√≠k, Viktor Lucza, Filip Maz√°n, Zolt√°n Rusn√°k and Richard Vida.</i> <i><br></i> <br><h3>  Hashes </h3><br><img src="https://habrastorage.org/webt/ec/t0/cc/ect0cczq-yh6clsy64idjfnzfb0.png"><br><br><h3>  Sources </h3><br>  1. <a href="https://blog.fortinet.com/2014/04/16/a-good-look-at-the-Andromeda-botnet">blog.fortinet.com/2014/04/16/a-good-look-at-the-Andromeda-botnet</a> <br>  2. <a href="https://blog.avast.com/Andromeda-under-the-microscope">blog.avast.com/Andromeda-under-the-microscope</a> <br>  3. <a href="http://eternal-todo.com/blog/Andromeda-gamarue-loves-json">eternal-todo.com/blog/Andromeda-gamarue-loves-json</a> <br>  4. <a href="http://blog.trendmicro.com/trendlabs-security-intelligence/usb-malware-implicated-fileless-attacks">blog.trendmicro.com/trendlabs-security-intelligence/usb-malware-implicated-fileless-attacks</a> </div><p>Source: <a href="https://habr.com/ru/post/344262/">https://habr.com/ru/post/344262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344252/index.html">Prospects for the evolution of hard drives: advanced technology and implementation challenges</a></li>
<li><a href="../344254/index.html">Atos IT Challenge Launch Report</a></li>
<li><a href="../344256/index.html">‚Äú3 classes of parish school‚Äù or study at Microsoft Virtual Academy (MVA)</a></li>
<li><a href="../344258/index.html">10 most trendy and dead technologies, frameworks and languages ‚Äã‚Äãaccording to Stack OverFlow. Short</a></li>
<li><a href="../344260/index.html">Generation of natural speech in a 3CX call center based on deep learning</a></li>
<li><a href="../344264/index.html">Business doesn‚Äôt need internet marketers or why ‚ÄúDismissing your internet marketer‚Äù is the best advice for 2017</a></li>
<li><a href="../344266/index.html">Transition from tester to project managers</a></li>
<li><a href="../344268/index.html">On the results of the MERC-2017 contest: an interview with the winners</a></li>
<li><a href="../344270/index.html">Webpage interaction with Ethereum</a></li>
<li><a href="../344272/index.html">Angular 5 (or 4): downgrade component for use in AngularJS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>