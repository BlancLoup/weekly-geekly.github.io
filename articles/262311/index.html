<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AGTH reverse to recreate an alternate GUI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since the topic of reverse engineering is quite popular in Habr√©, I decided to share my insights on this topic. I, like many fans of visual stories , ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AGTH reverse to recreate an alternate GUI</h1><div class="post__text post__text-html js-mediator-article">  Since the topic of reverse engineering is quite popular in Habr√©, I decided to share my insights on this topic.  I, like many fans of <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D0%25B7%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2580%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD">visual stories</a> , know a program like <a href="http://retropc98.narod.ru/soft/agth.htm">AGTH (Anime-Game-Text-Hooker)</a> .  It allows you to extract text from short stories for later translation (most games are Japanese).  The development of this program, apparently, was discontinued in 2011, the source could not be found, and since the soul wanted additional features, it was decided to reverse this program and, based on the data, recreate an alternative shell with all the functions I lack. <br><a name="habracut"></a><br>  The original program consists of two parts - an executable file and an interception module executed in the form of a dynamic library.  The program injects this library into the game process and with its help receives text from there. <br>  I will rewrite and rewrite only the executable file, and the interception module will leave the original one.  There are several reasons for this.  In addition to the obvious complexity of the module and the inherent laziness, it is necessary to ensure the compatibility of my design with the so-called H-codes.  H-code is a data set needed by the interceptor for correctly installing a hook in the case when default hooks are ineffective.  It contains memory addresses, register numbers and other information about the location of the text in the game.  For each individual game, this code is unique and found by enthusiasts.  Therefore, to write your own module so to say ‚Äúbased on‚Äù will not work.  It will be necessary to ensure full compatibility with these codes, and this is a completely different level of complexity.  Yes, and it will not give any additional benefits. <br><br><h2>  Parsing the communication protocol of the interception module and AGTH </h2><br>  Obviously, the interception module in the game and AGTH somehow interact with each other, and to write an alternative shell, you need to know how.  There are quite a few ways to transfer data from one program to another, ranging from window messages to sockets.  What method was actually used, I learned by chance.  Just went into the properties of the process agth.exe through <a href="https://ru.wikipedia.org/wiki/Process_Explorer">Process Explorer</a> and decided to see what lines this program contains. <br><br><img src="https://habrastorage.org/files/8f6/0be/131/8f60be131c69449ebc6430b23ede4193.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Immediately, the line "\\. \ Pipe \ agth" rushed into the eyes - this is how the <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB">named pipe</a> is indicated, which means we can assume that AGTH uses pipes to communicate with the game.  Now we have a direction in which to start searches.  For debugging, I will use <a href="https://ru.wikipedia.org/wiki/OllyDbg">OllyDbg</a> , my favorite debugger. <br>  Let's load AGTH into ‚ÄúOlya‚Äù and immediately put bryaks on the <b>CreateNamedPipe *</b> functions inside the <b>kernel32</b> module.  One of these bryak should work as soon as the program tries to create a named pipe, and from this point you can get to the code that works with these pipes. <br><br><img src="https://habrastorage.org/files/632/8e3/12e/6328e312e64e4addaf57000569905e5f.png"><br><br>  We continue the execution and from the second trigger of the breakpoint we get to the right place.  The fact that this place is necessary tells us the presence of the string "\\. \ Pipe \ agth" on the stack. <br><br><img src="https://habrastorage.org/files/a1c/891/843/a1c8918439264744a83369b4bf5ee29a.png"><br><br>  Now let's go to the address <b>0x00AF3A64</b> , which lies on top of the stack and should point to the code immediately after the call to <b>CreateNamedPipeW</b> . <br><br><pre><code class="hljs tex">001B3A43 &gt; 56 PUSH ESI ; 0x0 00AF3A44 . 6A 00 PUSH 0 00AF3A46 . 68 00000200 PUSH 20000 00AF3A4B . 6A 00 PUSH 0 00AF3A4D . 68 FF000000 PUSH 0FF 00AF3A52 . 6A 06 PUSH 6 00AF3A54 . 68 01000840 PUSH 40080001 00AF3A59 . 68 A026AF00 PUSH agth.00AF26A0 ; UNICODE "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>.<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pipe</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agth</span></span></span></span>" 00AF3A5E . FF15 4010AF00 CALL DWORD PTR DS:[&lt;&amp;KERNEL32.CreateName&gt;; kernel32.CreateNamedPipeW 00AF3A64 . 8BF8 MOV EDI,EAX 00AF3A66 . EB 03 JMP SHORT agth.00AF3A6B</code> </pre> <br>  Here it is already possible to make out with what parameters our pipe is created, namely: <br><br><pre> <code class="hljs tex">CreateNamedPipeW("<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>.<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pipe</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agth</span></span></span></span>", 40080001, 6, 0xFF, 0, 0x20000, 0, NULL);</code> </pre> <br>  Use the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365150%2528v%3Dvs.85%2529.aspx">documentation</a> and expand the magic numbers into named constants.  It will turn out like this: <br><br><pre> <code class="hljs lisp">CreateNamedPipeW(<span class="hljs-string"><span class="hljs-string">"\\.\pipe\agth"</span></span>, PIPE_ACCESS_INBOUND | FILE_FLAG_OVERLAPPED | FILE_FLAG_FIRST_PIPE_INSTANCE, PIPE_WAIT | PIPE_READMODE_MESSAGE | PIPE_TYPE_MESSAGE, <span class="hljs-number"><span class="hljs-number">0</span></span>xFF, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>x20000, <span class="hljs-number"><span class="hljs-number">0</span></span>, NULL)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Running through the code below, you can find the call to the <b>ConnectNamedPipe</b> and <b>WaitForMultipleObjects</b> functions, which are waiting for an event from the created pipe. <br><br><img src="https://habrastorage.org/files/b52/80a/ddd/b5280adddbbe4a4f92408fb90c9fbef7.png"><br><br>  Well, now you need to know how the data is read, or rather, what is the size of the data block transferred from the game to the application.  The fact that the data is transmitted in blocks, rather than in a continuous stream of bytes, is indicated by the presence of the <b>PIPE_TYPE_MESSAGE</b> flag used to create the channel. <br><br>  It is easy to see that after <b>WaitForMultipleObjects</b> returns control, a new thread will be created, which probably handles events on the newly connected pipe.  Let's <b>go</b> to the address <b>0x00CC5080</b> : <br><br><img src="https://habrastorage.org/files/c1a/e47/63a/c1ae4763a50e46118fa4684882244cbf.png"><br><br>  Here is the required <b>ReadFile</b> function, which is called with parameters: <br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">02</span></span>91D9B4 <span class="hljs-number"><span class="hljs-number">00000104</span></span> <span class="hljs-params"><span class="hljs-params">|hFile = 00000104 (window) 0291D9B8 0291DA78 |</span></span>Buffer = <span class="hljs-number"><span class="hljs-number">02</span></span>91DA78 <span class="hljs-number"><span class="hljs-number">02</span></span>91D9BC <span class="hljs-number"><span class="hljs-number">00001</span></span>FE8 <span class="hljs-params"><span class="hljs-params">|BytesToRead = 1FE8 (8168.) 0291D9C0 0291DA14 |</span></span>pBytesRead = <span class="hljs-number"><span class="hljs-number">02</span></span>91DA14 <span class="hljs-number"><span class="hljs-number">02</span></span>91D9C4 <span class="hljs-number"><span class="hljs-number">004</span></span>C4168 \pOverlapped = <span class="hljs-number"><span class="hljs-number">004</span></span>C4168</code> </pre><br>  I got them from the stack at the moment when the breakpoint, set in advance for the ReadFile call, worked.  In general, we are only interested in the <b>BytesToRead</b> parameter, which is 8168 bytes.  Probably - this is the size of the structure with the text that the game sends to the program. <br><br>  As a result, enough information was gathered about how the interaction with the game takes place: AGTH implements a pipe server that receives data in 8168 byte chunks.  Now you can proceed to the analysis of what these bytes mean. <br><br>  I decided to do a data format analysis inside my program.  In it, I implemented my own server using the data obtained earlier, and with its help I received messages from the game.  Very convenient - you can get the structure of the desired size and read data directly into it.  In the course of the analysis of what this or that group of bytes means, this structure can be modified and at the end get a complete description of all the fields. <br><br><img src="https://habrastorage.org/files/aa8/57d/300/aa857d3007464840a877dd419505f06f.png"><br><br>  This is what looks like what comes into the program from the game.  Immediately struck by the lines UserHookQ and Kotarou. The first is the name of the function that is displayed in the original program, the second is the text from the game in UTF-16 encoding.  Also, the number 7 (blue selection) is noticed, which, as it turned out, is always equal to the number of characters of the string of game text.  Looking through different data sets, it turned out that the function name is a null-terminated string with a maximum length of 24 characters.  That is, in the case of the screenshot above, all the bytes between the green and blue selection are just garbage.  There are still 16 bytes of data at the beginning of the structure.  The first two variables were easy to determine - these are Context and Subcontext, which can also be seen in the window of the original program.  The third parameter was a little harder to find - it always had small values ‚Äã‚Äãand changed only when the game was restarted.  It turned out to be ProcessID games.  The last of the four was constantly changing and had quite large values.  The only clue was that this value always increased with time and never decreased.  This was the time, or rather the result of the <b>GetTickCount</b> function <b>call</b> . <br><br>  The result was the following structure: <br><br><pre> <code class="delphi hljs"> TAGTHRcPckt = <span class="hljs-keyword"><span class="hljs-keyword">packed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> <span class="hljs-comment"><span class="hljs-comment">// SizeOf = 8168 bytes Context: Cardinal; Subcontext: Cardinal; ProcessID: Cardinal; UpTime: Cardinal; TextLength: Cardinal; HookName: array [0 .. 23] of ansichar; Text: array [0 .. 4061] of widechar; end;</span></span></code> </pre> <br>  With the communication between the application and the game figured out, now you need to find out how the text capture module gets into the game and gets information about where and how to install the hooks. <br><br><h2>  Loader Study </h2><br>  Run the game (or any other application), wait for the final download and hook on it with a debugger.  Next, open the list of modules, select <b>kernel32</b> , and in the list of functions, set bryakpoint on all functions that start at <b>LoadLibrary *</b> .  This is done because how not to twist, but the final dll loading will be done by calling one of these functions and, if you intercept the call, you can wander around the stack and go to the loader itself. <br><br><img src="https://habrastorage.org/files/480/73a/57d/48073a57d702478ab8ad52d166383970.png"><br><br>  We continue the program.  Then run AGTH and tell it the process of the game: <br><pre> <code class="bash hljs">agth /PN_.exe</code> </pre> <br>  The debugger will work right there.  In my case, the breakpoint worked on the <b>LoadLibraryW</b> function. <br>  Let's look at the stack: <br><br><img src="https://habrastorage.org/files/be3/d2a/a0f/be3d2aa0f29e4a79bfc27470e83a6c36.png"><br><br>  the second one is the function argument, but the first one is the return address and it leads somewhere in the <b>kernel32 kernel</b> .  Strange, I expected to see the address of the loader code embedded in the game there.  Well, let's see what lies next to the <b>LoadLibraryW</b> argument.  Let's <b>go to 0x7EF80022</b> and here it is! <br><br><img src="https://habrastorage.org/files/3e6/85a/8bf/3e685a8bf0e2406a9140a7eec5def594.png"><br><br>  This is the desired bootloader, by the way, quite tricky: there are only 4 teams (starting with the address <b>0x7EF80014</b> , the data goes). <br><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">7</span></span>EF80000 <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">1E00</span></span>F87E PUSH <span class="hljs-number"><span class="hljs-number">7</span></span>EF8001E ; UNICODE <span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>EF80005 <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">1400</span></span>F87E PUSH <span class="hljs-number"><span class="hljs-number">7</span></span>EF80014 ; UNICODE <span class="hljs-string"><span class="hljs-string">"AGTH"</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>EF8000A <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">121E4</span></span>D75 PUSH kernel32.LoadLibraryW <span class="hljs-number"><span class="hljs-number">7</span></span>EF8000F -E9 CE9755F6 JMP kernel32.SetEnvironmentVariableW</code> </pre> <br>  First, the parameters of the <b>SetEnvironmentVariableW ('AGTH', '0')</b> function are <b>added</b> to the stack, then the address of the <b>LoadLibraryW</b> function, which serves as the return address for the <b>SetEnvironmentVariableW</b> function, since it is called not via <b>CALL</b> , but by using an unconditional <b>JMP</b> transition.  ‚ÄúSo this is why <b>LoadLibraryW</b> was called from somewhere in the depths of <b>kernel32</b> , and not the loader!‚Äù I thought.  But the thought of what would happen after the <b>LoadLibrary</b> worked would not let me rest.  Therefore, I decided to look where all the same control will return after the call.  We go to the address <b>0x754D3677</b> and see: <br><br><pre> <code class="hljs sql">754D3677 50 PUSH EAX 754D3678 FF15 F0064D75 <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> DWORD PTR DS:[&lt;&amp;ntdll.RtlExitUserThread&gt;] ; ntdll.RtlExitUserThread</code> </pre> <br><br>  Apparently, after calling <b>LoadLibraryW</b> , <b>RtlExitUserThread</b> will be called with a parameter that will return <b>LoadLibraryW</b> and thus the remote thread will end successfully.  It would seem that everything is fine, but the thought did not leave me: ‚ÄúWhere did this address appear on the stack, and where did the program get the address of the line in which the path to the embedded dll lies?  After all, there is nothing like this in the loader code! ‚Äù  It turns out that someone put these addresses on the stack before the first loader instruction was called.  And then it dawned on me: remote threads are created using the <b>CreateRemoteThread</b> function, and it, in addition to a pointer to a function, also accepts a parameter for this function.  That is, it first <b>pushes the RtlExitUserThread</b> address onto the stack so that the thread, having made <b>RET</b> , correctly terminated, and then another variable, the parameter. <br><br>  Once again in brief: <br><ul><li>  <b>CreateRemoteThread</b> <b>pushes the RtlExitUserThread</b> address, the path to the dll and starts the bootloader </li><li>  the loader adds to the stack the arguments for SetEnvironmentVariableW, the address <b>LoadLibraryW</b> and makes an unconditional transition to <b>SetEnvironmentVariableW</b> </li><li>  <b>SetEnvironmentVariableW</b> takes its arguments from the stack and when returning from it the thread is at the beginning of <b>LoadLibraryW</b> </li><li>  <b>LoadLibraryW</b> takes the path to the dll from the stack and when returning from it, the stream goes to <b>RtlExitUserThread</b> </li><li>  <b>RtlExitUserThread</b> ends the stream </li></ul><br><br>  By the way, such a game with a stack, when a function after RET arrives not in the code that caused it, but in another function, is called a return-oriented programming technique or simply <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25B7%25D0%25B2%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">ROP (Return-Oriented Programming)</a> . <br><br>  Well, with the implementation and transfer of parameters to the target process, we figured out, all parameters are passed through an environment variable named ‚ÄúAGTH‚Äù.  It turns out that in case of writing your own loader, it is enough to set the environment variable and load the dll. <br><br><div class="spoiler">  <b class="spoiler_title">Loader:</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//       TInject = packed record // code cmd0: BYTE; cmd1: BYTE; cmd1arg: DWORD; cmd2: BYTE; cmd2arg: DWORD; cmd3: WORD; cmd3arg: DWORD; cmd4: BYTE; cmd4arg: DWORD; cmd5: WORD; cmd5arg: DWORD; cmd6: BYTE; cmd6arg: DWORD; cmd7: WORD; cmd7arg: DWORD; // data pLoadLibrary: Pointer; pExitThread: Pointer; pSetEnvironmentVariableW: Pointer; ENVName: array [0 .. 4] of WideChar; ENVValue: array [0 .. MAX_PATH] of WideChar; LibraryPath: array [0 .. MAX_PATH] of WideChar; end; const //     PUSH: BYTE = $68; CALL_DWORD_PTR: WORD = $15FF; INT3: BYTE = $CC; NOP: BYTE = $90; {  Dll   } class function THooker.InjectDll(Process: DWORD; ModulePath, HCode: WideString): boolean; var Memory: Pointer; CodeBase: DWORD; BytesWritten: SIZE_T; ThreadId: DWORD; hThread: DWORD; hKernel32: DWORD; Inject: TInject; function RebasePtr(ptr: Pointer): DWORD; //      //    begin Result := CodeBase + DWORD(ptr) - DWORD(@Inject); end; begin Result := false; //      //        Memory := VirtualAllocEx(Process, nil, sizeof(Inject), MEM_TOP_DOWN or MEM_COMMIT, PAGE_EXECUTE_READWRITE); if Memory = nil then Exit; CodeBase := DWORD(Memory); hKernel32 := GetModuleHandle('kernel32.dll'); //   : //  Inject       FillChar(Inject, sizeof(Inject), 0); with Inject do begin // code cmd0 := NOP; cmd1 := PUSH; cmd1arg := RebasePtr(@ENVValue); cmd2 := PUSH; cmd2arg := RebasePtr(@ENVName); cmd3 := CALL_DWORD_PTR; cmd3arg := RebasePtr(@pSetEnvironmentVariableW); cmd4 := PUSH; cmd4arg := RebasePtr(@LibraryPath); cmd5 := CALL_DWORD_PTR; cmd5arg := RebasePtr(@pLoadLibrary); cmd6 := PUSH; cmd6arg := 0; cmd7 := CALL_DWORD_PTR; cmd7arg := RebasePtr(@pExitThread); // data //      , //  ImageBase kernel32.dll     //         //  -      //     kernel32.dll  //     //       pLoadLibrary := GetProcAddress(hKernel32, 'LoadLibraryW'); pExitThread := GetProcAddress(hKernel32, 'ExitThread'); pSetEnvironmentVariableW := GetProcAddress(hKernel32, 'SetEnvironmentVariableW'); lstrcpy(@LibraryPath, PWideChar(ModulePath)); lstrcpy(@ENVName, PWideChar('AGTH')); lstrcpy(@ENVValue, PWideChar(HCode)); end; //       WriteProcessMemory(Process, Memory, @Inject, SIZE_T(sizeof(Inject)), BytesWritten); //    hThread := CreateRemoteThread(Process, nil, 0, Memory, nil, 0, ThreadId); if hThread = 0 then Exit; //      WaitForSingleObject(hThread, INFINITE); CloseHandle(hThread); VirtualFreeEx(Process, Memory, 0, MEM_RELEASE); // -      Result := true; end;</span></span></code> </pre> <br></div></div><br>  Now we need to deal with the parameters, more precisely with the way the command line of the program, through which the H-code is specified, is converted into the value of that environment variable. <br>  In order not to constantly poking around in the debugger, a stub library was written whose only function is to read and write the ‚ÄúAGTH‚Äù variable for further study. <br><br>  Stub code: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span> AGTH; <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> windows; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span> .. <span class="hljs-number"><span class="hljs-number">255</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> widechar; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> GetEnvironmentVariableW(<span class="hljs-string"><span class="hljs-string">'AGTH'</span></span>, buffer, <span class="hljs-number"><span class="hljs-number">256</span></span>); MessageBoxW(<span class="hljs-number"><span class="hljs-number">0</span></span>, buffer, buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br><br>  Next, replacing the original dll, I began to sort through all the possible command line switches and see how they are mapped to the environment variable.  It turned out to be easy. <br>  A list of all commands can be found in the help embedded in the original program.  Of these commands, I was only interested in Hook options. <br><br><div class="spoiler">  <b class="spoiler_title">Hook options:</b> <div class="spoiler_text"><pre> <code class="bash hljs">/H[X]{A|B|W|S|Q}[N][data_offset[*drdo]][:sub_offset[*drso]]@addr[:module[:{name|<span class="hljs-comment"><span class="hljs-comment">#ordinal}]] - select OK for more help /NC - don't hook child processes /NH - no default hooks /NJ - use thread code page instead of Shift-JIS for non-unicode text (should be specified for capturing non-japanese text) /NS - don't use subcontexts /S[IP_address] - send text to custom computer (default parameter: local computer) /V - process text threads from system contexts /X[sets_mask] - extended sets of hooked functions (default parameter: 1; number of available sets: 2)</span></span></code> </pre> </div></div><br>  Then simply enter the random command line parameters and see how they affect the final result. <br>  For example, the set of keys <b>'/ HQN54 @ 48693e / NH / Slocalhost'</b> turns into <b>'20S0: localhostUQN54 @ 48693e'</b> and you can immediately see that the values ‚Äã‚Äãof the keys <b>/ H</b> and <b>/ S</b> are transmitted as is.  It was also found that the prefixes <b>U</b> and <b>S0:</b> never change and disappear completely only in the absence of the corresponding keys <b>/ H</b> and <b>/ S.</b>  All other keys affect only the first two hexadecimal numbers.  After playing with the keys a little more, it turned out that these are bit flags, where each key is responsible for setting a separate bit in the byte that these two numbers represent. <br><br>  The result was a sign: <br><br><pre> <code class="bash hljs">/nh - 20 - 10 0000 /nc - 10 - 01 0000 /nj - 08 - 00 1000 /x3 - 06 - 00 0110 //  /x2  /x /x2 - 04 - 00 0100 /x - 02 - 00 0010 /V - 01 - 00 0001</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Command line to H code conversion function</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PROCESS_SYSTEM_CONTEXT = $<span class="hljs-number"><span class="hljs-number">01</span></span>; HOOK_SET_1 = $<span class="hljs-number"><span class="hljs-number">02</span></span>; HOOK_SET_2 = $<span class="hljs-number"><span class="hljs-number">04</span></span>; USE_THREAD_CODEPAGE = $<span class="hljs-number"><span class="hljs-number">08</span></span>; NO_HOOK_CHILD = $<span class="hljs-number"><span class="hljs-number">10</span></span>; NO_DEF_HOOKS = $<span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">THooker</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateHCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AGTHcmd: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; lcmd, uFlag, sFlag: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; flags: BYTE; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> lcmd := lowercase(AGTHcmd); flags := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/nh'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> NO_DEF_HOOKS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/nc'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> NO_HOOK_CHILD; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/nj'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> USE_THREAD_CODEPAGE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/v'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> PROCESS_SYSTEM_CONTEXT; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/x3'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (HOOK_SET_1 <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> HOOK_SET_2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/x2'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> HOOK_SET_2 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pos(<span class="hljs-string"><span class="hljs-string">'/x'</span></span>, lcmd) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> flags := flags <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> HOOK_SET_1; <span class="hljs-comment"><span class="hljs-comment">//    /h        U i := pos('/h', lcmd); if i &gt; 0 then begin uFlag := copy(AGTHcmd, i, length(AGTHcmd) - (i - 1)); // /h -&gt; endstr delete(uFlag, 1, 2); // del /h i := pos(' ', uFlag); if i &gt; 0 then delete(uFlag, i, length(uFlag) - (i - 1)); uFlag := 'U' + uFlag; end else uFlag := ''; //    /s        S0: i := pos('/s', lcmd); if i &gt; 0 then begin sFlag := copy(AGTHcmd, i, length(AGTHcmd) - (i - 1)); delete(sFlag, 1, 2); // del /s i := pos(' ', sFlag); if i &gt; 0 then delete(sFlag, i, length(sFlag) - (i - 1)); sFlag := 'S0:' + sFlag; end else sFlag := ''; Result := IntToHex(flags, 1) + sFlag + uFlag; end;</span></span></code> </pre> <br></div></div><br>  Thus, the format of the parameters for the library was dismantled. <br><br><h2>  the end </h2><br>  That's all.  The case is left for small - to implement your own interface and add the necessary features.  What was done: <br><ul><li>  With the help of layered windows, the subtitle output over the game </li><li>  Added integration with Google translator </li><li>  JS user scripts for text preprocessing before translation </li></ul><br>  Writing the rest of the code is rather trivial, so I won't give it here, just leave a link to <a href="https://github.com/Tsukihime/Easy-Text-Hooker">Github</a> . </div><p>Source: <a href="https://habr.com/ru/post/262311/">https://habr.com/ru/post/262311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262295/index.html">Evolution go</a></li>
<li><a href="../262299/index.html">WPF pitfalls</a></li>
<li><a href="../262301/index.html">Iron unlock iCloud on Apple iPad Air 2 Cellular A1567</a></li>
<li><a href="../262305/index.html">Black archeology of datamining: how dangerous are the ‚Äúplums‚Äù of big data</a></li>
<li><a href="../262309/index.html">Legends and myths of modern implementations of x265 / HEVC or x264 vs x265 in comparison of screenshots</a></li>
<li><a href="../262315/index.html">Yii 2.0.5 (security fix)</a></li>
<li><a href="../262317/index.html">At St.Petersburg State University of Economics, the acceptance of applicants' documents for the direction ‚ÄúApplied Mathematics and Computer Science‚Äù with a deep study of Wolfram Mathematica began</a></li>
<li><a href="../262319/index.html">Another critical vulnerability has been discovered in Adobe Flash Player.</a></li>
<li><a href="../262321/index.html">Three thoughts for Android fans based on I / O 2015</a></li>
<li><a href="../262323/index.html">Spring without XML. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>