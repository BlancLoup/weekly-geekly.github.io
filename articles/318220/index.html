<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SetGoroutineName</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Go, more than a million goroutine can be launched, and this mechanism is fascinating until there is a problem. For example, a memory leak or dead-l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SetGoroutineName</h1><div class="post__text post__text-html js-mediator-article"><p>  In Go, more than a million goroutine can be launched, and this mechanism is fascinating until there is a problem.  For example, a memory leak or dead-lock. </p><br><p>  The first thing I want to do is figure it out, look at what is happening. <br><img src="https://habrastorage.org/files/a83/a38/0ae/a83a380ae0d7473badb24e4ac43d5578.png" alt="image"></p><br><p>  It can be done like this. </p><a name="habracut"></a><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"bytes"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime/pprof"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { profiler := pprof.Lookup(<span class="hljs-string"><span class="hljs-string">"goroutine"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buf bytes.Buffer profiler.WriteTo(&amp;buf, <span class="hljs-number"><span class="hljs-number">1</span></span>) fmt.Println(buf.String()) }</code> </pre> <br><pre> <code class="hljs go">goroutine profile: total <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> @ <span class="hljs-number"><span class="hljs-number">0xb1620</span></span> <span class="hljs-number"><span class="hljs-number">0xb1340</span></span> <span class="hljs-number"><span class="hljs-number">0xac9c0</span></span> <span class="hljs-number"><span class="hljs-number">0x200c0</span></span> <span class="hljs-number"><span class="hljs-number">0x59f</span></span>80 <span class="hljs-number"><span class="hljs-number">0x98d</span></span>61 # <span class="hljs-number"><span class="hljs-number">0xb161f</span></span> runtime/pprof.writeRuntimeProfile+<span class="hljs-number"><span class="hljs-number">0xdf</span></span> /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/pprof/pprof.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">614</span></span> # <span class="hljs-number"><span class="hljs-number">0xb133f</span></span> runtime/pprof.writeGoroutine+<span class="hljs-number"><span class="hljs-number">0x9f</span></span> /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/pprof/pprof.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">576</span></span> # <span class="hljs-number"><span class="hljs-number">0xac9bf</span></span> runtime/pprof.(*Profile).WriteTo+<span class="hljs-number"><span class="hljs-number">0xff</span></span> /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/pprof/pprof.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">298</span></span> # <span class="hljs-number"><span class="hljs-number">0x200bf</span></span> main.main+<span class="hljs-number"><span class="hljs-number">0xbf</span></span> /tmp/sandbox627252447/main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span> # <span class="hljs-number"><span class="hljs-number">0x59f7f</span></span> runtime.main+<span class="hljs-number"><span class="hljs-number">0x39f</span></span> /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/proc.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">183</span></span></code> </pre> <br><p>  <a href="https://play.golang.org/p/ysl_avotLS">https://play.golang.org/p/ysl_avotLS</a> </p><br><p>  Or so: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { b1 := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">20</span></span>) runtime.Stack(b1, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) s1 := <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(b1) fmt.Println(s1) }</code> </pre> <br><pre> <code class="hljs lua">goroutine <span class="hljs-number"><span class="hljs-number">1</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">running</span></span>]: main.main() /tmp/sandbox952340390/main.go:<span class="hljs-number"><span class="hljs-number">10</span></span> +<span class="hljs-number"><span class="hljs-number">0x80</span></span></code> </pre> <br><p>  <a href="https://play.golang.org/p/FCbzn2_DlQ">https://play.golang.org/p/FCbzn2_DlQ</a> </p><br><p>  We see that in these examples one gorutin is running and its stack is traced, but if we have 20-30 identical goroutines, then the question is, who do they serve?  If this is a site, then maybe the user who left, and goroutine has not ceased to exist, and as a result does not release the memory? </p><br><p>  There is a desire to give the names of the gorutinos and to write in the title a useful, useful information, such as the Id of the user whom she services.  But Go is not easy, because there is no <code>SetGoroutineName</code> or <code>GetGoroutineId</code> .  Such functions are evil in the opinion of the creators of the Go language.  It's hard not to agree with people like Rob and Ken.  But evil is not because these functions are evil at all, but because programmers will start using these functions incorrectly.  Not for debugging applications at the time of memory leaks, but simply as goroutine local storage.  That is, in the logic of the program it is bad to use such things, but if you have got it wrong, you still need to somehow find the error. </p><br><h1 id="pyradebug">  PyraDebug </h1><br><p>  So you need to give the names of the gorutins, but whatever the application logic does not depend on it.  So was born <code>pyradebug</code> </p><br><pre> <code class="hljs swift">go <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -u github.com/<span class="hljs-type"><span class="hljs-type">CossackPyra</span></span>/pyradebug</code> </pre> <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/CossackPyra/pyradebug"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pyraDebug *pyradebug.PyraDebug <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { pyraDebug = pyradebug.InitPyraDebug() pyraDebug.Enable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++ { <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { pyraDebug.SetGoroutineName(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"sleep func %d"</span></span>, i)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { time.Sleep(time.Second) } }(i) } http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/goroutine"</span></span>, handle_goroutine) log.Fatal(http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8765"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_goroutine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { agi := pyraDebug.ListGoroutines(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) w.Header().Set(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, gi := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> agi { fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">"%d\t%s\t%s\t%s\n"</span></span>, i, gi.Id, gi.Name, gi.Status) } }</code> </pre><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta"># http:</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//127.0.0.1:8765/goroutine 0 goroutine 31 running 1 goroutine 1 IO wait 2 goroutine 17 syscall, locked to thread 3 goroutine 20 sleep func 0 sleep 4 goroutine 21 sleep func 1 sleep 5 goroutine 22 sleep func 2 sleep 6 goroutine 23 sleep func 3 sleep 7 goroutine 24 sleep func 4 sleep 8 goroutine 25 sleep func 5 sleep 9 goroutine 26 sleep func 6 sleep 10 goroutine 27 sleep func 7 sleep 11 goroutine 28 sleep func 8 sleep 12 goroutine 29 sleep func 9 sleep</span></span></span></span></code> </pre> <br><p>  An important feature of the library is <code>pyraDebug.Enable = true</code> , that is, after debugging, you simply <code>pyraDebug.Enable = true</code> it off and it stops doing something and therefore cannot rely on <code>SetGoroutineName</code> in logic. </p><br><p>  Initially, I wanted to indicate the name of the gurutin, which gave birth to it, but in practice I need only the name, the source code of the 127 line.  It is easy to fork, understand and modify. </p><br><p>  The library depends on the text format that gives <code>runtime.Stack</code> and may stop working in the future, which is also good that developers do not rely thoughtlessly on this library and use it only for debugging. </p><br><p>  Ps.  It is always interesting to know what bike did. </p><br><p>  <a href="https://github.com/CossackPyra/pyradebug">https://github.com/CossackPyra/pyradebug</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/318220/">https://habr.com/ru/post/318220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318210/index.html">Attempts to open a new checkers tactic or what to do with a pipe dream</a></li>
<li><a href="../318212/index.html">Secrets of a successful update: interface, backend, application structure</a></li>
<li><a href="../318214/index.html">5 really free non-linear video editors for Windows</a></li>
<li><a href="../318216/index.html">DevOps - speed? Yes speed</a></li>
<li><a href="../318218/index.html">From Intranet to Digital Workplace</a></li>
<li><a href="../318222/index.html">Parsing: how and why to use PureComponent in React</a></li>
<li><a href="../318224/index.html">.NET wrappers for native C ++ / CLI libraries</a></li>
<li><a href="../318226/index.html">NetApp SnapLock ‚Ñ¢ - Licensed Data Protection Feature (WORM)</a></li>
<li><a href="../318228/index.html">Hacking on board the aircraft</a></li>
<li><a href="../318230/index.html">Information hygiene in a country with non-free Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>