<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VSTO and CAB: Integrating .NET applications in Microsoft Word</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VSTO stands for Visual Studio Tools for Office. These tools make it quite easy to cross already with a hedgehog ‚Äî write .NET applications executed by ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VSTO and CAB: Integrating .NET applications in Microsoft Word</h1><div class="post__text post__text-html js-mediator-article">  VSTO stands for Visual Studio Tools for Office.  These tools make it quite easy to cross already with a hedgehog ‚Äî write .NET applications executed by the CLR in the Microsoft Office environment.  In particular, programmers have the ability to create plug-ins (plug-ins) and "customized" document templates for almost the entire main family of Microsoft Office products. <br><br>  The article presents the Windows Forms infrastructure of the project, in which Microsoft Word is perceived by the application as a shell.  The article reveals several interesting points of using the Composite UI Application Block, in particular, connecting the infrastructure of the Word domain model to the framework expansion services, as well as some facts and features of development using VSTO tools. <br><a name="habracut"></a><br><h4>  Task </h4><br>  Suppose we have several dozen people who write documents and constantly work with their editors.  For some reason, Sharepoint and other portals are not suitable, therefore the implementation of its own business logic is required.  Let's complicate the task - people work in an area that is very far from computer subjects and only know Microsoft Office.  Even more complicated - the office is poor, the Microsoft Office of the 2003 version of most people.  In some places, the big bosses and the main boss are worth 2007th.  The car park is heterogeneous - from the 2000th Windows to Windows Vista. <br><br><h4>  Decision </h4>  One solution is a plug-in for Microsoft Office.  You can write it on COM, through the bare Office Interop, or through the same interop, but wrapped in VSTO tools in a clever way.  These funds and use.  The user will run Word, the VSTO runtime will hook the .NET assemblies and somehow complement the Microsoft Word controls, allowing the user to execute the business logic necessary for the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  And why all this? </h4>  (This is someone who can not wait to find out how it will end).  At the exit, I will lay out a Visual Studio solution that will allow you to create your application connected to Microsoft Word in half-ping.  Along the way, I will explain almost everything that is used in this solution. <br><br><h4>  What is required for work </h4><ol><li>  Microsoft Word 2003 SP3 </li><li>  <a href="http://www.microsoft.com/downloads/details.aspx%3FFamilyId%3D5E86CAB3-6FD6-4955-B979-E1676DB6B3CB%26displaylang%3Den">VSTO 2005 SE</a> </li><li>  <a href="http://www.microsoft.com/downloads/details.aspx%3FFamilyId%3D8315654B-A5AE-4108-B7FC-186402563F2B%26displaylang%3Den">VSTO 2005 SE Runtime</a> </li><li>  <a href="http://www.microsoft.com/Downloads/details.aspx%3Ffamilyid%3D7b9ba1a7-dd6d-4144-8ac6-df88223aee19%26displaylang%3Den">CAB</a> </li><li>  Visual Studio 2005 or 2008 </li></ol><h4>  Why CAB? </h4>  In order to determine the explicit separation of the functionality associated with Microsoft Word from simple Windows Forms logic.  Simply put, our plugin will be a CAB module, and if you wish, we can easily connect this logic to other CAB applications.  Simply put, using CAB minimizes the amount of glue code. <br><br>  There are two more reasons why I included the CAB in the solution.  The first is that I have already given a description of this framework <a href="http://habrahabr.ru/blogs/net/50322/">here</a> , and now I want to give a full-fledged working example.  The second reason is more banal - I like CAB, it makes the world and things in it easier :) <br><br><h4>  More on VSTO </h4>  Generally speaking, VSTO not only Word plugins can create.  This is a powerful system, now it is already in the third version.  VSTO is the gateway for a developer to the world of automation and programming of Office-based solutions.  In a nutshell, a .NET developer gains access to the domain model of an Office application and does what it wants with it. <br><br>  All these solutions can be divided into two types: <ol><li>  Document Level Customization </li><li>  Application Level Customization </li></ol><br>  These are independent levels.  The first creates document templates for Microsoft Office applications.  You can take an Excel template, diversify it with different user controls (buttons, grids), and add any logic ‚Äî for example, so that the user-generated data is sent to a server through a web service and processed there.  At this level, the developer has access to the Action Pane (in the 2003 version), where you can connect your controls, plus a lot more in the 2007 version. <br><br>  Application Level Customization means that an extension module (so-called add-in) is connected to the Microsoft Office application environment.  Actually, I initially started talking about him.  This plug-in is a locomotive of the business application and allows you to connect all the capabilities of the .NET platform to Microsoft Office.  I will show exactly the solution of the second level. <br><br>  If anyone is interested in the possibilities of VSTO - there is a lot about them in <a href="http://msdn.microsoft.com/en-us/library/bf68wbkb(VS.80).aspx">msdn</a> . <br><br><h4>  Pseudo task </h4>  Let's create a small example illustrating the above.  Suppose there is a requirement that a user can select text from a Microsoft Word document and receive this selected text in the window of a user element (I know, a foolish example, but I don‚Äôt want to do a more complicated one, but it is difficult to invent a less complex one). <br><br>  In details.  User launches Microsoft Word.  After starting among the toolbars, the user will have access to the TP - extension toolbar (i.e., our extension).  It has a button, by pressing which the user is shown a window with the button ‚ÄúGet text‚Äù and a multiline textbox control element.  The user clicks on the button "Get text", the selected text in the document is copied to the textbox.  Everyone is happy. <br><br>  It is clear that the example is not suitable for life.  But the infrastructure being created will make it quite easy to build muscles on it, if, of course, it is necessary for someone. <br><br><h4>  Creating a solution </h4>  After installing VSTO in the studio when creating a new solution, Office projects will be available: <br><br><img src="http://img7.imageshack.us/img7/6816/addin1.png"><br><br>  Be careful with the name - it will be at the same time the name of the root namespace and you can change it only with pens through the unloading of the project. <br><br>  The output is a solution with two projects: <br><img src="http://img528.imageshack.us/img528/5795/addin2.png"><br><br>  WordCAB is actually an add-in.  The second - no less important, is the deployment project for the expansion module.  Why is he important? <br><br>  The fact is that installing an expansion module on users' workstations is a very laborious undertaking.  It is not only to just copy the library in the desired folder.  For successful module operation, it is required to register a bunch of keys in the registry.  If you dig deeper, it turns out that the extension module is connected to the Microsoft Office as a COM library, with all the consequences.  To whom it is interesting, you can have a look at all the necessary registry keys in the deployment project (Right-click, View-&gt; Registry). <br><br>  The ThisAddIn class is the access point to the module: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> ThisAddIn <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">void</font> ThisAddIn_Startup( <font color="#0000ff">object</font> sender, System. <font color="#2B91AF">EventArgs</font> e) <br> { <br> new AddInApplication().Run(); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">void</font> ThisAddIn_Shutdown( <font color="#0000ff">object</font> sender, System. <font color="#2B91AF">EventArgs</font> e) <br> { <br> } <br> <br> <font color="#0000ff">#region</font> VSTO generated code <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Required method for Designer support - do not modify</font> <br> <font color="#008000">/// the contents of this method with the code editor.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">void</font> InternalStartup() <br> { <br> <font color="#0000ff">this</font> .Startup += <font color="#0000ff">new</font> System.EventHandler(ThisAddIn_Startup); <br> <font color="#0000ff">this</font> .Shutdown += <font color="#0000ff">new</font> System.EventHandler(ThisAddIn_Shutdown); <br> } <br> <br> <font color="#0000ff">#endregion</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In <code>ThisAddIn_Startup</code> we will write code.  To be more precise, we will launch a CAB application. <br><br><h4>  What is a CAB application? </h4>  This is a class like that.  It has a launch point ‚Äî the <code>Run()</code> method, and some framework infrastructure ‚Äî in particular, have access to the main use case ‚ÄúApplication‚Äù (ie, the main, root WorkItem) and the ability to override system services added to default  This class has already been implemented in the base view, and the programmer needs to parameterize it - specify the type of root precedent and the type of the main form: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">internal</font> <font color="#0000ff">sealed</font> <font color="#0000ff">class</font> AddInApplication : WindowsFormsApplication&lt;AddInWorkItem, <font color="#0000ff">object</font> &gt; <br> { <br> <font color="#0000ff">protected</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Start() <br> { <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The type of the main form (shell form) is object.  Why?  Because the application runs in Microsoft Word, so there is no need to create the main form.  The Microsoft Word form is the main form, but without its traditional capabilities. <br><br>  In the course of the play, it occurred to me to clarify a bit the model of the application for the extension module in Microsoft Word. <br><br><h5>  Word Add-in Application Model </h5>  So, the user works with documents.  Moreover, per unit of time, it can work with only one document.  Therefore, the extension module has a clear context - the current open document.  (By the way, in the Microsoft Word VSTO model this document is designated as <code>Globals.ThisAddIn.Application.ActiveDocument</code> ).  From here (I made) the conclusion (or simplification) - it makes sense to show custom business elements in a modal mode, because otherwise the context is broken.  Controls that are open to one document should only exist while this document is active. <br><br>  Example - the user opened the document and opened his card (not in modal mode).  Switched to another document, and the card remained for the previous one - a violation of the context and integrity of perception.  Of course, such behavior can be controlled (and even necessary, in some cases), but the modality of controls and their rigid binding to the current active document makes life easier. <br><br><h4>  Modal workspace </h4>  User controls in the CAB framework are displayed in special so-called workspaces (Workspace).  According to the behavior described above, we need to show controls in a modal mode.  Since WindowWorkspace's native CAB window was turned out to be dubious and looked ugly, I wrote my own simple one - I will not give the code, because its a couple of screens.  You can enjoy creativity by downloading the solution with the code (link to the archive is given at the end of the article). <br><br>  Registration of a modal working area occurs in the <code>InitializeServices()</code> method of the main use case - <code>AddInWorkitem</code> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Workspaces.Add(( <font color="#0000ff">new</font> SimpleModalWorkspace() ), WorkspaceNames.MainWorkspace);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Total: under the key ID <code>WorkspaceNames.MainWorkspace</code> registered a modal work area.  It can now be accessed from anywhere, where there is a link to the main use case: <code>IWorkspace</code> interface <code>IWorkspace</code> from the <code>Workspaces</code> collection using the above key.  It's just like an orange!  (c) c / f "Terminator 2" <br><br><h4>  Microsoft Word Controls Factory </h4>  It's about the Word toolbar and the buttons on it.  In VSTO, these are wrappers over COM objects ‚Äî the <code>CommandBar</code> and <code>CommandBarButton</code> from the <code>Microsoft.Office.Core</code> namespace.  Terribly buggy things, to be honest, especially their animation.  It was possible to understand all the subtleties and details only after shock trolling on the VSTO forums. <br><br>  What is the idea - the idea is to save the programmer and the developers of business modules from the need to work with COM wrappers.  For this, we (that is, I) integrate the Misrosoft Word model into the mechanism of the so-called expansion sites (UiExtensionSite) of the CAB framework. <br><br>  The mechanism of expansion sites consists of functional bundles-additions.  Simply put, in the code you need to visualize the relationship of subordinate elements.  In our case, these relationships are: <br><ol><li>  Into an array of Microsoft Word toolbars, a toolbar is inserted. </li><li>  A button is inserted into the toolbar button collection. </li><li>  Nothing is inserted into the button (we do not consider the case of combo boxes, although they are present), so this is a terminal object </li></ol><br>  So we got three subordinate entities: <br><ol><li>  <code>IWordCommandBarContainer</code> - Microsoft Word <code>IWordCommandBarContainer</code> Container </li><li>  <code>IWordCommandBar</code> - a container of buttons on the toolbar </li><li>  <code>IWordButton</code> - button </li></ol><br><br>  By the way, in addition to the definition of Word controls, specific types of interfaces <code>IWordCommandBar</code> and <code>IWordButton</code> are adapters to the above-mentioned <code>CommandBar</code> and <code>CommandBarButton</code> respectively. <br><br>  In order for the framework to understand what, where and, most importantly, how to insert, it needs to register the adapter factory for user controls.  In our case, you can insert toolbars (into the toolbar collection) and buttons (into the button collection on the toolbar).  Therefore, registering the adapter factory is necessary for the <code>IWordCommandBarContainer</code> and for the <code>IWordCommandBar</code> .  Then, when the user receives the expansion location, the framework will look for instances of the classes for adding subordinate elements for this expansion location, and then using them for their intended purpose ‚Äî to add elements.  Well, in order not to bother, these instances are generated by the factory: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> CommandBarUIAdapterFactory : IUIElementAdapterFactory <br> { <br> <font color="#0000ff">public</font> IUIElementAdapter GetAdapter( <font color="#0000ff">object</font> uiElement) <br> { <br> <font color="#0000ff">if</font> ( uiElement <font color="#0000ff">is</font> IWordCommandBarContainer ) <font color="#008000">//</font> <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> CommandBarUIAdapter(( IWordCommandBarContainer )uiElement); <br> <font color="#0000ff">if</font> ( uiElement <font color="#0000ff">is</font> IWordCommandBar ) <font color="#008000">//  </font> <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> CommandBarButtonUIAdapter(( IWordCommandBar )uiElement); <br> <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ArgumentException( <font color="#A31515">"uiElement"</font> ); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> Supports( <font color="#0000ff">object</font> uiElement) <br> { <br> <font color="#0000ff">return</font> ( uiElement <font color="#0000ff">is</font> IWordCommandBarContainer ) || ( uiElement <font color="#0000ff">is</font> IWordCommandBar ); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  But the implementation of the collection of toolbars (with the ability to add a new one!) <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">internal</font> <font color="#0000ff">class</font> BarCollection : IWordCommandBarContainer <br> { <br> <font color="#0000ff">#region</font> IWordCommandBarContainer Members <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> AddBar(IWordCommandBar bar) <br> { <br> CommandBar commandBar = <font color="#0000ff">null</font> ; <br> <font color="#008000">//todo:  ,      </font> <br> <font color="#0000ff">try</font> <br> { <br> commandBar = Globals.ThisAddIn.Application.CommandBars[bar.Id]; <br> } <br> <font color="#0000ff">catch</font> ( ArgumentException ) { } <br> <br> <font color="#0000ff">if</font> ( commandBar == <font color="#0000ff">null</font> ) <br> commandBar = Globals.ThisAddIn.Application.CommandBars.Add(bar.Id, ( <font color="#0000ff">object</font> )MsoBarPosition.msoBarTop, _null, <font color="#0000ff">true</font> ); <br> <br> commandBar.Visible = <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">object</font> _null = System.Reflection.Missing.Value; <br> <br> <font color="#0000ff">#endregion</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The buttons on the toolbars are similar.  Look at the code at your leisure. <br><br>  It was necessary, by the way, to create a factory of buttons and toolbars themselves (see <code>IWordUIElementFactory</code> ).  The fact is that the CAB modules work with the <code>IWordCommandBar</code> and <code>IWordButton</code> .  The specific types of these interfaces are in the VSTO Word-AddIn assembly and are tied to <code>Microsoft.Office.Core</code> .  Therefore, in the modules (where there is no link to Office) there was a possibility to receive instances of the specified elements, a factory is created.  It is registered in the main WorkItem. <br><br>  Registration of factories and places of expansion for toolbars: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Services.AddNew&lt;WordUIElementFactory, IWordUIElementFactory&gt;(); <br> IUIElementAdapterFactoryCatalog factoryService = <font color="#0000ff">base</font> .Services.Get&lt;IUIElementAdapterFactoryCatalog&gt;(); <br> factoryService.RegisterFactory( <font color="#0000ff">new</font> CommandBarUIAdapterFactory()); <br> <br> UIExtensionSites.RegisterSite(UIExtensionSiteNames.WordBarsSite, <font color="#0000ff">new</font> BarCollection());</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  If you are confused, I'm sorry :) I myself understand that here without half a liter you will not understand.  (If you take care of it, then much becomes clear.) <br><br><h4>  CAB module </h4>  This is a regular build.  It should have a <code>ModuleInit</code> class.  In this class there is a link to the main use case <code>AddInWorkitem</code> and, as a result, there is access to all the good about which I wrote above. <br><br>  The task of the CAB module is to load to the main precedent, insert a toolbar, insert a button on it, describe the button handler: <br><br>  Voila: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">UIExtensionSite site = _rootWorkItem.UIExtensionSites[UIExtensionSiteNames.WordBarsSite]; <br> IWordCommandBar mainBar = site.Add&lt;IWordCommandBar&gt;(_factory.CreateBar( <font color="#A31515">"AddInToolbar"</font> )); <br> <br> IWordButton btn = _factory.CreateButton(mainBar, CommandNames.OpenForm, ToolStripItemDisplayStyle.ImageAndText, <font color="#A31515">" "</font> , <br> <font color="#A31515">"   Custom Control"</font> , Resources.OpenForm, <font color="#0000ff">false</font> ); <br> <br> mainBar.AddButton(btn); <br> btn.Click += <font color="#0000ff">new</font> EventHandler&lt;WordButtonClickArgs&gt;(ButtonClick);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The button handler will create a custom window with the ‚Äúget text‚Äù button and a text field, and then show it (using the special display modifier <code>WindowSmartPartInfo</code> ) in the previously mentioned work area (which, as we remember, I registered in the case under the <code>WorkspaceNames.MainWorkspace</code> key): <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">void</font> ButtonClick( <font color="#0000ff">object</font> sender, WordButtonClickArgs e) <br> { <br> <font color="#0000ff">object</font> smartPart = _rootWorkItem.SmartParts.AddNew&lt;SampleSmartPart&gt;(); <br> WindowSmartPartInfo info = <font color="#0000ff">new</font> WindowSmartPartInfo(); <br> info.FormStartPosition = FormStartPosition.CenterScreen; <br> info.MaximizeBox = <font color="#0000ff">false</font> ; <br> info.MinimizeBox = <font color="#0000ff">false</font> ; <br> info.Resizable = <font color="#0000ff">false</font> ; <br> info.Title = <font color="#A31515">"Custom Control"</font> ; <br> info.ShowInTaskbar = <font color="#0000ff">false</font> ; <br> _rootWorkItem.Workspaces[WorkspaceNames.MainWorkspace].Show(smartPart, info); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  Module loading </h4>  Here I made a feint knee.  Usually, modules are loaded into the framework through a special declarative loading format - the so-called ProfileCatalog.  Usually, this is a good way to connect everything you need.  But, given the harsh Soviet realities, there is a non-zero probability that the programmer will need a non-declarative module connection logic.  To do this, we will override the special service of listing loadable modules - <code>IModuleEnumerator</code> .  I made it very simple - it looks into the folder of the executable assembly and searches in it for a module called CustomModule.dll.  Finds and loads.  Well, or does not load, if it does not find: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> CustomModuleEnumerator : IModuleEnumerator <br> { <br> <font color="#0000ff">#region</font> Constants <br> <font color="#0000ff">private</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> ModuleName = <font color="#A31515">"CustomModule.dll"</font> ; <br> <font color="#0000ff">#endregion</font> <br> <br> <font color="#0000ff">#region</font> IModuleEnumerator Members <br> <br> <font color="#0000ff">public</font> IModuleInfo[] EnumerateModules() <br> { <br> <font color="#2B91AF">List</font> &lt;IModuleInfo&gt; result = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;IModuleInfo&gt;(); <br> <br> <font color="#0000ff">string</font> path = GetModulePath(ModuleName); <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">File</font> .Exists(path) ) <br> result.Add( <font color="#0000ff">new</font> ModuleInfo(ModuleName)); <br> <font color="#0000ff">return</font> result.ToArray(); <br> } <br> <br> <font color="#0000ff">#endregion</font> <br> <br> <font color="#0000ff">#region</font> Private Methods <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> GetModulePath( <font color="#0000ff">string</font> assemblyFile) <br> { <br> <font color="#0000ff">if</font> ( !Path.IsPathRooted(assemblyFile) ) <br> assemblyFile = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, assemblyFile); <br> <br> <font color="#0000ff">return</font> assemblyFile; <br> } <br> <font color="#0000ff">#endregion</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now this service is very simple, but if you wish, of course, you can pile up even a bald feature in it.  For example, load modules from the database :) <br><br>  You need to overload this service in the CAB application class: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> AddServices() <br> { <br> <font color="#0000ff">base</font> .AddServices(); <br> <br> RootWorkItem.Services.Remove&lt;IModuleEnumerator&gt;(); <br> RootWorkItem.Services.AddOnDemand&lt;CustomModuleEnumerator, IModuleEnumerator&gt;(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  Doctor, I'm tired.  What happened? </h4>  It turned out that was conceived in the original pseudo-example: <br><img src="http://img528.imageshack.us/img528/7209/addin3.jpg"><br>  In the Microsoft toolbars, there is our toolbar, a button with an icon hangs on it, the user control comes out of the button click event, and you can push the text selected in the document into the text field of the button :) Trivial, but notice how insignificant the connectivity between objects is!  I would like to note that the frame, with proper treatment, has ideal code maintainability. <br><br><h4>  Attention!  Underwater rocks! </h4><br><h5>  Security </h5>  When you compile and run the example, nothing will start.  Moreover, a message will fall out, which will tell you - they say, there are not enough rights to launch a third-party module (in our case, CustomModule.dll).  The problem is that by default the VSTO application (in development mode!) Gives Full Trust the right only to the executable assembly and to all the assemblies on which it depends - i.e.  on WordCAB.dll.  In order to allow the use of code of third-party libraries, perform the following action: <br> <code>C:\Windows\Microsoft.NET\Framework\v2.0.50727&gt;caspol -u -ag All_Code -url "D:\Projects\WordCAB\bin\Debug\*" FullTrust <br> Microsoft (R) .NET Framework CasPol 2.0.50727.3053 <br> Copyright (c) Microsoft Corporation. All rights reserved. <br> <br> The operation you are performing will alter security policy. <br> Are you sure you want to perform this operation? (yes/no) <br> yes <br> Added union code group with "-url" membership condition to the User level. <br> Success</code> <br> <br>  Instead of <code>"D:\Projects\WordCAB\bin\Debug\*"</code> you need to specify the folder from which the Add-in is launched.  Do not forget the star. <br><br><h5>  Add-in stopped loading! </h5>  Sometimes, when a raw Exception occurs in a module, Word blocks the execution of this module on the next boot.  Go to Help-&gt; About-&gt; Disabled Items and see if your extension is in the list.  If there is, remove it from there.  At the next run-debug it will appear. <br><br><h5>  How to remove </h5>  Removing an extension is not so trivial.  Pull out the COM-AddIns button on the Microsoft Word toolbar.  To do this, go to Tools-&gt; Customize-&gt; Tools -&gt; (Drag'n'Drop) COM-AddIns.  Click on it and uncheck your extension.  He will unload.  To reload, on the contrary, set the checkbox back.  Another way is to go to the control panel and remove from the programs. <br><br><h5>  And what about Word 2007? </h5>  The add-in is remarkably loaded into the Ribbon on the last tab. <br><br>  There's still a bunch of small pitfalls.  But I have already written so much here that I am not sure that anyone will finish reading to the end :) <br><br><h4>  Where to get the code </h4>  <a href="https://github.com/head-thrash/VSTO-CAB">github.com/head-thrash/VSTO-CAB</a> <br><br><h2>  findings </h2>  In general, you can take VSTO, Microsoft Office 2003, .NET Framework 2.0 and make a decision.  I have resulted in the basic decision on which it is possible to increase functionality in this article.  Who wants - use on health.  I would be happy to answer questions and correct inaccuracies, if there are such.  Thank you very much for your attention! <br></div><p>Source: <a href="https://habr.com/ru/post/54880/">https://habr.com/ru/post/54880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54870/index.html">Writing texts for websites: do not overdry, do not oversalt</a></li>
<li><a href="../54871/index.html">The Microsoft Business Start program. 3rd year. Or "41 start-up companies have just received a grant!"</a></li>
<li><a href="../54874/index.html">Open replacement ati-drivers</a></li>
<li><a href="../54878/index.html">Silverlight Development on Mac</a></li>
<li><a href="../54879/index.html">Registration for KIBORIF is open.</a></li>
<li><a href="../54881/index.html">Project Idea Generator</a></li>
<li><a href="../54882/index.html">Do you model classes (UML) before you start developing? (PHP only please!)</a></li>
<li><a href="../54886/index.html">Publishing your own book: from A to Z</a></li>
<li><a href="../54887/index.html">DaisyDisk. chamomile with apple.</a></li>
<li><a href="../54889/index.html">Building regexp on input lines S1..SN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>