<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeBSD and D-Link DI-804HV over IPSEC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about one of my first experiences with FreeBSD and how to set up IPSEC to communicate with D-Link DI-804HV and the problems that arose....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeBSD and D-Link DI-804HV over IPSEC</h1><div class="post__text post__text-html js-mediator-article"> I want to talk about one of my first experiences with FreeBSD and how to set up IPSEC to communicate with D-Link DI-804HV and the problems that arose.  I hope this helps people not to step on my rake. <br><br>  It so happened that when I came to a new job, the server with FreeBSD, which was the gateway to the Internet, fell into my area of ‚Äã‚Äãresponsibility - a mail server and a firewall were running on it.  From previous work there was experience with Linux, but FreeBSD had never seen it before.  And one of the first tasks of the new work was to set up a connection to a remote office through the Internet, for this purpose they bought a piece of metal D-Link DI-804HV.  It was decided to connect this whole economy through IPSEC. <br><a name="habracut"></a><br>  <b>Some changes have been made to the article, based on comments after the publication</b> <br>  So, what we had in stock (addresses here are given solely for example): <br>  internal enterprise network <b>192.168.250.0/24</b> , <br>  internal office network <b>192.168.0.0/24</b> , <br>  Enterprise <b>Router 192.168.250.1</b> <br>  office router <b>192.168.0.1</b> <br>  external address on FreeBSD <b>10.10.10.1</b> , <br>  external address on the DI-804HV <b>10.10.10.2</b> . <br><br>  All work carried out first on the test machine to avoid any unpleasant moments. <br>  Well, it all started as usual - from reading the documentation on the D-link site and other network resources.  The D-Link website has a description of the FreeBSD 4.8 bundle with this piece of hardware, but some of the information there is already outdated, as it turned out later. <br>  I started my work with rebuilding the kernel, including the necessary options ‚Äî the kernel configs are in <i>/ usr / src / sys / i386 / conf</i> , I copied <i>GENERIC</i> to <i>IPSEC</i> and started making changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since I have FreeBSD 9, the changes are as follows: <br> <code>options IPSEC <br> device crypto <br></code> <br><br>  If the version is less than 7 (as I understood from the discussion in the internet), the following is necessary: <br><br> <code>options IPSEC <br> options IPSEC_ESP <br> options IPSEC_DEBUG # ,     <br></code> <br><br>  I rebuilt the kernel with the commands: <br><br> <code>make buildkernel KERNCONF=IPSEC <br> make installkernel KERNCONF=IPSEC <br></code> <br><br>  where <i>IPSEC</i> is my kernel configuration name. <br><br>  Overloaded the car, checked that it is loaded. <br>  Then proceeded to install the software itself.  Before installing, everyone recommends updating ports, in my case it was through the commands: <br><br> <code>portsnap fetch <br> portsnap extract <br> portsnap update <br></code> <br><br>  After that, I started installing the necessary ports.  From reading articles in the forum, I realized that I need a racoon, it is located in the ports <i>/ usr / ports / security / ipsec-tools</i> .  There is also racoon2, but we do not need it, because ikev2 is not supported by DI-804HV. <br><br>  Install the port through: <br><br> <code>make install clean <br></code> <br><br>  After installation, go to the <i>/ usr / local / etc / racoon</i> directory - if not, then create - and create the <i>racoon.conf</i> configuration <i>file</i> : <br><br> <code>freebsd# cat /usr/local/etc/racoon/racoon.conf <br> path include "/usr/local/etc/racoon"; <br> path pre_shared_key "/usr/local/etc/racoon/psk.txt"; <br> <br> padding <br> { <br> maximum_length 20; # maximum padding length. <br> randomize off; # enable randomize length. <br> strict_check off; # enable strict check. <br> exclusive_tail off; # extract last one octet. <br> } <br> <br> listen <br> { <br> #isakmp ::1 [7000]; <br> isakmp 10.10.10.1 [500]; <br> #admin [7002]; # administrative port for racoonctl. <br> #strict_address; # requires that all addresses must be bound. <br> } <br> <br> # Specify various default timers. <br> timer <br> { <br> # These value can be changed per remote node. <br> counter 5; # maximum trying count to send. <br> interval 20 sec; # maximum interval to resend. <br> persend 1; # the number of packets per send. <br> # maximum time to wait for completing each phase. <br> phase1 30 sec; <br> phase2 15 sec; <br> } <br> <br> remote anonymous <br> { <br> exchange_mode main,base; <br> # doi ipsec_doi; <br> # situation identity_only; <br> lifetime time 28800 sec; <br> #my_identifier asn1dn; <br> #certificate_type x509 "my.cert.pem" "my.key.pem"; <br> #nonce_size 16; <br> # initial_contact on; <br> generate_policy on; <br> proposal { <br> encryption_algorithm 3des; <br> hash_algorithm sha1; <br> authentication_method pre_shared_key; <br> dh_group 2; <br> } <br> proposal_check strict; <br> <br> } <br> <br> sainfo anonymous <br> { <br> #pfs_group 2; <br> lifetime time 28800 sec; <br> encryption_algorithm 3des, cast128, blowfish 448, des, rijndael; <br> authentication_algorithm hmac_sha1, hmac_md5; <br> compression_algorithm deflate; <br> } <br> <br></code> <br><br>  Authentication will occur using a shared key (shared_key), which is located in the <i>/usr/local/etc/racoon/psk.txt</i> file: <br><br> <code>freebsd# cat /usr/local/etc/racoon/psk.txt <br> 10.10.10.2 123456789q <br></code> <br><br>  I would like to note that this file needs to change the attributes of the form 0600 from the root: <br><br> <code>freebsd# ls -l /usr/local/etc/racoon/psk.txt <br> -rw------- 1 root wheel 21 Jan 31 13:55 /usr/local/etc/racoon/psk.txt <br></code> <br><br>  Otherwise, then you can understand for a long time why it does not work. <br>  Then make changes to <i>/ etc / rc.conf</i> : <br><br> <code>racoon_enable="YES" <br> #   , gif0      <br> <s>cloned_interfaces="gif0" <br> gif_interfaces="gif0" <br> gifconfig_gif0="10.10.10.1 10.10.10.2" <br> ifconfig_gif0="inet 192.168.250.1 192.168.0.1 netmask 0xffffffff"</s> <br> ipsec_enable="YES" <br> ipsec_file="/etc/ipsec.conf" <br></code> <br><br>  Well, the <i>/etc/ipsec.conf</i> file: <br><br> <code>flush; <br> spdflush; <br> spdadd 192.168.250.0/24 192.168.0.0/24 any -P out ipsec esp/tunnel/10.10.10.1.-10.10.10.2/require; <br> spdadd 192.168.0.0/24 192.168.250.0/24 any -P in ipsec esp/tunnel/10.10.10.2-10.10.10.1/require; <br></code> <br><br>  We are overloaded, we see that the new interface has appeared, the service has started, we go to the next stage. <br><br>  Well, it seems to be done with setting up FreeBSD, it's time to start DI-804HV <br><br>  Go to the web console, go to the VPN tab, enter the name for our VPN connection and click the <b>More</b> button. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/06b/6a6/ae0/06b6a6ae0f2bb840968cd005b5f12e24.jpg" alt="image"><br><br>  We fall into the following settings and fill in all fields according to our initial conditions: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/899/a9f/a2f/899a9fa2f18f3bf51723371e2259a429.jpg" alt="image"><br><br>  After filling in this data, click <b>Apply</b> and after reloading the page we need to go to the IKE Proposal Index, click on the <b>Select IKE Proposal</b> button and what do we see? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/47e/bc5/a53/47ebc5a5345748caa6b97584ce603991.jpg" alt="image"><br><br>  And we see there only 56-bit DES, which corresponds to 1DES, and not 3DES at all, as we need. <br><br>  At first I did not pay attention to this, because of what I lost half an hour figuring out why the connection was not established.  I decided that there might be a problem in the firmware, went to <a href="">ftp.dlink.ru</a> and found out that I have the latest firmware 1.53RU.  By further googling, Google‚Äôs cache pulled information that I don‚Äôt have 3DES in my firmware, which means I need to roll back to the old one.  Found version 1.51 for 2008 <a href="">ftp.dlink.com/Gateway/di804HV/Firmware/di804HV_firmware_151.BIN</a> , <a href="">upgraded</a> , or rather, asked for voila and voila - the 3DES we needed appeared on the right page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/97f/c80/7e397fc8022cf7de96b6632ee4c07196.jpg" alt="image"><br><br>  Well, then everything is simple - choose <b>DH Group - Group 2</b> (this is the same as modp1024, if for racoon2), <b>encrypt algorithm - 3DES</b> , <b>Auth algorithm - SHA1</b> , <b>Life Time = 28800</b> (it is necessary to ensure that all these parameters coincide with those that we have in <i>/usr/local/etc/racoon/racoon.conf.In the</i> end, do not forget to select the desired <b>Proposal ID</b> in the combo box, click <b>Add to</b> Proposal Index and after that - <b>Apply.</b> <br><br>  Go back and go to <b>IPSeS Proposal</b> and fill in all the necessary fields there: <br><br><img src="http://s004.radikal.ru/i205/1202/e0/9d954e86f885.jpg" alt="image"><br><br>  We also add this all by analogy, save and go to the <b>Status-&gt; VPN Status</b> tab: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d58/fbd/8a1/d58fbd8a1cbfea3c2825f4b94c4a7e71.jpg" alt="image"><br><br>  Click Reconnect - and that's it, you can check the operation of the channel: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ba/512/66f/1ba51266f3321d90df36cf2ba091d49f.jpg" alt="image"><br><br>  References: <br>  <a href="http://www.opennet.ru/">www.opennet.ru</a> <br>  forum.lissyara.su <br>  <a href="http://www.google.ru/">www.google.ru</a> <br><br>  PS This article was written only to facilitate the installation of this FreeBSD &lt;-&gt; D-Link DI-804HV bundle, because during the setup process I regularly ran into various problems in the bundle on the forums.  Any constructive comments are welcome. </div><p>Source: <a href="https://habr.com/ru/post/137456/">https://habr.com/ru/post/137456/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137446/index.html">Metaprogramming</a></li>
<li><a href="../137449/index.html">PROhq Online Phone - New Freelance Tool</a></li>
<li><a href="../137451/index.html">Draw three-dimensional icons</a></li>
<li><a href="../137453/index.html">Practical bioinformatics p.4. Getting ready to work with ZINBA</a></li>
<li><a href="../137454/index.html">MySQL in NGINX: using blocking libraries in a non-blocking server</a></li>
<li><a href="../137457/index.html">The gov.uk platform will be completely open. Source codes published on GitHub</a></li>
<li><a href="../137458/index.html">Why don't we make personal computers anymore?</a></li>
<li><a href="../137459/index.html">PHP deobfuscation</a></li>
<li><a href="../137460/index.html">"Money for free!" For fans of social networks</a></li>
<li><a href="../137461/index.html">The use of fuzzy binary relations in solving the problem of appointments (distribution of personnel)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>