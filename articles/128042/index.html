<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DIY disassembler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Knowledge of the structure of machine commands for many years is not mandatory, so that a person can call himself a programmer. Naturally it was not a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DIY disassembler</h1><div class="post__text post__text-html js-mediator-article">  Knowledge of the structure of machine commands for many years is not mandatory, so that a person can call himself a programmer.  Naturally it was not always.  Before the appearance of the first assemblers, programming was carried out directly in machine code.  Hard work, coupled with a large number of errors.  Modern assemblers allow (to a reasonable degree) to abstract from iron, the method of coding commands.  What can we say about the compilers of high-level languages.  They are striking with the complexity of their implementation and the simplicity with which the programmer is allowed to convert the source code into a sequence of machine instructions (and to convert, to a sufficient degree, optimally).  From the programmer is required only knowledge of your favorite language / IDE.  Knowledge of what the source listing translates into is not necessary. <br>  Those who are interested in looking at a brief description of the coding structure of machine instructions, an example implementation, and the source code of a disassembler for x86 architecture are welcome. <br><br><a name="habracut"></a><br>  Creating a disassembler for the x86 architecture is, although the task is not very difficult, but still quite specific.  A certain kind of knowledge is required of a programmer ‚Äî knowledge of how a microprocessor recognizes a sequence of ‚Äúbytes‚Äù in machine code.  Not every university can provide such knowledge in the amount sufficient for writing a fully functional modern disassembler - you have to look for yourself (usually in English).  This post does not pretend to be complete coverage of the problem of creating a disassembler, it only briefly describes how the disassembler was written for the x86 architecture, 32-bit command execution mode.  I would also like to note the likelihood of possible inaccuracies in the translation of certain concepts from the official specification. <br><br>  <b>Command structure for intel x86</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The command structure is as follows: <br>  ‚Ä¢ Optional prefixes (each prefix is ‚Äã‚Äã1 byte in size) <br>  ‚Ä¢ Mandatory command opcode (1 or 2 bytes) <br>  ‚Ä¢ Mod_R / M - baytik, defining the command operand structure - optional. <br>  ‚Ä¢ Optional bytes occupied by command operands (sometimes divided as one byte of the SIB [Scale, Index, Base], offset and immediate value field). <br><br>  <b>Prefixes</b> <br><br>  The following prefixes exist: <br>  The first six change the segment register used by the command when accessing a memory cell. <br>  ‚Ä¢ 0x26 - prefix for replacing ES segment <br>  ‚Ä¢ 0x2E - CS segment replacement prefix <br>  ‚Ä¢ 0x36 - SS segment replacement prefix <br>  ‚Ä¢ 0x3E - DS segment replacement prefix <br>  ‚Ä¢ 0x64 - FS segment replacement prefix <br>  ‚Ä¢ 0x65 - GS segment replacement prefix <br><br>  ‚Ä¢ 0x0F - prefix for additional commands (sometimes it is not considered to be a real prefix - in this case, the opcode of a command is considered to consist of two bytes, the first of which is 0x0F) <br><br>  ‚Ä¢ 0x66 - operand size override prefix (for example, ax will be used instead of eax) <br>  ‚Ä¢ 0x67 - address size override prefix (see below) <br>  ‚Ä¢ 0x9B - wait prefix (WAIT) <br>  ‚Ä¢ 0xF0 - blocking prefix (LOCK with its help realizes synchronization of multi-threaded applications) <br>  ‚Ä¢ 0xF2 - REPNZ command repeat prefix - work with byte sequences (strings) <br>  ‚Ä¢ 0xF3 - prefix repeat command REP - work with byte sequences (strings) <br><br>  Each of these prefixes changes the semantics and / or structure of the machine instruction (for example, its length or the choice of mnemonics). <br><br>  <b>Opkody teams.</b> <br>  The team opcode is sometimes one, sometimes together with the prefix (s) uniquely identifies the mnemonic (name) of the command.  There are many teams.  And with the increasing complexity of modern microprocessors, their number does not decrease - new commands appear, and obsolete ones do not disappear (backward compatibility).  The list of opcodes and commands associated with them, as a rule, can be downloaded on the official websites of manufacturers of microprocessors. <br><br>  The Mod_R / M byte consists of the following fields: <br><br>  ‚Ä¢ Mod - the first two bits (value from 0 to 3) <br>  ‚Ä¢ R / M - the next three bits (value from 0 to 7) <br>  ‚Ä¢ Value of ModR / M - the next three bits (value from 0 to 7) <br><br>  <b>Implementation:</b> <br><br>  For writing disassembler we will use the following page: <a href="http://ref.x86asm.net/geek32.html">http://ref.x86asm.net/geek32.html</a> . <br><br>  We see several tables.  In essence, only these tables and the description of their fields will be needed for writing the disassembler.  Of course, logical reasoning and free time are additionally required. <br>  The first table contains a list of machine commands that do not contain the prefix 0x0F.  In the second list of commands containing this prefix (most of these commands appeared in microprocessors of the ‚ÄúPentium with MMX‚Äù family or later). <br>  The following three tables allow you to convert the Mod_R / M byte into a sequence of command operands for a 32-bit command encoding mode.  Moreover, each subsequent of these three tables specifies the Mod_R / M byte parsing of special cases of the previous table. <br>  The last table allows you to convert the Mod_R / M byte into a sequence of command operands for a 16-bit command encoding mode.  By default, the command is considered to be encoded in 32-bit mode.  To change the encoding mode, use the address size override prefix (0x67). <br><br>  The first thing that needs to be done is to move the first two tables to convenient data structures for work.  On the same site, you can download xml-versions of these tables, and already convert them into beautiful sishny structures.  I did it differently - I loaded the html tables into Excel, and already there, writing a simple script on VBA, I received the source code that, after manual corrections, was the required data structures. <br><br>  The algorithm for disassembling itself is quite simple: <br><br>  ‚Ä¢ A list of prefixes used in the current machine instruction is collected. <br>  ‚Ä¢ The corresponding field is searched for in one of the two tables depending on the opcode, prefixes and generation (model) of the target (desired) microprocessor. <br>  ‚Ä¢ The record we find is characterized by a list of fields, such as the generation (model) of the microprocessor, from which the support for this command has appeared or, for example, the list of flags that this command can change.  We are mainly interested only in the mnemonic (name) of the command and the list of operands.  After analyzing all the operands found and the Mod_R / M byte field, we can learn the textual representation and the length of the command. <br><br>  The number of operands can range from zero to three.  The source tables contain over a hundred types of operands.  Some operands are duplicated - they have different names, but the sequence of actions for mod_r / m byte processing (and possibly subsequent bytes) is the same. <br><br>  To view an example of processing various operands and an example of disassembling the simplest ‚ÄúHello world‚Äù function, you can download the <a href="">disassembler source code for the C ++ Builder 6 compiler</a> . <br><br>  <b>PS:</b> <br>  It‚Äôs not a fact that someone who has read this post ever needs information gathered from it (units write disassemblers), but in any case this disassembler was tested and even included in a <a href="http://www.os-lab.ru/protector.htm">fairly large commercial tread</a> , the source code is open and distributed freely ) </div><p>Source: <a href="https://habr.com/ru/post/128042/">https://habr.com/ru/post/128042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128037/index.html">The story of how for the year $ 20,000 turn into $ 2,000,000. Copy one year later</a></li>
<li><a href="../128038/index.html">How to pack a startup</a></li>
<li><a href="../128039/index.html">Nexus Prime is already in pre-order</a></li>
<li><a href="../128040/index.html">Remote access from Windows on FreeBSD for beginners</a></li>
<li><a href="../128041/index.html">New Wi-Fi standard</a></li>
<li><a href="../128044/index.html">1080p on Raspberry Pi</a></li>
<li><a href="../128045/index.html">Notes on restoring embedded systems</a></li>
<li><a href="../128047/index.html">Graph visualization using arbor.js library</a></li>
<li><a href="../128048/index.html">We lift several Ruby on Rails projects on the same server under different versions of ruby ‚Äã‚Äã(Nginx + Unicorn)</a></li>
<li><a href="../128050/index.html">Google bought the company Zagat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>