<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to use Java with CryptoPro to sign a PDF document</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I am an employee of Alfa-Bank and develop software with built-in cryptographic information protection. 

 In this article I want to talk about ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to use Java with CryptoPro to sign a PDF document</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/alfa/blog/337668/"><img src="https://habrastorage.org/web/6f5/e23/4e7/6f5e234e72b24f04803646a28077b5c0.jpg"></a> <br><br>  Hello!  I am an employee of Alfa-Bank and develop software with built-in cryptographic information protection. <br><br>  In this article I want to talk about the following things: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  the benefits of PDF as an electronically signed document; </li><li>  Java platform, itextpdf library and CryptoPro CSP IMSP as signature tools; </li><li>  about what difficulties I had to face, about the improvement of itextpdf; </li><li>  give an example of code that performs several signatures; </li><li>  talk about the appropriateness of using PDF as a signed document. </li></ul><a name="habracut"></a><br>  In the modern information world, the importance of an electronic signature and the basic services provided by it (data integrity, and non-repudiation of authorship) cannot be overestimated.  State bodies, individuals and legal entities make extensive use of electronic signatures in the exchange of information among themselves. <br><br>  According to the law, an electronic signature can give documents legal force, equal in importance to a paper carrier, signed by a handwritten signature and sealed by an authorized person. <br><br><h3>  PDF Benefits </h3><br>  As a container for storing a variety of information in a friendly view of the person, the PDF format has rightfully gained its popularity.  It will turn out to open in any OS.  A PDF document may contain not only textual and tabular data, but also audio and video recordings, engineering graphics, and three-dimensional models.  For additional processing of PDF documents, this format includes such a powerful tool as JavaScript support for changing the content in forms and fields upon the occurrence of an event or performing a user action. <br><br>  Tools Adobe Systems (developer PDF) support the use of electronic signatures.  Unlike messages with an attached enhanced electronic signature of the PKCS # 7 standard and its enhancement CAdES, no additional special software is required to view a signed PDF document.  In addition to the cryptographic provider, which is required in all cases. <br><br>  Those.  Adobe tools allow you to visualize an electronic signature in a document. <br><br>  When signing a PDF document, you can set visualization parameters, specify the page number, block size with a signature, the name of the field where to place it, add a graphic image, for example, a company logo, scan a personal signature of the manager and print the organization. <br><br>  When viewing such documents, in addition to visualization in the body of the document, Acrobat and Adobe Reader display the ‚ÄúSignatures‚Äù tab with related information: an icon indicating the status of the signature verification, information on whether the document was changed, the result of the public key certificate, the last verification time , page and field containing an electronic signature. <br><br><h3>  Signature tools </h3><br>  The Java version was used: "1.8.0_111" HotSpot (TM) 64-Bit Server VM (build 25.111-b14). <br><br>  As a certified means of protecting information from a licensed developer, we use the cryptographic provider CryptoPro CSP v4.0 and CryptoPro JCP - v.2.0, with the installation of the CryptoPro Java CSP v.4.0 module <br><br>  Why CryptoPro JCP - v.2.0, with CryptoPro Java CSP v.4.0? <br><br>  Because the provider of CryptoPro JCP, after a long non-certified period, received a certificate of conformity from the regulator until 12/31/2018, and then, according to information from the developer, with certification, uncertainty may reappear.  The CryptoPro Java CSP v.4.0 module does not perform cryptographic transformations in itself and is essentially an API to the CryptoPro CSP provider, with the next certification of which there are no questions.  Here it must be said that a valid certificate on the CIPP is not required, provided that the cryptographic provider is used exclusively for internal purposes. <br><br>  In accordance with the Java Cryptography Architecture (JCA) specification, in my application, I specify and use the functions of a cryptographic provider: JCSP.  After installing CryptoPro, this provider is displayed in the list of all available in the ../java/jdk1.8.x_xxx/jre/lib/security/java.security file, where you can configure which of them is preferable for using by default, unless explicitly indicated in the annex: <br> <code># <br> # List of providers and their preference orders (see above): <br> # <br> security.provider.1=ru.CryptoPro.JCSP.JCSP</code> <br> <br>  We do not forget that the export restrictions of the Java platform, which block the operation of cryptographic providers with Russian encryption algorithms, should be lifted. <br><br>  To do this, in ../java/jdk1.8.x_xxx/jre/lib/security, you must replace the <strong>local_policy.jar</strong> and <strong>US_export_policy.jar</strong> files <strong>with the</strong> <strong>ones</strong> provided at: <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 8 Download</a> <br>  and containing in <strong>default_local.policy</strong> and <strong>default_US_export.policy</strong> : <br><br> <code>grant { <br> // There is no restriction to any algorithms. <br> permission javax.crypto.CryptoAllPermission; <br> }; <br></code> <br>  The use of iText library <a href="http://itextpdf.com/">itextpdf.com</a> for working with PDF documents in Java was dictated by the CryptoPro provider. <br><br>  CryptoPro JCP ships a Git patch file for the iTextpdf library version 5.1.3 - <br>  jcp-2.0.xxxxx \ Doc \ itextpdf \ itextpp_5.1.3.gost.user.patch <br><br><img src="https://habrastorage.org/web/86d/5b2/db0/86d5b2db015a467e9d6bcdf98f539888.png"><br><br>  The patch adapts itextpdf to work with the provider CryptoPro.  You need to download the source code of the library version 5.1.3, then use the Git version control Bash command line to apply the patch: git apply --stat itextpdf_5.1.3.gost.user.patch <br><br><img src="https://habrastorage.org/web/6d5/3fe/ded/6d53feded99540bb94a08d2fd2e3cd4a.png"><br><br>  Next, you need to collect the resulting library from the updated source code and connect to the application. <br><br>  You can find many examples in CryptoPro JCP in the sample <strong>-sources.jar</strong> file.  In particular, there are examples of signature and verification of electronic documents in PDF documents.  (\ PDF \ SignVerifyPDFExample.java). <br><br><h3>  Problems and difficulties of assembly </h3><br>  After successfully updating the source code of itextpdf, dependencies on packages ru.CryptoPro.JCP and ru.CryptoPro.reprov.x509 appear in it. <br><br>  Without them, the project with the source code itextpdf_5.1.3.gost will not build. <br><br> <code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:2.3.2:compile (default-compile) on project itextpdf: Compilation failure: Compilation failure: <br> [ERROR] \github\iTextpdf_5.1.3_patched_cryptopro_bc1.50\src\main\java\com\itextpdf\text\pdf\PdfPKCS7.java:[138,23] error: package ru.CryptoPro.JCP does not exist <br> [ERROR] \github\iTextpdf_5.1.3_patched_cryptopro_bc1.50\src\main\java\com\itextpdf\text\pdf\PdfPKCS7.java:[139,31] error: package ru.CryptoPro.reprov.x509 does not exist <br></code> <br>  You need to take the JCP.jar and JCPRevTools.jar files from the CryptoPro 2.0 distribution and place them in the JRE directory that Maven uses: Java \ jdk1.8.0_111 \ jre \ lib \ ext.  Of course, they should be in the classPath of the application. <br><br>  So, the library is assembled, we connect it to the application.  And here comes the main problem.  iTextpdf_5.1.3 contains a dependency on Bouncy Castle version 1.46 - an open source library that implements a cryptographic provider and support for ASN.1 structures. <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.bouncycastle<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>bctsp-jdk15<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.46<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>jar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>compile<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optional</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optional</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The delivery of CryptoPro JCP 2.0 in turn has dependencies on Bouncy Castle version 1.50 bcpkix-jdk15on-1.50 and bcprov-jdk15on-1.5, respectively, they are placed in jre / lib / ext when installing CryptoPro. <br><br>  As a result, when you start your application and the method of signing the PDF, we get the error: <br><br> <code>Exception in thread "main" java.lang.NoClassDefFoundError: org/bouncycastle/asn1/DEREncodable <br> at com.itextpdf.text.pdf.PdfSigGenericPKCS.setSignInfo(PdfSigGenericPKCS.java:97) <br> at com.itextpdf.text.pdf.PdfSignatureAppearance.preClose(PdfSignatureAppearance.java:1003) <br> at com.itextpdf.text.pdf.PdfSignatureAppearance.preClose(PdfSignatureAppearance.java:904) <br> at com.itextpdf.text.pdf.PdfStamper.close(PdfStamper.java:194) <br> at ru.alfabank.ccjava.trustcore.logic.SignatureProcessor.pdfSignature(SignatureProcessor.java:965) <br> at ru.alfabank.ccjava.trustcore.logic.SignatureProcessor.main(SignatureProcessor.java:1363) <br> Caused by: java.lang.ClassNotFoundException: org.bouncycastle.asn1.DEREncodable <br> at java.net.URLClassLoader.findClass(Unknown Source) <br> at java.lang.ClassLoader.loadClass(Unknown Source) <br> at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source) <br> at java.lang.ClassLoader.loadClass(Unknown Source) <br> ... 6 more <br></code> <br>  Every Java developer has come across such an exception in the main stream and knows that you can spend a lot of time analyzing the problem and how to fix it.  The essence of the NoClassDefFoundError exception is as follows: it is thrown when the Java virtual machine cannot find the specific class that was available at the compilation stage during the execution of the application. <br><br>  What turns out - the iTextpdf_5.1.3 library has a dependency on the older provider Bouncy Castle, and for the new versions of iTextpdf there is no patch from CryptoPro. <br><br>  Specifically, in the delivery of CryptoPro JCP 2.0 dependencies on the new version of Bouncy Castle has the library CAdES.jar.  If you remove this library from the JRE, or refuse to support the formation of CAdES signatures when installing CryptoPro JCP 2.0, the problem will be solved. <br><br>  But what if CAdES support should remain? <br><br>  To get rid of the library conflict, the following steps should be taken: <br><br><ul><li>  replace the source code of the library iTextpdf_5.1.3_patched_cryptopro org.bouncycastle 1.46 dependency on version 1.50. <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.bouncycastle<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>bcprov-ext-jdk15on<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.50<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.bouncycastle<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>bcprov-jdk15on<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.50<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.bouncycastle<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>bcmail-jdk15on<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.50<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></li><li>  We make corrections to the project iTextpdf_5.1.3_patched_cryptopro, guided by the document <a href="http://www.bouncycastle.org/wiki/display/JA1/Porting%2Bfrom%2Bearlier%2BBC%2Breleases%2Bto%2B1.47%2Band%2Blater">Bouncy Castle "Porting from earlier BC releases to 1.47 and later"</a> </li><li>  To fix the iTextpdf_5.1.3_patched_cryptopro places, where the business was not limited to new class names and methods of Bouncy Castle, but the constructions in the methods were clearly changed, download the source code itextpdf 5.5.5, which has a dependency on Bouncy Castle 1.50, thoughtfully transfer the implementation of the methods from there . </li></ul><br>  As a result, the project iTextpdf_5.1.3_patched_cryptopro_bc1.50 starts to build.  Conflict resolved, CryptoPro and itextpdf link to the same version of org.bouncycastle 1.50. <br><br>  The source code iTextpdf_5.1.3_patched_cryptopro_bc1.50 is uploaded to GitHub: <a href="">iTextpdf_5.1.3_patched_cryptopro_bc1.50</a> <br><br><h3>  Sample code, several PDF signatures </h3><br>  An example of using CryptoPro and iTextpdf_5.1.3_patched_cryptopro_bc1.50 is as follows: <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> aliases * -      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> data * -     PDF * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> pdfVersion * -    PDF * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> SignatureProcessorException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] samplePDFSignature(String[] aliases, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> pdfVersion) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> SignatureProcessorException { ByteArrayOutputStream bais = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); HashMap&lt;X509Certificate, PrivateKey&gt; currSignAttrMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;X509Certificate, PrivateKey&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String alias : aliases) { X509Certificate certificate = (X509Certificate) signAttributesMap1.get(alias)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; PrivateKey privateKey = (PrivateKey) signAttributesMap1.get(alias)[<span class="hljs-number"><span class="hljs-number">1</span></span>]; currSignAttrMap.put(certificate, privateKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (certificate == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignatureProcessorException(PDF_SIGNATURE_ERROR + CERTIFICATE_NOT_FOUND_BY_ALIAS); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (privateKey == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignatureProcessorException(PDF_SIGNATURE_ERROR + PRIVATE_KEY_NOT_FOUND_BY_ALIAS); } } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { FileInputStream fis = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(FILE_PATH)); ByteArrayOutputStream baos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((n = fis.read(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, buf.length)) != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { baos.write(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, n); } fis.close(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] im = baos.toByteArray(); X509Certificate innerCA = obtainCertFromTrustStoreJKS(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, INNER_CA); PdfStamper stp = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; PdfReader reader = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pageNumber = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entry&lt;X509Certificate, PrivateKey&gt; entry : currSignAttrMap.entrySet()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bais.toByteArray().length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PdfReader(data); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PdfReader(bais.toByteArray()); bais = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); } stp = PdfStamper.createSignature(reader, bais, pdfVersion); <span class="hljs-comment"><span class="hljs-comment">//'\0' Certificate[] certPath = new Certificate[] {entry.getKey(), innerCA}; PdfSignatureAppearance sap = stp.getSignatureAppearance(); sap.setProvider("JCSP"); //JCP sap.setCrypto(entry.getValue(), certPath, null, PdfSignatureAppearance.CRYPTOPRO_SIGNED); Image image = Image.getInstance(im); sap.setImage(image); sap.setVisibleSignature(new Rectangle(150, 150), pageNumber, null); pageNumber++; stp.close(); bais.close(); reader.close(); } } catch (RuntimeException e) { throw new SignatureProcessorException(PDF_SIGNATURE_ERROR + ExceptionUtils.getFullStackTrace(e)); } catch (IOException e) { throw new SignatureProcessorException(PDF_SIGNATURE_ERROR + ExceptionUtils.getFullStackTrace(e)); } catch (DocumentException e) { throw new SignatureProcessorException(PDF_SIGNATURE_ERROR + ExceptionUtils.getFullStackTrace(e)); } catch (CertificateEncodingException e) { throw new SignatureProcessorException(PDF_SIGNATURE_ERROR + ExceptionUtils.getFullStackTrace(e)); } catch (Exception e) { throw new SignatureProcessorException(PDF_SIGNATURE_ERROR + ExceptionUtils.getFullStackTrace(e)); } return bais.toByteArray(); }</span></span></code> </pre><br>  The method takes as input a list of container names with keys of an electronic signature, bytes of a PDF document and the version number of the PDF format.  According to the specified names, keys and certificates are retrieved from the cache.  The image is loaded for visualization of the signature. <br><br>  An object with a root certificate is created to form the certification path that is required by the setCrypto method of the com.itextpdf.text.pdf.PdfSignatureAppearance class. <br><br>  The loop signs the pages of the PDF document with the keys whose names were transferred to the method. <br><br>  For the demonstration, two signatures were made - valid and non-valid with an invalid certificate. <br><br><img src="https://habrastorage.org/web/c8b/ebc/baa/c8bebcbaa7d34f89a9e4f0ca2a0b8d0d.png"><br><br><img src="https://habrastorage.org/web/fc4/091/28a/fc409128a9744cf29c1a5b0a84a9dfd8.png"><br><br>  Tab "Signatures" is as follows: <br><br><img src="https://habrastorage.org/web/548/f88/3e7/548f883e781942a49967a920fae51b4e.png"><br><br><img src="https://habrastorage.org/web/bad/28f/4bf/bad28f4bfc92420787d58256b04ae5eb.png"><br><br><h3>  Application of electronic signature of PDF documents </h3><br>  In my opinion, the signature directly in PDF format is a special case.  Such a stamp in the file itself is intended more likely to visualize an EA for the purpose of checking it with eyes.  This is convenient and effective when it comes to a small number of documents where automation is not required, and the operator performs the role of a reviewer. <br><br>  With the intensive process of exchanging a large number of electronic documents, the operator will not cope.  In this case, the information system performs automation, and there is no need for a beautiful visualization.  Accordingly, it is unnecessary to waste the resources of the information system and electronic channels for the transfer of large PDF files and the processing of stamp images. <br><br>  It is more practical to form the electronic signature as a separate file or to wrap the file and the signature in one PKCS # 7 standard container (CAdES).  This standard with attached or disconnected signature is perfect for a large document flow between information systems. <br><br>  The same PDF document can be signed by the CAdES standard with a detached signature, as a result there will be two files - the PDF itself and the container with the signature. <br><br>  Recall the problems encountered when signing on to Java.  Conclusion - the PDF format is currently poorly supported by CryptoPro in the part of the application programming interface for Java.  The existing itextpdf library had to be edited independently. <br><br>  In the field of activities related to the development of commercial software with embedded DTPM, such an approach is unacceptable, patches, updates and improvements should be performed by the organization-licensee.  Therefore, the method of signing a PDF document given in the post can be used to demonstrate the possibilities and for internal use. <br><br><h3>  useful links </h3><br><ol><li>  <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 8</a> </li><li>  <a href="https://cryptopro.ru/">Website CryptoPro</a> </li><li>  <a href="http://itextpdf.com/">ITextpdf Developer</a> </li><li>  <a href="http://www.bouncycastle.org/wiki/display/JA1/Porting%2Bfrom%2Bearlier%2BBC%2Breleases%2Bto%2B1.47%2Band%2Blater">Bouncy Castle "Porting from earlier releases to 1.47 and later"</a> </li><li>  <a href="">Source code for iTextpdf_5.1.3_patched_cryptopro_bc1.50 in GitHub</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/337668/">https://habr.com/ru/post/337668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337658/index.html">How we built our mini data center. Part 5 - experience, breaks, heat</a></li>
<li><a href="../337660/index.html">Why is a site audit useless for 99% of small businesses?</a></li>
<li><a href="../337662/index.html">JavaScript: Asynchronous Programming Techniques</a></li>
<li><a href="../337664/index.html">Report with mitap for back-end developers</a></li>
<li><a href="../337666/index.html">How to meet the requirements of the quality management system according to ISO 9001: 2015</a></li>
<li><a href="../337670/index.html">Interserver WebRTC</a></li>
<li><a href="../337672/index.html">Getting the text of requests from SoapHttpClientProtocol</a></li>
<li><a href="../337674/index.html">Kindergarten, pants with straps: where do programmers come from</a></li>
<li><a href="../337676/index.html">How to optimally calculate the amount of "iron": Sizing model of the EFS</a></li>
<li><a href="../337678/index.html">The practice of forming requirements in IT projects from A to Z. Part 6. System behavior. Excellence requirements</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>