<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In the footsteps of RTM. Forensic investigation of a computer infected with a banking trojan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite a lot was written about the RTM banking Trojan attacks on accountants and financial directors, including Group-IB experts , but in the public fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In the footsteps of RTM. Forensic investigation of a computer infected with a banking trojan</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/lr/n9/jq/lrn9jqxckejcndmfynlxv2idhno.jpeg"><br><br>  Quite a lot was written about the RTM banking Trojan attacks on accountants and financial directors, including Group-IB <a href="https://www.group-ib.ru/blog/buhtrap-2">experts</a> , but in the public field there has not yet been a single case study of RTM-infected devices.  To correct this injustice, <b>Oleg Skulkin</b> , one of the Group-IB's leading computer forensics <b>specialists,</b> gave a detailed account of how to conduct a forensic investigation of a computer infected with a banking trojan as part of an incident response / investigation. <a name="habracut"></a><br><br><h3>  How it all began <br></h3><br>  Researchers learned about the activities of the RTM criminal group in December 2015.  Since then, phishing e-mails that distribute this Trojan, fall into the electronic mailboxes of potential victims with enviable consistency. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As you already know, from September to December, the RTM group sent out over 11,000 malicious emails.  Cybercriminals do not intend to stop at what has been accomplished, as evidenced by all the new mailings that we record both on sensors that protect our clients and in the framework of collecting data on current threats. <br><br>  In this article I will tell you how to conduct a forensic investigation, or simply forsensiku, of the image of a computer drive infected with a RTM banking trojan. <br><br>  <b>Necessary introductory</b> <b><br></b> <br>  Imagine that we do not know about infecting a computer with RTM, but we have only the fact of compromise, which resulted in the theft of money - this will make building the research process more interesting and also make it applicable to other cases.  I also want to draw attention to the fact that in this article I will not dwell on the reverse engineering of the Trojan: firstly, this is not the competence of the criminologist, secondly, my colleague, Semyon Rogachev, wrote about this in detail in <a href="https://habr.com/ru/company/group-ib/blog/432256/">Habr√©</a> . <cut></cut><br><br>  So, all that we have is an image of a computer drive in the ‚ÄúE01‚Äù format (Encase Image File Format).  For a start, it would be nice to know what's inside.  At a minimum, the operating system, because it is from her and her version, of course, depends on the presence of certain forensic artifacts that we have to investigate. <br><br>  1. Use the mmls utility from the Brian Carrier‚Äôs Sleuth Kit package: <br><br><img src="https://habrastorage.org/webt/ul/5v/sm/ul5vsmdojpvdw-fgaygg5zkd7fe.png"><br><br>  What do we have?  Multiple NTFS partitions similar to Windows.  We need to make sure - we will try to find registry files, for example, SOFTWARE. <br><br>  2. Use the fls (the Sleuth Kit) and findstr utilities to find out the corresponding record number in the main file table (MFT): <br><br><img src="https://habrastorage.org/webt/o0/cw/gc/o0cwgcy4wzd3w_sbtgfuzs8ntv8.png"><br><br>  Great, now we can copy the file we need for further analysis using icat (the Sleuth Kit): <br><br>  <b>icat -o 718848 E: \ RTM.E01 234782&gt; SOFTWARE</b> <b><br></b> <br>  So, we have the registry file SOFTWARE, extract the most significant information from which we can, for example, with the help of RegRipper Harlan Carvey.  At the moment, we are interested in the contents of the Microsoft \ Windows NT \ CurrentVersion section: <br><br><img src="https://habrastorage.org/webt/wy/fu/ww/wyfuww8ciqvsctoozxqs7y17yvi.png"><br><br>  Now we know that the computer under investigation was running Windows 7 Professional with SP1, and therefore we know what forensic artifacts we may encounter and which ones we may need. <br><br>  Where to start our search?  Recall the Jesse Kornblum paradox: "Malware can hide, but it must run."  A good start could be a search for potential pinning mechanisms in the system that allow malware to restart after restarting the computer. <br><br>  Let's start with a simple one: take the registry file <b>NTUSER.DAT</b> from the user's directory (C: \ Users \% username% \) with the latest modification date and extract data from it using the same RegRipper.  If we again want to get the record number of the file we need with the help of fls and findstr, then we need to add the ‚Äìp parameter for fls - this will allow the utility to output the full paths to the files.  Why do you need it?  The fact is that the NTUSER.DAT file is in the directory for each user, and SOFTWARE is one for the entire system, so in this case it is important to get the record number of a specific file.  In general, it is not necessary to use the Sleuth Kit, there are more convenient tools, for example, <b>FTK Imager</b> - a free AccessData development tool that can be used not only to create forensic copies, but also to study their contents: <br><br><img src="https://habrastorage.org/webt/pa/j-/ga/paj-ga2chze-9mh0dtypvdnecnm.png"><br><br>  Let's start with low-hanging fruits, the so-called <b>‚Äúrun keys‚Äù</b> : <br><br><img src="https://habrastorage.org/webt/fw/0t/ow/fw0towuba5xcawhqu1qrxdejcbu.png"><br><br>  So what do we have?  The partition was last modified on November 7th, and we see that when a user logs in, the apg.exe file is launched from a non-standard location.  Let's see what else can be found in the b7mg81 directory: <br><br><img src="https://habrastorage.org/webt/lk/dw/0n/lkdw0nanxdhw5vskl4o_2t_vspq.png"><br><br>  TeamViewer?  Interesting.  Let's take a closer look at apg.exe - <b>let's</b> use <b>PPEE</b> : <br><br><img src="https://habrastorage.org/webt/dc/yt/am/dcytamx_6uoucjsgajn5knlfe2w.png"><br><br>  Looks like a teamviewer, signed up as a teamviewer, does that mean teamviewer?  It looks like it.  But it's not that simple.  Let's look at the import table: <br><br><img src="https://habrastorage.org/webt/px/7e/tq/px7etqtttsf2w4og8pdxjyer4wm.png"><br><br>  So, msi.dll, somewhere we have already seen this file, and this is not C: \ Windows \ System32, but the same b7mg81 directory.  Judging by the size, it has nothing to do with the original msi.dll, which means it‚Äôs available - <b>Search Search DLL Hijacking</b> : the operating system starts searching for the required libraries from the current directory, which means that the legitimate msi.dll will be loaded in b7mg81. <br><br>  Another interesting file is <b>TeamViewer.ini</b> : <br><img src="https://habrastorage.org/webt/vr/fi/qj/vrfiqjtz1nbptqq4dix83upebuo.png"><br><br>  And here is the counter-forensic: judging by the configuration file, our teamViewer did not keep logs, and, apparently, was used as a RAT.  Well, not bad.  It's time to find out if it started at all. <br><br>  There are a lot of artifacts in Windows that indicate the launch of executable files.  Let's continue to work with the registry, this time with the <b>SYSTEM file</b> .  In order to extract data from it, you can use RegRipper again. <br><br>  We are interested in ControlSet001 \ Control \ Session Manager \ AppCompatCache.  Here we will find a list of executable files with paths to them, dates of the last modification (according to the $ STANDARD_INFORMATION attribute), as well as a flag indicating whether the file was launched or not: <br><br><img src="https://habrastorage.org/webt/xb/zy/ly/xbzylyyclidtgk8x2e1nesl9_pm.png"><br><br>  Great, our file was run at least once.  So, we have a certain ‚Äúpivot point‚Äù, we know that on November 7, TeamViewer appeared on the computer's drive, which did not keep journals, and most likely was not visible to the user, because instead of the legitimate library, it loaded the one that is with it in one directory. <br><br>  It's time to start building a timeline.  I think enough of what can be built with the help of the Sleuth Kit.  Let's start with the fls utility already known to us: <br><br>  <b>fls.exe -m "C: /" -o 718848 -r -z GMT D: \ RTM.E01&gt; bodyfile.txt</b> <b><br></b> <br>  Now use mactime to convert the resulting file to the timeline: <br><br>  <b>mactime.pl -d -b bodyfile.txt&gt; timeline.csv</b> <b><br></b> <br>  Timelines are very convenient to analyze in <b>Eric Zimmerman's Timeline Explorer</b> .  Our timeline will only include file system events.  If you want it to include changes in the registry, journals, etc., you can use plaso.  Personally, I use it extremely rarely, since data processing takes a lot of time, and the result is often quite redundant. <br><br>  Let's go back to the timeline.  The b7mg81 catalog was created on November 7, 2018 at 13:59:37: <br><img src="https://habrastorage.org/webt/za/fj/4_/zafj4_e1jimgrfxs-otfqhxl3mo.png"><br><br>  And two seconds before this, the file 21DA.tmp is created: <br><img src="https://habrastorage.org/webt/zn/ob/gh/znobghmvi4qg-jq9khw8sljyxmq.png"><br><br>  If we look for its checksum, for example, on VirusTotal, then we will get quite interesting results: <br><br><img src="https://habrastorage.org/webt/5e/0-/v0/5e0-v0_eiyq6dp_ot2rse2itxya.png"><br><br>  Obviously, our RAT was unpacked from this file.  Go ahead: <br><img src="https://habrastorage.org/webt/y5/xu/vi/y5xuvifv2vlfuvev_6h16ohtqs8.png"><br><br>  Even earlier, the LocalDataNT directory is created with quite interesting files inside.  Take, for example, WinPrintSvc.exe: <br><img src="https://habrastorage.org/webt/hb/it/0h/hbit0hzcud-esfkdiwdu1grngi4.png"><br><br>  <b>Remote Utilities</b> is another remote management tool.  And here is another suspicious file created a few seconds earlier: <br><img src="https://habrastorage.org/webt/ow/y3/si/owy3sixtv7ftlvpp_sw3lj7godo.png"><br><br>  Check his checksum: <br><img src="https://habrastorage.org/webt/vd/ht/va/vdhtvat-yyblyly6cg0of3b_zgk.png"><br><br>  Several anti-virus products will detect it as ‚Äú <b>RemoteAdmin</b> ‚Äù at once.  Apparently, he is the source of Remote Utilities.  Check if the detected RAT was launched.  This time we will use the AmCache.hve registry file from C: \ Windows \ AppCompat \ Programs (the same RegRipper will allow us to get data from it in a digestible form): <br><img src="https://habrastorage.org/webt/tc/c0/vy/tcc0vy_vwhkun69oqfr5cfty8c8.png"><br><br>  As you can see in the illustration, AmCache allows us to get not only the first launch date, but also the checksum of the file. <br><br>  So, we have two RATs, but where did they come from?  Good question!  If you still scroll timeline, then we will see traces of creating a rather suspicious directory and file: <br><img src="https://habrastorage.org/webt/s9/6n/i7/s96ni7n5j69310sfd0rvaaq1rma.png"><br><br>  Despite the strange extension, fnbfdnja.hej has its usual title: <br><img src="https://habrastorage.org/webt/cf/yi/sx/cfyisxf0m50wxzt4agxrwfd1p0w.png"><br><br>  What will the search by checksum on VirusTotal show us?  Here's what: <br><img src="https://habrastorage.org/webt/kt/nh/qf/ktnhqfsyzjuulv_engnh-fuw1pg.png"><br><br>  As you can see in the illustration, some antivirus software detects our file quite definitely - we are dealing with <b>RTM</b> .  VT can help us some more.  If we look at the Relations tab, we see this: <br><img src="https://habrastorage.org/webt/im/ft/ey/imfteyuy9a9mhxfk-hprb0apm34.png"><br><br>  It seems that we have found the culprit of the celebration - this is ‚ÄúDocuments for October.exe‚Äù.  Or maybe not, the name associated with our file is different, even though the checksum is the same.  So, again .exe, which means we need to look for traces of the launch again.  Personally, I really love working with the registry, so again I will use the help of the already known NTUSER.DAT file and RegRipper.  This time we will take a look at <b>UserAssist</b> - from it we will get the names and paths to the files, the dates of their last launch, as well as the number of these launches.  The file ‚ÄúDocuments for October.exe‚Äù is not visible, but another file is visible: <br><br>  C: \ Users \% username% \ Desktop \ Documents environment.exe <br><br>  Great, this looks like what we need.  True, there is a small problem - there is no file in the right place.  Let's go back to the timeline.  After creating the fnbfdnja.hej file, this is what happens: <br><img src="https://habrastorage.org/webt/kv/uq/z3/kvuqz3m_3rkzzhhjjemblduatuc.png"><br><br>  The files in the Temp directory probably belong to RTM, but we are not interested in them.  We are interested in the $ R6K21RQ.exe and $ I6K21RQ.exe files.  This is exactly what the files placed in the ‚ÄúTrash‚Äù look like - the first one contains the data itself, the second - the metadata.  If we look at the contents of $ I6K21RQ.exe, we immediately see the path to the desired file - ‚ÄúDocuments environment.exe‚Äù. <br><br>  It's time to take a look at what VT will offer for its checksum: <br><img src="https://habrastorage.org/webt/gq/2i/kd/gq2ikdu0wi_zq_kf78tvzl6nzrg.png"><br><br>  We see already familiar to us detekty - "RTM".  As it turned out, the checksum of our file coincided with the checksum "Documents for October.exe".  Moreover, VT knows several more files with the same checksum: <br><img src="https://habrastorage.org/webt/sq/1i/af/sq1iaf7zwnjwezruvjvwglfeor0.png"><br><br>  It would be nice to get some network indicators of compromise.  We have no memory dump, network traffic dump too, what to do?  Swap file!  But how to find a needle in a haystack?  And here VT will also help us a little, this time the <b>‚ÄúBehavior‚Äù</b> tab: <br><img src="https://habrastorage.org/webt/4e/ns/ay/4ensayd62o0tyaigs2dgtd5gjba.png"><br><br>  It looks like C2, right?  Let's see if there is anything like this in our paging file (pagefile.sys).  Of course, there are: <br><img src="https://habrastorage.org/webt/xk/o3/zx/xko3zx4wjjhiudwepxxfqzcp7y4.png"><br><br>  So, we confirmed that our file interacted with 185.141.61 [.] 246.  Let's try to find more network indicators.  One of the RATs was TeamViewer, we will try to find something similar to its ID.  For this you can, for example, use regular expressions: <br><img src="https://habrastorage.org/webt/mm/4j/1a/mm4j1a5ydt2iytwbpbzgrk9ml10.png"><br><br>  Great, we have another network indicator - 195.123.219 [.] 87.  Of course, paging files are not only suitable for searching for network indicators.  If we return to the ‚ÄúBehavior‚Äù tab on VT, we will see that our file creates tasks in the scheduler.  If we look for the string ‚Äúfnbfdnja.hej‚Äù, we will find this: <br><img src="https://habrastorage.org/webt/pe/7s/ze/pe7szesg0ty9v-zpsgm7ab7bgxa.png"><br><br>  Created task and runs fnbfdnja.hej through rundll32.exe. <br><br>  Well, it's time to round out.  It's time to determine where all the same file "Documents Environment.exe" came from.  We already know that this is RTM, and since this is RTM, then the most likely infection vector is a phishing email.  In this case, the victim used Microsoft Outlook, so we found the OST file with the mail in the usual place, and in it - the same phishing email: <br><img src="https://habrastorage.org/webt/hw/lp/la/hwlpla4cn3g5er_tdoa5mub7zka.png"><br><br>  However, I want to end our post not on this, but on another interesting artifact.  If we go back to the NTUSER.DAT file and look at the value of the "Shell" parameter in the Software \ Microsoft \ Windows NT \ CurrentVersion \ Winlogon section, then instead of the usual "explorer.exe" we will see this: <br><img src="https://habrastorage.org/webt/mv/z5/vh/mvz5vhgzz_0omh1uasj0adunwv0.png"><br><br>  This means that after the user logs in, instead of launching the "Explorer", the system will be shut down, and with it the article will be completed. </div><p>Source: <a href="https://habr.com/ru/post/449100/">https://habr.com/ru/post/449100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../449094/index.html">Startup Psychology: Transformations That Not All Will Survive</a></li>
<li><a href="../449096/index.html">We expand and supplement Kubernetes (review and video of the report)</a></li>
<li><a href="../449098/index.html">As a ‚Äúspy‚Äù company, it made its way into the Mozilla certificate store and what came of it</a></li>
<li><a href="../4491/index.html">Privacy died in the information age</a></li>
<li><a href="../44910/index.html">Minucion: and happiness seems so close!</a></li>
<li><a href="../449106/index.html">UPS for banking and financial institutions</a></li>
<li><a href="../44911/index.html">Zend Framework 1.7.0</a></li>
<li><a href="../449110/index.html">Fixed a bug related to the inability to use Cyrillic in IMAP folder names</a></li>
<li><a href="../449112/index.html">Retired - we are discussing once popular audio gadgets that are already ‚Äúout of date‚Äù</a></li>
<li><a href="../449114/index.html">React on Œªambda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>