<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authentication of GNU / Linux file servers in an AD-based Windows domain. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Samba authentication in a Windows domain 

 1. Introduction. Review of existing publications 
 Recently, system administrators are faced with the task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authentication of GNU / Linux file servers in an AD-based Windows domain. Part 1</h1><div class="post__text post__text-html js-mediator-article"><h4>  Samba authentication in a Windows domain </h4><br><br><a name="habracut"></a><h5>  1. Introduction.  Review of existing publications </h5><br>  Recently, system administrators are faced with the task of uniting heterogeneous operating systems in an enterprise network.  In particular, one of the problems is the use of GNU / Linux servers in conjunction with workstations and servers running Windows of different versions. <br>  Typically, a small business network includes about 20-30 workstations running Windows 7, a domain controller based on Windows Server 2008 R2, a router and several specialized servers.  Next, we will consider the inclusion of such servers based on GNU / Linux in the Windows Server 2008 R2 domain and the procedure for working with such servers. <br>  As the first task, let's consider the organization of the Samba file server in the Windows Server 2008 R2 domain.  The problem of creating file servers based on Samba is the subject of many articles and publications in various forums.  As an example, the documentation on Samba, published on the official website of the project <a href="http://www.samba.org/samba/docs">www.samba.org/samba/docs</a> .  Here are a variety of materials, starting with the second edition of the famous book ‚ÄúUsing Samba‚Äù written by Jay Ts, Robert Eckstein and David Collier-Brown and published by O'Reilly &amp; Associates.  The third edition of this book, which was published in 2007, is not yet available on the site.  Of note is the excellent set of HOWTO guides and configuration examples presented on the site. <br>  A considerable amount of additional information on the work of Samba can be obtained on the websites of manufacturers of major Linux distributions. <br>  It is worth noting various author materials published in online and print publications;  for example, the article by Alexander Farkhutdinov in the Linux Format magazine (http://wiki.linuxformat.ru/index.php/LXF123:Samba), the blog of the experiment lover (http://www.k-max.name/) and a number of articles on such well-known resources like <a href="http://www.opennet.ru/">www.opennet.ru</a> and <a href="http://habrahabr.ru/">habrahabr.ru</a> .  Readers can see this for themselves by searching for the phrase ‚ÄúEnabling samba in the Windows domain‚Äù or ‚ÄúEnabling Linux in the Windows domain‚Äù and eventually receiving tens and hundreds of thousands of links. <br>  The purpose of this article is not only to give specific recommendations on the inclusion of GNU / Linux servers in the Windows domain structure, but also to consider the operation of a test network that emulates a small enterprise network.  We will try to consider most aspects of work in such a network and make recommendations on how to organize the interaction of all its elements. <br><br><h5>  2. Description of test network, Windows domain </h5><br>  To organize a test network, we will use the VMware VSphere 5 virtual environment, which is based on the ESXi hypervisor architecture.  However, one could use the well-proven Microsoft Hyper-V, as well as any other similar solution. <br>  The test environment is an Active Directory-based domain network (Active Directory Domain Services - AD DS), which consists of two infrastructure servers running MS Windows Server 2008 R2 EE and one client machine ‚Äî MS Windows 7 Professional.  IP addresses from subnet 192.168.7.0/24 are used 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/d80/fab/1f7/d80fab1f794f46fb87e21a08cfac39ab.jpg"><br><br>  Domain Name - LAB.LOCAL Domain Controller - LAB-DC1.lab.local Forefront Threat Management Gateway (TMG) 2010 Server - LAB-TMG.lab.local Client - LAB-CL1 .lab.local <br>  Roles installed on LAB-DC1 <br><ul><li>  Active Directory Certificate Services (AD CS) </li><li>  Active Directory Domain Services (AD DS) </li><li>  DHCP server (Scope name: LAB.LOCAL; Address pool: 192.168.7.20-192.168.7.70) </li><li>  DNS server (Type: AD-Integrated; Dynamic updates: Secure only) </li><li>  Web Services (IIS) </li></ul><br><br>  <i>Note</i> <i><br></i>  <i>Installation of AD DS Domain Service is performed in accordance with the recommendations set forth in the article <a href="http://technet.microsoft.com/en-us/library/dd378801">technet.microsoft.com/en-us/library/dd378801</a> (v = ws.10) .aspx</i> <br><br><h5>  3. Windows Domain Authorization Mechanisms </h5><br><br><img src="https://habrastorage.org/storage2/a3f/e59/49c/a3fe5949c638d02cb3c5996ab9ee111b.jpg"><br><br>  An extremely important part of the SMB protocol are authentication methods.  Their incompatibility on the client and server sides causes a significant number of network access problems.  There are four basic authentication methods. <br>  Source - <a href="http://wiki.linuxformat.ru/index.php/LXF123">wiki.linuxformat.ru/index.php/LXF123</a> : Samba <br><br>  <b>Open text</b> <br>  For obvious reasons, this authentication method is both the easiest and most unreliable.  This authentication was used by older versions of Samba.  In the current version, the password is encrypted by default.  To disable encryption, you must change the value of the encrypted password parameter in the smb.conf file to false.  This method was also used in MS DOS clients as well as in older versions of Windows NT.  Already in Windows 95 (and newer versions) to activate it, you must edit the registry.  For Windows 2000 and above, it is possible to enable this authentication method through local security policies.  To do this, set the value ‚ÄúYes‚Äù of the ‚ÄúSend unencrypted password to third-party SMB servers‚Äù switch.  Note once again: the use of this method today is not justified by anything and is highly discouraged. <br><br>  <b>LM method (LAN manager)</b> <br>  Used in Windows 95/98.  Samba defaults to LM authentication.  If you experience problems with access to resources running Windows NT 4.0 and above, you need to adjust the local security policies on the Windows server ‚Äî set the ‚ÄúLAN Manager authentication level‚Äù switch to ‚ÄúSend LM and NTLM responses‚Äù. <br><br>  <b>NTLM method</b> <br>  Appeared in Windows NT 3.5.  Currently used in a slightly revised and improved form - NTLMv2.  NTLMv2 works according to the "request-response" scheme.  An interesting feature of this method is that the server does not store the password not only in the open, but also in the encrypted form.  Only its hash is stored, but it is not transmitted over the network either, which is very good from a security point of view. <br>  Windows 95/98 can work with NTLMv2 after installing the Directory Services client.  Samba also supports this authentication method. <br><br>  <b>Using the Kerberos service</b> <br><br>  Kerberos is a powerful system that performs user authentication and authorization, which is used in the Active Directory (AD) domain as the main one.  It also provides encryption for intranet traffic.  The Kerberos protocol offers a mechanism for mutual authentication of the client and the server before establishing a connection between them, and the protocol takes into account the fact that the initial exchange of information between the client and the server occurs in an unprotected environment, and transmitted packets can be intercepted and modified.  In other words, the protocol is ideal for use on the Internet and similar networks.  Starting with the third version, Samba can be a full-fledged client of the Active Directory domain. <br>  We will pay special attention to this method, since our article is dedicated to integrating a Samba server on Linux into an AD domain, which means you need to work with Kerberos. <br>  In Windows Server 2008 R2, the Key Distribution Center (KDC) is implemented as a domain service.  It uses Active Directory as the account database.  In addition, some user data comes into it from the global catalog (Global Catalog). <br>  The KDC, like the Active Directory directory service, is in every domain.  Both services are automatically started by the LSA subsystem (Local Security Authority), which is installed on the domain controller.  They work in the process space of this manager.  None of these services can be stopped.  To ensure constant access to the KDC and Active Directory, Windows provides the ability to deploy multiple peer domain controllers in each domain.  At the same time, requests for authentication and ticket issuance addressed to the domain‚Äôs KDC service can be received by any domain controller. <br>  The KDC (Key Distribution Service) is a single process that combines two services: the Authentication Service Authentication Service (AS) and the Ticket-Granting Service (TGS).  In general terms, the process is as follows: <br>  When entering the network, the client contacts the authentication service of the domain where the user account is located, providing her with a username and password.  In response, the client issues a TGT ticket - Ticket-Granting Ticket, of course, if the login and password are correct.  After this, the TGS comes into play.  This service issues tickets for access to other services of your domain or to the service of issuing tickets to a trusted domain.  To contact the TGS service, the customer first needs to get in touch with the ticket issuing service of the domain where the service account is located, submit their TGT ticket and request the right ticket.  If the client does not have a TGT ticket that allows access to this ticket issuing service, he can use the referral process.  The starting point of this process is the service of the domain where the user account is located, and the final point is the ticket issuing service of the domain where the account of the required service is located. <br>  In many sources, tickets are called ‚Äútickets‚Äù, ‚Äúreceipts‚Äù and even ‚Äúmandates‚Äù.  But the meaning does not change; this is a ‚Äúdocument‚Äù confirming the right to use the service. <br>  In a Windows environment, Kerberos policy is defined at the domain level and is implemented by the KDC domain service.  It is stored in the Active Directory as a subset of domain security policy attributes.  By default, only members of the domain administrators group have the right to make changes to the Kerberos policy. <br>  Kerberos policy provides for: <br>  <i>The maximum validity of the user ticket (Maximum user ticket lifetime).</i>  By ‚Äúuser ticket‚Äù here is meant a ticket issuance ticket (TGT ticket).  The value is set in hours and the default is 10 hours. <br>  <i>The maximum time during which a user ticket can be renewed (Maximum lifetime that user ticket can be renewed).</i>  Set in a day;  default is 7 days. <br>  <i>Maximum service ticket lifetime.</i>  By "service ticket" here is meant a session ticket.  The value of this parameter must be more than 10 minutes, but less than the value of the Maximum user ticket lifetime.  The default is 10 hours. <br>  <i>Maximum tolerance in computer clock synchronization (Maximum tolerance for synchronization of computer clocks).</i>  Indicated in minutes;  default is 5 min. <br><br>  Enforce user logon restrictions check.  If this item is checked, the KDC service analyzes each request for a session ticket and checks whether the user has the right to log on locally (Log on Locally privilege) or access the requested computer through the network (Access this computer from network privilege).  Such verification takes additional time and may slow down the provision of network services, so the administrator is entitled to disable it.  By default, it is enabled. <br>  Immediately it is worth mentioning several pitfalls that can be encountered.  First of all, the discrepancy between the hours on the client and server side should be no more than a few minutes (by default, as mentioned above, no more than five), otherwise the server will recognize the client's receipt as invalid and deny it access.  In this case, the message ‚ÄúAccess denied‚Äù will be displayed on the client‚Äôs Windows machine immediately, or Windows will ask the login-password time after time without any visible result.  Secondly, it should be remembered that the core of Active Directory is four technologies: DNS, LDAP, SMB, and Kerberos.  All of them work within the domain, but each of them can be addressed as an independent service.  Despite such independence of services, the incorrect work of at least one of them will make the inclusion of a client in the domain impossible.  Special attention should be paid to the fact that if on the client side the DNS server, client name or domain name are incorrectly specified, then it will not be included in the AD domain.  The reason for this is the fact that the DNS server in the Active Directory domain stores SRV records indicating the location of the KDC and LDAP servers. <br><br><h5>  4. Required GNU / Linux Packages </h5><br>  All the packages listed below are needed to deploy OpenLDAP, Kerberos and Samba on a server running Ubuntu Linux 10.04.4 LTS 64 with Xfce graphical shell.  It also provides information on the required pre-installed packages for installation in accordance with the official documentation for OpenLDAP, Kerberos and Samba. <br><br>  The following packages are required to build OpenLDAP: <br><br><ul><li>  C compiler, for example gcc (required) </li><li>  Reentrant POSIX REGEX software (required) </li><li>  Cyrus SASL 2.1.21+ (recommended) </li><li>  OpenSSL 0.9.7+ (recommended) </li></ul><br><br>  Required packages can be installed with the command sudo apt-get install package_name. <br>  Oracle Berkeley DB version 4.4 - 4.8 or 5.0 - 5.1 is also required.  How to build it from source, we‚Äôll tell you a little later when we talk about building OpenLDAP. <br><br>  To build Kerberos, we need the flex and bison packages (sudo apt-get install flex bison), otherwise you will get the error ‚Äúyacc - command not found‚Äù when building.  Then we will need g ++ (sudo apt-get install g ++), because otherwise Kerberos will not build again, saying that ‚Äúg ++ is command not found.‚Äù <br><br>  By the time Samba is built, we should already have OpenLDAP and Kerberos installed, in which case installation of additional packages will not be required. <br>  To install the gcc, g ++, flex, bison packages, you can use the package managers installed on your GNU / Linux distribution.  Usually you just need to mark these packages during the initial installation of the system. <br><h5>  5. Build packages from source. </h5><br>  So, we proceed to the part itself - building packages from sources.  Of course, building from source is not common practice for modern Linux distributions, and is more likely to be of research interest.  We will consider the build from source, as this process is, in general, universal for any Linux distribution.  In the future we will work with repositories, which is somewhat simpler. <br>  OpenLDAP Build <br>  First, from the Oracle site, download the Berkeley DB source files (hereinafter referred to as BDB) from the Oracle site.  <a href="http://www.oracle.com/technetwork/database/berkeleydb/downloads/index-082944.html">www.oracle.com/technetwork/database/berkeleydb/downloads/index-082944.html</a> In our case, everything <a href="http://www.oracle.com/technetwork/database/berkeleydb/downloads/index-082944.html">worked</a> out with BDB 4.8 <br>  Compile and install BDB: <br><pre><code class="bash hljs">tar xvzf db-4.8.30.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> db-4.8.30/build_unix ../dist/configure <span class="hljs-comment"><span class="hljs-comment">#    - /configure --help make sudo make install</span></span></code> </pre> <br>  Download OpenLDAP source code <a href="http://www.openldap.org/software/download/">www.openldap.org/software/download</a> <br>  In our case, it was version 2.4.30. <br>  Compile and install OpenLDAP: <br><pre> <code class="bash hljs">tar -xzvf openldap-2.4.30.tgz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> openldap <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CPPFLAGS=<span class="hljs-string"><span class="hljs-string">"-I/usr/local/BerkeleyDB.4.8/include -D_GNU_SOURCE"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-L/usr/local/BerkeleyDB.4.8/lib"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LD_LIBRARY_PATH=<span class="hljs-string"><span class="hljs-string">"/db-4.8.30.NC/build_unix/.libs/"</span></span> ./configure --with-tls=no <span class="hljs-comment"><span class="hljs-comment">#      ‚Äî ./configure --help make depend make make test #    OpenLDAP.    ,    . make install</span></span></code> </pre><br><br>  That's all with OpenLDAP.  Finally I would like to mention a few of the most common mistakes: <br>  configure: error: Berkeley DB version mismatch Solution: most likely you did not export the LDFLAGS and LD_LIBRARY_PATH variables, as mentioned above. <br>  getpeereid.c: 52: error: storage size of 'peercred' is not known You most likely forgot about the -D_GNU_SOURCE flag, which is needed to bypass incompatibility with glibc. <br>  And once again carefully check all whether the necessary packages are installed on your system. <br>  Kerberos build <br><br>  Download Kerberos <a href="http://web.mit.edu/kerberos/dist/index.html">web.mit.edu/kerberos/dist/index.html</a> We used current release. <br>  After that, unpack, build and install the program: <br><br>  t <pre> <code class="bash hljs">ar -xzvf krb5-1.10.1.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /krb5-1.10.1/src ./configure --with-ldap=yes <span class="hljs-comment"><span class="hljs-comment">#,  ,  .  ‚Äî    ./configure ‚Äî-help. make make install make check #   .</span></span></code> </pre><br>  If you get the error ‚Äúyacc - command not found‚Äù, it means that you forgot to install the flex and bison packages. <br>  sudo apt-get install flex bison <br>  If ‚Äúg ++ - command not found‚Äù, then forgot about the g ++ compiler. <br><pre> <code class="bash hljs">sudo apt-get install g++</code> </pre><br>  Build samba <br>  Download the Samba source from <a href="http://www.samba.org/samba/download/">www.samba.org/samba/download</a> .  We need the latest version, so download samba-latest.tar.gz. <br>  Unzip, build and install Samba: <br><br><pre> <code class="bash hljs">tar -xzvf samba-latest.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> samba-3.6.3 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> source3 ./configure --with-ldap=yes --with-ads=yes make make install</code> </pre><br>  Most likely, if all the previous steps were completed correctly, the assembly and installation of Samba will take place without problems.  If not, first check if all the dependencies are installed correctly.  If Samba misses something, it will make it very clear. <br>  Of course, assembling all the packages from source texts is a time consuming procedure with low efficiency.  Therefore, it is best to install the required packages using the package manager of your GNU / Linux distribution. <br>  So, all the packages are installed and it's time to move on to the configuration. </div><p>Source: <a href="https://habr.com/ru/post/143187/">https://habr.com/ru/post/143187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143179/index.html">How to improve site performance or 5 reasons to start using Google Analytics</a></li>
<li><a href="../143180/index.html">Monetizing Google Play: free games with access to operator billing</a></li>
<li><a href="../143181/index.html">New look at CodePlex</a></li>
<li><a href="../143184/index.html">Shutdown Day 2012</a></li>
<li><a href="../143185/index.html">Apple rejects any applications that use Dropbox</a></li>
<li><a href="../143188/index.html">How to properly sort content based on user ratings</a></li>
<li><a href="../143189/index.html">Will the interface Cascades in Blackberry 10?</a></li>
<li><a href="../143190/index.html">Authentication of GNU / Linux file servers in an AD-based Windows domain. Part 2</a></li>
<li><a href="../143191/index.html">RIM offers developers $ 10,000 guaranteed income for applications for its platform</a></li>
<li><a href="../143193/index.html">Digest of new materials in Russian TechNet for April</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>