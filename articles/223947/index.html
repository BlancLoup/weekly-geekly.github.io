<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32 and LCD via I2C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For use in the future, it was necessary to connect using an I2C STM32 microcontroller with a 2004 screen. Having not found a similar solution on the n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32 and LCD via I2C</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/5ee/a04/f86/5eea04f86878745e07c34c5a0710c0c6.jpg"><br>  For use in the future, it was necessary to connect using an I2C STM32 microcontroller with a 2004 screen. Having not found a similar solution on the network, I publish it here.  This recipe is also suitable for screens 1602. Further under the cut.  (Caution, pictures). <br><a name="habracut"></a><br>  The toy ticket office, bought by the son, turned out to be defective, and worked through time.  An idea appeared to remake its insides, and the moment of the choice of the microcontroller coincided with the publication of the <a href="http://geektimes.ru/users/raja/" class="user_link">RaJa</a> article about STM32 [ <a href="https://habr.com/ru/post/223947/">1</a> ].  Having estimated a bit and comparing the prices: STM32 + LCD2004 + I2C = ArduinoMega (the reason was that it was necessary to realize a keyboard, a speaker, a barcode input device and a screen, so each output of the microcontroller is on the account) I selected the first set. <br><br>  Purchases were made, and it was time to wait.  For the firmware I bought another USB-USART adapter. <br><div class="spoiler">  <b class="spoiler_title">What and where to buy.</b> <div class="spoiler_text"><ol><li>  <a href="http://www.ebay.com/itm/371036921289">STM32F103C8T6</a> </li><li>  <a href="http://www.ebay.com/itm/400448319287">2004 LCD HD44780</a> .  Turned out without Cyrillic.  Pay attention to this feature when searching, if you need the Russian language on the screen. </li><li>  <a href="http://www.ebay.com/itm/310565362720">IIC / I2C / TWI / SP I Serial Interface Board Port Arduino 1602LCD Display Module For the</a> description compatible with 2004. But I think any similar one will do. </li><li>  <a href="http://www.ebay.com/itm/181202034360">USB to UART TTL CP2012</a> for firmware and debugging.  You can use other supported methods of firmware and debugging, but this option is the cheapest. </li></ol><br></div></div><br>  Tools for programming, firmware and debugging used by me: <br><ol><li>  <a href="http://ravenium.ru/emblocks-ide/">EmBlocks</a> . </li><li>  Flash driver from original site: <a href="http://www.st.com/web/en/catalog/tools/PF257525">STM32 and STM8 Flash loader demonstrator</a> . </li><li>  Terminal for reading signals from MK via USB2UART: <a href="https://sites.google.com/site/terminalbpp/">Terminal v1.91b</a> .  But Putty (Connection-&gt; Serial) will do. </li></ol><br>  After receiving the microcontroller I tried to play with the LEDs, it turned out.  And then there were several hours of trying to link the screen with the MK.  It‚Äôs boring to describe all this, I‚Äôll try to remember the rake I ran into. <br><br>  The first will describe the connection.  Strange, describing the use of STM32 in few places draw diagrams, mostly code, guess what and how to connect. <br>  Connect the image in the photo (by clicking - larger). <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f16/2c9/f46/f162c9f46347ed9d2e12b31b20a919e1.jpg"></a> <br>  This connection is relevant for STM32F103C8.  For other MK boards, check the connection pins of I2C1 by datasheet. <br>  USART adapter to USB.  This is understandable.  Next - connect the USART to the STM32 derived from the miniUSB USART1 connector.  TX to RX and respectively RX to TX.  I have a 3v3 output on USART, I powered the MK from it.  I connected the earth separately, for its convenient disconnection during the switching of the firmware modes and operation.  I soldered the I2C to the screen (also on ebay there are screens with soldered I2C).  Power for I2C and the screen is taken from 3v3 MK or 5V from USART.  Below I wrote about the setting of contrast at different voltage supply.  Next: SCL from I2C connects to PB6, SDA from I2C to PB7.  Attracting SCL and SDA to power when using this device alone is not necessary. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first rake was USART.  I used it for debugging, in the code here, lines of work with it are commented out.  But he did not solve the problem.  It seems that there is no synchronization between the computer and the microcontroller before sending the first character.  And if you use the code from the example [ <a href="https://habr.com/ru/post/223947/">4</a> ] - then MK perfectly duplicates the resulting text, but it cannot write.  I achieved the most appropriate debugging output for the lines by adding a delay (500) after each character. <br><br>  Then he tried to implement the work with I2C.  I took the code from the example [ <a href="https://habr.com/ru/post/223947/">3</a> ], drew attention to the comments about the hanging of the MK, after analyzing the sources, I saw that, like the comment author, I need to shift the device address to the left: <br><br><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/microtechnics.ru/stm</span></span>32-ispolzovanie-i2c/<span class="hljs-comment"><span class="hljs-comment">#comment-8109 I2C_Send7bitAddress(I2Cx, slaveAddress&lt;&lt;1, transmissionDirection);</span></span></code> </pre> <br>  Pasted the code and tried to run.  The program hung at the time of waiting for the release of the bus: <br><br><pre> <code class="hljs lisp">while(!I2C_CheckEvent(<span class="hljs-name"><span class="hljs-name">I2Cx</span></span>, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  Here a rake in the device I2C address.  Judging from the description of the seller, I had the address 0x20.  Here I lost 15 minutes for nothing, but after reading the description of different models of I2C adapters, the link [ <a href="https://habr.com/ru/post/223947/">6</a> ] to which I brought in my article [ <a href="https://habr.com/ru/post/223947/">5</a> ] <a href="http://geektimes.ru/users/romanvl/" class="user_link">romanvl</a> , I paid attention to the latest model and tried to change the address to 0x27.  It all worked.  The conclusion is this: if you have sealed on the adapter A0 A1 A2 - address 0x20, not sealed - 0x27. <br>  Compare: <br><table><tbody><tr><td><img src="//habrastorage.org/files/573/da6/7a5/573da67a5cff4350bc14182ebad1eb95.jpg"></td><td><img src="//habrastorage.org/files/cd4/d60/f8c/cd4d60f8c0be4a8791a04ad9ab16f0f8.jpg"></td></tr></tbody></table><br>  Next - the screen.  It turned out that it works perfectly from 3.3 volts, as well as the I2C adapter (in the <a href="http://www.nxp.com/documents/data_sheet/PCF8574.pdf">adapter's</a> datasheet, from 2.5 to 6 V).  But first I checked it from 5B.  And the contrast was twisted to the maximum.  As a result, as a result of the launch of the program, the screen was completely full.  I was upset and continued to pick the code.  But after half an hour I woke up and the culprit ran up, I showed him the screen and accidentally saw at an angle from the side that something was written there.  The reason for this is the wrong contrast adjustment.  (Sorry if I described the obvious things here, maybe there are those who did not know this.) <br><img src="//habrastorage.org/files/a44/96d/60b/a4496d60bf15471bb8532ee5bb8b8363.JPG">  I can not see anything <br><img src="//habrastorage.org/files/831/6dd/65f/8316dd65fc484fd48d2f599c5d010520.JPG">  Same but angled <br><br>  At 5V power supply, the contrast should be slightly reduced.  And at 3.3V, put on a maximum, nothing is visible on the setting from 5V.  The result is shown in the first picture in the post.  My turned out to be without the Russian language, I saw it, scrolling through the characters.  I tried to draw a blot, not knowing that the maximum you can define 8 of your characters, wrote for blot 12. I picked up similar ones from Chinese, it seemed to work out. <br><img src="//habrastorage.org/files/8d4/092/159/8d40921593d4477cab9a78e3cac91817.jpg"><br>  The code is presented on the Gihab, since to achieve the result I rewrote the library from Arduin: <a href="https://github.com/Vendict/STM32_LCD_I2C">STM32_LCD_I2C</a> . <br><br>  Used materials: <br><ol><li><a name="stm32vs"></a>  The reason for choosing a microcontroller: <a href="http://habrahabr.ru/post/191054/">STM32 vs Arduino</a> . </li><li>  From here, took the implementation of the Delay: <a href="http://we.easyelectronics.ru/STM32/stm32-i2c-eeprom-24sxx.html">STM32 I2C EEPROM 24CXX</a> . </li><li><a name="i2c"></a>  Article about I2C <a href="http://microtechnics.ru/stm32-ispolzovanie-i2c/">STM32.</a>  <a href="http://microtechnics.ru/stm32-ispolzovanie-i2c/">Using I2C.</a>  <a href="http://microtechnics.ru/stm32-ispolzovanie-i2c/">microtechnics.ru/stm32-ispolzovanie-i2c</a> .  Immediately <a href="http://microtechnics.ru/stm32-ispolzovanie-i2c/">comment</a> about the shift, without which I would probably just catch a rake as discussing. </li><li><a name="usart"></a>  An example of working with the USART <a href="http://chipspace.ru/stm32-usart-4/">STM32.</a>  <a href="http://chipspace.ru/stm32-usart-4/">Usart</a>  <a href="http://chipspace.ru/stm32-usart-4/">Part 4 - Final</a> . </li><li><a name="ari2c"></a>  <a href="http://habrahabr.ru/post/219137/">Reduce the number of wires in the Arduino - I2C LCD screen and RTC clock on two wires</a> . </li><li><a name="lcdblue"></a>  <a href="http://arduino-info.wikispaces.com/LCD-Blue-I2C">LCD Displays (Blue and YELLOW) with I2C / TWI Interface</a> . </li><li>  To understand the logic of the STM32 with external devices <a href="http://we.easyelectronics.ru/STM32/rukovodstvo-k-bystromu-startu-po-rabote-s-periferiey-stm32f10x.html">Quick Start Guide for working with STM32F10x peripherals</a> . </li></ol><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/223947/">https://habr.com/ru/post/223947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223935/index.html">[POLL] Which OS would you like to use for developing for Tizen?</a></li>
<li><a href="../223937/index.html">4 Apple Design Myths from Former Apple Designer</a></li>
<li><a href="../223939/index.html">The penetration testing lab ‚ÄúOne Step Ahead‚Äù is open</a></li>
<li><a href="../223941/index.html">4Blend HDR, the path to success: from winning the Nokia Developer competition to popularity in the Windows Store</a></li>
<li><a href="../223945/index.html">LinkMeUp. Issue number 15. Guest from Canada</a></li>
<li><a href="../223949/index.html">Android development application for working with OBDII protocol</a></li>
<li><a href="../223953/index.html">Ancient philosophers and modern scientists</a></li>
<li><a href="../223955/index.html">Li-Ion Battery Operation</a></li>
<li><a href="../223957/index.html">What language can you learn by asking questions to the search engine? Yandex Workshop</a></li>
<li><a href="../223961/index.html">Steam Protocol 2 and Steam Files - Introduction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>