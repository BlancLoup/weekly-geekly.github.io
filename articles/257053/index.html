<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The progress of the heavy task in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It happened to me to somehow deal with a heavy PHP script. It was necessary to somehow display in the browser the progress of the task at the time, wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The progress of the heavy task in PHP</h1><div class="post__text post__text-html js-mediator-article">  It happened to me to somehow deal with a heavy PHP script.  It was necessary to somehow display in the browser the progress of the task at the time, while in a sufficiently long cycle on the PHP side calculations were performed.  In such cases, they usually resort to occasional line breaks like this: <br><br><pre><code class="javascript hljs">&lt;script&gt;<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'progress'</span></span>).style.width = <span class="hljs-string"><span class="hljs-string">'1%'</span></span>;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  This option did not suit me for several reasons, besides, I basically do not like this approach. <br><a name="habracut"></a><br>  I had about 3000-5000 iterations.  I figured that the traffic is too big for such a simple undertaking.  In addition, this option seemed to me very ugly from a technical point of view, and the appearance of the page was completely ugly: the footer would not come soon - after the last notification of the 100% completion of the task. <br><br>  Dodging the problem of an ugly page was not a big deal, but the remaining drawbacks made me glad and start searching for a more elegant solution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some leading questions.  Are asynchronous HTTP requests possible?  - Yes.  Is it possible to report using a single byte that a part of a large task has been completed?  - Yes.  Can we gradually (consistently) receive and process data using <code>XMLHttpRequest.onreadystatechange</code> ?  - Yes.  We can even use HTTP headers to send a pre-notification of the total duration of the task being performed (if this is possible in principle). <br><br>  The solution is simple.  The founded page is the control panel.  With the remote, you can start and stop the task.  This page initiates XMLHttpRequest - starts the execution of the main task.  In the process of performing this task (inside the main loop), the script sends the client one byte - a space character.  On the console in the <code>onreadystatechange</code> handler <code>onreadystatechange</code> we, by getting byte by byte, will be able to conclude about the progress of the task. <br><br>  The scheme is as follows.  Operation script: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">50</span></span>; $i++) <span class="hljs-comment"><span class="hljs-comment">// ,    50 { sleep(1); //   echo ' '; }</span></span></code> </pre><br>  <code>XMLHttpRequest.onreadystatechange</code> handler: <br><br><pre> <code class="javascript hljs">xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progress = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText.length; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'progress'</span></span>).style.width = progress + <span class="hljs-string"><span class="hljs-string">'%'</span></span>; } };</code> </pre><br>  However, there are only 50 iterations. We know about this because we ourselves have determined their number in the script file.  And if we do not know, or the amount can vary?  With <code>readyState == 2</code> we can get information from the headers.  Let's take this and use to determine the number of iterations: <br><br><pre> <code class="php hljs">header(<span class="hljs-string"><span class="hljs-string">'X-Progress-Max: 50'</span></span>);</code> </pre><br>  And on the remote get and remember this value: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progressMax = <span class="hljs-number"><span class="hljs-number">100</span></span>; xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">2</span></span>) { progressMax = +<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'X-Progress-Max'</span></span>) || progressMax; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progress = <span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText.length / progressMax; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'progress'</span></span>).style.width = progress + <span class="hljs-string"><span class="hljs-string">'%'</span></span>; } };</code> </pre><br>  The overall scheme should be clear.  Let's talk now about the pitfalls. <br><br>  First, if the <code>output_buffering</code> option is enabled in PHP, you need to take this into account.  Everything is simple here: if it is enabled, then when the script is run <code>ob_get_level()</code> will be greater than 0. It is necessary to bypass buffering.  Also, if you use the Nginx FastCGI PHP bundle, you need to consider that both FastCGI and Nginx itself will buffer the output.  The latter will do this if it is going to compress the data for sending.  The problem is solved simply: <br><br><pre> <code class="php hljs">header(<span class="hljs-string"><span class="hljs-string">'Content-Encoding: none'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  If the problem with gzip can be solved inside the PHP script itself, then you can force FastCGI to transfer data immediately by correcting the server configuration: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">fastcgi_keep_conn</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre><br>  In addition, either Nginx, or FastCGI, or Chrome itself consider that initiating the reception and transmission of the response body, which contains only one byte, is too wasteful.  Therefore, you need to precede the entire operation with additional bytes.  We need to agree, let's say that the first 20 spaces should not mean anything at all.  On the PHP side, they just need to be spat out into the output, but in the <code>onreadystatechange</code> handler <code>onreadystatechange</code> they need to be ignored.  In my opinion, since the entire configuration component is transmitted in the headers, then this number of ignored spaces is also better to be conveyed in the header.  Let's call it <em>padding</em> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">'X-Progress-Padding: 20'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> str_repeat(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); flush(); <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre><br>  On the client side, this also needs to be taken into account: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progressMax = <span class="hljs-number"><span class="hljs-number">100</span></span>, progressPadding = <span class="hljs-number"><span class="hljs-number">0</span></span>; xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">2</span></span>) { progressMax = +<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'X-Progress-Max'</span></span>) || progressMax; progressPadding = +<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'X-Progress-Padding'</span></span>) || progressPadding; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> progress = <span class="hljs-number"><span class="hljs-number">100</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText.length - progressPadding) / progressMax; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'progress'</span></span>).style.width = progress + <span class="hljs-string"><span class="hljs-string">'%'</span></span>; } };</code> </pre><br>  Where does the number 20 come from?  If you tell me - I will be very grateful.  I installed it experimentally. <br><br>  By the way, about setting PHP <code>output_buffering</code> .  If you have complex buffering and you do not want to break it, you can use this function: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ob_ignore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $flush = false)</span></span></span><span class="hljs-function"> </span></span>{ $ob = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ob_get_level()) { array_unshift($ob, ob_get_contents()); ob_end_clean(); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($flush) flush(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($ob <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $ob_data) { ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $ob_data; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count($ob); }</code> </pre><br>  With it, you can bypass all levels of buffering, output data directly, after which all buffers are restored. <br><br>  By the way, why is the space used to notify you about the completed part of the task?  Simply because almost any format of data presentation on the web cannot be spoiled by such spaces.  You can apply this method of sending a notification of the progress of an operation, and after all this, display a report on the results in JSON. <br><br>  If you put everything in order, slightly optimize and supplement the code with all the features that can be useful, you will get this: <br><br><div class="spoiler">  <b class="spoiler_title">progress-loader.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProgressLoader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, callbacks</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _this = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> callbacks) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> callbacks[k] != <span class="hljs-string"><span class="hljs-string">'function'</span></span>) callbacks[k] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> k; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getXHR</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Msxml2.XMLHTTP"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Microsoft.XMLHTTP"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (E) { xhr = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xhr &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> XMLHttpRequest != <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xhr; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xhr = getXHR(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contentLoading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, progressPadding = <span class="hljs-number"><span class="hljs-number">0</span></span>, progressMax = <span class="hljs-number"><span class="hljs-number">-1</span></span>, progress = <span class="hljs-number"><span class="hljs-number">0</span></span>, progressPerc = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">2</span></span>) { contentLoading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; progressPadding = +<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'X-Progress-Padding'</span></span>) || progressPadding; progressMax = +<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getResponseHeader(<span class="hljs-string"><span class="hljs-string">'X-Progress-Max'</span></span>) || progressMax; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callbacks.start) callbacks.start.call(_this, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.readyState == <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!contentLoading) contentLoading = !!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText .replace(<span class="hljs-regexp"><span class="hljs-regexp">/^\s+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">// .trimLeft() ‚Äî  _ if (!contentLoading) { progress = this.responseText.length - progressPadding; progressPerc = progressMax &gt; 0 ? progress / progressMax : -1; if (callbacks.progress) { callbacks.progress.call(_this, this.status, progress, progressPerc, progressMax ); } } else if (callbacks.loading) callbacks.loading.call(_this, this.status, this.responseText); } else if (this.readyState == 4) { if (callbacks.end) callbacks.end.call(_this, this.status, this.responseText); } }; if (callbacks.abort) this.xhr.onabort = callbacks.abort; this.xhr.send(null); this.abort = function() { return this.xhr.abort(); }; this.getProgress = function() { return progress; }; this.getProgressMax = function() { return progressMax; }; this.getProgressPerc = function() { return progressPerc; }; return this; }</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">process.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ob_ignore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data, $flush = false)</span></span></span><span class="hljs-function"> </span></span>{ $ob = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ob_get_level()) { array_unshift($ob, ob_get_contents()); ob_end_clean(); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($flush) flush(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($ob <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $ob_data) { ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $ob_data; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count($ob); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($work = @$_GET[<span class="hljs-string"><span class="hljs-string">'work'</span></span>]) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { header(<span class="hljs-string"><span class="hljs-string">"X-Progress-Max: $work"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); header(<span class="hljs-string"><span class="hljs-string">"X-Progress-Padding: 20"</span></span>); ob_ignore(str_repeat(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $work; $i++) { usleep(rand(<span class="hljs-number"><span class="hljs-number">100000</span></span>, <span class="hljs-number"><span class="hljs-number">500000</span></span>)); ob_ignore(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $work.<span class="hljs-string"><span class="hljs-string">' done!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(); }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">launcher.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>ProgressLoader<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"progress-loader.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">progress</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">button</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">: inline-block; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">vertical-align</span></span></span><span class="css">: middle; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0.4em</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">2em</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin-right</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2em</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">progress</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"progressbar"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display: none;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">progress</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span><span class="hljs-tag">&gt;</span></span>Start/Stop<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> progressbar = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'progressbar'</span></span></span><span class="javascript">), btnStart = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'start'</span></span></span><span class="javascript">), worker = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">; btnStart.onclick = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (!worker) { </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> url = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'process.php?work=42'</span></span></span><span class="javascript">; worker = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> ProgressLoader(url, { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">start</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">status</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ progressbar.style.display = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'inline-block'</span></span></span><span class="javascript">; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">progress</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">status, progress, progressPerc, progressMax</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ progressbar.value = +progressbar.max * progressPerc; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">end</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">status, s</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ progressbar.style.display = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'none'</span></span></span><span class="javascript">; worker = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">; }, }); } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { worker.abort(); progressbar.style.display = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'none'</span></span></span><span class="javascript">; worker = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">; } }; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  Instead of introducing before the cut: <i>Please do not kick.</i>  <i>Googling before working on the scheme did not give any sane results, so it was necessary to invent it, which is why I decided to present it in this first publication.</i> </div><p>Source: <a href="https://habr.com/ru/post/257053/">https://habr.com/ru/post/257053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257041/index.html">Implementation of the NEC IR protocol on ATmega</a></li>
<li><a href="../257043/index.html">Yandex vs fraudulent mobile redirects and subscriptions</a></li>
<li><a href="../257047/index.html">How we participated in the opening of the world's largest store of children's toys</a></li>
<li><a href="../257049/index.html">Extend Selenium WebDriver. Writing a robot for the RSDN, not thinking about the context</a></li>
<li><a href="../257051/index.html">Html-maker - convenient and easy generation of html using coffeescript</a></li>
<li><a href="../257055/index.html">SMART Life (cont.)</a></li>
<li><a href="../257057/index.html">Implementing the ws2812b protocol on ATmega</a></li>
<li><a href="../257063/index.html">How Aviasales Material Design Switched</a></li>
<li><a href="../257065/index.html">How we launched the weather probe in the Urals. Part 1</a></li>
<li><a href="../257067/index.html">Chips with subliminal operating supply voltages - a revolutionary approach to reducing current consumption</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>