<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Social network on Android for a few days off - part II (server)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Summary of the first part 
 In response to the incessant boom of mobile social apps, my friends and I decided to get together in a mini hackathon and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Social network on Android for a few days off - part II (server)</h1><div class="post__text post__text-html js-mediator-article"><h3>  Summary of the first part </h3><br>  In response to the incessant boom of mobile social apps, my friends and I decided to get together in a mini hackathon and write another social network on Android in order to outline the range of common issues and offer a skeleton from which everyone can make something new and original.  In the <a href="http://habrahabr.ru/post/258105/">first part,</a> we looked at the client interface, network requests, the friend graph, and image processing. <br>  In this article we will briefly tell you about uploading photos to the cloud storage, delivering push notifications and a queue of asynchronous tasks on the server. <br><a name="habracut"></a><br><h3>  Content </h3><br>  <a href="https://habr.com/ru/post/258111/">Introduction</a> <br>  <a href="https://habr.com/ru/post/258111/">check in</a> <br>  <a href="https://habr.com/ru/post/258111/">Contact Sync</a> <br>  <a href="https://habr.com/ru/post/258111/">Upload photos</a> <br>  <a href="https://habr.com/ru/post/258111/">Push notifications</a> <br>  <a href="https://habr.com/ru/post/258111/">Asynchronous Task Queues</a> <br>  <a href="https://habr.com/ru/post/258111/">Conclusion</a> <br><a name="p1"></a><br><h3>  Introduction </h3><br>  The server part of the application performs the functions of registering users, synchronizing the list of contacts and managing the list of friends, downloading and post-processing photos, managing and issuing comments / likes, sending push notifications.  Consider these questions in more detail. <br><a name="p2"></a><br><h3>  check in </h3><br>  When registering, the user is required to specify the name and phone number, as well as optionally choose an avatar.  Since  identification of users occurs on the contact book, then the important aspect is the verification of the specified phone, so we added <i>SMS verification</i> .  You can choose your service for sending SMS from <a href="http://habrahabr.ru/company/bankfilter/blog/227305/">this article</a> . <br><a name="p3"></a><br><h3>  Contact Sync </h3><br>  To build a graph of friends on the server, the contact lists of users are recorded and compared with the phone numbers of users specified during registration.  All contact lists are stored in a hashed form.  Phone numbers must be given in normal form, which is used by the library <a href="https://github.com/googlei18n/libphonenumber">libphonenumber</a> from Google. <br><br><div class="spoiler">  <b class="spoiler_title">Code 1. An example of normalization in libphonenumber</b> <div class="spoiler_text"><pre><code class="java hljs">String strRawPhone = <span class="hljs-string"><span class="hljs-string">"8-903-1234567"</span></span>; PhoneNumberUtil phoneUtil = PhoneNumberUtil.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PhoneNumber swissNumberProto = phoneUtil.parse(swissNumberStr, <span class="hljs-string"><span class="hljs-string">"RU"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NumberParseException e) { System.err.println(<span class="hljs-string"><span class="hljs-string">"NumberParseException was thrown: "</span></span> + e.toString()); } System.out.println(phoneUtil.format(swissNumberProto, PhoneNumberFormat.E164)); <span class="hljs-comment"><span class="hljs-comment">//: +79031234567</span></span></code> </pre> <br></div></div><br>  It is worth noting one nuance - the country code is defined in ISO-3166 format relative to the user's device, i.e.  even if in my contact book there are phone numbers of other countries, then when these numbers are normalized, it is necessary to use the country code of the ‚Äúregistry‚Äù of my device's SIM card - RU. <br><br>  Comparison of phones occurs in one of two cases: <br><ul><li>  When registering a new user, his phone is compared with existing contact lists. </li><li>  Also, each time the application starts, the contact list is re-sent to the server to identify new contacts. </li></ul><br>  For the described scenario, two tables are created on the server database ‚Äî one for the contact list itself and one for the list of confirmed friends (the graph of friends itself).  This scheme allows you to change existing contacts without breaking the previously formed edges of the graph of friends. <br><div class="spoiler">  <b class="spoiler_title">Code 2. Database schema - contacts and friends</b> <div class="spoiler_text">  db / schema.rb <br><pre> <code class="ruby hljs"> create_table <span class="hljs-string"><span class="hljs-string">"contacts"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">force:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|t|</span></span> t.string <span class="hljs-string"><span class="hljs-string">"public_id"</span></span> t.string <span class="hljs-string"><span class="hljs-string">"contact_key"</span></span> t.datetime <span class="hljs-string"><span class="hljs-string">"created_at"</span></span> t.datetime <span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> create_table <span class="hljs-string"><span class="hljs-string">"friends"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">force:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|t|</span></span> t.string <span class="hljs-string"><span class="hljs-string">"public_id_src"</span></span> t.string <span class="hljs-string"><span class="hljs-string">"public_id_dest"</span></span> t.integer <span class="hljs-string"><span class="hljs-string">"status"</span></span> t.datetime <span class="hljs-string"><span class="hljs-string">"created_at"</span></span> t.datetime <span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> t.string <span class="hljs-string"><span class="hljs-string">"contact_key"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><a name="p4"></a><br><h3>  Upload photos </h3><br>  We chose two options as a photo repository - a free account (free tier) <b>AWS S3</b> as the main server and our own server as a backup (for example, in case the requests are exceeded in the free S3 account). <br><table><tbody><tr><td>  Figure 1. Uploading images on AWS S3 </td></tr><tr><td><img src="https://habrastorage.org/files/246/184/c2f/246184c2fad6483f9eb4bfb0e0c7ea20.png" alt="image"></td></tr></tbody></table><br>  Before downloading, the client requests a temporary public link from the server with write permissions, downloads this link directly to S3, and then reports to the server about the successful download.  We used <b><a href="http://docs.aws.amazon.com/sdkforruby/api/index.html">aws-sdk gem</a></b> to work with AWS S3.  Before work, you must create an account in <i>AWS Web Services</i> (at the time of development it was possible to create a free test account for 5GB and 20,000 requests) and get a pair of <i>ACCESS_KEY / SECRET_ACCESS_KEY keys</i> <br><div class="spoiler">  <b class="spoiler_title">Code 3. Request a public link in aws-sdk</b> <div class="spoiler_text">  lib / s3.rb <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'aws-sdk'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S3Storage</span></span></span><span class="hljs-class"> ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_presigned_url</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Aws::S3::Resource</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">( :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_key_id</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3_access_key_id</span></span></span><span class="hljs-class">'], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">secret_access_key</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3_secret_access_key</span></span></span><span class="hljs-class">'], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3_region</span></span></span><span class="hljs-class">']) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bucket</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3_bucket</span></span></span><span class="hljs-class">']).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s3_prefix</span></span></span><span class="hljs-class">'] + "/" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presigned_url</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">put</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acl</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expires_in</span></span></span><span class="hljs-class">: 3600) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> ...</span></span></code> </pre><br></div></div><br>  After the client reports that the photo has been successfully uploaded, our server downloads it asynchronously, makes two miniatures using <b><a href="https://rubygems.org/gems/rmagick">rmagick gem</a></b> and saves it back to the cloud storage.  Thumbnails are used to facilitate traffic on a mobile device when viewing images in the tape. <br><div class="spoiler">  <b class="spoiler_title">Code 4. An example of creating thumbnails in rmagick</b> <div class="spoiler_text">  lib / uploader.rb <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'aws-sdk'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'open-uri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'s3'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Uploader</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upload</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">img_id</span></span></span><span class="hljs-class">) ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Image</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">img_id</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_original</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Magick::Image</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from_blob</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url_original</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_medium</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_original</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resize_to_fit</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Image::MEDIUM_WIDTH</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">medium_height</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_medium</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath_medium</span></span></span><span class="hljs-class"> ){</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">quality</span></span></span><span class="hljs-class">=100} ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br>  After the uploaded photos are processed, a push notification is sent to all subscribers. <br><a name="p5"></a><br><h3>  Push notifications </h3><br>  When uploading new photos or adding comments, real-time push notifications are sent to the user's subscribers.  The most popular and fairly simple way to deliver push notifications to Android is <b>GCM - Google Cloud Messaging</b> .  Before using the service, you need to register your project in <a href="https://console.developers.google.com/">the developer console</a> , get the <i>API key</i> and the <i>Project Number</i> .  <i>The API key is</i> used to authorize the application server when requesting GCM, it is added to the HTTP request header. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From the client‚Äôs side, the unique identifier of the recipient of notifications is <i>PushID</i> , which is obtained by contacting the Android device directly to the GCM server via the GoogleCloudMessaging SDK from the Android device, and you must specify the <i>ProjectID</i> received earlier.  The received <i>PushID is</i> sent to our application server and is subsequently used in the delivery of notifications. <br><div class="spoiler">  <b class="spoiler_title">Figure 2. The sequence of registration of the new PushID</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/872/96e/955/87296e9557f241f787a838261031f322.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code 5. Example of registering a new PushID (client)</b> <div class="spoiler_text">  class MainActivityHandler <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerPushID</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AsyncTask task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncTask() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object[] params)</span></span></span><span class="hljs-function"> </span></span>{ String strPushID = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gcm == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { gcm = GoogleCloudMessaging.getInstance(activity); } strPushID = gcm.register(Constants.PUSH_SENDER_ID); Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Received push id = "</span></span> + strPushID); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ex) { Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> + ex.getMessage()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strPushID; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object res)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String strPushID = res != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? (String) res : <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!strPushID.isEmpty()) { UserProfile profile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserProfile(); profile.pushid = strPushID; Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Sending pushId "</span></span> + strPushID + <span class="hljs-string"><span class="hljs-string">" to server"</span></span>); ServerInterface.updateProfileRequest(activity, profile, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response.Listener&lt;String&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String response)</span></span></span><span class="hljs-function"> </span></span>{ Photobook.getPreferences().strPushRegID = strPushID; Photobook.getPreferences().savePreferences(); Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Delivered pushId to server"</span></span>); } }, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } }; task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR); }</code> </pre><br></div></div><br>  The connection between the application server and the GCM can be made in two ways - via <b>XMPP</b> and <b>HTTP</b> .  The first option is asynchronous (allows you to send multiple messages without waiting for confirmation of the previous ones), and also supports <i>upstream / downstream</i> two-way communication.  HTTP only supports synchronous <i>downstream</i> requests, but allows sending notifications to several recipients at once. <br><div class="spoiler">  <b class="spoiler_title">Figure 3. The sequence of delivery of push-notifications</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/ad4/4bd/bce/ad44bdbcee5649748a9229ffea9f51c0.png" alt="image"><br></div></div><br><br><table><tbody><tr><td>  Code 6. Example of sending push notifications (HTTP) </td></tr><tr><td>  lib / push.rb <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'net/http'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PushSender</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net::HTTP</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">android</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">googleapis</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">', 80) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Net::HTTP::Post</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">('/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gcm</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">', {'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">' =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">', '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authorization</span></span></span><span class="hljs-class">' =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">=' + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APP_CONFIG</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">google_api_key</span></span></span><span class="hljs-class">']}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = {:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registration_ids</span></span></span><span class="hljs-class"> =&gt; [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pushid</span></span></span><span class="hljs-class">], :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> =&gt; {:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">}} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_json</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></td></tr></tbody></table><br><a name="p6"></a><br><h3>  Asynchronous Task Queues </h3><br>  To speed up interaction with the client, some tasks on the server are performed in the background.  In particular, it is sending push notifications, as well as image scaling.  For such tasks, we chose <a href="https://rubygems.org/gems/resque/">resque gem</a> .  A list of queuing processing solutions and a brief description can be found <a href="http://queues.io/">here</a> .  We chose <i>resque</i> for its ease of installation and configuration, support for persistence using the redis database, the presence of a minimalist web interface.  After starting the rails server, you must separately start the <i>resque</i> queue handler in the following way: <br><pre> <code class="bash hljs">QUEUE=* rake environment resque:work</code> </pre> <br>  After that, the setting of new tasks in the queue is carried out in the following way (On the example of sending push notifications) <br><div class="spoiler">  <b class="spoiler_title">Code 7. Example of setting the task in the queue</b> <div class="spoiler_text">  app / controllers / image_controller.rb <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#Crop and save uploaded file def create img_id = request.headers['imageid'] ... Resque.enqueue(Uploader, img_id) ... end</span></span></code> </pre><br>  lib / uploader.rb <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'aws-sdk'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'open-uri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'s3'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Uploader</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upload</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">img_id</span></span></span><span class="hljs-class">) ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author_id</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author</span></span></span><span class="hljs-class"> != </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Friend</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public_id_dest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Friend::STATUS_FRIEND</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">follower</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = {:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image_id</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">img_id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">author</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profile</span></span></span><span class="hljs-class">), :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class">} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PushSender</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">perform</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">follower</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public_id_src</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PushSender::EVENT_NEW_IMAGE</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br><a name="p7"></a><br><h3>  Conclusion </h3><br>  Work on the application was carried out without the goal of gaining commercial benefits and solely for the sake of self-interest, as well as to strengthen teamwork skills.  The format of our meetings was similar to the weekend hackathon; every day we tried to implement a specific module of the application.  We will be happy if you have comments or suggestions for improving the project, and also plan to continue such hackathons, so if you are a novice backend / web / Android developer and you have an interest to participate in this format offline meetings in Moscow or remotely then email us via any communication channels. <br><div class="spoiler">  <b class="spoiler_title">This is us</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a19/67e/719/a1967e719b39464b88371ac1fc5cf725.jpg" alt="image"><br></div></div><br>  <b>PS</b> It should be noted that writing a new social network is not a difficult task and, if there is a desire, even a novice Android developer is available.  Instead of your own backend, you can use ready-made solutions from <b>Google Apps Engine</b> or <b>Heroku</b> .  The development of the concept, operational support and scaling of the network due to the growing number of users is much more difficult.  Perhaps we will consider these issues in future articles. <br><br>  <b>github</b> <br>  <a href="https://github.com/aboev/photobook-client">Android client</a> <br>  <a href="https://github.com/aboev/photobook-server">Ruby on rails server</a> <br><br>  Good luck and good week to all! </div><p>Source: <a href="https://habr.com/ru/post/258111/">https://habr.com/ru/post/258111/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258085/index.html">Canceled the decision of the Nevyansk court to block Bitcoin sites</a></li>
<li><a href="../258101/index.html">CloudFlare ScrapeShield bypass in Java (Android)</a></li>
<li><a href="../258105/index.html">Social network on Android for a few days off - part I (client)</a></li>
<li><a href="../258107/index.html">Transitions with CoreAnimation: animating the appearance of the image</a></li>
<li><a href="../258109/index.html">Mexico and Russia: similar problems in learning to develop electronics</a></li>
<li><a href="../258113/index.html">HL7v3 vs. HL7 FHIR comparison</a></li>
<li><a href="../258115/index.html">Bluetooth heart rate monitor or photoplethysmograph device. Part 1</a></li>
<li><a href="../258119/index.html">What is so special about Nim?</a></li>
<li><a href="../258121/index.html">Simple suffix tree</a></li>
<li><a href="../258125/index.html">The digest of interesting materials for the mobile # 103 developer (on May 12-17)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>