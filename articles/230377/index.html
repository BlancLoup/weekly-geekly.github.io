<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unity3D + Google Services: multiplayer for your project on Android and iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about the use of Google gaming services in your application on Unity. Writing this material led me to a fairly large nu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unity3D + Google Services: multiplayer for your project on Android and iOS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e76/86a/0ea/e7686a0ea4c26d90d93ec3d730bc53e3.png"><br>  In this article I want to talk about the use of Google gaming services in your application on Unity.  Writing this material led me to a fairly large number of problems encountered during the development of our application, as well as the absence of any materials in Russian on this topic.  And actually, in English too.  The description of the plugin on the githaba is very brief and does not give an answer to possible problems with the work of the services.  I think it‚Äôs not worth explaining here that multiplayer and player ratings often increase user interest, and therefore your possible profit.  And thanks to this article, novice developers will be able to start using these advantages. <br><a name="habracut"></a><br><br><h4>  Plugin </h4><br>  We used the free <a href="https://github.com/playgameservices/play-games-plugin-for-unity">Play Games For Unity</a> plugin.  It contains libraries for working with Google services.  The plugin includes a Google+ user authorization, the ability to use achievements and rankings for players, Google clouds to store data and organize multiplayer both in real time and step by step.  Installing the plugin does not cause any difficulties: in Unity, you need to select an asset import (Assets-&gt; ImportPackage-&gt; CustomPackage) and in the opened window select an asset located in the folder "current-build". <br>  Next, you need to enter the id of your application: open the drop-down list ‚ÄúGoogle Play Games‚Äù and select the item ‚ÄúAndroid Setup‚Äù.  Id applications you can find in the Google Developer Console.  It is issued after adding a new application to Game Services, you can see it next to the name of your game.  After adding the id, you can go directly to the code. <br><br>  To initialize the plugin, use the following code: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    using GooglePlayGames; using UnityEngine.SocialPlatforms; //   Google Play Games PlayGamesPlatform.Activate();</span></span></code> </pre> <br>  PlayGamesPlatform.Activate ();  it is enough to call only once after starting your application.  After initialization, you can access the platform using Social.Active. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To implement user authentication, use the following code: <br><pre> <code class="cs hljs"> ... <span class="hljs-comment"><span class="hljs-comment">//  : Social.localUser.Authenticate((bool success) =&gt; { // ,      . });</span></span></code> </pre><br>  The success variable takes true values ‚Äã‚Äãon successful login and false, respectively, on failure.  In our case, with a successful login, the method of downloading the required user from the Google cloud is called.  And immediately the first problem encountered in our path: the method is called, but if an unsuccessful attempt fails, it does not return false, and therefore the authorization fails and there is no possibility to call the method again (! Success).  I had to write a crutch, which calls the method at a certain interval until authorization passes (provided that the user has confirmed the authorization request before this). <br>  After user authorization, we get the opportunity to use Google services. <br><br><h4>  Raise multiplayer </h4><br>  Some of this is described on a githaba, something on developers.google.  Here I collected a useful squeeze. <br>  The plugin has 4 multiplayer modes of operation: <br><ol><li>  Creating a room with random players (quick play) </li><li>  Creating a room with an invitation screen (allows you to invite friends from Google+ circles to the game) </li><li>  Invitation overview (allows you to see which friends on Google+ want to invite you to the game) </li><li>  Invitations by id (we will not consider it, because we did not use this mode in our application; those who are interested can read about it by reference to Github) </li></ol><br>  To make it easier to work with the following functions, your class must inherit from the RealTimeMultiplayerListener interface. <br><br><h6>  Create a "quick game" / connect </h6><br>  A room is created where random opponents are recruited, or an automatic connection to an already created room takes place. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MinOpponents = <span class="hljs-number"><span class="hljs-number">1</span></span>, MaxOpponents = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> GameVariant = <span class="hljs-number"><span class="hljs-number">0</span></span>; PlayGamesPlatform.Instance.RealTime.CreateQuickGame(MinOpponents, MaxOpponents, GameVariant, listener);</code> </pre><br>  Obviously, the minimum and maximum number of players is determined by the variables MinOpponents, MaxOpponents.  In our game MaxOpponents = 1, this means that in multiplayer you will have only one opponent. <br>  If your class is inherited from RealTimeMultiplayerListener, then instead of the listener you need to write this. <br><br><h6>  Creating a room with an invitation screen </h6><br>  Almost identical to the previous one.  A player can invite friends from Google+ or add random opponents. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MinOpponents = <span class="hljs-number"><span class="hljs-number">1</span></span>, MaxOpponents = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> GameVariant = <span class="hljs-number"><span class="hljs-number">0</span></span>; PlayGamesPlatform.Instance.RealTime.CreateWithInvitationScreen(MinOpponents, MaxOpponents, GameVariant, listener);</code> </pre><br><br><h6>  Invitation Overview </h6><br><pre> <code class="cs hljs">PlayGamesPlatform.Instance.RealTime.AcceptFromInbox(listener);</code> </pre><br>  A menu opens in which the player can see their invitations from Google+. <br><br><h6>  Room connection </h6><br>  The following method allows you to show the user a load while creating or connecting to a room: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRoomSetupProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> progress</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// (    0.0  100.0) }</span></span></code> </pre><br>  In our case, we simply output the progress variable. <br><br>  When the connection to the room is successful (or not), the following method is called: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRoomConnected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> success</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (success) { <span class="hljs-comment"><span class="hljs-comment">//     // ‚Ä¶  ‚Ä¶ } else { //     // ‚Ä¶  ‚Ä¶ } }</span></span></code> </pre><br>  In our game for each online race, obstacles are generated randomly, and accordingly their position should be the same on both phones.  If the connection is successful, the host is selected from the list of participants and obstacles are generated on its phone.  After they are generated, the transmission of messages with the level parameters to another phone immediately begins, and as soon as the receiving phone has loaded the last obstacle, it sends a message that it is ready and the game begins.  It also transmits the sequence number used by the spacecraft so that the correct model is displayed on the screen of another player.  Moreover, various service variables are transmitted that are necessary to determine the readiness of all the parameters necessary for the game. <br><br><h6>  members id </h6><br>  To find out the id of all participants, including yours, you can use the following code (can be executed only after connecting to the room). <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; List&lt;Participant&gt; participants = PlayGamesPlatform.Instance.RealTime.GetConnectedParticipants();</code> </pre><br>  For all participants, the list will be sorted in the same way. <br>  To find out your Id, use the following method: <br><br><pre> <code class="cs hljs">Participant myself = PlayGamesPlatform.Instance.RealTime.GetSelf(); Debug.Log(<span class="hljs-string"><span class="hljs-string">"My participant ID is "</span></span> + myself.ParticipantId);</code> </pre><br><h6>  Posting: </h6><br>  The plugin supports 2 types of messages, reliable and unreliable.  Reliable communication is slower, but guarantees delivery, unreliable faster, but delivery verification is not performed. <br>  To send a reliable message, use the following code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] message = ....; <span class="hljs-comment"><span class="hljs-comment">//    byte[] bool reliable = true; PlayGamesPlatform.Instance.RealTime.SendMessageToAll(reliable, message);</span></span></code> </pre><br>  Accordingly, for the unreliable one, change the variable reliable to false.  The message will be sent to all participants in the room, except for you. <br>  You can also send a message to a specific participant: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] message = ...; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> reliable = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> participantId = ...; PlayGamesPlatform.Instance.RealTime.SendMessage(reliable, participantId, message);</code> </pre><br>  In this way, you can send a message to yourself by specifying your id in the participantId. <br>  The maximum length of one reliable message is 1400 bytes, an unreliable 1168 bytes. <br>  There was also a problem: even if you send one message per frame, they are not sent.  We have not figured out what is the reason, probably they just do not have time to form (maybe someone will correct me in the comments).  Therefore, a frame counter was made and messages were sent at a specific interval, measured in frames.  Then everything began to work great.  During the game, our application implies the constant sending of messages (coordinates and rotation angle of the spacecraft), therefore unreliable messages are used, because the transmission speed comes to the fore, and if a couple of packets are lost, then that's okay, if the transmission is quite frequent, notice this.  But when players join a room, all messages sent with parameters of participants and their ships are reliable, since they are sent only once and their values ‚Äã‚Äãare crucial for the start of the race. <br><br>  We check receipt of all necessary messages to start the game: <br><img src="https://habrastorage.org/getpro/habr/post_images/440/63a/fe4/44063afe4c9ef4b6966ee463791fecdc.png"><br><br>  Finally, after dozens of builds and tests, everything began to work: <br><img src="https://habrastorage.org/getpro/habr/post_images/aa1/3a4/f27/aa13a4f27e431af8599699b99a3ad0e3.png"><br><br><h6>  Receive messages </h6><br>  When you receive a message, the following method is called: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRealTimeMessageReceived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isReliable, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> senderId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br>  The received message is completely identical to the sent one, both in length and in content. <br>  Since our game uses many different messages (whether the coordinates of the ship, or a message about winning one of the participants, etc.), in order to understand what message was received, we went to a rather simple and obvious step: the first byte was a number defining what kind of message and what method to call when it is received, and the transmitted data started from the second byte. <br><br><h6>  Connection events </h6><br>  If the user is disconnected from the room, the following method is called: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnLeftRoom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         //    PlayGamesPlatform.Instance.RealTime.LeaveRoom() //      }</span></span></code> </pre><br>  <b>Important:</b> When you minimize the game, the player disconnects from the room.  Perhaps for some applications this will be a problem.  But in our case, folding would inevitably lead to defeat, in view of the specifics of the game.  Therefore, when one of the participants is disconnected from the room, the OnPeersDisconnected () method, described later, is called. <br><br>  If someone connects or disconnects from the room, the following methods will be called. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPeersConnected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] participantIds</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      } public void OnPeersDisconnected(string[] participantIds) { //     }</span></span></code> </pre><br>  Participants can connect at any time during the game, if there are empty slots, and here it is necessary to ensure that the participant does not connect after the game has already started.  You can make the wait until all the slots are full and only then start the game. <br>  In our game, with early exit, one of the participants sends a message that determines the opponent's victory and the game ends, and therefore the following method should be called. <br><br><h6>  Exit the game </h6><br>  After your game is over, you need to leave the room: <br><pre> <code class="cs hljs">PlayGamesPlatform.Instance.RealTime.LeaveRoom();</code> </pre><br>  After this, OnLeftRoom () will be called. <br><br><h4>  Conclusion </h4><br>  I hope our article will be useful for both beginners and more experienced Unity developers who have not met with the organization of multiplayer in their projects.  If there is interest, I‚Äôll write a continuation about using this plugin to work with the Google cloud, which also had difficulties in developing, and, of course, there were no answers in English / Russian. </div><p>Source: <a href="https://habr.com/ru/post/230377/">https://habr.com/ru/post/230377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230359/index.html">SASM - IDE for assembler</a></li>
<li><a href="../230361/index.html">LG G3: outside and inside the clearest smartphone in the world</a></li>
<li><a href="../230365/index.html">HybridAuth for UMI.CMS. Authorization through social networks on UMI.CMS</a></li>
<li><a href="../230367/index.html">Machine learning is a microscope of a modern scientist. Why CERN Yandex Technologies</a></li>
<li><a href="../230373/index.html">Lumia Midsummer Night: How a photo installation was created at the MSND festival</a></li>
<li><a href="../230383/index.html">What is my hard drive</a></li>
<li><a href="../230385/index.html">Google announced free programming courses for Android</a></li>
<li><a href="../230389/index.html">Mapcode - the simple and short address of any place on Earth</a></li>
<li><a href="../230391/index.html">"Holographic" displays for smartphones may appear in a couple of years</a></li>
<li><a href="../230393/index.html">Fast morphology or files against MySQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>