<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to restart the server?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Abstract: description of rebut types, story about sysrq, ipt_SYSRQ, ipmi, psu. 

 How to restart the server? - This is a question that is usually aske...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to restart the server?</h1><div class="post__text post__text-html js-mediator-article">  Abstract: description of rebut types, story about sysrq, ipt_SYSRQ, ipmi, psu. <br><br>  <em>How to restart the server?</em>  - This is a question that is usually asked to very novice users who get confused between halt, shutdown -r, reboot, init 6, etc. <br><br>  An experienced administrator will clarify the question: ‚Äúwhat is wrong with the server?‚Äù Different types of server failures require different types of reboots - and the wrong choice will lead to dire consequences, from which a visit to the IPMI / DRAC / iLO web face to ‚Äúreload‚Äù the easiest.  The most difficult in my personal practice was the enikeyschik's business trip to a neighboring city.  In order to "push reboot" on a server standing alone. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article: what prevents the server from rebooting and how to help it. <br><br>  Let's start with the rebut theory. <br><br>  When the server is turned off or restarted, the initialization manager (in most modern distributions - systemd, in an eccentric Ubuntu 14.04 is still upstart, in archaic junk - sysv-init) in a certain order sends all the demons a command to "turn off".  And most demons (like DBMS, like mysql) know how to shut down correctly.  For example, finish all transactions, save all unsaved data to disk, etc.  For in-memory, the DBMS, like redis, can be critical at all: did not save - lost. <br><br>  Old initialization systems waited indefinitely for each of the init scripts.  For example, if the ‚Äújoker‚Äù added a ‚Äúsleep 3600‚Äù branch to you in the ‚Äústop‚Äù, then your server will reboot an hour with a tail.  And if there is a maybe more number, or just a program that does not want to end, then the reboot will never end. <br><a name="habracut"></a><br>  New initialization systems (in fact, do not be shy - only systemd remains) give a certain timeout (usually 120 or 180 seconds) to save data, and then complete the process forcefully.  In addition to stopping the demons, the file systems are unmounted (that is, all block caches are discarded), the iscsi target stops (also with the cache discarded), etc.  etc.  Given that the time of shatdaun is obtained indefinitely long, it is all the same of course.  Plus, there is at least some hope for the correct completion of all daemons, dropping file caches, and so on. <br><br>  Thus, on a healthy system, the correct answer to the question ‚Äúhow to reboot‚Äù is to execute the reboot command.  In some cases, even the only correct one (correction: if you make a ‚Äúreboot‚Äù in the graphical interface, the desktop environment will think that this is an emergency reboot, you must use the ‚Äúreboot‚Äù in the DE interface to reboot from the graphical mode). <br><br>  What can go wrong with the ‚Äúregular reboot‚Äù?  Well, firstly, some of the processes-demons can begin to "blunt" - see above. <br><br>  Secondly, there may be a problem with unmounting filesystems.  It is believed that it is enough to ‚Äúkill‚Äù all processes, and it will be easy to unmount the disk - no one uses it.  But, to put it mildly, this is not so.  Here are potential methods of ‚Äúnailing fs with nails so that it is not unmounted: <br><ul><li>  fallocate / fs / swap -l 1G; mkswap / fs / swap;  swapon / fs / swap </li><li>  dd if = / dev / sda of = / fs / image;  kpartx / fs / image </li><li>  losetup --find --show / fs / image </li></ul><br>  etc.  In short: a file can be occupied not only by the file system, but also by the kernel.  A module in the kernel can be busy searching for answers to the meaning of life and have no intention of freeing the resource. <br><br>  What is it fraught with?  Unmounted file system.  Systemd in this situation, tries, tries, and throws (unmounted file system).  That is, the reboot in this situation will be VERY long, but it will still pass.  But this if umount returns an error. <br><br>  And it happens that umount cannot complete the operation due to the fact that something is not available.  For example, a file on the nfs server.  If a process turns to such a file, it cannot be completed (even with the help of kill -9).  And in this situation, 'reboot' just hangs the server.  Again, the most typical places in systemd are ‚Äúcovered‚Äù, but the chance to stumble upon TASK_UNINTERRUPTIBLE ('D' in ps aux) is still possible. <br>  What to do?  You can reboot without synchronizing file systems and terminating anything with reboot -f.  But he can also hang.  For the reasons below, but for now about the consequences: all processes are not stopped and die instantly, tcp sessions are not closed, disk caches are not reset.  However, the core still performs some movements in the reboot area (and, perhaps, part of the caches will be reset).  The main thing is that in the reboot process most of the core will be involved.  And that means that if the kernel pops out, then we may not go back. <br><br>  The second, extremely unpleasant situation: problems with the file system at / (at the root).  Any attempt to make ls, grep, and even 'reboot' causes either a console hang or an error.  Problems with libc (including deleting it) go through the same category when trying to 'reboot' talk about linking problems and refuse to do something.  Or, we have reached the limit on the number of pids and they are all in the 'D' state.  or something else of the same caliber that goes in the ‚Äúserver bad‚Äù category. <br><br>  It so happens that only one console remains open on the server (and the second one no longer opens).  Why?  Because someone had something to do with the disk driver.  Or a raid controller.  Or something else, after which only memories in the disk cache remain from the '/'.  This means that we only have bash commands (built-in) that run without starting new processes. <br><br>  There is a reboot method that does not require the execution of any executable files (i.e., reading from the missing disk).  This (from root): <code>echo b &gt;/proc/sysrq-trigger</code> .  The sysrq-trigger file allows you to "push" any button from the SysRq combinations (kernel emergency buttons).  Including SysRq-b, that is, an emergency "reboot".  It often happens that after pressing enter, it does not even have time for a line feed to appear - the server is already in reboot before syscall returns.  This is the strongest softovogo that is for a reboot. <br>  <em>Note: the ‚Äúsync, reboot‚Äù that seems correct in this situation, i.e.</em>  <em>SysRq-s, SysRq-B is a mistake, because</em>  <em>after SysRq-S, the kernel may try to start communicating with the empty set, and, potentially, fall into panic or break off the last of the available consoles.</em>  <em>If an emergency reboot is made - it should be an emergency</em> <br><br><h1>  ipt_sysrq </h1><br>  This all works if you have a console to server.  And if the login hangs and there is no open console?  There is an <a href="http://marek.terminus.sk/prog/ipt_sysrq.shtml">ipt_SYSRQ</a> module that allows you to perform sysrq requests for receiving a specific network packet (more precisely, according to the iptables rule).  Works entirely in the kernel, i.e.  does not depend on FS.  The send_sysrq command is attached to it. <br><br><h1>  watchman for watchman </h1><br><br>  One might think that this is "all", but there are even more unpleasant hangs.  For example, the network card is stuck.  And the usual reboot (including via sysrq) does not help.  A second example of such a bad situation is the enclosure hang, which is stuck on a bad disk and ignores all bus reset.  The reboot seems to reset everything, and the disks are inaccessible. <br><br>  In this case, we need a power cycle (on / off).  Physically running to the server is not interesting, so you can look at the capabilities of modern servers: IPMI.  This is a built-in microcomputer that allows you to control a large computer.  It is usually called IPMI, DRAC, iLO, etc. <br><br>  Introducing us: ipmitool chassis power cycle.  It is more demanding on the health of the system (the kernel modules must be loaded, ipmitool itself must start successfully, ipmi must be working, etc.).  But on the other hand, it allows you to distort the nutrition of all.  More precisely, almost everyone - if the server has jbods, then this command does not reach them.  But, after all, it is a very good and good reboot. <br><br>  If the kernel is completely poplohlo, the command can be executed remotely (ipmitool -H ipmi.server.local chassis power cycle) <br><br>  Another difficult situation is when ipmi hangs.  If the system is more or less alive, you can ‚Äúrestart ipmi‚Äù: <code>ipmitool mc reboot hard</code> .  After that, you can make a power cycle for the chassis.  It sounds strange, but several times in my life I ‚Äúpulled out‚Äù the server to a normal reboot with just such a sequence.  ( <em>After mc reboot hard, you need to give a couple of minutes to download BMC</em> ). <br><br>  The next ‚Äúpain‚Äù point is hanging power supplies.  Yes, it happens.  Bugs in the firmware power supply fix, they need to be <a href="http://en.community.dell.com/support-forums/servers/f/956/t/19600749">flashed</a> .  Of course, any soft rebuts (such as the ipmi power cycle) do not work in this situation.  You need to either physically poke the cable or distort the power remotely.  An IP socket helps in this situation. <br><br>  It looks like this (fragment of the control panel for servers.com/servers.ru): <br><img src="https://habrastorage.org/files/ca6/cd6/195/ca6cd619569c4a4aaf5ac4b2e747e86e.png"><br>  Obviously, in these conditions, the reboot will go through a very tough scenario, but it definitely will. <br><br><h1>  Conclusion </h1><br>  Brief squeeze <br><table><tbody><tr><td>  Normal work </td><td>  reboot </td></tr><tr><td>  problems with software </td><td>  reboot -f </td></tr><tr><td>  problems with core / mounts / libc </td><td>  echo b&gt; / proc / sysrq-trigger </td></tr><tr><td>  problems with the kernel / mounts / libc and no open console </td><td>  ipt_SYSRQ (must be prepared in advance) </td></tr><tr><td>  kernel / iron problems </td><td>  ipmitool chassis power cycle </td></tr><tr><td>  kernel / iron problems without open console </td><td>  ipmitool -H ipmi.server.local chassis power cycle </td></tr><tr><td>  problems with autonomous peripherals / PSU / ipmi </td><td>  reboot through IP socket </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/98770/">https://habr.com/ru/post/98770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98758/index.html">Great Belarusian Firewall</a></li>
<li><a href="../98759/index.html">Galaxy S vs HTC Desire: Quake2 running test</a></li>
<li><a href="../98762/index.html">Media Player PowerZest HD-500</a></li>
<li><a href="../98766/index.html">V8 engine for .NET applications</a></li>
<li><a href="../98768/index.html">Auto-vectorization and auto-parallelization with Guided Auto-parallelization (GAP)</a></li>
<li><a href="../98771/index.html">Convenient and safe work with ssh servers</a></li>
<li><a href="../98775/index.html">RetroN 3 is a versatile gaming console for nostalgic gamers.</a></li>
<li><a href="../98778/index.html">InducTable: futuristic table for geeks</a></li>
<li><a href="../98779/index.html">C #: Etudes by Eric Lippert</a></li>
<li><a href="../98780/index.html">Megaphone and Megaphone-login: have they not deceived me?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>