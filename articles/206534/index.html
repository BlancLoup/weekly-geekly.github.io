<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Finishing exdupe.exe - a smart deduplicating archiver</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, I ran into an unpleasant problem - it took several virtual machines to back up. I must say that backing up for me means having as a res...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Finishing exdupe.exe - a smart deduplicating archiver</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, I ran into an unpleasant problem - it took several virtual machines to back up.  I must say that backing up for me means having as a result not only an archive with the last copy, but a small handful of these archives made according to a given scheme.  Of course, the batnichek for archiving was written quickly and worked without any complaints, but the size ... The size of the backup set turned out to be huge.  Especially sad was the fact that they were almost identical virtuals, and almost identical backups of these virtual women.  So I recognized the word "deduplication" and "diff" and began to look for some kind of compression utility with deduplication. <br><a name="habracut"></a><br>  Different utilities offered different approaches to compressing files that are close in content, but one thing turned out to be common - choose one source file and set the utility on the others - it determines the difference between the source and the others and archives the result, and when you need to deploy - you specify the source file and the archive with diff , the utility itself will deploy everything. <br>  In short, the source needed somewhere to have in expanded form.  All the time - and at the time of archiving, and at the time of unzipping.  That is, "oil painting" - I have five virtual women, I want to make an archive today with the difference between today's virtual women and yesterday's - I have to: <br>  - from yesterday to prepare a full copy of the entire farm, <br>  - then run the utility, it will make diff and archive diff. <br>  Now I want to copy all this somewhere ‚Äî I will not drag yesterday‚Äôs (source) data in uncompressed form ‚Äî I will have to archive the source as well.  If tomorrow I need to make a diff between yesterday and tomorrow - the source should be available in uncompressed and untouched form - either a copy of yesterday's state, or an archive that will have to be deployed.  If I need to deploy the archive on a new host, first I need to deploy the source, then deploy the diff itself. <br>  Well, good disk space - you can buy, but time!  Such a lot of time is spent on unarchiving the source!  But he was found - an archiver who could do everything right - drive the source into the archive, moreover, with deduplication, and then do the diffs directly from the compressed source, and the speed of archiving / unarchiving rests on the speed of the hard disk.  Cool  But under Windows 2003 does not work.  As you understand, if everything worked by itself - I would not have written this article. <br><br>  So, now - ambula. <br>  The archiver is called exdupe, it was of frivarny type, with partially available source code.  Partially - because the deduplicator library was linked statically, and the code was laid out on the command line utility (now all the code is laid out).  Everything lies in the form of a project under Visual Studio 2012. Everything started only under the 64-bit version of Windows (mine is Win2003), and at startup it gave an error: <br><blockquote>  Entry Point Not Found <br>  The procedure entry point VssFreeSnapshotPropertiesInternal could not be located in the dynamic link library VSSAPI.DLL. <br></blockquote><img src="https://habrastorage.org/getpro/habr/post_images/7e7/9f0/474/7e79f047448302ea4f55cbe71da330db.png" alt="image"><br>  The source code was immediately downloaded from <a href="http://www.exdupe.com/old">the</a> program <a href="http://www.exdupe.com/old">site</a> (I finished the version 0.5.0). <br>  The cause of the error is the incompatibility of the versions of the VSSAPI.dll library in my Windows and in the lib that was connected in the project. <br>  Picked up the source, I realized that the easiest way is to simply disable support for Shadow Copy ‚Äî remove the VSS library calls and freeze the functions responsible for accessing VSS.  It must be said, the code was written with direct hands, albeit with errors, and there were only two functions and they were in the file "shadow \ shadow.cpp". <br>  Here is what we do: <br><ol><li>  find the function void unshadow (void) </li><li>  Comment line 342: <br><pre><code class="cpp hljs">VssFreeSnapshotProperties(&amp;prop.Obj.Snap);</code> </pre> <br>  will be: <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">//removing shadowing //VssFreeSnapshotProperties(&amp;prop.Obj.Snap);</span></span></code> </pre></li><li>  before line 330 <br><pre> <code class="cpp hljs"> ULONG fetched = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br><br>  add: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//remove shadowing return 1;</span></span></code> </pre><br></li><li>  find the function int shadow (vector volumes), <br>  Comment line 177: <br><pre> <code class="cpp hljs"> hr = ::CreateVssBackupComponents(&amp;comp);</code> </pre><br>  will be: <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">//remove shadowing //hr = ::CreateVssBackupComponents(&amp;comp);</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      5. before line 157: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">// Initialize COM and open ourselves wide for callbacks by // CoInitializeSecurity. HRESULT hr;</span></span></code> </pre><br><br>  stick in: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//remove shadowing return 1;</span></span></code> </pre><br></li><br>  Before building, I recommend changing the name of the executable in the project properties so as not to be confused with the author's ‚Äúexdupe.exe‚Äù.  Type "exdupe-050-noshadow.exe". <br>  We collect, we start - it works! <br>  The algorithm is really smart, of course it wakes up the memory and loads the kernels, but this can be configured - I can comfortably run in two streams with the "-t2" key.  On a regular hard drive, source deduplication with compression: <br>  - 65.7 GB for 44 min = 24.8 MB / s <br>  - compressed to 24.1 GB = compression ratio 0.37 <br>  deduplication the next day <br>  - processing time 10 min.  20 s.  = 106 MB / s <br>  - diff compressed to 2.1 GB <br><br>  Separately, I‚Äôll say that the restriction on launching only from under 64-bit OS versions is artificially introduced, and can be disabled, while archives created by a 64-bit program are normally deployed with 32-bit, though there are no record speeds here (and there‚Äôs no waiting need to). <br>  I do not post binaries and full texts of the project due to license restrictions. <br><br>  Exdupe utility website - <a href="http://www.exdupe.com/">www.exdupe.com</a> <br>  Sources: <a href="http://www.exdupe.com/old">www.exdupe.com/old</a> </ol></div><p>Source: <a href="https://habr.com/ru/post/206534/">https://habr.com/ru/post/206534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206524/index.html">MetaPro - new augmented reality glasses</a></li>
<li><a href="../206526/index.html">Invisible.js - some models on both client and server</a></li>
<li><a href="../206528/index.html">Interview with a twelve-year game developer + author</a></li>
<li><a href="../206530/index.html">How to pass encrypted parameters to DataStage</a></li>
<li><a href="../206532/index.html">Four job interviews - four story wonders</a></li>
<li><a href="../206536/index.html">The story of one backdoor</a></li>
<li><a href="../206538/index.html">Russian video analytics market: results of 2013</a></li>
<li><a href="../206540/index.html">Are your programmers working by the sweat of their brows or just lazy?</a></li>
<li><a href="../206544/index.html">How to write an automatic test for algorithmic complexity?</a></li>
<li><a href="../206546/index.html">SendVoice, or how to hear your visitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>