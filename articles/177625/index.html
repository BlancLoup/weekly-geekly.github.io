<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Disabling the main application thread from the debugger and avoiding interception CreateFile ()</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the standard tricks that make learning your application difficult is emulating the execution of API functions. 

 Consider a particular case. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Disabling the main application thread from the debugger and avoiding interception CreateFile ()</h1><div class="post__text post__text-html js-mediator-article">  One of the standard tricks that make learning your application difficult is emulating the execution of API functions. <br><a name="habracut"></a><br>  Consider a particular case. <br>  For example, when you need to determine a critical place in an application, say, opening yourself to check the application checksum, BP is set on the API function CreateFile (), where we will wait for the input parameter with the path to our executable file, then in the debugger we will go to code that caused this function and proceed directly to the analysis. <br><br>  You can do even more simply by using the <a href="http://technet.microsoft.com/en-us/sysinternals/bb896645">Process Monitor</a> utility for the authorship of the notorious Mark Russinovich and Bruce Cogswell. <br><br>  This utility, absolutely calmly shows the full stack of calls, including return addresses of interest to us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/398/328/d5e/398328d5ecf1d177c4121192149ec084.png" alt="image"><br><br>  We can only run the debugger and install BP to the desired address. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/527/d08/306/527d083063338f35c85deb751f59ebd0.png" alt="image"><br><br>  True, this utility already shows the return address, and not the address of the call to the immediate function.  But more about that later. <br><br>  Imagine that the body of our application is already changed.  The easiest way to bypass the application checksum check is to replace the lpFileName parameter in the captured CreateFile () function with the path to the unchanged application body.  After this operation, you do not even need to study the mechanism for calculating the checksum, no matter what is used there, digital signature verification, MD5 hash or the banal CRC32.  Since  This algorithm will work with the body of the original application - all checks will be successfully passed. <br><br>  Therefore, the task looks like this in the first approximation: to make it as difficult as possible to change the parameters of the called function.  The use of mounted protections in this case will not save, because  as a result, there will always be a call to the CreateFile () function, the body of which is difficult to put it under the protection of the virtual machine (to put it mildly, some external protections can self-emulate this call, but now it‚Äôs not about them). <br><br>  One of the ways to bypass CreateFile () is to directly call the corresponding kernel function, bypassing kernel32-&gt; kernelbase-&gt; ntdll.  The result of such a call can be seen in the picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db8/cb3/9e9/db8cb39e992d4453c0f324031b00b59a.png" alt="image"><br><br>  A direct call is no longer about installing BP on any functions, since  such calls are simply not available.  Yes, we have on our hands the return address after the call, but the nuance is that the overwhelming majority of modern mounted protectors spread the code quite intelligently, and having a return code on the call does not mean that we can determine the place of the call itself to change this or that another parameter. <br><br>  To implement this algorithm, let's see what happens when you call such a code (delphi7 + Windows 7 32bit): <br><br><pre><code class="cpp hljs">hFile := CreateFile(PChar(ParamStr(<span class="hljs-number"><span class="hljs-number">0</span></span>)), GENERIC_READ, FILE_SHARE_READ <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> FILE_SHARE_WRITE, nil, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><br>  1. There is a transition to the import table <br>  2. Transferring control to the function CreateFileA () of the library kernel32.dll <br>  3. Transfer of control of the function CreateFileW () of the library kernel32.dll <br>  4. Transferring control to the CreateFileW () function of the KernelBase.dll library <br>  5. Transfer control function zwCreateFile () library ntdll.dll <br>  6. Transferring control to the kernel <br><br>  We want to get away from the first five points and execute item 6 directly. <br>  To do this, we will be helped by the implementation of the ZwCreateFile function in the ntdll.dll library, the description of the parameters of the function itself and a small educational program :) <br><br>  Consider the implementation of ZwCreateFile of the third ring (UserMode) under different systems. <br>  Pay attention to the machine code instructions MOV. <br><br>  Windows Vista - 32 bits (6.0.6002.18005) <br><pre> <code class="delphi hljs">.text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343D4 <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ZwCreateFile .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343D4 ZwCreateFile proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343D4 B8 <span class="hljs-number"><span class="hljs-number">3</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">3</span></span>Ch .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343D9 BA <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> FE <span class="hljs-number"><span class="hljs-number">7</span></span>F mov edx, <span class="hljs-number"><span class="hljs-number">7</span></span>FFE0300h .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343DE FF <span class="hljs-number"><span class="hljs-number">12</span></span> call dword ptr [edx] .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343E0 C2 <span class="hljs-number"><span class="hljs-number">2</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> retn <span class="hljs-number"><span class="hljs-number">2</span></span>Ch .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F343E0 ZwCreateFile endp</code> </pre><br><br>  Windows 7 - 32 bits (6.1.7601.17725) <br><pre> <code class="delphi hljs">.text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055C8 <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ZwCreateFile .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055C8 ZwCreateFile proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055C8 B8 <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">42</span></span>h .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055CD BA <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> FE <span class="hljs-number"><span class="hljs-number">7</span></span>F mov edx, <span class="hljs-number"><span class="hljs-number">7</span></span>FFE0300h .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055D2 FF <span class="hljs-number"><span class="hljs-number">12</span></span> call dword ptr [edx] .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055D4 C2 <span class="hljs-number"><span class="hljs-number">2</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> retn <span class="hljs-number"><span class="hljs-number">2</span></span>Ch .text:<span class="hljs-number"><span class="hljs-number">77</span></span>F055D4 ZwCreateFile endp</code> </pre><br><br>  Windows 8 - 32 bits (6.2.8400.0) <br><pre> <code class="delphi hljs">.text:<span class="hljs-number"><span class="hljs-number">6</span></span>A21629C <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ZwCreateFile .text:<span class="hljs-number"><span class="hljs-number">6</span></span>A21629C ZwCreateFile proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> .text:<span class="hljs-number"><span class="hljs-number">6</span></span>A21629C B8 <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">164</span></span>h .text:<span class="hljs-number"><span class="hljs-number">6</span></span>A2162A1 E8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> call sub_6A2162A9 .text:<span class="hljs-number"><span class="hljs-number">6</span></span>A2162A6 C2 <span class="hljs-number"><span class="hljs-number">2</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> retn <span class="hljs-number"><span class="hljs-number">2</span></span>Ch .text:<span class="hljs-number"><span class="hljs-number">6</span></span>A2162A6 ZwCreateFile endp</code> </pre><br><br>  As you can see, the differences are quite minimal.  What you should pay attention to is that a certain number is entered into the EAX register, and a function is called.  This function is called KiFastSystemCall and looks something like this (depending on the OS): <br><br><pre> <code class="cpp hljs">mov edx, esp sysenter ret</code> </pre><br><br>  Instead of SYSENTER there may be an INT 0x2E call, but this is no longer essential. <br>  The implementation of this function under 64-bit systems is slightly different: <br><br>  Windows 8 - 64 bits, 32-bit ntdll (6.2.8400.0) <br><pre> <code class="delphi hljs">.text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF470 <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ZwCreateFile .text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF470 ZwCreateFile proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> .text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF470 B8 <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">53</span></span>h .text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF475 <span class="hljs-number"><span class="hljs-number">64</span></span> FF <span class="hljs-number"><span class="hljs-number">15</span></span> C0 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> call large dword ptr fs:<span class="hljs-number"><span class="hljs-number">0</span></span>C0h .text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF47C C2 <span class="hljs-number"><span class="hljs-number">2</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> retn <span class="hljs-number"><span class="hljs-number">2</span></span>Ch .text:<span class="hljs-number"><span class="hljs-number">6</span></span>B2BF47C ZwCreateFile endp</code> </pre><br><br>  Since  our code is 32-bit, and the system is 64-bit, here the FS: 0C0h gateway is already being called, which ultimately passes the execution of the native 64-bit function that looks like this: <br><br>  Windows 8 - 64 bits, 64-bit ntdll (6.2.8400.0) <br><pre> <code class="delphi hljs">.text:<span class="hljs-number"><span class="hljs-number">0000000180003110</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> NtOpenFile .text:<span class="hljs-number"><span class="hljs-number">0000000180003110</span></span> NtOpenFile proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000180003110</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">8</span></span>B D1 mov r10, rcx .text:<span class="hljs-number"><span class="hljs-number">0000000180003113</span></span> B8 <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">31</span></span>h .text:<span class="hljs-number"><span class="hljs-number">0000000180003118</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>F <span class="hljs-number"><span class="hljs-number">05</span></span> syscall .text:<span class="hljs-number"><span class="hljs-number">000000018000311</span></span>A C3 retn .text:<span class="hljs-number"><span class="hljs-number">000000018000311</span></span>A NtOpenFile endp</code> </pre><br><br>  But, despite this nuance, the EAX register is initialized even in this case. <br><br>  The number placed in EAX is an index from the KeServiceDescriptorTable table, through which the kernel determines which function to call at a given time.  These indices are sewn directly into the NTDLL code, change from version to version (changing the table can occur even as a result of a minor patch), so we need to learn how to get them dynamically. <br><br>  The following function will help us in this: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-comment"><span class="hljs-comment">//  STD  TSDTIndex = ( sdtNtSetInformationThread, sdtZwOpenFile, sdtNtQueryObject, WOW64ReservedAddr); var FunctionSDTIndex: array [TSDTIndex] of DWORD = (0, 0, 0, 0); procedure InitSDTTable; const //  ,      ApiNames: array [TSDTIndex] of string = ( 'NtSetInformationThread', 'ZwOpenFile', 'NtQueryObject', '' ); const KSEG0_BASE = $80000000; MM_HIGHEST_USER_ADDRESS = $7FFEFFFF; MM_USER_PROBE_ADDRESS = $7FFF0000; MM_SYSTEM_RANGE_START = KSEG0_BASE; MustWrite = PAGE_READWRITE or PAGE_WRITECOPY or PAGE_EXECUTE_READWRITE or PAGE_EXECUTE_WRITECOPY; OBJ_CASE_INSENSITIVE = $00000040; FILE_SYNCHRONOUS_IO_NONALERT = $00000020; FILE_READ_DATA = 1; var pSectionAddr, dwLength: DWORD; lpBuffer: TMemoryBasicInformation; pNtHeaders: PImageNtHeaders; ExportAddr: TImageDataDirectory; ProcessExport: Boolean; ImageBase: DWORD; IED: PImageExportDirectory; I: Integer; FuntionAddr: Pointer; NamesCursor: PDWORD; OrdinalCursor: PWORD; Ordinal: DWORD; CurrentFuncName: string; SDT: TSDTIndex; begin //    ,    NTDLL pSectionAddr := GetModuleHandle('ntdll.dll'); ImageBase := 0; ExportAddr.VirtualAddress := 0; ExportAddr.Size := 0; dwLength := SizeOf(TMemoryBasicInformation); //  WOW ,     , //      sysenter //  32-     asm push eax mov eax, fs:[$c0] mov I, eax pop eax end; FunctionSDTIndex[WOW64ReservedAddr] := I; _Write(Format('WOW64Reserved: %d', [FunctionSDTIndex[WOW64ReservedAddr]])); //      while pSectionAddr &lt; MM_USER_PROBE_ADDRESS do begin //     if VirtualQuery(Pointer(pSectionAddr), lpBuffer, dwLength) &lt;&gt; dwLength then RaiseLastOSError; try //     -   if (lpBuffer.State = MEM_FREE) or (lpBuffer.State = MEM_RESERVE) then Continue; //    -   if (lpBuffer.Protect and PAGE_GUARD) = PAGE_GUARD then Continue; if (lpBuffer.Protect and PAGE_NOACCESS) = PAGE_NOACCESS then Continue; _Write(Format(' : %x', [pSectionAddr])); //  -       ? if PWord(lpBuffer.BaseAddress)^ = IMAGE_DOS_SIGNATURE then begin //     pNtHeaders := Pointer(Integer(lpBuffer.BaseAddress) + PImageDosHeader(lpBuffer.BaseAddress)^._lfanew); ExportAddr.VirtualAddress := 0; ExportAddr.Size := 0; ImageBase := DWORD(lpBuffer.BaseAddress); if (pNtHeaders^.Signature = IMAGE_NT_SIGNATURE) and (pNtHeaders^.FileHeader.Machine = IMAGE_FILE_MACHINE_I386) then begin _Write(' PE .'); //   -      ExportAddr := pNtHeaders.OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_EXPORT]; if ExportAddr.VirtualAddress &lt;&gt; 0 then Inc(ExportAddr.VirtualAddress, ImageBase) else ExportAddr.Size := 0; end; _Write(Format('  : %x', [ExportAddr.VirtualAddress])); _Write(Format('  : %x', [ExportAddr.Size])); end; // ,         ProcessExport := False; if ExportAddr.Size &lt;&gt; 0 then if ExportAddr.VirtualAddress &gt;= DWORD(lpBuffer.BaseAddress) then ProcessExport := ExportAddr.VirtualAddress + ExportAddr.Size &lt; DWORD(lpBuffer.BaseAddress) + lpBuffer.RegionSize; //    -   if ProcessExport then begin if (ImageBase = 0) or (ExportAddr.VirtualAddress = 0) then Exit; IED := PImageExportDirectory(ExportAddr.VirtualAddress); _Write(Format(' : %s', [string(PAnsiChar(ImageBase + IED^.Name))])); // ,     ? if LowerCase(string(PAnsiChar(ImageBase + IED^.Name))) = 'ntdll.dll' then begin _Write('  '); // ,   ,      I := 1; NamesCursor := Pointer(ImageBase + DWORD(IED^.AddressOfNames)); OrdinalCursor := Pointer(ImageBase + DWORD(IED^.AddressOfNameOrdinals)); while I &lt; Integer(IED^.NumberOfNames) do begin //       CurrentFuncName := string(PAnsiChar(ImageBase + PDWORD(NamesCursor)^)); for SDT := sdtNtSetInformationThread to sdtNtQueryObject do if ApiNames[SDT] = CurrentFuncName then begin //       Ordinal := OrdinalCursor^ + IED^.Base; //       FuntionAddr := Pointer(ImageBase + DWORD(IED^.AddressOfFunctions)); FuntionAddr := Pointer(ImageBase + PDWORD(DWORD(FuntionAddr) + (Ordinal - 1) * 4)^); //      MOV FuntionAddr := Pointer(DWORD(FuntionAddr) + 1); //  SDT   FunctionSDTIndex[SDT] := PDWORD(FuntionAddr)^; _Write(Format('  %s - SDT  %d', [CurrentFuncName, FunctionSDTIndex[SDT]])); end; Inc(I); Inc(NamesCursor); Inc(OrdinalCursor); end; end; ImageBase := 0; end; // ,     ? if FunctionSDTIndex[sdtNtSetInformationThread] &lt;&gt; 0 then if FunctionSDTIndex[sdtZwOpenFile] &lt;&gt; 0 then if FunctionSDTIndex[sdtNtQueryObject] &lt;&gt; 0 then Exit; finally //    ,    . Inc(pSectionAddr, lpBuffer.RegionSize); end; end; end;</span></span></code> </pre><br><br>  This function determines the load address of the NTDLL.DLL library, goes to the export table of this library, searches for records about the functions we need (in this example, NtSetInformationThread, ZwOpenFile and NtQueryObject are considered), determines their actual address in memory and reads the SDT index of the required function, based on machine code functions above.  The results are placed in the FunctionSDTIndex array. <br><br>  Now, having on hand the valid SDT indexes of the functions required for the example, let's consider directly the declaration of ZwOpenFile itself, which we are going to call. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ZwOpenFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( _Out_ PHANDLE FileHandle, _In_ ACCESS_MASK DesiredAccess, _In_ POBJECT_ATTRIBUTES ObjectAttributes, _Out_ PIO_STATUS_BLOCK IoStatusBlock, _In_ ULONG ShareAccess, _In_ ULONG OpenOptions )</span></span></span></span>;</code> </pre><br><br>  Six parameters placed on the stack.  The first and fourth follow the link, the third pointer.  Well, well, we do a call: <br><pre> <code class="delphi hljs"> <span class="hljs-comment"><span class="hljs-comment">//      // ZwOpenFile // =========================================================================== _Write('  ZwOpenFile'); _Write('    '); SysCallArgument := FunctionSDTIndex[sdtZwOpenFile]; oa.Length := SizeOf(TObjectAttributes); oa.RootDirectory := 0; oa.ObjectName := @UnicodeStr; oa.Attributes := OBJ_CASE_INSENSITIVE; oa.SecurityDescriptor := nil; oa.SecurityQualityOfService := nil; UnicodeStr.Buffer := StringToOleStr('??' + ParamStr(0)); UnicodeStr.Length := Length(UnicodeStr.Buffer) * SizeOf(WideChar); UnicodeStr.MaximumLength := UnicodeStr.Length + SizeOf(WideChar); asm //    mov SAVED_EBP, ebp mov SAVED_ESP, esp //   //         push FILE_SYNCHRONOUS_IO_NONALERT // OpenOptions push FILE_SHARE_READ + FILE_SHARE_WRITE + FILE_SHARE_DELETE // ShareAccess lea eax, iosb //   OUT  IoStatusBlock push eax //    lea eax, oa // ObjectAttributes  ,   push eax //  -    push FILE_READ_DATA + SYNCHRONIZE // DesiredAccess lea eax, hFile //   OUT  FileHandle push eax //     //       , //     , //          movzx eax, IsWOW64 or eax, eax jz @32Bit //   64-  lea eax, @64bit push eax push eax mov eax, WOW64Addr push eax mov eax, SysCallArgument xor ecx, ecx lea edx, dword ptr ss:[esp+4*3] ret @64bit: add esp, 4 jmp @FINALIZE @32Bit: //   32-  (XP  ) lea eax, @FINALIZE push eax push eax movzx eax, NeedInt2E or eax, eax jnz @NT_CODE mov edx, esp mov eax, SysCallArgument sysenter @NT_CODE: //   W2K   pop eax lea edx, esp + 4 mov eax, SysCallArgument int $2E nop @FINALIZE: //   mov Status, eax //    mov ebp, SAVED_EBP mov esp, SAVED_ESP end; if Status &lt;&gt; 0 then hFile := 0; _Write(Format('  %x', [Status])); _Write(Format(' %d', [hFile]))</span></span></code> </pre>  ; <br><br>  Actually this task is completed. <br><br>  Now the nuances: as you can see, the code can be called in three different ways. <br><br>  SYSENTER, INT2E and WOW64 register.  This is due to the features of the implementation of various operating systems and their bit depth.  The second nuance is the preservation of registers EBP / ESP.  This is due to the fact that after calling a function under 64-bit systems, the alignment on the stack is slightly different, so we restore it forcibly, so as not to destroy the application. <br><br>  Calls to the other two functions will not be considered here, but in short - NtSetInformationThread disconnects the main application thread from the debugger.  After calling it, trying to install BP will result in a different plan for errors.  For example, Delphi 7 responds with such errors: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/549/e6d/03b/549e6d03bceb29e98b31646e28c5d6b4.png" alt="image"><br><br>  After that, it remains only to disrupt the process and start the environment again. <br><br>  In the source code of the example, this call is disabled by the DISABLE_HIDEFROMDEBUGGER directive. To avoid, if you want to check its operation, comment out the declaration of this directive and recast the example. <br><br>  The second function, NtQueryObject, shows how to work with the resulting file handle (just as an example). <br><br>  The result of the demo application will be something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9f/7ee/88b/f9f7ee88bd5731fadae9ae05ede72908.png" alt="image"><br><br>  Take an example <a href="">here</a> . <br><br>  Well, as a postscript.  This approach is not a panacea, but simply an attempt to show one of the approaches to building application security.  Naturally, this code will not save you from a competent researcher.  It is possible to bypass even this implementation variant at least in three ways on a vskidka: <br><br>  1. driver parameter substitution <br>  2. substitution of the path to the application in the process environment block <br>  3. Replacing the result of the function on your own by embedding the adapter into your code at the return address of the function, which will be shown to us by the same Process Monitor. <br><br>  But scaring off a novice software researcher will help, maybe even puzzling a more advanced specialist, and only distributing the program as source codes will save the professional;) </div><p>Source: <a href="https://habr.com/ru/post/177625/">https://habr.com/ru/post/177625/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177615/index.html">Information system based on Semantic MediaWiki</a></li>
<li><a href="../177617/index.html">How we made a movie for Shadow Fight 2</a></li>
<li><a href="../177619/index.html">How to get into the "golden billion" or sobering statistics</a></li>
<li><a href="../177621/index.html">Are we all ready to go to electric cars (Fermi problem)</a></li>
<li><a href="../177623/index.html">Asterisk speech recognition through Google + smart IVR</a></li>
<li><a href="../177627/index.html">OS statistics on hh.ru</a></li>
<li><a href="../177629/index.html">Risks: full-time employee VS private entrepreneur (FOP)</a></li>
<li><a href="../177631/index.html">Installing and configuring JetBrains PhpStorm 6 for Windows 7 for developing web applications in PHP</a></li>
<li><a href="../177633/index.html">Classification of forecasting methods and models</a></li>
<li><a href="../177635/index.html">The option of organizing software version control for devices with multiple network devices on board</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>