<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recipe for capistrano - import production base on the developer machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes a situation arises when you need to get a production base to yourself, for development and testing. 
 I wrote this recipe as part of the hem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recipe for capistrano - import production base on the developer machine</h1><div class="post__text post__text-html js-mediator-article">  Sometimes a situation arises when you need to get a production base to yourself, for development and testing. <br>  I wrote this recipe as part of the heme, now it works only if the base for production and development is the same (in our case, postgresql).  If you wish, you can add other databases. <br><br>  For this purpose (as for others), Capistrano is perfect for us. <br><br>  In order to use the recipe, you need to install 7zip on the server and local machine: <br><pre><code class="hljs pgsql">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-comment"><span class="hljs-comment">--assume-yes install p7zip-full</span></span></code> </pre> <br><a name="habracut"></a><br>  Add this code to Capfile: <br>  ... <br><pre> <code class="hljs pgsql">mac_os = `uname -a`.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?("Darwin") run_local_sudo_psql = mac_os ? "psql -h localhost -U postgres" : "#{sudo} -u postgres psql" run_local_psql = mac_os ? "psql -h localhost" : "psql" database_yml_path = "config/database.yml" config = YAML::<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>(capture("cat #{current_path}/#{database_yml_path}")) adapter = config[rails_env]["adapter"] <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> = config[rails_env]["database"] db_username = config[rails_env]["username"] db_password = config[rails_env]["password"] config = YAML::<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>(File.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(database_yml_path)) local_rails_env = <span class="hljs-string"><span class="hljs-string">'development'</span></span> local_adapter = config[local_rails_env]["adapter"] local_database = config[local_rails_env]["database"] local_db_username = config[local_rails_env]["username"] local_db_password = config[local_rails_env]["password"] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> :local_folder_path, "tmp/backup" # you can <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> store *.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span>z files <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> dev machine <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> :<span class="hljs-type"><span class="hljs-type">timestamp</span></span>, <span class="hljs-type"><span class="hljs-type">Time</span></span>.now.to_i # <span class="hljs-type"><span class="hljs-type">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> seconds <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> :db_file_name, "#{database}-#{timestamp}.sql" # etc. app_production<span class="hljs-number"><span class="hljs-number">-1332404980.</span></span><span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> :db_archive_ext, "7z" namespace :db <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> task :backup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> file_name = <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(:db_file_name) archive_ext = <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(:db_archive_ext) dump_file_path = "#{shared_path}/backup/#{file_name}" output_file = "#{dump_file_path}.#{archive_ext}" run "mkdir -p #{shared_path}/backup" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adapter == "postgresql" run %{export PGPASSWORD="#{db_password}" &amp;&amp; pg_dump -U #{db_username} #{<span class="hljs-keyword"><span class="hljs-keyword">database</span></span>} &gt; #{dump_file_path}} run "cd #{shared_path} &amp;&amp; 7z a #{output_file} #{dump_file_path} &amp;&amp; rm #{dump_file_path}" <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> puts "Cannot backup, adapter #{adapter} is not implemented for backup yet" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> "mkdir -p #{local_folder_path}" download(output_file, "#{local_folder_path}/#{file_name}.#{archive_ext}") <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> task :<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> file_name = "#{db_file_name}.#{db_archive_ext}" file_path = "#{local_folder_path}/#{file_name}" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> local_adapter == "postgresql" <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> "cd #{local_folder_path} &amp;&amp; 7z x #{file_name}" <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> %{echo "drop database #{local_database}" | #{run_local_sudo_psql}} <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> %{echo "create database #{local_database} owner #{local_db_username};" | #{run_local_sudo_psql}} puts "ENTER your development password: #{local_db_password}" <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> "#{run_local_psql} -U#{local_db_username} #{local_database} &lt; #{local_folder_path}/#{db_file_name}" <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> "rm #{local_folder_path}/#{db_file_name}" <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> puts "Cannot import, adapter #{local_adapter} is not implemented for backup yet" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> task :pg_import <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adapter == local_adapter db.backup db.<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> puts "Sorry, but development and production adapters must be equals" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  How it works: </h4><br>  <b>cap db: pg_import</b> <br><br><ol><li>  creates a folder on the server "# {project_name} / shared / backup" </li><li>  makes a dump of the production base into this folder, archives it 7zip </li><li>  sends via ssh to the local machine in the project folder 'tmp / backup' </li><li>  extracts and imports into the development base <b>IMPORTANT</b> : before doing this, make <b>DROP the current local database</b> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/140492/">https://habr.com/ru/post/140492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140484/index.html">Debriefing: Hackspace PHDays CTF Afterparty 2011</a></li>
<li><a href="../140486/index.html">Well, Herz'snim !!!</a></li>
<li><a href="../140487/index.html">Windows 8 Camp - how was it? Photos and recordings</a></li>
<li><a href="../140488/index.html">Xcode 4.3.2 released</a></li>
<li><a href="../140490/index.html">A bit of magic: how to take and make a call-center really effective</a></li>
<li><a href="../140495/index.html">Let's program the rosenblatt perceptron?</a></li>
<li><a href="../140496/index.html">Mercurial: where to start implementation and why patches are needed</a></li>
<li><a href="../140497/index.html">Watson-as-a-service</a></li>
<li><a href="../140499/index.html">YouTube updated video editor</a></li>
<li><a href="../140500/index.html">Firefox Mobile 13.0a1 is now available for 58% of Android devices with ARMv6 processors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>