<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Alternative way to cache UserControls in Asp.net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think everyone who uses Asp.net to develop web sites is well aware that Asp.net has built-in UserControls caching. 
 Any user element can be cached ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Alternative way to cache UserControls in Asp.net</h1><div class="post__text post__text-html js-mediator-article">  I think everyone who uses Asp.net to develop web sites is well aware that Asp.net has built-in UserControls caching. <br>  Any user element can be cached for a specific time depending on various conditions.  Such a cache works extremely quickly and in most cases this is quite enough, but in projects in which I participate, this was not enough. <br>  The main disadvantages were as follows: <br><ul><li>  The cache may depend not only on the parameters of the query string, but also on some other parameters, such as cookies or the type of user (for example, in an online store this can be a natural or legal person) </li><li>  The entire cache should not be lost when recompiling the project (this usually happens when changing the web.config configuration file) </li><li>  If necessary, you must be able to clear the entire cache. </li></ul><br>  Initially, we periodically generated the cache for the entire site, but over time this became a very big problem due to the complexity of the controls, so I decided to look for another solution. <br><a name="habracut"></a><br>  Its essence is to create a control that would know how to cache itself. <br>  To do this, take the UserControl class and create the CacheUserControl class derived from it: <br><blockquote><code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> CacheUserControl : UserControl <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">string</font> GetCachePath(); <br> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#2B91AF">TimeSpan</font> GetCacheTime(); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsCache { <font color="#0000ff">get</font> ; <font color="#0000ff">protected</font> <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">protected</font> <font color="#0000ff">string</font> cacheText; <br> <font color="#0000ff">protected</font> <font color="#0000ff">string</font> cachePath; <br> <font color="#0000ff">protected</font> <font color="#0000ff">sealed</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnInit( <font color="#2B91AF">EventArgs</font> e) <br> { <br> ... <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">sealed</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> RenderControl(HtmlTextWriter htmlTextWriter) <br> { <br> ... <br> } <br> }</font> <br></code> </blockquote><br><br>  As you can see, there are two abstract methods. <br>  The GetCachePath method returns the path to the cache file.  This path should reflect all dependencies of the control so that it can select the correct file. <br>  The GetCacheTime method returns the time interval through which the cache will be considered obsolete and will be updated if necessary. <br><br>  Next, you need to override two methods of the UserControl class: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The OnInit method should check if the cache file exists, and if so, the control should delete all its child controls so that they do not trigger any of their events and load the cache from the file: <br><br><blockquote> <code><font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">sealed</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnInit( <font color="#2B91AF">EventArgs</font> e) <br> { <br> <font color="#0000ff">try</font> <br> { <br> cachePath = GetCachePath(); <br> <font color="#0000ff">if</font> (cachePath != <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">var</font> cacheFile = <font color="#0000ff">new</font> FileInfo(cachePath); <br> <font color="#0000ff">if</font> (cacheFile.Exists) <br> { <br> <font color="#0000ff">var</font> cacheTime = GetCacheTime(); <br> <br> <font color="#0000ff">var</font> cacheTimeExpired = cacheFile.CreationTime + cacheTime &lt; <font color="#2B91AF">DateTime</font> .Now; <br> <font color="#0000ff">if</font> (!cacheTimeExpired) <br> { <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> reader = cacheFile.OpenText()) <br> { <br> cacheText = reader.ReadToEnd(); <br> IsCache = <font color="#0000ff">true</font> ; <br> Controls.Clear(); <br> } <br> } <br> } <br> } <br> } <br> <font color="#0000ff">catch</font> (IOException) <br> { <br> } <br> <br> <font color="#0000ff">base</font> .OnInit(e); <br> }</font></code> </blockquote> <br><br>  The RenderControl method should check whether the cache is loaded, and if it is loaded, then render it, and if not, render the control in normal mode and additionally create a cache file: <br><br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">sealed</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> RenderControl(HtmlTextWriter htmlTextWriter) <br> { <br> <font color="#0000ff">if</font> (IsCache) <br> { <br> htmlTextWriter.Write(cacheText); <br> } <br> <font color="#0000ff">else</font> <br> { <br> <font color="#0000ff">base</font> .RenderControl(htmlTextWriter); <br> <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">if</font> (cachePath != <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> streamWriter = <font color="#0000ff">new</font> StreamWriter(cachePath, <font color="#0000ff">false</font> , <font color="#2B91AF">Encoding</font> .UTF8)) <br> { <br> <font color="#0000ff">using</font> (htmlTextWriter = <font color="#0000ff">new</font> HtmlTextWriter(streamWriter)) <br> { <br> <font color="#0000ff">base</font> .RenderControl(htmlTextWriter); <br> } <br> } <br> } <br> } <br> <font color="#0000ff">catch</font> (IOException) <br> { <br> } <br> } <br> }</font></code> </blockquote> <br><br>  As a result, to use self-caching control, you need to change the base class from UserControl to CacheUserConrtol and additionally define two methods, for example: <br><br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">string</font> GetCachePath() <br> { <br> <font color="#0000ff">var</font> id = Request.QueryString[ <font color="#A31515">"id"</font> ]; <br> <font color="#0000ff">if</font> ( <font color="#0000ff">string</font> .IsNullOrEmpty(id)) <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> <br> <font color="#0000ff">var</font> currency = <font color="#A31515">"rur"</font> ; <br> <font color="#0000ff">var</font> cookie = Request.Cookies[ <font color="#A31515">"currency"</font> ]; <br> <font color="#0000ff">if</font> (cookie != <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">var</font> <font color="#0000ff">value</font> = cookie.Value; <br> <font color="#0000ff">if</font> ( <font color="#0000ff">value</font> == <font color="#A31515">"usd"</font> ) currency = <font color="#A31515">"usd"</font> ; <br> <font color="#0000ff">else</font> <font color="#0000ff">if</font> ( <font color="#0000ff">value</font> == <font color="#A31515">"euro"</font> ) currency = <font color="#A31515">"euro"</font> ; <br> } <br> <br> <font color="#0000ff">var</font> path = <font color="#0000ff">string</font> .Format( <font color="#A31515">"~/cache/cat_{0}_cur_{1}.html"</font> , id, currency); <br> <font color="#0000ff">return</font> Server.MapPath(path); <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#2B91AF">TimeSpan</font> GetCacheTime() <br> { <br> <font color="#0000ff">return</font> <font color="#2B91AF">TimeSpan</font> .FromDays(7); <br> }</font></code> </blockquote> <br><br>  Now the control itself will create separate cache files for different categories (determined by id) for each currency of the directory (determined from cookie) <br><br>  The only disadvantage of this approach is that over time, garbage will accumulate in the cache, so it will periodically have to be completely cleared.  It should also be noted that the Page_Load method of such a control is invoked in any case, but the events of the child controls only if the content is not taken from the file. <br><br>  Well, that's all. <br><br></div><p>Source: <a href="https://habr.com/ru/post/60352/">https://habr.com/ru/post/60352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../60343/index.html">Online json parser</a></li>
<li><a href="../60345/index.html">We put PHP on the iPhone</a></li>
<li><a href="../60347/index.html">Git wizardry</a></li>
<li><a href="../60349/index.html">How do free software developers live and earn money?</a></li>
<li><a href="../60350/index.html">A systematic approach to the leader in working with the team. Do not repeat mistakes three times</a></li>
<li><a href="../60353/index.html">Pet Shop Boys (QR Code Video Remix)</a></li>
<li><a href="../60355/index.html">Installing Windows 7 on the EEE-PC 1000HE</a></li>
<li><a href="../60358/index.html">We program Windows 7: Taskbar. Part 4 - Custom OverlayIcon</a></li>
<li><a href="../60359/index.html">We program Windows 7: Taskbar. Part 5 - CustomWindowsManager</a></li>
<li><a href="../60360/index.html">We program Windows 7: Taskbar. Part 6 - AppId</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>