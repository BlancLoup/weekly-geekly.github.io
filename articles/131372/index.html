<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to use C ++ AMP from C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the Visual Studio 11 Developer Preview , C ++ AMP allows you to speed up your applications using heterogeneous hardware, such as a GPU. 
 If you ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to use C ++ AMP from C #</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/3f19e24a/e0dba192/00f21024/e9fed3eb.png" align="left"><br>  In the <a href="http://blogs.msdn.com/b/nativeconcurrency/archive/2011/09/16/get-visual-studio-11-now.aspx">Visual Studio 11 Developer Preview</a> , C ++ AMP allows you to speed up your applications using heterogeneous hardware, such as a GPU. <br>  If you are a .NET developer, you can still use C ++ AMP in your applications.  Most of the code will be written in C #, only a few sections using C ++ AMP to execute it on the GPU, then use your favorite interop mechanism for binding.  This post will explain how to do this through P / invoke. <br><a name="habracut"></a><br>  However, before attempting to call C ++ AMP from C #, make sure that C ++ AMP is running on your machine.  Post <a href="http://blogs.msdn.com/b/nativeconcurrency/archive/2011/09/19/vs-11-developer-preview-gotchas-with-c-amp.aspx">VS 11 Developer Preview</a> along with Daniel Moth C ++ AMP explains how to do this.  I note that C ++ AMP can be used from both Visual Studio 11 Express and Visual Studio 11 Ultimate, however, in this article we will use the latter option. <br><br><h5>  Short cut </h5><br>  As soon as C ++ AMP works on your system, the easiest way to start using it is to open the <a href="">sample project</a> in Visual Studio 11 Ultimate and start experimenting with it. <br><br><h5>  A long way </h5><br>  If you have a ready-made application that you want to change to be able to use C ++ AMP, or you want to understand how the above example was created, then follow the steps below.  In short, you will need to do the following: <br><ul><li>  Step 1: Open or create a C # project in Visual Studio 11. <ul><li>  Select the target platform as X86 (if you plan to write 32-bit C ++ AMP code). </li><li>  Allow the use of unsafe code in the project. </li></ul><br></li><li>  Step 2: Add a C ++ project to the solution. <ul><li>  Create a Win32 DLL, which will contain the C ++ AMP code. </li></ul></li><li>  Step 3: Add the project build step to copy the Win32 DLL to the binaries of the managed project. </li><li>  Step 4: Add dependencies between projects. </li><li>  Step 5: We write C ++ AMP and C # code. <br><ul><li>  C # code will use P / invoke for the C ++ AMP code. </li></ul></li></ul><br>  So, we proceed to a more detailed description of the necessary steps. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Step 1: Open or create a C # project in Visual Studio 11 </h5><br>  First of all, you need to open or create a C # project.  The rest of the article will assume that it is named as HelloWorldCSharp, and is based on the Visual C # Console Application template. <br>  I note that you need Visual Studio 11 Ultimate to create a console application, because  in Visual Studio 11 Express, you can only create Metro applications. <br>  You may need to clarify two parameters: <br><ul><li>  Knowing that the C ++ AMP code will be 32-bit, the target platform of the project should be set to X86, but not to AnyCPU. </li><li>  The managed project should allow unsafe code (right click on the HelloWorldCSharp project in the solution browser, click on the Build tab, select ‚ÄúAllow unsafe code‚Äù). </li></ul><br><h5>  Step 2: Add a C ++ project to the solution </h5><br>  We also need a Win32 DLL containing C ++ AMP code.  In this example, we will create a ‚ÄúWin32 Console Application‚Äù and call it ‚ÄúHelloWorldLib‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c7/d0e/a70/0c7d0ea70c2a398f192c1ba19dce6ff7.png"><br><br>  After clicking Next, select the application type as ‚ÄúDLL‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/19e/9b1/938/19e9b193861fae7191b0b2d9b0a41f04.png"><br><br><h5>  Step 3: Add the project build step to copy the Win32 DLL to the binaries of the managed project </h5><br>  When building a solution, I would like both projects to be built, right?  However, HelloWorldLib.dll will not be copied to the HelloWorldCSharp binary folder.  We need to do this in such a way that HelloWorldCSharp.exe could be found at runtime. <br>  To force HelloWorldLib.dll to be correctly copied each time it is assembled, you must add an assembly step to the HelloWorldCSharp project.  First, upload HelloWorldCSharp in Solution Explorer: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9db/6f7/127/9db6f7127aac29607336c1049f9a6be8.png"><br><br>  Next, you need to edit HelloWorldCSharp.csproj in Visual Studio (right click on the project, click ‚ÄúEdit HelloWorldSharp.csproj‚Äù): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e80/a84/e57/e80a84e57ff387bb5867c448136584dc.png"><br><br>  Paste the following XML right before the ‚ÄúMicrosoft.CSharp.targets‚Äù section: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\$(Configuration)\HelloWorldLib.dll"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Link</span></span></span><span class="hljs-tag">&gt;</span></span>HelloWorldLib.dll<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Link</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  After reloading HelloWorldLib, HelloWorldLib.dll should appear in Solution Explorer. <br>  In the properties window, make sure that the value ‚ÄúCopy to Output Directory‚Äù is selected as ‚ÄúCopy if newer‚Äù, and also ‚ÄúBuild Action‚Äù is set as ‚ÄúContent‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/944/a63/34b/944a6334b77d482605235ab40272cc5a.png" width="433" height="527"><br><br><h5>  Step 4: Add dependencies between projects </h5><br>  For more convenience, let's set the HelloWorldLib project as a dependency for the HelloWorldCSharp project.  Then, when building HelloWorldCSharp, the assembly and HelloWorldLib will occur. <br>  Right click on HelloWorldCSharp and select Project Dependencies: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d86/433/70a/d8643370a15201232faae4128bedcd15.png" width="420" height="654"><br><br>  And then add a dependency on HelloWorldLib: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e59/56a/508/e5956a508d7c73f92a83006ff52e7978.png" width="459" height="426"><br><br>  To make sure that the solution build is correct, rebuild the project, then the HelloWorldCSharp binaries folder (i.e. HelloWorldCSharp \ HelloWorldCSharp \ bin \ Debug) must contain both HelloWorldCSharp.exe and HelloWorldLib.dll. <br><br><h5>  Step 5: Writing C ++ AMP and C # Code </h5><br>  Now we are ready to call C ++ AMP code from C #.  Change the HelloWorldLib.cpp as below: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdafx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"amp.h"</span></span></span><span class="hljs-meta"> using namespace concurrency; extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> __declspec ( dllexport ) void _stdcall square_array(float* arr, int n) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Create a view over the data on the CPU array_view&lt;float,1&gt; dataView(n, &amp;arr[0]); // Run code on the GPU parallel_for_each(dataView.grid, [=] (index&lt;1&gt; idx) mutable restrict(direct3d) { dataView[idx] = dataView[idx] * dataView[idx]; }); // Copy data from GPU to CPU dataView.synchronize(); }</span></span></span></span></code> </pre><br>  We simply added the square_array function, which squares the array elements using C ++ AMP.  Also, we decorate a function to export it from a DLL. <br>  Now, edit the HelloWorldCSharp application to call the C ++ AMP code.  Change Program.cs in the HelloWorldCSharp project as shown below: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Function defined in HelloWorldLib.dll to square an array using C++ AMP </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DllImport("HelloWorldLib", CallingConvention = CallingConvention.StdCall)] extern unsafe static void square_array(float* array, int length); static unsafe void Main() { // Allocate an array float[] arr = new[] { 1.0f, 2.0f, 3.0f, 4.0f }; // Square the array elements using C++ AMP fixed (float* arrPt = &amp;arr[0]) { square_array(arrPt, arr.Length); } // Enumerate the results foreach (var x in arr) { Console.WriteLine(x); } } }</span></span></code> </pre><br>  ‚Ä¶ that's all!  Now you can run the HelloWorldCSharp project and see the working C ++ AMP code through C #. <br><br>  I note that this is a very simple example that demonstrates the ability to call a C ++ AMP function from C #.  The example is too ‚Äúnaive‚Äù to demonstrate the speed of execution - it produces too little action on data elements using the capabilities of GPU acceleration.  Post <a href="http://www.danielmoth.com/Blog/Matrix-Multiplication-With-C-AMP.aspx">C ++ AMP code for Matrix Multiplication</a> is an example that demonstrates acceleration during matrix multiplication. <br><br><hr><br><h5>  From translator </h5><br>  In addition to C ++ AMP, there is another project from Microsoft (its Research division) - <a href="http://research.microsoft.com/en-us/projects/accelerator/">Accelerator</a> , which provides parallel computing capabilities on both multi-core CPUs and GPUs that support DirectX 9 and higher. <br>  Accelerator v2 is a native C ++ library with a managed wrapper. <br></div><p>Source: <a href="https://habr.com/ru/post/131372/">https://habr.com/ru/post/131372/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131366/index.html">The history of Losharik</a></li>
<li><a href="../131367/index.html">Electronic signature of an individual (part 1)</a></li>
<li><a href="../131369/index.html">Design patterns for Android development. Part 1 - Introduction</a></li>
<li><a href="../131370/index.html">Who is stronger - a whale or an elephant?</a></li>
<li><a href="../131371/index.html">Productivity Future Vision (2011)</a></li>
<li><a href="../131374/index.html">Acer Iconia Tab A100 - video review of the first 7-ki on Honeycomb</a></li>
<li><a href="../131376/index.html">Presentation of Samsung Galaxy Nexus and Android 4.0 (Russian translation)</a></li>
<li><a href="../131377/index.html">SoX port for Android or trying to create the perfect player</a></li>
<li><a href="../131378/index.html">People as "sensors"</a></li>
<li><a href="../131380/index.html">Creating your own "television" based on torrent-trackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>