<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sorting large amounts of data, implementation in Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently on Habr√© there was article Sorting of a million 32-bit int'ov in 2 megabytes of memory on the Python . Interested, tried to implement in Java...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sorting large amounts of data, implementation in Java</h1><div class="post__text post__text-html js-mediator-article">  Recently on Habr√© there was article <a href="http://habrahabr.ru/blogs/python/65503/">Sorting of a million 32-bit int'ov in 2 megabytes of memory on the Python</a> .  Interested, tried to implement in Java. <br><br>  Of course, 32 lines failed.  It turned out 235. <br>  But it seemed to me that the result could well be used as the first post - do not judge strictly;) <br><a name="habracut"></a><br><br>  At first, we got a trial version, which worked with arrays of integers, stored them in a binary file.  After it earned (by the way, 2.3 seconds on p4-3.2), it was thought that a hard peg to architecture and types is not the right way.  After all, it was not without reason that collections made in Java that work with any types of data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After spending 2 hours, I got a completely working class, digesting any Comparable-types. <br><br><h3>  What it consists of: </h3><br>  <b>Test</b> - class to test performance.  With unit tests, I didn't bother. <br><br>  <b>FileSort</b> - in fact, the main worker, cook and carpenter. <br><br>  <b>FileSortStorageObject</b> - an assistant that saves a list of objects in a temporary file. <br><br>  <b>FileSortStorage</b> - assistant interface.  In fact, serialization (ObjectOutputStream and ObjectInputStream) slows down the algorithm a little, so anyone can implement a different save method. <br><br><h3>  How it works: </h3><br>  Since there is a lot of data, there is no sense to represent them as a full array.  It seemed to me that you can work with them with the help of an iterator. <br><br>  1. With the help of an iterator, the part of the data that is stored in the memory is read (the number of records is specified). <br>  2. The read block is sorted by the same quicksort (its memory overhead is not large). <br>  3. Next, the sorted block is added to its temporary file, where it lies for the time being. <br>  4. While there is data, repeat P1-3 <br>  5. Here we have N files, each of which contains a sorted portion of data. <br>  6. An iterator is created that elementarily merges the existing files. <br><br>  When merging, iterators are also used (what I do, I like them), which select the next record from each individual file.  From the selected entries is selected minimum, which is returned to the outside.  The next object from the corresponding file is immediately counted to the place of the entry issued to the outside. <br><br><h3>  So, the source.  Suddenly someone wants to play </h3><br><h4>  Main class: </h4><br><blockquote><code><font color="#800050">package</font> ru.dchekmarev.test.FileSort; <br> <br> <font color="#800050">import</font> java.io.*; <br> <font color="#800050">import</font> java.util.*; <br> <br> <font color="#50c050">/** <br> *           <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">class</font> FileSort&lt;T <font color="#800050">extends</font> Comparable&lt;T&gt;&gt; <font color="#800050">implements</font> Iterable&lt;T&gt; { <br> <font color="#800050">private</font> <font color="#800050">int</font> bufferSize = 10000; <br> <font color="#800050">private</font> List&lt;FileSortStorage&gt; partFiles = <font color="#800050">new</font> LinkedList&lt;FileSortStorage&gt;(); <br> <font color="#800050">private</font> Iterator&lt;T&gt; source; <br> <font color="#800050">private</font> List&lt;T&gt; part = <font color="#800050">new</font> LinkedList&lt;T&gt;(); <br> <font color="#50c050">/** <br> *   ,    <br> */</font> <br> <font color="#800050">public</font> FileSort() { <br> } <br> <font color="#50c050">/** <br> *    -  <br> */</font> <br> <font color="#800050">public</font> FileSort(Iterator&lt;T&gt; newSource) { <br> setSource(newSource); <br> } <br> <font color="#50c050">/** <br> *     -       <br> */</font> <br> <font color="#800050">public</font> FileSort(Iterator&lt;T&gt; newSource, Integer newSize) { <br> this(newSource); <br> setBufferSize(newSize); <br> } <br> <font color="#50c050">/** <br> *       <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">void</font> setBufferSize( <font color="#800050">int</font> newSize) { <br> bufferSize = newSize; <br> } <br> <font color="#50c050">/** <br> *   ,   <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">void</font> setSource(Iterator&lt;T&gt; newSource) { <br> source = newSource; <br> <font color="#800050">try</font> { <br> sortParts(); <br> } <font color="#800050">catch</font> (IOException e) { <br> <font color="#800050">throw</font> <font color="#800050">new</font> RuntimeException(e); <br> } <br> Collections.sort(part); <br> } <br> <font color="#50c050">/** <br> *      <br> */</font> <br> <font color="#800050">public</font> Iterator&lt;T&gt; iterator() { <br> <font color="#800050">if</font> (partFiles.size() == 0) { <br> <font color="#50c050">//  ,     </font> <br> <font color="#800050">return</font> part.iterator(); <br> } <br> <font color="#800050">return</font> <font color="#800050">new</font> Iterator&lt;T&gt;() { <br> Long t = 0L; <br> List&lt;T&gt; items = <font color="#800050">new</font> ArrayList&lt;T&gt;(); <br> List&lt;Iterator&lt;T&gt;&gt; iterators = <font color="#800050">new</font> ArrayList&lt;Iterator&lt;T&gt;&gt;(); <br> Integer minIdx = <font color="#800050">null</font> ; <br> <font color="#50c050">//   ,  </font> <br> <font color="#50c050">//       ,       </font> <br> { <br> iterators.add(part.iterator()); <br> <font color="#800050">for</font> (FileSortStorage f : partFiles) { <br> iterators.add(f.iterator()); <br> } <br> <font color="#800050">for</font> (Iterator&lt;T&gt; item : iterators) { <br> <font color="#800050">if</font> (item.hasNext()) { <br> items.add(item.next()); <br> } <font color="#800050">else</font> { <br> <font color="#800050">throw</font> <font color="#800050">new</font> RuntimeException( <font color="#5050c0">"failed to get first for iterator"</font> ); <br> } <br> } <br> } <br> <font color="#50c050">/** <br> *    ,     <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">boolean</font> hasNext() { <br> <font color="#800050">if</font> (minIdx == <font color="#800050">null</font> ) { <br> <font color="#800050">for</font> ( <font color="#800050">int</font> i = 0; i &lt; items.size(); i++) { <br> <font color="#800050">if</font> (items.get(i) != <font color="#800050">null</font> &amp;&amp; <br> (minIdx == <font color="#800050">null</font> || <br> items.get(i).compareTo(items.get(minIdx)) &lt; 0)) { <br> minIdx = i; <br> } <br> } <br> } <br> <font color="#800050">return</font> minIdx != <font color="#800050">null</font> ; <br> } <br> <font color="#50c050">/** <br> *     - , <br> *         <br> */</font> <br> <font color="#800050">public</font> T next() { <br> T res = <font color="#800050">null</font> ; <br> <font color="#800050">if</font> (hasNext()) { <br> res = items.get(minIdx); <br> <font color="#800050">if</font> (iterators.get(minIdx).hasNext()) { <br> items.set(minIdx, iterators.get(minIdx).next()); <br> } <font color="#800050">else</font> { <br> items.set(minIdx, <font color="#800050">null</font> ); <br> } <br> } <br> minIdx = <font color="#800050">null</font> ; <br> <font color="#800050">return</font> res; <br> } <br> <font color="#800050">public</font> <font color="#800050">void</font> remove() { <br> <font color="#800050">throw</font> <font color="#800050">new</font> UnsupportedOperationException(); <br> } <br> }; <br> } <br> <font color="#50c050">/** <br> *           <br> */</font> <br> <font color="#800050">void</font> sortParts() <font color="#800050">throws</font> IOException { <br> <font color="#800050">while</font> (source.hasNext()) { <br> part.add((T)source.next()); <br> <font color="#800050">if</font> (part.size() &gt;= bufferSize &amp;&amp; source.hasNext()) { <br> Collections.sort(part); <br> partFiles.add( <font color="#800050">new</font> FileSortStorageObject(part)); <br> part.clear(); <br> } <br> } <br> } <br> } <br> <br></code> </blockquote><br><br><h4>  Interface to save to disk: </h4><br><br><blockquote> <code><font color="#800050">package</font> ru.dchekmarev.test.FileSort; <br> <br> <font color="#800050">import</font> java.util.List; <br> <font color="#800050">import</font> java.io.IOException; <br> <br> <font color="#800050">public</font> <font color="#800050">interface</font> FileSortStorage&lt;T&gt; <font color="#800050">extends</font> Iterable&lt;T&gt; { <br> <font color="#800050">public</font> <font color="#800050">void</font> setObjects(List&lt;T&gt; objects) <font color="#800050">throws</font> IOException; <br> } <br> <br></code> </blockquote><br><br><h4>  The implementation of saving on disk serialized objects: </h4><br><br><blockquote> <code><font color="#800050">package</font> ru.dchekmarev.test.FileSort; <br> <br> <font color="#800050">import</font> java.io.*; <br> <font color="#800050">import</font> java.util.*; <br> <br> <font color="#50c050">/** <br> *             <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">class</font> FileSortStorageObject&lt;T&gt; <font color="#800050">implements</font> FileSortStorage&lt;T&gt; { <br> <font color="#800050">private</font> <font color="#800050">final</font> File file; <br> <br> <font color="#50c050">/** <br> * ,         <br> */</font> <br> <br> <font color="#800050">public</font> FileSortStorageObject(List&lt;T&gt; objects) <font color="#800050">throws</font> IOException { <br> file = File.createTempFile( <font color="#5050c0">"FileSort"</font> , <font color="#5050c0">"dat"</font> ); <br> setObjects(objects); <br> } <br> <font color="#50c050">/** <br> *     <br> */</font> <br> <font color="#800050">public</font> <font color="#800050">void</font> setObjects(List&lt;T&gt; objects) <font color="#800050">throws</font> IOException { <br> ObjectOutputStream wr = <font color="#800050">new</font> ObjectOutputStream( <font color="#800050">new</font> FileOutputStream(file)); <br> <font color="#800050">for</font> (T item : objects) { <br> wr.writeObject(item); <br> } <br> wr.close(); <br> } <br> <font color="#50c050">/** <br> *   -  <br> */</font> <br> <br> <font color="#800050">public</font> Iterator&lt;T&gt; iterator() { <br> <font color="#800050">try</font> { <br> <font color="#800050">return</font> <font color="#800050">new</font> Iterator&lt;T&gt;() { <br> <font color="#800050">private</font> ObjectInputStream fr = <br> <font color="#800050">new</font> ObjectInputStream( <font color="#800050">new</font> FileInputStream(file)); <br> T obj; <br> <font color="#800050">public</font> <font color="#800050">boolean</font> hasNext() { <br> <font color="#800050">if</font> (obj == <font color="#800050">null</font> ) { <br> <font color="#800050">try</font> { <br> obj = (T)fr.readObject(); <br> } <font color="#800050">catch</font> (ClassNotFoundException e) { <br> <font color="#800050">throw</font> <font color="#800050">new</font> RuntimeException(e); <br> } <font color="#800050">catch</font> (IOException e) { <br> obj = <font color="#800050">null</font> ; <br> } <br> } <br> <font color="#800050">return</font> obj != <font color="#800050">null</font> ; <br> } <br> <font color="#800050">public</font> T next() { <br> hasNext(); <br> T res = obj; <br> obj = <font color="#800050">null</font> ; <br> <font color="#800050">return</font> res; <br> } <br> <font color="#800050">public</font> <font color="#800050">void</font> remove() { <br> <font color="#800050">throw</font> <font color="#800050">new</font> UnsupportedOperationException(); <br> } <br> }; <br> } <font color="#800050">catch</font> (IOException e) { <br> <font color="#800050">throw</font> <font color="#800050">new</font> RuntimeException(e); <br> } <br> } <br> <font color="#50c050">/** <br> *  <br> */</font> <br> <br> <font color="#800050">protected</font> <font color="#800050">void</font> finalize() { <br> file.delete(); <br> } <br> } <br></code> </blockquote><br><br><h4>  And the test class, because you always want to see a clear result: </h4><br><br><blockquote> <code><font color="#800050">package</font> ru.dchekmarev.test.FileSort; <br> <br> <font color="#800050">import</font> java.util.*; <br> <br> <font color="#800050">public</font> <font color="#800050">class</font> Test { <br> <font color="#800050">public</font> <font color="#800050">static</font> <font color="#800050">void</font> main(String[] args) { <br> System.out.println( <font color="#5050c0">"Test start"</font> ); <br> <font color="#50c050">//  -</font> <br> <br> FileSort&lt;Double&gt; sort = <font color="#800050">new</font> FileSort&lt;Double&gt;( <br> <font color="#50c050">//     -  </font> <br> <font color="#50c050">//       </font> <br> <font color="#800050">new</font> Iterator&lt;Double&gt;() { <br> <font color="#800050">private</font> <font color="#800050">int</font> i = 0; <br> <font color="#800050">private</font> Random rand = <font color="#800050">new</font> Random(); <br> <font color="#800050">public</font> <font color="#800050">boolean</font> hasNext() { <br> <font color="#800050">if</font> (i &gt;= 1000) { <br> System.out.println( <font color="#5050c0">"generator finish"</font> ); <br> } <br> <font color="#800050">return</font> i &lt; 1000; <br> } <br> <font color="#800050">public</font> Double next() { <br> i++; <br> <font color="#800050">return</font> rand.nextDouble(); <br> } <br> <font color="#800050">public</font> <font color="#800050">void</font> remove() { <br> <font color="#800050">throw</font> <font color="#800050">new</font> UnsupportedOperationException(); <br> } <br> }); <br> <font color="#800050">int</font> i = 0; <br> <font color="#50c050">//   </font> <br> <br> <font color="#800050">for</font> (Double res : sort) { <br> <font color="#800050">if</font> (++i % 10000 == 0) { <br> <font color="#50c050">//        </font> <br> <font color="#50c050">//    </font> <br> System.out.println(i); <br> } <br> System.out.println( <font color="#5050c0">" == "</font> + res); <br> } <br> } <br> } <br></code> </blockquote><br><br><br>  Code ... Yes, you could write literate. <br>  Algorithm ... Yes, for sure it is not correct.  But it works :) <br>  <a href="http://dchekmarev.ru/blog/article/1248798335">my original</a> </div><p>Source: <a href="https://habr.com/ru/post/65612/">https://habr.com/ru/post/65612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65600/index.html">Oh, those stereotypes ...</a></li>
<li><a href="../65602/index.html">XSS vulnerability on Futurico.ru</a></li>
<li><a href="../65603/index.html">New Habr in a new way</a></li>
<li><a href="../65604/index.html">What questions - such answers</a></li>
<li><a href="../65606/index.html">Linux Foundation Credit Cards</a></li>
<li><a href="../65613/index.html">AirPeople.ru - Do you fly by air?</a></li>
<li><a href="../65614/index.html">Corner lamer (increase the efficiency of the mobile old man Sony Ericsson w810i)</a></li>
<li><a href="../65616/index.html">Mood lamp!</a></li>
<li><a href="../65617/index.html">Data structures: binary trees. Part 1</a></li>
<li><a href="../65618/index.html">The Senate will deal with ultrafast trading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>