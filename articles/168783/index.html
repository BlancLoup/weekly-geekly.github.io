<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple power monitoring device</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now more and more people are interested in the topic of monitoring the consumption of electricity. 
 In some cases, this knowledge is very important (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple power monitoring device</h1><div class="post__text post__text-html js-mediator-article">  Now more and more people are interested in the topic of monitoring the consumption of electricity. <br>  In some cases, this knowledge is very important (for example, for your country house allocated 8kW of power and you need to understand how close you are to the allowed limit, etc.). <br>  There are already finished products, one of them was already the <a href="http://habrahabr.ru/post/127322/">hero of the review</a> on Habr√©. <br><br>  But we are not one of those who are looking for easy ways and will make such a device: <br><img src="https://habrastorage.org/storage2/584/506/572/5845065724f0864fb902f6ca1ee7e95d.jpg"><br><a name="habracut"></a><br>  I got this <a href="http://openenergymonitor.org/emon/sites/default/files/SCT013-000_datasheet.pdf">sensor</a> in my hands: <br><img src="https://habrastorage.org/storage2/236/e69/50a/236e6950adf2a881914ce794c65f61e2.jpg"><br><br>  The remaining components will be used the most accessible and priority will be given to those that are already available. <br><blockquote>  <b>Note</b> : since the scheme is not too complicated, I will not give it entirely, but I will only tell you about some of the features. <br>  Links to all useful materials and libraries that were used to create this device are located at the end of the article. </blockquote><br>  The sensor, the photo of which is shown above, is a non-invasive current sensor (up to 100A).  Sensor output - current. <br>  Directly to the analog input of the Arduinka this sensor can not be connected (more precisely, you can, but it will not bring any benefit). <br>  In order to obtain adequate values ‚Äã‚Äãof the measured value, we need to add several elements and connect the sensor as follows: <br><img src="https://habrastorage.org/storage2/ac7/2af/74b/ac72af74b0bfafb1116501432e3841f0.png"><br>  The justification of the scheme and the calculation of the denominations of the elements is provided by the following <a href="http://openenergymonitor.org/emon/buildingblocks/ct-sensors-interface">link</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, the current value can be measured, but our goal is to measure the power consumption. <br>  We use the well-known formula: <b>P = U * I.</b> <br><br>  And it seems that all the values ‚Äã‚Äãin the right part are known.  But, unfortunately, the voltage value can fluctuate in rather large limits and should also be measured in a good way for more accurate results. <br><br>  Given this remark, we can immediately say that the device will not be very accurate and will most likely be some indicator with the ability to estimate the measured values, but with an error that also depends on the voltage value.  If you have a power stabilizer installed - this error decreases. <br><br>  With the connection of the sensor figured out, now we need to deal with the other components. <br><br>  The ATmega168 microcircuit and the 12x2 LCD display with Cyrillic support remained from my first steps in mastering the Arduinka - and we will use them. <br><br>  At the prototyping stage, it turned out that ATmega168 is, but there is no quartz with a pair of capacitors to it.  But, as everyone knows, atmega can safely work at a frequency of 8 MHz with an internal oscillator. <br><br>  This mode of operation is completely normal, but the accuracy of the internal oscillator is low.  For the device being created this is not critical. <br><br>  To enable this mode of MK, it is necessary to correct the fyuzy.  Physes can be changed using the Arduino environment, but this is done only at the time of the bootloader firmware. <br><br>  Components of successful firmware: <br><ol><li>  Arduinka with an Arduino ISP Stitched Sketch </li><li>  Arduinka with DIP-panel for the "experimental" MK (or bezdeeka mockup, where arduinka with minimal "body kit" is assembled) </li><li>  Several wires for connecting arduine (or arduinka and mock) </li><li>  The correct entry for the "new board" in the boards.txt file </li></ol><br><div class="spoiler">  <b class="spoiler_title">Description of option in boards.txt</b> <div class="spoiler_text">  atmega168ic8mhz.name = ATmega168 (internal clock 8MHz) <br><br>  atmega168ic8mhz.upload.protocol = stk500 <br>  atmega168ic8mhz.upload.maximum_size = 14336 <br>  atmega168ic8mhz.upload.speed = 19200 <br>  atmega168ic8mhz.upload.using = arduino: arduinoisp <br><br>  atmega168ic8mhz.bootloader.low_fuses = 0xe2 <br>  atmega168ic8mhz.bootloader.high_fuses = 0xdd <br>  atmega168ic8mhz.bootloader.extended_fuses = 0x00 <br>  atmega168ic8mhz.bootloader.path = arduino: atmega <br>  atmega168ic8mhz.bootloader.file = ATmegaBOOT_168_pro_8MHz.hex <br>  atmega168ic8mhz.bootloader.unlock_bits = 0x3F <br>  atmega168ic8mhz.bootloader.lock_bits = 0x0F <br><br>  atmega168ic8mhz.build.mcu = atmega168 <br>  atmega168ic8mhz.build.f_cpu = 8000000L <br>  atmega168ic8mhz.build.core = arduino: arduino <br>  atmega168ic8mhz.build.variant = arduino: standard <br></div></div><br>  Attention, if you have an MC with an Arduinov bootloader, then you need to update the bootloader using a quartz resonator. <br><br>  The firmware was successful, the MC earned on the internal oscillator. <br><br>  Now I had to think about how to connect the display and buttons. <br><br>  The problem is quite simple and can be connected as it is done in all examples (see links below). <br><br>  The display is connected in 4-bit mode (to save used digital pins). <br>  One of the conclusions of the display is responsible for the contrast.  I wanted to be able to adjust the contrast from the sketch.  Said and done: we connect this pin to a free pin with PWM (in addition we put an electrolytic capacitor at 10¬µF - for smoothing). <br><br>  Since it was planned to use two buttons, the simplest solution would be to hang each button on your digital pin and monitor their status, but this is somehow trivial. <br><br>  I decided to use only one pin for the buttons (analog). <br><br>  The scheme is very simple - the buttons are turned on one after another, each resistor is parallel to each button.  Consistently with this design is another resistor.  This whole chain is connected between the "earth" and the "power".  Thus, a voltage divider is obtained. <br><div class="spoiler">  <b class="spoiler_title">Drew as I could, sorry.</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/eb4/a80/f1a/eb4a80f1a8cb1485857119366578d725.png"></div></div><br><br>  The feature of the circuit (and selected resistors) is such that it allows you to track the pressing of any of the buttons and the ‚Äúbonus‚Äù - the fact of pressing two buttons at once, which we will use when writing a sketch. <br><br>  First assembled a prototype on a solderless breadboard: <br><img src="https://habrastorage.org/storage2/e5d/03b/d9d/e5d03bd9d2d00c243be650382fb1d2ec.jpg"><br><br>  I wrote a small sketch that interrogated the sensor, made the necessary calculations and output the data to the display - everything worked as expected. <br><br>  The only surprise was that the sensor, which is not connected to the wire, the current in which we want to measure, gives non-zero values ‚Äã‚Äã- there is a small ‚ÄúDC component‚Äù (due to the imperfection of the elements between the sensor and the analog input of the MK).  Therefore, it was decided to add a simple ‚Äúautocalibration‚Äù mechanism to the sketch to eliminate it. <br><br>  Now you can go to the implementation of "in the gland." <br><br>  A printed circuit board for the sake of a single device, imkho, is inexpedient - I decided to do everything on a printed breadboard with a hinged installation. <br><br>  For the device was purchased housing.  The choice was made "by eye" (the size of the display was decisive and the fact that there should be two buttons next to it). <br><br>  Photos of some components that were used in subsequent iterations: <br><img src="https://habrastorage.org/storage2/efb/38d/60f/efb38d60fab610f6dbf470fde636873d.jpg"><br><br>  For my own convenience, I decided to make a device of two boards. <br><br>  At the top there is a display, buttons, connectors and most of the ‚Äúcrumbling‚Äù, referring to the display and the sensor. <br>  On the bottom board, there is an atmega168 chip in the socket, capacitors (for power) and a connector for connecting the programmer.  This board was almost empty. <br><br>  To connect the boards I decided to use the pin connectors: <br><img src="https://habrastorage.org/storage2/27a/c45/8ff/27ac458ff4c73136f2c8ed5088e18922.jpg"><br><br>  Of course, all the components could be placed on one board (the microcontroller should be placed under the display), but I didn‚Äôt want to do a more dense installation, and leaving the ‚Äúreserve for development‚Äù is not superfluous (even if it is not needed). <br><br>  "Sandwich" in the collection: <br><img src="https://habrastorage.org/storage2/bbe/598/414/bbe598414dfa0ff3584a3cfdb5771c02.jpg"><br><br>  It can be seen that the boards have a "tricky" configuration - this is in order not to disturb the internal "decoration" of the acquired case.  The protrusions in the body are well fixed "sandwich" inside and do not allow to hang freely in the body. <br><br>  At this stage of the project, I had to think hard, how can I now mark the holes for the display, buttons and connectors, and to do it in such a way that I would not have to make a false panel? <br><br>  The guides helped and the fact that the boards were made with a minimum gap - the backlash is almost zero. <br><br>  Marking the necessary holes produced from the inside and used the means at hand. <br><br>  He started with the buttons: he took a toothpaste and smeared the ‚Äútops‚Äù of the pushers - after that he carefully inserted the ‚Äúsandwich‚Äù into the body along the guides and achieved a print on the inside of the body. <br>  Then I drilled the holes with the drill of the required diameter using the marks obtained.  And again tried on the board - bingo!  The buttons were in place. <br><br>  Similarly, I ‚Äúsmeared‚Äù the display frame (it was still under the packaging film) and repeated the manipulations.  The result can be seen below. <br><br>  Last "fitting", everything looks bearable: <br><img src="https://habrastorage.org/storage2/52d/976/16b/52d97616bb207ce59dc04a20f238c7f3.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Nervous not to look (reverse side of the board)</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/ca7/d02/113/ca7d02113440ce861bb45cc2de8f589f.jpg"><br></div></div><br>  At first, I didn‚Äôt plan to make a connector for connecting the programmer: I thought I‚Äôd make the hardware, write all the software stuffing, go and put everything together in the case, but it turned out that simply removing the connector is more convenient than disassembling the device for each software adjustment. <br><br>  Programming the device using the programmer on FT232RL: <br><img src="https://habrastorage.org/storage2/8d8/b12/a4a/8d8b12a4a74db997bd19dcd7d2203885.jpg"><br><br>  The device is assembled (though the software has not yet been added): <br><img src="https://habrastorage.org/storage2/7e5/950/fa1/7e5950fa17d70f3683ad52ce9464032d.jpg"><br><br>  Demonstration of the device and its main features (here is the "final" version of the software): <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/6LoOl4J36_0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhg7rAbbgCZjukYxdBrll3Yx2PVNMQ" frameborder="0" allowfullscreen=""></iframe><br>  I apologize for the quality - it is very inconvenient to hold the ‚Äúcamera‚Äù with one hand and connect, press, turn on the air conditioner, etc. with the other. <br><br>  The archive with the sketch and the necessary library is available <a href="">here</a> . <br><br><h5>  Shopping list </h5><br>  I cite the links where I purchased the components.  Of course, you can find cheaper. <br><ul><li>  <a href="http://robocraft.ru/shop/index.php%3Froute%3Dproduct/product%26path%3D29%26product_id%3D66">ATmega 168</a> - 145 rubles. </li><li>  <a href="http://devicter.ru/goods/datchik-peremennogo-toka-100a">Current sensor</a> - 529 rubles. </li><li>  <a href="http://devicter.ru/goods/3-55-Jack-Socket-3-in-1-package">Jack jack 3.5mm</a> - 79 rubles.  (in a set of three, only one is needed) </li><li>  <a href="http://devicter.ru/goods/nabor-elektronnyh-komponentov-20-v-1">Resistors and capacitors</a> - 189 rubles.  (from the set you need not all) </li><li>  <a href="http://devicter.ru/goods/shtyrevyje-kontakty-dla-maketnyh-plat">Pin connectors</a> - 319 rubles.  (again, from the set you need not all) </li><li>  <a href="http://www.chipdip.ru/product/ds-261a/">Power socket</a> - 20 rubles. </li><li>  <a href="http://www.chipdip.ru/product/wh1202a-ygh-ct/">LCD display 16x2 (English-Russian)</a> - 650 rubles. </li><li>  <a href="http://www.chipdip.ru/product/tc-a109/">Clock button (h = 13mm)</a> - 19 rubles.  (2 pcs.) </li><li>  <a href="http://www.chipdip.ru/product/g1020b/">Case</a> - 88 rubles. </li><li>  <a href="http://www.chipdip.ru/product/dip-r-pcb/">Development board</a> - 870 rubles.  (not all needed) </li></ul><br>  It turns out more than 2.5 thousand rubles. <br><br>  Quite a lot, but if you take only the necessary elements (and not the sets) and purchase them in the "right" places, you can save a lot (though you will have to wait longer). <br><br>  Additionally, a prototype board, a set of connecting wires, a <a href="http://devicter.ru/goods/Foca-v2-1-FT232RL">programmer</a> , an arduinka (as an ISP programmer), etc. were used.  Since these things were previously used in this "project" only temporarily - did not include them in the cost of the device created. <br><br>  I also need a power supply unit for 5V (stabilized) - I did not include it in the price either, since I found it in my deposits and I don‚Äôt even know what device it was from. <br><br>  <b>As a result</b> : another device has been created, which makes it possible to adequately assess the current electricity consumption. <br>  The accuracy of the device is low, but when you turn on electrical consumers with known characteristics (kettle, oven, air conditioner, lamps, etc.) - the values ‚Äã‚Äãdisplayed on the display correspond quite precisely to the declared by the manufacturer (an error of about 5-10%). <br>  The device monitors both the maximum and minimum values ‚Äã‚Äãof power consumption (it is expected that the lowest consumption was recorded at night and I had 0.58 kW - computers, network storage, a refrigerator, all sorts of charges and several devices in standby mode). <br><br>  When you see the figures of current consumption - it makes you think about the efficiency of energy use and immediately want to find out, due to what you can reduce them. <br><br><h5>  useful links </h5><br><ul><li>  <a href="http://easyelectronics.ru/izmeritelnye-cepi.html">Measuring chains</a> </li><li>  <a href="http://openenergymonitor.org/emon/buildingblocks/ct-sensors-interface">Connection of current sensor to Arduino (selection of elements, basic formulas)</a> </li><li>  <a href="http://openenergymonitor.org/emon/buildingblocks/how-to-build-an-arduino-energy-monitor-measuring-current-only">Sketch for measuring the rms current and power</a> </li><li>  <a href="http://avr.roboforum.ru/calc.html">AVR fusion calculator</a> </li><li>  <a href="http://arduino.cc/en/Tutorial/ArduinoISP">Arduino as an ISP programmer</a> </li><li>  <a href="http://wiki.amperka.ru/%25D1%2581%25D1%2585%25D0%25B5%25D0%25BC%25D1%258B-%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F:%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D1%2582%25D0%25B5%25D0%25BA%25D1%2581%25D1%2582%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE-%25D1%258D%25D0%25BA%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B0">Connecting the LCD-display to Arduino</a> </li><li>  <a href="http://files.amperka.ru/datasheets/MT-16S2H.pdf">Display specification and code table</a> </li><li>  <a href="http://easyelectronics.ru/kak-sdelat-kvadratnoe-otverstie.html">How to make a rectangular hole in the body</a> </li></ul><br><br>  PS It was already thought that the nrf24l01 + wireless module (and 3.3V power regulator for it) should be added to the ‚Äúbottom‚Äù board with a MK and the device created should be converted into a ‚Äúwireless sensor with a display‚Äù. <br><br>  PPS about the errors found in the text please report using private messages. </div><p>Source: <a href="https://habr.com/ru/post/168783/">https://habr.com/ru/post/168783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168765/index.html">Video review ultrabook (tablet) Asus Taichi 21</a></li>
<li><a href="../168767/index.html">Multi torrent rocking on the transmission</a></li>
<li><a href="../168769/index.html">Software development for Nexus 7</a></li>
<li><a href="../168771/index.html">Porting Android apps to BlackBerry 10</a></li>
<li><a href="../168773/index.html">Manage Windows services using PowerShell. Part 4. Changing services using WMI</a></li>
<li><a href="../168785/index.html">Nokia and the Elop effect: continued</a></li>
<li><a href="../168787/index.html">The simple answer to the difficult question: Why does not work?</a></li>
<li><a href="../168789/index.html">TPB AFK</a></li>
<li><a href="../168791/index.html">Installing and configuring KVM running CentOS 6</a></li>
<li><a href="../168795/index.html">Autopsy Meizu MX2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>