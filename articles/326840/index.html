<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mustached shooter with a polygonal belly. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story about the development of the project is similar to the web: everywhere there are threads of associations, stories about interesting ideas. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mustached shooter with a polygonal belly. Part two</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/c29/cf0/752/c29cf07524e54d57a666c4ffb9ee718c.png"></p><br><p>  The story about the development of the project is similar to the web: everywhere there are threads of associations, stories about interesting ideas.  And sometimes the threads of the story wrapped in a cocoon around an unusual bug.  And now, the material has accumulated so much that you have to start working on the second part of the article before the first one is published. </p><br><blockquote>  And now, when the second part is published, there is enough material for the third part!  :) </blockquote><p>  Today in the program: a mixture of visual and architecture of the project.  But first, a couple more details about the shadows. <br>  So let's go! </p><a name="habracut"></a><br><h2 id="stati">  Articles </h2><br><ul><li>  <a href="https://habrahabr.ru/post/322262/">First part.</a>  <a href="https://habrahabr.ru/post/322262/">Mustached shooter of twenty-three polygons.</a> </li><li>  The second part of.  Mustached shooter with a polygonal belly. </li></ul><br><h2 id="oglavlenie">  Table of contents </h2><br><ul><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Shadow manager</a> </li><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Architecture Refactoring</a> </li><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Refactoring game objects</a> </li><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Death effect</a> </li><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Stain effect</a> </li><li>  <a href="&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiOH03jphVwTjoHmDJFh7fyjKHXkg#img-width40-height44-src">Tile rendering</a> </li><li>  <a href="https://habrahabr.ru/post/326840/">The conclusion of the second part</a> </li></ul><br><h2 id="img-width40-height44-srchttpshabrastorageorgweb9cf605c399cf605c393044a5c8634fe30e74663fcpnglevel-34-menedzher-teney"><img width="40" height="44" src="https://habrastorage.org/web/9cf/605/c39/9cf605c393044a5c8634fe30e74663fc.png">  Level 3.4.  Shadow Manager. </h2><br><p>  As you remember, shadows are already generated on the CPU with a bunch of optimizations.  But their drawing needs to be improved.  While I was dealing with generation, I needed the simplest rendering method, so everything works like this: </p><br><ol><li>  Each object casting a shadow has two children, which render shadows with different shaders (one is back only - faces, the other is front); </li><li>  On the stage is a huge sprite, which is drawn the latest, and tinted in the desired color, if the stencil non-zero value. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Guess what problems it causes?</b> <div class="spoiler_text"><ol><li>  The simplest is duplication of objects (two identical descendants of each element).  Getting rid of them by making a two-pass shader is not an option, since  Objects with multipass shaders do not know how to batch; </li><li>  Further, the ability to make only one light source with shadows; </li><li>  Very meager opportunities for working with light (because in fact, there is no light, only a shadow).  So you can make a color shade, but color lighting does not; </li><li>  Stencil buffer is occupied entirely and cannot be used for other effects. </li></ol></div></div><br><p>  The idea is simple: render the shadow rendering in a separate passage, adding the ability to cast shadows to any number of light sources (yes, fps will sag). </p><br><p>  In total, several classes were required: </p><br><ul><li>  <strong>LightSource</strong> , a flashlight with an infinite range, adjusting the colors of the shadow and lighting; </li><li>  <strong>IShadowSource</strong> , an interface with a shadow conversion function void RebuildShadow (Vector3 lightPosition); </li><li>  <strong>ShadowRenderer</strong> , which registers all sources of light and shadows and is able to render shadows. </li></ul><br><p>  The code is written, shaders are checked, you can move on.  And then the problems started. <br><img src="https://habrastorage.org/web/5e0/aec/7cb/5e0aec7cb70c43be83b8fe0df606f377.png" alt="Shoals with shadows"><br>  <em>Faded shadows.</em> </p><br><p>  The image above has two problems. </p><br><p>  First, the shadows are too long and sometimes incorrectly overlap objects.  This may be if the shadows are rendered on top of an empty z-buffer (other objects may overlap the shadow, but the shadows themselves do not write anything in z-buffer). </p><br><p>  Secondly, the shadows in some strange noise.  This happens if you work with an uncleaned buffer. </p><br><p>  So, the problem is that the z-buffer with which I work, apparently, was not used by the camera.  Frame rendering now works like this: </p><br><ol><li>  Rendering a scene in RenderTexture; </li><li>  Shadow rendering, depth-buffer is taken from item 1, and color-buffer is yours (more on this below); </li><li>  Compositing shadows and rendered scenes; </li><li>  Post effects </li></ol><br><div class="spoiler">  <b class="spoiler_title">About separate use of buffers.</b> <div class="spoiler_text"><p>  When working with post-effects it is often necessary to transform a texture using some kind of shader.  In Unity3D, there is a <a href="https://docs.unity3d.com/ScriptReference/Graphics.Blit.html">Graphics.Blit</a> method for this.  We pass the original texture to it, specify the target - where to draw, the material and even the passage of the shader. <br>  In fact, we work with at least three different buffers: </p><br><ol><li>  The original color buffer, from where we read the colors of the pixels; </li><li>  The target color buffer where we write the colors; </li><li>  Depth + stencil buffer to which we write (and from which we read the depth and data of stencil). </li></ol><br><p>  And in the <em>Graphics.Blit</em> method, the target color buffer and depth buffer are inseparable.  That is, if we need, for example, to read the depth of the scene's geometry from the source texture, and write pixels to the target texture, a bummer. </p><br><p>  Or if we rendered the scene into texture, part of the shaders have written the data to the stencil, and now we want to get a new texture, using this data (and retaining the original texture!) - also a bummer. </p><br><p>  There is a solution in the Unity3D documentation about this explicitly stated: </p><br><blockquote>  If you want to use the same texture as the depth of the texture, it is possible to use it. (GL.LoadOrtho), setup material pass (Material.SetPass) and draw a quad (GL.Begin). </blockquote><p>  In general, a modified version of Blit, which allows to separate the transfer of buffers: </p><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Blit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RenderBuffer colorBuffer, RenderBuffer depthBuffer, Material material</span></span></span><span class="hljs-function">)</span></span> { Graphics.SetRenderTarget(colorBuffer, depthBuffer); GL.PushMatrix(); GL.LoadOrtho(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, passCount = material.passCount; i &lt; passCount; ++i) { material.SetPass(i); GL.Begin(GL.QUADS); GL.TexCoord(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); GL.Vertex3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); GL.TexCoord(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); GL.Vertex3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); GL.TexCoord(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); GL.Vertex3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); GL.TexCoord(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); GL.Vertex3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); GL.End(); } GL.PopMatrix(); Graphics.SetRenderTarget(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre> <br><p>  Use in code: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RenderShadowEffect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RenderTexture source, RenderTexture target, LightSource light</span></span></span><span class="hljs-function">)</span></span> { shadowEffect.SetColor(<span class="hljs-string"><span class="hljs-string">"_ShadowColor"</span></span>, light.ShadowColor); shadowEffect.SetColor(<span class="hljs-string"><span class="hljs-string">"_LightColor"</span></span>, light.LightColor); shadowEffect.SetTexture(<span class="hljs-string"><span class="hljs-string">"_WorldTexture"</span></span>, source); shadowEffect.SetTexture(<span class="hljs-string"><span class="hljs-string">"_ShadowedTexture"</span></span>, target); Blit(target.colorBuffer, source.depthBuffer, shadowEffect); }</code> </pre> </div></div><br><p>  So what is the matter?  Why is my RenderTexture, in which I render the camera on the output completely empty (and not even cleared of garbage)? </p><br><p>  Turn off the shadows and see what the frame debug shows: </p><br><p><img src="https://habrastorage.org/web/8f2/b3c/992/8f2b3c99283d46a78282e473a00f6ba1.png"><br><img src="https://habrastorage.org/web/176/486/f33/176486f33a6d4c57b47767ae8a163531.png"><br>  <em>Strange render textures.</em> </p><br><p>  Curious.  Apparently, the post-anti-aliasing effect forces the camera to render into its texture.  At the same time, I don‚Äôt have access to this texture: when debugging in Camera.activeTexture is empty. <br>  Ah, so, antialiasing!  Climb into my drawing sequence?  Then I will get into your code! </p><br><p>  The post effects work through the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnRenderImage.html">MonoBehaviour.OnRenderImage</a> method, and I through the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnPreRender.html">MonoBehaviour.OnRenderImage</a> and <br>  <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnPostRender.html">MonoBehaviour.OnPostRender</a> .  I make a dirty hack: rename OnRenderImage to Apply and call it with my hands, after rendering the shadows, with my renderTexture.  Now antialiasing does not interfere with shadows. </p><br><p>  New shadows allow you to make funny, but not very necessary things like chromatic aberration or smooth shadows. <br><img src="https://habrastorage.org/web/ba3/74f/254/ba374f2547a847b9b439c2d17b4eee29.png"><br>  <em>Hundreds of ordinary pale shadows with a slight offset.</em> <br><img src="https://habrastorage.org/web/0d3/71f/f73/0d371ff73d4d4391bbd241c37950e83d.png"><br>  <em>Three colored shadows.</em> </p><br><p>  While the shadows slow down on mobile phones (eat about 10 - 15 extra fps).  If everything is sad, at the end I will translate everything into single-pass rendering, but for now I will not lean on light sources. </p><br><blockquote>  Hint: improvise in debugging graphics!  Debugging vertex shaders can be painful, so visualize all the data you can: pull vertices along the normals, add color and transparency, etc. <br><img src="https://habrastorage.org/web/4ff/7aa/c21/4ff7aac2135543ca99427bbc62584deb.png"><br>  <em>Debash visualization through shaders and gizmos.</em> </blockquote><p>  It turned out that adding new classes became harder due to some unsuccessful design decisions. <br>  <em>Todo: clean the architecture and code of the project</em> </p><br><h2 id="img-width40-height44-srchttpshabrastorageorgweb393c7465a393c7465aa104b6f82d21abe6fb2c4a2pnglevel-41-refaktoring-arhitektury"><img width="40" height="44" src="https://habrastorage.org/web/393/c74/65a/393c7465aa104b6f82d21abe6fb2c4a2.png">  Level 4.1.  Refactoring architecture. </h2><br><p>  As you remember, I am developing a project with a prototype.  But you don‚Äôt want to pull all the prototype architecture (do you know which architecture in the prototypes written in 2 hours?), So you need to refactor. </p><br><p>  So: </p><br><p>  First of all, I <em>am putting</em> as much data as possible from <em>MonoBehaviour</em> to <em>ScriptableObject</em> .  This is all sorts of styles, settings, library prefabov; </p><br><p><img src="https://habrastorage.org/web/b1d/afd/f14/b1dafdf1435347b1811fe3d1a159b062.png"><br>  <em>Project Settings.</em> </p><br><p>  I break all logic into small classes, for example, <em>BulletCaster</em> or <em>MovableObject</em> .  Each of them contains the necessary settings and pursues only one goal. </p><br><div class="spoiler">  <b class="spoiler_title">These classes have a very simple interface.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BulletCaster</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CastBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 direction</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovingBody</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Direction {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsStopped {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} }</code> </pre> </div></div><br><p><img src="https://habrastorage.org/web/d63/3ef/7ee/d633ef7eef974593b159fe6e4471997d.png"><br>  <em>From microclasses you can collect complex logic.</em> </p><br><p>  I remove direct dependencies on singletons (Clock, ShadowManager, etc.) and implement the service locator pattern (a somewhat controversial thing, but far more accurate than scattering singletons). </p><br><p>  I implement collision processing through layers, optimizing them, clearly removing impossible collisions (for example, static &lt;-&gt; static). </p><br><p>  I optimize the creation of objects by writing a global pool.  I think this is another bike, but I wanted to write it with my own hands.  The pool is able to create objects by prefab key, initialize them after creation, notify objects about creation / deletion. </p><br><div class="spoiler">  <b class="spoiler_title">And once with a pool there was an amusing incident.</b> <div class="spoiler_text"><p>  My bullets have a life time limit (about 10 seconds of unfrozen time).  A strange bug appeared once: some of the bullets disappeared right in the air, as if the cooldown was advancing ahead of time and the bullet disappeared on a timer. </p><br><p>  It was difficult to catch: not all the bullets disappeared, and debazhit each, hoping that at least one will disappear - very tiring. </p><br><p>  However, we managed to find out two strange facts: </p><br><ol><li>  The bullets began to disappear only after the level was restarted; </li><li>  The code responsible for removing bullets was not called at all. </li></ol><br><p>  The most important rule once again did not let down: </p><br><blockquote>  The stranger the bug seems, the more stupid its causes. </blockquote><p>  So enjoy: </p><br><ol><li>  Levels are recreated on the same stage, without rebooting; </li><li>  When creating a level, I forgot to delete old walls (because the level is the same, it was not visible anywhere except in the hierarchy; </li><li>  When the bullet touched such a double wall, the collision handler was called twice; </li><li>  In the collision handler, the bullet is removed (added to the pool).  Thus, in the pool data there were two references to the same bullet; </li><li>  After some time, the player fired this bullet; </li><li>  When trying to shoot again from the pool, a link was taken to the already active, flying bullet.  She reinitialized, changed her coordinates and the ‚Äúprevious‚Äù bullet disappeared right in the air. </li></ol><br><p>  Of course, such a mistake could be without the old walls, with complex collisions.  Therefore, I added checks for object activity during collisions and, of course, began to remove old walls. </p></div></div><br><p>  I recall the problem with the uncomfortable touch and implement TouchManager.  He remembers the last touch and tracks only his.  It keeps the last N movements, ignoring too short ones (finger trembling).  At the moment when the finger or the mouse stopped touching the screen, the manager calculates the direction and length of the gesture.  If the gesture is too short - the manager ignores it: the player changed his mind, without choosing a clear direction. </p><br><p>  Now the code has become more readable, adding new classes has become easier, and the feeling that the architecture of the project will collapse when adding the latest feature before the release has disappeared. <br>  You can return to art and game logic.  In truth, the logic of the game would do well to clean up. </p><br><p>  <em>Todo: think about the gameplay elements, clarity and simplicity of the gameplay for the player.</em> </p><br><h2 id="img-width40-height44-srchttpshabrastorageorgweb0804a829a0804a829a9824c6e81bd07cf223a7dbbpnglevel-42-refaktoring-igrovyh-obektov"><img width="40" height="44" src="https://habrastorage.org/web/080/4a8/29a/0804a829a9824c6e81bd07cf223a7dbb.png">  Level 4.2.  Refactoring game objects </h2><br><p>  When I was thinking about the gameplay features, I was fascinated by the huge amount of possibilities.  Judge for yourself, all objects can have four orthogonal characteristics: </p><br><ol><li>  Does the bullets reflect or absorb them? </li><li>  Will we destroy the object with a bullet? </li><li>  Is it moving or static? </li><li>  What is the type of object (player / enemy / civil)? </li></ol><br><p>  All these characteristics can be combined and even changed on the fly.  But how to show it to the player?  At first my list of objects looked like this: </p><br><ol><li>  <em>Ordinary walls</em> .  Absorb the bullets; </li><li>  <em>Mirror walls</em> .  Reflect bullets; </li><li>  <em>High-rise walls</em> .  Each floor is plain or mirror.  When a bullet hits the ground floor is destroyed, the top fall down.  So you can do counters, etc .; </li><li>  <em>The boxes</em> .  Dynamic, but indestructible, absorb bullets; </li><li>  <em>Mirror boxes</em> .  Dynamic, but indestructible, reflect bullets .; </li><li>  <em>Chickens</em>  Dynamic, destructible, the player loses points when they die; </li><li>  <em>Enemies</em> .  Dynamic, destructible, you need to defeat all to pass the level; </li><li>  <em>Mirror enemies</em> .  Ordinary enemies, but the bullet, destroying the enemy, is reflected; </li><li>  <em>Crystals</em>  Dynamic, destroyed by a bullet, if a player touches them, he gets a bonus; </li><li>  <em>Player</em> </li></ol><br><p><img src="https://habrastorage.org/web/b82/d34/f79/b82d34f79a9144d494d4907e3cd57e07.png"><br>  <em>All available objects.</em> </p><br><p>  I will obviously have problems with clear visualization of all this beauty.  When I started working on a low-poly version, I planned to use simple color coding: </p><br><ol><li>  The color of the edge determines the type of object; </li><li>  The white color of the ceiling indicates a static object (wall), the ceiling tinted in the edge color is dynamic. </li></ol><br><p>  For example, a gray edge means that the object will absorb a bullet, purple - will reflect.  But it turns out that the color of the edge must encode a lot of properties.  Too hard.  I find the types of objects with obvious problems: </p><br><ol><li>  High-rise walls.  When only one floor remains, it will not differ from a regular wall.  But he will be destroyed.  Or not?  Very illogical feature; </li><li>  Mirror boxes.  The bullet always moves at the same speed.  Reframe from the boxes, it will accelerate them endlessly and unpredictably; </li><li>  Mirror enemies.  We'll have to use a different color, not like either the "enemy" or the "mirror".  This entity only confuses all the cards. </li></ol><br><p>  Total remains: </p><br><ol><li>  Two types of walls, ordinary and mirror; </li><li>  Player; </li><li>  Chickens; </li><li>  Enemies; </li><li>  Crystals; </li><li>  The boxes. <br><img src="https://habrastorage.org/web/4ea/af1/fad/4eaaf1fadd5a4acf8bf2720552df7285.png"><br>  <em>Objects remaining after cleaning.</em> </li></ol><br><p>  Everything is well coded with color, there are few objects, but there is room for level design. </p><br><p>  Now, when I decided on the game entities and cleaned the code from garbage, you can bring the graphics to the final state.  These are effects and physics, and all sorts of interface elements.  In short, a lot of work. </p><br><p>  <em>Todo: start developing release effects.</em> </p><br><h2 id="img-width40-height44-srchttpshabrastorageorgweba2964bdf0a2964bdf0ef44e45894126b0aa3b0941pnglevel-51-effekt-gibeli"><img width="40" height="44" src="https://habrastorage.org/web/a29/64b/df0/a2964bdf0ef44e45894126b0aa3b0941.png">  Level 5.1.  The effect of death. </h2><br><blockquote>  The exact, verified gesture and move is made.  The bullet flies, is reflected from the wall, passes in a few pixels from the player, touches the edge of another reflector and again changes direction.  Now it is aimed at the last opponent on the map.  The move is over.  New move, waiting for victory.  The direction is no longer important: the past bullet will do its job.  So, the laws of geometry are relentless and the projectile finds its goal.  The bullet touches the enemy ... And the enemy just disappears.  Here is a bummer. </blockquote><p>  Yes, I want some fan when hit by a bullet.  To the game visually said: </p><br><ul><li>  "Yes, man, you did it! You figure it out in hell grandmother!" <br>  Or vice versa: </li><li>  "Careful, careful ... Noooo! You were so close, and now you have to go through everything again!" </li></ul><br><p>  But now when the bullet hits, the elements simply disappear.  I try to make a smooth immersion of objects through the floor.  It looks slow and unnatural, and yet, it is not clear that the object has already been destroyed and it is impossible to interact with it. </p><br><p>  Okay, what is required of the effect of doom? </p><br><ol><li>  It should be bright, tangible and meaningful; </li><li>  The consequences of death must be visible throughout the entire level, helping to plan for the passage, but not distracting. </li></ol><br><p>  Splinters!  Let the bullet breaks opponents into pieces!  Hmm, is it not difficult?  Nope, all objects are convex, and cutting convex polygons is a pleasure. </p><br><p>  In fact, I just can‚Äôt cut the enemy in half.  It consists of several meshes: </p><br><ol><li>  The inner part, a convex polygon, everything is simple; </li><li>  Color ring.  It is not only not convex, and even with a hole.  But it consists of N (where N is the number of sides) of convex quadrilaterals.  So just save them in an array and cut each of them; </li><li>  Outer side.  In fact, this is the outer side of the quadrilaterals from the previous paragraph.  But I will work with it as with a large convex polygon - for rendering side faces and physics through PolygonCollider2D. </li></ol><br><p><img src="https://habrastorage.org/web/02f/7f5/be0/02f7f5be077a4e2ab2d02d73cdf85a6f.png"><br>  <em>Parts of the object that need to be cut separately.</em> </p><br><p>  As a result, the algorithm is as follows: </p><br><ol><li>  I transform an object (player, enemy, etc.) into the inside, an array of pieces of the ring, the outside.  In the future I will call this structure "Piece"; </li><li>  I find the geometric center for the Piece; </li><li>  I choose a random direction and ‚Äúlead‚Äù a straight line in this direction through the geometric center; </li><li>  Piece cut this straight.  To do this, take each polygon of the Piece (ring, inner and outer parts or their pieces): <br>  4.1.  I create the <em>left</em> and <em>right</em> array of points; <br>  4.2.  I specify the <em>current</em> array - <em>left</em> ; <br>  4.3.  I add the first point of the polygon to the <em>current</em> array; <br>  4.4.  I go through all the remaining points; <br>  4.5.  If the current and previous points are on the same side of a straight line, add the current point to the <em>current</em> array; <br>  4.5.  If the current and previous points are from different sides of the line, I find the intersection point, add it to both the <em>left</em> and <em>right</em> arrays.  I switch the <em>current</em> array to the opposite.  I add the current point to the new <em>current</em> array. </li><li>  I add all the <em>left</em> shards to the new <em>left</em> Piece, and the <em>right</em> to the <em>right</em> ; </li><li>  Dream cut the resulting fragments recursively, to the specified depth. </li></ol><br><p>  With each cut, I divide the objects into two parts, so with three cuts, 8 fragments are obtained.  It would be possible to "play" a little with depth, but also so beautiful. </p><br><p>  I modify the creation code of the mesh, the collider and the shadow of the polygon so that it can also create fragments at specified points. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/z_ET6lkb3-w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>I get about such fragments.</em> </p><br><blockquote>  At first, I planned to make cached partitions and use only them, but it turned out that real-time splitting does not cause brakes, but looks more effective. <br><br>  The fragments revealed a nasty bug with shadows: I looked for the silhouette points on the polygons incorrectly.  Because of this, in the previous video, part of the fragments cast shadows only partially.  Corrections are already available in the previous article. </blockquote><p>  So, now when a bullet hits a target, I replace the latter with shards.  The object is removed to the pool, and the fragments are loaded from the pool and update their meshes / colliders according to their new form.  The velocities for rigidBody are calculated based on the speed of the destroyed element and the direction of the bullet.  The splinters are off the isBullet flag, they only interact with the walls and with each other.  Each fragment has a special class FloorHider, it lowers the object along the z coordinate through the floor, and after its complete disappearance, it deletes (moves to the pool.) </p><br><p>  A small retrospective: </p><br><ol><li>  Shards - very "physically" understandable image.  Therefore, it helps to understand the concept of stopping time.  Shards begin to scatter, then time stops and everything stops.  The game stopped looking deterministic step by step; </li><li>  All the fragments are trapped with each other and do not inhibit; </li><li>  The crystal is now removed when touched with no effects.  Maybe also break into pieces? </li><li>  There is not enough of a trace after the destruction, I want to keep the level of the consequences of the attacks; </li><li>  Fano looks, I want to shoot! </li></ol><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Us-3WS2y0oM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>Splinters!</em> </p><br><p>  Enemies scattering into pieces is a very effective touch, but it is spoiled by the fact that the fragments disappear without any trace.  There are several reasons, besides showiness, why should I add these traces. </p><br><p>  <em>Todo: realize the effect of splinter marks.</em> </p><br><h2 id="img-width40-height44-srchttpshabrastorageorgweb7adf1cf747adf1cf74a59468491e43d3482e551f5pnglevel-521-effekt-pyaten"><img width="40" height="44" src="https://habrastorage.org/web/7ad/f1c/f74/7adf1cf74a59468491e43d3482e551f5.png">  Level 5.2.1.  The effect of stains. </h2><br><blockquote>  When I was thinking about a visual, the idea of ‚Äã‚Äã"blood stains" spun in my head, which would appear if a player or npc died.  On long levels, such spots will become convenient labels for navigation.  And in case of loss, they will help to assess the initial position of the enemies and think about the tactics of re-passing. </blockquote><p>  So the spots.  I discard the option with decals and rendered textures: it seems to me that this is how I will get out of style.  I try to display the trace of the fragments or the place of their disappearance.  It looks bad: </p><br><p><img src="https://habrastorage.org/web/09d/a02/edd/09da02eddd3341f99fdaa225c21f10c6.png"><br><img src="https://habrastorage.org/web/905/ab3/d92/905ab3d92398464eb76c2550399b18f5.png"><br>  <em>Different varieties of spots.</em> </p><br><p>  I think about a full fill, among the options I prototype this: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6XhrpuRBhXI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>Just creating heaps of triangles.</em> </p><br><p>  Yes, I liked this option more.  But creating lots of triangles with wild overdraw is a bad idea.  However, the result is similar to a mosaic, so I think in the direction of the Voronoi diagram. </p><br><p>  That's just generate it on the fly, especially with the subsequent relaxation of Lloyd (relaxation makes the cells similar in size) on mobile devices will be too painful.  Prejudice is needed.  And hence another problem: the spots can be at any distance from each other, and I, obviously, cannot predict an infinitely large diagram.  Do you know what tiling is?  :) </p><br><p>  For a start, I find a suitable <a href="https://forum.unity3d.com/threads/delaunay-voronoi-diagram-library-for-unity.248962/">library</a> for generating a Voronoi diagram. </p><br><p>  Now I understand tiling.  It would be an ideal solution to build a diagram directly on a torus, but you really don't want to go into the jungle of the library or even write your own.  Therefore, I come up with the following algorithm: </p><br><ol><li>  I create N points in a square with coordinates {-0.5, -0.5, 0.5, 0.5}; </li><li>  For each Y in the interval [-tiles, tiles] and X in the interval [-tiles, tiles], except for X = 0, Y = 0: <br>  2.1.  I copy the points with the X, Y offset (at tiles = 1, I get 9 tiles with my initial one in the center); </li><li>  I build a Voronoi diagram over all points (including offset clones); </li><li>  I apply, if necessary, the relaxation of Lloyd; </li><li>  I go through all the resulting polygons and leave only those whose center is in the source square {-0.5, -0.5, 0.5, 0.5}. </li></ol><br><p>  As a result, a tile with polygons is obtained, in which the left side ideally goes to the right, the top one - to the bottom (with diagonals - in a similar way).  In fact, not everything is so smooth. <br>  The idea is that the Voronoi diagram is a very local thing, so you can emulate a torus by making several copies of the original points in all directions.  But Lloyd‚Äôs relaxation is certainly not local, and the more iterations there are, the more copies need to be made (increasing the value of tiles). </p><br><p>  Yes, and the coordinates of the centers do not always work correctly to check, after all, a floating point.  Therefore, sometimes, very rarely, on the edge of the mosaic, an element is missing. <br><img src="https://habrastorage.org/web/91b/c2d/8ab/91bc2d8ab3a7472aa35af97f5fec9c56.png"><br>  <em>Find repetitions?</em> </p><br><div class="spoiler">  <b class="spoiler_title">hint</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/web/490/1fe/f5d/4901fef5d2e04282a796c46c37f1738a.png"></p></div></div><br><p>  So, it turns out about a piece of mosaic: <br><img src="https://habrastorage.org/web/117/0ad/8be/1170ad8bec854c34bef8756b7bc2a524.png"><br>  <em>Mosaic is rendered on the texture of the library.</em> </p><br><p>  I make a small ScriptableObject that stores an array of calculated tiles and an editor with a large "recalculate tiles" button. </p><br><blockquote>  Problems with rare holes due to float in checks for a polygon hit a tile I decided to regenerate incorrect tiles.  Since  I make prejudices once, with my hands in the editor, I can afford it.  :) </blockquote><p>  Now to display these tiles on the screen! </p><br><p>  <em>Todo: generate mosaic tile triangles.</em> </p><br><h2 id="img-width40-height44-srchttpshabrastorageorgweb4479a83b34479a83b3791422a87016b00f99b53f9pnglevel-522-rendering-taylov"><img width="40" height="44" src="https://habrastorage.org/web/447/9a8/3b3/4479a83b3791422a87016b00f99b53f9.png">  Level 5.2.2.  Tile rendering. </h2><br><p>  Assume that the spot will be perfectly round and I know its coordinates and radius.  You need to somehow get all the polygons that are inside this spot.  In addition, the stain may appear in any coordinates, so the mosaic needs to be virtually tinted. </p><br><p>  To test the algorithm, I created such a "mosaic", it will be easier to find problems with it: <br><img src="https://habrastorage.org/web/54f/85f/c1c/54f85fc1c3e34a11a90100e8e662a785.png"><br>  <em>Fake mosaic</em> </p><br><p>  Suppose I have a mosaic generated from 512 points.  So, the output will be 512 polygons and checking each one for intersection with the circle is too expensive.  Therefore, I keep the mosaic in the form of small rectangular blocks: <br><img src="https://habrastorage.org/web/7a1/fb0/86a/7a1fb086a723448293f3e8dea983f1f4.png"><br>  <em>Visualization of blocking.</em> <br>  Knowing the area of ‚Äã‚Äãthe mosaic and the number of polygons, you can get the optimal number of blocks at which the search speed will be maximum. </p><br><p>  So, the search logic is as follows: </p><br><p>  Given a circle with coordinates <em>center</em> and radius <em>radius</em> .  You need to find all the polygons that fall into the circle. </p><br><ol><li>  From the AABB circle, we calculate the coordinates of the first and last blocks that fall into AABB (Coordinates may be less than 0 or more rows - 1 due to tiling). <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rectSize = size / (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)rows; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minX = Mathf.FloorToInt((center.x - radius) / rectSize); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minY = Mathf.FloorToInt((center.y - radius) / rectSize); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxX = Mathf.CeilToInt((center.x + radius) / rectSize); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxY = Mathf.CeilToInt((center.y + radius) / rectSize);</code> </pre> </li><li>      min  max; </li><li>  ,    ; </li><li>      : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> innerX = ((x + rows) % rows + rows) % rows; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> innerY = ((y + rows) % rows + rows) % rows;</code> </pre> </li><li>      ; </li><li>     ,     (  ). </li></ol><br><p> ,         ,    : <br><img src="https://habrastorage.org/web/f4b/b72/a84/f4bb72a847bb438cb520445c7a06dcf6.png"><br> <em> .      </em> </p><br><p>       ,        ‚Äî  .    : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/k_dNEXn6wDo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p> ,  , .  ,          , , {0, 0}  {1, 1},   . </p><br><p>  ,      : </p><br><ol><li>   ,    ; </li><li>    ; </li><li>      . </li></ol><br><p>    : <br>       : <br><img src="https://habrastorage.org/web/d92/744/e73/d92744e730e54e13bc8d19cb1bd31129.png"><br> <em>Points = 500, Relax = 5</em> </p><br><p>     ,     . <br>   : <br><img src="https://habrastorage.org/web/b16/23a/630/b1623a6304a44528a1f3d3f64191cb47.png"><br> <em>Points = 500, Relax = 0</em> </p><br><p>     :  <em></em>  ,    ,  ,    : <br><img src="https://habrastorage.org/web/fe4/845/b61/fe4845b61bf14d7b85f840f0ef918294.png"><br> <em>Triangles, Points = 500, Relax = 0</em> </p><br><p>     . ,    , , :   ,      . -    "",            ,    : <br><img src="https://habrastorage.org/web/374/33e/a24/37433ea24151468280fd4ef1b0f07b46.png"><br> <em>      .</em> </p><br><p> ,   ‚Äî       .    ,      :      -: <br><img src="https://habrastorage.org/web/c20/396/8a4/c203968a42c645b89edb14838c9771a6.png"><br> <em>   .</em> </p><br><p> :      ,     .            .   ,    "" . </p><br><p> <em>Todo:        .</em> </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  ,   .            ‚Äî  ,    .   ,     (  ),     . </p><br><p> ,   : </p><br><ol><li>   .    (  )   ,        ; </li><li> <em> :     ,  ,     .</em>  ,   .  :) </li><li> Unity3D  ,      .       ‚Äî   frame debug, ,   Unity3D      (    msaa). </li></ol><br><p>          ,   ,      . </p><br><p>   ,     feedback'a! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326840/">https://habr.com/ru/post/326840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326826/index.html">Bash Scripts, Part 5: Signals, Background Tasks, Script Management</a></li>
<li><a href="../326828/index.html">Permafrost, coal mine and piqlFilm: a new approach to data storage and protection</a></li>
<li><a href="../326830/index.html">We write Telegram-bot on Rust, which will run the code on ... Rust?</a></li>
<li><a href="../326832/index.html">How to approach the analysis of the site in terms of a hacker and identify vulnerabilities?</a></li>
<li><a href="../326834/index.html">Amateur CNC?</a></li>
<li><a href="../326846/index.html">A simple error in coding does not mean a non-fearful error.</a></li>
<li><a href="../326848/index.html">Android application performance</a></li>
<li><a href="../326852/index.html">Cooking Physically Based Rendering + Image-based Lighting. Theory + practice. Step by step</a></li>
<li><a href="../326854/index.html">TypeScript to Slack</a></li>
<li><a href="../326856/index.html">How to make your C ++ code cross-platform?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>