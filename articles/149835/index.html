<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simplify registration and work with DependencyProperty</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working with WPF / Silverlight, periodically you have to create custom DependencyProperty, mainly when creating controls. The standard approach o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simplify registration and work with DependencyProperty</h1><div class="post__text post__text-html js-mediator-article">  When working with WPF / Silverlight, periodically you have to create custom DependencyProperty, mainly when creating controls.  The standard approach of advertising and working with them is not perfect and has disadvantages, which will be discussed below.  Accordingly, the idea was to simplify the recording of registration and work with the DependencyProperty. <br><a name="habracut"></a><br>  To get started, here‚Äôs the standard code for the DependencyProperty declaration: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SomeDependecyObject</span></span> : <span class="hljs-title"><span class="hljs-title">DependencyObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty IntValueProperty = DependencyProperty.Register(<span class="hljs-string"><span class="hljs-string">"IntValue"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SomeDependecyObject), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIPropertyMetadata(<span class="hljs-number"><span class="hljs-number">1</span></span>, OnIntValuePropertyChanged)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IntValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)GetValue(IntValueProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(IntValueProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnIntValuePropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyObject d, DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newPropertyValue = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)e.NewValue; SomeDependecyObject instance = (SomeDependecyObject)d; <span class="hljs-comment"><span class="hljs-comment">// Perform callback action. } }</span></span></code> </pre> <br>  Disadvantages of this approach: <br><ul><li>  Specify the property name as a string.  When renaming a property, you need to remember to rename the string value. </li><li>  Static callback.  To access the class members, the d parameter must be cast to the class type.  New and old property values ‚Äã‚Äãare also non-type properties. </li><li>  At the compilation level, there is no check for the type of the property and the default value.  The Register method's propertyType parameter can accept any Type.  The defaultValue parameter is an object. </li></ul><br>  Improved version code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SomeDependecyObject</span></span> : <span class="hljs-title"><span class="hljs-title">DependencyObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty IntValueProperty = DependencyProperty&lt;SomeDependecyObject&gt;.Register(x =&gt; x.IntValue, <span class="hljs-number"><span class="hljs-number">1</span></span>, x =&gt; x.OnIntValuePropertyChanged); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IntValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)GetValue(IntValueProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(IntValueProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnIntValuePropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyPropertyChangedEventArgs&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; e</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br>  In this embodiment, the Register method accepts a property as an expression, a default value of a specific type, and not a static callback.  The callback method accepts a generic instance of the DependencyPropertyChangedEventArgs class, where the old and new property values ‚Äã‚Äãare cast to the property type.  The recording itself is also simplified.  Below is the code for the classes that allow you to apply this entry. <br><br>  Code generic generic DependecyProperty: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependencyProperty</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">DependencyObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DependencyProperty Register&lt;TProperty&gt;(Expression&lt;Func&lt;T, TProperty&gt;&gt; propertyExpression) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Register&lt;TProperty&gt;(propertyExpression, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(TProperty), <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DependencyProperty Register&lt;TProperty&gt;(Expression&lt;Func&lt;T, TProperty&gt;&gt; propertyExpression, TProperty defaultValue) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Register&lt;TProperty&gt;(propertyExpression, defaultValue, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DependencyProperty Register&lt;TProperty&gt;(Expression&lt;Func&lt;T, TProperty&gt;&gt; propertyExpression, Func&lt;T, PropertyChangedCallback&lt;TProperty&gt;&gt; propertyChangedCallbackFunc) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Register&lt;TProperty&gt;(propertyExpression, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(TProperty), propertyChangedCallbackFunc); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DependencyProperty Register&lt;TProperty&gt;(Expression&lt;Func&lt;T, TProperty&gt;&gt; propertyExpression, TProperty defaultValue, Func&lt;T, PropertyChangedCallback&lt;TProperty&gt;&gt; propertyChangedCallbackFunc) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> propertyName = propertyExpression.RetrieveMemberName(); PropertyChangedCallback callback = ConvertCallback(propertyChangedCallbackFunc); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DependencyProperty.Register(propertyName, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TProperty), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyMetadata(defaultValue, callback)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PropertyChangedCallback ConvertCallback&lt;TProperty&gt;(Func&lt;T, PropertyChangedCallback&lt;TProperty&gt;&gt; propertyChangedCallbackFunc) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propertyChangedCallbackFunc == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedCallback((d, e) =&gt; { PropertyChangedCallback&lt;TProperty&gt; callback = propertyChangedCallbackFunc((T)d); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) callback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DependencyPropertyChangedEventArgs&lt;TProperty&gt;(e)); }); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PropertyChangedCallback&lt;TProperty&gt;(DependencyPropertyChangedEventArgs&lt;TProperty&gt; e);</code> </pre><br>  This class takes as a generic parameter the type of DependencyObject and contains several overloaded Register methods.  The Register method gets its name from the property expression, converts the callback and creates a DependencyProperty by the standard method. <br><br>  DependecyPropertyChangedEventArgs class code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DependencyPropertyChangedEventArgs</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EventArgs</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DependencyPropertyChangedEventArgs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { NewValue = (T)e.NewValue; OldValue = (T)e.OldValue; Property = e.Property; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T NewValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T OldValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DependencyProperty Property { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  The code of the additional class ExpressionExtensions, which is used to get the property name by expression: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExpressionExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> RetrieveMemberName&lt;TArg, TRes&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Expression&lt;Func&lt;TArg, TRes&gt;&gt; propertyExpression) { MemberExpression memberExpression = propertyExpression.Body <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MemberExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberExpression == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { UnaryExpression unaryExpression = propertyExpression.Body <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UnaryExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unaryExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) memberExpression = unaryExpression.Operand <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MemberExpression; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ParameterExpression parameterExpression = memberExpression.Expression <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ParameterExpression; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameterExpression != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; parameterExpression.Name == propertyExpression.Parameters[<span class="hljs-number"><span class="hljs-number">0</span></span>].Name) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memberExpression.Member.Name; } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Invalid expression."</span></span>, <span class="hljs-string"><span class="hljs-string">"propertyExpression"</span></span>); } }</code> </pre></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/149835/">https://habr.com/ru/post/149835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149828/index.html">Belarusians made a drone running Linux</a></li>
<li><a href="../149829/index.html">Build system options selection panel in Sublime Text 2. (or how the bike was invented)</a></li>
<li><a href="../149830/index.html">Review and refinement of the backlight for the e-book Hama 54308</a></li>
<li><a href="../149831/index.html">Curiosity ready to budge, laser tested tonight</a></li>
<li><a href="../149833/index.html">Experts called "endangered" professions in the world</a></li>
<li><a href="../149836/index.html">Energy-saving background location + sending data to the server from the background</a></li>
<li><a href="../149838/index.html">Manage homemade iron over the air using Open Sound Control</a></li>
<li><a href="../149839/index.html">Google refuses the legendary button ‚ÄúI'm Feeling Lucky‚Äù</a></li>
<li><a href="../149844/index.html">Yii 1.1.12</a></li>
<li><a href="../149847/index.html">Do you use SIM card PIN protection?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>