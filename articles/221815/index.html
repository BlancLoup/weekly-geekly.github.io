<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create a website using Laravel and Recurly. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, Habr! After studying the first part , I started looking for the second, but it was not there, so I decided to write the translation my...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create a website using Laravel and Recurly. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, Habr!  After studying the <a href="http://habrahabr.ru/post/195690/">first part</a> , I started looking for the second, but it was not there, so I decided to write the translation myself.  So, let's begin. <br><br><h5>  Introduction </h5><br>  In the first part of this series, we created the bare backbone of the site with subscriptions based on Laravel.  We also created a website with roles and created a distribution of roles for registered users.  Now we come to the point where we can create and execute registration, authorization and exit. <br>  In this part, we will integrate Recurly to customize our paid membership plans. <br><a name="habracut"></a><br><h4>  Getting Started </h4><br>  There are two Recurly libraries - the PHP client library, which we previously installed using composer (in the first part) and Recurly JS.  Recurly JS is a client library for dynamic form integration that safely processes information from maps. <br>  The card information is placed on Recurly servers, not in our web application, which reduces our headache. <br><br>  Download the <a href="https://github.com/recurly/recurly-js/zipball/master">Recurly JS</a> library and copy the <b>recurly.min.js</b> from the build folder to the <b>public / js / libs</b> folder and add it in the layout before the closing tag: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/js/libs/recurly.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We also need to use the CSS styles that are used to display the form of payment.  Create a directory in the <b>css / recurly directory</b> and copy the themes directory into it, and then we will link to it in the appropriate section of our layout. <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/css/recurly/themes/default/recurly.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  When you log in for the first time after <a href="http://recurly.com/">creating an account with Recurly</a> , you will be <a href="http://recurly.com/">prompted</a> to create your subscription plans.  In the <a href="http://habrahabr.ru/post/195690/">first part,</a> we created three different subscription levels - bronze, silver and gold.  You can always change them or add new ones, but there is no harm in doing it now. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Create a plan called <i>Bronze</i> ;  Be careful, you need to set the code plan <u><i>‚Äúbronze‚Äù</i></u> (in lower case).  Set a price - I wrote ¬£ 4.99 per month, but you can choose any amount and / or time you like.  If necessary, you can set a one-time fee or a free trial period. <br><br>  Repeat the process two more times to tune the silver (code: ‚Äúsilver‚Äù) and gold (code: ‚Äúgold‚Äù) plans.  I set the minimum at ¬£ 9.99 and ¬£ 14.99 per month, respectively, the maximum. <br><br>  Now go to the admin panel of Recurly, where there are a few things that we need to configure, as well as find the necessary information to configure your application.  Click API access on the left side.  Click Enable API Access.  Write down your API key, and your subdomain. <br><br>  Now go to Recurly.js on the left side (under Developer).  Click Enable Recurly.js and Transparent Post API.  Write down your secret key. <br><br>  Now create the Recurly configuration file in the <b>app / config / recurly.php folder</b> , replacing the values ‚Äã‚Äãwith the ones you just wrote together with the three-digit code that displays your default currency (for example, USD, GBP, AUD): <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'api_key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'YOUR-API-KEY'</span></span>, <span class="hljs-string"><span class="hljs-string">'private_key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'YOUR-PRIVATE-KEY'</span></span>, <span class="hljs-string"><span class="hljs-string">'subdomain'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'YOUR-SUBDOMAIN'</span></span>, <span class="hljs-string"><span class="hljs-string">'default_currency'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'XYZ'</span></span> );</code> </pre><br>  We now turn to pop-up notifications on the left side.  Click the configure button.  Enter the URL of your application including <i>/ recurly</i> , for example <i><a href="http://www.example.com/recurly">www.example.com/recurly</a></i> .  Leave the HTTP authorization username (Username) and HTTP password authorization (Password) fields empty for now. <br><br><h4>  Registration page </h4><br>  Now, let's create a registration page that allows potential customers to choose a plan for themselves.  Create the <b>signup.blade.php</b> file with this <b>app app / views / home</b> with the following contents: <br><pre> <code class="php hljs">@extends(<span class="hljs-string"><span class="hljs-string">'layouts.default'</span></span>) @section(<span class="hljs-string"><span class="hljs-string">'content'</span></span>) &lt;h1&gt;Signup&lt;/h1&gt; &lt;p&gt;Please select your plan...&lt;/p&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fluid</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pricing</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">table</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pricing</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">three</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">column</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span4</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bronze</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bronze</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt;¬£4.99 / </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Month</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #1&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #2&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bronze</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">select</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">white</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ok</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Select</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span4</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">silver</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Silver</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">badge</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">badge</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">warning</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Popular</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt;¬£9.99 / </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Month</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #1&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #2&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">silver</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">select</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">white</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ok</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Select</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span4</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gold</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gold</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">h2</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt;¬£4.99 / </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Month</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #1&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Feature</span></span></span><span class="hljs-class"> #2&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">feature</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gold</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">select</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">white</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">icon</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ok</span></span></span><span class="hljs-class">"&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Select</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span></span></code> </pre><br>  Of course, if you want to provide timely price updates, then you need to use the Recurly API and fill this data in the template automatically. <br>  Now add the following lines to <b>css / style.css:</b> <br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-table</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#f3f3f3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: center; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#5e5f59</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-name-bronze</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#665D1E</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-name-silver</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#C0C0C0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-name-gold</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#FFD700</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-table-bronze</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#f89406</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-table</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-name</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">span</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-table</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ul</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">list-style</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-table</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">li</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.plan-feature</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-top</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid <span class="hljs-number"><span class="hljs-number">#c5c8c0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span> <span class="hljs-number"><span class="hljs-number">10px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-three-column</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> auto; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">80%</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.pricing-variable-height</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: inline-block; <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">margin-left</span></span>: <span class="hljs-number"><span class="hljs-number">2%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">vertical-align</span></span>: bottom; <span class="hljs-attribute"><span class="hljs-attribute">zoom</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; *<span class="hljs-attribute"><span class="hljs-attribute">display</span></span>:inline; } <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-mouseover</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.plan-name</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#4e9a06</span></span> <span class="hljs-meta"><span class="hljs-meta">!important</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.btn-plan-select</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">18px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">8px</span></span> <span class="hljs-number"><span class="hljs-number">25px</span></span>; }</code> </pre><br>  Finally, create a route in <b>app / routes.php</b> <br><pre> <code class="php hljs">Route::get(<span class="hljs-string"><span class="hljs-string">'/signup'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View::make(<span class="hljs-string"><span class="hljs-string">'home/signup'</span></span>); });</code> </pre><br><br><h4>  Payment acceptance </h4><br><br>  So we got to the point of payment, namely the registration page - payment. <br>  First, let's change the callback <b>user / register</b> POST.  Instead of redirecting to the home page, we will move the user to the payment page.  Replace these lines: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect::to(<span class="hljs-string"><span class="hljs-string">'/'</span></span>)-&gt;with( <span class="hljs-string"><span class="hljs-string">'success'</span></span>, <span class="hljs-string"><span class="hljs-string">'Welcome to the site, . Auth::user()-&gt;name . '</span></span>!<span class="hljs-string"><span class="hljs-string">' );</span></span></code> </pre><br>  on those: <br><pre> <code class="php hljs">Session::put(<span class="hljs-string"><span class="hljs-string">'register_user'</span></span>, $user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect::to(<span class="hljs-string"><span class="hljs-string">'/user/register/payment'</span></span>);</code> </pre><br>  We need to expand the default layout so that we can insert JavaScript code into the footer (bottom).  Add the following line after the last script tag: <br><pre> <code class="javascript hljs">@<span class="hljs-keyword"><span class="hljs-keyword">yield</span></span>(<span class="hljs-string"><span class="hljs-string">'scripts'</span></span>)</code> </pre><br>  Now create a new route: <br><pre> <code class="php hljs">Route::get(<span class="hljs-string"><span class="hljs-string">'/user/register/payment'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Recurly_js::$privateKey = Config::get(<span class="hljs-string"><span class="hljs-string">'recurly.private_key'</span></span>); $plan = <span class="hljs-string"><span class="hljs-string">'bronze'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">todo:</span></span></span><span class="hljs-comment"> get this from vars $user = Session::get('register_user'); $signature = Recurly_js::sign(array( 'account' =&gt; array( 'account_code' =&gt; 'user_' . $user-&gt;id ), 'subscription' =&gt; array( 'plan_code' =&gt; $plan, 'currency' =&gt; Config::get('recurly.default_currency') ) )); return View::make('user/register')-&gt;with(array( 'plan' =&gt; $plan, 'subdomain' =&gt; Config::get('recurly.subdomain'), 'currency' =&gt; Config::get('recurly.default_currency'), 'signature' =&gt; $signature )); });</span></span></code> </pre><br>  A few notes on this code: <br><ul><li>  We have to set the secret key in the <i>Recurly_js</i> class, which we will receive from the configuration file created earlier. </li><li>  We must receive the subscription data (plan) from the previous stage created in the registration.  This piece is left as an independent exercise. </li><li>  We need to create a signature (signature) for Recurly.js, using several pieces of information, including the user ID, which we create by linking the class (user) and its ID </li><li>  This signature is transmitted along with other information in this view. </li></ul><br>  The payment page consists of two parts, the first part is simple HTML: <br><pre> <code class="html hljs xml">@extends('layouts.default') @section('content') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recurly-subscribe"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> @stop</code> </pre><br>  Recurly.js injects its client-generated payment form code into this div. <br><br>  Next, we add JavaScript to the section that receives the output at the bottom of the layout template: <br><pre> <code class="php hljs">@section(<span class="hljs-string"><span class="hljs-string">'scripts'</span></span>) &lt;script&gt; Recurly.config({ subdomain: <span class="hljs-string"><span class="hljs-string">'{{ $subdomain }}'</span></span>, currency: <span class="hljs-string"><span class="hljs-string">'{{ $currency }}'</span></span> }); Recurly.buildSubscriptionForm({ target: <span class="hljs-string"><span class="hljs-string">'#recurly-subscribe'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// Signature must be generated server-side with a utility // method provided in client libraries. signature: '{{ $signature }}', successURL: '/user/register/confirm', planCode: '{{ $plan }}', distinguishContactFromBillingInfo: true, collectCompany: false, termsOfServiceURL: 'http://www.example.com/terms', acceptPaypal: true, acceptedCards: ['mastercard', 'discover', 'american_express', 'visa'], account: { firstName: 'Joe', lastName: 'User', email: 'test@example.net', phone: '555-555-5555' }, billingInfo: { firstName: 'Joe', lastName: 'User', address1: '123 somestreet', address2: '45', city: 'San Francisco', zip: '94107', state: 'CA', country: 'US', cardNumber: '4111-1111-1111-1111', CVV: '123' } }); &lt;/script&gt; @stop</span></span></code> </pre><br>  The magic happens here - Recurly builds a form of payment and displays it in a div c id <i># recurly-subscribe</i> , which requires some of the information, we have come to a form that requires generated signatures. <br>  Then, the callback that Recurly returns after successfully submitting the form, which is defined in <i>successURL with the</i> following parameters: <br><pre> <code class="php hljs">Route::post(<span class="hljs-string"><span class="hljs-string">'/user/register/confirm'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $recurly_token = Input::get(<span class="hljs-string"><span class="hljs-string">'recurly_token'</span></span>); Recurly_js::$privateKey = Config::get(<span class="hljs-string"><span class="hljs-string">'recurly.private_key'</span></span>); $result = Recurly_js::fetch($recurly_token); var_dump($result); });</code> </pre><br>  Again, we initialize Recurly.js with the secret key from the configuration, and use it to retrieve the object represented by the token that Recurly sends as the POST variable (recurly_token).  This will be an instance of <i>Recurly_Subscription</i> from which various information can be extracted.  I display this with <i>var_dump ()</i> to look at the data. <br><br>  First of all, let's get the plan code to find out what the user has subscribed to: <br><pre> <code class="php hljs">$plan_code = $result-&gt;plan-&gt;plan_code;</code> </pre><br>  Now, you need to find the appropriate role, notice - we gave them the names ‚Äúbronze‚Äù, ‚Äúsilver‚Äù and ‚Äúgold‚Äù. <br><pre> <code class="php hljs">$role = Role::where(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, $plan_code)-&gt;first();</code> </pre><br>  Then get the user from the session (and then remove him from the session): <br><pre> <code class="php hljs">$user = Session::get(<span class="hljs-string"><span class="hljs-string">'register_user'</span></span>); Session::forget(<span class="hljs-string"><span class="hljs-string">'register_user'</span></span>);</code> </pre><br>  Next, we provide the role for the appropriate new user: <br><pre> <code class="php hljs">$user-&gt;roles()-&gt;attach($role);</code> </pre><br>  Then, we must remove the deferred role: <br><pre> <code class="php hljs">$role_pending = $role_pending = Role::where(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, <span class="hljs-string"><span class="hljs-string">'pending'</span></span>)-&gt;first(); DB::table(<span class="hljs-string"><span class="hljs-string">'role_user'</span></span>)-&gt;where(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, $user-&gt;id)-&gt;where(<span class="hljs-string"><span class="hljs-string">'role_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'='</span></span>, $role_pending-&gt;id)-&gt;delete();</code> </pre><br>  Now, we have completed the registration process by accepting payments, creating subscriptions, and also applying roles for new accounts based on the plan chosen by the user. <br><br><h4>  Account Management Page </h4><br>  Let's create a simple page from which users can manage their account. <br>  Obviously, this will require the user to log in, so we must apply an authentication filter. <br>  Instead of specifying this filter for each protected page, we can put all the relevant routes into the group, like this: <br><pre> <code class="php hljs">Route::group(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'before'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'auth'</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Route::get(<span class="hljs-string"><span class="hljs-string">'/user/account'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// User must be logged in }); Route::get('user/account/billing', function() { // User must be logged in }); });</span></span></code> </pre><br>  Calling an account page is simple: <br><pre> <code class="php hljs">Route::get(<span class="hljs-string"><span class="hljs-string">'/user/account'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View::make(<span class="hljs-string"><span class="hljs-string">'user/account/index'</span></span>); });</code> </pre><br>  Now the address of the form <b>app / views / user / account / index.blade.php</b> : <br><pre> <code class="php hljs">@extends(<span class="hljs-string"><span class="hljs-string">'layouts.default'</span></span>) @section(<span class="hljs-string"><span class="hljs-string">'content'</span></span>) &lt;h1&gt;Your Account&lt;/h1&gt; &lt;ul&gt; &lt;li&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"/user/account/edit"</span></span>&gt;Edit your account information&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"/user/account/plan"</span></span>&gt;Update your subscription plan&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"/user/account/billing"</span></span>&gt;Update your Billing information&lt;/a&gt;&lt;/li&gt; &lt;/ul&gt; @stop</code> </pre><br>  Let's start with the information update billing page.  Of course, we don‚Äôt store people‚Äôs billing information, since on the payment page, Recurly will create and fill out a form for you, announcing (POSTing) new information to Recurly without it sometime near your web application. <br><pre> <code class="php hljs">Route::get(<span class="hljs-string"><span class="hljs-string">'user/account/billing'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Recurly_js::$privateKey = Config::get(<span class="hljs-string"><span class="hljs-string">'recurly.private_key'</span></span>); $account_code = <span class="hljs-string"><span class="hljs-string">'user_'</span></span> . Auth::user()-&gt;id; $signature = Recurly_js::sign( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'account'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'account_code'</span></span> =&gt; $account_code)) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View::make(<span class="hljs-string"><span class="hljs-string">'user/account/billing'</span></span>)-&gt;with(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'subdomain'</span></span> =&gt; Config::get(<span class="hljs-string"><span class="hljs-string">'recurly.subdomain'</span></span>), <span class="hljs-string"><span class="hljs-string">'currency'</span></span> =&gt; Config::get(<span class="hljs-string"><span class="hljs-string">'recurly.default_currency'</span></span>), <span class="hljs-string"><span class="hljs-string">'account_code'</span></span> =&gt; $account_code, <span class="hljs-string"><span class="hljs-string">'signature'</span></span> =&gt; $signature )); });</code> </pre><br>  This is very similar to the payment page in that we initialize the Recurly.js libraries, creating signatures (albeit using different information) and passing through several parameters into the view. <br>  Path <b>app / views / user / account / billing.blade.php</b> <br>  follows pretty much the same pattern on the payment page: <br><pre> <code class="php hljs">@extends(<span class="hljs-string"><span class="hljs-string">'layouts.default'</span></span>) @section(<span class="hljs-string"><span class="hljs-string">'content'</span></span>) &lt;div id=<span class="hljs-string"><span class="hljs-string">"recurly-billing"</span></span>&gt; &lt;/div&gt; @stop @section(<span class="hljs-string"><span class="hljs-string">'scripts'</span></span>) &lt;script&gt; Recurly.config({ subdomain: <span class="hljs-string"><span class="hljs-string">'{{ $subdomain }}'</span></span>, currency: <span class="hljs-string"><span class="hljs-string">'{{ $currency }}'</span></span> }); Recurly.buildBillingInfoUpdateForm({ target: <span class="hljs-string"><span class="hljs-string">'#recurly-billing'</span></span>, successURL: <span class="hljs-string"><span class="hljs-string">'/user/account/billing/confirm'</span></span>, accountCode: <span class="hljs-string"><span class="hljs-string">'{{ $account_code }}'</span></span>, signature: <span class="hljs-string"><span class="hljs-string">'{{ $signature }}'</span></span> }); &lt;/script&gt; @stop</code> </pre><br>  Finally, a very simple callback when the user has filled in payment information: <br><pre> <code class="php hljs">Route::post(<span class="hljs-string"><span class="hljs-string">'user/account/billing/confirm'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect::to(<span class="hljs-string"><span class="hljs-string">'/user/account'</span></span>)-&gt;with(<span class="hljs-string"><span class="hljs-string">'success'</span></span>, <span class="hljs-string"><span class="hljs-string">'Your billing information has been updated.'</span></span>); });</code> </pre><br>  And here it is!  Users can update their billing information! <br>  I have not implemented account editing.  It's pretty simple, and let it be an exercise for you. <br><br><h4>  Push notifications </h4><br><br>  In addition to the capabilities for requesting the Recurly API, a ‚Äúping‚Äù service is an application with a notification when an event occurs. <br>  These notices should not be confused with mobile variety, however - they are completely different. <br>  Essentially, the service sends a POST request to the URI, and sends the XML document as the request body.  You can use Recurly libraries to extract the necessary information and act accordingly.  These notifications are described in detail in the Recurly documentation. <br><br>  Let's define our callback function when the notification was received: <br><pre> <code class="php hljs">Route::post(<span class="hljs-string"><span class="hljs-string">'recurly'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $xml = file_get_contents (<span class="hljs-string"><span class="hljs-string">"php://input"</span></span>); $notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Recurly_PushNotification($xml); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($notification-&gt;type) { <span class="hljs-comment"><span class="hljs-comment">// ... process notification } });</span></span></code> </pre><br>  You, probably, understood that as soon as someone subscribed and paid for the service, he remains an indefinite subscriber, and it is not clear whether their subscription continues or not.  So, the most interesting is the notice of cancellation of the subscription.  We can use the notification from Recurly to identify inactive subscriptions and revoke the corresponding roles.  For example: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($notification-&gt;type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'canceled_subscription_notification'</span></span>: <span class="hljs-comment"><span class="hljs-comment">// get the account code $account_code = $notification-&gt;account-&gt;account_code; // extract the user ID (account_code format is user_ID) $user_id = intval(substr($account_code, (strpos($account_code, '_')+1))); // find the user in question $user = User::find($user_id); // get the plan code $plan_code = $notification-&gt;subscription-&gt;plan-&gt;plan_code; // find the corresponding role... $role = Role::where('name', '=', $plan_code)-&gt;first(); // ...and revoke it DB::table('role_user')-&gt;where('user_id', '=', $user-&gt;id)-&gt;where('role_id', '=', $role)-&gt;delete(); break; // ... process notification }</span></span></code> </pre><br><br>  There are a number of other things you could do, depending on the type of notification. <br>  You can use new, updated, canceled, etc. notifications to create a subscription history, track the number of members, and analyze rejections.  You can also use transaction notifications ‚Äî whether positive (payments) or negative (returns) ‚Äîto track actual and expected income. <br><br>  This is the <a href="http://www.sitepoint.com/creating-subscription-based-website-laravel-recurly-2/">original article</a> ends.  Thanks to everyone who read my article.  In some places, I did not understand what the author wants to say, you will understand this when reading.  If you are interested in the result, then I will post on the githabe what I got (Now, unfortunately, I cannot lay out - there is no time to finish the practice in the second part).  Thank you for your time! </div><p>Source: <a href="https://habr.com/ru/post/221815/">https://habr.com/ru/post/221815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221805/index.html">Fast web application - network trepanation</a></li>
<li><a href="../221807/index.html">Benchmark 14 sorting algorithms on arrays with different dimensions and content</a></li>
<li><a href="../221809/index.html">Space free launch</a></li>
<li><a href="../221811/index.html">The story of parsing one aspx site</a></li>
<li><a href="../221813/index.html">Comparison of biological sequences</a></li>
<li><a href="../221817/index.html">PocketBook 626 vs Sony PRS-T3: tested in humans</a></li>
<li><a href="../221819/index.html">Using Git hooks to block edits of published commits</a></li>
<li><a href="../221821/index.html">Macrorails on MSP430</a></li>
<li><a href="../221823/index.html">Crazy Cube World Game. Creature. Part 1</a></li>
<li><a href="../221825/index.html">Rare graphic station SGI Indy. 20 years later</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>