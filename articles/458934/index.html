<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploying Applications on Multiple Kubernetes Clusters with Helm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How Dailymotion Uses Kubernetes: Application Deployment 


 We in Dailymotion started using Kubernetes in production 3 years ago. But deploying applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploying Applications on Multiple Kubernetes Clusters with Helm</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/8f/-s/8h/8f-s8hlxikospwqtqw5wjcexjri.jpeg"></p><br><h2 id="kak-dailymotion-ispolzuet-kubernetes-razvertyvanie-prilozheniy">  How Dailymotion Uses Kubernetes: Application Deployment </h2><br><p>  We in Dailymotion started using Kubernetes in production 3 years ago.  But deploying applications on several clusters is still fun, so in the past few years we have tried to improve our tools and workflows. </p><a name="habracut"></a><br><h3 id="s-chego-nachalos">  How did it start </h3><br><p>  Here we describe how we deploy our applications on several Kubernetes clusters around the world. </p><br><p>  To deploy several Kubernetes objects at once, we use <a href="https://helm.sh/">Helm</a> , and all our charts are stored in the same git repository.  To deploy a full stack of applications from several services, we use the so-called summary chart.  In essence, this is a chart that declares dependencies and allows you to initialize the API and its services with a single command. </p><br><p>  We also wrote a small Python script on top of Helm to do checks, create charts, add secrets and deploy applications.  All these tasks are performed on the central CI platform using the docker image. </p><br><p>  Let's get to the point. </p><br><blockquote>  Note.  When you read this, the first release candidate for Helm 3 has already been announced.  The basic version contains a whole set of improvements designed to solve some of the problems that we faced in the past. </blockquote><br><h3 id="rabochiy-process-razrabotki-chartov">  Chart Development Workflow </h3><br><p>  For applications, we use branching, and decided to apply the same approach to charts. </p><br><ul><li>  The <strong>dev</strong> branch is used to create charts that will be tested on development clusters. </li><li>  When the pull request is passed to the <strong>master</strong> , they are checked in the staging. </li><li>  Finally, we create a pull request to transfer changes to the <strong>prod</strong> branch and apply them in production. </li></ul><br><p>  Each environment has its own private repository that stores our charts, and we use the <a href="https://chartmuseum.com/">Chartmuseum</a> with very useful APIs.  In this way, we guarantee strict isolation between environments and checking the charts in real conditions, before using them in production. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rz/vt/uk/rzvtuk6q7b_rkeaxnyujzhmfjog.png"></a> </p><br><p>  <em>Chart repositories in different environments</em> </p><br><p>  It is worth noting that when developers send the dev branch, a version of their chart is automatically sent to the dev Chartmuseum.  Thus, all developers use the same dev repository, and you need to carefully indicate your version of the chart in order not to accidentally use someone's changes. </p><br><p>  Moreover, our small Python script checks Kubernetes objects against Kubernetes OpenAPI specifications using <a href="https://kubeval.instrumenta.dev/">Kubeval</a> before publishing them to Chartmusem. </p><br><h3 id="obschee-opisanie-rabochego-processa-razrabotki-charta">  General description of the workflow development chart </h3><br><p> <a href=""><img src="https://habrastorage.org/webt/yd/cw/qw/ydcwqw-vqfitu5bj8ky4nh7xxea.png"></a> </p><br><ol><li>  Setting up <a href="https://gazr.io/">pipeline</a> tasks according to <a href="https://gazr.io/">gazr.io</a> specification for quality control (lint, unit-test). </li><li>  Submitting a docker image with Python tools that deploy our applications. </li><li>  Set up the environment by the name of the branch. </li><li>  Checking yaml Kubernetes files with Kubeval. </li><li>  Automatically increase the version of the chart and its parental charts (charts that depend on the variable chart). </li><li>  Sending a chart to the Chartmuseum that fits its environment </li></ol><br><h2 id="upravlenie-razlichiyami-v-klasterah">  Manage Cluster Differences </h2><br><h3 id="federaciya-klasterov">  Cluster Federation </h3><br><p>  There was a time when we used the <a href="https://kubernetes.io/docs/concepts/cluster-administration/federation/">Kubernetes cluster federation</a> , where you could declare Kubernetes objects from one API endpoint.  But there were problems.  For example, some Kubernetes objects could not be created at the end point of the federation, so it was difficult to maintain the merged objects and other objects for individual clusters. </p><br><p>  To solve the problem, we began to manage the clusters independently, which greatly simplified the process (using the first version of the federation; in the second, something could change). </p><br><h3 id="georaspredelennaya-platforma">  Geo-distributed platform </h3><br><p>  Now our platform is distributed in 6 regions - 3 locally and 3 in the cloud. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/jq/c1/mr/jqc1mru36g5byams4wddzducauw.png"></a> <br>  <em>Distributed deployment</em> </p><br><h3 id="globalnye-znacheniya-helm">  Global Helm Values </h3><br><p>  4 global Helm values ‚Äã‚Äãallow you to identify differences between clusters.  For all of our charts, there are minimal defaults. </p><br><pre><code class="plaintext hljs">global: cloud: True env: staging region: us-central1 clusterName: staging-us-central1</code> </pre> <br><p>  <em>Global values</em> </p><br><p>  These values ‚Äã‚Äãhelp define the context for our applications and are used for different tasks: monitoring, tracing, logging, making external calls, scaling, etc. </p><br><ul><li>  ‚ÄúCloud‚Äù: we have a hybrid platform Kubernetes.  For example, our API is deployed in GCP zones and in our data centers. </li><li>  ‚ÄúEnv‚Äù: some values ‚Äã‚Äãmay vary for non-working environments.  For example, resource definitions and autoscaling configurations. </li><li>  "Region": this information helps determine the location of the cluster and can be used to determine the nearest endpoints for external services. </li><li>  "ClusterName": if and when we want to determine the value for an individual cluster. </li></ul><br><p>  Here is a specific example: </p><br><pre> <code class="plaintext hljs">{{/* Returns Horizontal Pod Autoscaler replicas for GraphQL*/}} {{- define "graphql.hpaReplicas" -}} {{- if eq .Values.global.env "prod" }} {{- if eq .Values.global.region "europe-west1" }} minReplicas: 40 {{- else }} minReplicas: 150 {{- end }} maxReplicas: 1400 {{- else }} minReplicas: 4 maxReplicas: 20 {{- end }} {{- end -}}</code> </pre> <br><p>  <em>Helm Template Example</em> </p><br><p>  This logic is defined in an auxiliary template so as not to clutter Kubernetes YAML. </p><br><h3 id="obyavlenie-prilozheniya">  Announcement of the application </h3><br><p>  Our deployment tools are based on several YAML files.  Below is an example of how we declare a service and its scaling topology (number of replicas) in a cluster. </p><br><pre> <code class="plaintext hljs">releases: - foo.world foo.world: # Release name services: # List of dailymotion's apps/projects foobar: chart_name: foo-foobar repo: git@github.com:dailymotion/foobar contexts: prod-europe-west1: deployments: - name: foo-bar-baz replicas: 18 - name: another-deployment replicas: 3</code> </pre> <br><p>  <em>Service definition</em> </p><br><p>  This is a diagram of all the steps that define our deployment workflow.  The last step deploys the application simultaneously to several work clusters. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/iu/qh/xk/iuqhxki4nfqoi0mus258j0feylu.png"></a> <br>  <em>Jenkins deployment steps</em> </p><br><h3 id="a-sekrety">  And the secrets? </h3><br><p>  As for security, we keep track of all the secrets from different places and store them in a unique <a href="https://www.vaultproject.io/">Vault</a> repository in Paris. </p><br><p>  Our deployment tools extract secrets from Vault and, when deployment times arrive, insert them into Helm. </p><br><p>  To do this, we defined a comparison between the secrets in Vault and the secrets our applications need: </p><br><pre> <code class="plaintext hljs">secrets: - secret_id: "stack1-app1-password" contexts: - name: "default" vaultPath: "/kv/dev/stack1/app1/test" vaultKey: "password" - name: "cluster1" vaultPath: "/kv/dev/stack1/app1/test" vaultKey: "password"</code> </pre> <br><ul><li>  We defined the general rules to follow when writing secrets to Vault. </li><li>  If the secret belongs <strong>to a specific context or cluster</strong> , you need to add a specific entry.  (Here the cluster1 context has its own value for stack-app1-password secret). </li><li>  Otherwise, the <strong>default</strong> value is used. </li><li>  For each item in this list, a key-value pair is inserted into the <strong>Kubernetes secret</strong> .  Therefore, the secret pattern in our charts is very simple. </li></ul><br><pre> <code class="plaintext hljs">apiVersion: v1 data: {{- range $key,$value := .Values.secrets }} {{ $key }}: {{ $value | b64enc | quote }} {{ end }} kind: Secret metadata: name: "{{ .Chart.Name }}" labels: chartVersion: "{{ .Chart.Version }}" tillerVersion: "{{ .Capabilities.TillerVersion.SemVer }}" type: Opaque</code> </pre> <br><h2 id="problemy-i-ogranicheniya">  Problems and limitations </h2><br><h3 id="rabota-s-neskolkimi-repozitoriyami">  Work with multiple repositories </h3><br><p>  Now we share the development of charts and applications.  This means that developers have to work in two git repositories: one for the application, and the other to determine its deployment in Kubernetes.  2 git repositories are 2 workflows and it‚Äôs easy for a beginner to get confused. </p><br><h3 id="upravlyat-obobschennymi-chartami-hlopotno">  Manage the generalized charts troublesome </h3><br><p>  As we already said, generalized charts are very convenient for defining dependencies and quickly deploying multiple applications.  But we use <code>--reuse-values</code> to avoid passing all values ‚Äã‚Äãevery time we deploy the application included in this generic chart. </p><br><p>  In the continuous delivery workflow, we only have two values ‚Äã‚Äãthat change regularly: the number of replicas and the image tag (version).  Other, more stable values ‚Äã‚Äãare changed manually, and this is quite difficult.  Moreover, one mistake in the deployment of the generalized chart can lead to serious disruptions, as we have seen from our own experience. </p><br><h3 id="obnovlenie-neskolkih-faylov-konfiguracii">  Update multiple configuration files </h3><br><p>  When a developer adds a new application, he has to change several files: announcement of the application, list of secrets, add an application depending on if it is included in the generalized chart. </p><br><h3 id="razresheniya-jenkins-slishkom-rasshireny-v-vault">  Jenkins permissions too extended in Vault </h3><br><p>  Now we have one <a href="https://www.vaultproject.io/docs/auth/approle.html">AppRole</a> that reads all the secrets from Vault. </p><br><h3 id="process-otkata-ne-avtomatizirovan">  The rollback process is not automated. </h3><br><p>  For rollback, you need to execute the command on several clusters, and this is fraught with errors.  We perform this operation manually in order to guarantee the correct version identifier. </p><br><h2 id="my-dvizhemsya-v-storonu-gitops">  We are moving towards GitOps </h2><br><h3 id="nasha-cel">  Our goal </h3><br><p>  We want to return the chart to the repository of the application that it deploys. </p><br><p>  The workflow will be the same as for development.  For example, when a branch is sent to the master, the deployment will start automatically.  The main difference between this approach and the current workflow will be that <strong>everything will be managed in git</strong> (the application itself and the way it is deployed to Kubernetes). </p><br><p>  There are several advantages: </p><br><ul><li>  Much <strong>more understandable</strong> for the developer.  It's easier to learn how to apply changes in the local chart. </li><li>  The definition of the service deployment can be specified <strong>in the same place as the</strong> service <strong>code</strong> . </li><li>  <strong>Manage the removal of generalized charts</strong> .  The service will have its release Helm.  This will allow you to manage the application life cycle (rollback, upgrade) at the smallest level so as not to affect other services. </li><li>  <strong>The advantages of git</strong> for managing charts are: undo changes, audit log, etc. If you need to undo a change in a chart, you can do this with git.  Deployment starts automatically. </li><li>  You can think of improving your development workflow with tools like <strong>Skaffold</strong> , with which developers can test changes in a context close to production. </li></ul><br><h3 id="dvuhetapnaya-migraciya">  Two Stage Migration </h3><br><p>  Our developers have been using this workflow for 2 years now, so we need the most painless migration possible.  Therefore, we decided to add an intermediate stage on the way to the goal. <br>  The first stage is simple: </p><br><ul><li>  We retain a similar structure for setting up application deployment, but in the same object called DailymotionRelease. </li></ul><br><pre> <code class="plaintext hljs">apiVersion: "v1" kind: "DailymotionRelease" metadata: name: "app1.ns1" environment: "dev" branch: "mybranch" spec: slack_channel: "#admin" chart_name: "app1" scaling: - context: "dev-us-central1-0" replicas: - name: "hermes" count: 2 - context: "dev-europe-west1-0" replicas: - name: "app1-deploy" count: 2 secrets: - secret_id: "app1" contexts: - name: "default" vaultPath: "/kv/dev/ns1/app1/test" vaultKey: "password" - name: "dev-europe-west1-0" vaultPath: "/kv/dev/ns1/app1/test" vaultKey: "password"</code> </pre> <br><ul><li>  1 release per application (without generalized charts). </li><li>  Charts in the git application repository. </li></ul><br><p>  We talked to all the developers, so the migration process has already begun.  The first phase is still monitored using the CI platform.  Soon I will write another post about the second stage: how we switched to the GitOps workflow with <a href="https://github.com/weaveworks/flux">Flux</a> .  I will tell you how we set up everything and what difficulties we faced (several repositories, secrets, etc.).  Follow the news. </p><br><p>  Here we tried to describe our progress in the application deployment workflow in recent years, which has led to thoughts about the GitOps approach.  We have not yet reached the goal and will report the results, but now we are convinced that we did the right thing when we decided to simplify everything and bring it closer to the habits of the developers. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458934/">https://habr.com/ru/post/458934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458920/index.html">DevOps Fan Conference</a></li>
<li><a href="../458922/index.html">How to move from ESXi to KVM / LXD and not go crazy</a></li>
<li><a href="../458928/index.html">XLNet vs. BERT</a></li>
<li><a href="../458930/index.html">How do students from Perm get to the final of the international data analysis championship Data Mining Cup 2019</a></li>
<li><a href="../458932/index.html">Yota - or how you can find out everything</a></li>
<li><a href="../458936/index.html">‚ÄúIt's easier to answer than to remain silent‚Äù - a great interview with the father of transactional memory, Maurice Herlihy</a></li>
<li><a href="../458940/index.html">How we implemented Agile-testing</a></li>
<li><a href="../458944/index.html">Hiring an employee starts with ... respect. We will interview the engineer</a></li>
<li><a href="../458948/index.html">Habr Weekly # 8 / Yandex Wizards, a book about Prince of Persia, YouTube vs Hackers, Pentagon "heart" laser</a></li>
<li><a href="../45895/index.html">Collective posts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>