<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FutoIn AsyncSteps: the concept and implementation of asynchronous business logic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to acquaint dear readers with another bike approach to the organization of asynchronous code. At once I will make a reservation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FutoIn AsyncSteps: the concept and implementation of asynchronous business logic</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to acquaint dear readers with another <s>bike</s> approach to the organization of asynchronous code.  At once I will make a reservation that there is a mass of solutions from light streams and various proposals on Promise to self-promotion for specific tasks, but I do not undertake to give any subjective comparisons, since none of them did not suit me not only from the point of view of the programmer, but also the verifier code. <br><br>  <b>FutoIn</b> - on the one hand, is the ‚Äúglue‚Äù of standards / specifications of various suits for unifying software interfaces of various existing projects by well-established types, on the other hand, it is a concept for building and scaling project components and infrastructure written on different technologies without the need to add this very "glue". <br><br>  <b>AsyncSteps</b> is the specification and implementation of a software interface for building asynchronous programs regardless of the language or technology selected. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <u>Goals set for the concept:</u> <br><ul><li>  implementation (with reservations) should be possible in all common programming languages ‚Äã‚Äãwith support for objects and anonymous functions.  Representative minimum: C ++, C #, Java, JavaScript, Lua (not OOP), PHP, Python; </li><li>  written program should be easy to read (comparable to the classic version); </li><li>  Exceptions must be supported with the ability to intercept and expand the asynchronous stack to the beginning; </li><li>  Convenience is required for writing asynchronous libraries with a single approach for calling, returning a result and handling errors; </li><li>  provide a simple tool for the natural parallelization of independent program branches; </li><li>  provide a simple tool for creating asynchronous loops with classical controls (break, continue) and a label to exit nested loops; </li><li>  provide a place to store the state of the executable business logic; </li><li>  the ability to cancel the abstract asynchronous task, correctly completing the execution (freeing external resources); </li><li>  ability to easily integrate with other approaches to asynchronous programming; </li><li>  the ability to limit the execution time of the task and each subtask separately; </li><li>  the ability to create a task model for copying (improving the performance of critical parts) or using it as a first-class object to transfer logic as a parameter (a-la callback); </li><li>  make debugging asynchronous program as comfortable as possible. </li></ul><br><a name="habracut"></a><br><h4>  What came of it </h4><br>  The specification was born and updated (to call the standard without a sufficient distribution and editing the hand does not rise) <a href="">FTN12: FutoIn Async API</a> .  <i>I‚Äôll say right away that it is written in English - the de facto standard in the international IT community, like Latin in medicine.</i>  <i>Please do not focus on this attention.</i> <br><br>  Having passed a relatively short path <a href="https://github.com/futoin/core-php-ri-asyncsteps">based on PHP-based</a> proof-of-concept (the latest specification changes have not yet been implemented), <a href="https://github.com/futoin/core-js-ri-asyncsteps">a JavaScript version has been</a> born <a href="https://github.com/futoin/core-js-ri-asyncsteps">under Node.js and browser</a> .  Everything is available on GitHub under the <a href="">Apache-2</a> license.  In NPM and Bower are available under the name <a href="https://www.npmjs.com/package/futoin-asyncsteps">"futoin-asyncsteps"</a> . <br><br><h4>  And how is this used? </h4><br>  Let's start with a warm-up for a cognitive understanding of the essence. <br><br>  First, a small example of a <u>pseudo-code</u> in the synchronous version: <br><pre>     variable = null

     try
     {
         print ("Level 0 func")
        
         try
         {
             print ("Level 1 func")
             throw "myerror"
         }
         catch (error)
         {
             print ("Level 1 onerror:" + error)
             throw "newerror"
         }
     }
     catch (error)
     {
         print ("Level 0 onerror:" + error)
         variable = "Prm"
     }
    
     print ("Level 0 func2:" + variable)
</pre><br><br>  And now, the same, but written asynchronously: <br><pre>     add (// Level 0
         func (as) {
             print ("Level 0 func")
             add (// Level 1
                 func (as) {
                     print ("Level 1 func")
                     as.error ("myerror")
                 },
                 onerror (as, error) {
                     print ("Level 1 onerror:" + error)
                     as.error ("newerror")
                 }
             )
         },
         onerror (as, error) {
             print ("Level 0 onerror:" + error)
             as.success ("Prm")
         }
     )
     add (// Level 0
         func (as, param) {
             print ("Level 0 func2:" + param)
             as.success ()
         }
     )
</pre><br><br>  Expected output: <br><pre>     Level 0 func
     Level 1 func
     Level 1 onerror: myerror
     Level 0 onerror: newerror
     Level 0 func2: Prm
</pre><br><hr><br><br>  I think the principle is obvious, but let's add a bit of theory: the asynchronous task is divided into pieces of code (execution steps) that can be executed without waiting for an external event for a sufficiently short time so as not to harm others quasi-parallelly executed within the same thread.  These pieces of code are enclosed in anonymous functions that are added for sequential execution via the <b>add ()</b> method of the <b>AsyncSteps</b> interface, which is implemented on the <b>AsyncSteps</b> root object and is available through the first parameter of each such step function (the interface is the objects are different!). <br><br>  Main prototypes of handler functions: <br><ul><li>  <b>execute_callback (AsyncSteps as [, previous_success_args1, ...])</b> is a prototype of the function performing a step </li><li>  <b>error_callback (AsyncSteps as, error)</b> - prototype error handling function </li></ul><br><br>  The main methods of constructing the task: <br><ul><li>  <b>as.add (execute_callback func [, error_callback onerror])</b> - add step </li><li>  <b>as.parallel ([error_callback onerror])</b> - returns the AsyncSteps interface of parallel execution </li></ul><br><br>  The result of the step: <br><ul><li>  <b>as.success ([result_arg, ...])</b> - positive result of execution.  Arguments are passed to the next step.  Default action - no need to call if no arguments </li><li>  <b>as.error (name [, error_info])</b> - set as.state (). error_info and <u>throw an exception</u> .  The asynchronous stack is spun through all <b>onerror</b> <i>(and oncancel, but for now we‚Äôll omit it)</i> </li></ul><br>  The result passed through a call to <b>AsyncSteps # success ()</b> gets into the next step to be executed as arguments after the required parameter as. <br><br>  Let's look at the <s>sausage code</s> real example: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// CommonJS .  browser'     $as var async_steps = require('futoin-asyncsteps'); //   -,       var root_as = async_steps(); //     root_as.add( function( as ){ //      as.success( "MyValue" ); } ) //   .add( //  ,   try function( as, arg ){ if ( arg === 'MyValue' ) // true { //    as.add( function( as ){ //      MyError    as.error( 'MyError', 'Something bad has happened' ); }); } }, //    -  ,   catch function( as, err ) { if ( err === 'MyError' ) // true { //   ,   as.success( 'NotSoBad' ); } } ) .add( function( as, arg ) { if ( arg === 'NotSoBad' ) { //         as.state.error_info console.log( 'MyError was ignored: ' + as.state.error_info ); } //     ,      as.state.p1arg = 'abc'; as.state.p2arg = 'xyz'; //   ,   p,   . //     ,   var p = as.parallel(); p.add( function( as ){ console.log( 'Parallel Step 1' ); as.add( function( as ){ console.log( 'Parallel Step 1.1' ); as.state.p1 = as.state.p1arg + '1'; //   as.success() } ); } ) .add( function( as ){ console.log( 'Parallel Step 2' ); as.add( function( as ){ console.log( 'Parallel Step 2.1' ); as.state.p2 = as.state.p2arg + '2'; } ); } ); } ) .add( function( as ){ console.log( 'Parallel 1 result: ' + as.state.p1 ); console.log( 'Parallel 2 result: ' + as.state.p2 ); } ); //      ,  " " root_as.execute();</span></span></code> </pre> <br><br>  Result: <br><pre> MyError was ignored: Something bad has happened
 Parallel Step 1
 Parallel Step 2
 Parallel Step 1.1
 Parallel Step 2.1
 Parallel 1 result: abc1
 Parallel 2 result: xyz2
</pre><br><br><h4>  Complicate to cycles </h4><br>  Such a simple language design as a cycle turns into a completely non-trivial logic under the hood in asynchronous programming, which you can see for yourself. <br><br>  However, the following types of cycles are provided: <br><ul><li>  <b>loop (func (as) [, label])</b> - before the error or as.break () </li><li>  <b>repeat (count, func (as, i) [, label])</b> - no more than <i>count</i> iterations </li><li>  <b>forEach (map_or_array, func (as, key, value) [, label])</b> - pass through a simple or associative array (or equivalent) </li></ul><br><br>  Early termination of the iteration and exit from the loop is done via <b>as.continue ([ <i>label</i> ])</b> and <b>as.break ([ <i>label</i> ]),</b> respectively, which are implemented on the basis of <b>as.error ([ <i>label</i> ])</b> <br><br>  Another example that does not require special explanations: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     browser $as().add( function( as ){ as.repeat( 3, function( as, i ) { console.log( "&gt; Repeat: " + i ); } ); as.forEach( [ 1, 2, 3 ], function( as, k, v ) { console.log( "&gt; forEach: " + k + " = " + v ); } ); as.forEach( { a: 1, b: 2, c: 3 }, function( as, k, v ) { console.log( "&gt; forEach: " + k + " = " + v ); } ); } ) .loop( function( as ){ call_some_library( as ); as.add( func( as, result ){ if ( !result ) { // exit loop as.break(); } } ); } ) .execute();</span></span></code> </pre><br><br>  Result: <br><pre> &gt; Repeat: 0
 &gt; Repeat: 1
 &gt; Repeat: 2
 &gt; forEach: 0 = 1
 &gt; forEach: 1 = 2
 &gt; forEach: 2 = 3
 &gt; forEach: a = 1
 &gt; forEach: b = 2
 &gt; forEach: c = 3
</pre><br><br><h4>  Waiting for an external event </h4><br>  There are two fundamental points here: <br><ol><li>  <b>as.setCancel (func (as))</b> - the ability to install an external cancellation task handler </li><li>  <b>as.setTimeout (timeout_ms)</b> - setting the maximum wait time </li></ol><br>  <i>Calling any of them <u>will require calling an explicit call to</u> <b>as.success ()</b> or <b>as.error ()</b> to continue.</i> <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dummy_service_read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> success, error </span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   success()    //  error()   } function dummy_service_cancel( reqhandle ){ //     dummy_service_read() } var as = async_steps(); as.add( function( as ){ setImmediate( function(){ as.success( 'async success()' ); } ); as.setTimeout( 10 ); // ms //    as.success() -  setTimeout() } ).add( function( as, arg ){ console.log( arg ); var reqhandle = dummy_service_read( function( data ){ as.success( data ); }, function( err ){ if ( err !== 'SomeSpecificCancelCode' ) { try { as.error( err ); } catch ( e ) { //   -     - } } } ); as.setCancel(function(as){ dummy_service_cancel( reqhandle ); }); //    as.success() -  setCancel() // OPTIONAL.    1  as.setTimeout( 1000 ); }, function( as, err ) { console.log( err + ": " + as.state.error_info ); } ).execute(); setTimeout( function(){ //     as.cancel(); }, 100 );</span></span></code> </pre><br><br><h4>  Sugar for debugging </h4><br>  Need any comments? <br><pre> <code class="javascript hljs">.add( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> as, arg </span></span></span><span class="hljs-function">)</span></span>{ ... }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> as, err </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( err + <span class="hljs-string"><span class="hljs-string">": "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.error_info ); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.last_exception.stack ); } )</code> </pre><br><br>  If everything is completely bad, then you can ‚Äúdeploy‚Äù the code to synchronous execution. <br><pre> <code class="javascript hljs"> async_steps.installAsyncToolTest(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> = async_steps(); <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.second_called = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.add( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> as </span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.success(); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> as, error </span></span></span><span class="hljs-function">)</span></span>{ error.should.equal( <span class="hljs-string"><span class="hljs-string">"Does not work"</span></span> ); } ).add( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> as </span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.second_called = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.success(); } ); <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.execute(); <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.second_called.should.be.false; async_steps.AsyncTool.getEvents().length.should.be.above( <span class="hljs-number"><span class="hljs-number">0</span></span> ); async_steps.AsyncTool.nextEvent(); <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.state.second_called.should.be.true; async_steps.AsyncTool.getEvents().length.should.equal( <span class="hljs-number"><span class="hljs-number">0</span></span> );</code> </pre><br><br><h4>  Conclusion </h4><br>  For those who start reading from here.  Above is described something like a compressed translation of the <a href="">README.md</a> project and excerpts from <a href="">the FTN12 specification: FutoIn Async API</a> .  If you digest English, do not hesitate to get more information from the originals. <br><br>  The idea and project were born from the need to transfer business logic to an asynchronous environment.  Primarily for processing database transactions with SAVEPOINT and reliable timely ROLLBACK in a runtime environment like Node.js. <br><br>  <b>FutoIn AsyncSteps</b> is a kind of Swiss knife with rigidly structured steps;  with the deployment of the stack in the processing of exceptions almost in the classical form;  with support for loops, time limits, task cancellation handlers in each nested step.  Perhaps this is exactly what you were looking for for your project. <br><br>  I was glad to share with you and I will be glad to receive both positive and negative criticism, which will benefit the project.  And also, I invite all interested to participate. <br><br>  PS Examples of practical application of <a href="https://github.com/futoin/core-js-ri-invoker">FutoIn Invoker</a> and <a href="https://github.com/futoin/core-js-ri-executor">FutoIn Executor</a> , about which, perhaps, there will also be an article after the first release. </div><p>Source: <a href="https://habr.com/ru/post/249087/">https://habr.com/ru/post/249087/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249075/index.html">Online service for tracking changes on sites</a></li>
<li><a href="../249077/index.html">To the attention of Masterhost / Mastermind customers!</a></li>
<li><a href="../249079/index.html">Microsoft News: R support, new Power BI for analytics and reports, animation and 3D graphics in the cloud</a></li>
<li><a href="../249083/index.html">How to protect Linux ‚Äì server from critical vulnerability Ghost. Update your OS!</a></li>
<li><a href="../249085/index.html">PVS-Studio and hostile habitat</a></li>
<li><a href="../249089/index.html">Deep learning and Caffe on New Year's holidays</a></li>
<li><a href="../249091/index.html">An extension for the normal selection of text inside a link in browsers</a></li>
<li><a href="../249093/index.html">Open Data Day February 21 will be held around the world</a></li>
<li><a href="../249095/index.html">Data Center per billion or "Super Ring" for the "Wild West"</a></li>
<li><a href="../249097/index.html">New GHOST vulnerability threatens popular Linux distributions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>