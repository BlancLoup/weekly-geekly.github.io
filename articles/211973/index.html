<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Paperclip Vulnerability (XSS / RCE)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Paperclip is the most popular jam for uploading files / avatars in rails. A fairly simple logical bug was found in it, leading to uploading an arbitra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Paperclip Vulnerability (XSS / RCE)</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://github.com/thoughtbot/paperclip">Paperclip</a> is the most popular jam for uploading files / avatars in rails.  A fairly simple logical bug was found in it, leading to uploading an arbitrary file to the server, that is, with an arbitrary extension: file.html, file.php, file.cgi, and so on. <br><br>  Paperclip has a “magical” (like all in the rails) adapter system.  If the input is an object of the type File, then the file adapter is taken, if the line is checked according to different patterns.  If the line is of the URL type http: // * then a request is made at this URL to download the file. <br><a name="habracut"></a><br>  io_adapters / uri_adapter.rb contained the following code: <br><pre><code class="ruby hljs">@original_filename = @target.path.split(<span class="hljs-string"><span class="hljs-string">"/"</span></span>).last @original_filename <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-string"><span class="hljs-string">"index.html"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.original_filename = @original_filename.strip @content_type = @content.content_type <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @content.respond_to?(<span class="hljs-symbol"><span class="hljs-symbol">:content_type</span></span>) @content_type <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-string"><span class="hljs-string">"text/html"</span></span></code> </pre> <br>  Note that the content of the type is taken from the header of the server response, which you have no reason to trust.  So I created a URL that returns a picture <a href="http://www.sakurity.com/img.jpg.htm">www.sakurity.com/img.jpg.htm</a> but having .htm in the extension. <br><br>  Paperclip thinks that we gave it a picture, as the Content-Type returned image / jpg and saves the file as file.jpg.htm.  But if the web server (apache / ngin) serves this file, then it already looks at .htm at the end and responds with the insides of our file and Content-Type = text / html.  The browsers parse the response like a normal HTML page. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Oh yes, we will hide our load in the EXIF ​​headers, so the file will still be a valid JPG (in case there are any resize operations on the server). <br><br>  ÛßÙ4Ù¬ıPı ﬁˆ mˆ˚˜ä¯¯®˘8˘ “W˙Á˚˚w¸ ¸ò˝) ˝∫˛K˛‹ ˇmˇˇˇ · ‚EifII * <br>  Ü å ¢ ™ (1 ≤2 "£ € iá ¯CanonCanon DIGITAL IXUS 70 ¥ ¥ f-spot version 0.3.52008: 09: 08 11:29:26 <code><img src="http://onerror=alert(0)"></code>  öÇ Z ùÇ b 'à Pê 0220 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d17/48d/6b2/d1748d6b22ce2a4ce964eb14cbb41531.png" alt="image"><br>  For RCE (code execution) it is necessary for the server to execute .php / .pl / .cgi files, which is rarely a principle for Rails applications, but I could be wrong. <br><br>  To check if you are vulnerable, remove type = file from the tag and send the URL. <br><img src="https://habrastorage.org/getpro/habr/post_images/9da/acb/dc9/9daacbdc9648deb7bbeb92d831448328.png" alt="image"><br><br>  The bug was fixed on December 11 and fixed only on February 2.  A new major version of Paperclip 4 has been released, which also makes content listing of required list types mandatory (previously, many developers forgot to limit file types for download in general).  Well, in general, it can be an interesting vector for checking the download-by-URL functionality. </div><p>Source: <a href="https://habr.com/ru/post/211973/">https://habr.com/ru/post/211973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211961/index.html">You can do without jQuery</a></li>
<li><a href="../211965/index.html">Let's try Nokia Lumia 1520 (5 days of test operation)</a></li>
<li><a href="../211967/index.html">Nimbus Note for Windows - Note Management Software</a></li>
<li><a href="../211969/index.html">The conflict between the Russian film company and video blogger</a></li>
<li><a href="../211971/index.html">COOLRF: the right choice of sockets and switches smart home</a></li>
<li><a href="../211975/index.html">How to develop an electronic device according to the principles of DFM</a></li>
<li><a href="../211979/index.html">InstantClick: library to improve site responsiveness</a></li>
<li><a href="../211983/index.html">Systemd - Standard Initialization System in Debian GNU / Linux</a></li>
<li><a href="../211987/index.html">The second book from the series “Simple Science” has been published with experiences for children.</a></li>
<li><a href="../211989/index.html">Free testing of mobile applications (Samsung Apps)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>