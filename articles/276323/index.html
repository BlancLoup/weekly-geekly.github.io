<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrate NAS from vfiler NetApp to EMC VNX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my last article, I looked at the migration of data from the SAN, now I want to dwell on another type of migration, namely, NAS migration. We will t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrate NAS from vfiler NetApp to EMC VNX</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5e1/eab/fb9/5e1eabfb97b84e06b4d9e4632b52ab79.JPG"><br><br>  In my <a href="https://habrahabr.ru/post/276163/">last article,</a> I looked at the migration of data from the SAN, now I want to dwell on another type of migration, namely, NAS migration.  We will transfer data from CIFS and NFS located on NetApp vfilers on VNX.  In general, I can not say that this procedure is difficult, but, as always, there are some nuances that are better known in advance.  In the article, I will describe my experience gained during my work in the Storage and Virtualization team at <a href="http://icl-services.com/">ICL Services</a> and give a working procedure. <br><a name="habracut"></a><br><h5>  <b>Information to be collected before migration</b> </h5><br>  Starting the migration, it is better to prepare in advance everything that you may need so that the process does not have to be distracted by this activity. <br>  So, we need: <br>  - IP address and VLAN for VDM (Virtual Data Mover) <br>  - Name and size of file systems <br>  - Names ball <br>  - Access rights to balls <br>  - The size of the quota. <br><br><h6>  <b>Firewall Rules</b> </h6><br>  Make sure that the corresponding ports are open on both sides of the firewall: <br>  <b>CIFS</b> <br><table><tbody><tr><th>  Source </th><th>  Destination </th><th>  Protocol </th></tr><tr><td>  CIFS client </td><td>  VDM </td><td>  53 TCP / UDP <br>  88 TCP / UDP <br>  111 TCP / UDP <br>  137 TCP / UDP <br>  138 UDP <br>  139 TCP <br>  389 TCP / UDP <br>  445 TCP <br>  464 TCP / UDP <br>  636 TCP / UDP <br>  12345 TCP <br>  3268 UDP </td></tr><tr><td>  VDM </td><td>  AD Server </td><td>  53 TCP / UDP <br>  88 TCP / UDP <br>  111 TCP / UDP <br>  137 TCP / UDP <br>  138 UDP <br>  139 TCP <br>  389 TCP / UDP <br>  445 TCP <br>  464 TCP / UDP <br>  636 TCP / UDP <br>  12345 TCP <br>  3268 UDP <br></td></tr></tbody></table><br>  <b>Nfs</b> <br><table><tbody><tr><th>  Source </th><th>  Destination </th><th>  Protocol </th></tr><tr><td>  NFS Client </td><td>  VDM </td><td>  111 TCP / UDP <br>  2049 TCP / UDP <br>  2079 TCP / UDP <br>  1234 TCP / UDP <br>  31491 UDP <br>  49152-65535 TCP / UDP <br></td></tr></tbody></table><br>  After the information necessary to start the migration has been collected, we will notify all interested parties, agree on the idle time and begin the migration ... <br>  I mostly use the CLI and will give examples from it, but all the actions described in the article can be done through the GUI. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>VNX Setup</b> </h5><br>  First of all, we create the interface: (did you request IP?) <br> <code>server_ifconfig server_2 -create -Device lacp0 -name vnx01-vdm01 IP 172.XXX.XXX.XXX 255.255.255.224 172.XXX.XXX.XXX vlan=XXXX <br></code> <br><br>  Check the created interface: <br> <code>server_ifconfig server_2 -a <br></code> <br><br>  The output will be something like this: <br> <code>server_2: <br> vnx02-vdm5 protocol=IP device=lacp0 <br> inet=172.XXX.XXX.XXX netmask=255.255.255.224 broadcast=172.XXX.XXX.XXX <br> UP, Ethernet, mtu=1500, vlan=2836, macaddr=XX:XX:XX:XX:XX:XX:XX:XX <br></code> <br><br>  At the same time, check the routing: <br> <code>server_route server_2 ‚Äìlist <br></code> <br><br>  Now create a VDM: <br> <code>nas_server -name VNX01-VDM01 -type vdm -create server_2 <br></code> <br><br>  And we will attach the interface to the VDM: <br> <code>nas_server -vdm VNX01-VDM01 -attach vnx01-vdm01 <br></code> <br><br>  Check the interface on VDM: <br> <code>nas_server -list server_2 ‚Äìvdm <br></code> <br><br>  Now we need to create a file system for the NAS, and, of course, the size of the file system of the target NAS must be greater than or equal to the size of the file system of the source NAS. Create: <br> <code>nas_fs -name fs_vnx01-vdm01 -create size=3000G pool="Pool NAS" -o slice=yes <br></code> <br><br>  Mount the file system: <br> <code>server_mount VNX01-VDM01 fs_vnx01-vdm01 /fs_vnx01-vdm01 <br></code> <br><br>  Checking what was mounted successfully: <br> <code>server_mount server_2 <br></code> <br><br>  Create a Quotas Tree: <br> <code>nas_quotas -on -tree -fs fs_vnx01-vdm01 -path /r2_datastore01 <br></code> <br><br>  Set limits: <br> <code>nas_quotas -edit -tree ‚Äìfs fs_vnx01-vdm01 ‚Äìblock 3145728000: 2097152000 3 <br></code> <br><br>  Check the established limits: <br> <code>nas_quotas -report -tree -fs fs_vnx01-vdm01 <br></code> <br><br>  Now let's get down to creating a CIFS ball.  First we need to create a CIFS server: <br> <code>server_cifs VNX01-VDM360 -add compname=vnx02-vdm360,domain=domain.local,interface=vnx02-vdm360 <br></code> <br><br>  We join the domain: <br> <code>server_cifs VNX02-VDM360 -Join compname=VNX02-VDM360,domain=domain.local,admin=nasadmin,ou="ou=NAS" <br></code> <br><br>  Create the first CIFS ball: <br> <code>server_cifs VNX02-VDM360 -list -name th2 /fs_vnx01-vdm01/ th2 <br></code> <br><br>  And NFS: <br> <code>server_export VNX01-VDM01 -P nfs -o root=172.XXX:XXX:XXX:172.YYY.YYY.YYY,rw=172.XXX:XXX:XXX:172.YYY.YYY.YYY <br></code> <br><br>  Thus, we have finished configuring the NAS on the destination side.  Now we need to transfer the data from NetApp, located on site A, to VNX on site B. In order to minimize possible risks, as well as reduce downtime, I want to offer you a procedure that I used to perform all past migrations and which I confirmed on my own practice.  I hope it will be useful to you. <br><br>  <b>Preparation infrastructure</b> <br>  1.1 Mapim balls (we completed this step in the instructions above) <br>  1.2 Starting full copying from vfiler to VDM using the tools of the <a href="">EMCCOPY</a> utility for CIFS and rsync for NFS <br>  1.3 Check the EMCCOPY or / and rsync logs <br>  1.4 Copy rights using utility LGDUP <br>  1.5 Check LGDUP logs <br>  1.6 Starting differential copying <br>  1.7 Checking the EMCCOPY and / or rsync logs <br><br>  <b>Go move</b> <br>  2.1 Remove EMCCOPY or rsync task from the scheduler <br>  2.2 Stop applications using migrated vfiler <br>  2.3 Unmount NFS / CIFS drives from clients <br>  2.4 We bring vfiler from the domain <br>  2.5 Save in a safe place vfiler configuration <br>  2.6 Turning off access to vfiler for all groups except the one from which the copy was performed <br>  2.7 Remove IP addresses from vfiler <br>  2.8 Add addresses previously used by vfiler to VDM <br>  2.10 Enter VDM in the domain under the name vfiler <br>  2.11 We check access <br>  2.12 We mount disks to customers <br>  2.13 We check the rights. <br><br>  That's all.  As with the SAN migration, if you did everything correctly, the host will not notice that it is already working with another NAS.  I don‚Äôt see any reason to bring commands to work with vfiler, since you can use any other NAS. <br>  Simple instructions for working with EMCCOPY can be read <a href="http://www.thecrumb.com/2014/12/18/emcopy-vs-robocopy/">here</a> . <br>  Rsync, I think, is already well known to everyone (and emccopy is essentially robocopy). <br><br>  As an example - my scripts for EMCCOPY <br><br>  <b>EMCCOPY DIFF Script</b> <br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> ON <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> =========================================================================== <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> E:\EMC\EXE <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> delims=/ " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var1=<span class="hljs-variable"><span class="hljs-variable">%%k</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> delims=: " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var2=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var3=<span class="hljs-variable"><span class="hljs-variable">%var1%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%var2%</span></span>.log <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var4=<span class="hljs-variable"><span class="hljs-variable">%var1%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%var2%</span></span>.err <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ================================================================= <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> delims=/ " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span><span class="hljs-variable"><span class="hljs-variable">%%k</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>&gt;&gt;E:\EMC\SCRIPTS\netap01_vfiler1\Progress.txt <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> delims=: " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">%%i</span></span>H<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>&gt;&gt;E:\EMC\SCRIPTS\netap01_vfiler1\Progress.txt E:\EMC\EXE\emcopy64 \\netapp\data \\vnx01-vdm01.domain.local\data /xd .snapshot /o /purge /i /lg /secfix /preserveSIDh /s /stream /de /sdd /c /r:<span class="hljs-number"><span class="hljs-number">3</span></span> /w:<span class="hljs-number"><span class="hljs-number">1</span></span> /th <span class="hljs-number"><span class="hljs-number">16</span></span> /log:e:\EMC\LOGS\vnx01-vdm01\data_<span class="hljs-variable"><span class="hljs-variable">%var3%</span></span> &gt; e:\EMC\LOGS\vnx01-vdm01\data_<span class="hljs-variable"><span class="hljs-variable">%var4%</span></span></code> </pre><br><br>  <b>EMCCOPY LGDUP</b> <br><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> ON <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> =========================================================================== <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> E:\EMC\EXE <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> delims=/ " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var1=<span class="hljs-variable"><span class="hljs-variable">%%k</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "tokens=<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> delims=: " <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> /t') <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var2=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>_<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var3=dm2_<span class="hljs-variable"><span class="hljs-variable">%var1%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%var2%</span></span>.log <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> var4=dm2_<span class="hljs-variable"><span class="hljs-variable">%var1%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%var2%</span></span>.err <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ================================================================= <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> lgdup -v -l E:\EMC\LOGS\vnx01-vdm01\lgdup_vnx01-vdm01.log \\<span class="hljs-number"><span class="hljs-number">172</span></span>.XXX.XXX.XXX \\vnx01-vdm01</code> </pre><br><br>  If there are any questions or additions, and maybe advice, I will always be happy to hear.  All easy migrations! <br></div><p>Source: <a href="https://habr.com/ru/post/276323/">https://habr.com/ru/post/276323/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276313/index.html">Authentication via ESIA OAuth2</a></li>
<li><a href="../276315/index.html">XAML Developer Chips: Conditional Converter</a></li>
<li><a href="../276317/index.html">I'm not smart, I just sat on it longer than you</a></li>
<li><a href="../276319/index.html">Quick installation of SSL certificate from StartSSL in iRedMail mail server</a></li>
<li><a href="../276321/index.html">Multiprocess Firefox 44.b, Electrolysis Optimization</a></li>
<li><a href="../276325/index.html">Attackers use Gcat backdoor for cyber attacks on Ukrainian energy companies</a></li>
<li><a href="../276327/index.html">Linux kernel support 2.6.32 LTS ends in February</a></li>
<li><a href="../276329/index.html">Quantum morris</a></li>
<li><a href="../276331/index.html">Add range operator in PHP</a></li>
<li><a href="../276333/index.html">Using or Using?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>