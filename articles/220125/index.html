<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of parsing with Python + lxml</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers. 
 In today's article, I‚Äôll show the basics of HTML parsing pages using the lxml library for Python. 
 In short, lxml is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of parsing with Python + lxml</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear readers. <br>  In today's article, I‚Äôll show the basics of HTML parsing pages using the <a href="http://lxml.de/">lxml</a> library for Python. <br>  In short, <strong>lxml</strong> is a fast and flexible library for handling <a href="http://ru.wikipedia.org/wiki/XML">XML</a> and <a href="http://ru.wikipedia.org/wiki/HTML">HTML</a> markup in Python.  In addition, it has the ability to decompose the elements of the document into a tree.  In the article I will try to show how easy it is to apply in practice. <br><br><a name="habracut"></a><br><h3>  Select a target for parsing </h3><br>  Since  I actively go in for sports, in particular, <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B8%25D0%25BB%25D1%258C%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B6%25D0%25B8%25D1%2583-%25D0%25B4%25D0%25B6%25D0%25B8%25D1%2582%25D1%2581%25D1%2583">BZHZH</a> I wanted to see the pain statistics in all the MMA tournaments in tournaments held. <br>  Searches on the buzz led me to the <a href="http://hosteddb.fightmetric.com/">site</a> with all the official statistics on major international tournaments in mixed martial arts.  The only catch was that the information on us was presented in an inconvenient form for analysis.  This is due to the fact that the results of the tournaments are located on separate pages.  In addition, the date of the tournament with its name is also placed on a separate page on a separate page. <br>  To combine all the information on tournaments into one table, suitable for analysis, it was decided to write a <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2580%25D1%2581%25D0%25B5%25D1%2580">parser</a> described below. <br><br><h3>  Algorithm parser </h3><br>  First, let's deal with the algorithm of the parser.  It will be as follows: <br><ol><li>  We take as a basis the table with all tournaments and their dates, which is located <br>  by <a href="http://hosteddb.fightmetric.com/events/index/date/desc/1/all">this</a> <a href="http://hosteddb.fightmetric.com/events/index/date/desc/1/all"><br></a>  <a href="http://hosteddb.fightmetric.com/events/index/date/desc/1/all">address</a> </li><li>  Fill in the data from this page into a dataset with the following columns: </li><li>  tournament </li><li>  description link </li><li>  date </li><li>  For each record set (for each tournament) we move across the field <br>  <em>[link to description]</em> for information on battles </li><li>  We write down information on all fights of tournament </li><li>  To the data set with information about the battles we add the date of the tournament from <br>  set (2) </li></ol><br>  The algorithm is ready and you can go to its implementation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Getting started with lxml </h3><br>  To work we need the modules <em>lxml</em> and <a href="http://pandas.pydata.org/pandas-docs/stable/">pandas</a> .  Let's load them into our program: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lxml.html <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> html <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DataFrame</code> </pre> <br>  For the convenience of further parsing, we will move the main domain into a separate variable: <br><br><pre> <code class="python hljs">main_domain_stat = <span class="hljs-string"><span class="hljs-string">'http://hosteddb.fightmetric.com'</span></span></code> </pre><br>  Now let's get the object to parse.  This can be done using the <a href="http://lxml.de/lxmlhtml.html">parse ()</a> function: <br><br><pre> <code class="python hljs">page = html.parse(<span class="hljs-string"><span class="hljs-string">'%s/events/index/date/desc/1/all'</span></span> % (main_domain_stat))</code> </pre><br>  Now open the specified table in the HTML editor and study its structure.  We are most interested in the block with the classes <code>events_table data_table row_is_link</code> , because  It contains the table with the data we need.  You can get this block like this: <br><br><pre> <code class="python hljs">e = page.getroot().\ find_class(<span class="hljs-string"><span class="hljs-string">'events_table data_table row_is_link'</span></span>).\ pop()</code> </pre><br>  We will understand what this code does. <br>  First, using the <a href="http://lxml.de/api/lxml.etree._ElementTree-class.html">getroot ()</a> function, we get the root element of our document (this is necessary for the subsequent work with the document). <br>  Further, using the <a href="http://lxml.de/lxmlhtml.html">find_class ()</a> function, we find all the elements with the specified classes.  As a result of the function, we get a list of such elements.  Since  after visual analysis of the HTML code of the page, it is clear that only one element is suitable for this criterion, then we extract it from the list using the <a href="https://docs.python.org/2/tutorial/datastructures.html">pop ()</a> function. <br>  Now we need to get a table from our <em>div</em> 'a, obtained earlier.  To do this, we use the <a href="http://lxml.de/api/lxml.etree._Element-class.html">getchildren ()</a> method, which returns a list of alternate objects of the current element.  AND <br>  because we have only one such object, you we extract this one from the list. <br><br><pre> <code class="python hljs">t = e.getchildren().pop()</code> </pre><br>  Now the variable <i>t</i> contains a table with the information we need.  Now, I will get 2 auxiliary <em>dataframe'a</em> , combining that, we will get information about tournaments with their dates and links to the results. <br>  In the first set I will include all tournament names and links to their pages on the site.  This is easily done using the <a href="http://lxml.de/lxmlhtml.html">iterlinks ()</a> iterator, which returns a list of conditioners <code>(, , <br>  ,  )</code> <code>(, , <br>  ,  )</code>  <code>(, , <br>  ,  )</code> within the specified element.  Actually, from this tuple, we need the address of the link and its text. <br>  A link test can be obtained by referring to the <strong>.text</strong> property of the corresponding element.  The code will be as follows: <br><br><pre> <code class="python hljs">events_tabl = DataFrame([{<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>:i[<span class="hljs-number"><span class="hljs-number">0</span></span>].text, <span class="hljs-string"><span class="hljs-string">'LINK'</span></span>:i[<span class="hljs-number"><span class="hljs-number">2</span></span>]} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> t.iterlinks()][<span class="hljs-number"><span class="hljs-number">5</span></span>:])</code> </pre><br>  The attentive reader will notice that in the loop we exclude the first 5 entries.  They contain information that we don‚Äôt need, such as field headers, so I got rid of them. <br>  So, we got the links.  Now we get 2 subsets of data with dates of tournaments.  This can be done like this: <br><br><pre> <code class="python hljs">event_date = DataFrame([{<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>: evt.getchildren()[<span class="hljs-number"><span class="hljs-number">0</span></span>].text_content(), <span class="hljs-string"><span class="hljs-string">'DATE'</span></span>:evt.getchildren()[<span class="hljs-number"><span class="hljs-number">1</span></span>].text_content()} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> evt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> t][<span class="hljs-number"><span class="hljs-number">2</span></span>:])</code> </pre><br>  In the code shown above, we go through all the lines ( <i>tr</i> tags) in table <i>t</i> .  Then for each row we get a list of child columns ( <em>td</em> elements).  And we get the information recorded in the first and second columns using the <a href="http://lxml.de/lxmlhtml.html">text_content</a> method, which returns a string from the text of all child elements of the given column. <br>  To understand how the <i>text_content</i> method <i>works,</i> here‚Äôs a small example.  Suppose we have this structure of the document <i>&lt;tr&gt; &lt;td&gt; &lt;span&gt; text &lt;/ span&gt; &lt;span&gt; text &lt;/ span&gt;</i> .  So, the <i>text_content</i> method returns a string of <em>text, text</em> , and the <i>text</i> method does not return anything, or just <em>text</em> . <br><br>  Now that we have 2 subsets of data, combine them into a final set: <br><br><pre> <code class="python hljs">sum_event_link = events_tabl.set_index(<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>).join(event_date.set_index(<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>)).reset_index()</code> </pre><br>  Here, we first specify the indices to our sets, then combine them and reset the indices of the final set.  More information about these operations can be found in one of my past <a href="https://habr.com/posts/54">articles</a> .  It remains to upload the received dataframe to a text file, for safekeeping: <br><br><pre> <code class="python hljs">sum_event_link.to_csv(<span class="hljs-string"><span class="hljs-string">'..\DataSets\ufc\list_ufc_events.csv'</span></span>,<span class="hljs-string"><span class="hljs-string">';'</span></span>,index=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br><h3>  Event handler for one UFC event </h3><br>  We unloaded a page with a list of tournaments in a convenient format.  It's time to sort out the results pages for the competition.  For example, take the last <a href="http://hosteddb.fightmetric.com/events/details/662">tournament</a> and see the HTML code of the page. <br>  You may notice that the information we need is contained in the element with the <i>data_table</i> class <i>row_is_link</i> .  In general, the parsing process is similar to the one shown above, with one exception: the results table is not entirely correct. <br>  Its uncorrection is that for each fighter there is a separate line in it, which is not convenient in the analysis.  To get rid of this inconvenience when analyzing the results, I decided to use an iterator, only on odd lines.  The number of the even number is calculated from the current odd line. <br>  Thus, I will process a couple of lines at once and transfer them to a line.  The code will be as follows: <br><br><pre> <code class="python hljs">all_fights = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sum_event_link.itertuples(): page_event = html.parse(<span class="hljs-string"><span class="hljs-string">'%s/%s'</span></span> % (main_domain_stat,active_event_link)) main_code = page_event.getroot() figth_event_tbl = main_code.find_class(<span class="hljs-string"><span class="hljs-string">'data_table row_is_link'</span></span>).pop()[<span class="hljs-number"><span class="hljs-number">1</span></span>:] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> figther_num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(figth_event_tbl)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> figther_num % <span class="hljs-number"><span class="hljs-number">2</span></span>: all_fights.append( {<span class="hljs-string"><span class="hljs-string">'FIGHTER_WIN'</span></span>: figth_event_tbl[figther_num][<span class="hljs-number"><span class="hljs-number">2</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'FIGHTER_LOSE'</span></span>: figth_event_tbl[figther_num+<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'METHOD'</span></span>: figth_event_tbl[figther_num][<span class="hljs-number"><span class="hljs-number">8</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'METHOD_DESC'</span></span>: figth_event_tbl[figther_num+<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">7</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'ROUND'</span></span>: figth_event_tbl[figther_num][<span class="hljs-number"><span class="hljs-number">9</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'TIME'</span></span>: figth_event_tbl[figther_num][<span class="hljs-number"><span class="hljs-number">10</span></span>].text_content().lstrip().rstrip(), <span class="hljs-string"><span class="hljs-string">'EVENT_NAME'</span></span>: i[<span class="hljs-number"><span class="hljs-number">1</span></span>]} ) history_stat = DataFrame(all_fights)</code> </pre><br>  You may notice that for each match the tournament name is additionally recorded.  This is necessary in order to determine the date of the match. <br>  Now save the results to a file: <br><br><pre> <code class="python hljs">history_stat.to_csv(<span class="hljs-string"><span class="hljs-string">'..\DataSets\ufc\list_all_fights.csv'</span></span>,<span class="hljs-string"><span class="hljs-string">';'</span></span>,index=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br>  Let's look at the result: <br><br><pre> <code class="python hljs">history_stat.head()</code> </pre> <br><table><thead><tr><th></th><th>  EVENT_NAME </th><th>  FIGHTER_LOSE </th><th>  FIGHTER_WIN </th><th>  METHOD </th><th>  METHOD_DESC </th><th>  ROUND </th><th>  TIME </th></tr></thead><tbody><tr><th>  0 </th><td>  UFC Fight Night 38: Shogun vs.  Henderson </td><td>  Robbie lawler </td><td>  Johny hendricks </td><td>  U. DEC </td><td>  NaN </td><td>  five </td><td>  5:00 </td></tr><tr><th>  one </th><td>  UFC Fight Night 38: Shogun vs.  Henderson </td><td>  Carlos condit </td><td>  Tyron woodley </td><td>  KO / TKO </td><td>  Knee injury </td><td>  2 </td><td>  Two o'clock </td></tr><tr><th>  2 </th><td>  UFC Fight Night 38: Shogun vs.  Henderson </td><td>  Diego sanchez </td><td>  Myles jury </td><td>  U. DEC </td><td>  NaN </td><td>  3 </td><td>  5:00 </td></tr><tr><th>  3 </th><td>  UFC Fight Night 38: Shogun vs.  Henderson </td><td>  Jake shields </td><td>  Hector lombard </td><td>  U. DEC </td><td>  NaN </td><td>  3 </td><td>  5:00 </td></tr><tr><th>  four </th><td>  UFC Fight Night 38: Shogun vs.  Henderson </td><td>  Nikita Krylov </td><td>  Ovince saint preux </td><td>  SUB </td><td>  Other - Choke </td><td>  one </td><td>  1:29 </td></tr></tbody></table><br>  It remains only to tighten the date to the fights and unload the final file: <br><br><pre> <code class="python hljs">all_statistics = history_stat.set_index(<span class="hljs-string"><span class="hljs-string">'EVENT_NAME'</span></span>).join(sum_event_link.set_index(<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>).DATE) all_statistics.to_csv(<span class="hljs-string"><span class="hljs-string">'..\DataSets\ufc\statistics_ufc.csv'</span></span>,<span class="hljs-string"><span class="hljs-string">';'</span></span>, index_label=<span class="hljs-string"><span class="hljs-string">'EVENT'</span></span>)</code> </pre><br><h3>  Conclusion </h3><br>  In the article, I tried to show the basics of working with the <strong>lxml</strong> library, which is used for parsing XML and HTML markup.  The code specified in the article does not claim to be optimal, but correctly performs the task set for it. <br>  As you can see from the above program, the process of working with the library is quite simple, which helps to quickly write the necessary code.  In addition to the above functions and methods, there are other equally necessary. </div><p>Source: <a href="https://habr.com/ru/post/220125/">https://habr.com/ru/post/220125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220113/index.html">Exploitation of vulnerability in DrWeb update procedure</a></li>
<li><a href="../220115/index.html">Maketon Nova Base - a marathon for assembling a 3D printer</a></li>
<li><a href="../220117/index.html">Embarcadero RAD studio XE6</a></li>
<li><a href="../220119/index.html">Kirill Safonov: ‚ÄúIt's like racing on the ocean on small yachts‚Äù</a></li>
<li><a href="../220123/index.html">Internet radio with a host of leading from different cities and calls live</a></li>
<li><a href="../220127/index.html">Discover MODX</a></li>
<li><a href="../220129/index.html">Jump Start April 22: Data Center Virtualization using Windows Server 2012 R2 and System Center 2012 R2. Ensuring the security and high availability of virtual machines</a></li>
<li><a href="../220131/index.html">EditorConfig - Alone Settings for All Editors / IDE</a></li>
<li><a href="../220135/index.html">Plan-fact, dynamics and profits in one diagram with R</a></li>
<li><a href="../220137/index.html">Automate the deployment of applications in 1 click on the platform InfoboxCloud Jelastic with JPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>