<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Differentiation of access rights in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to describe one of the ways to differentiate access to data in a DBMS, which seems to me quite flexible and interesting. This method allows you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Differentiation of access rights in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/8a2/56c/353/8a256c3536e44928b88e4f07a6037c01.jpg"></p><br><p>  I want to describe one of the ways to differentiate access to data in a DBMS, which seems to me quite flexible and interesting.  This method allows you to get information about the current user by calling a simple stored procedure.  But first, let's consider the well-known existing methods with their pros and cons, among which we can highlight the use of built-in DBMS authentication mechanisms and access control at the application level. </p><a name="habracut"></a><br><h2 id="sposob-1-vstroennye-mehanizmy-autentifikacii">  Method 1. Built-in authentication mechanisms </h2><br><p>  For each business user, a corresponding user is created in the DBMS, to which the necessary rights are distributed. </p><br><p>  The advantages of this approach: its simplicity and transparency.  According to the DBMS logs, it is easy to see which requests are performed by users, several rights can be combined into roles and distributed to users directly out of the box.  The main disadvantage of this approach is the lack of access control at the row level.  Yes, <a href="https://www.postgresql.org/docs/current/static/ddl-rowsecurity.html">row-level security</a> appeared in 9.5, but this mechanism does not work as fast as we would like, especially <a href="">for JOIN</a> . </p><br><p>  The built-in authentication mechanisms also include LDAP, PAM, GSSAPI, and <a href="https://www.postgresql.org/docs/9.6/static/auth-methods.html">others</a> . </p><br><h2 id="sposob-2-proverka-na-urovne-prilozheniya">  Method 2: Application Level Checks </h2><br><p>  Many implement access control directly at the application level.  In this case, you can use an external service to authorize users and store password hashes directly in the database and check them in the application.  It does not matter.  The main thing is that all users ultimately go to the database under one user.  In this approach, I do not see any advantages at all, but there are plenty of minuses: </p><br><ol><li>  There is no access control at the row level, or it becomes very difficult. </li><li>  If the password of the DBMS user is compromised, the attacker gets full access to all the data, and he can not only read them, but also change them. </li><li>  The application becomes the only link controlling access, and if, say, you want to implement another service that works with the database, you will have to write all the code that performs the checks, again. </li></ol><br><p>  Despite such a large number of disadvantages, according to my observations, this is the most common way to delineate access to date. </p><br><h2 id="sposob-3-vvedenie-sessii-na-urovne-subd">  Method 3. Introduction of the session at the DBMS level </h2><br><p>  About this method today and I want to tell in more detail.  Its essence is simple: an authorization procedure is created in the database, which checks the user's login and password and, if successful, sets the value of some session variable that would be readable until the end of the current session.  To store the value of a variable, we will use a global GD array, accessible to Pl / Python procedures: </p><br><pre><code class="python hljs">create <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> replace function set_current_user_id(user_id integer) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ GD[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>] = user_id $$ language plpythonu;</code> </pre> <br><p>  The very same authorization procedure will be as follows: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> login(user_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, password_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> vuser_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; vis_admin boolean; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, is_admin <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> vuser_id, is_admin <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> login = login_ <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = password_; if found then perform set_current_user_id(vuser_id); <span class="hljs-comment"><span class="hljs-comment">/*   set_is_admin()    set_current_user_id() */</span></span> perform set_is_admin(vis_admin); else raise exception 'Invalid login or password'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; return vuser_id; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql security definer;</code> </pre> <br><p>  After that, it remains to implement a function that will return the ID of the logged in user: </p><br><pre> <code class="python hljs">create <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> replace function get_current_user_id() returns integer <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GD.get(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>) $$ language plpythonu stable;</code> </pre> <br><p>  Now, how to use it all.  And it is very easy to use.  After the user is authorized within any function, it is now easy to find out what the user is requesting access to the data and what rights it has.  For example: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> delete_branch(branch_id_ <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> current_user_is_admin() <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-string"><span class="hljs-string">'Access denied: this operation needs admin privileges'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql;</code> </pre> <br><p>  To demonstrate how access control at the row level will work, we will write a function that will return a list of bank accounts, and only those that are open in the branch to which the user belongs (branch_id). </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get_accounts() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (account_number <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> a.account_number <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> accounts a <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> u.branch_id = a.branch_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.id = get_current_user_id(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql;</code> </pre> <br><p>  What are the pros and cons of this approach?  Pros: </p><br><ol><li>  Usability, flexibility, extensibility. </li><li>  Providing access control at the row level, almost without prejudice to the performance of the DBMS. </li><li>  All logic is concentrated in the DBMS, thus it is possible to provide access to the database to several applications in which only the authorization mechanism will have to be implemented. </li><li>  In addition to information about the user, you can quickly receive any metadata associated with him - for example, whether the current user is an administrator, his name to be displayed in a personal account, groups to which he belongs, and so on. </li></ol><br><p>  Despite this, there are also disadvantages: </p><br><ol><li>  All the logic of working with data needs to be wrapped in stored procedures (in fact, for me this is a plus). </li><li>  The need to authorize the user at the beginning of each session, and if the code is wrapped in a transaction, then at the beginning of each transaction.  This may be uncritical for so-called "fat clients", but for web applications it is already becoming relevant.  In this case, the problem is solved by wrapping the driver, which provides access to the DBMS with a custom code so that authorization is performed before executing each request.  It does not sound very beautiful, but in fact everything is not so scary.  I used <a href="http://flask.pocoo.org/">Flask</a> and <a href="https://flask-login.readthedocs.io/en/latest/">flask_login</a> in my projects, which greatly simplifies this task. </li></ol><br><h2 id="rezyume">  Summary </h2><br><p>  Of course, for sure there are projects where the approach described by me will be inappropriate and I will be happy if you share your thoughts on this matter - perhaps this method can be improved and improved.  But, in general, this approach seems to me quite interesting. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/334558/">https://habr.com/ru/post/334558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334548/index.html">The unrealized potential of the Internet of Things</a></li>
<li><a href="../334550/index.html">Company Development with Open Source</a></li>
<li><a href="../334552/index.html">A quarter of a million for the "beetle": Microsoft is beginning an active struggle with bugs</a></li>
<li><a href="../334554/index.html">Characteristics of the PVS-Studio analyzer on the example of EFL Core Libraries, 10-15% of false positives</a></li>
<li><a href="../334556/index.html">Machine Learning for an Insurance Company: Improving the Model through Algorithm Optimization</a></li>
<li><a href="../334560/index.html">Let's play in Firebase</a></li>
<li><a href="../334562/index.html">hh and in production: how to release a new feature</a></li>
<li><a href="../334564/index.html">Defice ask.mcdonalds.ru</a></li>
<li><a href="../334566/index.html">7 ways to use blue in your company colors</a></li>
<li><a href="../334568/index.html">Generative models from OpenAI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>