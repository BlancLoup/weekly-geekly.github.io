<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The analysis of data from the Eastron SDM220 electric meter by means of ThingSpeak</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. In an article on geektimes, I told you how to connect to an Eastron electric meter SDM220-Modbus and collect data from it on the RS-485 bus. To...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The analysis of data from the Eastron SDM220 electric meter by means of ThingSpeak</h1><div class="post__text post__text-html js-mediator-article">  Hello.  In an article on <a href="https://geektimes.ru/post/277358/">geektimes,</a> I told you how to connect to an <a href="https://ru.aliexpress.com/item/SDM220Modbus-Single-Phase-DIN-Rail-Kwh-meter-with-Pulse-Output-and-RS485-Modbus-Communication-MID-approved/32346363823.html">Eastron</a> electric <a href="https://ru.aliexpress.com/item/SDM220Modbus-Single-Phase-DIN-Rail-Kwh-meter-with-Pulse-Output-and-RS485-Modbus-Communication-MID-approved/32346363823.html">meter SDM220-Modbus</a> and collect data from it on the RS-485 bus.  Today I want to tell you about the collection and analysis of statistics on the consumption of electricity in the house. <br><br><img src="https://habrastorage.org/files/a64/ad4/b4b/a64ad4b4b1b94ff4bc94dcdeb57d38d1.png"><br><a name="habracut"></a><br>  As a home hub for data collection, I used the <b>Centerm GI-945</b> thin client.  Its advantages are x86 architecture (atom 1,6 GHz), 5 USB, 1G Ethernet, mini-pcie (put a wifi card in it).  From the USB stick is loaded Ubuntu Server 14.04. <br><br><img src="https://habrastorage.org/files/c08/76c/d1b/c0876cd1bfcb41d78e2c7efea00ef652.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/754/08e/5d4/75408e5d41944247aa3587251de07295.jpg"><br><br>  Through <b>USB-RS485</b> adapter to the "server" is connected to the meter.  Poll counter makes the script in Python, the basis for <a href="http://vogelchr.blogspot.com/2015/03/sdm220-power-meter-modbus-python-rs485.html">this example</a> .  The script requires the <b>pyModbus</b> library <b>.</b> <br><br><div class="spoiler">  <b class="spoiler_title">Library installation</b> <div class="spoiler_text">  sudo add-apt-repository ppa: fkrull / deadsnakes-python2.7 <br>  sudo apt-get update <br>  sudo apt-get upgrade <br><br>  apt-get -y install python-pip <br>  apt-get install python2.7-dev <br><br>  pip install -U pymodbus </div></div><br>  The script is run on <b>cron</b> once a minute, takes data (voltage, current, power and energy taken into account) from the meter and sends them to the <a href="https://thingspeak.com/">ThingSpeak</a> website. <br><br>  On the site, you first need to register, create your channel data <b>channel</b> and name the <b>fields</b> .  Also, to write data to the channel, you need the <b>write API key</b> . <br><br><img src="https://habrastorage.org/files/e1c/2f6/e1c/e1c2f6e1cb46408aa0802e5c16089a19.png"><br><br><div class="spoiler">  <b class="spoiler_title">Python Script Code</b> <div class="spoiler_text">  #! / usr / bin / python2 <br>  import struct <br>  import pymodbus.client.sync <br>  import binascii <br>  import time <br>  import sys <br>  import urllib <br><br>  def read_float_reg (client, basereg, unit = 1): <br>  resp = client.read_input_registers (basereg, 2, unit = 1) <br>  if resp == None: <br>  return none <br>  # according to spec, each pair of registers returned <br>  # encodes a IEEE754 float where the first register carries <br>  # the most significant 16 bits <br>  # least significant 16 bits. <br>  return struct.unpack ('&gt; f', struct.pack ('&gt; HH', * resp.registers)) <br><br>  def fmt_or_dummy (regfmt, val): <br>  if val is None: <br>  return '.' * len (regfmt [2]% (0)) <br>  return regfmt [2]% (val) <br><br>  def main (): <br>  regs = [ <br>  # Symbol Reg # Format <br>  ('V:', 0x00, '% 6.2f'), # Voltage [V] <br>  ('Curr:', 0x06, '% 6.2f'), # Current [A] <br>  ('Pact:', 0x0c, '% 6.0f'), # Active Power ("Wirkleistung") [W] <br>  ('Papp:', 0x12, '% 6.0f'), # Apparent Power ("Scheinl.") [W] <br>  ('Prea:', 0x18, '% 6.0f'), # Reactive Power ("Blindl.") [W] <br>  ('PF:', 0x1e, '% 6.3f'), # Power Factor [1] <br>  ('Phi:', 0x24, '% 6.1f'), # cos (Phi)?  [one] <br>  ('Freq:', 0x46, '% 6.2f'), # Line Frequency [Hz] <br>  ('Wact:', 0x0156, '% 6.2f'), # Energy [kWh] <br>  ('Wrea:', 0x0158, '% 6.2f'), # Energy react [kvarh] <br>  ] <br><br>  cl = pymodbus.client.sync.ModbusSerialClient ('rtu', <br>  port = '/ dev / ttyUSB0', baudrate = 9600, parity = 'N', stopbits = 1, <br>  timeout = 0.8) <br><br>  values ‚Äã‚Äã= [read_float_reg (cl, reg [1], unit = 1) for reg in regs] <br>  outvals = list (('' .join ([fmt_or_dummy (* t) for t in zip (regs, values)])). split ()) <br>  params = urllib.urlencode ({'key': 'xxxxxxxxxxxxxxxxxx', 'field1': outvals [0], 'field2': outvals [1], 'field3': outvals [2], 'field4': outvals [8] }) <br>  f = urllib.urlopen (‚Äú <a href="https://api.thingspeak.com/update">api.thingspeak.com/update</a> ‚Äù, data = params) <br>  print (outvals) <br>  sys.stdout.flush () <br><br><br>  if __name__ == '__main__': <br>  main () <br></div></div><br>  The script takes all the available parameters from the meter, but only the main ones are transmitted to the site, if you wish, you can transfer everything. <br><br>  The result will be immediately displayed on the site (the screen shows statistics for some time, the first survey will contain only one point with a value) <br><br><img src="https://habrastorage.org/files/55b/6e7/c56/55b6e7c5616343289515879508fd9248.png"><br><br>  By default, the graphs display the last 60 readings, which, when polled once a minute, gives the result for the last hour.  For each graph, you can customize the display <br><br><img src="https://habrastorage.org/files/738/176/a12/738176a12bf844d0aa66287b1ced9891.png"><br><br>  For voltage, I adjusted statistics for 6 hours with averaging over 10 values ‚Äã‚Äãand smoothing the curve (spline). <br><br>  It can be seen that the graph of energy consumption is an ever-increasing curve, and I would like to see the flow per hour, day and month, for this the site has an analyst based on the MATLAB engine and the ability to run events over time. <br><br>  To collect hourly statistics, did the following: <br><br><ol><li>  Created a second channel <b>PowerStatistic</b> ; <br><br></li><li>  In <b>Apps -&gt; MATLAB Analysis, I</b> created a script that takes the current energy value and subtracts the value an hour ago.  The result is entered into the channel field; <br><br></li><li>  In <b>Apps -&gt; Time Control, I</b> created a <b>GetPowerPerHour</b> event that will run a Matlab script every 00 hours. </li></ol><br><div class="spoiler">  <b class="spoiler_title">PowerPerHour Script</b> <div class="spoiler_text">  % ID of the source channel, in which data from the counter are placed, if the channel is private, you need to specify Read API Key <br>  readChannelID = 154291; <br><br>  % Channel ID to record processed data (PowerStatistic) <br>  writeChannelID = 157182; <br>  writeAPIKey = 'xxxxxxxxxxxxxxxxxx'; <br><br>  %% Read Data %% <br>  data1 = thingSpeakRead (readChannelID, 'Fields', 4); <br>  data2 = thingSpeakRead (readChannelID, 'Fields', 4, 'NumMinutes', 60); <br>  value = data1-data2 (1); <br><br>  % in data1 read the last value from the 4th field (Energy) <br>  % reading in data2 is done crookedly, but I haven‚Äôt yet come up with another, read the last 60 values ‚Äã‚Äã(per hour) and take the first one <br><br>  %% Analyze Data %% <br>  % had to add rounding to two characters, because despite the fact that in the original array the values ‚Äã‚Äãare rounded to two decimal places, the result of the subtraction for some reason looked like this: 0.2700000000000031 <br>  analyzedData = round (value, 2); <br><br>  % disp can be used to debug data <br>  % disp (analyzedData); <br><br>  If analyzedData has one value, not a vector, it will be recorded in the first field of the channel.  To write to other fields you need to add 'Fields', 2, for example. <br>  %% Write Data %% <br>  thingSpeakWrite (writeChannelID, analyzedData, 'WriteKey', writeAPIKey); </div></div><br>  There is an unpleasant cant on the site, there is a <b>Save &amp; Run</b> button for applying the script, which makes an entry to the channel every time, so it‚Äôs better to comment out the record line until full debugging, however, even when the script is ready, you can‚Äôt just save it without launching, but running the script immediately records the data into the channel.  Delete individual data from the channel is also impossible.  This question has already been raised on the <a href="http://community.thingspeak.com/forum/thingspeak-apps/rfe-save-without-running-or-run-without-action/">project forum</a> , but has not yet been fixed. <br><br><img src="https://habrastorage.org/files/cbc/93c/3f1/cbc93c3f1fa84c2baaf0fe7cdc054b49.png"><br><br>  The launch settings on a schedule, the script runs every hour.  The fact that the start of the launch at 12.00 can be ignored. <br><br>  We look in the channel result: <br><br><img src="https://habrastorage.org/files/6aa/dce/875/6aadce875ded468485c91604b4e48a74.png"><br><br>  For this graph in the settings specified <b>Type column</b> to display the power consumption by the hour.  The pop-up window corresponds to the peak of consumption at 12 o'clock (the cursor on the screen was not displayed). <br><br>  Similarly, the script that collects statistics for the day.  The script runs at 00:01 of each day and summarizes the 24 readings from the hourly archive. <br><br><div class="spoiler">  <b class="spoiler_title">PowerPerDay Script</b> <div class="spoiler_text">  readChannelID = 157182; <br>  readAPIKey = 'zzzzzzzzzzzzzzzzzzzzz'; <br><br>  writeChannelID = 157182; <br>  writeAPIKey = 'xxxxxxxxxxxxxxxxxxxx'; <br><br>  %% Read Data %% <br>  % read the last 24 values ‚Äã‚Äãfrom the first field of the channel <br>  data = thingSpeakRead (readChannelID, 'ReadKey', readAPIKey, 'Fields', 1, 'NumPoints', 24); <br><br>  %% Analyze Data %% <br>  % sum <br>  analyzedData = sum (data); <br><br>  % disp (analyzedData); <br><br>  %% Write Data %% <br>  thingSpeakWrite (writeChannelID, analyzedData, 'WriteKey', writeAPIKey, 'Fields', 2); <br></div></div><br>  ThingSpeak also has Android apps.  To view the latest values, I liked <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.buzsikdev.pocketiot%26hl%3Dru">Pocket IoT</a> , and for charts, <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.cinetica_tech.thingview%26hl%3Dru">ThingView</a> .  There are also a couple of widgets, but they are some kind of curves. <br><br>  ¬ªChannel <a href="https://thingspeak.com/channels/154291">PowerMeter</a> <br>  ¬ª <a href="https://thingspeak.com/channels/157182">PowerStatistic</a> Channel <br><br>  On this, perhaps, everything.  The article does not claim to be a tutorial, since I just started to get acquainted with the possibilities of ThingSpeak, any additions, comments and edits are welcome. </div><p>Source: <a href="https://habr.com/ru/post/309580/">https://habr.com/ru/post/309580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309570/index.html">About the Internet of things and the semiconductor industry in the region where they drink camel milk. The first day</a></li>
<li><a href="../309572/index.html">Offline-first app with Hoodie & React. Part Two: Authorization</a></li>
<li><a href="../309574/index.html">Integration of Intel AMT settings in the management console</a></li>
<li><a href="../309576/index.html">Welcome to the Python-Meetup September 22</a></li>
<li><a href="../309578/index.html">New statistics Y Combinator will tell startups the direction of development</a></li>
<li><a href="../309582/index.html">Opinion Habr: disable or not a large site owed 450 000 rubles?</a></li>
<li><a href="../309584/index.html">3 useful tools for the preparation of a marketing campaign in E-commerce</a></li>
<li><a href="../309586/index.html">MS Office spells the words to a new line</a></li>
<li><a href="../309588/index.html">Announcement of the conference "Designing Business Architectures 2016"</a></li>
<li><a href="../309592/index.html">Review services cloud PBX Beeline</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>