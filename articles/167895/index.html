<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Long Polling A to Z do it yourself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to implement long polling using Nginx and Javascript in the network a lot of material. But I haven‚Äôt met a complete guide yet. Then there are prob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Long Polling A to Z do it yourself</h1><div class="post__text post__text-html js-mediator-article">  How to implement long polling using Nginx and Javascript in the network a lot of material.  But I haven‚Äôt met a complete guide yet.  Then there are problems with the compilation of the module under Nginx, then the download icon rotates in the browser with long poll requests.  Under the cut, the full material is how to do it right. <br><a name="habracut"></a><br><br><h4>  Compiling Nginx module under linux </h4><br>  To support long polling connections in the Nginx server, a great <a href="https://github.com/wandenberg/nginx-push-stream-module">nginx-push-stream-module module is</a> implemented.  Since it is not included in the official delivery, it needs to be downloaded, configured and compiled with Nginx. <br><br>  Before this, you must have all the necessary packages installed. <br><pre><code class="bash hljs">apt-get install git apt-get install make apt-get install g++ apt-get install libpcre3 libpcre3-dev libpcrecpp0 libssl-dev zlib1g-dev</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next you need to download the nginx-push-stream-module, nginx module itself and compile them together. <br><br>  Clone a project from GIT <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://github.com/wandenberg/nginx-push-stream-module.git</code> </pre><br><br>  Download and unpack the latest nginx <br><pre> <code class="bash hljs">NGINX_PUSH_STREAM_MODULE_PATH=<span class="hljs-variable"><span class="hljs-variable">$PWD</span></span>/nginx-push-stream-module wget http://nginx.org/download/nginx-1.2.6.tar.gz tar xzvf nginx-1.2.6.tar.gz</code> </pre><br><br>  Configure and compile nginx with nginx-push-stream-module <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.2.6 ./configure --add-module=../nginx-push-stream-module make make install</code> </pre><br><br>  If there are no compilation errors, everything is ready.  Let us verify that we installed exactly that nginx and that now it really does have a module nginx-push-stream-module <br><pre> <code class="bash hljs">check: /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx -v <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> configuration: /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx -c <span class="hljs-variable"><span class="hljs-variable">$NGINX_PUSH_STREAM_MODULE_PATH</span></span>/misc/nginx.conf -t</code> </pre><br><br>  After executing these commands, you should see this: <br><pre> <code class="bash hljs">nginx version: nginx/1.2.6 the configuration file <span class="hljs-variable"><span class="hljs-variable">$NGINX_PUSH_STREAM_MODULE_PATH</span></span>/misc/nginx.conf syntax is ok configuration file <span class="hljs-variable"><span class="hljs-variable">$NGINX_PUSH_STREAM_MODULE_PATH</span></span>/misc/nginx.conf <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> is successful</code> </pre><br><br><h4>  Configuring Nginx for Long Polling Connections </h4><br>  To configure support for long polling, in the Nginx configuration, you need to register at least two controllers.  The first is for subscribers (those who will receive messages), the second for publishing messages (those who will send messages). <br><br>  Omitting the remaining server settings, the /usr/local/nginx/nginx.conf configuration file should look like this: <br><pre> <code class="bash hljs">... http { ... server { listen 80; server_name stream.example.com; charset utf-8; location /pub { push_stream_publisher admin; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$push_stream_channel_id</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_id</span></span>; allow 1.1.1.1 <span class="hljs-comment"><span class="hljs-comment"># ip     } location ~ /sub/(.*) { push_stream_subscriber long-polling; set $push_stream_channels_path $1; push_stream_last_received_message_tag $arg_tag; push_stream_last_received_message_time $arg_time; push_stream_longpolling_connection_ttl 25s; } } }</span></span></code> </pre><br><br>  In this example, / pub is the address for posting messages, only your server (1.1.1.1), from which events come, should see it, / sub is the address for subscribers, those to whom messages will be sent.  The identifier that will identify the subscribers is passed after / sub, and is taken as the id parameter in / pub. <br><br>  The very important parameters push_stream_last_received_message_tag and push_stream_last_received_message_time will be discussed below when we touch javascript. <br><br>  An example for understanding the work: <br>  You can create multiple subscribers by calling: <a href="http://stream.example.com/sub/1">stream.example.com/sub/1</a> , <a href="http://stream.example.com/sub/2">stream.example.com/sub/2</a> , <a href="http://stream.example.com/sub/3">stream.example.com/sub/3</a> .  Each of them will ‚Äúhang‚Äù on the Nginx server for 25 seconds (push_stream_longpolling_connection_ttl).  If we call the POST request on <a href="http://stream.example.com/pub%3Fid%3D2">stream.example.com/pub?id=2</a> and send the message ‚ÄúHello‚Äù in the body, the subscriber ‚Äúhanging‚Äù on / sub / 2 will receive the answer ‚ÄúHello‚Äù.  It is convenient to check this in the <a href="https://addons.mozilla.org/ru/firefox/addon/poster">Poster</a> plugin for FireFox. <br><br><h4>  Creating Javascript Subscribers </h4><br>  Most likely, you need to use long polling to update any data in the browser, and for this you will need to write a Javascript client. <br><br>  I tried different methods, but I chose <a href="http://en.wikipedia.org/wiki/XMLHttpRequest">XMLHttpRequest</a> as the standard.  Compared with other methods it has the following advantages: <br><ul><li>  Works great in all Chrome, FireFox, Opera, IE 8, 9, 10 browsers </li><li>  Browser does not hang the download page icon </li><li>  Works on different domains (cross-domain, if the server has support for <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> ) </li></ul><br><br>  Let the variable subID - stored a unique value for the subscriber <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> LongPolling = { <span class="hljs-attr"><span class="hljs-attr">etag</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">init</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, xhr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.time === <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.time = $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dateToUTCString(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>()); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.XDomainRequest) { <span class="hljs-comment"><span class="hljs-comment">//  IE,     (-  IE8) setTimeout(function () { $this.poll_IE($this); }, 2000); } else { //  XMLHttpRequest  mcXHR = xhr = new XMLHttpRequest(); xhr.onreadystatechange = xhr.onload = function () { if (4 === xhr.readyState) { //    if (200 === xhr.status &amp;&amp; xhr.responseText.length &gt; 0) { //  Etag  Last-Modified  Header  $this.etag = xhr.getResponseHeader('Etag'); $this.time = xhr.getResponseHeader('Last-Modified'); //    $this.action(xhr.responseText); } if (xhr.status &gt; 0) { //       $this.poll($this, xhr); } } }; //  long polling $this.poll($this, xhr); } }, poll: function ($this, xhr) { var timestamp = (new Date()).getTime(), url = 'http://stream.example.com/sub/' + subID + '?callback=?&amp;v=' + timestamp; // timestamp       xhr.open('GET', url, true); xhr.setRequestHeader("If-None-Match", $this.etag); xhr.setRequestHeader("If-Modified-Since", $this.time); xhr.send(); }, //      poll(),   IE poll_IE: function ($this) { var xhr = new window.XDomainRequest(); var timestamp = (new Date()).getTime(), url = 'http://stream.example.com/sub/' + subID + '?callback=?&amp;v=' + timestamp; xhr.onprogress = function () {}; xhr.onload = function () { $this.action(xhr.responseText); $this.poll_IE($this); }; xhr.onerror = function () { $this.poll_IE($this); }; xhr.open('GET', url, true); xhr.send(); }, action: function (event) { //  ,    -  ... }, valueToTwoDigits: function (value) { return ((value &lt; 10) ? '0' : '') + value; }, //     UTC dateToUTCString: function () { var time = this.valueToTwoDigits(date.getUTCHours()) + ':' + this.valueToTwoDigits(date.getUTCMinutes()) + ':' + this.valueToTwoDigits(date.getUTCSeconds()); return this.days[date.getUTCDay()] + ', ' + this.valueToTwoDigits(date.getUTCDate()) + ' ' + this.months[date.getUTCMonth()] + ' ' + date.getUTCFullYear() + ' ' + time + ' GMT'; } }</span></span></code> </pre><br><br>  It is important to say about the two parameters etag and time. <br><pre> <code class="javascript hljs">xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-None-Match"</span></span>, $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.etag); xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"If-Modified-Since"</span></span>, $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.time);</code> </pre><br>  Without them, long polling did not always work and messages came through again.  These two parameters are needed by the nginx-push-stream-module module to identify messages that the subscriber has not yet received.  So for stable work, it is just necessary. <br><br><h4>  In custody </h4><br>  The method described in this topic is used and successfully works in our comment system <a href="http://cackle.me/">Cackle</a> .  Every day we have about 20 000 - 30 000 parallel subscribers, and we have never observed any errors in the delivery of messages.  For production solutions, this is exactly what you need. </div><p>Source: <a href="https://habr.com/ru/post/167895/">https://habr.com/ru/post/167895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167883/index.html">Utilization of liquid crystal and plasma displays</a></li>
<li><a href="../167887/index.html">Domain disputes solves the case</a></li>
<li><a href="../167889/index.html">Amazon Web Services: cheaper again</a></li>
<li><a href="../167891/index.html">Someone got a report on natural gas 400 milliseconds earlier.</a></li>
<li><a href="../167893/index.html">Using ssh socks proxy with MSF Reverse TCP Payloads</a></li>
<li><a href="../167903/index.html">And this is Chelyabinsk ... UWDC venue!</a></li>
<li><a href="../167905/index.html">In the footsteps of a mobile phone. Geolocation via cellular network</a></li>
<li><a href="../167907/index.html">Rambler closes Map projects, Avia, Photos, Dictionaries, Rambler Plus</a></li>
<li><a href="../167909/index.html">Interview with the creator of C ++ STL, 1995 Part 3</a></li>
<li><a href="../167911/index.html">The Moscow Government opens co-working center to help small businesses.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>