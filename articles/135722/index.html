<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Routing requests in Autodaf√©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Autodaf√© - node.js framework, start to read in this article: habrahabr.ru/blogs/nodejs/135089 

 The main part of the article will be devoted to the r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Routing requests in Autodaf√©</h1><div class="post__text post__text-html js-mediator-article">  Autodaf√© - node.js framework, start to read in this article: <a href="http://habrahabr.ru/blogs/nodejs/135089/">habrahabr.ru/blogs/nodejs/135089</a> <br><br>  The main part of the article will be devoted to the redirection of requests to autodafe, the formation of URLs, etc. But first, I would like to highlight the general principles of the application with connected clients, in order to make it clearer which part of the workflow we will discuss. <br><br><h3>  Where does the dust come from </h3><br>  Let's start with a diagram showing the connection of clients to the application: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/44a/2f2/551/44a2f255167a117b699c6c98ed0fe714.png"><br><br>  On the diagram you can see several users who use different devices and different browsers, which in turn connect to the application using different protocols.  (At the moment, you can only connect to autodafe via http and websockets) <br><br>  In the application, each connection corresponds to one Client.  Client is created for each http request and websockets connection.  Clients with the same session ID belong to the same Session instance.  Usually one session per application corresponds to one browser. <br><br>  Well, for logical completion, the ‚Äúusers‚Äù component is shown in the diagram, which allows you to bind different sessions that have passed special authorization to one UserIdentity object.  Thus, in an application, each UserIdentity object is associated with one real user. <br><br><a name="habracut"></a><br><br><h3>  Where does the money go </h3><br>  So we come to the topic of this article: writing routing.  Each Client, upon receiving a request, forms it in a special form and sends it to Router.  And he, in turn, using the routing table (Route map in the diagram) redirects the request to the desired action of the desired controller. <br><br>  Thus: each request <i>for any protocol is</i> redirected using the table described <i>in one place</i> <br><br><img src="https://habrastorage.org/storage2/001/e3e/dba/001e3edbab7ed31d27cd66730caaf33d.png"><br><br><h3>  Routing table </h3><br>  In the routing table you can specify: <br><ul><li>  by itself, redirecting requests to the action of a specific controller </li><li>  parameters for human-readable URLs </li><li>  methods and protocols for which these actions are available </li><li>  redirection depending on the host from which the request came, to which port it came, etc. </li></ul><br>  The routing table serves not only to parse the incoming request, but also to form a URL on the server, which allows you to flexibly change the appearance of the URL, making edits in one place. <br><br>  Controllers are ordinary classes.  Actions are methods.  No query will work if it is not listed in the routing table.  In this way, non-action methods of the controller are protected from being invoked. <br><br>  For the following examples, you can take the Hello World application described in <a href="http://habrahabr.ru/blogs/nodejs/135089/">this</a> article.  Now there is only one rule in the router.rules section of the configuration file: <br><br><pre><code class="javascript hljs">router : { <span class="hljs-attr"><span class="hljs-attr">rules</span></span> : { <span class="hljs-string"><span class="hljs-string">''</span></span> : <span class="hljs-string"><span class="hljs-string">'site.index'</span></span> } }</code> </pre> <br>  The keys of the rules section correspond to the part of the url of the address that comes after the host name and to the request parameters, so for the url of the address <a href="http://www.example.com/messages/unread%3Fuser_id%3D5">www.example.com/messages/unread?user_id=5</a> this part is equal to messages / unread. <br><br>  Values ‚Äã‚Äãrules - this is the path to the action that must be performed for this request in the form of 'controller. Action' <br><br><pre> <code class="javascript hljs">router : { <span class="hljs-attr"><span class="hljs-attr">rules</span></span> : { <span class="hljs-string"><span class="hljs-string">''</span></span> : <span class="hljs-string"><span class="hljs-string">'site.index'</span></span>, <span class="hljs-string"><span class="hljs-string">'messages/unread'</span></span> : <span class="hljs-string"><span class="hljs-string">'dialogs.show_unread_messages'</span></span> } }</code> </pre><br><br><h3>  Creating a URL </h3><br><br>  In the controller code, to create the required URL, use the create_url method: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.create_url( <span class="hljs-string"><span class="hljs-string">'dialogs.show_unread_messages'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//  '/messages/unread'</span></span></code> </pre><br>  Often, links should be inserted into the view; dust is now used as a templating engine; a special function url is written for it: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{#url}dialogs.show_unread_messages{/url}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h3>  Parameter passing </h3><br><br>  Creating a link inside the controller: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.create_url( <span class="hljs-string"><span class="hljs-string">'dialogs.show_unread_messages'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_id</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span> } ); <span class="hljs-comment"><span class="hljs-comment">//  '/messages/unread?user_id=5'</span></span></code> </pre><br>  In the view: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{#url user_id="5"}dialogs.show_unread_messages{/url}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h3>  Putting parameters in the way </h3><br><br>  The bottom line: convert / messages / unread? User_id = 5 to / messages / unread / user / 5 <br><br>  Rules section: <br><br><pre> <code class="javascript hljs">rules : { <span class="hljs-string"><span class="hljs-string">'/messages/unread/user/&lt;user_id:\\d+&gt;'</span></span> : <span class="hljs-string"><span class="hljs-string">'dialogs.dialogs.show_unread_messages'</span></span> }</code> </pre><br>  As you can see, we simply define the name of the parameter and the regular expression to which it should match.  Neither the controller nor the view changes should be done. <br><br><h3>  Filter requests </h3><br>  Some actions need to be performed, for example, only if they came through a POST request or via WebSockets.  This can be specified directly in the table. <br><br><pre> <code class="javascript hljs">rules : { <span class="hljs-comment"><span class="hljs-comment">//       POST 'update_message' : 'dialogs.update_message | post' }</span></span></code> </pre><br>  Instead of post, there can be get, delete, and ws.  The latter restricts the call only to actions received via WebSockets <br><br>  Methods can be grouped by comma: <br><br><pre> <code class="javascript hljs">rules : { <span class="hljs-comment"><span class="hljs-comment">//       POST 'delete_message' : 'dialogs.delete_message | post, delete' }</span></span></code> </pre><br>  Spaces are not taken into account, so you can easily align everything into a beautiful view. <br><br>  Filter queries by domain name and port <br><br><pre> <code class="javascript hljs">rules : { <span class="hljs-string"><span class="hljs-string">'hostname:m.domain.com port:3000 /'</span></span> : <span class="hljs-string"><span class="hljs-string">'mobile.index'</span></span> }</code> </pre><br>  In more detail, this topic will be disclosed in the upcoming documentation site. <br><br>  Thanks for attention. <br><br><h3>  PS: </h3><br>  <a href="https://github.com/jifeon/autodafe">Github</a> source code: <a href="https://github.com/jifeon/autodafe">autodafe</a> <br>  Follow the framework on twitter <a href="https://twitter.com/">@node_autodafe</a> <br><br>  If you want to take part in the development or in any way to help in the development of the framework - write in a personal or jifeon at gmail.com </div><p>Source: <a href="https://habr.com/ru/post/135722/">https://habr.com/ru/post/135722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135717/index.html">Release MODx 2.2</a></li>
<li><a href="../135718/index.html">Contribute to ReactOS or CFI @ habrahabr</a></li>
<li><a href="../135719/index.html">Configure Synology Server: Web Server</a></li>
<li><a href="../135720/index.html">D programming language - continuation 2</a></li>
<li><a href="../135721/index.html">Anonymous against neo-Nazis</a></li>
<li><a href="../135723/index.html">ARM v8 architecture processors go to server</a></li>
<li><a href="../135724/index.html">XEN is ported to ARMv5 and v7</a></li>
<li><a href="../135725/index.html">Programming for the PlayStation 2: Controller Library - Part One</a></li>
<li><a href="../135726/index.html">Configuring route switching between two providers on JunOS 11.1 or higher</a></li>
<li><a href="../135728/index.html">IBM Hunters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>