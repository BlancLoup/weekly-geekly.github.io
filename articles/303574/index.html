<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing demons on Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not long ago, I had the honor of doing the implementation of demons (workers) on Node.js for use in all projects developed by our company. We often de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing demons on Node.js</h1><div class="post__text post__text-html js-mediator-article"><p>  Not long ago, I had the honor of doing the implementation of demons (workers) on Node.js for use in all projects developed by our company.  We often develop projects where it is necessary to process and distribute video files on several servers, so we need to have a ready-made tool for this. </p><br><p>  Formulation of the problem: </p><br><ul><li>  Development should be on Node.js.  We have been using this platform for a long time to develop all our projects, so here it is a justified choice. </li><li>  All nodes in the cluster should be equivalent.  There should be no special manager or master.  Otherwise, stopping the wizard can cause the entire cluster to stop. </li><li>  Tasks must be in the MySQL table.  It is much more flexible and informative than using any MQ.  You can always access all tasks, evaluate the queue, reassign them to another node, etc. </li><li>  Each worker must be able to handle several tasks at the same time. </li></ul><br><p>  Immediately provide a link to GitHub of what happened: ( <a href="https://github.com/pipll/node-daemons">https://github.com/pipll/node-daemons</a> ). <a name="habracut"></a></p><br><h2 id="zapusk-vorkerov">  Run Workers </h2><br><p>  Each worker is a separate Node.js process.  To create a process vorker used built-in <strong>cluster</strong> .  It also controls the fall of the workers and restarts them. </p><br><div class="spoiler">  <b class="spoiler_title">Vorker startup code</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config/config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cluster = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cluster'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logger = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log4js'</span></span>).getLogger(<span class="hljs-string"><span class="hljs-string">'app'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./models'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         let shutdownInterval = null; if (cluster.isMaster) { //   _.each(config.workers, (conf, name) =&gt; { if (conf.enabled) { startWorker(name); } }); } else { //   let name = process.env.WORKER_NAME; let WorkerClass = require(path.join(__dirname, 'workers', name + '.js')); let worker = null; if (WorkerClass) { worker = new WorkerClass(name, config.workers[name]); //   worker.start(); //   ,    worker.on('stop', () =&gt; { process.exit(); }); } //      process.on('message', message =&gt; { if ('shutdown' === message) { if (worker) { worker.stop(); } else { process.exit(); } } }); } // Shutdown process.on('SIGTERM', shutdownCluster); process.on('SIGINT', shutdownCluster); //    function startWorker(name) { let worker = cluster.fork({WORKER_NAME: name}).on('online', () =&gt; { logger.info('Start %s worker #%d.', name, worker.id); }).on('exit', status =&gt; { //     if ((worker.exitedAfterDisconnect || worker.suicide) === true || status === 0) { //     ,      logger.info('Worker %s #%d was killed.', name, worker.id); } else { //     ,      logger.warn('Worker %s #%d was died. Replace it with a new one.', name, worker.id); startWorker(name); } }); } //    function shutdownCluster() { if (cluster.isMaster) { clearInterval(shutdownInterval); if (_.size(cluster.workers) &gt; 0) { //      logger.info('Shutdown workers:', _.size(cluster.workers)); _.each(cluster.workers, worker =&gt; { try { worker.send('shutdown'); } catch (err) { logger.warn('Cannot send shutdown message to worker:', err); } }); //     shutdownInterval = setInterval(() =&gt; { if (_.size(cluster.workers) === 0) { process.exit(); } }, config.shutdownInterval); } else { process.exit(); } } }</span></span></code> </pre> </div></div><br><p>  I would like to draw attention to a few points: </p><br><ul><li>  To start a worker, the <strong>fork of the</strong> process is used, and the <code>WORKER_NAME</code> environment <code>WORKER_NAME</code> is passed the name of the worker being started. </li><li>  When the worker is uncontrollably shutting down, we restart it. </li><li>  To controlfully stop the workers, we send them a <strong>shutdown</strong> signal.  A worker responds to this event and after completing the execution of the task does <code>process.exit()</code> . </li><li>  The wizard monitors the number of workers with <code>setInterval</code> and when all workers are stopped, makes <code>process.exit()</code> . </li></ul><br><h2 id="komponent-bazovogo-vorkera">  Base Worker Component </h2><br><p>  This component is designed to perform periodic processes and does not work with the task queue. </p><br><div class="spoiler">  <b class="spoiler_title">Base Worker Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bluebird'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> log4js = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log4js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EventEmitter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'events'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WorkerStates = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./worker_states'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(name, conf) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; <span class="hljs-comment"><span class="hljs-comment">//     this.conf = _.defaults({}, conf, { sleep: 1000 //    }); this.logger = log4js.getLogger('worker-' + name); //    this.stopped = true; //      loop  this.timer = null; //   this.state = null; } //    start() { this.logger.info('Start'); this.stopped = false; this.state = WorkerStates.STATE_IDLE; return this._startLoop(); } //    stop() { this.logger.info('Stop'); this.stopped = true; if (this.state === WorkerStates.STATE_IDLE) { //    if (this.timer) { clearTimeout(this.timer); this.timer = null; } this.state = WorkerStates.STATE_STOP; //     this.emit('stop'); } } //      loop() { return Promise.resolve(); } //     loop  _startLoop() { this.state = WorkerStates.STATE_WORK; return this.loop().catch(err =&gt; { this.logger.warn('Loop error:', err); }).finally(() =&gt; { this.state = WorkerStates.STATE_IDLE; if (!this.stopped) { //       loop  this.timer = setTimeout(() =&gt; { this._startLoop(); }, this.conf.sleep); } else { this.state = WorkerStates.STATE_STOP; //     this.emit('stop'); } }); } } module.exports = Worker;</span></span></code> </pre> </div></div><br><p>  The simplest worker code might look like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bluebird'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Worker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../components/worker'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class"> </span></span>{ loop() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.info(<span class="hljs-string"><span class="hljs-string">"Loop method"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve().delay(<span class="hljs-number"><span class="hljs-number">30000</span></span>); } } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = Sample;</code> </pre> <br><p>  Some features: </p><br><ul><li>  <code>loop</code> method is intended for inheritance in descendants and implementation of business tasks.  The return value of this method should be <code>Promise</code> . </li><li>  When the <code>loop</code> method is finished, it starts again after the time specified in the settings of the worker. </li><li>  A worker has three states: <br><ul><li>  <strong>STATE_IDLE</strong> - during a pause between runs of the <code>loop</code> method. </li><li>  <strong>STATE_WORK</strong> - while the <code>loop</code> method is running. </li><li>  <strong>STATE_STOP</strong> - after stopping the worker. </li></ul></li></ul><br><h2 id="komponent-vorkera-obrabotki-zadach">  Task processing component </h2><br><p>  This is the main component designed for parallel processing of tasks from the MySQL table. </p><br><div class="spoiler">  <b class="spoiler_title">Task Processing Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config/config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bluebird'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Worker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./worker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WorkerStates = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./worker_states'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../models'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskWorker</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(name, conf) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(name, conf); <span class="hljs-comment"><span class="hljs-comment">//     this.conf = _.defaults({}, this.conf, { maxAttempts: 3, //      delayRatio: 300000, //      count: 1, //      queue: '', //      update: 3000 //     }); //     this.count = 0; } loop() { if (this.count &lt; this.conf.count &amp;&amp; !this.stopped) { //    return this._getTask().then(task =&gt; { if (task) { //      this.count++; //      let interval = setInterval(() =&gt; { return models.sequelize.transaction(t =&gt; { return task.touch({transaction: t}); }); }, this.conf.update); //     this.handleTask(task.get({plain: true})).then(() =&gt; { //   return models.sequelize.transaction(t =&gt; { return task.complete({transaction: t}).then(() =&gt; { this.logger.info('Task completed:', task.id); }); }); }).catch(err =&gt; { //     -   this.logger.warn('Handle error:', err); return this.delay(task).then(delay =&gt; { return models.sequelize.transaction(t =&gt; { return task.fail(delay, {transaction: t}).then(() =&gt; { this.logger.warn('Task failed:', task.id); }); }); }); }).finally(() =&gt; { clearInterval(interval); this.count--; }).done(); return null; } }); } else { return Promise.resolve(); } } //    handleTask() { return Promise.resolve(); } //        delay(task) { return Promise.resolve().then(() =&gt; { return task.attempts * this.conf.delayRatio; }); } //      _getTask() { return models.sequelize.transaction({autocommit: false}, t =&gt; { return models.Task.scope({ method: ['forWork', this.conf.queue, config.node_id] }).find({transaction: t, lock: t.LOCK.UPDATE}).then(task =&gt; { if (task) { return task.work(config.node_id, {transaction: t}); } }); }); } _startLoop() { this.state = WorkerStates.STATE_WORK; return this.loop().catch(err =&gt; { this.logger.warn('Loop error:', err); }).finally(() =&gt; { if (this.count === 0) { this.state = WorkerStates.STATE_IDLE; } if (this.stopped &amp;&amp; this.count === 0) { this.state = WorkerStates.STATE_STOP; this.emit('stop'); } else { this.timer = setTimeout(() =&gt; { this._startLoop(); }, this.conf.sleep); } }); } } module.exports = TaskWorker;</span></span></code> </pre> </div></div><br><p>  The simplest worker code might look like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bluebird'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TaskWorker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../components/task_worker'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskWorker</span></span></span><span class="hljs-class"> </span></span>{ handleTask(task) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.info(<span class="hljs-string"><span class="hljs-string">'Sample Task:'</span></span>, task); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve().delay(<span class="hljs-number"><span class="hljs-number">30000</span></span>); } } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = Sample;</code> </pre> <br><p>  Features of the component: </p><br><ul><li>  To retrieve a task from the database, use the <code>SELECT ... FOR UPDATE</code> and the subsequent <code>UPDATE</code> records in the database in the same transaction with the autocommit disabled.  This allows you to get exclusive access to the task even with simultaneous requests from multiple servers. </li><li>  During task processing, a periodic process of updating the task status in the database is started.  This is necessary to distinguish a long-running task from an unexpectedly completed task without updating the status. </li><li>  The status of the processed task is determined by the <code>Promise</code> status returned by the <code>handleTask</code> method.  If successful, the task is marked as completed.  Otherwise, the task is marked as a failure and starts with a delay specified in the <code>delay</code> method. </li></ul><br><h2 id="model-raboty-s-zadachami">  Task Model </h2><br><p>  The <strong>sequelize</strong> module is used to work with database models.  All tasks are in the <strong>tasks</strong> table.  The table has the following structure: </p><br><table><thead><tr><th>  Field </th><th>  Type of </th><th>  Description </th></tr></thead><tbody><tr><td> <code>id</code> </td> <td>  integer autoincrement </td><td>  Task id </td></tr><tr><td> <code>node_id</code> </td> <td>  integer nullable </td><td>  ID of the node for which the task is intended </td></tr><tr><td> <code>queue</code> </td> <td>  string </td><td>  Task queue </td></tr><tr><td> <code>status</code> </td> <td>  enum </td><td>  Task status </td></tr><tr><td> <code>attempts</code> </td> <td>  integer </td><td>  Number of task start attempts </td></tr><tr><td> <code>priority</code> </td> <td>  integer </td><td>  Task priority </td></tr><tr><td> <code>body</code> </td> <td>  string </td><td>  Task body in JSON format </td></tr><tr><td> <code>start_at</code> </td> <td>  datetime, nullable </td><td>  Date and time the task began processing </td></tr><tr><td> <code>finish_at</code> </td> <td>  datetime, nullable </td><td>  Date and time of the end of the processing task (analogue TTL) </td></tr><tr><td> <code>worker_node_id</code> </td> <td>  integer nullable </td><td>  ID of the node that started processing the task </td></tr><tr><td> <code>worker_started_at</code> </td> <td>  datetime, nullable </td><td>  Date and time the task began processing </td></tr><tr><td> <code>checked_at</code> </td> <td>  datetime, nullable </td><td>  Date and time of task status update </td></tr><tr><td> <code>created_at</code> </td> <td>  datetime, nullable </td><td>  Date and time of task creation </td></tr><tr><td> <code>updated_at</code> </td> <td>  datetime, nullable </td><td>  Date and time of task change </td></tr></tbody></table><br><p>  A task can be assigned either to a specific node or to any node in the cluster.  This is governed by the <code>node_id</code> field during task creation.  The task can be started with a delay ( <code>start_at</code> field) and with a limited processing time ( <code>finish_at</code> field). </p><br><p>  Different workers work with different queues of tasks specified in the <code>queue</code> field.  Processing priority is set in the <code>priority</code> field (the higher, the higher the priority).  The number of task restarts is saved in the <code>attempts</code> field.  In the body of the task (the <code>body</code> field) in JSON format the parameters necessary for the worker are passed. </p><br><p>  The <code>checked_at</code> field serves as an indication of a running task.  Its value changes all the time while the task is running.  If the value of the <code>checked_at</code> field has not changed for a long time, and the task is in the <strong>working</strong> status, the task is considered failed and its status changes to <strong>failure</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Task Model Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> moment = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moment'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sequelize, Sequelize</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sequelize.define(<span class="hljs-string"><span class="hljs-string">'Task'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.INTEGER, <span class="hljs-attr"><span class="hljs-attr">primaryKey</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">autoIncrement</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">node_id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.INTEGER }, <span class="hljs-attr"><span class="hljs-attr">queue</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.STRING, <span class="hljs-attr"><span class="hljs-attr">allowNull</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.ENUM, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: [<span class="hljs-string"><span class="hljs-string">'pending'</span></span>, <span class="hljs-string"><span class="hljs-string">'working'</span></span>, <span class="hljs-string"><span class="hljs-string">'done'</span></span>, <span class="hljs-string"><span class="hljs-string">'failure'</span></span>], <span class="hljs-attr"><span class="hljs-attr">defaultValue</span></span>: <span class="hljs-string"><span class="hljs-string">'pending'</span></span>, <span class="hljs-attr"><span class="hljs-attr">allowNull</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-attr"><span class="hljs-attr">attempts</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.INTEGER, <span class="hljs-attr"><span class="hljs-attr">defaultValue</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">allowNull</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-attr"><span class="hljs-attr">priority</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.INTEGER, <span class="hljs-attr"><span class="hljs-attr">defaultValue</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">allowNull</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.TEXT, <span class="hljs-attr"><span class="hljs-attr">set</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">body</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setDataValue(<span class="hljs-string"><span class="hljs-string">'body'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(body)); }, <span class="hljs-attr"><span class="hljs-attr">get</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getDataValue(<span class="hljs-string"><span class="hljs-string">'body'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }, <span class="hljs-attr"><span class="hljs-attr">start_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.DATE }, <span class="hljs-attr"><span class="hljs-attr">finish_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.DATE }, <span class="hljs-attr"><span class="hljs-attr">worker_node_id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.INTEGER }, <span class="hljs-attr"><span class="hljs-attr">worker_started_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.DATE }, <span class="hljs-attr"><span class="hljs-attr">checked_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Sequelize.DATE } }, { <span class="hljs-attr"><span class="hljs-attr">tableName</span></span>: <span class="hljs-string"><span class="hljs-string">'tasks'</span></span>, <span class="hljs-attr"><span class="hljs-attr">freezeTableName</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">underscored</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">scopes</span></span>: { <span class="hljs-attr"><span class="hljs-attr">forWork</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">queue, node_id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">where</span></span>: { <span class="hljs-attr"><span class="hljs-attr">node_id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$or</span></span>: [ <span class="hljs-literal"><span class="hljs-literal">null</span></span>, node_id ] }, <span class="hljs-attr"><span class="hljs-attr">queue</span></span>: queue, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'pending'</span></span>, <span class="hljs-attr"><span class="hljs-attr">start_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$or</span></span>: [ <span class="hljs-literal"><span class="hljs-literal">null</span></span>, { <span class="hljs-attr"><span class="hljs-attr">$lt</span></span>: moment().toDate() } ] }, <span class="hljs-attr"><span class="hljs-attr">finish_at</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$or</span></span>: [ <span class="hljs-literal"><span class="hljs-literal">null</span></span>, { <span class="hljs-attr"><span class="hljs-attr">$gte</span></span>: moment().toDate() } ] } }, <span class="hljs-attr"><span class="hljs-attr">order</span></span>: [ [<span class="hljs-string"><span class="hljs-string">'priority'</span></span>, <span class="hljs-string"><span class="hljs-string">'DESC'</span></span>], [<span class="hljs-string"><span class="hljs-string">'attempts'</span></span>, <span class="hljs-string"><span class="hljs-string">'ASC'</span></span>], [sequelize.fn(<span class="hljs-string"><span class="hljs-string">'IFNULL'</span></span>, sequelize.col(<span class="hljs-string"><span class="hljs-string">'start_at'</span></span>), sequelize.col(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>)), <span class="hljs-string"><span class="hljs-string">'ASC'</span></span>] ] }; } }, <span class="hljs-attr"><span class="hljs-attr">instanceMethods</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fail</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">delay, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start_at = delay ? moment().add(delay, <span class="hljs-string"><span class="hljs-string">'ms'</span></span>).toDate() : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.attempts = sequelize.literal(<span class="hljs-string"><span class="hljs-string">'attempts + 1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = <span class="hljs-string"><span class="hljs-string">'failure'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.save(options); }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = <span class="hljs-string"><span class="hljs-string">'done'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.save(options); }, <span class="hljs-attr"><span class="hljs-attr">work</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node_id, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = <span class="hljs-string"><span class="hljs-string">'working'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.worker_node_id = node_id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.worker_started_at = moment().toDate(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.save(options); }, <span class="hljs-attr"><span class="hljs-attr">check</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.checked_at = moment().toDate(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.save(options); } } }); };</code> </pre> </div></div><br><h2 id="zhiznennyy-cikl-zadach">  Task life cycle </h2><br><p>  All tasks go through the following life cycle: </p><br><ol><li>  A new task is created with the <strong>pending</strong> status. </li><li>  When it is time to process the task, the first free worker receives it, translates it into <strong>working</strong> status and fills in the <code>worker_node_id</code> and <code>worker_started_at</code> . </li><li>  During the processing of the task, the worker with a certain frequency (every 10 seconds by default) updates the <code>checked_at</code> field to <code>checked_at</code> about the correct operation. </li><li>  At the end of work on a task there can be several scenarios: <br>  4.1.  If the task is successfully completed, the task is transferred to the <strong>done</strong> status. <br>  4.2.  If the task is completed, the task is transferred to the <strong>failure</strong> status, the number of <code>attempts</code> increases, and the launch is postponed for a specified amount of time (calculated in the <code>delay</code> method based on the number of attempts and the <code>delayRatio</code> setting). </li></ol><br><p>  The project also has a built-in <code>Manager</code> module that runs on each node and does the following task processing: </p><br><ol><li>  Transfers hung tasks to <strong>failure</strong> status. </li><li>  Transfers failed tasks to <strong>pending</strong> status for new processing. </li><li>  Removes outstanding tasks that have already expired. </li><li>  Removes successfully completed tasks with a delay of 1 hour (can be configured). </li><li>  Removes failed completed tasks with the spent number of launch attempts with a delay of 3 days (can be configured). </li></ol><br><p>  In addition, this module works with on / off nodes. </p><br><div class="spoiler">  <b class="spoiler_title">Manager Module Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> moment = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moment'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'bluebird'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Worker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../components/worker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../models'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config/config'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Manager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(name, conf) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(name, conf); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.conf = _.defaults({}, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.conf, { <span class="hljs-attr"><span class="hljs-attr">maxUpdate</span></span>: <span class="hljs-number"><span class="hljs-number">30000</span></span>, <span class="hljs-comment"><span class="hljs-comment">// 30 seconds maxCompleted: 3600000, // 1 hour maxFailed: 259200000 // 3 days }); } loop() { return models.sequelize.transaction(t =&gt; { return Promise.resolve() .then(() =&gt; { return this._checkCurrentNode(t); }) .then(() =&gt; { return this._activateNodes(t); }) .then(() =&gt; { return this._pauseNodes(t); }) .then(() =&gt; { return this._restoreFrozenTasks(t); }) .then(() =&gt; { return this._restoreFailedTasks(t); }) .then(() =&gt; { return this._deleteDeadTasks(t); }) .then(() =&gt; { return this._deleteCompletedTasks(t); }) .then(() =&gt; { return this._deleteFailedTasks(t); }); }); } _checkCurrentNode(t) { return models.Node.findById(config.node_id, {transaction: t}).then(node =&gt; { if (node) { return node.check(); } }); } _activateNodes(t) { return models.Node.update({ is_active: true }, { where: { is_active: false, checked_at: { $gte: moment().subtract(2 * this.conf.sleep).toDate() } }, transaction: t }).spread(count =&gt; { if (count &gt; 0) { this.logger.info('Activate nodes:', count); } }); } _pauseNodes(t) { return models.Node.update({ is_active: false }, { where: { is_active: true, checked_at: { $lt: moment().subtract(2 * this.conf.sleep).toDate() } }, transaction: t }).spread(count =&gt; { if (count &gt; 0) { this.logger.info('Pause nodes:', count); } }); } _restoreFrozenTasks(t) { return models.Task.update({ status: 'failure', attempts: models.sequelize.literal('attempts + 1') }, { where: { status: 'working', checked_at: { $lt: moment().subtract(this.conf.maxUpdate).toDate() } }, transaction: t }).spread(count =&gt; { if (count &gt; 0) { this.logger.info('Restore frozen tasks:', count); } }); } _restoreFailedTasks(t) { let where = [{status: 'failure'}]; let conditions = this._failedTasksConditions(); if (conditions.length) { where.push({$or: conditions}); } return models.Task.update({ status: 'pending', worker_node_id: null, worker_started_at: null }, { where: where, transaction: t }).spread(count =&gt; { if (count &gt; 0) { this.logger.info('Restore failure tasks:', count); } }); } _deleteDeadTasks(t) { return models.Task.destroy({ where: { status: 'pending', finish_at: { $lt: moment().toDate() } }, transaction: t }).then(count =&gt; { if (count &gt; 0) { this.logger.info('Delete dead tasks:', count); } }); } _deleteCompletedTasks(t) { return models.Task.destroy({ where: { status: 'done', checked_at: { $lt: moment().subtract(this.conf.maxCompleted).toDate() } }, transaction: t }).then(count =&gt; { if (count &gt; 0) { this.logger.info('Delete completed tasks:', count); } }); } _deleteFailedTasks(t) { let where = [ {status: 'failure'}, {checked_at: { $lt: moment().subtract(this.conf.maxFailed).toDate() }} ]; let conditions = this._failedTasksConditions(); if (conditions.length) { where.push({$or: conditions}); } return models.Task.destroy({ where: where, transaction: t }).then(count =&gt; { if (count &gt; 0) { this.logger.info('Delete failed tasks:', count); } }); } _failedTasksConditions() { let conditions = []; _.each(config.workers, (worker) =&gt; { if (worker.queue) { let item = {queue: worker.queue}; if (worker.maxAttempts !== undefined) { item.attempts = { $lt: worker.maxAttempts }; } conditions.push(item); } }); return conditions; } } module.exports = Manager;</span></span></code> </pre> </div></div><br><h2 id="vyvody-i-plany-na-buduschee">  Conclusions and future plans </h2><br><p>  In general, it turned out to be a good and fairly reliable tool for working with background tasks that we can share with the community.  We have developed the main ideas and principles used in this project over several years of work on various projects. </p><br><p>  In the project development plans: </p><br><ul><li>  Hotreload workers without restarting the master process.  To be able to update the code of individual workers, without interfering with the work of others. </li><li>  Adding information about the progress of the task (the <code>progress</code> field) and adding a method to the <code>TaskWorker</code> module to update this information. </li><li>  Creating various interfaces for working with tasks and nodes: <br><ul><li>  <strong>CLI</strong> </li><li>  <strong>Web</strong> </li><li>  <strong>API</strong> </li></ul></li><li>  Creating basic workers: <br><ul><li>  Processing video files. </li><li>  File replication between servers for secure storage. </li></ul></li><li>  Tests for workers. </li></ul><br><p>  I will be glad to constructive criticism and answer the questions of interest in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303574/">https://habr.com/ru/post/303574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303554/index.html">VIM: why, if there is an IDE, and how?</a></li>
<li><a href="../303560/index.html">Money does not smell: the scandalously bankrupt edition of Gawker begin to pull apart in parts</a></li>
<li><a href="../303562/index.html">Features of component caching in Unity3D</a></li>
<li><a href="../303566/index.html">When software communicates with us, should they be friendly</a></li>
<li><a href="../303572/index.html">We write an extension for PHP (7.0.7) without knowledge of C / C ++ and how it works in general</a></li>
<li><a href="../303576/index.html">Unique data center Finger Lakes Technologies Group inside the nuclear storage</a></li>
<li><a href="../303578/index.html">Creating a blog on symfony 2.8 lts [Part 6]</a></li>
<li><a href="../303580/index.html">How we develop a new frontend Tinkoff.ru</a></li>
<li><a href="../303582/index.html">C--. First meeting</a></li>
<li><a href="../303584/index.html">Experience in automating server REST API testing with Jmeter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>