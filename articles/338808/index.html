<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Review of music software code defects. Part 1. MuseScore</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Programming is a creative lesson, so there are many talented people among developers who have a peculiar hobby. Contrary to popular belief, this is no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Review of music software code defects. Part 1. MuseScore</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/293/1d5/2d2/2931d52d2c165e2d80f24cd1af6aeb29.png"></div><br>  Programming is a creative lesson, so there are many talented people among developers who have a peculiar hobby.  Contrary to popular belief, this is not always programming (well, or not only it: D).  Based on my passion for recording / processing music and professional activities, I decided to check the code quality of popular open source music programs.  The first for review is a program for editing notes - MuseScore.  Stock up on popcorn ... there will be a lot of serious bugs! <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  <a href="https://musescore.com/">MuseScore</a> is a computer program, music score editor for Windows, Mac OS X and Linux operating systems.  MuseScore allows you to quickly enter notes from both a computer keyboard and an external MIDI keyboard.  It supports the import and export of data in MIDI, MusicXML, LilyPond formats, as well as the import of files in the formats MusE, Capella and Band-in-a-Box.  In addition, the program can export scores to PDF, SVG and PNG files, or to LilyPond documents for further precise revision of the score. <br><br>  <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> is a tool for detecting errors in the source code of programs written in C, C ++ and C # languages.  Works in the environment of Windows and Linux. <br><br><h2>  Array Indexing Issues </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bcf/5d4/43a/bcf5d443afd2bca997c58f25daeecccb.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://www.viva64.com/ru/w/v557/">V557</a> Array overrun is possible.  The value of 'cidx' index could reach 4. staff.cpp 1029 <br><br><pre><code class="cpp hljs">ClefTypeList clefTypes[MAX_STAVES]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> staffLines[MAX_STAVES]; BracketType bracket[MAX_STAVES]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bracketSpan[MAX_STAVES]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> barlineSpan[MAX_STAVES]; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> smallStaff[MAX_STAVES]; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Staff::init(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> StaffType* staffType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cidx) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cidx &gt; MAX_STAVES) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= setSmall(0, false); } else { setSmall(0, t-&gt;smallStaff[cidx]); setBracketType(0, t-&gt;bracket[cidx]); setBracketSpan(0, t-&gt;bracketSpan[cidx]); setBarLineSpan(t-&gt;barlineSpan[cidx]); } .... }</span></span></code> </pre> <br>  The author of this code snippet made a serious mistake by comparing the index with the maximum size of the array.  For this reason, it became possible to go beyond the borders of four arrays at once. <br><br>  Corrected index check condition: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cidx &gt;= MAX_STAVES) { setSmall(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v557/">V557</a> Array overrun is possible.  The value of 'i' index could reach 59. inspectorAmbitus.cpp 70 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NoteHead</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Symbol { .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Group</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> { HEAD_NORMAL = <span class="hljs-number"><span class="hljs-number">0</span></span>, HEAD_CROSS, HEAD_PLUS, .... HEAD_GROUPS, <span class="hljs-comment"><span class="hljs-comment">// &lt;= 59 HEAD_INVALID = -1 }; .... } InspectorAmbitus::InspectorAmbitus(QWidget* parent) : InspectorElementBase(parent) { r.setupUi(addWidget()); s.setupUi(addWidget()); static const NoteHead::Group heads[] = { NoteHead::Group::HEAD_NORMAL, NoteHead::Group::HEAD_CROSS, NoteHead::Group::HEAD_DIAMOND, NoteHead::Group::HEAD_TRIANGLE_DOWN, NoteHead::Group::HEAD_SLASH, NoteHead::Group::HEAD_XCIRCLE, NoteHead::Group::HEAD_DO, NoteHead::Group::HEAD_RE, NoteHead::Group::HEAD_MI, NoteHead::Group::HEAD_FA, NoteHead::Group::HEAD_SOL, NoteHead::Group::HEAD_LA, NoteHead::Group::HEAD_TI, NoteHead::Group::HEAD_BREVIS_ALT }; .... for (int i = 0; i &lt; int(NoteHead::Group::HEAD_GROUPS); ++i) r.noteHeadGroup-&gt;setItemData(i, int(heads[i]));//out of bound .... }</span></span></code> </pre> <br>  Instead of counting the number of elements of the array, which are bypassed in the cycle, here they used a constant, which is almost four times more than this number.  In the cycle there is a guaranteed overrun of the array. <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical sub-expressions to the left and the right to the operator: - i - i text.cpp 1429 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Text::layout1() { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; rows(); ++i) { TextBlock* t = &amp;_layout[i]; t-&gt;layout(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QRectF* r = &amp;t-&gt;boundingRect(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r-&gt;height() == <span class="hljs-number"><span class="hljs-number">0</span></span>) r = &amp;_layout[ii].boundingRect(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= y += t-&gt;lineSpacing(); t-&gt;setY(y); bb |= r-&gt;translated(0.0, y); } .... }</span></span></code> </pre> <br>  The value of the index <i>[i - i]</i> , in this case, will always be zero.  Perhaps there was a mistake and wanted, for example, to refer to the previous element of the array. <br><br><h2>  Memory leaks </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f01/51d/d85/f0151dd8579e215b4cb9de9f97d80ae6.png"></p><br>  Using static analysis, you can also find memory leaks, and PVS-Studio does it.  Yes, static analyzers are weaker in their search for memory leaks than dynamic ones, but they can still find a lot of interesting things. <br><br>  In an unfamiliar project, it is difficult for me to check the accuracy of all warnings found, but in some places I managed to make sure that there was an error. <br><br>  <a href="https://www.viva64.com/ru/w/v773/">V773</a> Visibility scope of the beam.  A memory leak is possible.  read114.cpp 2334 <br><br><pre> <code class="cpp hljs">Score::FileError MasterScore::read114(XmlReader&amp; e) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"Excerpt"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MScore::noExcerpts) e.skipCurrentElement(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Excerpt* ex = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Excerpt(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ex-&gt;read(e); _excerpts.append(ex); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"Beam"</span></span>) { Beam* beam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Beam(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); beam-&gt;read(e); beam-&gt;setParent(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// _beams.append(beam); // &lt;= } .... }</span></span></code> </pre> <br>  In a large cascade of conditions, memory is allocated.  In each block of code, an object is created and a pointer to it is stored.  In the above code snippet, saving the pointer is commented out, adding an error to the code that leads to a memory leak. <br><br>  The 'voicePtr' pointer.  A memory leak is possible.  ove.cpp 3967 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> TrackParse::parse() { .... Track* oveTrack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Track(); .... QList&lt;Voice*&gt; voices; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">8</span></span>; ++i ) { Voice* voicePtr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Voice(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !jump(<span class="hljs-number"><span class="hljs-number">5</span></span>) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// &lt;= // channel if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voicePtr-&gt;setChannel(placeHolder.toUnsignedInt()); // volume if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voicePtr-&gt;setVolume(placeHolder.toInt()); // pitch shift if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voicePtr-&gt;setPitchShift(placeHolder.toInt()); // pan if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voicePtr-&gt;setPan(placeHolder.toInt()); if( !jump(6) ) { return false; } // &lt;= // patch if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voicePtr-&gt;setPatch(placeHolder.toInt()); voices.push_back(voicePtr); //SAVE 1 } // stem type for( i=0; i&lt;8; ++i ) { if( !readBuffer(placeHolder, 1) ) { return false; } // &lt;= voices[i]-&gt;setStemType(placeHolder.toUnsignedInt()); oveTrack-&gt;addVoice(voices[i]); //SAVE 2 } .... }</span></span></code> </pre> <br>  A large enough fragment, but it is easy to verify the presence of errors.  Each marked <i>return statement</i> results in a loss of the <i>voicePtr</i> pointer.  If, nevertheless, the program is executed before the line of code with the comment ‚ÄúSAVE 2‚Äù, then the pointer is saved to the class <i>Track</i> .  In the destructor of this class, the pointer will be freed.  In other cases there will be a memory leak.  Here is the implementation of the <i>Track</i> class: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Track</span></span></span><span class="hljs-class">{</span></span> .... QList&lt;Voice*&gt; voices_; .... } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Track::addVoice(Voice* voice) { voices_.push_back(voice); } Track::~Track() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Track::clear(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;voices_.size(); ++i){ <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> voices_[i]; } voices_.clear(); }</code> </pre> <br>  Other similar analyzer warnings are best viewed by the project developers. <br><br><h2>  Initialization errors </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/373/d1e/731/373d1e731ea5a187f80b454dd1e5c4d8.png"></div><br>  <a href="https://www.viva64.com/ru/w/v614/">V614</a> Uninitialized variable 'pageWidth' used.  Consider the doCredits function.  importmxmlpass1.cpp 944 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MusicXMLParserPass1::scorePartwise() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pageWidth; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pageHeight; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (_e.readNextStartElement()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_e.name() == <span class="hljs-string"><span class="hljs-string">"part"</span></span>) part(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_e.name() == <span class="hljs-string"><span class="hljs-string">"part-list"</span></span>) { doCredits(_score, credits, pageWidth, pageHeight);<span class="hljs-comment"><span class="hljs-comment">// &lt;= USE partList(partGroupList); } .... else if (_e.name() == "defaults") defaults(pageWidth, pageHeight); // &lt;= INIT .... } .... }</span></span></code> </pre> <br>  This code allows the use of uninitialized <i>pageWidth</i> and <i>pageHeight variables</i> in the <i>doCredits ()</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCredits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Score* score,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CreditWordsList&amp; credits, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageHeight)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pw1 = pageWidth / <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pw2 = pageWidth * <span class="hljs-number"><span class="hljs-number">2</span></span> / <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ph2 = pageHeight / <span class="hljs-number"><span class="hljs-number">2</span></span>; .... }</code> </pre> <br>  The use of uninitialized variables leads to indefinite behavior, which for a long time can give the appearance of correct program operation. <br><br>  <a href="https://www.viva64.com/ru/w/v730/">V730</a> class are initialized inside the constructor.  Consider inspecting: _dclickValue1, _dclickValue2.  aslider.cpp 30 <br><br><pre> <code class="cpp hljs">AbstractSlider::AbstractSlider(QWidget* parent) : QWidget(parent), _scaleColor(Qt::darkGray), _scaleValueColor(QColor(<span class="hljs-string"><span class="hljs-string">"#2456aa"</span></span>)) { _id = <span class="hljs-number"><span class="hljs-number">0</span></span>; _value = <span class="hljs-number"><span class="hljs-number">0.5</span></span>; _minValue = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; _maxValue = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; _lineStep = <span class="hljs-number"><span class="hljs-number">0.1</span></span>; _pageStep = <span class="hljs-number"><span class="hljs-number">0.2</span></span>; _center = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _invert = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _scaleWidth = <span class="hljs-number"><span class="hljs-number">4</span></span>; _log = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _useActualValue = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setFocusPolicy(Qt::StrongFocus); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lineStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _lineStep; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLineStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ _lineStep = v; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pageStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _pageStep; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPageStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> f)</span></span></span><span class="hljs-function"> </span></span>{ _pageStep = f; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dclickValue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _dclickValue1; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dclickValue2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _dclickValue2; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDclickValue1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ _dclickValue1 = val; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDclickValue2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ _dclickValue2 = val; } ....</code> </pre> <br>  The use of an uninitialized class field may lead to undefined behavior.  In this class, most fields are initialized in a constructor and have methods for accessing them.  But the variables <i>_dclickValue1 and_</i> <i>dclickValue2</i> remain not initialized, although they have methods for reading and writing.  If the method for reading is called first, it will return an undefined value.  About a hundred such sites have been found in the project code, and they deserve to be studied by developers. <br><br><h2>  Inheritance errors </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/113/897/7af1138979970dd992d04121fc403efd.png"></div><br><br>  <a href="https://www.viva64.com/ru/w/v762/">V762</a> It was possible a virtual function was overridden incorrectly.  See the third argument of the function 'adjustCanvasPosition' in the derived class 'PianorollEditor' and the base class 'MuseScoreView'.  pianoroll.h 92 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MuseScoreView</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adjustCanvasPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Element*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*playBack*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*staffIdx*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{}; .... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PianorollEditor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QMainWindow, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MuseScoreView{ .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adjustCanvasPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Element*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; .... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScoreView</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QWidget, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MuseScoreView { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adjustCanvasPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Element* el, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> playBack, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> staff = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> override</span></span>; .... } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleView</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QFrame, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MuseScoreView { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">adjustCanvasPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Element* el, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> playBack)</span></span></span></span>; .... }</code> </pre> <br>  The analyzer found three different ways to override and overload the <i>adjustCanvasPosition ()</i> function of the base <i>MuseScoreView</i> class.  You need to double-check the code. <br><br><h2>  Unreachable code </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/889/1b4/f83/8891b4f83756ee0be125787203219e97.png"></div><br><br>  <a href="https://www.viva64.com/ru/w/v517/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1740, 1811. scoreview.cpp 1740 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readNote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Note* note, XmlReader&amp; e)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (e.readNextStartElement()) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> QStringRef&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e.name())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"Accidental"</span></span>) { .... } .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"offTimeType"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= line 651 if (e.readElementText() == "offset") note-&gt;setOffTimeType(2); else note-&gt;setOffTimeType(1); } .... else if (tag == "offTimeType") // &lt;= line 728 e.skipCurrentElement(); // &lt;= Dead code .... } .... }</span></span></code> </pre> <br>  In a very large cascade of conditions there are two identical checks.  With such an error, either both conditions are not fulfilled, or only the first one is fulfilled.  Thus, the second condition is never satisfied and the code remains unreachable. <br><br>  Two more similar places in the code: <br><br><ul><li>  V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 645, 726. read114.cpp 645 </li><li>  V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1740, 1811. scoreview.cpp 1740 </li></ul><br>  Consider the following error. <br><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'middleMeasure! = 0' is always false.  ove.cpp 7852 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMiddleUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., Measure* middleMeasure, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; middleUnit)</span></span></span><span class="hljs-function"> </span></span>{ .... } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> OveOrganizer::organizeWedge(....) { .... Measure* middleMeasure = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> middleUnit = <span class="hljs-number"><span class="hljs-number">0</span></span>; getMiddleUnit( ove_, part, track, measure, ove_-&gt;getMeasure(bar2Index), wedge-&gt;start()-&gt;getOffset(), wedge-&gt;stop()-&gt;getOffset(), middleMeasure, middleUnit); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( middleMeasure != <span class="hljs-number"><span class="hljs-number">0</span></span> ) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= WedgeEndPoint* midStopPoint = new WedgeEndPoint(); measureData-&gt;addMusicData(midStopPoint); midStopPoint-&gt;setTick(wedge-&gt;getTick()); midStopPoint-&gt;start()-&gt;setOffset(middleUnit); midStopPoint-&gt;setWedgeStart(false); midStopPoint-&gt;setWedgeType(WedgeType::Cres_Line); midStopPoint-&gt;setHeight(wedge-&gt;getHeight()); WedgeEndPoint* midStartPoint = new WedgeEndPoint(); measureData-&gt;addMusicData(midStartPoint); midStartPoint-&gt;setTick(wedge-&gt;getTick()); midStartPoint-&gt;start()-&gt;setOffset(middleUnit); midStartPoint-&gt;setWedgeStart(true); midStartPoint-&gt;setWedgeType(WedgeType::Decresc_Line); midStartPoint-&gt;setHeight(wedge-&gt;getHeight()); } } .... }</span></span></code> </pre> <br>  Another very large piece of code that is never executed.  The cause is a condition that is always false.  The condition compares with zero a pointer that was initially initialized with zero.  On closer inspection, you can see a typo: the variables <b>middleMeasure</b> and <b>middleUnit are confused</b> .  Notice the <i>getMiddleUnit ()</i> function.  By the name and the last argument (passed by reference) it is clear that the variable <b>middleUnit is</b> modified, which should be checked in the condition. <br><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'error == 2' is always false.  mididriver.cpp 126 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ENOENT 2 bool AlsaMidiDriver::init() { int </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> = snd_seq_open(&amp;alsaSeq, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hw"</span></span></span><span class="hljs-meta">, ....); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> &lt; 0) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> == ENOENT) qDebug(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"open ALSA sequencer failed: %s"</span></span></span><span class="hljs-meta">, snd_strerror(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">)); return false; } .... }</span></span></code> </pre> <br>  Obviously, after the first check, the <i>error</i> variable will always be less than zero.  Due to the further comparison of the variable with the number <i>2,</i> debugging information is never displayed. <br><br>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> A part of the conditional expression is always false: strack&gt; - 1. edit.cpp 3669 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Score::undoAddElement(Element* element) { QList&lt;Staff* &gt; staffList; Staff* ostaff = element-&gt;staff(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> strack = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ostaff) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ostaff-&gt;score()-&gt;excerpt() &amp;&amp; strack &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) strack = ostaff-&gt;score()-&gt;excerpt()-&gt;tracks().key(...); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> strack = ostaff-&gt;idx() * VOICES + element-&gt;track() % VOICES; } .... }</code> </pre> <br>  Another case with an error in conditional expression.  Always executes code from <i>else</i> . <br><br>  <a href="https://www.viva64.com/ru/w/v779/">V779</a> Unreachable code detected.  It is possible that an error is present.  figuredbass.cpp 1377 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> FiguredBass::setProperty(P_ID propertyId, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariant&amp; v) { score()-&gt;addRefresh(canvasBoundingRect()); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(propertyId) { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Text::setProperty(propertyId, v); } score()-&gt;setLayoutAll(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  Diagnostics <a href="https://www.viva64.com/ru/w/v779/">V779 is</a> specialized in searching for an unreachable code, with its help such an amusing place was found.  And it is not one in the code, there are two more: <br><br><ul><li>  V779 Unreachable code detected.  It is possible that an error is present.  fingering.cpp 165 </li><li>  V779 Unreachable code detected.  It is possible that an error is present.  chordrest.cpp 1127 </li></ul><br><h2>  Empty pointers / iterators </h2><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddf/4fe/3fd/ddf4fe3fdbd9aaf035ec9a3529ea7dab.png"></div><br><br>  <a href="https://www.viva64.com/ru/w/v522/">V522</a> Dereferencing of the null pointer 'customDrumset' might take place.  instrument.cpp 328 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Instrument::readProperties(XmlReader&amp; e, Part* part, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* customDrumset) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"Drum"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// if we see on of this tags, a custom drumset will // be created if (!_drumset) _drumset = new Drumset(*smDrumset); if (!customDrumset) { // &lt;= const_cast&lt;Drumset*&gt;(_drumset)-&gt;clear(); *customDrumset = true; // &lt;= } const_cast&lt;Drumset*&gt;(_drumset)-&gt;load(e); } .... }</span></span></code> </pre> <br>  There is a mistake in the condition.  Most likely, the author wanted to check the <i>customDrumset</i> pointer <i>differently</i> before dereferencing, but made a typo. <br><br>  <a href="https://www.viva64.com/ru/w/v522/">V522</a> Dereferencing of the null pointer 'segment' might take place.  measure.cpp 2220 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Measure::read(XmlReader&amp; e, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> staffIdx) { Segment* segment = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (e.readNextStartElement()) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> QStringRef&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e.name())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"move"</span></span>) e.initTick(e.readFraction().ticks() + tick()); .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag == <span class="hljs-string"><span class="hljs-string">"sysInitBarLineType"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; val(e.readElementText()); BarLine* barLine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BarLine(score()); barLine-&gt;setTrack(e.track()); barLine-&gt;setBarLineType(val); segment = getSegmentR(SegmentType::BeginBarLine, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//!!! segment-&gt;add(barLine); // &lt;= OK } .... else if (tag == "Segment") segment-&gt;read(e); // &lt;= ERR .... } .... }</span></span></code> </pre> <br>  This is not the first big cascade of conditions in this project where mistakes are made.  Worth thinking!  Here, the <i>segment</i> pointer is initially zero, and is initialized before use under various conditions.  In one branch, they forgot to do this. <br><br>  Two more dangerous places: <br><br><ul><li>  V522 Dereferencing of the null pointer 'segment' might take place.  read114.cpp 1551 </li><li>  V522 Dereferencing of the null pointer 'segment' might take place.  read206.cpp 1879 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v774/">V774</a> The 'slur'  importgtp-gp6.cpp 2072 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GuitarPro6::readGpif(QByteArray* data) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c) { slur-&gt;setTick2(c-&gt;tick()); score-&gt;addElement(slur); legatos[slur-&gt;track()] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> slur; legatos[slur-&gt;track()] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br>  The <i>slur</i> pointer <i>is</i> used after freeing memory using the <i>delete</i> operator.  Probably, they mixed up the lines in some places. <br><br>  <a href="https://www.viva64.com/ru/w/v789/">V789</a> Iterators for the 'OldList' container  layout.cpp 1760 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Score::createMMRest(....) { ElementList oldList = mmr-&gt;takeElements(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Element* ee : oldList) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (ee-&gt;type() == e-&gt;type()) { mmr-&gt;add(ee); auto i = std::find(oldList.begin(), oldList.end(), ee); if (i != oldList.end()) oldList.erase(i); // &lt;= found = true; break; } } .... }</span></span></code> </pre> <br>  The analyzer detected simultaneous reading and modification of the <i>oldList</i> container in a range-based for loop.  This code is erroneous. <br><br><h2>  Arithmetic errors </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/65e/cce/2a6/65ecce2a69d6e342188f23055d174fb6.png"></div><br>  <a href="https://www.viva64.com/ru/w/v765/">V765</a> A compound assignment expression 'x + = x + ...' is suspicious.  Consider inspecting it for a possible error.  tremolo.cpp 321 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Tremolo::layout() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_chord1-&gt;up() != _chord2-&gt;up()) { beamYOffset += beamYOffset + beamHalfLineWidth; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (!_chord1-&gt;up() &amp;&amp; !_chord2-&gt;up()) { beamYOffset = -beamYOffset; } .... }</span></span></code> </pre> <br>  This is the code found by the analyzer.  The specified expression is equivalent to: <br><br><pre> <code class="cpp hljs">beamYOffset = beamYOffset + beamYOffset + beamHalfLineWidth;</code> </pre> <br>  The variable <i>beamYOffset is</i> added twice.  Perhaps this is a mistake. <br><br>  <a href="https://www.viva64.com/ru/w/v674/">V674</a> The '-2.5' literal of the 'double' type is compared to a value of the 'int' type.  Consider inspecting the 'alter &lt;- 2.5' expression.  importmxmlpass2.cpp 5253 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MusicXMLParserPass2::pitch(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&amp; step, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&amp; alter ....) { .... alter = MxmlSupport::stringToInt(strAlter, &amp;ok); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ok || alter &lt; <span class="hljs-number"><span class="hljs-number">-2.5</span></span> || alter &gt; <span class="hljs-number"><span class="hljs-number">2.5</span></span>) { logError(QString(<span class="hljs-string"><span class="hljs-string">"invalid alter '%1'"</span></span>).arg(strAlter)); .... alter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  The variable <i>alter</i> is of type <i>int</i> .  And the comparison with the numbers <i>2.5</i> and <i>-2.5</i> looks very strange. <br><br>  <a href="https://www.viva64.com/ru/w/v595/">V595</a>  Check lines: 926, 929. voice.cpp 926 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Voice::update_param(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _gen) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gen[GEN_OVERRIDEROOTKEY].val &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { root_pitch = gen[GEN_OVERRIDEROOTKEY].val * <span class="hljs-number"><span class="hljs-number">100.0f</span></span> - .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { root_pitch = sample-&gt;origpitch * <span class="hljs-number"><span class="hljs-number">100.0f</span></span> - sample-&gt;pitchadj; } root_pitch = _fluid-&gt;ct2hz(root_pitch); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sample != <span class="hljs-number"><span class="hljs-number">0</span></span>) root_pitch *= (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) _fluid-&gt;sample_rate / sample-&gt;samplerate; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br>  The analyzer complains about dereferencing an unverified <i>sample</i> pointer when verification is present below the code.  But what if the <i>sample</i> pointer was not planned to be checked in this function, and with zero did you want to compare the <i>sample-&gt; samplerate</i> variable before dividing?  Then there is a serious mistake. <br><br><h2>  miscellanea </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bc/040/5c7/2bc0405c7d50c81ed6b1cb8f3a988281.png"></div><br><br>  <a href="https://www.viva64.com/ru/w/v523/">V523</a> The 'then' statement is equivalent to the 'else' statement.  pluginCreator.cpp 84 <br><br><pre> <code class="cpp hljs">PluginCreator::PluginCreator(QWidget* parent) : QMainWindow(parent) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qApp-&gt;layoutDirection() == Qt::LayoutDirection::....) { editTools-&gt;addAction(actionUndo); editTools-&gt;addAction(actionRedo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { editTools-&gt;addAction(actionUndo); editTools-&gt;addAction(actionRedo); } .... }</code> </pre> <br>  The analyzer detected the execution of the same code under different conditions.  There should fix the error, or reduce the code in half, removing the condition. <br><br>  <a href="https://www.viva64.com/ru/w/v524/">V524</a> It is the odd that the body of the 'downLine' function is fully equivalent to the body of the 'upLine' function.  rest.cpp 667 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Rest::upLine() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { qreal _spatium = spatium(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lrint((pos().y() + bbox().top() + _spatium) * <span class="hljs-number"><span class="hljs-number">2</span></span> / _spatium); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Rest::downLine() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { qreal _spatium = spatium(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lrint((pos().y() + bbox().top() + _spatium) * <span class="hljs-number"><span class="hljs-number">2</span></span> / _spatium); }</code> </pre> <br>  The <i>upLine ()</i> and <i>downLine ()</i> functions have opposite names, but are implemented in the same way.  It is worth checking this suspicious place. <br><br>  <a href="https://www.viva64.com/ru/w/v766/">V766</a> An item with the same key '"mrcs"' has already been added.  importgtp-gp6.cpp 100 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;QString, QString&gt; instrumentMapping = { .... {<span class="hljs-string"><span class="hljs-string">"e-piano-gs"</span></span>, <span class="hljs-string"><span class="hljs-string">"electric-piano"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"e-piano-ss"</span></span>, <span class="hljs-string"><span class="hljs-string">"electric-piano"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"hrpch-gs"</span></span>, <span class="hljs-string"><span class="hljs-string">"harpsichord"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"hrpch-ss"</span></span>, <span class="hljs-string"><span class="hljs-string">"harpsichord"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"mrcs"</span></span>, <span class="hljs-string"><span class="hljs-string">"maracas"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">// &lt;= {"mrcs", "oboe"}, // &lt;= {"mrcs", "oboe"}, // &lt;=  Copy-Paste .... };</span></span></code> </pre> <br>  It seems that the author of this code fragment was in a hurry and created pairs with the same keys, but different values. <br><br>  <a href="https://www.viva64.com/ru/w/v1001/">V1001</a> The 'ontime' variable is not used until the end of the function.  rendermidi.cpp 1176 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderNoteArticulation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ontime = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">// render the suffix for (int j = 0; j &lt; s; j++) ontime = makeEvent(suffix[j], ontime, tieForward(j,suffix)); // render graceNotesAfter ontime = graceExtend(note-&gt;pitch(), ...., ontime); return true; }</span></span></code> </pre> <br>  The code modifies the <i>ontime</i> variable, but is not used when exiting the function.  Perhaps there is a mistake. <br><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'runState == 0' is always false.  pulseaudio.cpp 206 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PulseAudio</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Driver { Transport state; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> runState; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... } bool PulseAudio::stop() { if (runState == 2) { runState = 1; int i = 0; for (;i &lt; 4; ++i) { if (runState == 0) // &lt;= break; sleep(1); } pthread_cancel(thread); pthread_join(thread, 0); } return true; }</span></span></code> </pre> <br>  The analyzer always detected a false condition, but the <i>stop ()</i> function is called in parallel code and there should be no triggering.  The reason for the warning is that the author of the code used to synchronize a simple variable of type <i>int</i> , which is a field of the class.  And this leads to synchronization errors.  After correcting the code, the <a href="https://www.viva64.com/ru/w/v547/">V547</a> diagnostics <a href="https://www.viva64.com/ru/w/v547/">will</a> stop producing false positives, i.e.  it will trigger an exception on the topic of parallel code. <br><br><h2>  Conclusion </h2><br>  In a small project there were many different mistakes.  We hope that the authors of the program will pay attention to my review and carry out correctional work.  I will check the code of several more programs that I use.  If you know an interesting software for working with music and want to see it in the review, then send the names to me by <a href="">mail</a> . <br><br>  Other reviews: <ul><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/339816/">Review of music software code defects.</a>  <a href="https://habrahabr.ru/company/pvs-studio/blog/339816/">Part 2. Audacity</a> </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/340730/">Review of music software code defects.</a>  <a href="https://habrahabr.ru/company/pvs-studio/blog/340730/">Part 3. Rosegarden</a> </li></ul><br>  It is very easy to try the PVS-Studio analyzer on your project, just go to the <a href="https://www.viva64.com/ru/pvs-studio-download/">download</a> page. <br><br><div style="text-align:center;"> <a href="https://www.viva64.com/en/b/0530/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="https://www.viva64.com/en/b/0530/">Review of Music Software Code Defects Part 1. MuseScore</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="https://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/338808/">https://habr.com/ru/post/338808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338798/index.html">20 useful services for product managers</a></li>
<li><a href="../338800/index.html">SAP is looking for future specialists to work with data science and machine learning</a></li>
<li><a href="../338802/index.html">Dangerous game. Should I rely on a team of juniors</a></li>
<li><a href="../338804/index.html">$ mol_app_calc: Spreadsheet Party</a></li>
<li><a href="../338806/index.html">Loading OS on ARM</a></li>
<li><a href="../338810/index.html">"Kings of Mathematics": Big Data Analytics in a bank. Project GAUSS in VTB</a></li>
<li><a href="../338812/index.html">How can a never called function be called?</a></li>
<li><a href="../338814/index.html">We translate interfaces into fifty languages. Sketch</a></li>
<li><a href="../338816/index.html">MBLTdev 2017: Hardcore Android Development Reports</a></li>
<li><a href="../338818/index.html">Why headlines are needed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>