<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we organized a mini-provider in the village</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Having moved to work in the Far North, I was faced with the problem of the lack of a normal Internet (mobile operators do not count, because they are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we organized a mini-provider in the village</h1><div class="post__text post__text-html js-mediator-article">  Having moved to work in the Far North, I was faced with the problem of the lack of a normal Internet (mobile operators do not count, because they are still not satisfied).  Having stumbled a couple of weeks with the search for WiFi networks in the neighborhood, I found a kind person who decided to organize some sort of provider with distributing the Internet to everyone over WiFi.  But this person had no knowledge and experience in setting up networks and, as a result, the network was not built very well. <br><br>  After talking, we decided to unite.  Somehow I have experience in setting up servers for * nix and building networks, it has equipment and 2-3 channels to the Internet through neighbors and their ADSL modems. <br><a name="habracut"></a><br>  First of all, it was decided to raise the server gateway to the network.  Debian was installed as the OS.  To distribute the Internet, it was decided to use a combination of iptables + Squid (as a caching proxy), BIND (caching DNS) and dhcpd were also installed and configured for distributing Ip addresses. <br><br>  On the gateway there are 2 network cards: one ‚Äúlooks‚Äù at the local network, the second one at 4 adsl modems.  Since I can say no, I have no experience in building networks of providers, it was decided to allow users to connect to different networks via different modems (I ask you not to kick this solution strongly). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">routes</b> <div class="spoiler_text">  route add-net 0.0.0.0/4 gw 172.16.1.200 <br>  route add-net 16.0.0.0/4 gw 172.16.1.201 <br>  route add-net 32.0.0.0/4 gw 172.16.1.202 <br>  route add-net 48.0.0.0/4 gw 172.16.1.203 <br>  route add-net 64.0.0.0/4 gw 172.16.1.200 <br>  route add -net 80.0.0.0/4 gw 172.16.1.201 <br>  route add -net 96.0.0.0/4 gw 172.16.1.202 <br>  route add -net 112.0.0.0/4 gw 172.16.1.203 <br>  route add-net 128.0.0.0/4 gw 172.16.1.200 <br>  route add -net 144.0.0.0/4 gw 172.16.1.201 <br>  route add -net 160.0.0.0/4 gw 172.16.1.202 <br>  route add-net 176.0.0.0/4 gw 172.16.1.203 <br>  route add-net 192.0.0.0/4 gw 172.16.1.200 <br>  route add -net 208.0.0.0/4 gw 172.16.1.201 <br>  route add -net 224.0.0.0/4 gw 172.16.1.202 <br>  route add -net 240.0.0.0/4 gw 172.16.1.203 <br></div></div><br>  Webmin was also installed on the server. <br><br>  Actually, it makes no sense to talk about installing iptables, squid, dhs and dhcp.  So, as there are a lot of manuals on the network, I‚Äôll tell you about the small automation that I implemented to facilitate user management for a person who has never encountered * nix. <br><br>  The scheme of adding users is as follows: <br><br>  1. The user is registered in dhcp (addresses are issued only to registered users); <br>  2. Then the user is registered on squid; <br>  3. Then a script is launched that parses the squid config and creates rules for the firewall. <br><br>  Actually, the scripts themselves (clumsy scripts were written on the knee in order to work) (the scripts are in the / etc / nat directory). <br><br>  Actually parsing the squid config: <br><br><div class="spoiler">  <b class="spoiler_title">proxy</b> <div class="spoiler_text">  #! / bin / bash <br>  touch / etc / nat / ip <br>  mask = '172' <br>  I = $ (cat /etc/squid3/squid.conf | grep localnet | grep 172.16) <br>  arr = $ (echo $ I | tr "" "\ n") <br>  arr2 = $ (echo $ arr | tr "/" "\ n") <br>  for x in $ arr <br>  do <br>  declare -a arrip <br>  if [[$ x == $ mask *]];  then <br>  arrip [0] = $ x <br>  echo $ arrip [0] &gt;&gt; / etc / nat / ip <br>  fi <br>  done <br>  ### EOF ############################### <br>  / etc / nat / ipread <br></div></div><br>  As you can see, it processes the config and pulls out all the ip-addresses on a specific mask and, based on the result, launches another script: <br><br><div class="spoiler">  <b class="spoiler_title">etc / nat / ipread</b> <div class="spoiler_text">  #! / bin / bash <br>  cat / dev / null&gt; / etc / nat / natread <br>  echo "resetting iptables rules" <br>  sleep 1 <br>  iptables -F <br>  iptables -X <br>  iptables -t nat -F <br>  iptables -t nat -X <br>  iptables -t mangle -F <br>  iptables -t mangle -X <br>  iptables -P INPUT ACCEPT <br>  iptables -P FORWARD ACCEPT <br>  iptables -P OUTPUT ACCEPT <br><br>  echo "#! / bin / bash" &gt;&gt; / etc / nat / natread <br>  echo "echo 1&gt; / proc / sys / net / ipv4 / ip_forward" &gt;&gt; / etc / nat / natread <br>  echo "iptables -A INPUT -i lo -j ACCEPT" &gt;&gt; / etc / nat / natread <br>  echo "iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT" &gt;&gt; / etc / nat / natread <br>  mask = "172" <br>  badlist = $ (cat / etc / nat / bad) <br>  arrbad = $ (echo $ badlist) <br>  for x in $ arrbad <br>  do <br>  if [[$ x == $ mask *]]; <br>  then <br>  echo "iptables -I INPUT -i eth0 -s" $ x "-j DROP" &gt;&gt; / etc / nat / natread <br>  fi <br>  done <br>  ip = $ (cat / etc / nat / ip) <br>  arr = $ (echo $ ip | tr "/" "\ n") <br>  for x in $ arr <br>  do <br>  if [[$ x == $ mask *]]; <br>  then <br>  echo "iptables -t nat -A POSTROUTING -o eth1 -s" $ x "-j MASQUERADE" &gt;&gt; / etc / nat / natread <br>  fi <br>  done <br>  echo "iptables -A FORWARD -i eth1 -m state --state ESTABLISHED, RELATED -j ACCEPT" &gt;&gt; / etc / nat / natread <br>  echo "iptables -A FORWARD -i eth1 -o eth0 -j REJECT" &gt;&gt; / etc / nat / natread <br>  echo "iptables -t nat -A PREROUTING -i eth0!  -d 172.16.0.0/24 -p tcp -m multiport --dport 80,8080 -j DNAT --to 172.16.0.1Â§©128 ¬ª&gt;&gt; / etc / nat / natread <br>  echo "echo \" The firewall rules are being reset \ "" &gt;&gt; / etc / nat / natread <br>  echo "sleep 1s" &gt;&gt; / etc / nat / natread <br>  echo "echo \". \ "" &gt;&gt; / etc / nat / natread <br>  echo "sleep 1s" &gt;&gt; / etc / nat / natread <br>  echo "echo \". \ "" &gt;&gt; / etc / nat / natread <br>  echo "sleep 1s" &gt;&gt; / etc / nat / natread <br>  echo "echo \". \ "" &gt;&gt; / etc / nat / natread <br>  echo "sleep 1s" &gt;&gt; / etc / nat / natread <br>  echo "echo \" The reloading of the firewall rules was successful! \ "" &gt;&gt; / etc / nat / natread <br>  rm / etc / nat / ip <br>  / etc / nat / natread <br></div></div><br><br>  This script resets the iptables rules and generates a script that, based on the result, adds the firewall rules. <br><br>  This script is an example: <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / nat / natread</b> <div class="spoiler_text">  #! / bin / bash <br>  echo 1&gt; / proc / sys / net / ipv4 / ip_forward <br>  iptables -A INPUT -i lo -j ACCEPT <br>  iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT <br>  iptables -I INPUT -i eth0 -s 172.16 / 0/81 -j DROP <br>  iptables -I INPUT -i eth0 -s 172.16.0.82 -j DROP <br>  iptables -I INPUT -i eth0 -s 172.16.0.87 -j DROP <br>  iptables -I INPUT -i eth0 -s 172.16.0.27 -j DROP <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.1 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.10 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.100 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.101 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.102 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.103 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.104 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.105 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.106 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.107 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.108 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.109 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.11 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.110 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.111 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.112 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.113 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.114 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.115 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.116 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.117 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.118 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.119 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.12 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.121 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.123 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.124 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.125 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.13 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.14 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.15 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.16 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.17 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.18 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.19 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.20 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.21 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.22 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.23 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.24 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.25 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.26 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.27 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.28 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.29 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.30 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.31 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.32 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.33 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.34 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.35 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.36 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.37 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.38 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.39 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.40 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.41 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.42 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.43 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.44 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.45 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.46 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.47 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.48 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.49 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.50 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.51 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.52 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.53 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.54 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.55 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.56 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.57 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.58 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.59 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.60 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.61 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.62 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.63 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.64 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.65 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.66 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.67 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.68 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.69 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.70 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.71 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.72 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.73 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.74 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.75 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.76 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.77 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.78 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.79 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.80 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.81 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.82 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.83 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.84 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.85 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.86 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.87 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.88 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.89 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.90 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.91 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.92 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.93 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.94 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.95 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.96 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.97 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.98 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.99 -j MASQUERADE <br>  iptables -t nat -A POSTROUTING -o eth1 -s 172.16.0.120 -j MASQUERADE <br>  iptables -A FORWARD -i eth1 -m state --state ESTABLISHED, RELATED -j ACCEPT <br>  iptables -A FORWARD -i eth1 -o eth0 -j REJECT <br>  echo ‚ÄúFirewall rules are being reloaded‚Äû <br>  sleep 1s <br>  echo "." <br>  sleep 1s <br>  echo "." <br>  sleep 1s <br>  echo "." <br>  sleep 1s <br>  echo ‚ÄúThe reloading of the firewall rules completed successfully!‚Äù <br></div></div><br>  As you can see, there is also implemented the ability to add users who have forgotten to pay for the Internet by adding the addresses of these users to the bad file. <br><br>  Actually, with the distribution of the Internet figured out.  But a problem arose: due to frequent jumps in the electrical network, ADSL-modems could hang tightly, because of this, users could not access some of the sites.  As a crutch, a script was written that checks the availability of modems and, based on a test, generated a route table from the templates: <br><br><div class="spoiler">  <b class="spoiler_title">ping-test</b> <div class="spoiler_text">  #! / bin / bash <br>  host1 = "172.16.1.200" <br>  host2 = "172.16.1.201" <br>  host3 = "172.16.1.202" <br>  host4 = "172.16.1.203" <br>  if ping -q -c 1 $ host1 &amp;&gt; / dev / null; <br>  then <br>  x = "1" <br>  else <br>  x = "0" <br>  fi <br>  if ping -q -c 1 $ host2 &amp;&gt; / dev / null; <br>  then <br>  y = "1" <br>  else <br>  y = "0" <br>  fi <br>  if ping -q -c 1 $ host3 &amp;&gt; / dev / null; <br>  then <br>  z = "1" <br>  else <br>  z = "0" <br>  fi <br>  if ping -q -c 1 $ host4 &amp;&gt; / dev / null; <br>  then <br>  i = "1" <br>  else <br>  i = "0" <br>  fi <br>  if [$ x == 1] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-ok / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host1 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host2 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host3 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host4 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host12 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host23 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host13 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host14 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host24 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host34 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 1]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host123 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 1] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host124 / etc / nat / network <br>  else <br>  if [$ x == 0] &amp;&amp; [$ y == 1] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host134 / etc / nat / network <br>  else <br>  if [$ x == 1] &amp;&amp; [$ y == 0] &amp;&amp; [$ z == 0] &amp;&amp; [$ i == 0]; <br>  then <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-host234 / etc / nat / network <br>  else <br>  rm -f / etc / nat / network <br>  cp / etc / nat / network-ok / etc / nat / network <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  fi <br>  chmod + x / etc / nat / network <br>  / etc / nat / delnet <br>  / etc / nat / network <br></div></div><br><br>  According to the results of the script, 2 files are created: the network with the route table and delnet, which, in fact, deletes the old routes at startup: <br><br><div class="spoiler">  <b class="spoiler_title">network</b> <div class="spoiler_text">  #! / bin / bash <br>  route add-net 0.0.0.0/4 gw 172.16.1.200 <br>  route add-net 16.0.0.0/4 gw 172.16.1.201 <br>  route add-net 32.0.0.0/4 gw 172.16.1.202 <br>  route add-net 48.0.0.0/4 gw 172.16.1.203 <br>  route add-net 64.0.0.0/4 gw 172.16.1.200 <br>  route add -net 80.0.0.0/4 gw 172.16.1.201 <br>  route add -net 96.0.0.0/4 gw 172.16.1.202 <br>  route add -net 112.0.0.0/4 gw 172.16.1.203 <br>  route add-net 128.0.0.0/4 gw 172.16.1.200 <br>  route add -net 144.0.0.0/4 gw 172.16.1.201 <br>  route add -net 160.0.0.0/4 gw 172.16.1.202 <br>  route add-net 176.0.0.0/4 gw 172.16.1.203 <br>  route add-net 192.0.0.0/4 gw 172.16.1.200 <br>  route add -net 208.0.0.0/4 gw 172.16.1.201 <br>  route add -net 224.0.0.0/4 gw 172.16.1.202 <br>  route add -net 240.0.0.0/4 gw 172.16.1.203 <br>  rm -f / etc / nat / delnet <br>  touch / etc / nat / delnet <br>  echo "#! / bin / bash" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 0.0.0.0/4 gw 172.16.1.200" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 16.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 32.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 48.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 64.0.0.0/4 gw 172.16.1.200" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 80.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 96.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 112.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 128.0.0.0/4 gw 172.16.1.200" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 144.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 160.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 176.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 192.0.0.0/4 gw 172.16.1.200" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 208.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 224.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 240.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  chmod + x / etc / nat / delnet <br></div></div><br><div class="spoiler">  <b class="spoiler_title">delnet</b> <div class="spoiler_text">  #!  / bin / bash <br>  route del -net 0.0.0.0/4 gw 172.16.1.200 <br>  route del -net 16.0.0.0/4 gw 172.16.1.201 <br>  route del -net 32.0.0.0/4 gw 172.16.1.202 <br>  route del -net 48.0.0.0/4 gw 172.16.1.203 <br>  route del -net 64.0.0.0/4 gw 172.16.1.200 <br>  route del -net 80.0.0.0/4 gw 172.16.1.201 <br>  route del -net 96.0.0.0/4 gw 172.16.1.202 <br>  route del -net 112.0.0.0/4 gw 172.16.1.203 <br>  route del -net 128.0.0.0/4 gw 172.16.1.200 <br>  route del -net 144.0.0.0/4 gw 172.16.1.201 <br>  route del -net 160.0.0.0/4 gw 172.16.1.202 <br>  route del -net 176.0.0.0/4 gw 172.16.1.203 <br>  route del -net 192.0.0.0/4 gw 172.16.1.200 <br>  route del -net 208.0.0.0/4 gw 172.16.1.201 <br>  route del -net 224.0.0.0/4 gw 172.16.1.202 <br>  route del -net 240.0.0.0/4 gw 172.16.1.203 <br></div></div><br>  As an example, give patterns <br><div class="spoiler">  <b class="spoiler_title">network host1</b> <div class="spoiler_text">  #! / bin / bash <br>  route add -net 0.0.0.0/4 gw 172.16.1.201 <br>  route add-net 16.0.0.0/4 gw 172.16.1.202 <br>  route add-net 32.0.0.0/4 gw 172.16.1.203 <br>  route add -net 48.0.0.0/4 gw 172.16.1.201 <br>  route add-net 64.0.0.0/4 gw 172.16.1.202 <br>  route add -net 80.0.0.0/4 gw 172.16.1.203 <br>  route add -net 96.0.0.0/4 gw 172.16.1.201 <br>  route add -net 112.0.0.0/4 gw 172.16.1.202 <br>  route add -net 128.0.0.0/4 gw 172.16.1.203 <br>  route add -net 144.0.0.0/4 gw 172.16.1.201 <br>  route add -net 160.0.0.0/4 gw 172.16.1.202 <br>  route add-net 176.0.0.0/4 gw 172.16.1.203 <br>  route add -net 192.0.0.0/4 gw 172.16.1.201 <br>  route add -net 208.0.0.0/4 gw 172.16.1.202 <br>  route add -net 224.0.0.0/4 gw 172.16.1.203 <br>  route add -net 240.0.0.0/4 gw 172.16.1.201 <br><br>  rm -f / etc / nat / delnet <br>  touch / etc / nat / delnet <br>  echo "#! / bin / bash" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 0.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 16.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 32.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 48.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 64.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 80.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 96.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 112.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 128.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 144.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 160.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 176.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 192.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 208.0.0.0/4 gw 172.16.1.202" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 224.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 240.0.0.0/4 gw 172.16.1.201" &gt;&gt; / etc / nat / delnet <br>  chmod + x / etc / nat / delnet <br></div></div><br><div class="spoiler">  <b class="spoiler_title">network-host123</b> <div class="spoiler_text">  #! / bin / bash <br>  route add -net 0.0.0.0/4 gw 172.16.1.203 <br>  route add-net 16.0.0.0/4 gw 172.16.1.203 <br>  route add-net 32.0.0.0/4 gw 172.16.1.203 <br>  route add-net 48.0.0.0/4 gw 172.16.1.203 <br>  route add-net 64.0.0.0/4 gw 172.16.1.203 <br>  route add -net 80.0.0.0/4 gw 172.16.1.203 <br>  route add -net 96.0.0.0/4 gw 172.16.1.203 <br>  route add -net 112.0.0.0/4 gw 172.16.1.203 <br>  route add -net 128.0.0.0/4 gw 172.16.1.203 <br>  route add-net 144.0.0.0/4 gw 172.16.1.203 <br>  route add-net 160.0.0.0/4 gw 172.16.1.203 <br>  route add-net 176.0.0.0/4 gw 172.16.1.203 <br>  route add-net 192.0.0.0/4 gw 172.16.1.203 <br>  route add -net 208.0.0.0/4 gw 172.16.1.203 <br>  route add -net 224.0.0.0/4 gw 172.16.1.203 <br>  route add -net 240.0.0.0/4 gw 172.16.1.203 <br><br>  rm -f / etc / nat / delnet <br>  touch / etc / nat / delnet <br>  echo "#! / bin / bash" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 0.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 16.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 32.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 48.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 64.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 80.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 96.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 112.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 128.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 144.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 160.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 176.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 192.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 208.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del-net 224.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  echo "route del -net 240.0.0.0/4 gw 172.16.1.203" &gt;&gt; / etc / nat / delnet <br>  chmod + x / etc / nat / delnet <br></div></div><br>  From the examples one can understand the principle by which the templates were made. <br><br>  PS Despite the clumsiness of the solution, this gateway already within six months successfully launches about 100 users onto the network.  With a minimum of problems. </div><p>Source: <a href="https://habr.com/ru/post/256485/">https://habr.com/ru/post/256485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256473/index.html">Again, a harsh open source for state-owned companies and big business with examples of solutions. I believe in him, if that</a></li>
<li><a href="../256477/index.html">Programmers don't understand</a></li>
<li><a href="../256479/index.html">Do you know linear-gradient well?</a></li>
<li><a href="../256481/index.html">From Python Script to WSGI Applications</a></li>
<li><a href="../256483/index.html">Installing the free GPL site control panel VestaCP</a></li>
<li><a href="../256487/index.html">Google will invest another $ 1 billion in its data center in the Council Bluffs</a></li>
<li><a href="../256489/index.html">Video reports from MoscowJS Meetup</a></li>
<li><a href="../256491/index.html">Cloud infrastructure: 7 interesting services and technologies (and their analogues)</a></li>
<li><a href="../256493/index.html">CAN-USB adapter from stm32vldiscovery</a></li>
<li><a href="../256495/index.html">Designing a Web API in 7 steps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>