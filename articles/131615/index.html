<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About one runtime optimization error</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Initially, the post was planned to devote to the 64-bit xlc compiler error that I unsuccessfully caught many hours and which takes place on IBM's AIX ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About one runtime optimization error</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage1/22ada24c/d5fa13ab/2b40684c/2517a28e.png">  Initially, the post was planned to devote to the 64-bit xlc compiler error that I unsuccessfully caught many hours and which takes place on IBM's AIX architecture servers.  But it so happened that this error affects many compilers, and Visual Studio 2010 with SP1 installed is no exception.  What seems funny in the end is because it suggests that Microsoft is working with IBM developers to create optimizing compilers. <br><br>  A little background.  There is one scientific project that was written in C ++ for a long time and now it is being successfully transferred to many platforms, among which are HP-UX, IBM AIX and Oracle Solaris mainframes.  The transfer in the long run is that the compile-time errors are corrected, a group of tests is started, and if all the tests pass, then a conclusion is drawn that the code is working. <br><br>  Since the speed of performing mathematical procedures is very important, the compilation runs with the -O2 speed optimization key enabled.  But on the IBM AIX architecture, the xlc compiler for some reason cannot create workable code that satisfies the test suite.  At the same time, without the -O2 key, everything works fine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I, of course, could try to catch this error directly on the IBM AIX mainframe, if I had enough time in stock, but in the absence of a debugger (the error did not appear in debug mode) I had to catch in the old manner, by inserting printf into code sections.  I did not give remote access to IBM AIX, I had to work directly in the data center and during those few hours spent behind the terminal, I could not understand anything intelligible, except that there was a mistake and it was quite stable.  As a result, the error has been sitting in the code for a long time. <br><br>  This continued until I tried to transfer the code to Visual Studio 2010 SP1. <br><a name="habracut"></a><br>  And lo and behold!  The error manifested itself in the same original state, namely, in the 32-bit mode, everything works fine when the -O2 flag is turned on and without it, and in x64 when -O2 is turned on, one of the tests ‚Äúswears‚Äù exactly as it was on IBM AIX!  This is a victory, because now I could, without limiting myself to the time frame, thoughtfully digging an unplowed field of code, experimenting and consistently comparing the results of printf with the right and wrong passing of tests. <br><br>  The result was not long in coming.  Below is the extract from the full code, it is the most reduced code in size.  This code does not work in the 32-bit mode either, since the N parameter is 4. If we set #define N 8, then we get the original code that runs on 32 bits but is not working on x64.  For simplicity (not everyone has x64, and many will probably want to try), here is the source code that doesn't work on any architecture. <br><br>  So, let's try to compile this code with and without the -O2 key: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #define N 4 unsigned char a[N]; void f(unsigned int k) { int i; for(i=0;i&lt;N;++i) { a[i]=k&amp;0xf; k&gt;&gt;=4; } } int main(void) { int i; static unsigned int x=0x76543210; f(x); if (a[3]==2) { printf("Error!\n"); } for(i=0;i&lt;N;i++) { printf("%02x ", a[i]); } printf("\nsizeof(void*)=%d\n", sizeof(void*)); return 0; }</span></span></span></span></code> </pre> <br>  Write the program code in the file test32.c <br><br>  To compile, we will use Visual Studio 2010 SP1 and we will make the code for a 32-bit operating system.  We will build and launch using the following batch file: <br><br><pre> <code class="bash hljs">call <span class="hljs-string"><span class="hljs-string">"C:\Program Files\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"</span></span> cl /nologo test32.c /Fano_opt &gt;nul <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>   test32 pause <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>   cl /nologo -O2 test32.c /Fawith_opt &gt;nul test32</code> </pre><br>  After launch, we get the results: <br><br><pre> <code class="bash hljs">Setting environment fr using Microsoft Visual Studio 2010 x86 tools.   00 01 02 03 sizeof(void*)=4 Press any key to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span> . . .   Error! 00 01 02 02 sizeof(void*)=4</code> </pre><br>  It can be seen that after optimization we get 00 01 02 02 instead of 00 01 02 03. <br><br>  Why it happens? <br><br>  Consider the assembler file with_opt.asm obtained with optimization enabled. <br><br>  The assembler file no_opt.asm obtained with optimization turned off is not very interesting to us, since everything is working fine there.  Those interested can find it in their working directory. <br><br>  Optimization enabled: <br><pre> <code class="cpp hljs">_TEXT SEGMENT _main PROC ; COMDAT ; Line <span class="hljs-number"><span class="hljs-number">16</span></span> mov eax, DWORD PTR ?x@?<span class="hljs-number"><span class="hljs-number">1</span></span>??main@@<span class="hljs-number"><span class="hljs-number">9</span></span>@<span class="hljs-number"><span class="hljs-number">9</span></span> mov cl, al shr eax, <span class="hljs-number"><span class="hljs-number">4</span></span> mov dl, al shr eax, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">15</span></span> ; <span class="hljs-number"><span class="hljs-number">0000000f</span></span>H <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cl, <span class="hljs-number"><span class="hljs-number">15</span></span> ; <span class="hljs-number"><span class="hljs-number">0000000f</span></span>H <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dl, <span class="hljs-number"><span class="hljs-number">15</span></span> ; <span class="hljs-number"><span class="hljs-number">0000000f</span></span>H mov BYTE PTR _a, cl mov BYTE PTR _a+<span class="hljs-number"><span class="hljs-number">1</span></span>, dl mov BYTE PTR _a+<span class="hljs-number"><span class="hljs-number">2</span></span>, al mov BYTE PTR _a+<span class="hljs-number"><span class="hljs-number">3</span></span>, al ; Line <span class="hljs-number"><span class="hljs-number">17</span></span> cmp al, <span class="hljs-number"><span class="hljs-number">2</span></span> jne SHORT $LN4@main ; Line <span class="hljs-number"><span class="hljs-number">18</span></span> push OFFSET ??_C@_07NPIJMNAB@Error?$CB?<span class="hljs-number"><span class="hljs-number">6</span></span>?$AA@ call _printf add esp, <span class="hljs-number"><span class="hljs-number">4</span></span> $LN4@main:</code> </pre> <br><br>  It is easy to notice that the function call f () really does not occur, the compiler immediately calculates the values ‚Äã‚Äãof the variable x and fills the array a.  Moreover, during optimization, the filling is incorrect, the elements of the _a + 2 and _a + 3 array are filled with the same values ‚Äã‚Äãfrom the al register. <br><br>  The same is true when compiling a 64-bit executable file.  To work with 64-bit code, we replace the first line in the batch file: <br><br><pre> <code class="bash hljs">call <span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat"</span></span> amd64</code> </pre><br>  We will get the same incorrect result, but only with sizeof (void *) = 8, which confirms the 64 bits of the received code: <br><br><pre> <code class="bash hljs">Setting environment fr using Microsoft Visual Studio 2010 x64 tools.   00 01 02 03 sizeof(void*)=8 Press any key to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span> . . .   Error! 00 01 02 02 sizeof(void*)=8</code> </pre><br>  The x64 assembly code looks like this: <br><br><pre> <code class="cpp hljs">main PROC ; COMDAT ; Line <span class="hljs-number"><span class="hljs-number">15</span></span> $LN21: push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">32</span></span> ; <span class="hljs-number"><span class="hljs-number">00000020</span></span>H ; Line <span class="hljs-number"><span class="hljs-number">16</span></span> mov ecx, DWORD PTR ?x@?<span class="hljs-number"><span class="hljs-number">1</span></span>??main@@<span class="hljs-number"><span class="hljs-number">9</span></span>@<span class="hljs-number"><span class="hljs-number">9</span></span> movzx eax, cl shr ecx, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">15</span></span> mov BYTE PTR a, al movzx eax, cl shr ecx, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cl, <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">15</span></span> mov BYTE PTR a+<span class="hljs-number"><span class="hljs-number">1</span></span>, al mov BYTE PTR a+<span class="hljs-number"><span class="hljs-number">2</span></span>, cl mov BYTE PTR a+<span class="hljs-number"><span class="hljs-number">3</span></span>, cl ; Line <span class="hljs-number"><span class="hljs-number">17</span></span> cmp cl, <span class="hljs-number"><span class="hljs-number">2</span></span> jne SHORT $LN4@main ; Line <span class="hljs-number"><span class="hljs-number">18</span></span> lea rcx, OFFSET FLAT:??_C@_07NPIJMNAB@Error?$CB?<span class="hljs-number"><span class="hljs-number">6</span></span>?$AA@ call <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> $LN4@main:</code> </pre><br>  It is easy to see that the function f () is also not called here, and the compiler immediately calculates the values ‚Äã‚Äãof the variable x and fills the array a.  In this case, the elements of the array _a + 2 and _a + 3 are filled with the same values ‚Äã‚Äãfrom the register cl, which is wrong. <br><br>  As a result, the source code of the f () function was fixed as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;N;++i) { a[i]=(k&gt;&gt;<span class="hljs-number"><span class="hljs-number">4</span></span>*i)&amp;<span class="hljs-number"><span class="hljs-number">0xf</span></span>; } }</code> </pre> <br><br>  And then everything worked fine on both Visual Studio x86 / x64 and xlc for IBM AIX. <br><br>  The speed of the tests with the -O2 key eventually increased about 2.5 - 3 times. <br><br>  <b>UPD:</b> To avoid misunderstandings, changed the int type to unsigned int in the code, the error remained.  Previous version <a href="https://connect.microsoft.com/VisualStudio/feedback/details/698296/optimization-flag-o2-issue-in-c-c-compiler">can be found here.</a> <br><br>  <b>UPD2:</b> Received an official response from Microsoft: <br>  <i>Posted by Microsoft on Nov 2, 2011 at 11:17 am</i> <i><br><br></i>  <i>Thanks for reporting this issue.</i>  <i>I can confirm this problem with VS2010 SP1.</i>  <i>It will be fixed in Visual Studio.</i> <i><br><br></i>  <i>ian bearman</i> <i><br></i>  <i>VC ++ Code Generation and Optimization Team</i> <i><br></i> </div><p>Source: <a href="https://habr.com/ru/post/131615/">https://habr.com/ru/post/131615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131603/index.html">Electronic business card service</a></li>
<li><a href="../131604/index.html">Digest Wanted.VC # 20</a></li>
<li><a href="../131606/index.html">What I love Drupal for</a></li>
<li><a href="../131609/index.html">Samsung Galaxy Note: both fish and meat</a></li>
<li><a href="../131614/index.html">We programmatically remove fields and headers and headers in Firefox under Windows</a></li>
<li><a href="../131616/index.html">Everything about Nokia and Nokia World in one post: results</a></li>
<li><a href="../131619/index.html">On an approach to building a database at the initial stage of work on a web project</a></li>
<li><a href="../131620/index.html">Pocketbook A10 Review. Svezhatinka</a></li>
<li><a href="../131621/index.html">Change time zones in Mac OS X Snow Leopard</a></li>
<li><a href="../131622/index.html">Winners of the optical illusion competition 2011</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>