<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony + RabbitMQ Quick start for young</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends. 
 Today I wanted to talk about how you can work with RabbitMQ in Symfony and quite a bit about some underwater rooms. At the end I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony + RabbitMQ Quick start for young</h1><div class="post__text post__text-html js-mediator-article">  Good day, friends. <br>  Today I wanted to talk about how you can work with RabbitMQ in Symfony and quite a bit about some underwater rooms.  At the end I will write a couple of interesting moments about the rabbit (Russian translation of "rabbit") for those who are completely in the tank. <br><br>  I will not talk about RabbitMQ myself, so if you don‚Äôt know it yet, read the following translations: <br><br>  <a href="https://habrahabr.ru/post/149694/">Article 1</a> <br>  <a href="https://habrahabr.ru/post/150134/">Article 2</a> <br>  <a href="https://habrahabr.ru/post/200870/">Article 3</a> <br>  <a href="https://habrahabr.ru/post/201096/">Article 4</a> <br>  <a href="https://habrahabr.ru/post/201178/">Article 5</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Do not be afraid of examples on the pearl or Python - this is not scary, everything is quite clear from the source code. <br><br>  + Everything is described in sufficient detail when I read it at one time; it was enough to interpret the code in my mind in order to understand what and why. <br><br>  If you already know what a consumer is and why you need to do $ em-&gt; clear () + gc_collect_cycles in it, and then close the connection to the database, then most likely you will not learn anything new for yourself.  The article is more likely for those who do not want to deal with the AMQP protocol, but who need to use queues right now and for some reason, the choice fell <s>mindlessly</s> on RabbitMQ, and not the same lightweight <s>beanstalkd</s> . <br>  If you have a microservice architecture and you are waiting for me to tell you how to weld the communication between components via AMQP, how beautiful it is to do RPC, then I myself have been waiting for something like this for a long time on Habr√© ... <br><a name="habracut"></a><br>  We have a task: to send messages to the Email in the queue using RabbitMQ, as well as to ensure fault tolerance: if the mail server responds with a timeout or something else is broken - you need to try the task after 30 seconds again. <br><br>  So, install <a href="https://github.com/php-amqplib/RabbitMqBundle">our bundle</a> . <br><br>  I'm too lazy to describe to you how to copy the composer require command and line in AppKernel. <br><br>  I really hope that you have done this yourself and are ready to start configuring our bundle. <br><br><div class="spoiler">  <b class="spoiler_title">If not, here is a complete guide for the little ones:</b> <div class="spoiler_text">  RabbitMQ installation: <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'deb http://www.rabbitmq.com/debian/ testing main'</span></span> | sudo tee /etc/apt/sources.list.d/rabbitmq.list wget -O- https://www.rabbitmq.com/rabbitmq-release-signing-key.asc | sudo apt-key add - sudo apt-get update sudo apt-get install rabbitmq-server sudo rabbitmq-plugins <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> rabbitmq_management</code> </pre> <br>  Now you can open your <a href="http://localhost/">localhost</a> : 15672 under the account: guest guest and see a lot of cool things that you will soon understand and feel like a man. <br><br>  Now install the bundle itself: <br><br><pre> <code class="hljs perl">composer <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> php-amqplib/rabbitmq-bundle</code> </pre> <br>  And register it in our application: <br><br><pre> <code class="hljs lua">// app/AppKernel.php public <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerBundles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { $bundles = array( new OldSound\RabbitMqBundle\OldSoundRabbitMqBundle(), ); }</code> </pre><br>  That's all. <br><br></div></div><br><br>  Bundle configuration for us: <br><br><pre> <code class="hljs pgsql">old_sound_rabbit_mq: connections: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: host: <span class="hljs-string"><span class="hljs-string">'localhost'</span></span> port: <span class="hljs-number"><span class="hljs-number">5672</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">'guest'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">'guest'</span></span> vhost: <span class="hljs-string"><span class="hljs-string">'/'</span></span> lazy: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> connection_timeout: <span class="hljs-number"><span class="hljs-number">3</span></span> read_write_timeout: <span class="hljs-number"><span class="hljs-number">3</span></span> keepalive: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> heartbeat: <span class="hljs-number"><span class="hljs-number">0</span></span> use_socket: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> producers: send_email: <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> exchange_options: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: direct } consumers: send_email: <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> exchange_options: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: direct } queue_options: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email'</span></span> } callback: app.consumer.mail_sender</code> </pre><br>  Here, great attention should be paid to producers and consumers.  If it is very short and simple: producer is what sends messages through RabbitMQ to a consumer, and consumer in turn is the thing that receives and processes these messages.  Here exchange_options - options for the exchanger (did you read the articles about rabbitmq, which were at the beginning of the article?), Queue_options - options for the queue (similarly).  You should also pay attention to the callback in the consumer - here you can see the service ID, which extends the ConsumerInterface (execute method with message argument). <br><br>  Since  so far you don‚Äôt have it, when you start the application or compile the container, we will get some DI exception, that the service was not found, but we are requesting it.  Therefore, let's create our service: <br><br><pre> <code class="hljs kotlin">#app/config/services.yml services: app.consumer.mail_sender: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppBundle\Consumer\MailSenderConsumer</span></span></span></span></code> </pre><br>  And the class itself: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Consumer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">OldSound</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMqBundle</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMq</span></span>\<span class="hljs-title"><span class="hljs-title">ConsumerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PhpAmqpLib</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">AMQPMessage</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Class NotificationConsumer */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailSenderConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsumerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> AMQPMessage $msg * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AMQPMessage $msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'     : '</span></span>.$msg-&gt;getBody().PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' !...'</span></span>; } }</code> </pre><br>  Well, you are not offended that I did not include in the article how to work with SwiftMailer?  :) It is important for us that a string is delivered asynchronously here via a message queue, then how we will process this string is our business.  Mail is just an example of a case. <br><br>  How do we pass a string to our consumer account?  To do this, let's create a test command: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerAwareCommand</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Input</span></span>\<span class="hljs-title"><span class="hljs-title">InputInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Output</span></span>\<span class="hljs-title"><span class="hljs-title">OutputInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConsumerCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerAwareCommand</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt;setName(<span class="hljs-string"><span class="hljs-string">'app:test-consumer'</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'Hello PhpStorm'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getContainer()-&gt;get(<span class="hljs-string"><span class="hljs-string">'old_sound_rabbit_mq.send_email_producer'</span></span>)-&gt;publish(<span class="hljs-string"><span class="hljs-string">'    ...'</span></span>); }</code> </pre><br>  Again, I apologize for not having made a controller with a beautiful mold for you - I am too lazy for that.  Yes, and too unnecessarily.  And I'm an economical bummer and I like to draw, I dream a little towards theories and application architecture.  Distracted. <br><br>  Now we start our consumer and order it to wait for a message from RabbitMQ: <br><br><pre> <code class="bash hljs">bin/console rabbitmq:consumer send_email -vvv</code> </pre> <br>  And send him a message from our test team: <br><br><pre> <code class="bash hljs">bin/console app:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-consumer</code> </pre> <br>  And now, in the process of rabbitmq: consumer, we can see our message!  And that pseudo dispatch ended in success. <br><br>  And now let's see how we can implement deferred processing of messages in case of errors.  I will not use the RabbitMQ plugin for pending messages.  We will achieve this by creating a new queue, in which we will indicate the lifetime of messages for 30 seconds and set the setting: after death, move it to the main queue. <br><br>  Just add a new producer: <br><br><pre> <code class="hljs pgsql">producers: send_email: <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> exchange_options: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: direct } delayed_send_email: <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> exchange_options: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email_delayed_30000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: direct queue_options: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email_delayed_30000'</span></span> arguments: x-message-ttl: [<span class="hljs-string"><span class="hljs-string">'I'</span></span>, <span class="hljs-number"><span class="hljs-number">30000</span></span>] x-dead-letter-exchange: [<span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'notification.v1.send_email'</span></span>]</code> </pre><br>  Now let's change the consummer logic: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Consumer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">OldSound</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMqBundle</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMq</span></span>\<span class="hljs-title"><span class="hljs-title">ConsumerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">OldSound</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMqBundle</span></span>\<span class="hljs-title"><span class="hljs-title">RabbitMq</span></span>\<span class="hljs-title"><span class="hljs-title">ProducerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PhpAmqpLib</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">AMQPMessage</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Class NotificationConsumer */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailSenderConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsumerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $delayedProducer; <span class="hljs-comment"><span class="hljs-comment">/** * MailSenderConsumer constructor. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ProducerInterface $delayedProducer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProducerInterface $delayedProducer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;delayedProducer = $delayedProducer; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> AMQPMessage $msg * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AMQPMessage $msg)</span></span></span><span class="hljs-function"> </span></span>{ $body = $msg-&gt;getBody(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'     '</span></span>.$body.<span class="hljs-string"><span class="hljs-string">' ...'</span></span>.PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($body == <span class="hljs-string"><span class="hljs-string">'bad'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' ...'</span></span>.PHP_EOL; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $exception) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>.PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;delayedProducer-&gt;publish($body); } } }</code> </pre><br>  In general, it is useful to use LoggerInterface for output - and it is nice and scalable. <br>  But we are lazy and we do not want to create additional ‚Äúpillows‚Äù, right?  Just know. <br><br>  Now we have to flip the producer for the delayed queue: <br><br><pre> <code class="hljs scala">#app/config/services.yml services: app.consumer.mail_sender: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">AppBundle</span></span>\<span class="hljs-type"><span class="hljs-type">Consumer</span></span>\<span class="hljs-type"><span class="hljs-type">MailSenderConsumer</span></span> arguments: ['<span class="hljs-meta"><span class="hljs-meta">@old</span></span>_sound_rabbit_mq.delayed_send_email_producer']</code> </pre><br>  And change the command: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerAwareCommand</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Input</span></span>\<span class="hljs-title"><span class="hljs-title">InputInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Output</span></span>\<span class="hljs-title"><span class="hljs-title">OutputInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConsumerCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerAwareCommand</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt;setName(<span class="hljs-string"><span class="hljs-string">'app:test-consumer'</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'Hello PhpStorm'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getContainer()-&gt;get(<span class="hljs-string"><span class="hljs-string">'old_sound_rabbit_mq.send_email_producer'</span></span>)-&gt;publish(<span class="hljs-string"><span class="hljs-string">', ...'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getContainer()-&gt;get(<span class="hljs-string"><span class="hljs-string">'old_sound_rabbit_mq.send_email_producer'</span></span>)-&gt;publish(<span class="hljs-string"><span class="hljs-string">'bad'</span></span>); } }</code> </pre><br>  Now, along with the normal message, it will send a bad message. <br><br>  If we run, we will see the following output: <br><br><pre> <code class="hljs vbscript">     , ...  ...      bad... <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span></code> </pre><br>  <i>After 30 seconds, the processing message appears again:</i> <br><pre> <code class="hljs vbscript">     bad... <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span></code> </pre><br>  And so endlessly.  The logic of maximum attempts, etc.  think for yourself.  Next I will give a couple of tips for your sales and some features. <br><br>  Now tips for your sales: <br><br>  1) Without departing from the topic with the maximum processing attempts: know for all 102% all possible exceptions to the context with which you work!  Be able to imagine when re-processing is required, and when not, otherwise - hello trash from the logs and lack of understanding of what is happening.  If the broken task is spinning in RabbitMQ, with real data, normal tasks, you can hardly throw out broken tasks without crutches, without updating the concierge code or restarting it.  So think it over immediately.  In this case, it would be correct to catch only some SMTPTimeOutException. <br>  Also with such a model it is important to understand that: on stage 1 there is one ‚Äúglobal responsibility for changing the state of something‚Äù.  Do not give too many risky tasks to your worker.  If we consider the option with 1C, then the problem may be the following: let's say if the product is added or changed successfully in 1C, we write something in the database, for example, the date of the last successful synchronization or unsuccessful.  Those.  2 databases are updated here immediately: database 1C and database of your application.  Suppose everything has been successfully created in 1C, then the field ‚Äúdate of last successful synchronization‚Äù is updated in the database - hop, an error has come out, again, the database server does not respond - the task is postponed to ‚Äúlater‚Äù and repeats until the database starts responding.  And at the same time, every time the ‚Äúsubtask‚Äù associated with the creation of an entity in 1C will succeed, each time if the attempt to write to the site database fails, which is wrong. <br><br>  2) Read about durable, since we are using RabbitMQ.  PS: it starts up as true \ false flag ‚Äúdurable‚Äù in the config of the bundle, specifically in exchange_options and queue_options <br><br>  3) All your life close the connection to the database after the execution of the program.  And also run the EM cleanup and after the garbage collector to clean up the links.  Those.  in the end, our consumer should look something like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MailSenderConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsumerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $delayedProducer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $entityManager; <span class="hljs-comment"><span class="hljs-comment">/** * MailSenderConsumer constructor. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ProducerInterface $delayedProducer * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> EntityManagerInterface $entityManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProducerInterface $delayedProducer, EntityManagerInterface $entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;delayedProducer = $delayedProducer; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;entityManager = $entityManager; gc_enable(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> AMQPMessage $msg * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AMQPMessage $msg)</span></span></span><span class="hljs-function"> </span></span>{ $body = $msg-&gt;getBody(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'     '</span></span>.$body.<span class="hljs-string"><span class="hljs-string">' ...'</span></span>.PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($body == <span class="hljs-string"><span class="hljs-string">'bad'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' ...'</span></span>.PHP_EOL; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $exception) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>.PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;delayedProducer-&gt;publish($body); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;entityManager-&gt;clear(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;entityManager-&gt;getConnection()-&gt;close(); gc_collect_cycles(); } }</code> </pre><br>  Consumer works as a demon, so constantly storing links in it and keeping the connection with the database is bad.  In the case of MySQL, you will get a MySQL server that has gone away. <br><br>  4) Think a lot about why your pending message model may unexpectedly kill your business.  For example, we have a mechanism that, when a product changes in the admin panel, floods these changes through a queue in 1C.  Now imagine a situation: the administrator changes the product -&gt; task # 1 is created to try to change the same data in 1C database.  The 1C server does not respond, so the task is simply shifted constantly until everything works.  During this time, the administrator decided to correct something else in the same product, which he does.  Task # 2 is logged. <br><br>  Now imagine a situation where tasks # 1 and # 2 are alternately carried out and postponed. <br><br>  What if 1C works by the time task # 2 is completed?  The task will be completed and flood the latest changes.  Next, task # 1 will go into motion and wipe the stable changes :) <br>  Exit: send the timestamp as a version, and if the task is ‚Äúfrom the past‚Äù, we throw it away. <br><br>  5) You go into asynchrony - read about many architectural problems, as well as race condition, inconsistency of consumers on different machines and so on. <br><br>  6) Write versions of your queues ... Wow, how it helps on real sales.  In principle, we did just that in this example. <br><br>  7) Maybe you do not need RabbitMQ and the whole AMQP protocol.  Look towards beanstalkd. <br><br>  8) Start up the consumer and any other demonic on php through the supervisor and enable full logging of the crash of the processes in it.  He also has a web interface for managing this whole thing, which is also very convenient.  There will always be problems. </div><p>Source: <a href="https://habr.com/ru/post/338950/">https://habr.com/ru/post/338950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338940/index.html">We understand WeChat - the second most popular messenger in the world</a></li>
<li><a href="../338942/index.html">Micromaster's degree as a new form of education. Overview of the first pilot program</a></li>
<li><a href="../338944/index.html">Internet where there is none, or Fixed connection based on 3G-LTE</a></li>
<li><a href="../338946/index.html">We write our book again</a></li>
<li><a href="../338948/index.html">Time management for kinesthetics</a></li>
<li><a href="../338952/index.html">Running regular tasks on a cluster or how to make friends with Apache Spark and Oozie</a></li>
<li><a href="../338954/index.html">NetApp ONTAP ‚îÄ we will break it down</a></li>
<li><a href="../338958/index.html">Event digest for HR specialists in the IT field for October 2017</a></li>
<li><a href="../338960/index.html">How I searched (and found!) The bugs in the kickico smartcontract</a></li>
<li><a href="../338966/index.html">Monitoring of engineering infrastructure in the data center. Part 3. Cooling system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>