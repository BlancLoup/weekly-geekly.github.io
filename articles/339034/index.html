<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DevOps coming to our home? Home Minecraft server in Azure using modern DevOps practices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is NOT about minecraft. This article is about Azure and about modern approaches to delivery software. 

 If you just want to deploy a min...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DevOps coming to our home? Home Minecraft server in Azure using modern DevOps practices</h1><div class="post__text post__text-html js-mediator-article">  This article is NOT about minecraft.  This article is about <b>Azure</b> and about modern approaches to delivery software. <br><br>  If you just want to deploy a minecraft server - ask Google ‚Äúminecraft server hosting‚Äù - it will be both easier and cheaper. <br><br>  But if you want to look at the real case of using <i>Infrastructure as Code</i> approaches, <i>Configuration as Code</i> in relation to non-adapted to Azure software using minecraft as an example, then <u>welcome</u> <br><a name="habracut"></a><br><h3>  Roadmap </h3><br>  Azure Stack is huge and I want to poke in different parts of it, so this article will not be every one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The outline of the articles is as follows: <br><br><ul><li>  Automated deployment and server configuration using Azure CLI 2 and Powershell DSC </li><li>  Support for server configuration in a consistent state using Azure Automation </li><li>  Automated server update for the new version </li><li>  Get minecraft logs, analyze and display using Azure Stream Analytics and Power BI </li><li>  Organizing an active / passive cluster with management through Azure Automation </li><li>  ... </li></ul><br>  But of course the process of the emergence of new articles can be stopped by the absence of your interest) <br><br><h3>  Disclaimer </h3><br><ul><li>  I am not an engineer, not a devops engineer, not a minecraft player.  Therefore, <u>if you are fumbling</u> and it seems to you that I am not doing everything correctly - then most likely it‚Äôs the way it is - write in the comments as it should. </li><li>  All examples for the article are 100% working, but are supplied ‚Äúas is‚Äù.  If something does not work for you, fix it yourself or hammer it. </li></ul><br>  So. <br><br><h2>  Automated deployment and server configuration using Azure CLI 2 and Powershell DSC </h2><br><h4>  About the task </h4><br>  The task is not synthetic.  The server was asked to deploy children and it will actually be used.  The last thing I want is to constantly repair and repair it.  Even less, I want to lose data during updates.  Therefore, the requirements for it is quite a prod-like) <br><br><h4>  General approach </h4><br><ul><li>  100% automation. </li><li>  Treat scripts like code </li><li>  We follow the basic configuration management requirements for the delivery process to the prod environment </li></ul><br>  All points will be explained along the way. <br><br><h4>  About software </h4><br>  As a server, I took the official server <a href="https://minecraft.net/en-us/download/server">minecraft.net/en-us/download/server</a> .  A cursory study revealed that: <br><br><ul><li>  The server is a jar file and requires java to run. </li><li>  It needs to run next to a file eula.txt with a specific content. </li><li>  The server is configured using the server.properties file, which should also be near </li><li>  Server listens on TCP port 25565 </li><li>  The data (card) is stored by the server in the World daddy next to it (and this will be a bit of a problem) </li><li>  The server is able to upgrade data, if they are created by the previous version (and this will greatly simplify life when upgrading) </li><li>  Logs are stored in the daddy logs near </li></ul><br><h4>  Infrastructure </h4><br>  Let's apply the most basic scheme: <br><br>  One <b>Resource Group</b> c: <br><br><ul><li>  <b>Network Security Group</b> (ports 25565 (minecraft) and 3389 (rdp) will be opened) </li><li>  <b>VNET</b> c 1 subnet </li><li>  <b>NIC</b> and static <b>public IP</b> with DNS name </li><li>  1 <b>VM</b> under Windows Server 2016 core + 2 <b>Managed Disk</b> (OS + Data) </li><li>  <b>Storage account</b> and 1 container for <b>Blob storage</b> </li></ul><br><img src="https://habrastorage.org/webt/59/cf/ec/59cfec0d2e0b3736916173.jpeg" alt="image"><br><br>  The data will be stored separately from the virtual machine on a separate <b>managed disk</b> and linked to the World daddy next to the jar using Symlink (I wrote above that the location of the world daddy is not configured and should always be next to the jar). <br><br>  This will make it possible to start the server both with a linked disk, and without (for tests) - in this case, the world folder will be created with an empty card. <br><br>  We will configure the server based on: <br><br><ul><li>  Distribution (jar with server + jre + initial data), which will be preloaded into Blob storage </li><li>  Configurations (Powershell DSC), which will also be preloaded into Blob storage </li></ul><br>  I promised higher there to follow some of the requirements of configuration management - this is the first: <br><br><blockquote>  <i>all artifacts that are required to deploy the application should be published in a controlled stack with high availability.</i> </blockquote><br>  That is why we and the distribution and configuration will be pre-assembled from artifacts on the Internet and republished in Blob Storage. <br><br>  Thus, the algorithm for the deployment procedure is as follows: <br><br><ul><li>  Create a new Resource Group, Storage Account and Storage Container </li><li>  Build a distribution kit (jar with server + jre + initial data) and upload it to Blob Storage </li><li>  Create the rest of the infrastructure in the Resource Group </li><li>  Create a DSC configuration and upload it to Blob Storage </li><li>  Configure server based on configuration and distribution </li></ul><br><h4>  Sources </h4><br><ul><li>  Store on <a href="">github</a> </li><li>  Observe any intelligible strategy of bransling and release cycle (well, for example, <a href="https://datasift.github.io/gitflow/IntroducingGitFlow.html">gitflow</a> and release each article :)) </li><li>  We use azure cli 2 and bash where it is possible (by the way, in this article we managed to completely avoid using powershell api. But in the next one it will not work) </li></ul><br><h2>  Deployment steps </h2><br><h4>  1. Create a new Resource Group, Storage Account and Storage Container </h4><br>  implementation is trivial, just calls to cli <br><br><div class="spoiler">  <b class="spoiler_title">initial_preparation.sh</b> <div class="spoiler_text"><pre><code class="bash hljs">az configure --defaults location=<span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span> group=<span class="hljs-variable"><span class="hljs-variable">$GROUP</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create new group"</span></span> az group create -n <span class="hljs-variable"><span class="hljs-variable">$GROUP</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create storage account"</span></span> az storage account create -n <span class="hljs-variable"><span class="hljs-variable">$STORAGE_ACCOUNT</span></span> --sku Standard_LRS STORAGE_CS=$(az storage account show-connection-string -n <span class="hljs-variable"><span class="hljs-variable">$STORAGE_ACCOUNT</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> AZURE_STORAGE_CONNECTION_STRING=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$STORAGE_CS</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create storage container"</span></span> az storage container create -n <span class="hljs-variable"><span class="hljs-variable">$STORAGE_CONTAINER</span></span> --public-access blob</code> </pre> <br></div></div><br><h4>  2. Build a distribution kit (jar with server + jre + initial data) and upload it to Blob Storage </h4><br>  Download the server and the map, take jre from the current computer and pack everything in zip <br>  Distribution structure: <br><br><ul><li>  .jar </li><li>  jre </li><li>  initial_world - folder with initial map </li></ul><br><div class="spoiler">  <b class="spoiler_title">prepare_distr.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">mkdir <span class="hljs-variable"><span class="hljs-variable">$DISTR_DIR</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$DISTR_DIR</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"download minecraft server from official site"</span></span> curl -Os https://s3.amazonaws.com/Minecraft.Download/versions/1.12.2/minecraft_server.<span class="hljs-variable"><span class="hljs-variable">$MVERSION</span></span>.jar <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"copy jre from this machine"</span></span> cp -r <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JRE</span></span></span><span class="hljs-string">"</span></span> ./jre <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create ititial world folder"</span></span> mkdir initial_world <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> initial_world <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"download initial map"</span></span> curl -Os https://dl01.mcworldmap.com/user/1821/world2.zip unzip -q world2.zip cp -r StarWars/* . rm -r -f StarWars rm world2.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create archive (zip utility -&gt; https://ranxing.wordpress.com/2016/12/13/add-zip-into-git-bash-on-windows/)"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ zip -r -q <span class="hljs-variable"><span class="hljs-variable">$DISTR_ZIP</span></span> <span class="hljs-variable"><span class="hljs-variable">$DISTR_DIR</span></span> rm -r -f <span class="hljs-variable"><span class="hljs-variable">$DISTR_DIR</span></span></code> </pre><br></div></div><br><h4>  3. Build a DSC configuration and upload it to Blob Storage </h4><br>  DSC configuration is a single ps1 file (about its structure - later), which will run on the server and configure it. <br><br>  But the scripts in the ps1 file have dependencies on external modules that will not be automatically installed on the server. <br><br>  Therefore, the configuration must be transferred to the server not just as a ps1 file, but as an archive with: <br><br><ul><li>  ps1 file </li><li>  All dependent modules, folded in the same daddies next to the ps1 file </li></ul><br>  Dependent modules can be simply downloaded by curl as a nuget package from the powershell gallery repository and unzipped to the right place. <br><br>  You can also use the powershell Save-Module command - which includes these two steps. <br>  Please note that the versions of the dependent modules in the ps1 file and in the archive generation scripts with the configuration are indicated and match. <br><br>  And here we again follow the requirements of the next configuration management rule: <br><br><blockquote>  <i>All dependencies must be accurately identified and resolved always uniquely.</i> </blockquote><br><div class="spoiler">  <b class="spoiler_title">prepare_config.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"prepare server configuration"</span></span> curl -s -L -o configuration/xPSDesiredStateConfiguration.zip <span class="hljs-string"><span class="hljs-string">"https://www.powershellgallery.com/api/v2/package/xPSDesiredStateConfiguration/7.0.0.0"</span></span> curl -s -L -o configuration/xNetworking.zip <span class="hljs-string"><span class="hljs-string">"https://www.powershellgallery.com/api/v2/package/xNetworking/5.1.0.0"</span></span> curl -s -L -o configuration/xStorage.zip <span class="hljs-string"><span class="hljs-string">"https://www.powershellgallery.com/api/v2/package/xStorage/3.2.0.0"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> configuration unzip -q xPSDesiredStateConfiguration.zip -d xPSDesiredStateConfiguration rm -r xPSDesiredStateConfiguration.zip unzip -q xNetworking.zip -d xNetworking rm -r xNetworking.zip unzip -q xStorage.zip -d xStorage rm -r xStorage.zip zip -r -q ../<span class="hljs-variable"><span class="hljs-variable">$CONFIG_ZIP</span></span> . * rm -r -f xPSDesiredStateConfiguration rm -r -f xNetworking rm -r -f xStorage <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../</code> </pre> <br></div></div><br><h4>  4. Create the rest of the infrastructure in the Resource Group </h4><br>  the implementation is trivial, just cli calls: <br><br><div class="spoiler">  <b class="spoiler_title">iaas_preparation.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create network security group and rules"</span></span> az network nsg create -n <span class="hljs-variable"><span class="hljs-variable">$NSG</span></span> az network nsg rule create --nsg-name <span class="hljs-variable"><span class="hljs-variable">$NSG</span></span> -n AllowMinecraft --destination-port-ranges 25556 --protocol Tcp --priority 100 az network nsg rule create --nsg-name <span class="hljs-variable"><span class="hljs-variable">$NSG</span></span> -n AllowRDP --destination-port-ranges 3389 --protocol Tcp --priority 110 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create vnet, nic and pip"</span></span> NIC_NAME=minesrvnic PIP_NAME=minepip SUBNET_NAME=servers az network vnet create -n <span class="hljs-variable"><span class="hljs-variable">$VNET</span></span> --subnet-name <span class="hljs-variable"><span class="hljs-variable">$SUBNET_NAME</span></span> az network public-ip create -n <span class="hljs-variable"><span class="hljs-variable">$PIP_NAME</span></span> --dns-name <span class="hljs-variable"><span class="hljs-variable">$DNS</span></span> --allocation-method Static az network nic create --vnet-name <span class="hljs-variable"><span class="hljs-variable">$VNET</span></span> --subnet <span class="hljs-variable"><span class="hljs-variable">$SUBNET_NAME</span></span> --public-ip-address <span class="hljs-variable"><span class="hljs-variable">$PIP_NAME</span></span> -n <span class="hljs-variable"><span class="hljs-variable">$NIC_NAME</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create data disk"</span></span> DISK_NAME=minedata az disk create -n <span class="hljs-variable"><span class="hljs-variable">$DISK_NAME</span></span> --size-gb 10 --sku Standard_LRS <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"create server vm"</span></span> az vm create -n <span class="hljs-variable"><span class="hljs-variable">$VM_NAME</span></span> --size <span class="hljs-variable"><span class="hljs-variable">$VM_SIZE</span></span> --image <span class="hljs-variable"><span class="hljs-variable">$VM_IMAGE</span></span> \ --nics <span class="hljs-variable"><span class="hljs-variable">$NIC_NAME</span></span> \ --admin-username <span class="hljs-variable"><span class="hljs-variable">$VM_ADMIN_LOGIN</span></span> --admin-password <span class="hljs-variable"><span class="hljs-variable">$VM_ADMIN_PASSWORD</span></span> \ --os-disk-name <span class="hljs-variable"><span class="hljs-variable">${VM_NAME}</span></span>disk --attach-data-disk <span class="hljs-variable"><span class="hljs-variable">$DISK_NAME</span></span></code> </pre> <br></div></div><br><h4>  5. Configure the server based on the configuration and distribution </h4><br>  Here, probably the most interesting place.  The server is configured based on the DSC configuration that was previously loaded using the DSC extension for vm. <br><br>  DSC extension feeds the config in which the URL to the archive with the configuration and parameter values ‚Äã‚Äãis specified <br><br><div class="spoiler">  <b class="spoiler_title">server_configuration.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"prepare dsc extension settings"</span></span> cat MinecraftServerDSCSettings.json | envsubst &gt; ThisMinecraftServerDSCSettings.json <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"configure vm"</span></span> az vm extension <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> \ --name DSC \ --publisher Microsoft.Powershell \ --version 2.7 \ --vm-name <span class="hljs-variable"><span class="hljs-variable">$VM_NAME</span></span> \ --resource-group <span class="hljs-variable"><span class="hljs-variable">$GROUP</span></span> \ --settings ThisMinecraftServerDSCSettings.json rm -f ThisMinecraftServerDSCSettings.json</code> </pre> <br></div></div><br><h4>  About Powershell DSC </h4><br>  Well, this is some add-on powershell, which allows declaratively describe the desired state of the computer. <br><br>  The DSC configuration is analyzed on the target machine, a differential is built relative to the current configuration of this machine, and then the configuration is brought to the desired one.  The closest analogue of powershell DSC in the "opensource" world is <b>Ansible</b> . <br><br><h2>  Implement MinecraftServer DSC Configuration </h2><br>  Structurally, the configuration consists of a set of steps that are performed in a specific order (taking into account dependencies).  Run through all: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">xRemoteFile</span></span> DistrCopy { <span class="hljs-attribute"><span class="hljs-attribute">Uri</span></span> = <span class="hljs-string"><span class="hljs-string">"https://</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$accountName</span></span></span><span class="hljs-string">.blob.core.windows.net/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$containerName</span></span></span><span class="hljs-string">/mineserver.</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$minecraftVersion</span></span></span><span class="hljs-string">.zip"</span></span> DestinationPath = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$mineHome</span></span></span><span class="hljs-string">.zip"</span></span> MatchSource = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> }</code> </pre><br>  He declares that the computer should have a zip with the server distribution along the DestinationPath, if it does not lie there - it will be downloaded to the Uri address: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Archive</span></span> UnzipServer { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Path = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$mineHome</span></span></span><span class="hljs-string">.zip"</span></span> Destination = <span class="hljs-variable"><span class="hljs-variable">$mineHomeRoot</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[xRemoteFile]DistrCopy"</span></span> Validate = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> Force = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> }</code> </pre><br>  He declares that on the computer in the Destination folder there must be an unzipped archive with the server distribution kit if it does not lie there (or if the composition of the files differs from what is in the archive) - they will be added: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">File</span></span> CheckProperties { <span class="hljs-attribute"><span class="hljs-attribute">DestinationPath</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$mineHome</span></span></span><span class="hljs-string">\server.properties"</span></span> Type = <span class="hljs-string"><span class="hljs-string">"File"</span></span> Ensure = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Force = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> Contents = <span class="hljs-string"><span class="hljs-string">"....."</span></span> } File CheckEULA { <span class="hljs-attribute"><span class="hljs-attribute">DestinationPath</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$mineHome</span></span></span><span class="hljs-string">\eula.txt"</span></span> Type = <span class="hljs-string"><span class="hljs-string">"File"</span></span> Ensure = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Force = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> Contents = <span class="hljs-string"><span class="hljs-string">"..."</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[File]CheckProperties"</span></span> }</code> </pre><br>  Declares that the path of the DestinationPath should be the files with the server config and license.  If not, they are created with the contents of Contents: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">xWaitForDisk</span></span> WaitWorldDisk { <span class="hljs-attribute"><span class="hljs-attribute">DiskIdType</span></span> = <span class="hljs-string"><span class="hljs-string">"Number"</span></span> DiskId = <span class="hljs-string"><span class="hljs-string">"2"</span></span> RetryIntervalSec = <span class="hljs-number"><span class="hljs-number">60</span></span> RetryCount = <span class="hljs-number"><span class="hljs-number">5</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[File]CheckEULA"</span></span> } xDisk PrepareWorldDisk { <span class="hljs-attribute"><span class="hljs-attribute">DependsOn</span></span> = <span class="hljs-string"><span class="hljs-string">"[xWaitForDisk]WaitWorldDisk"</span></span> DiskIdType = <span class="hljs-string"><span class="hljs-string">"Number"</span></span> DiskId = <span class="hljs-string"><span class="hljs-string">"2"</span></span> DriveLetter = <span class="hljs-string"><span class="hljs-string">"F"</span></span> AllowDestructive = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> } xWaitForVolume WaitForF { <span class="hljs-attribute"><span class="hljs-attribute">DriveLetter</span></span> = <span class="hljs-string"><span class="hljs-string">'F'</span></span> RetryIntervalSec = <span class="hljs-number"><span class="hljs-number">5</span></span> RetryCount = <span class="hljs-number"><span class="hljs-number">10</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[xDisk]PrepareWorldDisk"</span></span> }</code> </pre><br>  Here we declare that a managed disk with data should be initialized in the OS and the letter F should be assigned to it: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">File</span></span> WorldDirectoryExists { <span class="hljs-attribute"><span class="hljs-attribute">Ensure</span></span> = <span class="hljs-string"><span class="hljs-string">"Present"</span></span> Type = <span class="hljs-string"><span class="hljs-string">"Directory"</span></span> Recurse = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> DestinationPath = <span class="hljs-string"><span class="hljs-string">"F:\world"</span></span> SourcePath = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$mineHome</span></span></span><span class="hljs-string">\initial_world"</span></span> MatchSource = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> DependsOn = <span class="hljs-string"><span class="hljs-string">"[xWaitForVolume]WaitForF"</span></span> }</code> </pre><br>  We declare that there should be a world directory on the disk F (with the world).  If it is not there - we consider what is happening for the first time and we need to create this folder using the map from the initial_world distribution as a basis: <br><br><pre> <code class="hljs pgsql">Script LinkWorldDirectory { DependsOn="[File]WorldDirectoryExists" GetScript= { @{ Result = (Test-<span class="hljs-type"><span class="hljs-type">Path</span></span> "$using:mineHome\World") } } SetScript= { <span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-Item -ItemType SymbolicLink -<span class="hljs-type"><span class="hljs-type">Path</span></span> "$using:mineHome\World" -Confirm -Force -<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> "F:\world" } TestScript= { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Test-<span class="hljs-type"><span class="hljs-type">Path</span></span> "$using:mineHome\World") } }</code> </pre><br>  This is a custom step - we check that we have the World folder in the folder with the server.  If it does not exist, we link it from the F disk. Script works as follows ‚Äî if TestScript returns false, SetScript is called.  Otherwise, it is not called: <br><br><pre> <code class="hljs bash">Script EnsureServerStart { DependsOn=<span class="hljs-string"><span class="hljs-string">"[Script]LinkWorldDirectory"</span></span> GetScript= { @{ Result = (Get-Process -Name java -ErrorAction SilentlyContinue) } } SetScript= { Start-Process -FilePath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$using</span></span></span><span class="hljs-string">:mineHome\jre\bin\java"</span></span> -WorkingDirectory <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$using</span></span></span><span class="hljs-string">:mineHome"</span></span> -ArgumentList <span class="hljs-string"><span class="hljs-string">"-Xms512M -Xmx512M -jar `"</span></span><span class="hljs-variable"><span class="hljs-variable">$using</span></span>:mineHome\minecraft_server.<span class="hljs-variable"><span class="hljs-variable">$using</span></span>:minecraftVersion.jar`<span class="hljs-string"><span class="hljs-string">" nogui"</span></span> } TestScript= { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (Get-Process -Name java -ErrorAction SilentlyContinue) -ne <span class="hljs-variable"><span class="hljs-variable">$null</span></span> } }</code> </pre><br>  Another custom step.  We check that the java process is running with the server).  If not running, run: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">xFirewall</span></span> FirewallIn { <span class="hljs-attribute"><span class="hljs-attribute">Name</span></span> = <span class="hljs-string"><span class="hljs-string">"Minecraft-in"</span></span> Action = <span class="hljs-string"><span class="hljs-string">"Allow"</span></span> LocalPort = (<span class="hljs-string"><span class="hljs-string">'25565'</span></span>) Protocol = <span class="hljs-string"><span class="hljs-string">'TCP'</span></span> Direction = <span class="hljs-string"><span class="hljs-string">'Inbound'</span></span> } xFirewall FirewallOut { <span class="hljs-attribute"><span class="hljs-attribute">Name</span></span> = <span class="hljs-string"><span class="hljs-string">"Minecraft-out"</span></span> Action = <span class="hljs-string"><span class="hljs-string">"Allow"</span></span> LocalPort = (<span class="hljs-string"><span class="hljs-string">'25565'</span></span>) Protocol = <span class="hljs-string"><span class="hljs-string">'TCP'</span></span> Direction = <span class="hljs-string"><span class="hljs-string">'Outbound'</span></span> }</code> </pre> <br>  And the last steps - open port 25565. <br><br><h2>  Epilogue </h2><br>  The article turned out and so long, it is necessary to round out.  The issues of debugging this DSC (very interesting in themselves) were left out - I‚Äôll cover them in the next one. <br><br>  Thank you all for your attention. <br><br><div class="spoiler">  <b class="spoiler_title">How to start all this from Windows</b> <div class="spoiler_text">  We will need <br><br><ul><li>  <a href="https://git-scm.com/downloads">Git and (required) Git Bash</a> </li><li>  <a href="https://ranxing.wordpress.com/2016/12/13/add-zip-into-git-bash-on-windows/">zip utility (set in PATH)</a> </li><li>  <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli%3Fview%3Dazure-cli-latest">Azure CLI 2</a> </li></ul><br>  Starting the rollout procedure <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/AndreyPoturaev/minecraft-in-azure <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> minecraft-in-azure git checkout v1.0.0 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> MINESERVER_PASSWORD=&lt;place your password here&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> MINESERVER_DNS=&lt;place unique name here. Server url will be <span class="hljs-variable"><span class="hljs-variable">$MINESERVER_DNS</span></span>.westeurope.cloudapp.azure.com&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> MINESERVER_STORAGE_ACCOUNT=&lt;place unique name here&gt; az login . rollout.sh</code> </pre><br>  Result: <br><br><img src="https://habrastorage.org/webt/59/cf/f4/59cff4e09c4aa143717312.jpeg" alt="image"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/339034/">https://habr.com/ru/post/339034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339022/index.html">Uneducated youth</a></li>
<li><a href="../339024/index.html">Zyxel Nebula: an overview of the key capabilities of the cloud network ecosystem</a></li>
<li><a href="../339026/index.html">How to run a Java application with multiple versions of the same library in 2017</a></li>
<li><a href="../339028/index.html">As I wrote browser 3D football. Part 2</a></li>
<li><a href="../339030/index.html">Continued fasting from schoolchildren. How could Habrahabr change our destiny?</a></li>
<li><a href="../339036/index.html">[CppCon 2017] Bjorn Stroustrup: Learning and teaching modern C ++</a></li>
<li><a href="../339038/index.html">How to debug small programs</a></li>
<li><a href="../339044/index.html">How to bring the first project to the end. Part 2. Myths, mistakes and failures</a></li>
<li><a href="../339046/index.html">Work with resources, or how I pushed through @Cleanup</a></li>
<li><a href="../339048/index.html">Swift Generics: Styles for UIView and more. # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>