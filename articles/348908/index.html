<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reactive applications with Model-View-Intent. Part 3: State Reducer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous section, we discussed how to implement a simple screen with a Model-View-Intent pattern using a unidirectional data stream. In the thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reactive applications with Model-View-Intent. Part 3: State Reducer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/gw/6w/w0/gw6ww0knnaevmfj8-v6xdrory6e.jpeg"><br><br>  In the previous section, we discussed how to implement a simple screen with a Model-View-Intent pattern using a unidirectional data stream.  In the third part, we will build a more complex screen with MVI using the State Reducer. <br><a name="habracut"></a><br>  If you haven‚Äôt read the second part yet, you should do it before further reading, because it describes how we connected View with business logic through Presenter and how data moves in one direction. <br><br>  Now let's create a more complex screen: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/WWeRn0tMoXM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  As you can see, this screen displays a list of items (products) grouped by category.  The application displays only 3 items of each category and the user can click ‚ÄúDownload more‚Äù to download all products of the selected category (http request). The user can also do Pull-To-Refresh, and when he reaches the end of the list, more categories will be loaded (pagination ) Of course, all these actions can be performed simultaneously, and each of them may not be executed (for example, in the absence of the Internet) <br><br>  Let's implement it step by step.  First, let's define the View interface. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadFirstPageIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadNextPageIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pullToRefreshIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadAllProductsFromCategoryIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HomeViewState viewState)</span></span></span></span>; }</code> </pre> <br>  The implementation of View is fairly straightforward, and therefore I will not show the code here (can be found on <a href="">github</a> ) <br>  Now let's focus on the model.  As mentioned in the previous parts - the model should reflect the state.  So, I present to you a model called <b>HomeViewState</b> . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeViewState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> loadingFirstPage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Throwable firstPageError; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;FeedItem&gt; data; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> loadingNextPage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Throwable nextPageError; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> loadingPullToRefresh; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Throwable pullToRefreshError; <span class="hljs-comment"><span class="hljs-comment">// ...  ... // ...  ... }</span></span></code> </pre><br>  Note that <b>FeedItem</b> is simply an interface that must implement each item displayed in RecyclerView.  For example, <b>Product implements FeedItem</b> .  The <b>section</b> category display name <b>also implements the FeedItem</b> .  The UI element, which indicates that additional category items can be loaded, is a FeedItem and contains its own state in order to display whether we load additional items in a specific category: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdditionalItemsLoadable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeedItem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> moreItemsAvailableCount; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String categoryName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> loading; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Throwable loadingError; <span class="hljs-comment"><span class="hljs-comment">// ...  ... // ...  ... }</span></span></code> </pre><br>  And also create an element of business logic <b>HomeFeedLoader</b> , which is responsible for loading <b>FeedItems</b> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeFeedLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Observable&lt;List&lt;FeedItem&gt;&gt; loadNewestPage() { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Observable&lt;List&lt;FeedItem&gt;&gt; loadFirstPage() { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Observable&lt;List&lt;FeedItem&gt;&gt; loadNextPage() { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Observable&lt;List&lt;Product&gt;&gt; loadProductsOfCategory(String categoryName) { ... } }</code> </pre><br>  Now let's connect everything step by step in our Presenter.  Keep in mind that some code presented here, as part of Presenter, most likely should be transferred to Interactor in a real application (which I did not do for better readability).  First, load the initial data: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomePresenter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeViewState</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HomeFeedLoader feedLoader; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Observable&lt;HomeViewState&gt; loadFirstPage = intent(HomeView::loadFirstPageIntent) .flatMap(ignored -&gt; feedLoader.loadFirstPage() .map(items -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(items, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(emptyList, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(emptyList, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, error)) subscribeViewState(loadFirstPage, HomeView::render); } }</code> </pre><br>  While everything is going well, there are no big differences with the way we implemented the ‚Äúsearch screen‚Äù in part 2. Now let's try adding support for Pull-To-Refresh: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomePresenter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeViewState</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HomeFeedLoader feedLoader; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Observable&lt;HomeViewState&gt; loadFirstPage = ... ; Observable&lt;HomeViewState&gt; pullToRefresh = intent(HomeView::pullToRefreshIntent) .flatMap(ignored -&gt; feedLoader.loadNewestPage() .map( items -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(...)) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(...)) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HomeViewState(...))); Observable&lt;HomeViewState&gt; allIntents = Observable.merge(loadFirstPage, pullToRefresh); subscribeViewState(allIntents, HomeView::render); } }</code> </pre><br>  But wait: <b>feedLoader.loadNewestPage ()</b> returns only new items, but what about the previous items we downloaded earlier?  In the ‚Äútraditional‚Äù MVP, someone can do <b>view.addNewItems (newItems)</b> , but in the first part we have already discussed why this is a bad idea (‚ÄúState Problem‚Äù). The problem we are facing now is: Pull-To-Refresh depends on the previous HomeViewState, since we want to combine the previous elements with the elements that returned from Pull-To-Refresh. <br><br><h3>  Ladies and Gentlemen, I beg to love and favor - State Reducer </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/a3b/f74/c30/a3bf74c3040562a3a2a05af4121c9e8c.gif" alt="image"><br><br>  State Reducer is a concept from functional programming.  It takes the previous state to the input and calculates the new state from the previous state: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> State </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( State previous, Foo foo )</span></span></span></span>{ State newState; <span class="hljs-comment"><span class="hljs-comment">// ...   State      Foo return newState; }</span></span></code> </pre><br>  The idea is that the reduce () method combines the previous state with foo to calculate the new state.  Foo usually represents the changes we want to apply to the previous state.  In our case, we want to combine the previous HomeViewState (originally received from loadFirstPageIntent) with the results from Pull-To-Refresh.  It turns out that in RxJava there is a special operator for this - <b>scan ()</b> .  Let's change our code a bit.  We need to create another class that will reflect a partial change (in the code above it is called Foo) and be used to calculate the new state: <br><br><div class="spoiler">  <b class="spoiler_title">Homepresenter</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomePresenter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeViewState</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HomeFeedLoader feedLoader; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Observable&lt;PartialState&gt; loadFirstPage = intent(HomeView::loadFirstPageIntent) .flatMap(ignored -&gt; feedLoader.loadFirstPage() .map(items -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.FirstPageData(items) ) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.FirstPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) ) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.FirstPageError(error)) Observable&lt;PartialState&gt; pullToRefresh = intent(HomeView::pullToRefreshIntent) .flatMap(ignored -&gt; feedLoader.loadNewestPage() .map( items -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.PullToRefreshData(items) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.PullToRefreshLoading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>))) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.PullToRefreshError(error))); Observable&lt;PartialState&gt; allIntents = Observable.merge(loadFirstPage, pullToRefresh); HomeViewState initialState = ... ; <span class="hljs-comment"><span class="hljs-comment">//     Observable&lt;HomeViewState&gt; stateObservable = allIntents.scan(initialState, this::viewStateReducer) subscribeViewState(stateObservable, HomeView::render); } private HomeViewState viewStateReducer(HomeViewState previousState, PartialState changes){ ... } }</span></span></code> </pre><br></div></div><br>  Each Intent now returns an Observable &lt;PartialState&gt; instead of an Observable &lt;HomeViewState&gt;.  Then we combine them into one Observable using <b>Observable.merge ()</b> and finally apply the <b>Observable.scan ()</b> operator.  This means that whenever a user <b>runs an</b> intent, this intent will create <b>PartialState</b> objects, which will be reduced to <b>HomeViewState</b> , which in turn will be displayed on View (HomeView.render (HomeViewState)).  The only missing part is the information function itself.  By itself, the HomeViewState class has not changed, but we have added the Builder (Builder pattern) and now we can create new HomeViewState objects in a convenient way.  Now let's implement the details function: <br><br><div class="spoiler">  <b class="spoiler_title">viewStateReducer</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> HomeViewState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewStateReducer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HomeViewState previousState, PartialState changes)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.FirstPageLoading) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.toBuilder() .firstPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .firstPageError(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) .build() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.FirstPageError) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder() .firstPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .firstPageError(((PartialState.FirstPageError) changes).getError()) .build(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.FirstPageLoaded) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder() .firstPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .firstPageError(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) .data(((PartialState.FirstPageLoaded) changes).getData()) .build(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.PullToRefreshLoading) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder() .pullToRefreshLoading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .nextPageError(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) .build(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.PullToRefreshError) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder() .pullToRefreshLoading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-comment"><span class="hljs-comment">// Hide pull to refresh indicator .pullToRefreshError(((PartialState.PullToRefreshError) changes).getError()) .build(); if (changes instanceof PartialState.PullToRefreshData) { List&lt;FeedItem&gt; data = new ArrayList&lt;&gt;(); data.addAll(((PullToRefreshData) changes).getData()); data.addAll(previousState.getData()); return previousState.builder() .pullToRefreshLoading(false) .pullToRefreshError(null) .data(data) .build(); } throw new IllegalStateException("Don't know how to reduce the partial state " + changes); }</span></span></code> </pre><br></div></div><br>  I know that all these instanceof checks are not very good, but this is not the point of this article.  Why do technical bloggers write bad code, like in the example above?  Because we want to concentrate on a specific topic without forcing the reader to keep in mind all the source code (for example, our application with a basket of goods) or to know certain design patterns.  Therefore, I believe that it is better to avoid patterns in the article that will make the code better, but can also lead to worse readability.  The focus of this article is State Reducer.  Looking at him with the instanceof checks, anyone can understand what he is doing.  Should you use instanceof checks in your application?  No, use design patterns or other solutions.  For example, you can declare a PartialState interface with the public HomeViewState method computeNewState (previousState).  In general, you may find Paco Estevez RxSealedUnions useful when developing applications with MVI. <br><br>  Okay, I think you get the idea of ‚Äã‚Äãrunning a State Reducer.  Let's implement the remaining functionality: pagination and the ability to load more items of a certain category. <br><br><div class="spoiler">  <b class="spoiler_title">Homepresenter</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomePresenter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeViewState</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HomeFeedLoader feedLoader; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Observable&lt;PartialState&gt; loadFirstPage = ... ; Observable&lt;PartialState&gt; pullToRefresh = ... ; Observable&lt;PartialState&gt; nextPage = intent(HomeView::loadNextPageIntent) .flatMap(ignored -&gt; feedLoader.loadNextPage() .map(items -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.NextPageLoaded(items)) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.NextPageLoading()) .onErrorReturn(PartialState.NexPageLoadingError::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>)); Observable&lt;PartialState&gt; loadMoreFromCategory = intent(HomeView::loadAllProductsFromCategoryIntent) .flatMap(categoryName -&gt; feedLoader.loadProductsOfCategory(categoryName) .map( products -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.ProductsOfCategoryLoaded(categoryName, products)) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.ProductsOfCategoryLoading(categoryName)) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialState.ProductsOfCategoryError(categoryName, error))); Observable&lt;PartialState&gt; allIntents = Observable.merge(loadFirstPage, pullToRefresh, nextPage, loadMoreFromCategory); HomeViewState initialState = ... ; Observable&lt;HomeViewState&gt; stateObservable = allIntents.scan(initialState, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::viewStateReducer) subscribeViewState(stateObservable, HomeView::render); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> HomeViewState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewStateReducer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HomeViewState previousState, PartialState changes)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.NextPageLoading) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder().nextPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).nextPageError(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).build(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.NexPageLoadingError) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder() .nextPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .nextPageError(((PartialState.NexPageLoadingError) changes).getError()) .build(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.NextPageLoaded) { List&lt;FeedItem&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.addAll(previousState.getData()); data.addAll(((PartialState.NextPageLoaded) changes).getData()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder().nextPageLoading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>).nextPageError(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).data(data).build(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.ProductsOfCategoryLoading) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexLoadMoreItem = findAdditionalItems(categoryName, previousState.getData()); AdditionalItemsLoadable ail = (AdditionalItemsLoadable) previousState.getData().get(indexLoadMoreItem); AdditionalItemsLoadable itemsThatIndicatesError = ail.builder() .loading(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).error(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).build(); List&lt;FeedItem&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.addAll(previousState.getData()); data.set(indexLoadMoreItem, itemsThatIndicatesError); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder().data(data).build(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.ProductsOfCategoryLoadingError) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexLoadMoreItem = findAdditionalItems(categoryName, previousState.getData()); AdditionalItemsLoadable ail = (AdditionalItemsLoadable) previousState.getData().get(indexLoadMoreItem); AdditionalItemsLoadable itemsThatIndicatesError = ail.builder().loading(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>).error( ((ProductsOfCategoryLoadingError)changes).getError()).build(); List&lt;FeedItem&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.addAll(previousState.getData()); data.set(indexLoadMoreItem, itemsThatIndicatesError); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previousState.builder().data(data).build(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PartialState.ProductsOfCategoryLoaded) { String categoryName = (ProductsOfCategoryLoaded) changes.getCategoryName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexLoadMoreItem = findAdditionalItems(categoryName, previousState.getData()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> indexOfSectionHeader = findSectionHeader(categoryName, previousState.getData()); List&lt;FeedItem&gt; data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); data.addAll(previousState.getData()); removeItems(data, indexOfSectionHeader, indexLoadMoreItem); <span class="hljs-comment"><span class="hljs-comment">//     (  ) data.addAll(indexOfSectionHeader + 1,((ProductsOfCategoryLoaded) changes).getData()); return previousState.builder().data(data).build(); } throw new IllegalStateException("Don't know how to reduce the partial state " + changes); } }</span></span></code> </pre><br></div></div><br>  Implementing pagination (loading the next ‚Äúpage‚Äù with items) is quite similar to pull-to-refresh, except that we add loaded items to the end of the list, instead of adding them to the beginning (as we do with pull-to-refresh ) It‚Äôs interesting how we load more items of a certain category.  To display the load indicator or the repeat / error button for the selected category, we simply need to find the corresponding AdditionalItemsLoadable object in the list of all FeedItem.  Then we change this item to display the download indicator or the repeat / error button.  If we have successfully loaded all the elements in a particular category, we are looking for a SectionHeader and AdditionalItemsLoadable, and then replace all the elements in between with the new loaded elements. <br><br><h3>  Conclusion </h3><br>  The purpose of this article was to show how State Reducer can help us design complex screens with small, clear code.  Just take a step back and think about how you would implement it with a ‚Äútraditional‚Äù MVP or MVVM without a State Reducer?  The key point that allows us to use State Reducer is that we have a model that reflects the state.  Therefore, it was very important to understand from the first part of this series of articles what a Model is.  Also, the State Reducer can be used only if we can be sure that the State (or rather, the Model) comes from a single source.  Therefore, unidirectional data flow is also very important.  I think it is now clear why we stopped on these topics in the first and second part of this series of articles, and I hope you have the same ‚Äúaha!‚Äù Moment when all the dots are connected together.  If not - do not worry, for me it took a lot of time (and a lot of practice, and a lot of mistakes and repetitions). <br>  You may be wondering why we did not use the State Reducer on the search screen (in the second part).  Using a State Reducer basically makes sense when we are somehow dependent on the previous state. <br><br>  Last but not least, I want to dwell on - if you have not noticed (without immersion in details) all our data is unchanged (we always create a new HomeViewState, we never call the setter method on any of the objects).  Therefore, you should not have problems with multithreading.  A user can pull-to-refresh and at the same time load a new page and load more items of a certain category, because the State Reducer is able to produce the correct state without depending on the order of http responses.  In addition, we wrote our code using simple functions, with no <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25B1%25D0%25BE%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D1%258D%25D1%2584%25D1%2584%25D0%25B5%25D0%25BA%25D1%2582_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">side effects</a> .  This makes our code super-tested, reproducible, highly parallelizable, and easy to discuss. <br><br>  Of course, the State Reducer was not invented for MVI.  You can find State Reducer concepts in a variety of libraries, frameworks, and systems in different programming languages.  State Reducer is superbly embedded in the Model-View-Intent philosophy with a unidirectional data stream and a Model reflecting State. <br><br>  In the next part, we will focus on how to create reusable and reactive UI components with MVI. </div><p>Source: <a href="https://habr.com/ru/post/348908/">https://habr.com/ru/post/348908/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348896/index.html">Cradle: Rave. Two hackathons + conference, with emphasis on Big Data & ML, Blockchain, Quantum Computing, DevOps and Mobile</a></li>
<li><a href="../348898/index.html">Slack is the opposite of organizational memory.</a></li>
<li><a href="../348900/index.html">Blockchain and medicine: 4 startups in the field of health care that are worth following</a></li>
<li><a href="../348902/index.html">Slightly reduce the action</a></li>
<li><a href="../348906/index.html">Dynamic generation of proxy classes in Java</a></li>
<li><a href="../348912/index.html">Fast and secure JVM application monitoring with BPF magic</a></li>
<li><a href="../348914/index.html">The random () function of a googleblock works absolutely deterministically.</a></li>
<li><a href="../348916/index.html">How to deploy HD Wi-Fi for 45 thousand fans in 10 days? Stadium "Spartacus" in anticipation of the 2018 World Cup</a></li>
<li><a href="../348918/index.html">O'Zhal: What's wrong with flexible methodologies</a></li>
<li><a href="../348920/index.html">Why don't people buy your game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>