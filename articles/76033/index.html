<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Text at any cost: PPT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago we discussed with you getting clear text from various data formats: be it PDF or DOC. In one of the discussions , it was suggested that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Text at any cost: PPT</h1><div class="post__text post__text-html js-mediator-article">  Some time ago we discussed with you getting clear text from various data formats: be it PDF or DOC.  In <a href="http://habrahabr.ru/blogs/php/69417/">one of the discussions</a> , it was suggested that when parsing PowerPoint presentations, I would earn hemorrhoids or another terrible soft spot disease.  Well, by the will of fate I had to get the text out of this ‚Äúsweet‚Äù format.  Frankly, <i>hemorrhoids could not be earned</i> , but the class for parsing presentations came out. <a name="habracut"></a><br><br><h4>  <s>Not</s> much about PPT format </h4><br>  Like DOC, PPT is an add-on to the WCBFF (Structured Binary File Format) format, which you can read <a href="http://habrahabr.ru/blogs/php/72745/">about</a> in an <a href="http://habrahabr.ru/blogs/php/72745/">article about MS Word</a> I wrote earlier.  I will only note that during testing I found a few errors (and besides, I saw a bunch of ‚Äúbroken‚Äù files from which I had to get the text) in the old implementation of <a href="">WCBFF</a> and <a href="">DOC</a> , so I advise you to update your sources to those who use my work. <br><br>  So, we digress.  Let's continue the conversation about PowerPoint.  Unlike DOC, we will not work with <code>WordDocument</code> and <code>1Table</code> ‚Äúfiles‚Äù, as before, but with presentation-specific ones: <code>Current User</code> and <code>PowerPoint Document</code> .  The presence of both ‚Äúfiles‚Äù in the ‚Äúfile system‚Äù of a CBF file is mandatory for presentations.  By them, we can determine that we have a presentation in front of an erroneous extension. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, to start getting data from PPT, it‚Äôs worth reading a small ‚Äúfile‚Äù ‚Äîthe record (or ‚Äúfile‚Äù consisting of one <code>CurrentUserAtom</code> entry) <code>Current User</code> .  This entry contains technical information about who edited the file last time, but this is not the most important.  In this block there is information about the offset to the first <code>UserEditAtom</code> record, which will be discussed below. <br><br>  Now I will tell you how to read the records in PPT.  Any record in the presentation contains a special <code>rh</code> header that contains technical information about it.  To do this, read the first 8 bytes of any record.  The first word usually does not contain the necessary information, but we will need the next 6 bytes.  WORD at offset 2 ( <code>rh.recType</code> ) identifies the type of record by which you can find out what to do with the record further.  Long at offset 4 ( <code>recLen</code> ) - record length excluding the header of eight bytes.  This recording method is quite convenient and allows you to avoid many errors when parsing a presentation file. <br><br>  What's next?  Returning to the <code>UserEditAtom</code> .  This entry is already in the <code>PowerPoint Document</code> .  Later we will work only with this "file".  With the help of reading this and related records, we have to build such a marvelous thing as an array of displacements <code>PersistDirectory</code> , with which we will look for the main structure of the PowerPoint document - <code>DocumentContainer</code> .  To do this, we must read the current <code>UserEditAtom</code> record, find in it the offset <code>offsetPersistDirectory</code> to the current "live" version of <code>PersistDirectory</code> and the offset <code>offsetLastEdit</code> to the next <code>UserEditAtom</code> .  So let's continue to get offsets until we hit the zeros in the DWORD <code>offsetLastEdit</code> . <br><br>  After all the <code>offsetPersistDirectory</code> offsets have been <code>offsetPersistDirectory</code> we need to create this same <code>PersistDirectory</code> .  We go on the offset in the reverse order and read the record <code>PersistDirectoryAtom</code> .  They contain an array of <code>PersistDirectoryEntry</code> entries.  Each of them contains the number of the first entry <code>persistId</code> and their number <code>cPersist</code> in the current entry.  After this information comes an array of offsets to <code>PersistDirectory</code> objects.  This is the most important array by which we will find links to all objects of the presentation. <br><br>  Now let's go back to the last <code>UserEditAtom</code> read and find the <code>docPersistIdRef</code> field <code>docPersistIdRef</code> .  This is the number of the most important <code>DocumentContainer</code> object in <code>PersistDirectory</code> .  We read it.  It stores the car and a small cart of information about the current presentation: headers and footers, notes for slides and the main thing - the record <code>SlideListWithTextContainer</code> , containing all sorts of different <code>SlideListWithTextContainer</code> about slides. <br><br>  We will be interested in only three types of records that are stored in this main block: <code>TextCharsAtom</code> , <code>TextBytesAtom</code> and <code>SlidePersistAtom</code> .  With the first two everything is easy: this is unicode text on a slide and plain ANSI, respectively.  Another thing is when instead of the text we get a link to the <code>SlidePersistAtom</code> slide.  According to it, we have to read the <code>Drawing</code> object, which ( <i>sic!</i> ) Is not a PPT object.  Yes, inside the slide in this case, the MS Drawing object is embedded, with a rather unpleasant structure of nested records. <br><br>  When I first learned about this fact, to be honest, I was upset.  Another 600 pages with documentation pages.  But ODRAW, as it turned out, is built on the same <code>rh</code> headings with the same <code>recType</code> 's as the PPT.  This made it possible to ease the task and slightly cheat by searching in the <code>Drawing</code> object of all the same <code>TextCharsAtom</code> and <code>TextBytesAtom</code> by their <code>recType</code> 's. <br><br><h4>  Implementation </h4><br>  You can get the code with comments on <a href="https://github.com/rembish/TextAtAnyCost">GitHub</a> .  It is still a little damp, but I think that in the near future I will find all the pitfalls.  The main errors are popping up precisely because of the not quite correct (?) Reading of <code>PersistDirectory</code> .  If anyone has clarifications, I will listen to them with pleasure. <br><br><h4>  Literature </h4><br><ul><li>  <a href="http://download.microsoft.com/download/0/B/E/0BE8BDD7-E5E8-422A-ABFD-4342ED7AD886/PowerPoint97-2007BinaryFileFormat(ppt)Specification.pdf">PowerPoint97-2007BinaryFileFormat (ppt) Specification.pdf</a> ; </li><li>  <a href="http://download.microsoft.com/download/2/4/8/24862317-78F0-4C4B-B355-C7B2C1D997DB/%255BMS-PPT%255D.pdf">[MS-PPT] .pdf</a> ; </li><li>  <a href="http://download.microsoft.com/download/2/4/8/24862317-78F0-4C4B-B355-C7B2C1D997DB/%255BMS-ODRAW%255D.pdf">[MS-ODRAW] .pdf</a> . </li></ul><br><br><h4>  Text at any cost </h4><br><ul><li>  <a href="http://habrahabr.ru/blogs/php/72745/">Text at any cost: WCBFF and DOC</a> </li><li>  <a href="http://habrahabr.ru/blogs/php/70119/">Text at any cost: RTF</a> </li><li>  <a href="http://habrahabr.ru/blogs/php/69568/">Text at any cost: PDF</a> </li><li>  <a href="http://habrahabr.ru/blogs/php/69417/">Text at any cost: DOCX and ODT</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/76033/">https://habr.com/ru/post/76033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../76024/index.html">How to do everything</a></li>
<li><a href="../76026/index.html">‚ÄúChinese‚Äù multiplication method</a></li>
<li><a href="../76028/index.html">If Earth had rings like Saturn</a></li>
<li><a href="../76030/index.html">Exponator - extension for viewing EXIF ‚Äã‚Äãdata of photos</a></li>
<li><a href="../76032/index.html">Comparing Agile Methodologies</a></li>
<li><a href="../76035/index.html">How to give health?</a></li>
<li><a href="../76037/index.html">Traumatic and the right of a citizen of Ukraine to self-defense in arms</a></li>
<li><a href="../76042/index.html">fwrite / fread in windows can damage your data</a></li>
<li><a href="../76043/index.html">Minesweeper on GWT</a></li>
<li><a href="../76048/index.html">Opera 10.10 Final</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>