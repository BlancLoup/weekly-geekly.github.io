<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to overdo the door lock</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third-party project of the Internet of things in my company began when we could not reinstall the door lock, which was inherited from the previous...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to overdo the door lock</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/11f/ba7/de9/11fba7de903c3af2b911ba9392aec2e5.jpg"><br><br>  The third-party project of the Internet of things in my company began when we could not reinstall the door lock, which was inherited from the previous tenant.  It was one of those little things that we learned about after moving to a new office. <br><br>  Usually people just pay for a new castle.  But for us it was too small, and no one wanted a doorbell.  In addition, we are engineers - and wanted to play with some iron. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The goal was to open the door with a phone or a wearable gadget.  There were several ways to approach the problem.  In theory, we could use an application, integration into another platform, or anything else that could send a signal to open a lock. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/094/861/121/094861121cc8ffb0c36ddb54a235c65f.jpg"><br>  <sup><font color="gray">Chima Open Door on Pebble and iOS</font></sup> <br><br>  To date, in our door experiment, we have developed solutions for integrating with Slack, native iOS and Android applications, Apple Watch and Pebble.  I will dwell on the architecture of mobile applications.  I admit that the final product is slightly over-complicated, but we love it so much! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b9/e04/8a8/5b9e048a86adc16636d201dfe21882ba.png"><br>  <sup><font color="gray">Architecture project of our IoT door lock</font></sup> <br><br>  What exactly happens when you press a button in your iOS / Android application?  An HTTP request is sent to the cloud server, which is the signal to send a message to the doorbell daemon via the client server, which then tells the relay card to open the lock. <br><br>  Traditionally, the door lock is opened by pressing a button next to the door.  But modern technology allows you to go beyond the immediate physical buttons.  In addition to the physical button that signals <code>Doorlock Daemon</code> on the diagram, we added two more triggers: the cloud trigger and the Bluetooth Low Energy (BLE) trigger, thanks to our choice of hardware. <br><br>  This article describes the cloud trigger that your door lock relies on. <br><br><h3>  From the press of a button to a record stored on the Skygear server </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/b6b/aa2/dea/b6baa2dea4a232d7c34ee6688517f191.png"><br>  When the user presses the door open button in the mobile application, it accesses the cloud server. <br><br>  Two things happen on a cloud server.  First, the entry is saved.  We chose the <a href="https://docs.skygear.io/guides/">Skygear Cloud Database</a> server, which allows you to synchronize data with the cloud.  The server keeps a log of door opening requests. <br><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">SKYDatabase</span></span> *db = [[<span class="hljs-built_in"><span class="hljs-built_in">SKYContainer</span></span> defaultContainer] publicCloudDatabase]; <span class="hljs-built_in"><span class="hljs-built_in">SKYRecord</span></span> *openDoor = [<span class="hljs-built_in"><span class="hljs-built_in">SKYRecord</span></span> recordWithRecordType:<span class="hljs-string"><span class="hljs-string">@"OpenDoor"</span></span>]; [db saveRecord:openDoor completion:^(<span class="hljs-built_in"><span class="hljs-built_in">SKYRecord</span></span> *record, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"saveOpenDoorRecordWithCompletion failed: %@"</span></span>, error); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (completion) { completion(error); } }];</code> </pre> <br>  As soon as the record is saved, the <code>after_save</code> function from the <a href="https://docs.skygear.io/guides/">Skygear Cloud Functions</a> set is <a href="https://docs.skygear.io/guides/">triggered</a> , which runs our code in the cloud without the need to deploy directly to the server. <br><br>  The <code>after_save</code> function <code>after_save</code> called by the fact that the record was saved.  Asynchronously called <code>def after_open_door_save(record, original_record, db):</code> when a record of the type <code>'OpenDoor'</code> .  This function publishes a message on the <code>'xxx-channel'</code> . <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@skygear.after_save('OpenDoor', async=True) def after_open_door_save(record, original_record, db): publish('xxx-channel', { 'source': 'record-after-save', 'data': record.get('data', None), })</span></span></code> </pre> <br><h3>  Node Client and Clojure Server on Raspberry Pi </h3><br>  The next step is to create a listener for the request.  That's where it's time for the Node client and Clojure server on the Raspberry Pi.  The Node client listens to messages on the specified channel of the Skygear server.  The Clojure server is the only one who has the right to access the Raspberry Pi 3 scheme. The Node client issues a request to the Clojure server as soon as it receives a message. <br><br>  Here is the Node client script, it contains the code associated with our specific Skygear configurations.  The specified endPoint and API Key are needed to access the main server on Skygear.  <code>skygear.on('xxx-channel', onReceiveOpenDoor)</code> means a callback function ( <code>onReceiveOpenDoor</code> ) when receiving a message on the <code>'xxx-channel'</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceiveOpenDoor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'daemon-trigger-skygear: open door'</span></span>); exec(<span class="hljs-string"><span class="hljs-string">`curl localhost:8090 --header 'X-Source: Skygear'`</span></span>); } skygear.config({ <span class="hljs-attr"><span class="hljs-attr">endPoint</span></span>: <span class="hljs-string"><span class="hljs-string">'https://chimagun.skygeario.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">apiKey</span></span>: apiKey, }).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { skygear.loginWithUsername(<span class="hljs-string"><span class="hljs-string">'xxx'</span></span>, <span class="hljs-string"><span class="hljs-string">'xxx'</span></span>).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { skygear.on(<span class="hljs-string"><span class="hljs-string">'xxx-channel'</span></span>, onReceiveOpenDoor); }); });</code> </pre> <br>  Clojure server directly controls the General Purpose Input / Output (GPIO) pins on the Raspberry Pi.  The GPIO is the pins on the Raspberry Pi 3. They are connected to an external circuit that connects to the door magnet. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa8/3cd/c9a/fa83cdc9af5e1bc15d87fc975264d931.png"><br><br>  Here is the Clojure code that shows how the Raspberry Pi opens the door.  When the Clojure server receives a request from the Node client, it opens the lock for three seconds.  But if during these three seconds a new request is received, the timer is rearranged for another three seconds.  When time ends, the door locks again. <br><br><pre> <code class="hljs pgsql">; <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> unlock-chan <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> unlock events ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> unlock event <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> received <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> the <span class="hljs-number"><span class="hljs-number">3000</span></span>ms timeout, the door <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> kept <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>. (go-<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> [unlock nil] (<span class="hljs-keyword"><span class="hljs-keyword">when</span></span> unlock (sh "gpio" "write" "1" "1") (<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> [[<span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> _] [unlock nil]] (<span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> (str "Unlock triggered by " (:source <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span>))) (recur (alts! [unlock-chan (timeout <span class="hljs-number"><span class="hljs-number">3000</span></span>)])))) (sh "gpio" "write" "1" "0") (<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> "Door Locked")) (recur (&lt;! unlock-chan))) ; http event listener (run-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> (fn [req] (&gt;!! unlock-chan {:source (<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> req [:headers "x-source"]) :network)}) {:status <span class="hljs-number"><span class="hljs-number">200</span></span>}) {:ip "127.0.0.1" :port <span class="hljs-number"><span class="hljs-number">8090</span></span>})</code> </pre> <br>  Note: Skygear uses American AWS, while the door and Raspberry Pi are in Hong Kong.  In fact, our request ËäùÈ∫ªÈñãÈñÄ (Chima Open Door) travels around the world before it reaches the door. <br><br><h3>  Why Raspberry Pi? </h3><br>  You may ask why we chose the Raspberry Pi.  We also considered Arduino boards, because we have such in our office.  The fact is that we could not use a specific Arduino model, because we wanted to synchronize data with the Skygear JS SDK, and this particular Arduino did not allow installing the Node server. <br><br>  In addition, the Raspberry Pi supports Bluetooth Low Energy (this means that we can open the door using the third method, Bluetooth). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a4/3e2/b09/5a43e2b09f7dbac08e6d3b766a1e4ddd.jpg"><br>  <sup><font color="gray">Raspberry Pi with Linux is compatible with the open-source serverless platform Oursky</font></sup> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a87/f49/393/a87f493931f0cc77cfd8571d744e4687.jpg"><br><br><h3>  Additional integrations </h3><br>  Taking into account that the application is for internal use only, we have implemented the <a href="http://www.slack.com/">Slack</a> <code>/chima-open-door</code> opening command, since every Oursky employee has access to Slack. <br><br>  Later, other colleagues got involved in the project and wrote the WatchOS application and the Android application, which we posted on the internal platform.  In addition to pressing the button inside the application, we also provide alternative ways to open the door, such as the touch of iOS 3D, the Today extension, the Android widget, and even integration with Pebble, as some of our developers wear such watches. <br><br><hr><br>  That's all done!  Before you dive into development, consider two factors: reverse current (in this case for the Raspberry Pi) and the security of each of your integrations.  For example, we also integrated Bluetooth application access via Bluetooth Low Energy (BLE), which is a self-implemented version of two-factor authentication.  Among other integrations, you may consider notifications when the door is open (bell, LED). <br><br>  If you want to know about any of the mentioned technologies, feel free to contact us! <br><br>  I want to thank my colleagues David Ng, Boris ( <a href="https://medium.com/%40akiroz">akiroz</a> ), Brian (b Ë≤≥ ÂèÉ ËÇÜ Èõ∂Èõ∂) and May Young for working on the Android application, the implementation of the scheme and Clojure, the Pebble application and the text of this article, respectively.  This is a team work! <br><br><hr><br>  <b>Repository Links / Files</b> <br>  ‚Üí <a href="https://gitlab.com/oursky/doorlock-cloudcode">CloudCode</a> <br>  ‚Üí <a href="https://gitlab.com/oursky/doorlock-ios">iOS Client</a> <br>  ‚Üí <a href="https://gitlab.com/oursky/doorlock-android">Android client</a> <br>  ‚Üí <a href="https://gitlab.com/oursky/doorlock-pebble">Pebble Client</a> </div><p>Source: <a href="https://habr.com/ru/post/331470/">https://habr.com/ru/post/331470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331458/index.html">The history of the development and life of one small game. Release</a></li>
<li><a href="../331460/index.html">PostgreSQL features for those who migrated from MySQL</a></li>
<li><a href="../331462/index.html">Web sockets for php. Choosing a web server server</a></li>
<li><a href="../331466/index.html">Lessons from three million downloads on the AppStore</a></li>
<li><a href="../331468/index.html">Use template + constexpr to create mask masks for microcontroller peripherals at compile time (C ++ 14)</a></li>
<li><a href="../331472/index.html">Introduction to ServiceNow and IT Infrastructure Management: Digest # 2</a></li>
<li><a href="../331474/index.html">Automatic compression of stored data in redis</a></li>
<li><a href="../331476/index.html">Visualizing goals increases their achievement by 46%. How do we solve this in WebCanape?</a></li>
<li><a href="../331478/index.html">How to hold a raffle among Java programmers</a></li>
<li><a href="../331482/index.html">Challenges marathon round of Yandex. Algorithm 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>