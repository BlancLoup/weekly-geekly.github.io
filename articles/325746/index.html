<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Repair remote server after removing part of OS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, there were a couple of interesting articles on Habr√© (for example, one , two, and in a number of colleagues ‚Äôblogs), after reading which the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Repair remote server after removing part of OS</h1><div class="post__text post__text-html js-mediator-article">  Recently, there were a couple of interesting articles on Habr√© (for example, <a href="https://habrahabr.ru/company/centosadmin/blog/321074/">one</a> , <a href="https://habrahabr.ru/post/321696/">two,</a> and in a number of colleagues ‚Äôblogs), after reading which there was a thought, not to share with the community the experience of getting out of interesting situations encountered while working in outsourcing. <br><br>  Today, about restoring access to a virtual machine from linux after removing a part of the operating system. <br><br>  If the content is interesting to the audience, then I will try to write a number of similar articles. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/ab1/7bb/363/ab17bb363b9a48b78b5b7372d4cab74b.png"></div><a name="habracut"></a><br><h2>  Formulation of the problem </h2><br>  In early 2012, it was necessary to do a v2v migration of several linux virtual machines between different data centers.  I don‚Äôt remember for what reason, but chose a method through rsync of all partitions (of course, then witchcraft with kernel settings / modules / initrd / grub and so on. Standard procedures). <br><br>  Since the servers were ‚Äúvoluminous‚Äù, these are important, replication is not possible, the channels are narrow, strict downtime requirements, deadlines yesterday, etc.  etc., then painted a detailed work plan in several stages of synchronization with subsequent desynchronization of changes.  The important point was the lack of access to the virtual machine console (target, where they migrated from) because it was in a private cloud.  The strict conditions were dictated by the Customer (the classic desire to do everything quickly, cheaply and efficiently), so we secured ourselves as much as possible: warned of the risks, made backups ourselves and asked to make butt backup, service users were notified of the work, the whole operation process was worked out to the smallest details, ‚ÄúWindows‚Äù at night are specified - nothing foreshadows trouble. <br><br><h2>  Beginning of work </h2><br>  Further, as per the law of Murphy: if something can happen, it will happen. <br><br>  The human factor intervened: at the stage of synchronization, the administrator confused the rsync arguments and accidentally swapped the source and destination addresses.  We were saved from data loss by the fact that synchronization was from the / usr mount point, and the administrator managed to notice and quickly interrupted the execution of the command.  As a result, the directories / usr / {bin, lib *, sbin} were hit - some of the files were deleted.  The main problem was that, due to the lack of many libraries, it was impossible to either open a new session, run rsync, or restore everything through the package manager, in general, only that + basic utilities without special dependencies remained.  The evening stopped being languid ... <br><br>  Then it started: brainstorming, hypothesis testing and way out was organized.  Everyone was "fun."  At the same time, the option of working from scratch and launching what was left was worked out, but this would mean a failure to meet deadlines and the loss of altered data. <br><br><h2>  Recovery description </h2><br>  Immediately make a reservation, this algorithm is not a panacea and is not necessarily the optimal solution, but it has a big plus - it quickly and successfully worked. <br><br>  The idea is as follows: find a donor, copy the missing data to start rsync, run rsync, restore all the libraries / commands, go through the package integrity / diff th system from backup, then remove the necessary data. <br><br>  Immediately, scans of the ‚Äúbroken‚Äù server were raised to work, a working server with a similar OS was found, which they decided to use as a donor for copying libraries and programs from it. <br><br>  The issue with the transport was open - nothing works on the "bit" server.  Is that telnet.  Then they remembered that through it you can easily send GET requests.  If you can, then you need it!  Since everything in * nix is ‚Äã‚Äãstored as files, then you can take, convert the archive with the necessary data into a unicode text file and transfer it as plain text (it‚Äôs better not to find a working method to transfer data relatively consistent through telnet). <br><br>  On the problem server there was an inverse task, to accept data, convert it into archive, unpack, bring rsync to working condition, then everything is like clockwork. <br><br>  On the production server, we performed a series of actions (conditionally): <br><br><ol><li>  We collect in archive that is required: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tar</span></span> zcf /tmp/usr.tgz /usr...</code> </pre> <br></li><li>  Convert from binary to text format: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">cat</span></span> /tmp/usr.tgz | busybox uuencode -m - &gt; usr.txt</code> </pre> <br></li><li>  We move to the web server, where there is access from the broken server: <br><br><pre> <code class="hljs swift">mv usr.txt /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html</code> </pre> </li></ol><br>  On a broken server (conditionally): <br><br><ol><li>  Trying to download the file: <br><br><pre> <code class="hljs pgsql">telnet workserver <span class="hljs-number"><span class="hljs-number">80</span></span> &gt; usr.txt <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /usr.txt</code> </pre> <br></li><li>  We look at how many lines are occupied by the service headers head -30 usr.txt (you can immediately cut off base64 via sed, but for safety purposes, we decided to look with our hands): <br><br><pre> <code class="hljs vhdl"> Trying workserver... Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> workserver. Escape <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> '^]'. HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Date: Fri, <span class="hljs-number"><span class="hljs-number">17</span></span> Jan <span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span> GMT Server: Apache Last-Modified: Fri, <span class="hljs-number"><span class="hljs-number">17</span></span> Jan <span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> GMT Accept-Ranges: bytes Content-Length: <span class="hljs-number"><span class="hljs-number">262635116</span></span> Connection: close Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-literal"><span class="hljs-literal">text</span></span>/plain; charset=utf-<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>-base64 <span class="hljs-number"><span class="hljs-number">644</span></span> - bmV0LnNoLm1lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code> </pre> <br></li><li>  Delete the first http lines with the command (delete lines 1 through 12, inclusive, before the begin-base64 line): <br><br><pre> <code class="bash hljs">sed -e <span class="hljs-string"><span class="hljs-string">'1,12d'</span></span> usr.txt</code> </pre> <br></li><li>  Convert back from text format to binary: <br><br><pre> <code class="bash hljs">busybox uudecode -o /root/usr.tgz usr.txt</code> </pre> <br></li><li>  Unpacking /root/usr.tgz and manually transfer files that are deleted; <br></li><li>  Check whether rsync has earned, if not - see what is missing, if yes - start rsync, synchronize service folders with a working copy; <br></li><li>  We are looking for what has changed (conditionally): <br><br><pre> <code class="bash hljs">rpm -Va | tr -s <span class="hljs-string"><span class="hljs-string">' '</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">'s/\ d\ /\ /g'</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">'s/\ c\ /\ /g'</span></span> | cut -f2 -d<span class="hljs-string"><span class="hljs-string">' '</span></span> &gt; va2.xt rpm -qf $(cat va2.xt) | sort -n | uniq &gt; reinstall.pkg yum -y reinstall $(cat reinstall.pkg)</code> </pre> <br></li><li>  Depending on the affected packages, a reboot may be required (after removing backup changes, working out options for rolling back to another server, and 3-fold checks that everything is loaded, preferably after reinstalling the kernel). </li></ol><br><h2>  Results </h2><br>  We were able to keep within the allotted time.  Business problems are not felt.  Nevertheless, we carried out a thorough analysis of the situation and in the future such errors did not recur. <br>  On the technical side, the following points were noted: <br><br><ul><li>  Now, in all situations where the original data is stored, the file systems are remounted before read only into read only mode; </li><li>  Works are performed in screen; </li><li>  All administrators conducting the work, copy only from a text editor (vi, notepad, etc) to exclude any errors (in this case, the administrator used the history to enter commands and slightly modified).  Regularly no departures from the plan.  Before that, everything is checked on test benches, checked by experienced administrators; </li><li>  On critical operations, a second, more experienced administrator is always on duty to analyze what is happening and, if necessary, intercept management; </li><li>  A number of packages / software have been compiled that are installed on the involved machines (after performing work on some, they are removed for safety reasons) and are used in case of non-standard situations; </li><li>  Now this task has been added to the list of training tasks when teaching employees how to restore * nix-like systems, i.e.  in addition to RHCE certification, each administrator must be able to solve it + it is interesting to give it to the linux-admins at the interview :) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/325746/">https://habr.com/ru/post/325746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325734/index.html">Setting up backup of information in the cloud Microsoft Azure Backup</a></li>
<li><a href="../325736/index.html">9th MSK.NET Community Meeting</a></li>
<li><a href="../325738/index.html">Why a lot of JOIN in the query is bad or do not interfere with the optimizer</a></li>
<li><a href="../325740/index.html">IT Events Calendar for April '17</a></li>
<li><a href="../325744/index.html">Rethinking markup. First steps with Gantry 5</a></li>
<li><a href="../325748/index.html">Games and the cloud. Myths and reality. We expect a heated discussion on April 12. Come virtually</a></li>
<li><a href="../325752/index.html">A bug in Telegram VoIP, which allows you to find out the address of the interlocutor</a></li>
<li><a href="../325756/index.html">Evolution on React + Redux</a></li>
<li><a href="../325758/index.html">Petri net with symfony a la WorkFlow component</a></li>
<li><a href="../325760/index.html">CSS Grid Layout. Fast start</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>