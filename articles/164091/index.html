<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practical use of the Racc - LALR generator (1) parser for Ruby</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of creating a framework for some Enterprise class system, I had the task of creating a utility for automated code generation using a UML model...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practical use of the Racc - LALR generator (1) parser for Ruby</h1><div class="post__text post__text-html js-mediator-article">  As part of creating a framework for some Enterprise class system, I had the task of creating a utility for automated code generation using a UML model.  Nothing most suitable for a quick and effective solution of the problem, except for the use of Ruby, and the built-in ERB template engine, has not turned up. <br><br>  The project file from the UML modeling environment was a database of SQLite3 format, however, the environment stored some of the information in this database as serialized BLOB objects.  The serialization format was textual, but not compatible with any of the known ones, such as XML, YAML, quite remotely resembled JSON.  It was impossible to use parsers existing in nature. <br><br>  In simple cases, when you do not need the entire object, but only a pair of scalar fields of a specific instance, then of course you can stupidly get to the desired regulars.  Otherwise, there is a universal solution to the problem, which allows you to quickly create your own parsers for such structures, deserializing them into Ruby objects. <br><a name="habracut"></a><br>  This is how the original serialized objects look like. <br>  The challenge is to get this into the complex structure of Ruby based on Array and Hash. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  data.txt </h4><br><pre><code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">7</span></span>ghoJdyGAqACCgeT:"User":<span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> { FromEndRelationships=( &lt;vdHoJdyGAqACCgfe&gt;, &lt;<span class="hljs-number"><span class="hljs-number">9</span></span>bToJdyGAqACCgfF&gt; ); _masterViewId="7ghoJdyGAqACCgeS"; pmLastModified="1355667704781"; pmAuthor="author"; Child=( {UwZoJdyGAqACCgei:"name":<span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> { visibility=<span class="hljs-number"><span class="hljs-number">71</span></span>; pmLastModified="1355667655234"; pmAuthor="author"; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=&lt;_n2oJdyGAqACCgXh&gt;; pmCreateDateTime="1355667628234"; _modelViews=<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; _modelEditable=T; }}, {<span class="hljs-number"><span class="hljs-number">9</span></span>lZoJdyGAqACCgel:"created":<span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> { visibility=<span class="hljs-number"><span class="hljs-number">71</span></span>; type_string="date"; pmLastModified="1355667655234"; pmAuthor="author"; pmCreateDateTime="1355667630703"; _modelViews=<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; _modelEditable=T; }}, {nLFoJdyGAqACCgeo:"active":<span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> { visibility=<span class="hljs-number"><span class="hljs-number">71</span></span>; pmLastModified="1355667655234"; pmAuthor="author"; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=&lt;_n2oJdyGAqACCgXY&gt;; pmCreateDateTime="1355667639609"; _modelViews=<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; _modelEditable=T; }} ); pmCreateDateTime="1355667607671"; _modelViews=( {<span class="hljs-number"><span class="hljs-number">4</span></span>QhoJdyGAqACCgeU:"View":ModelView { container=&lt;hguoJdyGAqACCgeL&gt;; <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>="7ghoJdyGAqACCgeS"; }} ); _modelEditable=T; }</code> </pre> <br><br>  If we analyze the original format, the following elements can be distinguished in it, which clearly define its grammar: <br><br><ul><li>  An object.  It starts with a format string <i>Id: "Name": Type</i> , and then contains a set of attributes in curly braces. </li><li>  Object Attributes  Indicated as <i>key = value</i> , plus a semicolon. </li><li>  Attribute value  May be a string, a number, a link, another object, or a collection of any of the listed values. </li><li>  Values ‚Äã‚Äãare specified for each type of notation.  Strings enclosed in quotes.  The object is enclosed in braces.  The collection of values ‚Äã‚Äãis enclosed in parentheses, separated by commas. </li></ul><br>  Such a grammar is context-free; it can easily be described using the <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0_%25D0%2591%25D1%258D%25D0%25BA%25D1%2583%25D1%2581%25D0%25B0-%25D0%259D%25D0%25B0%25D1%2583%25D1%2580%25D0%25B0">Backus-Naur form</a> .  And for parsing use the ascending shift / convolution algorithm.  One of the most common algorithms in this category is <a href="http://ru.wikipedia.org/wiki/LALR(1)">LALR (1)</a> , it is used in such well-known ‚Äúcompiler compilers‚Äù like Yacc / GNU Bison.  There is also an implementation for the Ruby platform we are interested in - this is <b>Racc</b> .  We will use it to create our parser. <br><br><h4>  Ascending shift / convolution algorithm </h4><br>  In order to get a basic understanding of <b>Racc</b> and create elements of our future parser, it is sufficient in a general simplified way to represent the principle of operation of the upward shift-convolution algorithm. <br><br>  Suppose we have an input stream of characters: <br><br> <code> +  + </code> <br> <br>  We also set grammar rules: <br><br> <code>   + </code> <br> <code>   + </code> <br> <br>  The incoming flow is divided into two parts by a marker: the analyzed left, and the unanalyzed right.  The marker is visually represented by the '|' symbol.  The algorithm sequentially reads one character from the stream; this is a shift operation (Shift) that moves the marker one position to the right.  The next step is to perform the convolution operation (Reduce) for the left part of the marker, in accordance with the rules of grammar.  And so on until the end of the characters and all convolutions will not be satisfied. <br><br> <code>s:  | +  + </code> <br> <code>r:  | +  + </code> <br> <code>s:  + |  + </code> <br> <code>r:  + |  + </code> <br> <code>s:  +  | + </code> <br> <code>r:  | + </code> <br> <code>s:  + | </code> <br> <code>r:  + | </code> <br> <code>s:  +  |</code> <br> <code>r:  |</code> <br> <br><h4>  Install Racc </h4><br>  The runtime for Racc-based parsers is already included in Ruby.  Starting with version 1.8.x, any parser created with Racc will work without additional gestures.  However, in order to be able to create your own parsers, you need to install the Racc package, which contains the parser generator.  This is done as standard via gem: <br><br> <code># gem install racc</code> <br> <br><h4>  Creating a parser on racc </h4><br>  The source for the Racc parser generator is a file (usually with a .y extension) containing a definition of the Ruby class of the parser, and including additional Racc directives.  The definition of the parser must contain the following elements: <br><br><ul><li>  Definitions of terminal grammar characters - tokens </li><li>  Definitions of grammar and convolution rules </li><li>  Lexical analyzer </li></ul><br><h5>  Tokens </h5><br>  So, the first thing that needs to be done is to distinguish in the grammar the so-called terminal symbols - elementary particles from which more complex structures are composed, and give them names.  We get something like this: <br><br><ul><li>  <b>T_OBJECTID</b> - object identifier </li><li>  <b>T_IDENTIFIER</b> - attribute identifier </li><li>  <b>T_STRING</b> - text string </li><li>  <b>T_NUMBER</b> - number </li><li>  <b>T_BOOLEAN</b> - boolean value </li><li>  <b>T_NULL</b> - <b>null</b> </li><li>  <b>T_REFERENCE</b> - link </li><li>  <b>T_LBR, T_RBR, T_LPAR, T_RPAR, T_EQ, T_COMMA, T_SEMICOLON</b> - punctuation marks: different brackets, equal sign, comma, semicolon </li></ul><br>  In the parser class definition, valid tokens are defined using the <b>token</b> keyword. <br><br><h5>  Lexical analyzer </h5><br>  The next step is to create a lexical analyzer.  Its functions include scanning the incoming stream and detecting tokens in it.  The lexical analyzer must transform the incoming stream into a set of consecutive tokens.  Racc, when performing a shift operation, must receive a new token from the incoming stream, converted by a lexical analyzer.  It does this by calling the <b>next_token</b> method of the parser class, which must return a structure containing the name and value of the token: <br><br><pre> <code class="ruby hljs">[<span class="hljs-symbol"><span class="hljs-symbol">:TOKEN_NAME</span></span>, <span class="hljs-string"><span class="hljs-string">'Token value'</span></span>]</code> </pre> <br>  As a marker of the end of the stream is the value: <br><br><pre> <code class="ruby hljs">[<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>]</code> </pre> <br>  To create a lexical analyzer, it is convenient to use the <i>StringScanner</i> class.  Sometimes it is important to choose the order of scanning patterns, as some tokens can overlap others.  In this example, the lexical analyzer performs the full processing of the entire incoming stream immediately at the start of the parser, calling the <b>tokenize</b> method, and storing the resulting tokens into the array, from which the next token method <b>next_token</b> each time receives the next token. <br><br><h5>  Grammar rules </h5><br>  The next step we describe the rules of grammar.  In Racc, this is done with the <b>rule</b> directive, following which rules are set using the Backus-Naur form.  Non-terminal symbols are expressed through terminal and non-terminal.  For example, in the following fragment, a nonterminal <b>attribute</b> is specified - an attribute of an object that, in accordance with our grammar, is an identifier, followed by an equal sign, an arbitrary value expressed by another nonterminal, and a trailing semicolon: <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">attribute:</span></span> T_IDENTIFIER T_EQ value T_SEMICOLON { result = { val[<span class="hljs-number"><span class="hljs-number">0</span></span>] =&gt; val[<span class="hljs-number"><span class="hljs-number">2</span></span>] } };</code> </pre> <br>  In curly braces, after the rule, a Ruby expression is specified that should perform a convolution of a given sequence of characters before the declared non-terminal, in this case, <b>attribute</b> .  The variables <b>val</b> and <b>result are</b> predefined by racc.  The <b>val</b> array contains the values ‚Äã‚Äãof a collapsible sequence, in this case val [0] contains the value T_IDENTIFIER, val [2] value value.  The <b>result</b> variable is the result of the collapsed value. <br><br>  To start the parser, you must call the <b>do_parse</b> method.  This method is defined in the <i>Racc :: Parser</i> class, from which our parser class will be inherited. <br><br>  Below is the complete source code for the parser definition. <br><br><h4>  parser.y </h4><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parser</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_OBJECTID</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_STRING</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_REFERENCE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_IDENTIFIER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_NUMBER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_BOOLEAN</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_NULL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">token</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_LBR</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_RBR</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_LPAR</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_RPAR</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_EQ</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_COMMA</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T_SEMICOLON</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rule</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class">[0] };</span></span> <span class="hljs-symbol"><span class="hljs-symbol">object:</span></span> T_OBJECTID T_LBR attributes T_RBR { oid = val[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">':'</span></span>); result = { <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; dequote(oid[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; convertNULL(dequote(oid[<span class="hljs-number"><span class="hljs-number">1</span></span>])), <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; dequote(oid[<span class="hljs-number"><span class="hljs-number">2</span></span>]) }.merge(val[<span class="hljs-number"><span class="hljs-number">2</span></span>]) }; <span class="hljs-symbol"><span class="hljs-symbol">attributes:</span></span> attribute { result = val[<span class="hljs-number"><span class="hljs-number">0</span></span>] } <span class="hljs-params"><span class="hljs-params">| attributes attribute { result = val[0].merge(val[1]) } ; attribute: T_IDENTIFIER T_EQ value T_SEMICOLON { result = { val[0] =&gt; val[2] } }; values: value { result = [val[0]] } |</span></span> values T_COMMA value { val[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt;&lt; val[<span class="hljs-number"><span class="hljs-number">2</span></span>] } ; <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> T_STRING { result = dequote(val[<span class="hljs-number"><span class="hljs-number">0</span></span>]) } <span class="hljs-params"><span class="hljs-params">| T_REFERENCE { result = dequote(val[0]) } |</span></span> T_NUMBER { result = val[<span class="hljs-number"><span class="hljs-number">0</span></span>].to_i } <span class="hljs-params"><span class="hljs-params">| T_BOOLEAN { result = val[0] == 'T' } |</span></span> T_NULL { result = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-params"><span class="hljs-params">| T_LBR object T_RBR { result = val[1] } |</span></span> T_LPAR values T_RPAR { result = val[<span class="hljs-number"><span class="hljs-number">1</span></span>] } ; ---- header ---- <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'strscan'</span></span> ---- inner ---- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tokenize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> tokens = [] s = StringScanner.new(text) <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> s.eos? <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.skip(<span class="hljs-regexp"><span class="hljs-regexp">/\s+/</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A[\w\.]+:\"*\w*\"*:\w+/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_OBJECTID</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\{/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_LBR</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\}/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_RBR</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\(/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_LPAR</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\)/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_RPAR</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\=/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_EQ</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\,/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_COMMA</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\A\;/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_SEMICOLON</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\w+/</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s[<span class="hljs-number"><span class="hljs-number">0</span></span>].match(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]+/</span></span>)) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_NUMBER</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span> (s[<span class="hljs-number"><span class="hljs-number">0</span></span>].match(<span class="hljs-regexp"><span class="hljs-regexp">/\A[TF]{1}\Z/</span></span>)) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_BOOLEAN</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">elsif</span></span> (s[<span class="hljs-number"><span class="hljs-number">0</span></span>].match(<span class="hljs-regexp"><span class="hljs-regexp">/\ANULL\Z/</span></span>)) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_IDENTIFIER</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/(["]).*?(?&lt;!\\)\1/m</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_STRING</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s.scan(<span class="hljs-regexp"><span class="hljs-regexp">/\&lt;.*?\&gt;/</span></span>) tokens &lt;&lt; [<span class="hljs-symbol"><span class="hljs-symbol">:T_REFERENCE</span></span>, s[<span class="hljs-number"><span class="hljs-number">0</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> s.getch <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> tokens &lt;&lt; [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tokens <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> @tokens = tokenize(text) do_parse <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @result <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_token</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tokens</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shift</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dequote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> text.gsub(<span class="hljs-regexp"><span class="hljs-regexp">/\A["&lt;]|["&gt;]\Z/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>).strip <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertNULL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span></span> text.upcase == <span class="hljs-string"><span class="hljs-string">"NULL"</span></span> ? <span class="hljs-literal"><span class="hljs-literal">nil</span></span> : text <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  The .y file is not yet a parser.  The parser should be generated using the <b>racc</b> utility, and it should be done every time after changing the definition of the parser in the .y file: <br><br> <code># racc parser.y -o parser.rb</code> <br> <br>  The resulting file with the class of the parser can be connected and used in the usual way: <br><br><h4>  main.rb </h4><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'pp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'./parser.rb'</span></span> parser = Parser.new obj = parser.parse(File.read(<span class="hljs-string"><span class="hljs-string">"data.txt"</span></span>)) puts obj.pretty_inspect</code> </pre><br>  This will be the result of the parser operation - Ruby's complex structure: <br><br><h4>  output </h4><br><pre> <code class="ruby hljs">{ <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"7ghoJdyGAqACCgeT"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"User"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Class"</span></span>, <span class="hljs-string"><span class="hljs-string">"FromEndRelationships"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"vdHoJdyGAqACCgfe"</span></span>, <span class="hljs-string"><span class="hljs-string">"9bToJdyGAqACCgfF"</span></span>], <span class="hljs-string"><span class="hljs-string">"_masterViewId"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"7ghoJdyGAqACCgeS"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmLastModified"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667704781"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmAuthor"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"author"</span></span>, <span class="hljs-string"><span class="hljs-string">"Child"</span></span> =&gt; [ { <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"UwZoJdyGAqACCgei"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Attribute"</span></span>, <span class="hljs-string"><span class="hljs-string">"visibility"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-string"><span class="hljs-string">"pmLastModified"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667655234"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmAuthor"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"author"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"_n2oJdyGAqACCgXh"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmCreateDateTime"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667628234"</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelViews"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelEditable"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"9lZoJdyGAqACCgel"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"created"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Attribute"</span></span>, <span class="hljs-string"><span class="hljs-string">"visibility"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-string"><span class="hljs-string">"type_string"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"date"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmLastModified"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667655234"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmAuthor"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"author"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmCreateDateTime"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667630703"</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelViews"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelEditable"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"nLFoJdyGAqACCgeo"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"active"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Attribute"</span></span>, <span class="hljs-string"><span class="hljs-string">"visibility"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-string"><span class="hljs-string">"pmLastModified"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667655234"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmAuthor"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"author"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"_n2oJdyGAqACCgXY"</span></span>, <span class="hljs-string"><span class="hljs-string">"pmCreateDateTime"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667639609"</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelViews"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelEditable"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ], <span class="hljs-string"><span class="hljs-string">"pmCreateDateTime"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"1355667607671"</span></span>, <span class="hljs-string"><span class="hljs-string">"_modelViews"</span></span> =&gt; [ { <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"4QhoJdyGAqACCgeU"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"View"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ModelView"</span></span>, <span class="hljs-string"><span class="hljs-string">"container"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"hguoJdyGAqACCgeL"</span></span>, <span class="hljs-string"><span class="hljs-string">"view"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"7ghoJdyGAqACCgeS"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"_modelEditable"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/164091/">https://habr.com/ru/post/164091/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164077/index.html">Post-mortem: Divine Space on Kickstarter.com</a></li>
<li><a href="../164083/index.html">The lessons of writing utilities for $ 1 000 000</a></li>
<li><a href="../164085/index.html">MySQL: we destroy stereotypes</a></li>
<li><a href="../164087/index.html">Center for collective development of microelectronics in Russia, stage I</a></li>
<li><a href="../164089/index.html">ABBYY-Habra-blog: results of the year</a></li>
<li><a href="../164093/index.html">Warm lamp phone</a></li>
<li><a href="../164095/index.html">Installing mercurial-server over ssh from source</a></li>
<li><a href="../164101/index.html">Java weather for beginners and older</a></li>
<li><a href="../164103/index.html">Google plans to attract 90% of MS Office users to Google Apps</a></li>
<li><a href="../164105/index.html">Electric Imp - Making a WiFi Thermometer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>