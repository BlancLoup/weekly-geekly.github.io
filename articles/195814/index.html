<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Timers in .Net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, not for the first time I come across the fact that developers do not fully understand how one of the standard timers in .NET - System.Thread...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Timers in .Net</h1><div class="post__text post__text-html js-mediator-article">  Recently, not for the first time I come across the fact that developers do not fully understand how one of the standard timers in .NET - System.Threading.Timer works. <br>  Those.  in general, they seem to understand that the timer does something, most likely in a ThreadPool - and if you use it to periodically execute something, it will work fine.  But if you need to create not one timer, but set 1000, then people start to worry: what if something is wrong there, and what if it is still 1000 threads and even afraid to use them in such cases. <br><br>  I would like to shed some light on this "mysterious" System.Threading.Timer. <br><a name="habracut"></a><br>  In .NET, there are still other timers, but they are mainly intended for solving specific problems (for example, for writing GUI applications).  We consider is designed to solve "system" problems or use in libraries. <br><br>  A little bit about how we could implement a timer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, for each periodically performed unit of work, we could create a separate thread that would wake up after a certain time interval, perform work, and fall asleep again.  It is clear that this is not the best option. <br><br>  One could go a different way and use the ‚Äútimer‚Äù kernel object.  For each periodic unit of work, create a core object and, in a separate thread, expect them in the style of: <br><br><pre><code class="cs hljs">WaitHandle.WaitAny(<span class="hljs-comment"><span class="hljs-comment">/*timerHandles[]*/</span></span>)</code> </pre> <br>  But, unfortunately or not, in .NET there is no API for working directly with such objects (kernel timers). <br><br>  There is a third variant of the timer implementation (obtained from the developers of the class System.Threading.Timer) <br>  When creating the first timer application in the domain through the P / Invoke mechanism, a ‚Äútimer‚Äù core object is created in the System.Threading.TimerQueue class: <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">SecurityCritical</span></span>] [SuppressUnmanagedCodeSecurity] [DllImport(<span class="hljs-string"><span class="hljs-string">"QCall"</span></span>, CharSet = CharSet.Unicode)] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TimerQueue.<span class="hljs-function"><span class="hljs-function">AppDomainTimerSafeHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateAppDomainTimer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dueTime</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">// some code if (this.m_appDomainTimer == null || this.m_appDomainTimer.IsInvalid) { this.m_appDomainTimer = TimerQueue.CreateAppDomainTimer(dueTime); // some code</span></span></code> </pre><br><br>  It also creates a separate thread that calculates how much you need to wait until the closest triggering of one of the timers, sets the appropriate parameters to the ‚Äútimer‚Äù kernel object and waits. <br>  Let's see how it looks.  Create a console project and connect the SOS Debugging Extension. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d5/16e/517/4d516e5177988fb4d89141b5cc1392d8.png" alt="image"><br><br>  As we can see, before creating the timer, we have only two streams: the ‚Äúmain‚Äù and the ‚Äúfinalizer‚Äù.  Let's move one line down. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/74c/d1a/3d3/74cd1a3d3eb36e08ea7d0f60f5687c0f.png" alt="image"><br><br>  We have two threads - one, ID 3, this is exactly the thread that works with the ‚Äútimer‚Äù core object.  And the second, ID 4, is the workflow of the pool, it has not yet managed to start, our callbacks will be executed in it. <br><br>  Now how it all works if you create several timers in sequence <br>  Go back to the System.Threading.TimerQueue class.  He is a singleton.  Every time you write code like this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(First, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>);</code> </pre><br>  This results in adding an instance of the System.Threading.TimerQueueTimer class to its internal queue (which is something like LinkedList).  Those.  this class contains all the created timers within itself (I incline that within the domain). <br>  After the first timer has been created.  The TimerQueue will regularly call the FireNextTimers method. <br>  What does it do (the code is long, I did not cite the source code, for whom it may be interesting to see for myself): <br>  He quickly goes over all the timers stored in it and finds the time until the closest triggering of the timer and sets the kernel object timer to send a notification through this interval.  As soon as this notification is received, the next trigger time will be recalculated and the kernel object timer will be set to a new interval.  When adding a new timer, the time of the next notification will be recalculated. <br><br>  Let's try creating 1000 timers and see what happens: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/513/164/958/5131649587486cca38db0a9f3f059b1c.png" alt="image"><br><br>  We see that creating 1000 timers does not entail creating 1000 threads.  The CLR created one thread to work with a kernel timer and several worker threads to handle timer responses. <br><br>  Total: <br>  When you work with the System.Threading.Timer class, there is one (per application domain) kernel object ‚Äútimer‚Äù and one thread for working with it, which works on the principle similar to the work of the heap data structure. <br>  On the question of 1000 timers - is it expensive to create so many timers in the application, I think that each case should be considered separately.  But knowing how timers are built from the inside will help make the right decision. <br><br>  Tested on Windows 7 64, .Net 4.5, VS2012. <br>  References: Duffy "Concurrent Programming on Windows", MSDN </div><p>Source: <a href="https://habr.com/ru/post/195814/">https://habr.com/ru/post/195814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195804/index.html">Automatic lap and time counting system for RC cars</a></li>
<li><a href="../195806/index.html">Generator utf-8 json on php with unicode 6 support</a></li>
<li><a href="../195808/index.html">We configure the HTTPS server on nginx</a></li>
<li><a href="../195810/index.html">Repairing a car with a 3D printer</a></li>
<li><a href="../195812/index.html">Derby.js deploy on Amazon EC2</a></li>
<li><a href="../195816/index.html">Javascript function argument schema or C-style prototypes without heavyweight frameworks</a></li>
<li><a href="../195818/index.html">Go: multithreading</a></li>
<li><a href="../195820/index.html">Automated test report generation</a></li>
<li><a href="../195830/index.html">We write a game development framework - Mechanic Framework</a></li>
<li><a href="../195832/index.html">Binary heap: proof of the complexity of the construction of O (n)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>