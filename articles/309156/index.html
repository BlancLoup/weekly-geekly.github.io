<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing IVR on Asterisk with ... Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I needed to add a metric for the uptime of the remote maintenance service to calculate the SLA. Statistics on API calls is an indirect indic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing IVR on Asterisk with ... Asterisk</h1><div class="post__text post__text-html js-mediator-article"><p>  Recently, I needed to add a metric for the uptime of the remote maintenance service to calculate the SLA.  Statistics on API calls is an indirect indicator of performance, and you need a reliable test of all functions from dialing from the external network to the user's passage through the entire maintenance menu.  I did not see anything ready on the Internet, so I decided to share my research. </p><br><p>  There is a remote service system - the client can call the call-center and check / change the settings of his account without the participation of the operator.  Tones (DTMF) are used to navigate through the menus and control settings.  The PBX in turn interacts with the core of the main system through the API, returning the results to the user in the form of voice messages. </p><br><p>  <strong>Task</strong> : set up an automated system check (correctly responds to requests / executes the necessary commands). <br>  Main requirements: </p><br><ul><li><p>  maximum likelihood of user simulation: i.e.  you just need to call and press buttons, and not call API methods around the call-center. </p><br></li><li>  working exactly with the recruitment plan that regular users fall into;  special context cannot be made for automated checking. </li></ul><a name="habracut"></a><br><p>  For this article, simplify our call-center and API to disgrace: when you call the call-center, the only service available to the user (key 1);  in it, the user is prompted to enter a PIN and, if it is correct, the status of the user account is issued (ON / OFF);  step left or right - an error message is displayed.  Three methods are available through the API: GET ping (call initialization), GET status (get status), POST status (set status). </p><br><p><img src="https://s3-eu-west-1.amazonaws.com/berlic-cloud/habr/ivr_scheme.png" alt="IVR Flow Chart"></p><br><p>  We will solve the problem with the help of Asterisk.  In fact, we need to collect a similar IVR only on behalf of the client: we need to describe the state machine (waiting for a greeting, waiting for a PIN request, etc.), and when moving to each of the states, perform certain actions. </p><br><p> It is clear how to send commands ‚Äî the call center expects tones from the user ‚Äî then you can use the <code>SendDTMF</code> command and ‚Äúpress‚Äù the necessary buttons on behalf of the client. </p><br><p>  How to change your state?  Yes, exactly the same!  To do this, we will slightly modernize the dialplan of our combat IVR by calling a simple macro in key places: </p><br><pre> <code class="hljs php">[macro-robot] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${CALLERID(name)}"</span></span>!=<span class="hljs-string"><span class="hljs-string">"Robot"</span></span>]?MacroExit()) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,SendDTMF(${ARG1})</code> </pre> <br><p>  As a result, in key IVR locations, if the call came from a robot, the selected DTMF sequence will be sent to the channel.  A delay of 1 second is added, so that our robot has time to go into the input mode. </p><br><p>  Now we can use the ability of Asterisk to send the call made to the local context we need - thus closing the IVR of the call-center and our robot between us.  In the simplest version, we can use the call-file and run the check, periodically copying this file to <code>/var/spool/asterisk/outgoing/</code> . </p><br><p>  The verification process will be as follows: </p><br><p>  <b>1.</b> Call the call center </p><br><p>  <b>2.</b> we wait, while it will be possible to choose service </p><br><p>  <b>3.</b> Push "1" </p><br><p>  <b>4.</b> We are waiting for the PIN to be entered. </p><br><p>  <b>5.</b> Enter the PIN </p><br><p>  <b>6.</b> We learn a condition </p><br><p>  - At the first check with an API call, we change the state to the opposite and re-check the state (go to step 3) </p><br><p>  - At the second check we are convinced that the state has changed to the opposite </p><br><p>  <b>8.</b> If the status has changed, we consider the check successful. </p><br><p>  <b>9.</b> In all other cases, we report an error. </p><br><p>  Below, I combined the dialplans of both Asterisks on one screen and showed how control / state changes are transmitted: </p><br><p><img src="https://s3-eu-west-1.amazonaws.com/berlic-cloud/habr/context-mix.png" alt="Interaction scheme"></p><br><div class="spoiler">  <b class="spoiler_title">Text, not a picture</b> <div class="spoiler_text"><p>  Hid in the spoiler, tk.  tearing the screen. </p><br><pre> <code class="hljs vbscript"> # <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>-file Channel: SIP/cc_peer/ivr &gt;----------\ Callerid: Robot | /--&lt; Context: robot-test | | Extension: s | | | | | [robot-test] | | [ivr] | | exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> init) &lt;--/ \-----&gt; exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(IVR Start) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(STATUS=) same =&gt; n,Answer() same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CURL(localhost/ping)}"</span></span>!=<span class="hljs-string"><span class="hljs-string">"PONG"</span></span>]?<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) /----------------------&lt; same =&gt; n,Macro(robot,<span class="hljs-number"><span class="hljs-number">00</span></span>) exten =&gt; <span class="hljs-number"><span class="hljs-number">00</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Init done) &lt;------------------------------/ same =&gt; n,Background(welcome) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n(again),Background(press_1_for_status) same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1</span></span>) ; Press <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> status &gt;----------------\ same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">5</span></span>) same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) \ same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) \ exten =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Status check) &lt;---------------------------\ \--------------------&gt; exten =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Status check) &lt;---------------------------------\ same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) \-------------------------&lt; same =&gt; n,Macro(robot,<span class="hljs-number"><span class="hljs-number">10</span></span>) | same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1234</span></span>) ; Send pin code &gt;----------------------------------------&gt; same =&gt; n,Read(PIN,enter_pin,<span class="hljs-number"><span class="hljs-number">4</span></span>) | same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(STATUS=${CURL(localhost/status?pin=${PIN})}) | same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">"ON"</span></span>]?<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>) | exten =&gt; _1[<span class="hljs-number"><span class="hljs-number">12</span></span>],<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(Status) &lt;--------------------------------------------------\ same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">"OFF"</span></span>]?off) | same =&gt; n,ExecIf($[${EXTEN}==<span class="hljs-number"><span class="hljs-number">11</span></span>]?MSet(CURRENT=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>=OFF)) | same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) | same =&gt; n,ExecIf($[${EXTEN}==<span class="hljs-number"><span class="hljs-number">12</span></span>]?MSet(CURRENT=OFF,<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>)) |---&lt; same =&gt; n(<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>),Macro(robot,<span class="hljs-number"><span class="hljs-number">11</span></span>) | same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">""</span></span>]?toggle) | same =&gt; n,Background(status_on) | same =&gt; n,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">"${CURRENT}"</span></span>]?System(echo GOOD &gt;&gt; /cc_check.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>)) | same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(s,again) | same =&gt; n,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>!=<span class="hljs-string"><span class="hljs-string">"${CURRENT}"</span></span>]?System(echo BAD &gt;&gt; /cc_check.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>)) \---&lt; same =&gt; n(off),Macro(robot,<span class="hljs-number"><span class="hljs-number">12</span></span>) | same =&gt; n,Hangup() same =&gt; n,Background(status_off) | same =&gt; n(toggle),NoOp(Toggle status) same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(s,again) | same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(STATUS=${<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>}) /--------------------------------------------------------------------------------------------/ same =&gt; n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(RES=${CURL(localhost/status,status=${<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>})}) / exten =&gt; <span class="hljs-built_in"><span class="hljs-built_in">err</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,NoOp(<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> occured) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) / /------&lt; same =&gt; n,Macro(robot,<span class="hljs-number"><span class="hljs-number">99</span></span>) same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1</span></span>) ; Press <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> status &gt;--------------------/ / same =&gt; n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) / same =&gt; n,Hangup() / exten =&gt; i,<span class="hljs-number"><span class="hljs-number">1</span></span>,System(echo BAD &gt;&gt; /cc_check.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) &lt;---------------------------/ [macro-robot] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${CALLERID(name)}"</span></span>!=<span class="hljs-string"><span class="hljs-string">"Robot"</span></span>]?MacroExit()) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,SendDTMF(${ARG1})</code> </pre> </div></div><br><p>  In our example, the result of the check is written to the file <code>/cc_check.log</code>  In the combat system, you will of course add these results to your monitoring system. </p><br><p>  In a real system, a simple CURL request to the API for testing the entire remote maintenance system is most likely not enough, so the solution can be expanded to monitor the robot‚Äôs call through AMI.  To do this, you need to modify the dialplan of the robot so that it sends <code>UserEvent'</code> to AMI.  Our demo configuration can be changed as follows: </p><br><div class="spoiler">  <b class="spoiler_title">robot-ami.conf</b> <div class="spoiler_text"><pre> <code class="hljs php">[robot-test-ami] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,UserEvent(CC_ROBOT_WAIT_INIT,RobotId: ${RobotId}) same =&gt; n,Set(STATUS=) same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) exten =&gt; <span class="hljs-number"><span class="hljs-number">00</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,UserEvent(CC_ROBOT_WAIT_SERVICE,RobotId: ${RobotId}) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,UserEvent(CC_ROBOT_WAIT_SERVICE,RobotId: ${RobotId},Data: Will press <span class="hljs-number"><span class="hljs-number">1</span></span> now) same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1</span></span>) ; Press <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> status same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) exten =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,UserEvent(CC_ROBOT_WAIT_PIN,RobotId: ${RobotId}) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,UserEvent(CC_ROBOT_WAIT_PIN,RobotId: ${RobotId},Data: Will send pin (<span class="hljs-number"><span class="hljs-number">1234</span></span>) now) same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1234</span></span>) ; Send pin code same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) exten =&gt; _1[<span class="hljs-number"><span class="hljs-number">12</span></span>],<span class="hljs-number"><span class="hljs-number">1</span></span>,UserEvent(CC_ROBOT_STATUS_CHECK,RobotId: ${RobotId}) same =&gt; n,ExecIf($[${EXTEN}==<span class="hljs-number"><span class="hljs-number">11</span></span>]?MSet(CURRENT=ON,<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>=OFF)) same =&gt; n,ExecIf($[${EXTEN}==<span class="hljs-number"><span class="hljs-number">12</span></span>]?MSet(CURRENT=OFF,<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>=ON)) same =&gt; n,UserEvent(CC_ROBOT_STATUS_CHECK,RobotId: ${RobotId},Data: Current status is <span class="hljs-string"><span class="hljs-string">'${CURRENT}'</span></span>) same =&gt; n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">""</span></span>]?toggle) same =&gt; n,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>==<span class="hljs-string"><span class="hljs-string">"${CURRENT}"</span></span>]?UserEvent(CC_ROBOT_RESULT,RobotId: ${RobotId},Data: GOOD)) same =&gt; n,ExecIf($[<span class="hljs-string"><span class="hljs-string">"${STATUS}"</span></span>!=<span class="hljs-string"><span class="hljs-string">"${CURRENT}"</span></span>]?UserEvent(CC_ROBOT_RESULT,RobotId: ${RobotId},Data: BAD)) same =&gt; n,Hangup() same =&gt; n(toggle),UserEvent(CC_ROBOT_STATUS_CHECK,RobotId: ${RobotId},Data: Need to toggle state) same =&gt; n,Set(STATUS=${<span class="hljs-keyword"><span class="hljs-keyword">NEW</span></span>}) same =&gt; n,UserEvent(CC_ROBOT_TOGGLE,RobotId: ${RobotId},Data: ${CURRENT}) same =&gt; n,Wait(<span class="hljs-number"><span class="hljs-number">2</span></span>) same =&gt; n,SendDTMF(<span class="hljs-number"><span class="hljs-number">1</span></span>) same =&gt; n,WaitExten(<span class="hljs-number"><span class="hljs-number">10</span></span>) exten =&gt; i,<span class="hljs-number"><span class="hljs-number">1</span></span>,UserEvent(CC_ROBOT_RESULT,RobotId: ${RobotId},Data: BAD)</code> </pre> </div></div><br><p>  To interact with such a dialplan, you need to connect to Asterisk, from which the robot's call is initiated, via AMI, make <code>Originate</code> and continue to act in accordance with incoming <code>UserEvent'</code> .  An example of the implementation of the script of our demo-test in Python: </p><br><div class="spoiler">  <b class="spoiler_title">test_call.py</b> <div class="spoiler_text"><pre> <code class="hljs lua">#!/usr/bin/python import <span class="hljs-built_in"><span class="hljs-built_in">os</span></span> import <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> import <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> import <span class="hljs-built_in"><span class="hljs-built_in">random</span></span> import sys import requests from asterisk.ami import Action, AMIClient seconds_to_wait = <span class="hljs-number"><span class="hljs-number">30</span></span> test_result = <span class="hljs-string"><span class="hljs-string">'unknown'</span></span> host = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span> # Asterisk with AMI <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> test dialplan user = <span class="hljs-string"><span class="hljs-string">'robot'</span></span> # AMI user password = <span class="hljs-string"><span class="hljs-string">'MrRobot'</span></span> # AMI password call_to = <span class="hljs-string"><span class="hljs-string">'Local/ivr'</span></span> # Call-center context = { # Robot dialplan context <span class="hljs-string"><span class="hljs-string">"context"</span></span>: <span class="hljs-string"><span class="hljs-string">"robot-test-ami"</span></span>, <span class="hljs-string"><span class="hljs-string">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"priority"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } def toggle_state(new_state): <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> <span class="hljs-string"><span class="hljs-string">'Will try to toggle state to {}'</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">format</span></span>(new_state) r = requests.post(<span class="hljs-string"><span class="hljs-string">'http://localhost/status'</span></span>, data = {<span class="hljs-string"><span class="hljs-string">'status'</span></span>:new_state.<span class="hljs-built_in"><span class="hljs-built_in">upper</span></span>()}) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> <span class="hljs-string"><span class="hljs-string">'Done! Actual state now: {}'</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">format</span></span>(r.text) def event_notification(source, event): global test_result keys = event.keys <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'RobotId'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> keys: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> keys[<span class="hljs-string"><span class="hljs-string">'RobotId'</span></span>] == robot_id: # it<span class="hljs-string"><span class="hljs-string">'s our RobotId if '</span></span>Data<span class="hljs-string"><span class="hljs-string">' in keys: data = keys['</span></span>Data<span class="hljs-string"><span class="hljs-string">'] else: data = '</span></span>unknown<span class="hljs-string"><span class="hljs-string">' if '</span></span>UserEvent<span class="hljs-string"><span class="hljs-string">' in keys: name = keys['</span></span>UserEvent<span class="hljs-string"><span class="hljs-string">'] else: name = '</span></span>unknown<span class="hljs-string"><span class="hljs-string">' if name.startswith('</span></span>CC_ROBOT<span class="hljs-string"><span class="hljs-string">'): print '</span></span>{}: {}<span class="hljs-string"><span class="hljs-string">'.format(name, data) if name == '</span></span>CC_ROBOT_TOGGLE<span class="hljs-string"><span class="hljs-string">': if data.lower() in ['</span></span>on<span class="hljs-string"><span class="hljs-string">','</span></span>off<span class="hljs-string"><span class="hljs-string">']: if data.lower() == '</span></span>on<span class="hljs-string"><span class="hljs-string">': toggle_state('</span></span>off<span class="hljs-string"><span class="hljs-string">') else: toggle_state('</span></span>on<span class="hljs-string"><span class="hljs-string">') else: print '</span></span>Unknown state {}<span class="hljs-string"><span class="hljs-string">'.format(data) if name == '</span></span>CC_ROBOT_RESULT<span class="hljs-string"><span class="hljs-string">': test_result = data # Generate uniq RobotId to distinguish events from different robots robot_id = '</span></span><span class="hljs-string"><span class="hljs-string">'.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(8)) print '</span></span>Current RobotId: {}<span class="hljs-string"><span class="hljs-string">'.format(robot_id) # Action to enable user events aEnableEvents = Action('</span></span>Events<span class="hljs-string"><span class="hljs-string">', keys={'</span></span>EventMask<span class="hljs-string"><span class="hljs-string">':'</span></span>user<span class="hljs-string"><span class="hljs-string">'}) # Action to originate call aOriginateCall = Action('</span></span>Originate<span class="hljs-string"><span class="hljs-string">', keys={'</span></span>Channel<span class="hljs-string"><span class="hljs-string">':call_to, '</span></span>Context<span class="hljs-string"><span class="hljs-string">':context['</span></span>context<span class="hljs-string"><span class="hljs-string">'], '</span></span>Exten<span class="hljs-string"><span class="hljs-string">':context['</span></span>extension<span class="hljs-string"><span class="hljs-string">'], '</span></span>Priority<span class="hljs-string"><span class="hljs-string">':context['</span></span>priority<span class="hljs-string"><span class="hljs-string">'], '</span></span>CallerId<span class="hljs-string"><span class="hljs-string">':'</span></span>Robot<span class="hljs-string"><span class="hljs-string">'}, variables={'</span></span>RobotId<span class="hljs-string"><span class="hljs-string">':robot_id} ) # Init AMI client and try to login client = AMIClient(host) # Register our event listener client.add_event_listener(event_notification) try: future = client.login(user, password) # This will wait for 1 second or fail if future.response.is_error(): raise Exception(str(future.response.keys['</span></span>Message<span class="hljs-string"><span class="hljs-string">'])) except Exception as err: client.logoff() sys.exit('</span></span>Error: {}<span class="hljs-string"><span class="hljs-string">'.format(err.message)) print '</span></span>Spawned AMI session to: {}<span class="hljs-string"><span class="hljs-string">'.format(host) try: # Try to enable user events coming future = client.send_action(aEnableEvents,None) if future.response.is_error(): raise Exception(str(future.response.keys['</span></span>Message<span class="hljs-string"><span class="hljs-string">'])) print '</span></span>Logged <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> as {}<span class="hljs-string"><span class="hljs-string">'.format(user) # Try to originate call future = client.send_action(aOriginateCall,None) if future.response.is_error(): raise Exception(str(future.response.keys['</span></span>Message<span class="hljs-string"><span class="hljs-string">'])) print '</span></span>Originated test call<span class="hljs-string"><span class="hljs-string">' except Exception as err: client.logoff() sys.exit('</span></span>Error: {}<span class="hljs-string"><span class="hljs-string">'.format(err.message)) print '</span></span>Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> events...<span class="hljs-string"><span class="hljs-string">' # Wait for events during timelimit interval for i in range(seconds_to_wait): time.sleep(1) # If test_result is changed (via events), then stop waiting if test_result != '</span></span>unknown<span class="hljs-string"><span class="hljs-string">': break; else: client.logoff() sys.exit('</span></span>Error: <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> limit exceeded<span class="hljs-string"><span class="hljs-string">') # Logoff if we still here client.logoff() print '</span></span>Test result: {}<span class="hljs-string"><span class="hljs-string">'.format(test_result)</span></span></code> </pre> </div></div><br><p>  Actions are performed similar to the above-described script with a call-file, but the call is initiated by a script command and the API call is also made from the script when the <code>CC_ROBOT_TOGGLE</code> event is <code>CC_ROBOT_TOGGLE</code> .  The result of the check comes with the event <code>CC_ROBOT_RESULT</code> . </p><br><p>  As a result, we solved the task within the framework of the required conditions: we call and ‚Äúpress buttons‚Äù, we make checks in the combat dialplan (giving out tones during the call if the robot calls). </p><br><p>  Have a good test! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309156/">https://habr.com/ru/post/309156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309142/index.html">Private unstructured types and type reuse</a></li>
<li><a href="../309144/index.html">About alignment of memory on ARM processors on a simple example</a></li>
<li><a href="../309150/index.html">Constants do not change: a small excursion into the depths of dotNet</a></li>
<li><a href="../309152/index.html">Review of computer vision problems in medicine</a></li>
<li><a href="../309154/index.html">Some examples of the practical use of RxJava</a></li>
<li><a href="../309158/index.html">Survey: Programmer and Salary</a></li>
<li><a href="../309160/index.html">Russian Post for Dummies</a></li>
<li><a href="../309162/index.html">Implementing a finite state machine in VHDL</a></li>
<li><a href="../309164/index.html">The digest of interesting materials for the mobile developer # 169 (August 29 - September 4)</a></li>
<li><a href="../309166/index.html">Offline-first app with Hoodie & React. Part One: Browser Database</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>