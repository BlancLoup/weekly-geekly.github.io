<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deleting data from the shardirovanny base</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An article about how to solve the problem of optimizing the process of deleting files from a shardirovannoy system. It's about the project for sharing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deleting data from the shardirovanny base</h1><div class="post__text post__text-html js-mediator-article">  An article about how to solve the problem of optimizing the process of deleting files from a shardirovannoy system.  It's about the project for sharing and working with files.  The system was a startup about 8 years ago, then it successfully shot and was sold several times.  There are 4 developers in the project who are with the project from the very beginning, which is very valuable.  Documentation, traditionally, either did not have time to write, or it is not very relevant. <br><br>  Why do you need to read this and why did I write all this?  I want to talk about the rake, which carefully lie inside the system and hit so that the stars spill from the eyes. <br><br>  I want to say a big thank you to <a href="https://habr.com/users/hanna_hlushakova/" class="user_link">Hanna_Hlushakova</a> for working together, bringing the project to the end and helping in the preparation of the article.  Basically you will find descriptions of the problem and the algorithm for its solution, which we used, there are no examples of code, data structures or other necessary things.  I don‚Äôt know if my experience will help you in avoiding rakes, but I hope you‚Äôll get something useful.  Perhaps this article will be absolutely irretrievable loss of precious time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/lb/p2/s5/lbp2s5dnlsusssfxqfd3zf9aoyk.png"><br><a name="habracut"></a><br><h3>  about the project </h3><br>  The project is one of the leaders in the Gartner square, has a client-company with more than 300 thousand employees in the US and Europe, and several billion files to maintain. <br><br>  The project uses the following technologies: Microsoft, C # .net servers, MS SQL database, 14 active servers + 14 in data mirroring mode. <br><br>  The volume of databases is up to 4 TB, the constant load in the business hours is about 400 thousand requests per minute. <br><br>  The database has a lot of business logic: <br>  450 tables <br>  1000 stored procedures <br>  80,000 lines of SQL code <br>  Documentation traditionally either did not have time to write, or it is not relevant. <br><br><h3>  About the task </h3><br>  The task is to redo the deletion of files from storage that have already been deleted by clients, and the period of storage of deleted files has ended, in case they want to restore them.  In the current version, as calculated by the company itself, files that were deleted 1 year ago were stored on servers, although under the terms of the business they should have been stored for only 1 month.  Since some of the files are stored on S3, the company paid for the extra data, and customers who used the On-Premises storage wondered why the files take up more space than they should. <br><br>  Databases shardirovanny on the company of the client. <br><br><h3>  How did the deletion work earlier? </h3><br><br><img src="https://habrastorage.org/webt/wy/zx/dq/wyzxdqqakclb2u1kjmtbzl3v39y.png"><br><br>  On the global server with information about all files in the system, ranges of 15 thousand file identifiers were formed. <br><br>  Then, according to the schedule, servers were polled based on a range of file identifiers. <br>  On each shard the boundaries of the range were transferred. <br><br>  Shard responded by sending the found files from the range. <br><br>  The main server added the missing files to the queue table for deletion in its database. <br>  Then, from the queue table, the service of physically deleting files from the storage received a packet of identifiers for deletion, after which it sent a confirmation that it was going to delete the files and a check was started on all shards - are these files used there? <br>  With the increase in the number of files, this approach began to work very slowly, as there were several billion files, and the number of ranges increased significantly.  There were still less than 5% of deleted files compared to the total, so it‚Äôs very inefficient to go through billions of files to find several million deleted ones. <br><br>  For example, usually after a user deletes a file, it should be stored for 1 month, in case it needs to be restored.  After this period, the file must be deleted by the program from the repository.  With the current number of files, the number of ranges and the speed of bypassing the ranges, the server would take 1 year to completely bypass all the ranges. <br>  It is clear that the place was not cleared, and this caused discontent among users, since there were many times more files on their servers than they should have been reporting.  For an additional place on S3 paid by the company that provides the service, which was for her a direct loss. <br><br>  Only on S3 at the time of the start of work 2 Petabytes of deleted files were stored, and this is only on the cloud.  In addition, there were clients whose files were stored on their dedicated servers, which had the same problem: the place on the server was taken by files deleted by users but not deleted from the server. <br><br><h3>  What decided to do? </h3><br>  We decided to track the deletion events: <br><br><ul><li>  the client deleted the file and then expired. </li><li>  user deleted the file immediately without the possibility of recovery. </li></ul><br>  When deleting a file from the shard base, they decided to use an optimistic approach and remove one of the usage checks.  We knew that 99% of files are used only within one shard.  We decided to immediately add the file to the queue for deletion, and not to check on the rest of the shards to use this file, since the check will be done again when the removal service confirms that it was deleted from the storage. <br><br>  In addition, they left the current JOB, which checked the deleted files by ranges, to add files that were deleted before the release of the new version. <br><br>  Everything that has been deleted on the shard is collected into a table and then transferred to one server, with information about all the files. <br><br>  On this server is sent to the table-queue for deletion. <br><br>  In the table for deletion, before deletion, it is checked that the file is not used on all shards.  This part of the check was here before the code was changed, and they decided not to touch it. <br><br><h4>  What should have been changed in the code? </h4><br>  On each of the shards added a table in which you want to record the identifier of the deleted file. <br><br>  Found all the procedures for deleting files from the database, they turned out to be only 2. After the user deletes the file, the file remains in the database for some time. <br><br>  In the procedure for removing a file from the database, an entry was added to this local table with the deleted files. <br><br>  On the global file server, they made a JOB, which downloads a list of files from the shardy bases.  Just calling the procedure from the shard base, it does a DELETE inside and lists the files in OUTPUT.  In MS SQL Server pull - pulling from a remote server is done significantly faster than pasting to a remote server.  All this is done in blocks. <br>  These files are then added to the drop queue table on the global server. <br>  In the queue table, we added a field with the shard identifier to know where the deletion event came from. <br><br><h3>  How was this all tested? </h3><br>  There are 3 environments: <br><br>  Dev is a development environment.  The code is taken from the develop branch of the gita.  It is possible to cover a different version of the code on IIS and make several versions of orchestration.  Connects to the dev environment from the client inside the vpn.  Until recently, the inconvenience was only with the bases, since all changes to the base can break the work of other parts of the system.  Then the bases were local.  On a dev server with databases, you can pour the already working code, so as not to destroy all the work.  On a dev environment, there are 3 shards, instead of 12, which are on sale, but this is usually enough to test the interaction. <br><br>  Staging - the environment is the same as the product version (almost the same, as it is rare, but there are changes right on the product by the administrators).  A copy of the code from the master branch.  In the database, sometimes they caught some differences with the code on the prode, but in general they are identical.  On Staging there are also 3 shards as in maiden.  There is also no load on staging as well as on dev.  Here you can run integration tests already clean, since the code coincides with the prod.  All tests must pass, this is a prerequisite before going on the patch. <br><br>  Perf lab, where tests are done under load.  The load is created using jmeter, 10 times less than on the prode, and there is only one shard, which sometimes creates inconvenience.  Data is taken from the sale, then anonymized and used on the perf lab.  All servers are the same configuration as in the sale. <br><br>  The load is 10 times smaller, because it is assumed that this is an approximate load that comes on the sale of 1 shard.  The disadvantage is that the global base is very underused, in contrast to the sale.  And, if the changes mainly concern the global database with files, then the test results can only be relied on approximately - this may not work so well on the sale.  Although perf lab does not ideally match the load with the prod, having the opportunity to test under load already helps to catch a lot of errors before deploying to the prod. <br><br>  There is also a backup server, where you can view the data from the sale, to catch some cases.  In general, the company operates under a license that prohibits developers from giving access to prod data, and the administration and support team (Operations) has access to the development, so you need to ask for help from DBAs.  Data from the sale is very easy to test, because some cases arise only on prod data and it is very useful to study the data in a real system to understand how the system works for the user. <br><br>  During tests on perf lab, it turned out that the load on deleting files from the repository is not realized from the word at all.  When implementing load testing, we chose more popular requests from client software, and part of the storage clearing was not included.  Since this is a base, it turned out to conduct a simplified test for all modified objects with a call to the modified procedures on different data manually.  (on those options that I knew about). <br>  In addition, both in integration and performance tests, the main emphasis was placed on the most popular type of file storage. <br><br>  An additional feature of Perf Labs, which was not immediately found out, is the discrepancy between the amount of data in some tables on the sale and perfo.  In the sense that all JOBs from the sales function on the tip, which form the data, but there is not always something that processes the data generated in the table.  And, for example, the aforementioned table ‚Äî the queue for deletion on a feather ‚Äî is much larger than on a sale - 20 million records on a feather and 200 thousand on sale. <br><br><h4>  Deploy process </h4><br>  Deploy process is pretty standard.  There were no changes in the application code for this task, all changes are only in the database.  Changes are always rolled onto the database by DBA, this process is not automated.  Two versions of scripts are prepared - for applying changes and for rolling back changes, and instructions are written for DBA.  2 versions of scripts are always made, and they are surely tested for rollback and rollback of changes.  And the same scripts are used to apply changes to staging and perf lab before running integration and load testing. <br><br><h3>  What happened after deploy? </h3><br>  During the first 5 hours after deployment, 1 million events arrived, indicating that the client software received an error when trying to download a file.  Event ‚Äúfile corrupted‚Äù.  It means that the file is trying to download the client, but the file was not found in the repository.  Usually these events are either not at all, or they are measured by 1 - 2 thousand per day. <br><br>  I‚Äôll say right away that it took at least 1 week to find the cause of the file from a team of 3 and sometimes 5 people (including me). <br><br>  We collected the entire list of files for which the event ‚ÄúFile Corrupted‚Äù came. <br><br>  Despite the fact that there were over 1 million events and they were all from different users, different companies, there were only 250 unique files on this list. <br><br>  DBA on the backup server was raised to investigate the backup databases at the time when the event arrived.  In the bases of the project there are quite a few tables with all sorts of logs that helped in the analysis.  Even when deleting information from the database, a log is surely added, what was removed and what event.  On the sale of such records are stored for 1 week, then merge to the archive server. <br><br>  And so are the tables with logs, which are very helpful in analyzing what happened: <br>  The full log with events at the client, is conducted on each shard <br><br>  On the global server: <br><br><ul><li>  Log requests for downloading all files by users </li><li>  Log download files to the system from users </li><li>  File log with event FileCorrupt </li><li>  Log files for cancel removal from storage </li><li>  Log of deleted files from the database </li></ul><br>  In addition, ELK with the application logs was available. <br><br>  The error was repeated on the dev environment, which confirmed the correctness of the assumption.  At first, nobody took this hypothesis seriously, since it was very difficult to believe that so many factors coincided at the same time and so many users arrived at this particular moment in time. <br><br><h3>  What went wrong? </h3><br>  It turned out that the system had about 250 (for comparison in the system billions of files) super duper mega popular files.  250, yes! <br><br>  These files were still very old.  At the time these files were uploaded to the system, another system used to generate the key of the file on the repository was used. <br><br>  It turned out that for this type of key, the method of physical deletion from physical storage behaves differently from other files. <br><br>  In the class with deletion there is a block of code with the condition specifically for files with the old key.  The system, at the time of deletion, before it is checked that the file is absent on shards, moves this old file to another location.  Well, that did not work. <br><br>  And it turned out that at the moment when the file is moved (and I‚Äôll remind you it is very popular), if some user tries to give him rights to the new user, the client software goes to the storage behind this file, but there is no file in the right place.  Since it is moved so that it does not work out.  And the client software sends a message that the file is broken.  In the database, it is marked as broken.  And all the information is removed from the database (well, almost all). <br><br>  In the meantime, our shard check procedure finds out that the file is in use.  And sends the answer that you need to return it.  But all the info has already been removed from the database, and it is impossible to return it. <br><br>  Funny, yes? <br><br>  That is, when deleting a file, the user got exactly at the time when the file was moved, the shards were checked, and it was at this point in time that the user sent a download request. <br><br>  Here it is - highload in action, when the most incredible coincidence you have the same. <br><br><img src="https://habrastorage.org/webt/_y/m6/me/_ym6meu2s43ds32d1ngjzspn67k.png"><br><br>  Having recovered from the surprise and rolling it all back, we made sure that the files of the users are alive, since they were restored from the disks of other clients. <br><br>  Naturally, everything was good on the tests, because during the test newer files were deleted with a new type of key that was used for the last 5 years. Such files are not transferred to another storage location during the deletion. <br><br>  Our optimism diminished, and we decided not to go the most optimistic way. <br><br><h3>  Retrospective </h3><br>  We decided that we need to add tests to different types of repositories. <br>  Add load to perf lab that uses calls when removed from storage <br>  Close known race conditions <br>  Add monitoring (although it would be in the plans, but did not fit into the initial scope) <br><br><h3>  About monitoring </h3><br>  They immediately decided to do the monitoring, but then he faded into the background, as it was necessary to quickly deploy. <br><br>  For monitoring, Zabbix, ELK, Grafana, NewRelic, SQL Sentry and the test version of AppDynamics were used in the project. <br><br>  From this, the pef lab was NewRelic and SQL Sentry. <br><br>  We have already measured all system metrics, and so, we wanted to measure the business metrics.  I had experience in organizing such monitoring through Zabbix - they decided to do the same. <br><br>  The scheme is very simple in the database to make a table into which, by JOB, to collect the necessary metrics and a procedure that will upload the collected metrics to Zabbix. <br><br>  Metrics: <br><br><ul><li>  The number of files in the queue for deletion on a global basis </li><li>  Number of files in queue by server </li><li>  Number of files sent to the removal program from the repository </li><li>  Number of deleted files </li><li>  Number of events FileCorrupt </li><li>  The number of files to delete on each shard </li></ul><br>  Monitoring was implemented and secured for the sale separately, before they began to deploy a new implementation of the deletion. <br><br><h3>  New solution </h3><br>  In general, we decided that it was better to overeat than not sleep enough, and made a new plan. <br><br><ol><li>  check on the same shard that the file is definitely not used by anyone else, and transfer only unused files to the server; </li><li>  when transferring to the server, collect all files in a table and check that files are not used on shards before being placed in a queue table for deletion; </li><li>  when using a file and searching it in the system, mark the queue for deletion in the table as a file that requires checking; </li><li>  issue for deletion only files for which there was no search; </li><li>  files that were searched, re-check for the presence on shards; </li><li>  In general, remove the check in the procedure that deletes the file, since it must work quickly - and the file being used in principle should not go to it; </li><li>  take into account in the procedure, which deletes everything by bit of a file that it is in the process of deletion, and not delete information on it. </li></ol><br>  Clause 6 with a delay included removal of the check in several stages.  First they left the check, then after a week they turned off checking on the files of the company's employees, after 2 weeks they turned off the check completely. <br><br><h3>  What should be changed in the code? </h3><br>  Again, all changes apply only to the database. <br><br>  The scale of change was the largest on the global server: <br>  Add an intermediate table in which to put all the files downloaded from shards. <br>  Make a JOB that checks the files in the intermediate table so that they are not used on shards. <br><br>  Add the field with the date of the last access to the file to the queue of deleted files in the table and add an index. <br><br>  Find all the procedures with access to the file - it turned out 5 procedures.  Add a block to change the date of last use in the queue table.  The date changed every time, regardless of whether it was filled or not. <br><br>  In the procedure for issuing files to the uninstall program, add it so that it displays only files with an empty usage date. <br><br>  Add a JOB that collects all files with the date of use and checks (with a delay of 10 minutes, which is necessary for the client software to add the file to the shard, in general it is up to 2 minutes, but decided to be safe) using the file on all shards.  After the check is completed, the date of use is reset to zero if the file is not found, otherwise the file is removed from the queue.  If the use date has changed during the verification process, the data does not change as it is assumed that while the test was in progress, the file could be uploaded to the shard, on which the test has already been completed and a new test cycle is required for the file. <br><br>  On shards: <br><br>  In the procedure that deletes files from a table with deleted files, it was necessary to add a check that the file was not used.  The procedure lost its simplicity and beauty is not much - in DELETE with output just added NOT EXISTS. <br><br>  Added JOB, which in the background banged from the table used on the server files. <br><br><h4>  Tests </h4><br>  In the integration tests added scripts to use all options for storage. <br>  We also wrote new cases to test new file deletion functionality. <br><br>  Perf Lab has added load to the global server.  In addition, the load added to the removal of files from the storage. <br><br><h4>  Depla </h4><br>  Scripts were prepared for the application and rollback of changes for the database.  DBA rolled scripts and it turned out that during load testing did not pay attention to the lock on the table-queue to delete files.  As a result, we did not fix the index, which was not the most optimal. <br><br>  Because of this, it was necessary to disable JOB checking by ranges and analyze and add identifiers of deleted files manually, according to files that were deleted in the system before the new code was added. <br><br><h3>  results </h3><br>  As a result, as a result of deployment, new deleted files are deleted from the storage within 24 hours. <br>  Files deleted before the launch of the new system were created on the backup and added to the queue for the prod. <br><br>  As a result, the extra data on S3 in the amount of 2 petabytes has been removed.  The same thing happened with the files on dedicated client servers, and now they have the space occupied on the server coincides with the place displayed in their clients. <br><br>  The curve index on the queue table is still living on the prod, the task of changing the index in the backlog, but slightly postponed due to higher priority tasks. </div><p>Source: <a href="https://habr.com/ru/post/427895/">https://habr.com/ru/post/427895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427879/index.html">How I switched from Python to Julia (and why)</a></li>
<li><a href="../427883/index.html">Understanding Virtualization, Containers, and Kubernetes: 18 Cloud Work Stuff</a></li>
<li><a href="../427889/index.html">Wrong, wrong, WRONG! methods of DDoS mitigation</a></li>
<li><a href="../427891/index.html">Millions of people can be attacked through a vulnerability in the Cisco WebEx conferencing platform.</a></li>
<li><a href="../427893/index.html">Bloody Lola on Omega 2 or stifle a python on Halloween</a></li>
<li><a href="../427899/index.html">JsonWriterSax - a library for creating JSON</a></li>
<li><a href="../427901/index.html">How not to use the Node.js Stream API</a></li>
<li><a href="../427905/index.html">Mining food or "Crossroads" through the eyes of a hacker</a></li>
<li><a href="../427907/index.html">Drone shooting, ‚Äúrakes‚Äù, life hacking, self-development and a photographer / videographer career: a new podcast ‚ÄúGLPH‚Äù</a></li>
<li><a href="../427909/index.html">Python: how to reduce memory consumption by half by adding just one line of code?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>