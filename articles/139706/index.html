<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with large Excel files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is a large file? So what is really big? When I was being, I thought it was a file for 50-60 thousand lines of records. And I would remain in such...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with large Excel files</h1><div class="post__text post__text-html js-mediator-article">  What is a large file?  So what is really big?  When I was being, I thought it was a file for 50-60 thousand lines of records.  And I would remain in such ignorance until now, but I had to carry out one project in which I had to work with files of 600-800 thousand lines.  Going to the hell out - under the cut: <br><br><a name="habracut"></a><br><br><h4>  What first </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And first, my friends, we rushed into the simplest thing you can think of.  Interop.Excell and everything.  It seemed.  Yeah, schaz.  As shown by the test tests, this method of opening led to the fact that in an hour 200 thousand lines of Excel were read, the application actively consumed the RAM, and pushed back the rest of the processes on the machine.  It all ended as expected, but the investigative experiment had to be completed - at 260,000 the application fell into OutOfMemory on a machine with 4 GB.  It became clear that the problem could not be solved in the forehead <br><br><h4>  Google it </h4><br><br>  How many wonderful discoveries to us ... Google brought, oddly enough, in msdn, where I met two methods of opening very large files: DOM and SAX.  I don‚Äôt remember after the prescription of times, but some of them fell off due to OutOfMemory, which was already disgusted at that moment, and the second one was completely unsuitable in terms of access to data.  Why - read below. <br><br><h4>  From what, from what </h4><br><br>  Our exelki are made.  For anyone who decided to dig the format a little deeper, it will not be a secret that, unlike the binary xls, xlsx is essentially a zip archive with data.  It is enough to change the extension with pens and unpack the archive into a folder - and we will get the entire internal structure of the document, which is nothing but a set of xml files and related information.  As it turned out, there is no text data in the root xml.  Instead, we have a set of indexes that refer to an auxiliary file that contains key / value pairs. One of the above methods to open that file is possible, but you need to dig into the accompanying files and pull text values ‚Äã‚Äãfrom them.  Darkness. <br><br><h4>  And the darkness receded </h4><br><br>  After long ordeals and wailing, the following was born: <br><br>  Our favorite usings that some individuals forget to include: <br> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Data; <br> <font color="#0000ff">using</font> System.Data.OleDb; <br> <font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.Linq; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Packaging; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Spreadsheet;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> <blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Data; <br> <font color="#0000ff">using</font> System.Data.OleDb; <br> <font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.Linq; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Packaging; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Spreadsheet;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> </blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Data; <br> <font color="#0000ff">using</font> System.Data.OleDb; <br> <font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.Linq; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Packaging; <br> <font color="#0000ff">using</font> DocumentFormat.OpenXml.Spreadsheet;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br></code> <br><br>  Actually, the code itself: <br> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> MessageHave( <font color="#0000ff">string</font> message); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _DataLoaded( <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt; data); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _NewProcent( <font color="#0000ff">int</font> col); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _DataLoaded DataLoaded; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _NewProcent NewProcent; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> MessageHave MessageHave_Event; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> ReadData( <font color="#0000ff">object</font> data) <br> { <br> <font color="#008000">//     " "-"  "</font> <br> <font color="#0000ff">var</font> keyValuePair = (KeyValuePair&lt; <font color="#0000ff">string</font> , <font color="#0000ff">string</font> &gt;)data; <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> cnn = <font color="#0000ff">new</font> OleDbConnection( <font color="#A31515">@"Provider=Microsoft.ACE.OLEDB.12.0;Data Source="</font> + <br> keyValuePair.Key + <font color="#A31515">@";Extended Properties="</font> <font color="#A31515">"Excel 12.0;HDR=No;IMEX=1"</font> <font color="#A31515">""</font> ) <br> ) <br> { <br> <font color="#0000ff">int</font> calc = 1000; <br> MessageHave_Event( <font color="#A31515">"  "</font> ); <br> cnn.Open(); <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">var</font> cmd = <font color="#0000ff">new</font> OleDbCommand( <font color="#2B91AF">String</font> .Format( <font color="#A31515">"select * from [{0}]"</font> , keyValuePair.Value), cnn); <br> <font color="#0000ff">using</font> (OleDbDataReader dr = cmd.ExecuteReader()) <br> { <br> <font color="#0000ff">var</font> lines = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt;(); <br> <font color="#0000ff">int</font> id = 0; <br> <font color="#0000ff">if</font> (dr != <font color="#0000ff">null</font> ) <br> <font color="#0000ff">while</font> (dr.Read()) <br> { <br> <font color="#0000ff">string</font> text = <font color="#A31515">""</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; dr.FieldCount; ++i) <br> { <br> <font color="#0000ff">if</font> (dr[i] != <font color="#0000ff">null</font> ) <br> text += dr[i] + <font color="#A31515">"^"</font> ; <font color="#008000">//   </font> <br> <font color="#0000ff">else</font> <br> text += <font color="#A31515">"^"</font> ; <br> } <br> lines.Add(text); <br> <br> id++; <br> <font color="#0000ff">if</font> (id == calc) <br> { <br> NewProcent(id); <br> calc += 1000; <br> } <br> } <br> DataLoaded(lines); <br> } <br> cnn.Close(); <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> MessageHave_Event( <font color="#A31515">"Exception: "</font> + ex.Message); <br> cnn.Close(); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> <blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> MessageHave( <font color="#0000ff">string</font> message); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _DataLoaded( <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt; data); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _NewProcent( <font color="#0000ff">int</font> col); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _DataLoaded DataLoaded; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _NewProcent NewProcent; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> MessageHave MessageHave_Event; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> ReadData( <font color="#0000ff">object</font> data) <br> { <br> <font color="#008000">//     " "-"  "</font> <br> <font color="#0000ff">var</font> keyValuePair = (KeyValuePair&lt; <font color="#0000ff">string</font> , <font color="#0000ff">string</font> &gt;)data; <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> cnn = <font color="#0000ff">new</font> OleDbConnection( <font color="#A31515">@"Provider=Microsoft.ACE.OLEDB.12.0;Data Source="</font> + <br> keyValuePair.Key + <font color="#A31515">@";Extended Properties="</font> <font color="#A31515">"Excel 12.0;HDR=No;IMEX=1"</font> <font color="#A31515">""</font> ) <br> ) <br> { <br> <font color="#0000ff">int</font> calc = 1000; <br> MessageHave_Event( <font color="#A31515">"  "</font> ); <br> cnn.Open(); <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">var</font> cmd = <font color="#0000ff">new</font> OleDbCommand( <font color="#2B91AF">String</font> .Format( <font color="#A31515">"select * from [{0}]"</font> , keyValuePair.Value), cnn); <br> <font color="#0000ff">using</font> (OleDbDataReader dr = cmd.ExecuteReader()) <br> { <br> <font color="#0000ff">var</font> lines = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt;(); <br> <font color="#0000ff">int</font> id = 0; <br> <font color="#0000ff">if</font> (dr != <font color="#0000ff">null</font> ) <br> <font color="#0000ff">while</font> (dr.Read()) <br> { <br> <font color="#0000ff">string</font> text = <font color="#A31515">""</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; dr.FieldCount; ++i) <br> { <br> <font color="#0000ff">if</font> (dr[i] != <font color="#0000ff">null</font> ) <br> text += dr[i] + <font color="#A31515">"^"</font> ; <font color="#008000">//   </font> <br> <font color="#0000ff">else</font> <br> text += <font color="#A31515">"^"</font> ; <br> } <br> lines.Add(text); <br> <br> id++; <br> <font color="#0000ff">if</font> (id == calc) <br> { <br> NewProcent(id); <br> calc += 1000; <br> } <br> } <br> DataLoaded(lines); <br> } <br> cnn.Close(); <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> MessageHave_Event( <font color="#A31515">"Exception: "</font> + ex.Message); <br> cnn.Close(); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> </blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> MessageHave( <font color="#0000ff">string</font> message); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _DataLoaded( <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt; data); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> _NewProcent( <font color="#0000ff">int</font> col); <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _DataLoaded DataLoaded; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> _NewProcent NewProcent; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> MessageHave MessageHave_Event; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> ReadData( <font color="#0000ff">object</font> data) <br> { <br> <font color="#008000">//     " "-"  "</font> <br> <font color="#0000ff">var</font> keyValuePair = (KeyValuePair&lt; <font color="#0000ff">string</font> , <font color="#0000ff">string</font> &gt;)data; <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> cnn = <font color="#0000ff">new</font> OleDbConnection( <font color="#A31515">@"Provider=Microsoft.ACE.OLEDB.12.0;Data Source="</font> + <br> keyValuePair.Key + <font color="#A31515">@";Extended Properties="</font> <font color="#A31515">"Excel 12.0;HDR=No;IMEX=1"</font> <font color="#A31515">""</font> ) <br> ) <br> { <br> <font color="#0000ff">int</font> calc = 1000; <br> MessageHave_Event( <font color="#A31515">"  "</font> ); <br> cnn.Open(); <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">var</font> cmd = <font color="#0000ff">new</font> OleDbCommand( <font color="#2B91AF">String</font> .Format( <font color="#A31515">"select * from [{0}]"</font> , keyValuePair.Value), cnn); <br> <font color="#0000ff">using</font> (OleDbDataReader dr = cmd.ExecuteReader()) <br> { <br> <font color="#0000ff">var</font> lines = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">string</font> &gt;(); <br> <font color="#0000ff">int</font> id = 0; <br> <font color="#0000ff">if</font> (dr != <font color="#0000ff">null</font> ) <br> <font color="#0000ff">while</font> (dr.Read()) <br> { <br> <font color="#0000ff">string</font> text = <font color="#A31515">""</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; dr.FieldCount; ++i) <br> { <br> <font color="#0000ff">if</font> (dr[i] != <font color="#0000ff">null</font> ) <br> text += dr[i] + <font color="#A31515">"^"</font> ; <font color="#008000">//   </font> <br> <font color="#0000ff">else</font> <br> text += <font color="#A31515">"^"</font> ; <br> } <br> lines.Add(text); <br> <br> id++; <br> <font color="#0000ff">if</font> (id == calc) <br> { <br> NewProcent(id); <br> calc += 1000; <br> } <br> } <br> DataLoaded(lines); <br> } <br> cnn.Close(); <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> MessageHave_Event( <font color="#A31515">"Exception: "</font> + ex.Message); <br> cnn.Close(); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br></code> <br><br>  The code showed a performance of about 15-20 minutes on files of 600-800 thousand records. <br><br>  If someone finds the implementation curve - do not kick much :) I will listen to all comments <br><br></div><p>Source: <a href="https://habr.com/ru/post/139706/">https://habr.com/ru/post/139706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139700/index.html">Unreal engine 3 is ported to flash</a></li>
<li><a href="../139702/index.html">Mozilla is working on Firefox for Windows 8 Metro</a></li>
<li><a href="../139703/index.html">Google may launch a tablet with ASUS</a></li>
<li><a href="../139704/index.html">Comparative test of programs that prevent attacks on ARP-table</a></li>
<li><a href="../139705/index.html">X server for Android</a></li>
<li><a href="../139707/index.html">Twitter has turned on SPDY support</a></li>
<li><a href="../139708/index.html">Sync vs Async on the example of Firebird</a></li>
<li><a href="../139710/index.html">Google Thumbnail: Getting Thumbnails of Websites</a></li>
<li><a href="../139711/index.html">Right to be forgotten</a></li>
<li><a href="../139713/index.html">How to search for programmers in the regions? We found an effective way. Sharing ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>