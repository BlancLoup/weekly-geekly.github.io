<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Headache from RecyclerView.Adapter - there is a way out</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Today on our blog is Max Tuev, Surf Architect, one of our certified studios. The guys are engaged in custom development, so the timing is no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Headache from RecyclerView.Adapter - there is a way out</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  Today on our blog is Max Tuev, <a href="http://surfstudio.ru/">Surf</a> Architect, one of our certified studios.  The guys are engaged in custom development, so the timing is no less important than the quality of the code.  Approaches and technologies that slow down development are not suitable here.  A good example of this is the RecyclerView.Adapter.  Under the cut, Max will tell you how to save time and nerves.  The word max. <br><br><img src="https://habrastorage.org/webt/ww/e2/wx/wwe2wxlu0sjed-3aakcmpu5_ru0.jpeg"><br><a name="habracut"></a><br>  With simple lists RecyclerView.Adapter copes with a bang.  But the attempt to implement an adapter for complex cases with several types of cells sometimes leads to the birth of monsters, which the developers try to forget as soon as possible and not touch them anymore.  But it happens that the new update brings a couple of cells to this barely living adapter.  If this sounds familiar - welcome under cat.  I'll tell you how we solved these problems in the studio.  In particular, I will show you how to learn how to manage a list using only 10 lines of code.  An example is on the gif below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/gl/4k/eigl4kgncxyd1xai3gubojxqsk4.gif" width="400"></div><br>  Where do monster legs grow from?  The main problems are 2 features of the adapter: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Item position control (getItemViewType, onBindViewHolder, ...) </li><li>  Determining which items to call notifyItem methods ... </li></ol><br><h3>  Let's start with the second paragraph </h3><br>  This problem can be solved using notifyDataSetChanged ().  But then it will not be possible to use ItemAnimator, which was unacceptable for us. <br><br>  DiffUtil, which recently appeared in the Support Library, helped solve this.  This class allows you to determine what has changed in the list and notify the adapter about changes.  For this you need to transfer to it the old and new lists.  Here is a good <a href="https://medium.com/%40iammert/using-diffutil-in-android-recyclerview-bdca8e4fbb00">example</a> . <br><br>  The problem with notify, it would seem, is solved.  But everything is not so simple.  For example, if we change one field of an object from the list, then DiffUtil will not work.  And this code is very common.  If you look closely, you will notice that for work he does not need the entire object as a whole.  All that is needed is the element id for the <code>areItemsTheSame()</code> method and the hash from the element data for the <code>areContentTheSame()</code> method.  This feature was used for our solution. <br><br>  From each data block of each cell id and hash are extracted with each change.  Then, the resulting list of these ‚Äúdried‚Äù objects is compared with DiffUtil with the same list collected from the previous adapter data.  From the outside it looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(items: List&lt;Foo&gt;)</span></span></span><span class="hljs-function"> </span></span>{ adapter.setData(items) }</code> </pre> <br>  When data is transferred to the adapter, it automatically calls the notify methods for parts of the list that have changed.  In addition, the animations are saved whenever you change the list, be it adding a new item, deleting an item, or moving an item.  There is nothing more to add here, the example clearly shows everything.  And we will return to the shortcomings of the approach at the end of the article. <br><br><h3>  Item Position Management </h3><br>  The most difficult to implement and especially support the adapter with multiple cells is the methods <code>getItemCount()</code> , <code>getItemViewType()</code> , <code>onBindViewHolder()</code> , <code>onCreateViewHolder()</code> .  They are interconnected and have very specific logic.  Here's what one of them might look like for a list with an optional footer and header: <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numHeaders = userInfo == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data.size() == <span class="hljs-number"><span class="hljs-number">0</span></span> ? numHeaders : data.size() + numHeaders + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Now imagine that you need to quickly add three more types of cells, and the presence of the third depends on the presence of the first two.  It is necessary to modify and, the most unpleasant, to debug all 4 methods. <br><br>  To greatly simplify the adapter, you can use a list of objects that extend one base class or interface, and take the logic of element layout to a higher level.  But for this, you will need wrapper objects for the data of each cell type.  This is too cumbersome when required, for example, to add one header. <br><br>  We took this approach for our solution, but used universal wrapper objects.  This class looks like this: <br><br><pre> <code class="hljs ruby"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Item</span></span></span><span class="hljs-class">&lt;T, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class">&gt;( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">itemController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseItemController</span></span></span><span class="hljs-class">&lt;T, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> )</span></span></code> </pre> <br>  ItemController here is responsible, roughly speaking, for all interaction with the cell.  To him we will return. <br><br>  In the end, everything turned out a bit more complicated, but the essence remained the same. <br><br>  Responsibility for creating an Item list is transferred to the Activity or Fragment.  Now there is no need to extend the RecyclerView.Adapter, since  A universal EasyAdapter was created to implement this solution.  For clarity, I will immediately give an example of the Activity method that updates the adapter: <br><br><pre> <code class="hljs kotlin"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(screenModel: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MainScreenModel</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> itemList = ItemList.create() .addIf(screenModel.hasHeader(), headerController) .addAll(screenModel.carousels, carouselController) .addIf(!screenModel.isEmpty(), deliveryController) .addIf(screenModel.hasCommercial, commercialController) .addAll(screenModel.elements, elementController) .addIf(screenModel.hasBottomCarousel(), screenModel.bottomCarousel, carouselController) .addIf(screenModel.isEmpty(), emptyStateController) adapter.setItems(itemList) }</code> </pre> <br>  The list in the gif above, by the way, is governed by this method. <br><br>  The ItemList class is needed to make lists more convenient.  A number of its features make it possible to greatly simplify this task and make the code more declarative: <br><br><ol><li>  Chained fill style. </li><li>  No explicit creation of Item objects. </li><li>  Methods for adding cells without data. </li><li>  Methods for adding cells with a predicate. </li><li>  Methods for adding both single cells and a list of cells. </li></ol><br>  When calling <code>adapter.setItems()</code> , the necessary notify methods will be called, as mentioned earlier. <br><br>  There is another important method in ItemList - fun addAll (data: Collection, itemControllerProvider: ItemControllerProvider): ItemList.  It allows you to configure the Adapter from a list of objects that extend one base class or interface.  It is useful if the logic for constructing a list is non-trivial and it makes sense to transfer it to the Presenter. <br><br>  Let's return to ItemController and immediately see an example implementation: <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ElementController</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> onClickListener: (element: Element) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> ) : BindableItemController&lt;Element, ElementController.Holder&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewGroup</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Holder = Holder(parent) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">data</span></span></span></span><span class="hljs-function"><span class="hljs-params">: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Element</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.id.hashCode().toLong() <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Holder</span></span></span></span>(parent: ViewGroup) : BindableViewHolder&lt;Element&gt;(parent, R.layout.element_item_layout) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: Element <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> nameTv: TextView <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coverView: ElementCoverView <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> { itemView.setOnClickListener { onClickListener.invoke(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) } nameTv = itemView.findViewById(R.id.name_tv) coverView = itemView.findViewById(R.id.cover_view) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">data</span></span></span></span><span class="hljs-function"><span class="hljs-params">: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Element</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> nameTv.text = <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.name coverView.render(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.cover) } } }</code> </pre> <br>  The first thing that catches the eye is the complete encapsulation of all interactions with the cell.  This allows you to quickly and safely make changes to the list, and completely reuse all the logic of interaction with the cell on other screens.  Another ItemController is responsible for extracting from the data id and hash, necessary for the correct operation of the automatic call methods notify. <br><br>  This structure simplifies one more thing: <br><br><ol><li>  No need to implement methods onBindViewHolder, getItemHash. </li><li>  No need to forward Listener inside Holder. </li><li>  ItemController for a cell without data will be even easier. </li><li>  No need to think up names for Holder and Listener (if you are still using java). </li><li>  You can use the ItemController template for a quick implementation. </li></ol><br>  This method allows many times to simplify the implementation of lists and unify work with all adapters in the project.  You can implement complex screens, which previously had to do with ScrollView.  This allows you to gain time at the start and reduce the amount of code in the Activity.  In addition, it is easy enough to convert an existing adapter to this style.  We usually do this when we need to slightly change the existing large adapter in the old project. <br><br>  There are, however, several drawbacks.  For example, <code>getChangePayload</code> in DiffUtil.Callback is ignored, and Item and ItemInfo objects are created for each cell when changing the list (which, in principle, can be solved if necessary).  If you are going to use giant lists, measure the performance (you can read about the performance of DiffUtil <a href="https://developer.android.com/reference/android/support/v7/util/DiffUtil.html">here</a> ).  But most of the problems with this approach you will not have. <br><br>  I hope my note to some of you come in handy and will allow you to spend less time and nerves to work with RecyclerView. <br><br>  An example implementation with examples of use <a href="https://github.com/MaksTuev/EasyAdapter">here</a> .  There is also <a href="https://github.com/MaksTuev/EasyAdapter/tree/master/templates">an</a> ItemController <a href="https://github.com/MaksTuev/EasyAdapter/tree/master/templates">template</a> for AndroidStudio and a <a href="https://github.com/MaksTuev/EasyAdapter/tree/master/adapter/src/main/java/ru/surfstudio/easyadapter/recycler/pagination">basic adapter</a> for pagination based on the described approaches. <br><br>  Many thanks to the Surf developers, especially Fedor Atyakshin (@rereverse), for their help in the development. </div><p>Source: <a href="https://habr.com/ru/post/345172/">https://habr.com/ru/post/345172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345160/index.html">Win a trip to the Norwegian office of Vivaldi</a></li>
<li><a href="../345162/index.html">We feed beacon fat herds</a></li>
<li><a href="../345164/index.html">Node.js and JavaScript for server development</a></li>
<li><a href="../345166/index.html">Diagnose and understand the behavior of your application's GPU using GAPID</a></li>
<li><a href="../345168/index.html">How to compromise the workflow system in a few clicks</a></li>
<li><a href="../345174/index.html">How I leaked $ 1000 to the promotion of the game and what came out of it</a></li>
<li><a href="../345176/index.html">DataTalks # 8: User Study</a></li>
<li><a href="../345178/index.html">UIKit performance optimization</a></li>
<li><a href="../345180/index.html">Helping food delivery: logo redesign and corporate identity development</a></li>
<li><a href="../345184/index.html">REST is a new SOAP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>