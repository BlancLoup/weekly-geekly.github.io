<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxmox VE 4 install root partition on unsupported installer soft raid1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with version 3.6, the Proxmox installer has the option to install on various ZFS Raid options, but the configuration used by many with the lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxmox VE 4 install root partition on unsupported installer soft raid1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8cb/d81/f52/8cbd81f52ba5490291e256f48d098f33.png"><br>  Starting with version 3.6, the Proxmox installer has the option to install on various ZFS Raid options, but the configuration used by many with the location of the root and storage area of ‚Äã‚Äãvirtual machine disks on the software raid array did not appear. <br>  On Habr√© and the network there are many similar articles, but they are relevant for version 3.6, and in version 4.0 appeared some interesting nuances.  In addition to this, in this manual I will approach the solution of this problem in a completely different way. <br><a name="habracut"></a><br><br><h4>  Nuances </h4><br>  1.Installer Proxmox 4th version puts us efi bootloader and I do not see a way to backup it using raid software - if someone knows, share it. <br>  2.Proxmox 4.0 compiled on Debian 8, and there is a known bug in it - when starting the system, arrays are not collected if one of the disks crashes in it.  The ‚Äúbootdegraded = 1‚Äù option is not collected at all and does not work. <br>  3. Having considered points 1 and 2, I thought, why should we edit something behind the Proxmox installer, when we can safely install Debian 8 as we need, and then install Proxmox on top.  This alignment will be discussed in the instructions. <br><br><h4>  We put Debian 8 </h4><br>  I think installing Debian 8 minimal with the neinst disk you can handle. <br>  We do all the settings as you need, we consider only the disk layout: <br>  - I have disks with a partition table in GPT <br>  - select section 1 MB and mark it as bios boot <br>  - select the remaining space in the section under the array <br>  - we collect md0 array <br>  - let LVM be over the array <br>  - create LV under the root and swap 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Checking the bug - pulling out any of the disks, members of the array, and boot.  Rather, we do not boot, because the bootloader cannot find the LVM with the root partition, because the array on which this very LVM is not built is not built. <br><br>  <b>UPD in Debian 8.5, the bug has already been repaired and there is no need to patch the patch (or rather, it could have been fixed before, but it was checked for 8.5)</b> <br><br><h4>  We fix the assembly of the array when loading </h4><br>  I put grub on both sections during installation, if you did not: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dpkg-reconfigure grub-pc</span></span></code> </pre> <br><br>  Patch patch: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/initramfs-tools/scripts/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-top cp /usr/share/initramfs-tools/scripts/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-top/mdadm . patch --verbose --ignore-whitespace &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EndOfPatch'</span></span> --- mdadm +++ mdadm @@ -76,7 +76,15 @@ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">$MDADM</span></span> --assemble --scan --run --auto=yes<span class="hljs-variable"><span class="hljs-variable">${extra_args:+ $extra_args}</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> verbose &amp;&amp; log_success_msg <span class="hljs-string"><span class="hljs-string">"assembled all arrays."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> - log_failure_msg <span class="hljs-string"><span class="hljs-string">"failed to assemble all arrays."</span></span> + log_warning_msg <span class="hljs-string"><span class="hljs-string">"failed to assemble all arrays...attempting individual starts"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dev <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(cat /proc/mdstat | grep md | cut -d <span class="hljs-string"><span class="hljs-string">' '</span></span> -f 1); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> + log_begin_msg <span class="hljs-string"><span class="hljs-string">"attempting mdadm --run </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$dev</span></span></span><span class="hljs-string">"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">$MDADM</span></span> --run <span class="hljs-variable"><span class="hljs-variable">$dev</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> + verbose &amp;&amp; log_success_msg <span class="hljs-string"><span class="hljs-string">"started </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$dev</span></span></span><span class="hljs-string">"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> + log_failure_msg <span class="hljs-string"><span class="hljs-string">"failed to start </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$dev</span></span></span><span class="hljs-string">"</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> verbose &amp;&amp; log_end_msg EndOfPatch</code> </pre><br>  We update a config: <br><pre> <code class="bash hljs">update-initramfs -u</code> </pre><br><br>  Attention: if you check how the patch works and boot up with the disc pulled out, then forget to return it back to the array: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mdadm --add /dev/md0 /dev/sda2</span></span></code> </pre><br><br><h4>  We put Proxmox </h4><br>  We bring / etc / hosts to the form: <br><pre> <code class="bash hljs">127.0.0.1 localhost.localdomain localhost 123.456.789.1 myproxmox.mydomain.ru myproxmox pvelocalhost</code> </pre><br><br>  Add to /etc/apt/sources.list <br><pre> <code class="bash hljs">deb http://download.proxmox.com/debian jessie pve-no-subscription</code> </pre><br><br>  Add a digital signature: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># wget -O- "http://download.proxmox.com/debian/key.asc" | apt-key add -</span></span></code> </pre><br><br>  Updating: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get update &amp;&amp; apt-get dist-upgrade</span></span></code> </pre><br><br>  Install Proxmox: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install proxmox-ve ntp ssh postfix ksm-control-daemon open-iscsi</span></span></code> </pre><br><br>  When installing in /etc/apt/sources.list.d/pve-enterprise.list, a commercial repository will be added; if there is no subscription, we will comment it out. <br><br>  Reboot and use. </div><p>Source: <a href="https://habr.com/ru/post/273391/">https://habr.com/ru/post/273391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273381/index.html">Vertical headers: who is right?</a></li>
<li><a href="../273383/index.html">Malicious software Nemucod specializes in distributing the ransomware Teslacrypt</a></li>
<li><a href="../273385/index.html">Yandex.Browser for mobile subscription transparency</a></li>
<li><a href="../273387/index.html">Audience comparison of Habrahabr, Hiktaims and Megamind</a></li>
<li><a href="../273389/index.html">Critical vulnerability in the Grub2 loader allows to bypass password protection</a></li>
<li><a href="../273393/index.html">The simplest cellular automata and their practical application</a></li>
<li><a href="../273395/index.html">Jedi Escape: May the gyroscope arrive with you</a></li>
<li><a href="../273397/index.html">Let the scrolling be with you: theory and practice on the camera in the platform [2/2]</a></li>
<li><a href="../273401/index.html">Python-> Cython-> C ++, and COM to boot: writing a framework for autotests</a></li>
<li><a href="../273403/index.html">Some CSS CSS Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>