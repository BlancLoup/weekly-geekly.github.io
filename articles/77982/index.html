<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JPA: Storing transfers in a database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely, many of you have encountered the problem of storing transfers in a database, which occurs when you try to implement a convenient way of workin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JPA: Storing transfers in a database</h1><div class="post__text post__text-html js-mediator-article"> Surely, many of you have encountered the problem of storing transfers in a database, which occurs when you try to implement a convenient way of working with all sorts of official reference books - statuses, object types, and so on. <br><br>  Its essence is very simple: if you store enumerations as entities ( <code>@Entity</code> ), then it turns out to be extremely inconvenient to work with them, the database is loaded with unnecessary queries even despite caching, and the queries to the database are complicated by unnecessary JOINs.  If the enumeration is defined as enum, then it becomes convenient to work with them, but there is a problem of synchronization with the database and tracking errors of such synchronization. <br><br>  This is especially true when the field containing the enumeration is annotated as <code>@Enumerated(EnumType.ORDINAL)</code> - everything breaks instantly when the order of the declaration of values ‚Äã‚Äãchanges.  If we store the values ‚Äã‚Äãin string form - like <code>@Enumerated(EnumType.STRING)</code> - the problem of access speed arises, since the indices for string fields are less efficient and take up more space.  Moreover, regardless of the method of storing the field value in the absence of a table with a list of acceptable values ‚Äã‚Äãin the database, we are in no way protected from incorrect or outdated data and, as a result, problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, the very idea of ‚Äã‚Äãstoring in the database is tempting because of the simplicity of building queries manually, which is very valuable when debugging software or solving difficult situations.  When you can write not just <code>SELECT id, title FROM product WHERE status = 5</code> , but, say, <code>SELECT id, title FROM product JOIN status ON status.id = product.status_id WHERE status.code = 'NEW'</code> is very valuable.  Including the fact that we can always be sure that <code>status_id</code> contains the correct value if we set <code>FOREIGN KEY</code> . <br><br>  In fact, there is a very simple and elegant solution to this problem that kills all birds with one stone. <br><a name="habracut"></a><br><br>  This solution is based on a simple hack, which, although a hack, does not introduce any side effects.  As you know, enumerations in Java are just syntactic sugar, internally represented by the same instances of classes generated from <code>java.lang.Enum</code> .  And just in the latter there is a wonderful <code>ordinal</code> field, declared as <code>private</code> , which stores the value returned by the <code>ordinal()</code> method and used by the <abbr>ORM</abbr> for placement into the database. <br><br>  We just need to read from the directory in the database the current identifier of the enumeration element and place it in this field.  Then we will be able to use <code>EnumType.ORDINAL</code> in a regular way for storing in the database with fast and convenient access, thus preserving all the delights of the Enums themselves in Java, and not have problems with identifier synchronization and their relevance. <br><br>  It may seem that such an approach gives rise to problems with the serialization of objects, but this is not so, because the <a href="http://java.sun.com/javase/6/docs/platform/serialization/spec/serial-arch.html">specification of the Java platform</a> literally tells us the following: <br><br><blockquote>  1.12.  Serialization of Enum Constants <br>  Enum constants are serialized differently than ordinary serializable or externalizable objects.  The serialized form of an enum constant consists solely of its name;  field values ‚Äã‚Äãare not present in the form. </blockquote><br><br>  That is, when serializing enums, they are always converted to string form, and the numeric value is ignored.  Voila! <br><br>  And now a little practice.  First, let's define the data model for our example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> status_id; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> product_id; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> status_id, code <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> status_pk PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> status_unq1 <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (code) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> (code) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'NEW'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> (code) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'ACTIVE'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> (code) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'DELETED'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> product ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> product_id, status_id <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, title <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span> (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> product_pk PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> product_unq1 <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (title), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> product_fk1 <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (status_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> RESTRICT ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> product_fki1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> product (status_id);</code> </pre><br><br>  Now we describe the same data scheme in Java.  Note that in this case both the enumeration and the entity class for the reference are defined.  To avoid repetition of uniform code, references for enumerations are inherited from <code>SystemDictionary</code> .  Also note the <code>@MappedEnum</code> annotation, which we will use later on to determine which enums are reflected in the database. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Status { NEW, ACTIVE, DELETED } <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(value = RetentionPolicy.RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> MappedEnum { Class&lt;? extends Enum&gt; enumClass(); } <span class="hljs-meta"><span class="hljs-meta">@MappedSuperclass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemDictionary</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(generator = <span class="hljs-string"><span class="hljs-string">"entityIdGenerator"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"id"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"code"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, length = <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String code; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Integer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> code; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String code)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.code = code; } } <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"status"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@SequenceGenerator</span></span>(name = <span class="hljs-string"><span class="hljs-string">"entityIdGenerator"</span></span>, sequenceName = <span class="hljs-string"><span class="hljs-string">"status_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@MappedEnum</span></span>(enumClass = Status.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatusEx</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemDictionary</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@SequenceGenerator</span></span>(name = <span class="hljs-string"><span class="hljs-string">"entityIdGenerator"</span></span>, sequenceName = <span class="hljs-string"><span class="hljs-string">"product_id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Product</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>(generator = <span class="hljs-string"><span class="hljs-string">"entityIdGenerator"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"id"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"status_id"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Enumerated</span></span>(EnumType.ORDINAL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Status status; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"title"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, unique = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String title; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Integer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Status status)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = status; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> title; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String title)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.title = title; } }</code> </pre><br><br>  Now we just need to read the values ‚Äã‚Äãfrom the database and write them to the <code>ordinal</code> field, and also remember to update the <code>values</code> array so that we can get the enumeration instances by index from <code>getEnumConstants()</code> - this is not only used by the same Hibernate when working with transfers, but simply in places is very convenient.  This can be done immediately after initializing the connection to the database using something like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Session session)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionAction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Session session)</span></span></span><span class="hljs-function"> </span></span>{ Iterator&lt;PersistentClass&gt; mappingList = configuration.getClassMappings(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (mappingList.hasNext()) { PersistentClass mapping = mappingList.next(); Class&lt;?&gt; clazz = mapping.getMappedClass(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SystemDictionary.class.isAssignableFrom(clazz)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!clazz.isAnnotationPresent(MappedEnum.class)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; MappedEnum mappedEnum = clazz.getAnnotation(MappedEnum.class); updateEnumIdentifiers(session, mappedEnum.enumClass(), (Class&lt;SystemDictionary&gt;) clazz); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateEnumIdentifiers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Session session, Class&lt;? extends Enum&gt; enumClass, Class&lt;? extends SystemDictionary&gt; entityClass)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;SystemDictionary&gt; valueList = (List&lt;SystemDictionary&gt;) session.createCriteria(entityClass).list(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxId = <span class="hljs-number"><span class="hljs-number">0</span></span>; Enum[] constants = enumClass.getEnumConstants(); Iterator&lt;SystemDictionary&gt; valueIterator = valueList.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (valueIterator.hasNext()) { SystemDictionary value = valueIterator.next(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> valueId = value.getId().intValue(); setEnumOrdinal(Enum.valueOf(enumClass, value.getCode()), valueId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueId &gt; maxId) maxId = valueId; } Object valuesArray = Array.newInstance(enumClass, maxId + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Enum value : constants) Array.set(valuesArray, value.ordinal(), value); Field field; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { field = enumClass.getDeclaredField(<span class="hljs-string"><span class="hljs-string">"$VALUES"</span></span>); field.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); Field modifiersField = Field.class.getDeclaredField(<span class="hljs-string"><span class="hljs-string">"modifiers"</span></span>); modifiersField.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL); field.set(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, valuesArray); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Can't update values array: "</span></span>, ex); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setEnumOrdinal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Enum object, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ordinal)</span></span></span><span class="hljs-function"> </span></span>{ Field field; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { field = object.getClass().getSuperclass().getDeclaredField(<span class="hljs-string"><span class="hljs-string">"ordinal"</span></span>); field.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); field.set(object, ordinal); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Can't update enum ordinal: "</span></span> + ex); } } }</code> </pre><br><br>  As you can see, we simply get from Hibernate a complete list of classes reflected on the database, select from them all inherited from the <code>SystemDictionary</code> declared above and, simultaneously, containing the <code>@MappedEnum</code> annotation, and then update the numeric values ‚Äã‚Äãof the enumeration class instances.  Actually, that's all.  Now we can safely: <br><br><ol><li>  Store enums as Java Enum and declare fields containing them as <code>@Enumerated(EnumType.ORDINAL)</code> </li><li>  Automatically control the synchronization of directories in the code and database </li><li>  Do not care about the order of identifiers in the code and their correspondence to the identifiers in the database </li><li>  Perform convenient database queries containing access to enumeration values ‚Äã‚Äãby their string name </li><li>  ... </li><li>  PROFIT! </li></ol><br>  To achieve complete Zen, you can (and should) also add a check that the database does not contain unnecessary values, that is, the reference table and the enum declaration are synchronized in the code. <br><br>  This approach is used by us ( <a href="http://opensourcetech.ru/">Open Source Technologies</a> ) in fairly large systems (from half a million lines of source code and more) with a distributed JMS-based service-oriented architecture and has shown itself very well, both in terms of usability and reliability.  What you want :) </div><p>Source: <a href="https://habr.com/ru/post/77982/">https://habr.com/ru/post/77982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../77973/index.html">Firefox Community Community Coordinator - Asa Dotzler, recommended that users switch to using Bing</a></li>
<li><a href="../77975/index.html">The creators of paid fraudulent erotic social networks seem to have learned a new trick.</a></li>
<li><a href="../77976/index.html">ESET begins testing a new version of ESET NOD32 for Microsoft Exchange Server</a></li>
<li><a href="../77979/index.html">Canobuvosti, 17th edition</a></li>
<li><a href="../77981/index.html">About fraud with copies of passports (on the Internet)</a></li>
<li><a href="../77983/index.html">Triangular coin</a></li>
<li><a href="../77984/index.html">How to increase the rating of free programs in the AppStore</a></li>
<li><a href="../77985/index.html">My planet Earth</a></li>
<li><a href="../77987/index.html">Skype for Symbian is now real!</a></li>
<li><a href="../77989/index.html">Guide to creating websites from Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>