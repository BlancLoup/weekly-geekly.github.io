<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Isolating an application with an IP address from another country‚Äôs VPN using the example of Steam</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Abstract: Isolating applications at the network level using Linux network namespaces. The organization of SSH-tunnels. 

 Traditionally, most of the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Isolating an application with an IP address from another country‚Äôs VPN using the example of Steam</h1><div class="post__text post__text-html js-mediator-article">  Abstract: Isolating applications at the network level using Linux network namespaces.  The organization of SSH-tunnels. <br><br>  Traditionally, most of the article will be devoted to the theory, and boring scripts - at the end of the article.  Steam will be used as a subject for experiments, although the writing applies to any application, including web browsers. <br><br>  Instead of entry.  I'll just show this picture: <br><img src="https://habrastorage.org/getpro/habr/post_images/c71/0e4/147/c710e4147a243fef79f6c7bfcebe3403.png"><br>  147% ... It reminds me of something.  However, habr is not for politics. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The price of games in Steam depends on the region.  Region - from IP'shnika.  There is a desire to have prices in rubles, and not in euros. <br><br>  To do this, we use VPN over SSH using tun-devices, plus network namespaces to isolate the application from all other network devices. <br><br><h1>  Network namespaces </h1><br>  Traditionally, an application that runs even with user rights has full access to the network.  It can use any network address that exists in the system to send packets. <br><br>  Moreover, most desktop applications do not understand anything at all in interfaces, since they assume that the system has only one network interface and does not allow to specify which of the interfaces should be used.  Server software usually has this option (what address to use as the sender's address), but for desktops it is an unaffordable luxury. <br><br>  If we have several interfaces (one of which relates to a VPN), then there are no regular methods to say incentive to use it, and not eth0 / wlan0.  More precisely, we can "wrap" all traffic in a VPN, but this is not always desirable.  At a minimum, latency growth and a decrease in speed (even if VPN leads to a super fast server, an increase in latency, an overhead from the tunnel, and a fixed width of the local channel set TCP into a position where you have to cut the speed).  As a maximum, it‚Äôs one thing to ‚Äúbuy through Russian VPN‚Äù, and another thing is to let all traffic go there.  I am not at all tempted by the use of a VPN <em>to get Roskomnadzor protection against opposition and free-thinking</em> . <br><br>  Under these conditions, there is a great desire to leave one to one specific application and a given network interface.  One.  Configured for the needs of this application only. <br><br>  To solve this problem in Linux, for a long time (already since 2007) there exists a technology called network namespaces, that is, namespace for networks.  The essence of the technology: the similarity of ‚Äúdirectories‚Äù is created above network interfaces, in each directory there can be several network interfaces and applications.  An application that finds itself in a given network namespace can use (and sees) only those network interfaces that are assigned to this space. <br><br>  The picture below explains what is happening: <br><img src="https://habrastorage.org/getpro/habr/post_images/a6c/838/ba9/a6c838ba98d0d195576a133d4b98987d.png"><br><a name="habracut"></a><br>  Such an abundance of configurations, of course, not quite the desktop, but it will allow to explain what is happening in its pure form. <br><br>  Different namespaces are highlighted in different colors.  These interfaces are available only from the specified namespaces and nothing else.  For example, the red namespace has access only to tap1, veth1 and lo, blue to eth1, eth2, lo and veth0, green to tun0 and lo.  Beyond the namespaces, there are eth0, the own interface br1, tap0 and lo. <br><br>  Note that each namespace has its own lo!  If you listen to mysql in blue namespace for lo, then you will not be able to access it from green (and anyone other than blue) namespace.  Perhaps this is the most pleasant feature.  The second feature is that we can use the same IP address in different namespaces on different interfaces, and there will be nothing for us.  Of course, the routing table for each namespace is different. <br><br>  The attentive reader sensed the spirit of virtualization.  Of course, yes.  Network namespaces (along with other technologies at this level) are an important part of LXC (container virtualization in Linux).  But, unlike openvz and many other similar technologies, the LXC components are so common that they can be used as stand-alone tools.  And this is the correct unix-way: everyone does only one thing, but well;  although purists may say that "shoving everything into the core is bad." <br><br>  The most interesting picture is obtained if you leave the application with the tun / tap interface, which leads beyond the current network (in the picture above - the green namespace with a single tun).  If tun lands somewhere outside the computer (for example, on a vpn server), then the application will have no way to understand what network settings are really on the computer.  If a VPN, for example, leads from Cyprus to Russia, then any application running in the green namespace will receive the address from Russia and go online as if it were in Russia.  Actually, this is what we need in order for Steam to believe that we have Russian IP and agreed to sell the game for half the price. <br><br>  <em>With the definition of the country at Steam everything is somewhat strange.</em>  <em>Without VPN, Steam sometimes shows me prices in euros, sometimes in rubles, and I could not understand the patterns.</em>  <em>Russian VPN removed all questions - prices are always in rubles</em> . <br><br>  A brief tip on working with network namespaces (practical tips near the end of the article): <br>  <code>ip netns</code> - list of network namespaces (in all ip netns commands, you can abbreviate to ip net) <br>  <code>ip netns add/delete foo</code> - create / delete network namespace with the name foo <br>  <code>ip netns exec foo /usr/bin/bin</code> - run the program in the specified network namespace (note that you cannot drag applications that are already running) <br>  <code>ip link set eth99 netns foo</code> - shove an interface into a given space <br><br>  And a few tricks: <br><br>  <code>ip netns exec foo ip link</code> - list of interfaces inside the foo space <br>  <code>ip netns exec foo tcpdump -ni eth99</code> - tcpdump on it.  Attention, due to the specific work of the exec, the output to the screen will appear only after pressing Ctrl-C.  If annoying - see below. <br>  <code>sudo ip netns exec foo login -f username</code> - run login inside namespace'a.  The logged-in user will already work in the specified namespace with well-configured settings for the terminal / group leader, etc. <br><br><h1>  VPN organization via SSH </h1><br>  I do not like openvpn, openswan and other applications for redundancy.  I recognize their need in some situations, but when I can, I try to use SSH.  There are several reasons: <br>  1) SSH is out of the box on any server. <br>  2) SSH uses TCP, not gre / udp, and if you need to connect from an exotic place with a fucking WiFi, then ssh on ports 22 and 443 is our everything.  If port 22 can still be closed, then 443 is definitely not;  it is used by HTTPS (and in case of blocking, indignant hamsters will carry everything on their way to google / facebook, etc.) <br>  3) SSH-client is on any machine within reach, that is, I can pick up the tunnel I need from any unix-machine.  In 3-5 steps - with windows. <br>  4) Tuning degree settings are easy to adjust.  If I only need socks-proxy, then I will not invent l2-tunnels. <br>  5) Without additional shamanism, you can have several parallel connections, and in any combination - to one server from different clients, to different servers from one client, etc.  Absolutely <s>fucked heads</s> can generally connect continents and networks to a single L2-segment by means of a lonely little bug sitting on 3g somewhere in the fifth point of the world behind hardcore nato with closed ports.  And it will even work (to the extent that 3g in the fifth point of the world will be able to digest the broadcasts / multicastes that fly through L3). <br><br>  Although the main reason is even simpler: SSH is a regular toolkit, and it can do everything it needs.  Why something else? <br><br>  So the SSH tunnel theory <br><br><h1>  TUN interfaces </h1><br>  The TUN interface is very simple: it creates a virtual network interface (tun0, tun1, etc.) in the system, which with its other ‚Äúend‚Äù looks at the fd (file descriptor) of the program that created it.  The program decides what to do with traffic from fd.  And the applications in the system decide for themselves what to do with the network interface. <br><br>  In the case of SSH, we tell the SSH client to create a tun-interface for our part, an SSH server for our part, and connect them.  It turns out that traffic on the one hand (from the client) came in, on the other hand (from the server) came out.  And vice versa.  What is not a tunnel?  What is not vpn?  Taking into account that SSH can also encrypt traffic, we get a ready VPN.  Inside SSH, this is called a channel, and it multiplexes them, but we don‚Äôt really care about it. <br><br>  Here is a simple drawing of what is happening: <br><img src="https://habrastorage.org/getpro/habr/post_images/824/358/4b6/8243584b6f73745ec9e0f792df74eb4d.png"><br><br>  Note that we need cooperation from the SSH server.  We will discuss the permission to create tunnels on the server in the section below. There will also be details on how to configure NAT, addressing and other things so that the Freedom arrow works. <br><br>  A note in the margin: in addition to the tun-interfaces, there are also tap-interfaces.  They allow you to combine L2-segments.  This is hell, horror, sodomy and intoxication, but if someone really wants to, then he can try to combine a couple of networks from different data centers via an SSH connection to a homely-made machine.  It will even work (I can‚Äôt vouch for the consequences). <br><br><h1>  Practical action </h1><br><br>  <b>Training:</b> <ol><li>  Copy the SSH key to root to the server (if there is no key, generate: <code>sudo ssh-keygen</code> ).  I usually make the key to the local root so as not to confuse it with my key.  The key is copied using the <code>sudo ssh-copy-id root@server</code> command. </li><li>  Check that SSH on the remote server is allowed to use tunnels.  In the <code>/etc/ssh/sshd_config</code> <code>PermitTunnel</code> variable must be uncommented and set to <code>yes</code> . </li><li>  Choose an arbitrary number (echo $ RANDOM).  This will be our tunnel number.  Remember it (or take another favorite number, for example, 42). </li><li>  Set up a remote server.  I am writing for debian / ubuntu, a process for other distributions / OS - see the documentation for setting up the network for them.  In the / etc / networking / interfaces file we create the following lines: <br><pre> <code class="hljs matlab">allow-hotplug tun42 auto tun42 iface tun42 inet static address <span class="hljs-number"><span class="hljs-number">100.64</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> pre-up iptables -A POSTROUTING -t nat -s <span class="hljs-number"><span class="hljs-number">100.64</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> MASQUERADE post-down iptables -D POSTROUTING -t nat -s <span class="hljs-number"><span class="hljs-number">100.64</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> MASQUERADE</code> </pre><br>  This will allow us to automatically receive the configured interface every time the tun42 interface appears on the server.  At the same time, we enable NAT to translate our packets from the tunnel, and turn it off as soon as the interface disappears. </li><li>  Enable server routing. <code>/etc/sysctl.d/enable_routing.conf</code> <br><pre> <code class="hljs pgsql">net.ipv4.conf.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>.forwarding = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre></li></ol><br><br>  We are almost done.  It remains only to run steam.  Everything written on the local machine. <br><ol><li>  Shut down all previous copies of steam, including the tray icon </li><li>  Connect to server: <code>sudo ssh -w 42:42 root@server</code> .  The -w option says to create tun42 locally and link it (having created) with the remote tun42. </li><li>  In the next console: <br><pre> <code class="hljs sql">xhost + sudo ip net add steam sudo ip link <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> netns steam dev tun42 sudo ip net exec steam ip addr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-number"><span class="hljs-number">100.64</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dev tun42 sudo ip net exec steam ip <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up dev tun42 sudo ip net exec steam ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via <span class="hljs-number"><span class="hljs-number">100.64</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> sudo ip net exec steam login -f $<span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> DISPLAY=:<span class="hljs-number"><span class="hljs-number">0</span></span> steam</code> </pre><br>  <code>xhost +</code> allows <code>xhost +</code> to connect to your X server (be careful).  Paranoids can learn man xhost for more precise rules. <br><br>  <code>ip net add</code> and <code>ip net exec</code> are shortcuts from <code>ip netns add</code> and <code>ip netns exec</code> - create a network namespace, and start a new user session from which we work.  <code>export DISPLAY=:0</code> says ‚Äúuse first X server.  By default, this variable is reset at login, and without it, steam will not be able to connect to the X-server </li></ol><br><br><br>  Own, everything.  At the exit, we have Russian prices in Steam and Russian censorship.  Fortunately, it will only be protected by steam, and the browser in the next window will use the not very fast, but very free Cyprus Internet. <br><br>  In the following parts: <br><ul><li>  How to run a 32-bit steam on x86_64 machine </li><li>  How to isolate steam completely, so that it works, but it has never been run from the root or the main user.  Love and hate with pulsadwio, dri, methods for determining missing libraries, debugging Steam itself </li></ul></div><p>Source: <a href="https://habr.com/ru/post/123140/">https://habr.com/ru/post/123140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123130/index.html">We write one-page client on javascript</a></li>
<li><a href="../123132/index.html">Perfect social network</a></li>
<li><a href="../123133/index.html">Introduction to SuperCollider</a></li>
<li><a href="../123134/index.html">Experience as a tester on a fixber site</a></li>
<li><a href="../123138/index.html">Google+ is not for kids</a></li>
<li><a href="../123141/index.html">Google Plus Review</a></li>
<li><a href="../123142/index.html">USB dongle support in Thinstation</a></li>
<li><a href="../123143/index.html">10 ways to improve your programming skills</a></li>
<li><a href="../123145/index.html">Overview of the SPI bus and development of the driver of the slave SPI device for embedded Linux (Part one, overview)</a></li>
<li><a href="../123151/index.html">Calculate Linux 11.6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>