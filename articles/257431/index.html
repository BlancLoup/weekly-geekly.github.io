<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement an even more secure VPN protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This publication is a continuation of the previously written in our blog: " Implement a secure VPN-protocol ." In this article, we do not alter or rew...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement an even more secure VPN protocol</h1><div class="post__text post__text-html js-mediator-article">  This publication is a continuation of the previously written in our blog: " <a href="http://habrahabr.ru/company/ivi/blog/256365/">Implement a secure VPN-protocol</a> ."  In this article, we do not alter or rewrite the protocol, but only slightly modify it further.  The implementation of everything described below is already present in version <a href="http://www.cypherpunks.ru/govpn/News.html">GoVPN 3.1</a> . <br><br> <a href="http://habrahabr.ru/company/ivi/blog/257431/"><img src="https://habrastorage.org/files/9e5/3d0/edd/9e53d0edd5494fa4a825effdd5429241.jpg"></a> <br><br>  To create noise, the transport protocol is slightly modified.  The handshake protocol has been changed to allow handshake augmentation and password gain.  More details about all this under the cut. <br><a name="habracut"></a><br><h2>  <font color="#fd004c">Hiding the size and time of sending the payload</font> </h2><br>  At the end of the previous article, I noticed that we ensure the confidentiality of the contents of the transmitted data, but do not hide the size of the packets and the fact of their sending.  Sometimes even the very fact (the period of the packet's appearance) can indirectly with high probability say that now, for example, DHCP works via an encrypted channel: it seems to be encrypted, but we still know which processes are inside.  Or, you can track the correlation between incoming traffic from one client to outgoing in another place, and thereby de-anonymize it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We solve this problem quite simply, although it is somewhat costly in terms of resources: we add noise to the traffic. <br><br>  In the transport protocol, after <i>nonce</i> , two bytes are added (which will be encrypted) containing the size of the payload.  It can be equal to zero, which is convenient for <i>heartbeat</i> packages to show that the client / server is still ‚Äúalive‚Äù on the network.  As a side effect: we reduce the MTU of the virtual TAP interface by these two bytes. <br><br>  Each packet is padded with zeros before encryption in order to increase its size to the maximum possible amount sent by GoVPN.  After encryption, it becomes noise, in which it is impossible to understand where the payload is and where useless data is. <br><br>  So we hid the size of the message, but not the fact of messages in the network.  This problem is solved simply by creating a constant traffic rate (constant packet rate).  Technically done simply: the tick generator is turned on.  For each tick, it is checked whether there is a package to send.  If not, an empty packet is sent.  All packages are supplemented to the maximum size with noise. <br><br>  The formation scheme of the transport layer package looks like this: <br><br><img src="https://habrastorage.org/files/e90/ebd/11d/e90ebd11dfbf41459756a288fc3f937c.png"><br><br><h2>  <font color="#fd004c">Strong password authentication protocol</font> </h2><br>  As the <a href="http://habrahabr.ru/users/cebka/" class="user_link">cebka</a> user correctly <a href="http://habrahabr.ru/company/ivi/blog/256365/">noted</a> in the comments to a previous publication, the 256-bit public key Curve25519 is not a random set of bytes, but a point on an elliptic curve.  Therefore, when trying to decrypt it, we will see that we received not random data, but, actually, a point, and, thus, we will understand that we have successfully picked up (found) the common authentication key. <br><br>  The common authentication key in the previous implementation of GoVPN even in the examples assumes that it was generated not from a password, but from a PRNG.  So in practice, of course, it would not have been possible to simply sort out the key.  However, if we want to use passwords, then this will become a problem, since passwords have far less entropy and are amenable <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B1%25D0%25BE%25D1%2580_%25D0%25BF%25D0%25BE_%25D1%2581%25D0%25BB%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2580%25D1%258E">to dictionary-searching attacks</a> . <br><br>  Why do we want to use passwords?  Because, in any case, the common authentication key must somehow be protected.  Either it is stored on a disk to which <a href="http://www.etegro.ru/articles/disk-encryption">full disk encryption</a> is applied, or PGP is encrypted, for example, and when used, the decrypted version of it is placed in random access memory (temporary disk).  Both disk and PGP, in turn, are protected by password phrases.  Why not use these pass phrases directly in the GoVPN protocol to have less software dependencies and attack vectors? <br><br>  <b>A small digression:</b> passwords should be used, not passwords.  Technically, there may be no difference between them for the computer, but for a person it is significant: the password is usually a short line of high-entropy (random) characters, and the passphrase is a long line of low-entropy.  Low entropy means easy human memorization.  It is believed that ordinary English text contains 1-2 bits of entropy per character.  However, if you take a hundred characters, then in total we will get a hundred bits, as a rule, easily remembered.  The only "but" from a technical point of view: if the password can still be stored in the database (do not do that, of course), then the passphrase is not convenient for this and the hash is saved from it. <br><br>  For the authentication protocol to be called ‚Äústrong,‚Äù it must be safe to use even with weak passwords.  In our case, the password ‚Äúfoobar‚Äù will be quickly picked up from the dictionary and decrypting the public key at the time of the handshake will indicate that the password has been successfully selected.  That is, this is not a zero-knowledge-protocol. <br><br>  This can be <a href="http://elligator.cr.yp.to/">corrected by</a> applying a special coding of the points of the <a href="http://elligator.cr.yp.to/">Elligator</a> curves.  It allows them to be encoded so that they become indistinguishable from noise.  This will be enough for the protocol to become zero-knowledge and to be able to use even weak passwords, while being called ‚Äústrong authentication protocol‚Äù.  Elligator is applied to a public key on one side before encryption and is inverted on the opposite side after decryption. <br><br>  Elligator can be applied not to all key pairs Curve25519: on average, about half of the points can not be encoded into a random string.  When generating a Curve25519 key pair, we try to encode a public one, checking whether it will work.  If not, repeat the procedure.  We get an unpleasant side effect: when generating keys Curve25519 on each side, we will need, on average, two times more entropy and computational resources. <br><br><h2>  <font color="#fd004c">Password enhancement</font> </h2><br>  The protocol after the application of Elligator becomes zero-knowledge and is suitable for authentication with weak passwords.  But the authentication data is stored on the server and client.  There may be no client on the client‚Äôs hard disk, as the passphrase is entered manually, but on the server it will be a separate file.  Compromising the contents of the server's hard disk, leaking the authentication key database will allow you to sort through the password, and attack with a dictionary.  This is a very powerful attack, which is able to recover a huge number of passwords and passwords used by people. <br><br>  If we keep the password hash on the server (since it is convenient to store it), then the attacker will simply calculate the hashes from the passwords being sorted and compare with what is on the hard disk.  Hashes are considered fast.  Therefore, <b>always</b> and everywhere stored passwords or passwords need to be strengthened. <br><br>  Common password enhancement methods: <a href="https://ru.wikipedia.org/wiki/PBKDF2">PBKDF2</a> , <a href="https://ru.wikipedia.org/wiki/Bcrypt">bcrypt</a> , <a href="https://ru.wikipedia.org/wiki/Scrypt">scrypt</a> .  We will not particularly go into the descriptions of these algorithms, since there are a lot of articles on this topic (because so far people manage to use none of this without absolutely appreciating the secrets of users). <br><br>  Personally, I do not consider bcrypt as an option, since the nominal length of password phrases per input is limited to 72 characters (the Blowfish feature), which is small (personally, all my password phrases have a length of 90-110 characters).  And the main argument in favor of bcrypt is that its function is slower.  True, but what prevents to increase the number of iterations of PBKDF2?  The difference between them as a whole is very blurry: the essence is one, just a little other tools are used. <br><br>  Scrypt is interesting, but there are also many arguments against it, albeit controversial.  One could think about it more closely if it were not for the final of the <a href="https://password-hashing.net/">Password Hashing Competition</a> , which is designed to make a good quality password enhancement function that takes into account the load on memory and temporary side channel attack.  There really are very interesting ideas, implementations and well-versed in the subject of "judges".  But until the finalist is selected, PBKDF2-SHA512 is used in GoVPN. <br><br>  As a rule, any enhancement is to increase the entropy of passwords and some expensive operation.  An increase in entropy is necessary so that, at a minimum, the same strong passwords do not coincide and for this purpose add the so-called "salt".  The expensive operation in the case of PBKDF2 is a lot (thousands) of hash function iterations.  In addition, additional entropy protects against the creation of pre-calculated hash values. <br><br>  In GoVPN, the already existing 128-bit client ID is used as a salt that is not secret (no need to hide it). <br><br>  The server is already pre-enhanced version.  It is also used in the handshake protocol.  Before starting the connection, the user enters a password phrase, it is amplified using the user ID as a salt, and this result is already used as an authentication key when shaking hands with the server.  The amplification operation is expensive, but is performed only on the client when the daemon starts. <br><br><h2>  <font color="#fd004c">Authentication augmentation</font> </h2><br>  By compromising the database of client authentication keys on the server, we are unlikely to be able to easily find out user passwords.  But in our hands we have the result of their gain, used for authenticating the parties.  If this data leaks to the attacker, then he will be able to present himself as a client, will be able to connect to the VPN server. <br><br>  If we can store on the server something that can only authenticate the authentication data, but cannot be used in their capacity, then this problem will be solved.  The process is commonly called augmentation (‚Äúaugmentation‚Äù) and is described in the <a href="https://www.cs.columbia.edu/~smb/papers/aeke.pdf">article</a> for EKE.  Instead of passwords on the server side are the so-called "verifiers" (verifiers). <br><br>  Options for solving this problem are many.  We will apply it based on asymmetric signature algorithms.  Specifically <a href="http://ed25519.cr.yp.to/"><b>Ed25519</b></a> from the author already used by us Curve25519, Salsa20 and Poly1305.  It is an easy-to-implement, fast, reliable (good cryptanalysis) algorithm for generating and verifying signatures.  In addition, it does not require additional entropy when creating signatures. <br><br>  The essence of augmentation in this case comes down to the fact that the public key Ed25519 of the pair generated from the strong password is used as the verifier.  Instead of a strong password, this checker is used to encrypt Diffie-Hellman public keys.  The client additionally, at the end of the handshake, signs the used shared key <b>K</b> obtained after Diffie-Hellman and sends this signature to the server.  Since the checker is just a public key, the server will be able to verify the signature for them and make sure that the client really has a private part of the key, which can be obtained by knowing only the password in the clear form.  The attacker will not be able to create a signature and introduce himself as a client. <br><br>  The checker is created on the client side in advance, using the utility included in GoVPN.  After entering his ID (which can be created on anyone's side) and the passphrase, on the basis of which the enhanced version is created and Ed25519 key pair, he sends the checker to the server administrator.  As a side effect, we get an increase in the handshake traffic by the length of the signature, and the waste of the client‚Äôs processor resources to create the signature, and the server to check it. <br><br>  The final protocol of the handshake began to look like this: <br><br><img src="https://habrastorage.org/files/d49/79a/035/d4979a035faf42a3844468a47b7a8864.png"><br><table><tbody><tr><td>  rand (xbit) </td><td>  reading X bits from PRNG </td></tr><tr><td>  CDHPriv </td><td>  Private Diffie-Hellman client key </td></tr><tr><td>  SDHPriv </td><td>  Private Diffie-Hellman server key </td></tr><tr><td>  CDHPub </td><td>  Diffie-Hellman's public client key </td></tr><tr><td>  Sdhpub </td><td>  public diffie-hellman server key </td></tr><tr><td>  enc (K, N, D) </td><td>  Salsa20 encryption with key K, nonce N, data D </td></tr><tr><td>  H () </td><td>  hash function HSalsa20.  Not fundamentally what here.  Could be SHA2 </td></tr><tr><td>  El () </td><td>  function of coding point of the Elligator curve, as well as inverting this action </td></tr><tr><td>  DSAPub </td><td>  Ed25519 client's public key generated based on its password </td></tr><tr><td>  DSAPriv </td><td>  Ed25519 client's private key generated based on its password </td></tr><tr><td>  Sign (K, D) </td><td>  Ed25519-signature generation by private key K of data D </td></tr><tr><td>  Verify (K, D) </td><td>  verification of the Ed25519 signature with the public key K data D </td></tr></tbody></table><h2>  <font color="#fd004c">What else to do or fix?</font> </h2><br>  Dependence on quality PRNG has not disappeared anywhere and the safe use of GoVPN under closed proprietary operating systems is technically impossible.  This can be fixed only by changing the OS / platform for good.  <b>Fixed in <a href="http://www.cypherpunks.ru/govpn/News.html">version 3.4</a></b> : third-party EGD-compatible PRNG sources can be used. <br><br>  The only thing that can indirectly be understood is that the traffic is GoVPN-specific is that at the beginning (when there is a handshake) there is an exchange of packets of always clearly defined sizes and only then the ‚Äúnoise‚Äù is turned on.  Handshake messages are indistinguishable from the noise, do not give out the client ID, but the size is not hidden.  <b>Fixed in <a href="http://www.cypherpunks.ru/govpn/News.html">version 4.0</a></b> : handshake messages can be noisy. <br><br>  A small statistic is not current: <br><table><tbody><tr><td>  Overhead transport protocol </td><td>  26 bytes per Ethernet packet TAP interface </td></tr><tr><td>  Overhead protocol handshake </td><td>  264 bytes, 2 packets from the client, 2 from the server </td></tr><tr><td>  Pass IPv4 TCP traffic </td><td>  786 Mbps on amd64 FreeBSD 10.1, Intel i5-2450M CPU 2.5 GHz, Go 1.5.1, one kernel loaded by the daemon </td></tr><tr><td>  Code size of the transport protocol encryption f-ii (de) </td><td>  1 screen, 1 screen </td></tr><tr><td>  Code size of the server, client part of the handshake protocol </td><td>  2 screens, 1.5 screens </td></tr><tr><td>  Supported Platforms </td><td>  i386 / amd64 GNU / Linux and FreeBSD </td></tr><tr><td>  Available as packages in </td><td>  <a href="https://aur.archlinux.org/packages/govpn/">Arch Linux</a> , <a href="http://www.freshports.org/security/govpn/">FreeBSD</a> </td></tr></tbody></table>  All the best, do not switch! <br><br>  <i>Sergey Matveyev, Python and Go-developer ivi.ru</i> <br><br>  Our previous publications: <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/company/ivi/blog/256365/">Implementing a secure VPN protocol</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/company/ivi/blog/240237/">Unnecessary items or how we balance between servers</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/company/ivi/blog/249359/">Blowfish on guard ivi</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/post/247813/">Non-personalized recommendations: the association method</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/post/237349/">By cities and villages or as we balance between CDN nodes</a> <br>  <font color="#fd004c">"</font> <a href="http://habrahabr.ru/post/236253/" title="b706a658aa01">I am Groot.</a>  <a href="http://habrahabr.ru/post/236253/" title="b706a658aa01">We do our analytics on events</a> <br>  <font color="#fd004c">¬ª</font> <a href="http://habrahabr.ru/post/236065/">All on one or as we built CDN</a> </div><p>Source: <a href="https://habr.com/ru/post/257431/">https://habr.com/ru/post/257431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257415/index.html">Typographer - the story continues</a></li>
<li><a href="../257417/index.html">120 servers in 30 days: tenders and other nuances of working with government agencies</a></li>
<li><a href="../257421/index.html">Interview about testing + screenshots of applications working in ReactOS, sent by testers</a></li>
<li><a href="../257425/index.html">Why not RemoteFX, as well as more information about NVIDIA GRID VGPU technology</a></li>
<li><a href="../257427/index.html">Adjustable power supply from ATX power supply to TL494. Part 1 - iron</a></li>
<li><a href="../257433/index.html">How we did the subway breakdown alert</a></li>
<li><a href="../257437/index.html">SkillsWiki conference materials: .NET-developer through the eyes of employers in Russia and abroad</a></li>
<li><a href="../257439/index.html">PHP Data Encryption Guide</a></li>
<li><a href="../257443/index.html">GPS-monitor for android "KidsTrack"</a></li>
<li><a href="../257445/index.html">thd or triggerhappy global hotkey daemon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>