<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NetApp ONTAP & VMware vVOL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to review the internal structure and architecture of the vVol technology implemented in NetApp storage systems with ONTA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NetApp ONTAP & VMware vVOL</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to review the internal structure and architecture of the vVol technology implemented in NetApp storage systems with ONTAP firmware. <br><br>  Why did this technology appear and why is it needed, why will it be in demand in modern data centers?  I will try to answer these and other questions in this article. <br><br>  The vVol technology has provided profiles that, when creating a VM, create virtual disks with specified characteristics.  In such an environment, the virtual environment administrator can easily and quickly check in his vCenter interface which virtual machines live on which media and find out their characteristics on the storage system: what kind of media is there, is the caching technology enabled for it, is it running replication for DR, is there compression, deduplication, encryption, etc.  With vVol technology, storage has become just a collection of resources for vCenter, integrating them much more deeply with each other than it was before. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Nepshots </h4><br>  The problem of consolidating snapshots and increasing the load on the disk subsystem from VMware snapshots may not be noticeable for small virtual infrastructures, but even they can meet with their negative impact in the form of slowing down the robots of the virtual machine or the impossibility of consolidation (removal of snapshots).  vVol supports hardware QoS for virtual disks of the VM, as well as <a href="https://habrahabr.ru/post/244923/">NetApp</a> Hardware-Assistant <a href="https://habrahabr.ru/post/279911/">replication</a> and <a href="https://habrahabr.ru/post/244923/">snapshots</a> , since they are architecturally designed and work fundamentally differently without affecting performance, unlike VMware snapshots of VMWs.  It would seem who uses these snapshots and why is this important?  The fact is that all the backup schemes in the virtualization environment are somehow forced to use the VMware snapshots COW if you want to get consistent data. <br><br><img src="https://habrastorage.org/files/815/555/bcc/815555bcc88c4806ab1cca3f65bdef29.PNG" alt="image"><br><a name="habracut"></a><br><h4>  vVol </h4><br>  What is vVol?  vVol is a layer for a datastor, i.e.  This is a datastor virtualization technology.  Previously, you had a datastor located on a LUN (SAN) or file ball (NAS);  as a rule, each datastor hosted several virtual machines.  vVol made the datastor more granular by creating a separate datastor for each disk of the virtual machine.  vVol also, on the one hand, unified the work with NAS and SAN protocols for the virtualization environment, the administrator anyway, these are moons or files, on the other hand, each virtual VM disk can live in different volums, moons, disk pools (aggregates), with different Cache and QoS settings on different controllers and may have different policies that <i>follow this VM disk</i> .  In the case of a traditional SAN, everything that the storage system ‚Äúsaw‚Äù for its part was also what it could manage ‚Äî the whole datastor, but not separately each virtual disk VM.  With vVol when creating one virtual machine, each of its individual disks can be created in accordance with a separate policy.  Each vVol policy, in turn, allows you to select the free space from the available storage resource pool, which will meet the pre-specified conditions in the vVol policies. <br><br>  This allows more efficient and convenient use of the resources and capabilities of the storage system.  Thus, each virtual machine disk is located on a dedicated virtual datastor similar to LUN RDM.  On the other hand, in vVol technology, using one common space is no longer a problem, because hardware snapshots and clones are performed not at the level of the whole datastor, but at the level of each individual virtual disk, while not using the VMware snapshots of VMware.  At the same time, the storage system will now be able to ‚Äúsee‚Äù each virtual disk separately; this allowed delegating storage capabilities in the vSphere (for example, snapshots), providing deeper integration and transparency of disk resources for virtualization. <br><br>  VMware began developing vVol in 2012 and demonstrated this technology two years later in its preview, while NetApp announced its support for its storage systems with ONTAP firmware with all supported VMWare protocols: NAS (NFS), SAN (iSCSI, FCP). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/caXlscYaWhU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h5>  Protocol endpoints </h5><br>  Let's now move away from the abstract description and move on to the specifics.  The vvols are located on FlexVol, for NAS and SAN, respectively, files or moons.  Each VMDK disk lives on its dedicated vVol disk.  When moving a vVol disk to another storage node, it transparently re-maps to another PE on this new node.  The hypervisor can start creating snapshots separately for each disk of the virtual machine.  A single virtual disk is a complete copy of it, i.e.  one more vVol.  Each new virtual machine without snapshots consists of several vVol.  Depending on the purpose, vVols come in the following types: <br><br><img src="https://habrastorage.org/files/4f0/f8c/490/4f0f8c490c1c4ee5a635e5bf3885419d.png" alt="image"><br><br>  Now, actually, about PE.  PE is the entry point to vVols, a kind of proxy.  PE and vVols are located on the storage system.  In the case of a NAS, the entry point is each Data LIF with its own IP address on the storage port.  In the case of SAN, this is a special 4MB of moons. <br><br>  PE is created on demand by VASA Provider (VP).  PE primaplivaet all its vVol by means of a Binging request from VP to the storage system, an example of the most frequent request is the start of the VM. <br><br>  ESXi is always connected to PE, not directly to vVol.  In the case of SAN, this avoids the 255 moon limit per ESXi host and the maximum number of paths to the moon.  Each virtual machine can consist of only one protocol vVol: NFS, iSCSI or FCP.  All PEs have a LUN ID of 300 or higher. <br><br>  Despite the slight differences, NAS and SAN are very similarly structured in terms of how vVol works in a virtualization environment. <br><br><pre><code class="bash hljs">cDOT::*&gt; lun <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> show -instance Vserver: netapp-vVol-test-svm PE MSID: 2147484885 PE Vdisk ID: 800004d5000000000000000000000063036ed591 vVol MSID: 2147484951 vVol Vdisk ID: 800005170000000000000000000000601849f224 Protocol Endpoint: /vol/ds01/vVolPE-1410312812730 PE UUID: d75eb255-2d20-4026-81e8-39e4ace3cbdb PE Node: esxi-01 vVol: /vol/vVol31/naa.600a098044314f6c332443726e6e4534.vmdk vVol Node: esxi-01 vVol UUID: 22a5d22a-a2bd-4239-a447-cb506936ccd0 Secondary LUN: d2378d000000 Optimal binding: <span class="hljs-literal"><span class="hljs-literal">true</span></span> Reference Count: 2</code> </pre> <br><h5>  iGroup &amp; Export Policy </h5><br>  The iGroup and Export Policy are the mechanisms for hiding information available on the storage system from the hosts.  Those.  provide each host with only what it should see.  As in the case of NAS, and SAN, moon mapping and file sphere export are automatically from VP.  iGroup is not mapped on all vVol, but only on PE, since ESXi uses PE as a proxy.  In the case of the NFS protocol, the export policy is automatically applied to the file globe.  The iGroup and export policy is created and populated automatically using a request from vCenter. <br><br><h5>  SAN &amp; IP SAN </h5><br><img src="https://habrastorage.org/files/d6c/576/52a/d6c57652a6ee4a588e30151a59d59cb0.png" alt="image"><br><br>  In the case of the iSCSI protocol, you must have at least one Data LIF on each storage node that is connected to the same network as the corresponding VMkernel on the ESXi host.  iSCSI and NFS LIFs should be separated, but can coexist on the same IP network and one VLAN.  In the case of FCP, it is necessary to have at least one Data LIF on each storage node for each factory, in other words, as a rule, these are two Data LIFs from each storage node that live on their own target port.  Use soft-zoning on the switch for FCP. <br><br><h5>  NAS (NFS) </h5><br><img src="https://habrastorage.org/files/265/f6c/f4e/265f6cf4eb3c4080b1e5baf7f0eb3db8.png" alt="image"><br><br>  In the case of the NFS protocol, you must have at least one Data LIF with an IP address installed on each storage node that is connected to the same subnet as the corresponding VMkernel on the ESXi host.  You cannot use the same IP address for iSCSI and NFS at the same time, but both of them can coexist on the same VLAN, on the same subnet and on the same physical Ethernet port. <br><br><h4>  VASA Provider </h4><br>  VP is an intermediary between vCenter and the storage system, he explains the storage system that the vCenter wants from it and vice versa tells the vCenter about important alerts and available storage resources, such as those that are physically in fact.  Those.  vCenter can now know how much free space there really is, it is especially convenient when the storage system presents the thin moons to the hypervisor. <br><br>  VP is not a single point of failure in the sense that if it fails, virtual machines will still work fine, but you cannot create or edit policies and virtual machines on vVol, start or stop VM on vVol.  Those.  in the case of a complete reboot of the entire infrastructure, the virtual machines will not be able to start, since it will not execute the Binding VP request to the storage system to apply PE to its vVol.  Therefore, VP is definitely desirable to reserve.  And for the same reason, it is not allowed to have a virtual machine from VP to vVol, which it manages.  Why is it ‚Äúdesirable‚Äù to reserve?  Because, starting with the version of NetApp VP 6.2, the latter is able to restore the contents of vVol simply by reading the meta information from the storage system itself.  Learn more about setting up and integration in the documentation for <a href="https://mysupport.netapp.com/documentation/productlibrary/index.html%3FproductID%3D61790">VASA Provider</a> and <a href="https://mysupport.netapp.com/documentation/productlibrary/index.html%3FproductID%3D30048">VSC</a> . <br><br><h4>  Disaster Recovery </h4><br>  VP supports Disaster Recovery functionality: in case of VP removal or damage, the vVol environment database can be restored: The meta information about the vVol environment is stored in a duplicate form: in the VP database, as well as with the vVol objects themselves on ONTAP.  To restore the VP, it is enough to register the old VP, raise the new VP, register the ONTAP with it, execute the <i>vp dr_recoverdb</i> command in the same <i>place</i> and connect it to the vCenter, in the latter run the ‚ÄúRescan Storage Provider‚Äù.  Read more <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1015727">in KB</a> . <br><br>  The DR functionality for VP will allow vVol to be replicated using SnapMirror hardware replication and restore the site to the DR site when vVol starts supporting storage replication (VASA 3.0). <br><br><h4>  Virtual Storage Console </h4><br>  VSC is a plug-in for storage in the vCenter GUI, including for working with VP policies.  VSC is a required component for vVol operation. <br><br><img src="https://habrastorage.org/files/aac/197/908/aac1979086874da19247942c393b149b.PNG" alt="image"><br><br><h4>  Snapshot &amp; FlexClone </h4><br>  Let's draw the line between snapshots in terms of the hypervisor and snepshots in terms of storage.  This is very important for understanding the internal structure of how vVol works on NetApp with snapshots.  As many already know, snapshots in ONTAP are always executed at the level of the clause (and aggregate) and are not executed at the file / moon level.  On the other hand, vVol, these are files or moons, i.e.  they cannot be used for each individual VMDK file to remove snapshots using data storage systems.  This is where the <a href="https://habrahabr.ru/post/280105/">FlexClone</a> technology comes to the rescue, which is able to make clones not only entirely, but also files / moons.  Those.  when the hypervisor removes a snapshot of a virtual machine living on vVol, the following happens under the hood: vCenter contacts VSC and VP, which in turn find exactly where the necessary VMDK files live and give the ONATP command to remove the <i>clone</i> from them.  Yes, the fact that from the side of the hypervisor looks like a snapshot on the storage system is a clone.  In other words, in order for the Hardware-Assistant Snapshot to work on the vVol, a FlexClone license is required.  It is for this or similar purposes that ONTAP has a new functionality called FlexClone Autodelete, which allows you to set policies for deleting old clones. <br><br>  Since snapshots are performed at the storage level, the problem of snapshot consolidation (ESXi) and the negative impact of snapshots on the performance of the disk subsystem are completely eliminated due to the internal arrangement of the ONTAP cloning / snapshotting mechanism. <br><br><h4>  Consistency </h4><br>  Since the hypervisor itself removes snapshots using storage systems, they are immediately immediately consistent.  That fits very well with the <a href="https://habrahabr.ru/post/244923/">NetApp ONTAP backup paradigm</a> .  vSphere supports VM memory snapshots on a dedicated vVol. <br><br><h4>  Clone and VDI </h4><br>  The cloning function is often very much in demand in the VDI environment, where there is a need to quickly deploy many of the same type of virtual machines.  In order to use the Hardware-Assistant cloning, a FlexClone license is required.  It is important to note that the FlexClone technology not only dramatically accelerates the deployment of copies of a large number of virtual machines, drastically reducing the consumption of disk space, but also indirectly speeds up their work.  Cloning essentially performs a function like deduplication, i.e.  reduces the amount of space occupied.  The fact is that NetApp FAS always puts data into the system cache, and the system and SSD caches in turn are Dedup-Aware, i.e.  they do not drag out duplicate blocks from other virtual machines that are already there, logically accommodating much more than the physically system and SSD cache can.  This dramatically improves performance during storage operation, and especially during Boot-Storm moments, due to the increased hit / read data to / from cache (a). <br><br><h4>  UNMAP </h4><br>  Technology vVol starting with version VMware 6.0, VM Hardware version 11 and Windows 2012 with the NTFS file system supports the release of space inside the thin moon on which this virtual machine is located automatically.  This significantly improves utilization of the usable space in the SAN infrastructure using Thing Provisioning and Hardware Assistant snapshots.  And starting with VMware 6.5 and the Linux guest OS with SPC-4 support, it will also allow you to free up space from inside the virtual machine, back to the storage system, allowing you to significantly save expensive storage space on the storage system.  <a href="https://habrahabr.ru/post/271959/">Read more about UNMAP</a> . <br><br><h4>  Minimum system requirements </h4><br><ul><li>  NetApp VASA Provider 5.0 and higher </li><li>  VSC 5.0 and higher. </li><li>  Clustered Data ONTAP 8.2.1 and above </li><li>  VMware vSphere 6.0 and up </li><li>  VSC and VP must have the same version, for example, both 5.x or both 6.x. </li></ul><br>  For details, check with your authorized NetApp partner or <a href="http://mysupport.netapp.com/matrix">compatibility matrix</a> . <br><br><h4>  <a href="https://habr.com/ru/post/321366/">SRM and hardware replication</a> </h4><a name="SRM"></a><br>  Unfortunately, Site Recovery Manager <a href="https://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D2112039">does not yet support vVol,</a> since in the current implementation of the VASA protocol, VMware does not support replication and SRM.  NetApp FAS systems have SRM integration and work without vVol.  VVol technology is also supported with vMSC (MetroCluster) for building geo-distributed, highly accessible storage for building. <br><br><h4>  Backup </h4><br>  The vVol technology will drastically change the approach to backups, reducing backup time and more efficiently using storage space.  One of the reasons for this is a fundamentally different approach of snooping and backup, since vVol uses hardware snooping, which is why the issue of consolidation and removal of VMware snapshots is eliminated.  Due to the elimination of problems with the consolidation of VMware snapshots, the removal of application-aware (hardware) snapshots and backups ceases to be a headache for admins.  This will allow for more frequent backup and snapshots.  Hardware snapshots that do not affect performance will allow them to be stored a lot right on the production environment, while hardware replication will allow more efficient replication of data for archiving or to a DR site.  Using snapshots compared to Full-backup will allow more economical use of storage space. <br><br><h4>  VASA API 3.0 </h4><br>  Do not confuse the plugin from the storage vendor (for example, NetApp VASA Provider 6.0) and the VMware VASA API (for example, VASA API 3.0).  The most important and expected innovation in the VASA API, in the near future, will be support for hardware replication.  It is hardware replication support that is so lacking in order for vVol technology to become widely used.  The new version will support hardware replication of vVol disks by means of storage systems to provide DR function.  Replication could have been done before using storage systems, but the hypervisor previously could not work with the replicated data due to the lack of support for such functionality in VASA API 2.X (and younger) by vSphere.  Also, PowerShell cmdlets will appear to control DR on vVol and, importantly, the ability to run replicated machines for testing.  For a planned migration from the DR site, virtual machine replication may be requested.  This will allow you to use SRM along with vVol. <br><br>  Oracle RAC will be validated to run on vVol, which is good news. <br><br><h4>  Licensing </h4><br>  The following components are necessary for vVol to work: VP, VSA and storage with the necessary firmware, supporting vVol.  These components themselves do not require any licenses to run vVol.  On the NetApp ONTAP side, a FlexClone license is required in order for the vVol to work - this license is also needed in order to support hardware snepshots or clones (removal and restoration).  Data replication (if needed) will require a NetApp SnapMirror / SnapVault license (on both storage systems: on the primary and backup sites).  On the vSphere side, you need Standard or Enterprise Plus licenses. <br><br><h4>  findings </h4><br>  The vVol technology was designed to even more closely interoperate the ESXi hypervisor with storage and simplify management.  This allowed a more rational use of the capabilities and resources of storage, such as Thing Provisioning, where, thanks to <a href="https://habrahabr.ru/post/271959/">UNMAP, space from thin moons can be released</a> .  At the same time, the hypervisor reports on the real state of storage space and resources, all this allows using Thing Provisioning not only for the NAS, but also to use it in ‚Äúcombat‚Äù conditions with the SAN, to abstract from the access protocol and to ensure the transparency of the infrastructure.  And policies for working with storage resources, thin cloning and snapshots that do not affect performance will allow even more quickly and conveniently to deploy virtual machines in a virtualized infrastructure. </div><p>Source: <a href="https://habr.com/ru/post/321366/">https://habr.com/ru/post/321366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321356/index.html">One-day conference on the gaming industry at VSBI February 11</a></li>
<li><a href="../321358/index.html">A / B tests are not needed *</a></li>
<li><a href="../321360/index.html">Technosphere Mail.Ru - three years</a></li>
<li><a href="../321362/index.html">Testing Ethereum smart contracts on the example of DAO</a></li>
<li><a href="../321364/index.html">Lightshot client for Ubuntu Linux (and not only)</a></li>
<li><a href="../321368/index.html">Andrew Un's draft of The Thirst for Machine Learning, Chapters 1-7</a></li>
<li><a href="../321370/index.html">Why VIPER is a bad choice for your next application.</a></li>
<li><a href="../321372/index.html">Why Zuckerberg chasing a ghost</a></li>
<li><a href="../321374/index.html">Configuring the launch of the GRUB bootloader menu when installing Linux from Windows on one computer with a GPT partition table</a></li>
<li><a href="../321376/index.html">Facebook shareholders want to remove Zuckerberg from the chair of the board of directors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>