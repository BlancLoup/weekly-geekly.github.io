<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interoperability Java and ... Assembler?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Java, it is possible to use software code implemented in other programming languages, the so-called JNI . You can write a dynamically linked librar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interoperability Java and ... Assembler?</h1><div class="post__text post__text-html js-mediator-article">  In Java, it is possible to use software code implemented in other programming languages, the so-called <a href="http://en.wikipedia.org/wiki/Java_Native_Interface">JNI</a> .  You can write a dynamically linked library, then load it in Java code, and use functions from there by declaring them as the native methods of the class that loaded it.  JNI was created primarily to perform machine-dependent actions (and also, possibly, improve the performance of speed-critical parts of an application) in C / C ++, but no one bothers to write the library in assembly language. <br><a name="habracut"></a><br><h4>  Tools </h4><br>  To create this perversion, Windows, Oracle JDK, Yasm (without macros) and the linker from Microsoft Visual Studio 2010 were used. If you wish, it would not be difficult to replace any of these components with your favorite, I tried not to use any non-standard features. <br><br><h4>  Using JNI </h4><br>  To begin with, let's create a Java class in which the function from the future .dll will be called: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestJNI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//   sum public static void main(String[] args) { System.loadLibrary("mydll"); //   mydll.dll System.out.println(sum(2, 3)); //   } }</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Name Mangling in Java </h4><br>  Now you need to know what function name the Java machine is looking to find in our library.  Let's use for this the javah program from JDK: <br><br> <code>javac TestJNI.java <br> javah TestJNI <br></code> <br><br>  This will generate a C ++ header: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;jni.h&gt; /* Header for class TestJNI */ #ifndef _Included_TestJNI #define _Included_TestJNI #ifdef __cplusplus extern "C" { #endif /* * Class: TestJNI * Method: sum * Signature: (II)I */ JNIEXPORT jint JNICALL Java_TestJNI_sum (JNIEnv *, jclass, jint, jint); #ifdef __cplusplus } #endif #endif</span></span></span></span></code> </pre><br><br>  The information contained here is needed mainly for the further writing of the library in C ++, we are only interested in the function signature: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">JNIEXPORT jint JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_TestJNI_sum</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *, jclass, jint, jint)</span></span></span></span>;</code> </pre><br><br>  We see that in the dll function must have the name JNICALL Java_TestJNI_sum and take 4 parameters.  For the simplest functions, we will not need the first two of them.  Any strange data types like JNIEXPORT, as it is easy to guess, are declared in the jni.h file, which is part of the JDK. <br><br><h4>  Assembler </h4><br>  Now let's write the library: <br><br><pre> <code class="hljs pgsql">;mydll.asm section .text <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> Java_TestJNI_sum Java_TestJNI_sum: mov eax, [esp + <span class="hljs-number"><span class="hljs-number">12</span></span>] ;   <span class="hljs-number"><span class="hljs-number">2</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> eax, [esp + <span class="hljs-number"><span class="hljs-number">16</span></span>] ret <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><pre> <code class="hljs delphi">;mydll.def <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> mydll <span class="hljs-keyword"><span class="hljs-keyword">EXPORTS</span></span> Java_TestJNI_sum</code> </pre><br><br>  Compile and link: <br> <code>yasm -f win32 mydll.asm <br> link /SUBSYSTEM:windows /DLL /NOENTRY /DEF:mydll.def mydll.obj <br></code> <br><br>  At the output we get a .dll file, which we need to pass to the code in Java. <br><br><h4>  Result </h4><br>  Put the files mydll.dll and TestJNI.class in one folder and see what happened: <br><br> <code>&gt;java TestJNI <br> 5 <br></code> <br><br>  This is a victory, we have learned to add two numbers! <br><br>  If suddenly someone became interested, then the following links will be useful to him: <br><br><ul><li>  <a href="http://today.java.net/pub/a/today/2006/10/19/invoking-assembly-language-from-java.html">Invoking Assembly Language Programs from Java</a> is a very good and much more detailed article in English on this topic; </li><li>  <a href="http://math.tntech.edu/techreports/TR_2004_5.pdf">Writing dll in assembler for external calling in Maple</a> - creating a library in assembler for Maple; </li><li>  <a href="http://java.sun.com/docs/books/jni/index.html">Java Native Interface: Programmer's Guide and Specification</a> is a thick book on JNI. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/145804/">https://habr.com/ru/post/145804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145798/index.html">Opera 12 - get full control over the browser</a></li>
<li><a href="../145799/index.html">Compensation angle demolition platform aerial camera</a></li>
<li><a href="../145800/index.html">Windows Azure: In-Memory Distributed Cache</a></li>
<li><a href="../145801/index.html">T-fractals on JavaScript Canvas</a></li>
<li><a href="../145803/index.html">Microsoft gives up? Xbox LIVE for Android</a></li>
<li><a href="../145805/index.html">Nonlinear Dynamics and Time Series Analysis - Review of the Recurrence plots Method</a></li>
<li><a href="../145806/index.html">Nokia sells Vertu and is preparing to lay off 10 thousand employees</a></li>
<li><a href="../145810/index.html">In jQuery since version 1.8, you can exclude some modules</a></li>
<li><a href="../145811/index.html">Pivot 360 or what solutions we used. Part 1</a></li>
<li><a href="../145812/index.html">QML and QtQuick Webinars: User Interface Paging</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>