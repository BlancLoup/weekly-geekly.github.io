<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I logged on SD card Shield V2.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 It took me an urgent need to collect a simple data logger for one old industrial gas analyzer, which had only current outputs on paper re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I logged on SD card Shield V2.0</h1><div class="post__text post__text-html js-mediator-article">  <b>Hi, Habr!</b> <br><br><img src="https://habrastorage.org/files/da4/814/692/da4814692f9a4476a6fbbf33c1d3382a.jpg" alt="image" align="left">  It took me an urgent need to collect a simple data logger for one old industrial gas analyzer, which had only current outputs on paper recorders.  It seems a simple task, but she amused me notably.  Details of this story under the cut.  Conclusions there. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The task was really the simplest.  But as always, everything is urgent.  I did not want to spend money on an industrial logger, and Arduino UNO was in the supply.  A five-minute question walk and found a suitable <a href="">nameplate</a> that was well suited for this task.  The <a href="http://imces.ru/index.php%3Frm%3Dnews%26action%3Dview%26id%3D403">DOG-4</a> industrial gas analyzer, which needed to be connected to a logger, has only outputs to paper recorders.  Conclusions current 0..5 mA for each analyzed gas (NO and SO2). <br><img src="https://habrastorage.org/files/34e/292/ee4/34e292ee456d4f22b1d0939f4db6d12f.gif" align="left">  By the way, the optical gas analyzer is an excellent and reliable design, but the obsolete electronics inside spoils the whole thing.  The task was to pologigirovat data during the week and write them in electronic form for calculations to technologists.  No further details were said. <br>  The label found on the Internet was ordered at <a href="http://devicter.ru/">this</a> (by the way, very good) store and was delivered the next day to Tomsk from Novosibirsk.  The description label is very convenient, it has a prototyping area, which I hoped to use in this simple project.  It is enough to load the current outputs of the recorders, for example, on 1 kOhm resistors pulled up in the ground and you will receive digital data from the device for the entire measurement range.  Arduino‚Äôs ADC bit size of 10 bits was quite convenient for technologists (of course, it‚Äôs much more fun to rip data off paper tapes).  Parcel arrived, beautiful packaging, description as in the online store.  Indicated the presence of a site for prototyping, on which it was necessary to solder only two resistors. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b2d/a22/be1/b2da22be16004e1ba204823ffd9781af.jpg"></div><br>  However, the autopsy showed that the nameplate does not match the description.  That's what actually was in the box. <img src="https://habrastorage.org/files/4b5/573/a6d/4b5573a6d7064d92ab71dadc18e08f16.jpg" align="left">  Instead of a prototyping site, there was a power switch of 5 - 3.3 V, the purpose of which remained unclear to me, since initially it would have been more sensible to take 3.3 V power from the Arduino board and power the SD card without the risk of burning the card.  Switching the switch to 5 V immediately supplies five-volt power to the card, thereby conscientiously disabling it in the future.  Fun Chinese electronics.  It is clear that the power supply was immediately served correctly at 3.3 V. The library for working with the device downloaded from the manufacturer‚Äôs official page also turned out to be a highlight.  She just did not work. <br>  The nameplate uses 4 pins of Arduino, according to this table.  Here, thank God, nothing is confused. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/03a/989/8b0/03a9898b017b4234b0b0414d54934d1d.jpg"></div><br>  Already thinking about starting to program the correct operation of this device myself, I remembered that in versions of the Arduino IDE 1.0+, developers everywhere for some reason began to use the definition #include ‚ÄúArduino.h‚Äù instead of #include ‚ÄúWProgram.h "And therefore the old libraries stopped working in later versions of the Arduino IDE.  Returning to the library from the manufacturer‚Äôs website, I discovered that it is for this reason that I cannot ‚Äústart‚Äù it.  Treated the situation is quite simple.  In files with the .h and .cpp extensions, the line #include "WProgram.h" must be replaced with such a construction <br><br><pre><code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(ARDUINO) &amp;&amp; ARDUINO &gt;= 100 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Arduino.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WProgram.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><br>  After that, the library will work in any version of the Arduino IDE.  You can do it yourself, or you can download the already updated version of the library at this <a href="">link</a> . <br><br>  The final code of my logger for the gas analyzer is unlikely to be interesting for the post, but I give a simple example for familiarization.  This is how the working code will look like to write data to the SD card, which will write the phrase ‚ÄúHello, Habrahabr!‚Äù To the file every 5 seconds. <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"FileLogger.h"</span></span> //     <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>   <span class="hljs-number"><span class="hljs-number">8</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">MEM_PW</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> void setup(void) { pinMode(<span class="hljs-type"><span class="hljs-type">MEM_PW</span></span>, <span class="hljs-type"><span class="hljs-type">OUTPUT</span></span>); //   <span class="hljs-number"><span class="hljs-number">8</span></span>      digitalWrite(<span class="hljs-type"><span class="hljs-type">MEM_PW</span></span>, <span class="hljs-type"><span class="hljs-type">HIGH</span></span>); } void loop(void) { byte buffer[] = <span class="hljs-comment"><span class="hljs-comment">"Hello, Habrahabr! \r\n"</span></span>; unsigned long length = sizeof(buffer)<span class="hljs-number"><span class="hljs-number">-1</span></span>; // ! int result = <span class="hljs-type"><span class="hljs-type">FileLogger</span></span>::append(<span class="hljs-comment"><span class="hljs-comment">"data.log"</span></span>, buffer, length); delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); //  <span class="hljs-number"><span class="hljs-number">5</span></span>  }</code> </pre><br><br>  A few important notes.  Before you start recording, you must format the card (FAT16) and open an empty file with the name that will be used in the program.  In the example, this is data.log.  Do not pull the card out of the nameplate on the "hot".  It is better to provide for software power off with the digitalWrite command (MEM_PW, LOW); <br>  If your data is a variable length, use the string length calculation.  In the example, this is unsigned long length = sizeof (buffer) -1.  Inaccuracies in the length of the phrases lead to a failure of the recording process and you can get a broken file instead of data. <br><br>  <b>findings</b> <br><br>  The nameplate turned out to be quite working.  Excellent data writing speed.  Of course, it is not very pleasant that the description is not true, but it is even amusing and makes it possible to think a little about brains.  By the way, the same label can be used for mini SD.  Connector for such a card is on the reverse side. <br><br>  Have a nice day, everyone! </div><p>Source: <a href="https://habr.com/ru/post/239171/">https://habr.com/ru/post/239171/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239159/index.html">7 best tools for solving business problems from a business consultant generalist</a></li>
<li><a href="../239161/index.html">Reddit asked its remote developers to move to San Francisco or they will be fired</a></li>
<li><a href="../239163/index.html">Car audio as headset for phone</a></li>
<li><a href="../239165/index.html">PassGenJS. We generate passwords in Javascript with the indication of reliability</a></li>
<li><a href="../239169/index.html">Hardware acceleration in the life of the coder. Yandex Workshop</a></li>
<li><a href="../239173/index.html">57 years ago, the world's first artificial satellite was launched</a></li>
<li><a href="../239175/index.html">Unity3D tips and tricks</a></li>
<li><a href="../239179/index.html">Why I bought another bitcoin</a></li>
<li><a href="../239189/index.html">Authomatic: python library for authentication and authorization</a></li>
<li><a href="../239193/index.html">Print It Yourself: What is interesting in the world of 3D printing from the point of view of the owner of Lumia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>