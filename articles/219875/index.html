<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Indexing AJAX sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing the interface of a single web application, the task arose of making pages generated by AJAX a request indexed by search engines. Yande...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Indexing AJAX sites</h1><div class="post__text post__text-html js-mediator-article"> When developing the interface of a single web application, the task arose of making pages generated by AJAX a request indexed by search engines.  Yandex and Google have a mechanism for indexing such pages ( <a href="https://developers.google.com/webmasters/ajax-crawling/">https://developers.google.com/webmasters/ajax-crawling/</a> <a href="">http://help.yandex.ru/webmaster/robot-workings/ajax-indexing.xml</a> ).  The point is quite simple, to tell the robot about the HTML version of the page, you need to include a tag in the body <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h4> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h4> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h4> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h4> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h5> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h5> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h5> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h4> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h4> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <pre> <code class="hljs pgsql"><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>,       http://widjer.net/posts/posts<span class="hljs-number"><span class="hljs-number">-430033</span></span>?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , <span class="hljs-number"><span class="hljs-number">7</span></span>   <span class="hljs-number"><span class="hljs-number">30</span></span>     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>  Home      . <br> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.QueryString["_escaped_fragment_"] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>(); } try { //We¬¥ll crawl the normal url <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(result); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { Trace.TraceError("CrawlError: {0}", ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Crawl(IUrlStorage st, ISpaSnapshot ss) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(st != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(ss != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); _sorage = st; _snapshot = ss; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); // ,  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { res = await _sorage.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!string.IsNullOrWhiteSpace(res)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); //  throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlStorage { Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url  bucketname IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } // url        } <br> <br>    S3   ,    . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToBucketNameStrategy BuckName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _buckName;} } private IUrlToKeyStrategy _keyName; // url   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IUrlToKeyStrategy KeyName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> S3Storage(string S3Key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, string S3SecretKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToBucketNameStrategy bns = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, IUrlToKeyStrategy kn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> UrlToKeyStrategy(); //      ,   _amazonConfig = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>,      }; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { // url   bucket   string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var reader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ex.ErrorCode != "NoSuchKey") throw ex; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task Put(string url, string body) { string bucket = _buckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), key = _keyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url); var client = CreateClient(); PutObjectRequest request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToBucketNameStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); // url,     bucket } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { //   switch(parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "posts": //  ,    ,    bucketName = "month"; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> "users": //  ,   bucketName = "weak"; break; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IUrlToKeyStrategy { string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly <span class="hljs-type"><span class="hljs-type">char</span></span>[] Sep = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">'/'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string url) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(url != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //       ""  key = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>(".", parts.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; HttpUtility.UrlEncode(x))); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>); } <br> <br>       Blitline.    ,    ,           . <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private <span class="hljs-type"><span class="hljs-type">int</span></span> _regTimeout = <span class="hljs-number"><span class="hljs-number">30000</span></span>; //<span class="hljs-number"><span class="hljs-number">30</span></span>s //   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrWhiteSpace(resp)) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var client = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FormUrlEncodedContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(response.Failed) crawlResponse = string.<span class="hljs-keyword"><span class="hljs-keyword">Join</span></span>("; ", response.Results.<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x.Error)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       <span class="hljs-type"><span class="hljs-type">JSON</span></span> var reqData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SrcDataDto { ViewPort = "1200x800", SaveHtml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveDest { S3Des = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StorageDestination { Bucket = _storage.BuckName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url), Key = _storage.KeyName.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(url) } } }, <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FunctionData { <span class="hljs-type"><span class="hljs-type">Name</span></span> = "no_op" } } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task TakeSnapshot(string url, IUrlStorage <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>) { //    var startInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, CreateNoWindow = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardOutput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardError = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, RedirectStandardInput = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, StandardOutputEncoding = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8 }; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process { StartInfo = startInfo }; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>.Put(url, output); } } <br>    _jsPath <br> var resourceWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>, maxRenderWait = <span class="hljs-number"><span class="hljs-number">13000</span></span>; var page = require(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> = require(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), count = <span class="hljs-number"><span class="hljs-number">0</span></span>, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: <span class="hljs-number"><span class="hljs-number">1280</span></span>, height: <span class="hljs-number"><span class="hljs-number">1024</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> doRender() { console.log(page.content); phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } page.onResourceRequested = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (req) { count += <span class="hljs-number"><span class="hljs-number">1</span></span>; clearTimeout(renderTimeout); }; page.onResourceReceived = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res.stage || res.stage === <span class="hljs-string"><span class="hljs-string">'end'</span></span>) { count -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count === <span class="hljs-number"><span class="hljs-number">0</span></span>) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== "success") { phantom.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { forcedRenderTimeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%<span class="hljs-number"><span class="hljs-number">23</span></span>_?_escaped_fragment_=</a>     javascript.  ,      .</code> </pre> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> <h4> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </h4> <code><a href="http://www.example.com/%25D1%2587%25D1%2582%25D0%25BE%25D1%2582%25D0%25BE%25D0%25B5%25D1%2589%25D0%25B5%3F_escaped_fragment_%3D"></a> <a href="http://widjer.net/posts/posts-430033"></a> <a href="http://widjer.net/posts/posts-430033%3F_escaped_fragment_%3D"></a> <a href="http://durandaljs.com/"></a> <a href="http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html"></a> <a href="http://www.blitline.com/docs/seo_optimizer"></a> <a href="http://aws.amazon.com/s3/"></a> .       AJAX . HTML       www.example.com/?_escaped_fragment_=.  ,      http://widjer.net/posts/posts-430033,       http://widjer.net/posts/posts-430033?_escaped_fragment_=. <br>      ,       ,      ajax ,      . <br> <a name="habracut"></a> <br>   <br>    ASP MVC   durandaljs (http://durandaljs.com/).   durandal     (http://durandaljs.com/documentation/Making-Durandal-Apps-SEO-Crawlable.html).  ,     Blitline (http://www.blitline.com/docs/seo_optimizer).    ,      .         ,       Amazon S3 bucket.    ,                   . <br> <br>  <br>      http://aws.amazon.com/s3/    .       ,          . ,   ,             . <br> <br>  S3 <br>    S3   buckets: day, month, weak.    ,        .   bucket  Lifecycle.     ,     , 7   30     bucket. <br> <br>    Blitline          .        bucket    . <br> { "Version": "2008-10-17", "Statement": [ { "Sid": "AddCannedAcl", "Effect": "Allow", "Principal": { "CanonicalUser": "dd81f2e5f9fd34f0fca01d29c62e6ae6cafd33079d99d14ad22fbbea41f36d9a"}, "Action": [ "s3:PutObjectAcl", "s3:PutObject" ], "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*" } ] } <br> YOUR_BUCKET_NAME     bucket. <br>  S3 ,   . <br> <br>  , MVC Controller <br>     SPA,      HomeController,     durandal   .  Index  Home      . <br> if (Request.QueryString["_escaped_fragment_"] == null) {   return View(); } try { //We¬¥ll crawl the normal url without _escaped_fragment_ var result = await _crawler.SnaphotUrl( Request.Url.AbsoluteUri.Replace("?_escaped_fragment_=", "") ); return Content(result); } catch (Exception ex) { Trace.TraceError("CrawlError: {0}", ex.Message); return View("FailedCrawl"); } <br> <br>   <br> _crawler    <br> <br> public interface ICrawl { Task&lt;string&gt; SnaphotUrl(string url); } <br> <br>     url,     ,   html   .    <br> <br> public class Crawl: ICrawl { private IUrlStorage _sorage; //   S3 private ISpaSnapshot _snapshot; //    public Crawl(IUrlStorage st, ISpaSnapshot ss) { Debug.Assert(st != null); Debug.Assert(ss != null); _sorage = st; _snapshot = ss; } public async Task&lt;string&gt; SnaphotUrl(string url) { //     (S3 ) string res = await _sorage.Get(url); // ,  if (!string.IsNullOrWhiteSpace(res)) return res; // ,   await _snapshot.TakeSnapshot(url, _sorage); //   var i = 0; do { res = await _sorage.Get(url); if(!string.IsNullOrWhiteSpace(res)) return res; Thread.Sleep(5000); } while(i &lt; 3); //  throw new CrawlException("    "); } } <br>   ,  . <br> <br>   S3 <br>   IUrlStorage <br> public interface IUrlStorage { Task&lt;string&gt; Get(string url); //    Task Put(string url, string body); //    //   IUrlToBucketNameStrategy BuckName { get; } // url  bucketname IUrlToKeyStrategy KeyName { get; } // url        } <br> <br>    S3   ,    . <br> public class S3Storage: IUrlStorage { private IUrlToBucketNameStrategy _buckName; // url   bucket public IUrlToBucketNameStrategy BuckName { get { return _buckName;} } private IUrlToKeyStrategy _keyName; // url   public IUrlToKeyStrategy KeyName { get { return _keyName; } } //    ,       amazon private readonly string _amazonS3AccessKeyID; private readonly string _amazonS3secretAccessKeyID; private readonly AmazonS3Config _amazonConfig; public S3Storage(string S3Key = null, string S3SecretKey = null, IUrlToBucketNameStrategy bns = null, IUrlToKeyStrategy kn = null) { _amazonS3AccessKeyID = S3Key; _amazonS3secretAccessKeyID = S3SecretKey; _buckName = bns ?? new UrlToBucketNameStrategy(); //      ,   _keyName = kn ?? new UrlToKeyStrategy(); //      ,   _amazonConfig = new AmazonS3Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 //   bucket   US Default,      }; } public async Task&lt;string&gt; Get(string url) { // url   bucket   string bucket = _buckName.Get(url), key = _keyName.Get(url), res = string.Empty; //  var client = CreateClient(); //  GetObjectRequest request = new GetObjectRequest { BucketName = bucket, Key = key, }; try { //    var S3response = await client.GetObjectAsync(request); using (var reader = new StreamReader(S3response.ResponseStream)) { res = reader.ReadToEnd(); } } catch (AmazonS3Exception ex) { if (ex.ErrorCode != "NoSuchKey") throw ex; } return res; } private IAmazonS3 CreateClient() { //  var client = string.IsNullOrWhiteSpace(_amazonS3AccessKeyID) //            ? Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonConfig) //from appSettings : Amazon.AWSClientFactory.CreateAmazonS3Client(_amazonS3AccessKeyID, _amazonS3secretAccessKeyID, _amazonConfig); return client; } public async Task Put(string url, string body) { string bucket = _buckName.Get(url), key = _keyName.Get(url); var client = CreateClient(); PutObjectRequest request = new PutObjectRequest { BucketName = bucket, Key = key, ContentType = "text/html", ContentBody = body }; await client.PutObjectAsync(request); } } <br> <br>   ,      url    S3 . Bucket       .      ,     . <br> public interface IUrlToBucketNameStrategy { string Get(string url); // url,     bucket } public class UrlToBucketNameStrategy : IUrlToBucketNameStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); var bucketName = "day"; //    var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); if(parts.Length &gt; 1) { //   switch(parts[1]) { case "posts": //  ,    ,    bucketName = "month"; break; case "users": //  ,   bucketName = "weak"; break; } } return bucketName; } } <br> <br>  bucket ,        .      IUrlToKeyStrategy. <br> public interface IUrlToKeyStrategy { string Get(string url); } public class UrlToKeyStrategy: IUrlToKeyStrategy { private static readonly char[] Sep = new[] { '/' }; public string Get(string url) { Debug.Assert(url != null); string key = "mainpage"; //   var parts = url.Split(Sep, StringSplitOptions.RemoveEmptyEntries); //   if(parts.Length &gt; 0) { //       ""  key = string.Join(".", parts.Select(x =&gt; HttpUtility.UrlEncode(x))); } return key; } } <br> <br>   ,      . <br> <br>    AJAX  <br>      ISpaSnapshot <br> public interface ISpaSnapshot { Task TakeSnapshot(string url, IUrlStorage storage); } <br> <br>       Blitline.    ,    ,           . <br> public class BlitlineSpaSnapshot : ISpaSnapshot { private string _appId; //id     private IUrlStorage _storage; //    private int _regTimeout = 30000; //30s //   public BlitlineSpaSnapshot(string appId, IUrlStorage st) { _appId = appId; _storage = st; } public async Task TakeSnapshot(string url, IUrlStorage storage) { //      string jsonData = FormatCrawlRequest(url); //  var resp = await Crawl(url, jsonData); //   ,     if (!string.IsNullOrWhiteSpace(resp)) throw new CrawlException(resp); } private async Task&lt;string&gt; Crawl(string url, string jsonData) { //    string crawlResponse = string.Empty; using (var client = new HttpClient()) { var result = await client.PostAsync("http://api.blitline.com/job", new FormUrlEncodedContent(new Dictionary&lt;string, string&gt; { { "json", jsonData } })); var o = result.Content.ReadAsStringAsync().Result; //         var response = JsonConvert.DeserializeObject&lt;BlitlineBatchResponse&gt;(o); //  if(response.Failed) crawlResponse = string.Join("; ", response.Results.Select(x =&gt; x.Error)); } return crawlResponse; } private string FormatCrawlRequest(string url) { //    ,       JSON var reqData = new BlitlineRequest { ApplicationId = _appId, Src = url, SrcType = "screen_shot_url", SrcData = new SrcDataDto { ViewPort = "1200x800", SaveHtml = new SaveDest { S3Des = new StorageDestination { Bucket = _storage.BuckName.Get(url), Key = _storage.KeyName.Get(url) } } }, Functions = new[] { new FunctionData { Name = "no_op" } } }; return JsonConvert.SerializeObject(new[] { reqData }); } } <br> <br>   <br>        ,      .     .   ,    .       <a href="http://phantomjs.org/">PhantomJS</a> <br> <br> public class PhantomJsSnapShot : ISpaSnapshot { private readonly string _exePath; //  PhantomJS private readonly string _jsPath; //  ,   public PhantomJsSnapShot(string exePath, string jsPath) { _exePath = exePath; _jsPath = jsPath; } public Task TakeSnapshot(string url, IUrlStorage storage) { //    var startInfo = new ProcessStartInfo { Arguments = String.Format("{0} {1}", _jsPath, url), FileName = _exePath, UseShellExecute = false, CreateNoWindow = true, RedirectStandardOutput = true, RedirectStandardError = true, RedirectStandardInput = true, StandardOutputEncoding = System.Text.Encoding.UTF8 }; Process p = new Process { StartInfo = startInfo }; p.Start(); //  string output = p.StandardOutput.ReadToEnd(); p.WaitForExit(); //    return storage.Put(url, output); } } <br>    _jsPath <br> var resourceWait = 13000, maxRenderWait = 13000; var page = require('webpage').create(), system = require('system'), count = 0, forcedRenderTimeout, renderTimeout; page.viewportSize = { width: 1280, height: 1024 }; function doRender() { console.log(page.content); phantom.exit(); } page.onResourceRequested = function (req) { count += 1; clearTimeout(renderTimeout); }; page.onResourceReceived = function (res) { if (!res.stage || res.stage === 'end') { count -= 1; if (count === 0) { renderTimeout = setTimeout(doRender, resourceWait); } } }; page.open(system.args[1], function (status) { if (status !== "success") { phantom.exit(); } else { forcedRenderTimeout = setTimeout(function () { doRender(); }, maxRenderWait); } }); <br>  <br>          AJAX ,          .      <a href="http://widjer.net/">widjer.net</a> (  DEMO).    url <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8">http://widjer.net/timeline/%23_</a> .   <a href="http://widjer.net/timeline/%2523%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B8%3F_escaped_fragment_%3D">http://widjer.net/timeline/%23_?_escaped_fragment_=</a>     javascript.  ,      .</code> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/219875/">https://habr.com/ru/post/219875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219865/index.html">Features of the development of children's mobile applications. Practical advice</a></li>
<li><a href="../219867/index.html">Mobile phone based laboratory microscope</a></li>
<li><a href="../219869/index.html">Checking the Qt 5 framework</a></li>
<li><a href="../219871/index.html">How we broke docshell.ru</a></li>
<li><a href="../219873/index.html">15 template engines for front-end development</a></li>
<li><a href="../219879/index.html">Startup step by step: team and mentors</a></li>
<li><a href="../219881/index.html">Tizen Developer Lab in St. Petersburg</a></li>
<li><a href="../219889/index.html">Dripstat again</a></li>
<li><a href="../219891/index.html">Continuous integration. The way to ensure reliability and trust in the system</a></li>
<li><a href="../219893/index.html">Removing Whitelist in bios laptops on the example of Lenovo X230</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>