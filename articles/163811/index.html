<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to become a puppeteer or Puppet for beginners</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 This topic opens a series of articles on the use of the Puppet configuration management system. 

 What is a configuration management system...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to become a puppeteer or Puppet for beginners</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><img src="https://habrastorage.org/storage2/5ba/787/81e/5ba78781e2f08ef47f5e69be2f188140.jpeg" alt="image" align="right"><br>  This topic opens a series of articles on the use of the <a href="http://ru.wikipedia.org/wiki/Puppet">Puppet</a> configuration management system. <br><br><h4>  What is a configuration management system? </h4><br>  Suppose you have a fleet of servers that perform various tasks.  As long as the servers are small and you are not growing, you can easily configure each server manually.  Install the OS (maybe automated), add users, install software, enter commands into the console, configure services, edit the configs of your favorite text editors (nanorc, vimrc), set the same DNS server settings on them, install the monitoring system agent, configure syslog for the centralized collection of logs ... In a word, there is a lot of work and it is not particularly interesting. <br><a name="habracut"></a><br>  I truly believe that a good admin is a lazy admin.  He doesn't like to do something a few times.  My first thought is to write a couple of scripts, in which there will be something like: <br><br>  servers.sh <br><pre><code class="bash hljs">servers=<span class="hljs-string"><span class="hljs-string">"server00 server01 server02 server03 server04"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> server <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$servers</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> scp /path/to/job/file/job.sh <span class="hljs-variable"><span class="hljs-variable">$server</span></span>:/tmp/job.sh ssh <span class="hljs-variable"><span class="hljs-variable">$server</span></span> sh /tmp/job.sh <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      job.sh <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash apt-get update apt-get install nginx service nginx start</span></span></code> </pre><br><br>  It seems everything became easy and good.  We need to do something - we write a new script, we launch it.  Changes come to all servers consistently.  If the script is well debugged - everything will be fine.  For the time being. <br><br>  Now imagine that there are more servers.  For example, a hundred.  And the change is long - for example, building something big and scary (for example, a kernel) from sources.  The script will be executed for a hundred years, but this is half the trouble. <br><br>  Imagine that you only need to do this on a specific group of hundreds of servers.  And after two days you need to do another big task on a different server slice.  You will have to rewrite scripts every time and check many times if there are any errors in them, whether it will cause any problems at startup. <br><br>  The worst thing is that in such scripts you describe the <i>actions</i> that need to be performed to bring the system into a certain state, and not the state itself.  So, if the system was originally not in the condition that you assumed, then everything will definitely go wrong.  The Puppet Manifests declaratively describe the required state of the system, and computing how to get to it from the current state is the task of the configuration management system itself. <br><br>  For comparison: the manifesto puppet, performing the same work as a couple of scripts from the beginning of the topic: <br><br>  nginx.pp <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">package</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">latest</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">running</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enable</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">require</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Package</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">'] } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> /^</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">(\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">+)$/ { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  If you use the servers correctly and spend some time on the initial configuration of the configuration management system, you can achieve such a state of the server fleet that you do not need to log in to them to do the work.  All necessary changes will come to them automatically. <br><br><h4>  What is Puppet? </h4><br>  Puppet is a configuration management system.  The architecture is client-server, configs are stored on the server (in terms of puppet, they are called <i>manifests</i> ), clients access the server, get them and apply them.  Puppet is written in the Ruby language, the manifests themselves are written on a special DSL, very similar to Ruby itself. <br><br><h4>  The first steps </h4><br>  Let's forget about clients, servers, their interactions, etc.  Suppose we have only one server on which a bare OS is installed (hereinafter I work in Ubuntu 12.04, for other systems, the actions will be somewhat different). <br><br>  First install the latest version of puppet. <br><br><pre> <code class="bash hljs">wget http://apt.puppetlabs.com/puppetlabs-release-precise.deb dpkg -i puppetlabs-release-precise.deb apt-get update apt-get install puppet puppetmaster</code> </pre><br><br>  Wonderful.  Now we have puppet installed on our system and we can play with it. <br><br><h5>  Hello, world! </h5><br>  Create the first manifest: <br><br>  /tmp/helloworld.pp <br><pre> <code class="ruby hljs">file { <span class="hljs-string"><span class="hljs-string">'/tmp/helloworld'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; present, content =&gt; <span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>, mode =&gt; <span class="hljs-number"><span class="hljs-number">0644</span></span>, owner =&gt; <span class="hljs-string"><span class="hljs-string">'root'</span></span>, group =&gt; <span class="hljs-string"><span class="hljs-string">'root'</span></span> }</code> </pre><br>  And apply it: <br><br><pre> <code class="bash hljs">$ puppet apply helloworld.pp /Stage[main]//File[/tmp/helloworld]/ensure: created Finished catalog run <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.06 seconds</code> </pre><br><div class="spoiler">  <b class="spoiler_title">A little bit about the launch</b> <div class="spoiler_text">  The manifestos in this topic can be applied manually using puppet apply.  However, in subsequent topics, the master-slave configuration (standard for Puppet) will be used for work. </div></div><br>  Now look at the contents of the / tmp / helloworld file.  It will (surprisingly!) Be the string "Hello, world!", Which we asked in the manifest. <br><br>  You can say what you could do with <code>echo "Hello, world!" &gt; /tmp/helloworld</code>  <code>echo "Hello, world!" &gt; /tmp/helloworld</code> , it would be faster, easier, I wouldn‚Äôt have to think, write some terrible manifestos, and in general <s>it‚Äôs nafig that nobody needs</s> is somehow too difficult, but think more seriously.  In fact, it would be necessary to write <code>touch /tmp/helloworld &amp;&amp; echo "Hello, world!" &gt; /tmp/helloworld &amp;&amp; chmod 644 /tmp/helloworld &amp;&amp; chown root /tmp/helloworld &amp;&amp; chgrp root /tmp/helloworld</code>  <code>touch /tmp/helloworld &amp;&amp; echo "Hello, world!" &gt; /tmp/helloworld &amp;&amp; chmod 644 /tmp/helloworld &amp;&amp; chown root /tmp/helloworld &amp;&amp; chgrp root /tmp/helloworld</code> to ensure the same result. <br><br>  Let's sort through the lines exactly what is contained in our manifest: <br><br>  /tmp/helloworld.pp <br><pre> <code class="ruby hljs">file { <span class="hljs-string"><span class="hljs-string">'/tmp/helloworld'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; present, <span class="hljs-comment"><span class="hljs-comment">#    content =&gt; 'Hello, world!', #      "Hello, world!" mode =&gt; 0644, #    - 0644 owner =&gt; 'root', #   - root group =&gt; 'root' #   - root }</span></span></code> </pre><br><br>  In terms of Puppet, a <i>resource of the</i> type <i>file</i> named (title) <i>/ tmp / helloworld is described here</i> . <br><br><h5>  Resources </h5><br>  A resource is the smallest unit of abstraction in Puppet.  Resources can be: <br><ul><li>  files; </li><li>  packages (Puppet supports package systems of many distributions); </li><li>  Services; </li><li>  users; </li><li>  groups; </li><li>  cron tasks; </li><li>  etc. </li></ul><br>  Resource syntax you can spy on <a href="http://docs.puppetlabs.com/puppet/3/reference/lang_resources.html">in the documentation</a> . <br><br>  Puppet has the ability to add your own resources.  Therefore, if you thoroughly get stuck, you can roll up to manifestos like: <br><br>  webserver.pp <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> webserver; webserver::vhost { <span class="hljs-string"><span class="hljs-string">'example.com'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; present, size =&gt; <span class="hljs-string"><span class="hljs-string">'1G'</span></span>, php =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>, https =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre><br>  Puppet will then create a logical volume of 1 GiB on the server, mount it where necessary (for example, in /var/www/example.com), add the necessary entries to fstab, create the necessary virtual hosts in nginx and apache, restart both daemons, add example.com to ftp and sftp with password mySuperSecretPassWord with write access to this virtual host. <br><br>  Yummy?  Not that word! <br><br>  Moreover, the most delicious, in my opinion, is not the automation of routine.  If you are an idiot, for example, and are constantly rebuilding your servers in production, Puppet will allow you to pick up an old lovingly created set of packages and configs from scratch in fully automatic mode.  You simply install the Puppet agent, connect it to your Puppet master and wait.  Everything will come by itself.  On the server, the packages will appear magically (no, really magically!), Your ssh-keys will be decomposed, the firewall will be installed, the individual bash settings will come, the networks will be installed and all the software you have prudently installed using Puppet will be installed and configured. <br>  In addition, Puppet, when you try, allows you to get a self-documenting system, because the configuration (manifests) themselves are the backbone of the documentation.  They are always relevant (they are already working), there are no errors in them (you check your settings before launching), they are minimally detailed (it works the same). <br><br><h5>  Some more magic </h5><br><br><div class="spoiler">  <b class="spoiler_title">A bit about cross-distribution</b> <div class="spoiler_text">  Puppet has the ability to use cross-distributive manifests, this is one of the purposes for which it was created.  I deliberately never used it and do not recommend it to you.  The server park should be as homogeneous as possible in terms of system software, this allows not to think at critical moments ‚Äúiblin, here <br>  rc.d, but not init.d ‚Äù(a curtsey in the direction of ArchLinux) and in general allows you to think less about routine tasks. </div></div><br><br>  Many resources depend on other resources.  For example, for the resource ‚Äússhd service‚Äù you need the resource ‚Äússhd package‚Äù and optionally ‚Äússhd config‚Äù <br>  Let's see how this is implemented: <pre> <code class="ruby hljs">file { <span class="hljs-string"><span class="hljs-string">'sshd_config'</span></span>: path =&gt; <span class="hljs-string"><span class="hljs-string">'/etc/ssh/sshd_config'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; file, content =&gt; <span class="hljs-string"><span class="hljs-string">"Port 22 Protocol 2 HostKey /etc/ssh/ssh_host_rsa_key HostKey /etc/ssh/ssh_host_dsa_key HostKey /etc/ssh/ssh_host_ecdsa_key UsePrivilegeSeparation yes KeyRegenerationInterval 3600 ServerKeyBits 768 SyslogFacility AUTH LogLevel INFO LoginGraceTime 120 PermitRootLogin yes StrictModes yes RSAAuthentication yes PubkeyAuthentication yes IgnoreRhosts yes RhostsRSAAuthentication no HostbasedAuthentication no PermitEmptyPasswords no ChallengeResponseAuthentication no X11Forwarding yes X11DisplayOffset 10 PrintMotd no PrintLastLog yes TCPKeepAlive yes AcceptEnv LANG LC_* Subsystem sftp /usr/lib/openssh/sftp-server UsePAM yes"</span></span>, mode =&gt; <span class="hljs-number"><span class="hljs-number">0644</span></span>, owner =&gt; root, group =&gt; root, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; Package[<span class="hljs-string"><span class="hljs-string">'sshd'</span></span>] } package { <span class="hljs-string"><span class="hljs-string">'sshd'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; latest, name =&gt; <span class="hljs-string"><span class="hljs-string">'openssh-server'</span></span> } service { <span class="hljs-string"><span class="hljs-string">'sshd'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; running, enable =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>, name =&gt; <span class="hljs-string"><span class="hljs-string">'ssh'</span></span> subscribe =&gt; File[<span class="hljs-string"><span class="hljs-string">'sshd_config'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> =&gt; Package[<span class="hljs-string"><span class="hljs-string">'sshd'</span></span>] }</code> </pre><br><br>  It uses inline config, which makes the manifesto ugly.  In fact, this is almost never done, there is an ERB-based template mechanism and the ability to simply use external files.  But we are not interested. <br><br>  The most delicious lines here are the dependency lines - require and subscribe. <br><br>  Puppet supports many dependency descriptions.  Details, as always, can be read in the <a href="http://docs.puppetlabs.com/puppet/3/reference/lang_relationships.html">documentation</a> . <br><br><ul><li>  <b>Require</b> means exactly what is expected.  If resource A depends (require) on resource B, then Puppet will first process resource B, and then return to resource A. </li><li>  <b>Subscribe</b> gives a little more tricky behavior.  If resource A is subscribed to resource B, then Puppet will first process resource B, and then return to resource A (behavior as require), and then as B changes, it will be processed again A. This is very convenient for creating services that depend from their configs (as in the example above).  If the config changes, the server is restarted, no need to worry about it yourself. </li></ul><br><br>  There are also <b>notify</b> , <b>before</b> , but we will not touch them here.  Interested - in the already mentioned <a href="http://docs.puppetlabs.com/puppet/3/reference/lang_relationships.html">documentation</a> . <br><br><h4>  Total </h4><br>  At the moment we have already learned how to write simple manifests indicating the dependencies between resources.  Very many simple demons fall into the ‚Äúpackage-config-service‚Äù model, so even in this form, puppet is already suitable for use. <br>  Subsequent topics will describe how to use more powerful puppet features when creating a spherical LAMP hosting in a vacuum (if there are other ideas of a spherical project for training - welcome to the PM or in the comments). <br><br><h4>  Related Links </h4><br><ul><li>  <a href="http://docs.puppetlabs.com/puppet/3/reference/">Documentation</a> </li><li>  <a href="http://puppetlabs.com/">Official site</a> </li><li>  <a href="http://projects.puppetlabs.com/projects/1/wiki/Puppet_Patterns">Template collection</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/Puppet">Wikipedia</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/163811/">https://habr.com/ru/post/163811/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163791/index.html">Game Patcher Development</a></li>
<li><a href="../163793/index.html">Ultrabook Review MicroXperts MXP U400</a></li>
<li><a href="../163795/index.html">Writing your Xcode plugin</a></li>
<li><a href="../163797/index.html">Manifesto of free information space</a></li>
<li><a href="../163807/index.html">Facebook? Twitter? Instagram? We all did it 40 years ago.</a></li>
<li><a href="../163813/index.html">Introduction to the development of WinRT applications in HTML / JavaScript. Styling applications</a></li>
<li><a href="../163815/index.html">New IBM programs for students and IT professionals</a></li>
<li><a href="../163817/index.html">Gold and silicon fever - what is common?</a></li>
<li><a href="../163819/index.html">Pre-training of the neural network using a limited Boltzmann machine</a></li>
<li><a href="../163821/index.html">EBay data center and adiabatic wetting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>