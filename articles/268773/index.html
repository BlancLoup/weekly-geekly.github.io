<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Imitation of the radio using Freeswitch and a little about voip-conference</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It even happens that you need to make such a monster like the Freeswitch work on the principle of a normal walkie-talkie. 
 One says everyone is liste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Imitation of the radio using Freeswitch and a little about voip-conference</h1><div class="post__text post__text-html js-mediator-article">  It even happens that you need to make such a monster like the Freeswitch work on the principle of a normal walkie-talkie. <br>  One says everyone is listening. <br><br>  And the NodesJs and npm modesl module will help us with this to interact with Freeswitch. <br><br><img src="https://habrastorage.org/files/f61/91d/6ef/f6191d6ef9764269be9310ca4e034cc5.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  At some point in our organization in a large wireless project, the customer needed to emulate the behavior of the radio over voip telephony.  The basis of the system was taken Freeswitch.  In general, the communication system is organized on the basis of a mesh network and, accordingly, there is no centralized server; each node has its own Freeswitch instance, which is responsible for different voice scenarios. <br><br><h2>  Task </h2><br>  In the radio, as is well known, everything is very simple: one says and everyone listens, which is what is required to be realized.  It is also necessary to make a conference call for several independent groups, and any subscriber can simultaneously be in several of them.  And of course the network should be address calls. <br>  Available: <br><br><ul><li>  <a href="https://freeswitch.org/">Freeswitch</a> is a user agent, which with the correct selection of modules can even make coffee. </li><li>  <a href="https://www.npmjs.com/package/modesl">modesl</a> - npm module for interacting with Freeswitch using the <a href="https://wiki.freeswitch.org/wiki/Event_Socket_Library">Event Socket Library</a> . </li><li>  <a href="https://freeswitch.org/confluence/display/FREESWITCH/mod_conference">mod_conference</a> - FS module for creating and working with voice conferences. </li><li>  <a href="https://freeswitch.org/confluence/display/FREESWITCH/mod_sofia">mod_sofia</a> - FS module for working with SIP. </li></ul><br><br><h2>  General scheme </h2><br>  The logic is of course strange and confusing, but once the customer asks, it must be done.  The approximate structure looks like this: <br><div class="spoiler">  <b class="spoiler_title">The overall structure of voice communications.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/dcb/eda/1b0/dcbeda1b0d064b32b688329bb5a5307b.png"></div></div><br>  <b>Sip client</b> - it can be both <a href="https://freeswitch.org/confluence/display/FREESWITCH/mod_portaudio">mod_portaudio</a> and linphone or for example baresip. <br><br>  <b>Local Conference</b> is an internal conference for each node, the task of which is to support the cunning logic of working with the emulation of the radio and switching between global conferences. <br><br>  <b>Global Conference</b> is a general conference, there may be several of them, which will allow to unite different users into different groups. <br><br><h2>  Training </h2><br><h3>  How to connect modesl </h3><br>  You can connect modesl as follows: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> esl = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">"modesl"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localServer = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localServerPort = <span class="hljs-number"><span class="hljs-number">8021</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localServerUser = <span class="hljs-string"><span class="hljs-string">"ClueCon"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionCallback = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   connection.on( "esl::end", function( event) { //  ,    }); } //  var connection = new esl.Connection( localServer, localServerPort, localServerUser, connectionCallback); connection.once( "error", function() { //   });</span></span></code> </pre> <br><br>  Connection capabilities in modesl: <br><ul><li>  Subscribe to Freeswitch events.  Here, for example, subscribe to all events: <pre> <code class="javascript hljs">connection.on( <span class="hljs-string"><span class="hljs-string">"esl::event::**"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> event</span></span></span><span class="hljs-function">) </span></span>{});</code> </pre> </li><li>  Synchronous call of the Freeswitch command <pre> <code class="javascript hljs">Connection.prototype.api = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command, args, cb</span></span></span><span class="hljs-function">)</span></span></code> </pre> </li><li>  Asynchronous call to the Freeswitch command <pre> <code class="javascript hljs">Connection.prototype.bgapi = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command, args, jobid, cb</span></span></span><span class="hljs-function">)</span></span></code> </pre> </li></ul><br><br><h3>  How to work with conferences in Freeswitch </h3><br>  You can create a conference simply by registering everything in xml configs, or you can do this by transferring all control from a xml configs to a specific address and port.  We will choose the 2nd option. <br>  In the Freeswitch configurations in the dialplan / public.xml file you need to write something like: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"conference_server"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"destination_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(5555)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"socket"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"127.0.0.1:8087 async full"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  This means that if they call 5555, then redirect control to 127.0.0.1:8087. <br>  You should also write a script to create a conference: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> esl = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'modesl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> esl_server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> esl.Server({<span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">8087</span></span>, <span class="hljs-attr"><span class="hljs-attr">myevents</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"ConferenceServer server is up"</span></span>); }); esl_server.on( <span class="hljs-string"><span class="hljs-string">'connection::ready'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conn, id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'ConferenceServer new call'</span></span>, id); conn.execute( <span class="hljs-string"><span class="hljs-string">'conference'</span></span>, <span class="hljs-string"><span class="hljs-string">'ConfName@default'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> err, result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }); conn.on(<span class="hljs-string"><span class="hljs-string">'esl::end'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> evt, body</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">"ConferenceServer call ended "</span></span>, id); }); });</code> </pre><br><br><h2>  Implementation </h2><br><h3>  Entry to the conference </h3><br>  Initially, when the node starts, the call to the local conference occurs.  To enter one of the global conferences, the node makes a call from the Local Conference to the Global Conference.  In Freeswitch, you can do <a href="https://wiki.freeswitch.org/wiki/Mod_conference">this</a> : <br>  fs_cli <br><pre> <code class="bash hljs">conference [conference name] dial sofia/internal/[sip address]</code> </pre><br>  nodejs <br><pre> <code class="javascript hljs"> self.dial = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sipAddress, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" dial sofia/internal/"</span></span> + sipAddress, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultId = result.getBody().indexOf( <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( resultId == <span class="hljs-number"><span class="hljs-number">-1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = result.getBody(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startIndex = body.indexOf( <span class="hljs-string"><span class="hljs-string">'['</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = body.substring( startIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, body.length - <span class="hljs-number"><span class="hljs-number">2</span></span>); callbackHelper.call( callback, <span class="hljs-string"><span class="hljs-string">"Conference call error: "</span></span> + result); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); };</code> </pre><br>  This is a very interesting and convenient function that allows you to combine different conferences into one. <br>  Then we do a deaf for this Global Conference inside the Local Conference (this allows us to ensure that the different global conferences that the node is in do not hear each other). <br>  You can do it <a href="https://wiki.freeswitch.org/wiki/Mod_conference">like this</a> : <br>  fs_cli <br><pre> <code class="bash hljs">conference [conference name] deaf [memberId]</code> </pre><br>  nodejs <br><pre> <code class="javascript hljs"> self.deaf = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" deaf "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); };</code> </pre><br>  Where memberId comes from, you can get it by subscribing to the <b>conference_add_member</b> event <br><br><h3>  Conversation </h3><br>  At each node before the start of a conversation, the Local Conference has the following form: <br><div class="spoiler">  <b class="spoiler_title">The state of the local conference.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a32/309/739/a32309739bf446cc831dfd080b974f89.png"></div></div><br>  The node hears everyone, and global conferences do not hear each other. <br>  When a node needs to say something in one of the global conferences, you must first make everyone a participant except yourself a <a href="https://wiki.freeswitch.org/wiki/Mod_conference">mute</a> .  This is done simply by running through the list of participants with this function. <br><pre> <code class="javascript hljs"> self.mute = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" mute "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); };</code> </pre>  . <br>  Then you need to do <a href="https://wiki.freeswitch.org/wiki/Mod_conference">undeaf</a> for that global conference where the node will talk <br><pre> <code class="javascript hljs"> self.undeaf = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" undeaf "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); };</code> </pre>  . <br>  As a result, we obtain the following schematically: <br><div class="spoiler">  <b class="spoiler_title">The scheme at the time of conversation.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/93f/f42/55e/93ff4255e73e4aceb89e0fb3d5db8b05.png"></div></div><br><br>  Since all global conferences have a mute made, the active global conference (the one that is made undeaf) will not be heard by others.  When the conversation ends we will return everything to its former state. <br><br><div class="spoiler">  <b class="spoiler_title">This is how you can summarize the code for working with conference participants.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FsConferenceAPI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> connection</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; self.connection = connection; self.unmuteAll = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" unmute all"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{}); }; self.dial = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sipAddress, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" dial sofia/internal/"</span></span> + sipAddress, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultId = result.getBody().indexOf( <span class="hljs-string"><span class="hljs-string">"SUCCESS"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( resultId == <span class="hljs-number"><span class="hljs-number">-1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = result.getBody(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startIndex = body.indexOf( <span class="hljs-string"><span class="hljs-string">'['</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = body.substring( startIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, body.length - <span class="hljs-number"><span class="hljs-number">2</span></span>); callbackHelper.call( callback, <span class="hljs-string"><span class="hljs-string">"Conference call error: "</span></span> + result); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }; self.kick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" kick "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = result.getBody(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( body.indexOf( <span class="hljs-string"><span class="hljs-string">"OK kicked "</span></span> + memberId) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callbackHelper.call( callback, body); }); }; self.kickAll = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" kick all"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = result.getBody(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( body.indexOf( <span class="hljs-string"><span class="hljs-string">"OK kicked"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> callbackHelper.call( callback, body); }); }; self.deaf = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" deaf "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }; self.undeaf = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" undeaf "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }; self.mute = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" mute "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }; self.unmute = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> conferenceName, memberId, callback</span></span></span><span class="hljs-function">)</span></span>{ self.connection.bgapi( <span class="hljs-string"><span class="hljs-string">"conference"</span></span>, conferenceName + <span class="hljs-string"><span class="hljs-string">" unmute "</span></span> + memberId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> result</span></span></span><span class="hljs-function">)</span></span>{ callbackHelper.call( callback, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }; }</code> </pre></div></div><br><br>  Now that all the basic functionality is ready, it is enough to write a high-level logic of operation.  But this is a topic for a separate article :). <br><br><h2>  findings </h2><br><br>  The scheme turned out quite large and confusing. <br>  You can solve this problem without using local conferences for each node, but you will have to make address calls to all global conferences in which we want to participate.  In this case, we will encounter another problem: the sip client should not put calls on hold and it will be necessary to use switching between active calls.  This scheme will also have its pros and cons. <br>  An important conclusion is that Freeswitch is a unique tool that allows you to implement a wide variety of voice work schemes. </div><p>Source: <a href="https://habr.com/ru/post/268773/">https://habr.com/ru/post/268773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268763/index.html">Parallel execution of dependent tasks and synchronization with conditional variables in the shell</a></li>
<li><a href="../268765/index.html">Back to the Code - Contest Report</a></li>
<li><a href="../268767/index.html">Deploying Applications in InterSystems Cach√©</a></li>
<li><a href="../268769/index.html">MiML2</a></li>
<li><a href="../268771/index.html">Using web fonts, the best way (for 2015)</a></li>
<li><a href="../268777/index.html">DevTips: Web Developer Tips (17-32)</a></li>
<li><a href="../268781/index.html">Multithreading in Unity by means of reactive extensions</a></li>
<li><a href="../268785/index.html">Installing a white certificate on a Microsoft VDI farm</a></li>
<li><a href="../268787/index.html">Features of software and hardware firewalls</a></li>
<li><a href="../268789/index.html">HackedSim. Call from any number - fiction or reality?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>