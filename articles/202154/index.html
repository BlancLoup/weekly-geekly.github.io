<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Copy-Paste and muons</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now I will tell and show by examples why physicists should also use static code analysis tools. I would like this tool to be PVS-Studio. But, of cours...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Copy-Paste and muons</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/1b3/960/47c/1b396047c51eb8505b6ebda89af263fe.png" alt="PVS-Studio, CERN"><br><br>  Now I will tell and show by examples why physicists should also use static code analysis tools.  I would like this tool to be PVS-Studio.  But, of course, any other tool will also be useful.  Code analyzer will reduce the time for debugging applications and reduce headaches from blunt errors.  It is better to think more about physics and less about errors in C ++ programs. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Sad background </h2><br>  In fact, this article was ‚Äúby‚Äù.  Even the one who searches for others' mistakes makes mistakes.  :) <br><br>  <b>I overlooked.</b>  <b>I have instructed to prepare a Geant4 project for testing a new young employee.</b>  <b>It was necessary to download the source code, generate a project for Visual Studio and generally do everything necessary so that I could take and check.</b>  <b>He did it all.</b>  <b>I just took the first available ancient version of Geant4_9_4, which was described in the article about building the project in Windows.</b>  <b>Eh!</b>  <b>I learned about it when I wrote this article.</b> <br><br>  <b>However, this has a positive side.</b>  <b>I wrote a new article, <a href="http://habrahabr.ru/company/pvs-studio/blog/202158/"><b>Continuing the Geant4 Review</b></a> , where we analyze the <a href="http://habrahabr.ru/company/pvs-studio/blog/202158/"><b>latest</b></a> source code (version 10.0-beta).</b>  <b>Now you can find out which errors were corrected, which means that they could be found much earlier and easier with the help of static analysis.</b>  <b>And you can see the errors that are still hiding.</b> <br><br>  <b>Of the sixteen warnings listed in the article in the new version:</b> <ul><li>  <b>disappeared: 6</b> </li><li>  <b>10 left</b> </li></ul>  So, although this article is not relevant, it shows very well the capabilities of the PVS-Studio code analyzer.  It is not so important that the old project is verified.  It is important how many errors can be avoided at the stage of writing the code. <br><br><h2>  Introduction </h2><br>  I continue a series of notes on analyzing the code used for scientific purposes.  Previous notes: <ul><li>  <a href="http://www.viva64.com/ru/b/0212/">Big Calculator is out of control</a> </li><li>  <a href="http://www.viva64.com/ru/b/0213/">We go for mushrooms after Cppcheck</a> </li></ul>  This time on turn the project Geant4.  I will give a description of the project, <a href="http://www.viva64.com/go.php%3Furl%3D1317">taken from Wikipedia</a> : <br><br>  <b><i>Geant4</i></b> <i>(eng. GEometry ANd Tracking - geometry and tracking) is a program for simulating the passage of elementary particles through matter using Monte Carlo methods.</i>  <i>Developed at CERN in the object-oriented programming language C ++.</i>  <i>It is a further development of previous versions of GEANT, substantially reworked and expanded.</i> <br><br>  <i>As stated on the project‚Äôs official website, ‚Äúthe areas of application include high energy physics and nuclear reaction research, medicine, particle accelerators, and space physical research.‚Äù</i>  <i>The software is used in many research projects around the world.</i> <br><br>  Project website: <a href="http://geant4.org/">http://geant4.org</a> .  The project has an average size: 76 megabytes of source code.  For comparison: <ul><li>  VirtualDub project - 13 megabytes; </li><li>  Apache HTTP Server project - 26 megabytes; </li><li>  Chromium project (along with additional libraries) - 710 megabytes. </li></ul>  For the analysis, the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> code analyzer was used.  Since the Geant4 project is not small, the chance to find something interesting in it was very large.  No errors can be found only in small projects (see <a href="http://www.viva64.com/ru/b/0158/">the non-linear error density</a> ).  Of course, there are also large projects where PVS-Studio does not find anything.  It is a pity, but this is only an exception. <br><br>  I want to apologize right away if I accidentally wrote some nonsense about physics.  But note that I was able to find software errors without understanding the essence of partons, and indeed almost everything related to nuclear reactions! <br><br>  <b><i>Note.</i></b>  <b><i>The article lists not all that was able to notice.</i></b>  <b><i>A more complete list of warnings that I noticed: <a href="http://www.viva64.com/external-pictures/txt/geant4_old.txt"><i>geant4_old.txt</i></a> .</i></b> <br><br>  Let's see what we managed to find interesting in the Geant4 code. <br><br><h2>  Copy-Paste and muons </h2><br>  About <a href="http://www.viva64.com/go.php%3Furl%3D1309">muons,</a> I only know that this is an elementary particle.  But I understand much better what Copy-Paste is.  Here is a beautiful example of an error when a line of code has been propagated.  The copied lines have been modified, but not everywhere.  Result: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4QMessenger::SetNewValue(G4UIcommand* aComm, G4String aS) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(photoDir) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aComm==theSynchR) thePhoto-&gt;SetSynchRadOnOff(aS); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==minGamSR) thePhoto-&gt;SetMinGammaSR(.... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==theGamN) thePhoto-&gt;SetGammaNuclearOnOff(.... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==theMuoN) thePhoto-&gt;SetElPosNuclearOnOff(.... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==theMuoN) thePhoto-&gt;SetMuonNuclearOnOff(aS); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==theMuoN) thePhoto-&gt;SetTauNuclearOnOff(aS); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aComm==biasPhotoN)thePhoto-&gt;SetPhotoNucBias(.... } .... }</code> </pre> <br>  PVS-Studio warning: V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 195, 196. G4phys_builders g4qmessenger.cc 195 <br><br>  Note the repeating check three times (aComm == theMuoN). <br><br>  <b>Note.</b>  <b>Bug fixed in new version of Gint4.</b>  <b>Or this code is deleted.</b> <br><br><h2>  Decay of baryons </h2><br>  It is difficult to study radioactive decay or try to detect the <a href="http://www.viva64.com/go.php%3Furl%3D1316">proton decay</a> .  This is especially difficult to do when programs contain errors. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4QEnvironment::DecayBaryon(G4QHadron* qH) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(qM&lt;mSzPi) <span class="hljs-comment"><span class="hljs-comment">// Only Lambda+PiM is possible { fQPDG=lQPDG; // Baryon is Lambda fMass=mLamb; sQPDG=pimQPDG; // Meson is Pi- sMass=mPi; } else if(qM&lt;mSzPi) // Both Lambda+PiM &amp; Sigma0+PiM are possible { if(G4UniformRand()&lt;.6) { .... }</span></span></code> </pre> <br>  PVS-Studio warning: V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 8373, 8380. G4hadronic_body_ci g4qenvironment.cc 8373 <br><br>  The same condition is used twice (qM &lt;mSzPi).  This means that we will never get into the branch to which the comment "// Both Lambda + PiM &amp; Sigma0 + PiM are possible". <br><br>  <b>Note.</b>  <b>Bug fixed in new version of Gint4.</b>  <b>Or this code is deleted.</b> <br><br><h2>  Calculate the number of partons </h2><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1310">Parton</a> is a point-like component of hadrons, which is manifested in experiments on deep inelastic scattering of hadrons on leptons and other hadrons. <br><br>  It is a pity, but there is a problem with counting their number: <br><pre> <code class="cpp hljs">G4bool G4CollisionMesonBaryonElastic:: IsInCharge(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk1, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk2) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { G4bool result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; G4ParticleDefinition * p1 = trk1.GetDefinition(); G4ParticleDefinition * p2 = trk2.GetDefinition(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( (GetNumberOfPartons(p1) != <span class="hljs-number"><span class="hljs-number">2</span></span> || GetNumberOfPartons(p2) != <span class="hljs-number"><span class="hljs-number">3</span></span>) ||(GetNumberOfPartons(p1) != <span class="hljs-number"><span class="hljs-number">3</span></span> || GetNumberOfPartons(p2) != <span class="hljs-number"><span class="hljs-number">2</span></span>) ) { result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  G4had_im_r_matrix g4collisionmesonbaryonelastic.cc 53 <br><br>  Immediately the essence of the error may be invisible.  Therefore, I will simplify the expression: <br><pre> <code class="cpp hljs">A = GetNumberOfPartons(p1); B = GetNumberOfPartons(p2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (A != <span class="hljs-number"><span class="hljs-number">2</span></span> || B != <span class="hljs-number"><span class="hljs-number">3</span></span>) || (A != <span class="hljs-number"><span class="hljs-number">3</span></span> || B != <span class="hljs-number"><span class="hljs-number">2</span></span>) )</code> </pre> <br>  Brackets for simplicity can also be discarded.  We get: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( A != <span class="hljs-number"><span class="hljs-number">2</span></span> || B != <span class="hljs-number"><span class="hljs-number">3</span></span> || A != <span class="hljs-number"><span class="hljs-number">3</span></span> || B != <span class="hljs-number"><span class="hljs-number">2</span></span> )</code> </pre> <br>  This condition is always true.  The variable 'A' is always not equal to 2 or not equal to 3. Similarly to the variable 'B'.  Apparently, there was confusion somewhere.  Most likely, the '&amp;&amp;' operator should be present here. <br><br>  <b>Note.</b>  <b>Bug fixed in new version of Gint4.</b>  <b>Or this code is deleted.</b> <br><br><h2>  Coulomb blockade and going beyond the boundaries of the array </h2><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1311">Coulomb blockade</a> - blocking the passage of electrons through a quantum dot connected between two tunneling contacts, due to the repulsion of electrons in the contacts from the electron at the point, as well as an additional Coulomb potential barrier, which creates an electron, sitting at the point. <br><br>  There is something wrong with the SetCoulombEffects () function.  The array of pointers 'sig' contains the addresses of nonexistent subarrays.  Working with 'sig' will lead to undefined program behavior.  Well, if the program ends in emergency mode.  It is much worse if the program continues and randomly reads and writes into memory occupied by other arrays and variables. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { NENERGY=<span class="hljs-number"><span class="hljs-number">22</span></span>, NANGLE=<span class="hljs-number"><span class="hljs-number">180</span></span> }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">G4LEpp</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> G4HadronicInteraction { .... G4float * sig[NANGLE]; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> G4float SigCoul[NENERGY][NANGLE]; .... }; G4LEpp::SetCoulombEffects(G4int State) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (State) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(G4int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;NANGLE; i++) { sig[i] = SigCoul[i]; } elab = ElabCoul; } .... }</code> </pre> <br>  PVS-Studio warning: V557 Array overrun is possible.  The value of 'i' index could reach 179. g4lepp.cc 62 <br><br>  The 'sig' array contains 180 pointers.  These pointers should reference the different lines of the two-dimensional 'SigCoul' array.  But in the array 'SigCoul' only 22 lines.  It turns out that most of the pointers in the 'sig' array will indicate incomprehensibly where. <br><br>  It is difficult to say exactly what the error is.  The SigCoul array may have been incorrectly declared.  For example, you need to swap the number of rows and columns: <br><br>  SigCoul [NENERGY] [NANGLE] - &gt;&gt; SigCoul [NANGLE] [NENERGY] <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Typo and Twist Surfaces </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4VTwistSurface::GetBoundaryLimit(G4int areacode, G4double limit[]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (areacode &amp; sC0Min1Max) { limit[<span class="hljs-number"><span class="hljs-number">0</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">0</span></span>]; limit[<span class="hljs-number"><span class="hljs-number">1</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (areacode &amp; sC0Max1Min) { limit[<span class="hljs-number"><span class="hljs-number">0</span></span>] = fAxisMax[<span class="hljs-number"><span class="hljs-number">0</span></span>]; limit[<span class="hljs-number"><span class="hljs-number">1</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (areacode &amp; sC0Max1Max) { limit[<span class="hljs-number"><span class="hljs-number">0</span></span>] = fAxisMax[<span class="hljs-number"><span class="hljs-number">0</span></span>]; limit[<span class="hljs-number"><span class="hljs-number">1</span></span>] = fAxisMax[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (areacode &amp; sC0Min1Max) { limit[<span class="hljs-number"><span class="hljs-number">0</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">0</span></span>]; limit[<span class="hljs-number"><span class="hljs-number">1</span></span>] = fAxisMax[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } .... }</code> </pre> <br>  PVS-Studio warning: V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 793, 802. G4specsolids g4vtwistsurface.cc 793 <br><br>  There are 4 variables: <ul><li>  sC0Min1Max </li><li>  sC0Max1Min </li><li>  sC0Min1Min </li><li>  sC0Max1Max </li></ul>  When working with borders, only 3 of them are used.  The check (areacode &amp; sC0Min1Max) is performed 2 times.  If you take a closer look, you can see that after the first check the minimums are selected: fAxisMin [0], fAxisMin [1].  Most likely, the first check should have been like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (areacode &amp; sC0Min1Min) { limit[<span class="hljs-number"><span class="hljs-number">0</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">0</span></span>]; limit[<span class="hljs-number"><span class="hljs-number">1</span></span>] = fAxisMin[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } &lt;b&gt;.      Gint4.    .&lt;/b&gt;</code> </pre> <br><h2>  X-rays and irregular IF </h2><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1312">X-rays</a> are electromagnetic waves whose photon energy lies on the scale of electromagnetic waves between ultraviolet radiation and gamma radiation. <br><br>  As I understand it, the G4ForwardXrayTR class is related to X-Ray.  Error crept into index comparison. <br><pre> <code class="cpp hljs">G4VParticleChange* G4ForwardXrayTR::PostStepDoIt(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iMat == jMat || ( (fMatIndex1 &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; fMatIndex1 &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; ( iMat != fMatIndex1 &amp;&amp; iMat != fMatIndex2 ) &amp;&amp; ( jMat != fMatIndex1 &amp;&amp; jMat != fMatIndex2 ) ) .... }</code> </pre> <br>  PVS-Studio warning: V501 operator: fMatIndex1&gt; = 0 &amp;&amp; fMatIndex1&gt; = 0 G4xrays g4forwardxraytr.cc 620 <br><br>  An index with the name 'fMatIndex1' is checked twice.  And about 'fMatIndex2' forgotten.  Probably should be written like this: <br><pre> <code class="cpp hljs">(fMatIndex1 &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; fMatIndex2 &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Typo and neutrons </h2><br><pre> <code class="cpp hljs">G4double G4MesonAbsorption:: GetTimeToAbsorption( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk1, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk2) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(( trk1.GetDefinition() == G4Neutron::Neutron() || trk1.GetDefinition() == G4Neutron::Neutron() ) &amp;&amp; sqrtS&gt;<span class="hljs-number"><span class="hljs-number">1.91</span></span>*GeV &amp;&amp; pi*distance&gt;maxChargedCrossSection) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> time; .... }</code> </pre> <br>  PVS-Studio warning: V501 There are identical sub-expressions 'trk1.GetDefinition () == G4Neutron :: Neutron ()'  operator.  G4had_im_r_matrix g4mesonabsorption.cc 285 <br><br>  Yes, I do not know what this function does.  But, as it seems to me, at the entrance it receives two trajectories of the movement of elementary particles.  The function must handle the situation in a special way if at least one particle is a neutron.  But, in fact, only the first particle is checked. <br><br>  Apparently, in fact, they planned to write: <br><pre> <code class="cpp hljs">trk1.GetDefinition() == G4Neutron::Neutron() || trk2.GetDefinition() == G4Neutron::Neutron()</code> </pre> <br>  A similar typo can be found here: g4scatterer.cc 138 <br><br>  <b>Note.</b>  <b>Bug fixed in new version of Gint4.</b>  <b>Or this code is deleted.</b> <br><br><h2>  Adding parton </h2><br>  There is a InsertParton () function that inserts a parton into a container.  You can specify after which parton to insert a new element.  If the insertion point is not specified, then you can probably insert it anywhere.  But just this case is implemented incorrectly. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;G4Parton *&gt; G4PartonVector; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4ExcitedString::InsertParton( G4Parton *aParton, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4Parton * addafter) { G4PartonVector::iterator insert_index; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( addafter != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) { insert_index=<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::find(thePartons.begin(), thePartons.end(), addafter); .... } thePartons.insert(insert_index+<span class="hljs-number"><span class="hljs-number">1</span></span>, aParton); }</code> </pre> <br>  PVS-Studio warning: V614 Potentially uninitialized iterator 'insert_index' used.  g4excitedstring.hh 193 <br><br>  If the 'addafter' pointer is zero, then the ‚Äúinsert_index‚Äù iterator remains uninitialized.  As a result, the insertion of a new element can lead to unpredictable consequences. <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Processing not all nucleons </h2><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1313">Nucleons</a> are the common name for protons and neutrons. <br><br>  There is a packNucleons () function that does not handle all items.  The fact is that the loop ends immediately after the first iteration.  At the end of the loop body there is a 'break' operator, but there is no 'continue' operator anywhere. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4QMDGroundStateNucleus::packNucleons() { .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( nmTry &lt; maxTrial ) { nmTry++; G4int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i = <span class="hljs-number"><span class="hljs-number">1</span></span> ; i &lt; GetMassNumber() ; i++ ) { .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( i == GetMassNumber() ) { areTheseMsOK = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V612 An unconditional 'break' within a loop.  g4qmdgroundstatenucleus.cc 274 <br><br>  It seems to me that the 'break' statement at the end is just superfluous and written by chance. <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Lund string model and typo in the index </h2><br>  This is a phenomenological model of hadronization. <br><br>  When you have to work with individual elements of arrays, it is very easy to make a typo.  This is exactly what happened in the constructor of the G4LundStringFragmentation class.  In the code below, the error is immediately visible.  Twice we assign values ‚Äã‚Äãto the same cell.  However, this is a very large function, where many elements of the array are initialized.  And to notice the error, considering the function, is an extremely difficult task.  This is the case where <a href="http://www.viva64.com/ru/t/0046/">static code analysis is</a> simply indispensable. <br><pre> <code class="cpp hljs">G4LundStringFragmentation::G4LundStringFragmentation() { .... BaryonWeight[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>]=pspin_barion*<span class="hljs-number"><span class="hljs-number">0.5</span></span>; .... BaryonWeight[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">2</span></span>]=(<span class="hljs-number"><span class="hljs-number">1.</span></span>-pspin_barion); .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'BaryonWeight [0] [1] [2] [2]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 205, 208. g4lundstringfragmentation.cc 208 <br><br>  <b>Note</b>  I want to note that in the code I have met many places where a variable is assigned two different values ‚Äã‚Äãin a row.  Many places are quite harmless.  For example, at the beginning, variables are assigned 0, and then the real value.  However, many of these places may contain an error.  Therefore, I recommend to Geant4 authors to carefully consider the diagnostic warnings <a href="http://www.viva64.com/ru/d/0108/">V519</a> .  I myself looked at these warnings very superficially. <br><br>  By the way, the approach is not very clear, when at first the variable is initialized with the default value and then with the desired value.  Why do you need it?  It is easier to immediately declare a variable where it is needed and initialize it with the necessary number. <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Some other warnings of V519 </h2><br>  The copy operator in the class G4KineticTrack looks suspicious: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; G4KineticTrack::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; right) { .... the4Momentum = right.the4Momentum; the4Momentum = right.GetTrackingMomentum(); .... }</code> </pre> <br>  PVS-Studio warning: V519 The4Momentum variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 451, 452. g4kinetictrack.cc 452 <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br>  By the way, the designers generally had a lot of warnings V519.  Perhaps in this code there is a sense?  For example, for debugging purposes.  Unclear.  So I think we should give a couple more examples of suspicious code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4IonisParamMat::ComputeDensityEffect() { .... fX0density = <span class="hljs-number"><span class="hljs-number">0.326</span></span>*fCdensity<span class="hljs-number"><span class="hljs-number">-2.5</span></span> ; fX1density = <span class="hljs-number"><span class="hljs-number">5.0</span></span> ; fMdensity = <span class="hljs-number"><span class="hljs-number">3.</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>((icase &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)&amp;&amp;(fCdensity &lt; ClimiG[icase])) icase-- ; fX0density = X0valG[icase]; fX1density = X1valG[icase]; .... }</code> </pre> <br>  PVS-Studio warnings: V519 The 'fX0density' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 245, 247. g4ionisparammat.cc 247 <br><br>  V519 The 'fX1density' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 245, 247. g4ionisparammat.cc 247 <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4AdjointPhotoElectricModel::SampleSecondaries(....) { .... pre_step_AdjointCS = totAdjointCS; post_step_AdjointCS = AdjointCrossSection(aCouple, electronEnergy,IsScatProjToProjCase); post_step_AdjointCS = totAdjointCS; .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'post_step_AdjointCS' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 76, 77. g4adjointphotoelectricmodel.cc 77 <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br>  And the last suspicious fragment I noticed.  Pay attention to the member 'erecrem'. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4Incl::processEventIncl(G4InclInput *input) { .... varntp-&gt;mzini = izrem; varntp-&gt;exini = esrem; varntp-&gt;pxrem = pxrem; varntp-&gt;pyrem = pyrem; varntp-&gt;pzrem = pzrem; varntp-&gt;mcorem = mcorem; varntp-&gt;erecrem = pcorem; varntp-&gt;erecrem = erecrem; .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'varntp-&gt; erecrem' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 896, 897. g4incl.cc 897 <br><br>  <b>Note.</b>  <b>Bug fixed in new version of Gint4.</b>  <b>Or this code is deleted.</b> <br><br><h2>  Count of array elements from 1 </h2><br>  It seems to me that here for a moment someone forgot that the elements of the arrays in C ++ are numbered from scratch.  As a result, it may happen beyond the array boundary.  Plus there is no comparison with the value 1.4, located at the very beginning of the array. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4HEInelastic::MediumEnergyClusterProduction(....) { .... G4double alem[] = {<span class="hljs-number"><span class="hljs-number">1.40</span></span>, <span class="hljs-number"><span class="hljs-number">2.30</span></span>, <span class="hljs-number"><span class="hljs-number">2.70</span></span>, <span class="hljs-number"><span class="hljs-number">3.00</span></span>, <span class="hljs-number"><span class="hljs-number">3.40</span></span>, <span class="hljs-number"><span class="hljs-number">4.60</span></span>, <span class="hljs-number"><span class="hljs-number">7.00</span></span>}; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j = <span class="hljs-number"><span class="hljs-number">1</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; j++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (alekw &lt; alem[j]) { jmax = j; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } .... }</code> </pre> <br>  PVS-Studio warning: V557 Array overrun is possible.  The value of 'j' index could reach 7. g4heinelastic.cc 4682 <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Physics and undefined behavior </h2><br>  C ++ is a cruel language.  Slightly relaxed - and immediately shot himself a proton leg.  Moreover, it can be immediately overlooked.  Here is an example of an incorrectly implemented addition operator: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; GMocrenDataPrimitive&lt;T&gt; &amp; GMocrenDataPrimitive&lt;T&gt;::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GMocrenDataPrimitive&lt;T&gt; &amp; _right) { GMocrenDataPrimitive&lt;T&gt; rprim; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rprim; }</code> </pre> <br>  PVS-Studio warning: V558 Function returns the current local object: rprim.  G4GMocren g4gmocrenio.cc 131 <br><br>  The function returns a reference to the local object.  Attempting to work with this link will result in undefined behavior. <br><br>  <b>Note.</b>  <b>The error is still present in the new version of Gint4.</b> <br><br><h2>  Time to wrap up </h2><br>  Unfortunately, it's time to end the excursion into the world of physics.  The fact is that this is still an article, and not a multi-page report.  It is a pity that I did not have time to tell about many other mistakes.  You can get acquainted with the suspicious code, which I managed to notice when looking at the PVS-Studio diagnostic warnings, in this file - <a href="http://www.viva64.com/external-pictures/txt/geant4_old.txt">geant4_old.txt</a> . <br><br>  Just I ask you not to conclude that these are all the errors that PVS-Studio could find.  I looked at the report rather superficially and could miss a lot of things.  I ask the project developers to check the code with PVS-Studio on their own.  Write to us and we will allocate a key for this for some time. <br><br>  And of course, as always, I repeat that it is more efficient to use static code analysis regularly, and not occasionally.  To realize the importance of regular use, please read <a href="http://www.viva64.com/ru/b/0196/">here</a> and <a href="http://www.viva64.com/ru/b/0105/">here</a> . <br><br>  As I said, the file contains a lot more suspicious code fragments than in this article.  I think all situations are clear enough.  As a last resort, I want to remind you that for each error code in the <a href="http://www.viva64.com/ru/d/0108/">documentation</a> there is a detailed description with examples. <br><br>  The only thing I want to briefly explain the diagnosis of V636 and V624.  Sometimes they may indicate inaccuracies in the calculations.  It seems to me that these diagnostics are important when it comes to computing programs. <br><br>  <b>Diagnostic Example V636:</b> <br><pre> <code class="cpp hljs">G4double G4XAqmTotal::CrossSection( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk1, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrack&amp; trk2) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... G4int sTrk1 = ....; G4int qTrk1 = ....; G4double sRatio1 = <span class="hljs-number"><span class="hljs-number">0.</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (qTrk1 != <span class="hljs-number"><span class="hljs-number">0</span></span>) sRatio1 = sTrk1 / qTrk1; .... }</code> </pre> <br>  PVS-Studio warning: V636 The 'sTrk1 / qTrk1' expression was implicitly casted from 'int' type to 'double' type.  Consider using a fractional part.  An example: double A = (double) (X) / Y ;.  g4xaqmtotal.cc 103 <br><br>  The result of dividing ‚Äúdouble X = 3/2‚Äù is 1, not 1.5, as it may seem due to negligence.  In the beginning, integer division occurs, and only then the result is converted to the type 'double'.  Considering unfamiliar code, it is difficult to say whether you really need to use integer division or is it a mistake.  I think such places in Geant4 deserve attention. <br><br>  <i>Note.</i>  <i>If integer division is required, such places should be accompanied by a comment.</i> <br><br>  <b>Diagnostic Example V624:</b> <br><pre> <code class="cpp hljs">dSigPodT = HadrTot*HadrTot*(<span class="hljs-number"><span class="hljs-number">1</span></span>+HadrReIm*HadrReIm)* (....)/<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-number"><span class="hljs-number">3.1416</span></span>*<span class="hljs-number"><span class="hljs-number">2.568</span></span>;</code> </pre> <br>  PVS-Studio warning: V624 The constant 3.1416 is being utilized.  The resulting value could be inaccurate.  Consider using the M_PI constant from &lt;math.h&gt;.  g4elastichadrnucleushe.cc 750 <br><br>  It is not clear why rigid constants are used in mass terms to denote the number Pi, Pi / 2, and so on.  Ready to believe that accuracy is enough.  But still, this is not an explanation.  Such constants are another reason for typos and inaccuracies.  There is a mass of predefined constants, such as M_PI, M_PI_4, M_LN2.  PVS-Studio makes appropriate recommendations for replacing hard constants. <br><br>  I almost forgot.  In the <a href="http://www.viva64.com/external-pictures/txt/geant4_old.txt">geant4_old.txt</a> file <a href="http://www.viva64.com/external-pictures/txt/geant4_old.txt">,</a> I also quoted messages related to micro-optimizations.  For example, regarding the increment of iterators: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">G4PhysicsTable</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;G4PhysicsVector*&gt; { .... }; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> G4PhysicsTable::iterator G4PhysicsTableIterator; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4PhysicsTable::insertAt (....) { G4PhysicsTableIterator itr=begin(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;idx; ++i) { itr++; } .... }</code> </pre> <br>  PVS-Studio warning: V803 Decreased performance.  In the case of it it is an iterator  Replace iterator ++ with ++ iterator.  g4physicstable.icc 83 <br><br>  Similarly, why this should be changed is described in the article: <a href="http://www.viva64.com/ru/b/0093/">Does it make practical sense to use the prefix increment operator ++ it for iterators instead of the postfix it ++</a> . <br><br><h2>  Conclusion </h2><br>  Accept that mistakes and typographical errors are made by <a href="http://www.viva64.com/ru/examples/">everyone</a> .  And yes, even you, dear readers.  It's unavoidable.  Using static code analysis tools, you can fix a lot of errors at the earliest stages.  This will reduce the time required to search for defects and will allow more attention to be paid to the problem being solved directly. <br><br><h2>  Additional links </h2><br><ol><li>  Andrey Karpov.  Myths about static analysis.  <a href="http://www.viva64.com/ru/b/0116/">The second myth - professional developers do not make stupid mistakes</a> . </li><li>  Andrey Karpov.  <a href="http://www.viva64.com/ru/b/0132/">Answers to questions that are often asked after reading our articles</a> . </li><li>  News about C ++ language, interesting articles and information about the projects we tested: <a href="https://twitter.com/Code_Analysis">@Code_Analysis</a> . </li><li>  First acquaintance with the analyzer: <a href="http://www.viva64.com/ru/b/0222/">PVS-Studio for Visual C ++</a> . </li></ol></div><p>Source: <a href="https://habr.com/ru/post/202154/">https://habr.com/ru/post/202154/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202142/index.html">AD called JSMPP</a></li>
<li><a href="../202144/index.html">Start Sandbox Championship Russian AI Cup</a></li>
<li><a href="../202146/index.html">It seems to me that the software hell is already close ...</a></li>
<li><a href="../202150/index.html">About cloud backups: use Rackspace CloudFiles</a></li>
<li><a href="../202152/index.html">Life hacking: in any incomprehensible situation, multiply by three</a></li>
<li><a href="../202158/index.html">Geant4 Continuation Check</a></li>
<li><a href="../202162/index.html">Implicit predicates</a></li>
<li><a href="../202164/index.html">Well, Pebble, wait a minute</a></li>
<li><a href="../202166/index.html">Live broadcast launch Visual Studio 2013 in Russia!</a></li>
<li><a href="../202168/index.html">Added support for Yandex.Maps version 2.1 in angular.js module yaMap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>