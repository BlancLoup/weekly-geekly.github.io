<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expanding PHPMailer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 Probably everyone who had to send mail from the PHP code via SMTP is familiar with the PHPMailer class. 
 In this article, I will tell you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expanding PHPMailer</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  Probably everyone who had to send mail from the PHP code via SMTP is familiar with the <a href="http://code.google.com/a/apache-extras.org/p/phpmailer/">PHPMailer</a> class. <br>  In this article, I will tell you how to teach PHPMailer to take as an additional parameter the IP address of the network interface from which we want to send.  Naturally, this feature will be useful only on servers with several white IP addresses.  And as a small addition, we will catch a rather unpleasant bug from the PHPMailer code. <a name="habracut"></a><br><br><h4>  PHPMailer Architecture Overview </h4><br>  The PHPMailer package consists of the frontend of the same name (the PHPMailer class) and several plug-in classes that implement the ability to send mail via SMTP protocol, including with POP3 pre-authentication. <br><br>  Front-end PHPMailer provides fields and methods for setting email parameters (localhost, return-path, AddAdress (), body, from, etc.), choosing the sending method and authentication method (SMTPSecure, SMTPAuth, IsMail (), IsSendMail (), IsSMTP ( ), etc.), as well as the Send () method. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After setting the letter parameters and specifying the sending method (it is possible to choose from the following: mail, sendmail, qmail or smtp), you must call the class method PHPMailer Send (), which, in turn, delegates the call to an internal method responsible for sending mail .  Since we are interested in exactly SMTP, then we will mainly consider the SMTP plugin from the class.smtp.php file. <br><br>  When using the PHPMailer :: IsSMTP () method, the PHPMailer :: Send () method will call the protected PHPMailer :: SmtpSend ($ header, $ body) method, passing the generated headers and message body to it. <br><br>  The PHPMailer :: SmtpSend () method will attempt to connect to the recipient's remote SMTP server (if this is not the first time the letter has been sent by the PHPMailer object, then the connection is most likely already established and this step will be skipped) and initiate a standard SMTP session with it (HELLO / EHLO, MAIL TO, RCPT, DATA, etc.). <br><br>  The connection to the SMTP server takes place in the public method PHPMailer :: SmtpConnect ().  Since there can be several MX records with different priorities for a single domain, the PHPMailer :: SmtpConnect () method will try to consistently connect to each of the SMTP servers specified when configuring PHPMailer. <br><br><h4>  Bug in code </h4><br>  And now let's take a close look at the PHPMailer :: SmtpConnect () code: <br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Initiates a connection to an SMTP server. * Returns false if the operation failed. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@uses</span></span></span><span class="hljs-comment"> SMTP * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@access</span></span></span><span class="hljs-comment"> public * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SmtpConnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SMTP(); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp-&gt;do_debug = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;SMTPDebug; $hosts = explode(<span class="hljs-string"><span class="hljs-string">';'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Host); $index = <span class="hljs-number"><span class="hljs-number">0</span></span>; $connection = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp-&gt;Connected(); <span class="hljs-comment"><span class="hljs-comment">// Retry while there is no connection try { while($index &lt; count($hosts) &amp;&amp; !$connection) { $hostinfo = array(); if (preg_match('/^(.+):([0-9]+)$/', $hosts[$index], $hostinfo)) { $host = $hostinfo[1]; $port = $hostinfo[2]; } else { $host = $hosts[$index]; $port = $this-&gt;Port; } $tls = ($this-&gt;SMTPSecure == 'tls'); $ssl = ($this-&gt;SMTPSecure == 'ssl'); if ($this-&gt;smtp-&gt;Connect(($ssl ? 'ssl://':'').$host, $port, $this-&gt;Timeout)) { $hello = ($this-&gt;Helo != '' ? $this-&gt;Helo : $this-&gt;ServerHostname()); $this-&gt;smtp-&gt;Hello($hello); if ($tls) { if (!$this-&gt;smtp-&gt;StartTLS()) { throw new phpmailerException($this-&gt;Lang('tls')); } //We must resend HELO after tls negotiation $this-&gt;smtp-&gt;Hello($hello); } $connection = true; if ($this-&gt;SMTPAuth) { if (!$this-&gt;smtp-&gt;Authenticate($this-&gt;Username, $this-&gt;Password)) { throw new phpmailerException($this-&gt;Lang('authenticate')); } } } $index++; if (!$connection) { throw new phpmailerException($this-&gt;Lang('connect_host')); } } } catch (phpmailerException $e) { $this-&gt;smtp-&gt;Reset(); if ($this-&gt;exceptions) { throw $e; } } return true; }</span></span></code> </pre> <br>  In the $ this-&gt; code, smtp is an object of the SMTP plugin class. <br><br>  We will try to figure out what the authors had in mind.  First, a check is made whether an internal object that can work with SMTP is created and is created if this is the first call to the SmtpConnect () method of an object of the PHPMailer class (in fact, the PHPMailer :: Close () method can turn $ this-&gt; smtp into null). <br><br>  Then the PHPMailer :: Host field is broken by the delimiter ';'  and the result is an array of MX records for the recipient domain.  If there was only one entry in Host (for example, 'smtp.yandex.ru'), then there will be only one element in the array. <br><br>  Next, it checks whether we are already connected to the recipient's server.  If this is the first SmtpConnect () call, then obviously $ connection will be false. <br><br>  So we got to the most interesting.  A cycle starts over all MX records, each iteration of which attempts to connect to the next MX.  But what will happen if you execute the algorithm of this cycle in your head, imagining that for the first MX record if ($ this-&gt; smtp-&gt; Connect (($ ssl? 'Ssl: //': ''). $ Host, $ port, $ this-&gt; Timeout)) returned false?  It turns out that the cycle will throw an exception, which will be intercepted already after the cycle.  Those.  all other MX records will not be checked for availability and we will catch an exception. <br><br>  But this is not the most unpleasant.  PHPMailer can work in two modes - throwing exceptions, or silently die with writing an error message in the ErrorInfo field.  So in the case of using the silent mode ($ this-&gt; exceptions == false, and this is the default mode) SmtpConnect () returns true! <br><br>  In general, this bug took me some time, the developers are <a href="http://code.google.com/a/apache-extras.org/p/phpmailer/issues/detail%3Fid%3D41">notified</a> about it.  I noticed it in version 5.2.1, but older versions behave the same way. <br><br>  Before moving on, I will introduce my quick fix.  Before the release of the official fix from the developers, I live with him.  Already a month the flight is normal. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SmtpConnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SMTP(); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp-&gt;do_debug = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;SMTPDebug; $hosts = explode(<span class="hljs-string"><span class="hljs-string">';'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Host); $index = <span class="hljs-number"><span class="hljs-number">0</span></span>; $connection = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp-&gt;Connected(); <span class="hljs-comment"><span class="hljs-comment">// Retry while there is no connection try { while($index &lt; count($hosts) &amp;&amp; !$connection) { $hostinfo = array(); if (preg_match('/^(.+):([0-9]+)$/', $hosts[$index], $hostinfo)) { $host = $hostinfo[1]; $port = $hostinfo[2]; } else { $host = $hosts[$index]; $port = $this-&gt;Port; } $tls = ($this-&gt;SMTPSecure == 'tls'); $ssl = ($this-&gt;SMTPSecure == 'ssl'); $bRetVal = $this-&gt;smtp-&gt;Connect(($ssl ? 'ssl://':'').$host, $port, $this-&gt;Timeout); if ($bRetVal) { $hello = ($this-&gt;Helo != '' ? $this-&gt;Helo : $this-&gt;ServerHostname()); $this-&gt;smtp-&gt;Hello($hello); if ($tls) { if (!$this-&gt;smtp-&gt;StartTLS()) { throw new phpmailerException($this-&gt;Lang('tls')); } //We must resend HELO after tls negotiation $this-&gt;smtp-&gt;Hello($hello); } if ($this-&gt;SMTPAuth) { if (!$this-&gt;smtp-&gt;Authenticate($this-&gt;Username, $this-&gt;Password)) { throw new phpmailerException($this-&gt;Lang('authenticate')); } } $connection = true; break; } $index++; } if (!$connection) { throw new phpmailerException($this-&gt;Lang('connect_host')); } } catch (phpmailerException $e) { $this-&gt;SetError($e-&gt;getMessage()); if ($this-&gt;smtp-&gt;Connected()) $this-&gt;smtp-&gt;Reset(); if ($this-&gt;exceptions) { throw $e; } return false; } return true; }</span></span></code> </pre> <br><br><h4>  Expanding PHPMailer to work with multiple network interfaces </h4><br>  The SMTP PHPMailer plugin works with the network through fsockopen, fputs and fgets.  If our machine has several network interfaces looking to the Internet, fsockopen will in any case create a socket on the first connection.  We need to be able to create on any. <br><br>  The first thought that came to mind is to use a standard bundle of classic sockets socket_create, socket_bind, socket_connect, which in socket_bind allows you to specify which network interface to connect the socket to by specifying its IP address.  As it turned out, the idea is not entirely successful.  As a result, almost the entire PHPMailer SMTP plugin had to be rewritten, replacing fputs and fgets with socket_read and socket_write, because fputs and fgets do not know how to work with the resource created by socket_create.  Earned, but the soul remained sediment. <br><br>  The next thought was better.  There is a stream_socket_client function that creates a stream socket that can be safely read with fgets.  As a result, by replacing just one method in the SMTP plugin, you can teach PHPMailer to send mail with an explicit indication of the network interface, and at the same time not to touch the developers code. <br><br>  Our plugin looks like this: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'class.smtp.php'</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SMTPX</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SMTP</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($host, $port = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $tval = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">30</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $local_ip)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// set the error val to null so there is no confusion $this-&gt;error = null; // make sure we are __not__ connected if($this-&gt;connected()) { // already connected, generate error $this-&gt;error = array("error" =&gt; "Already connected to a server"); return false; } if(empty($port)) { $port = $this-&gt;SMTP_PORT; } $opts = array( 'socket' =&gt; array( 'bindto' =&gt; "$local_ip:0", ), ); // create the context... $context = stream_context_create($opts); // connect to the smtp server $this-&gt;smtp_conn = @stream_socket_client($host.':'.$port, $errno, $errstr, $tval, // give up after ? secs STREAM_CLIENT_CONNECT, $context); // verify we connected properly if(empty($this-&gt;smtp_conn)) { $this-&gt;error = array("error" =&gt; "Failed to connect to server", "errno" =&gt; $errno, "errstr" =&gt; $errstr); if($this-&gt;do_debug &gt;= 1) { echo "SMTP -&gt; ERROR: " . $this-&gt;error["error"] . ": $errstr ($errno)" . $this-&gt;CRLF . '&lt;br /&gt;'; } return false; } // SMTP server can take longer to respond, give longer timeout for first read // Windows does not have support for this timeout function if(substr(PHP_OS, 0, 3) != "WIN") socket_set_timeout($this-&gt;smtp_conn, $tval, 0); // get any announcement $announce = $this-&gt;get_lines(); if($this-&gt;do_debug &gt;= 2) { echo "SMTP -&gt; FROM SERVER:" . $announce . $this-&gt;CRLF . '&lt;br /&gt;'; } return true; } }</span></span></code> </pre> <br><br>  In fact, the implementation of the Connect () method has also changed minimally.  Only the strings that create the socket directly are replaced and one more parameter is added to the signature - the IP address of the network interface. <br><br>  To use this plugin, you need to extend the PHPMailer class as follows: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'class.phpmailer.php'</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultipleInterfaceMailer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPMailer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * IP   ,    *    SMTP-. *      SMTPX. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $Ip = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($exceptions = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($exceptions); } <span class="hljs-comment"><span class="hljs-comment">/** *      SMTPX. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $ip IP       . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSMTPX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ip = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span> !== $ip) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Ip = $ip; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Mailer = <span class="hljs-string"><span class="hljs-string">'smtpx'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostSend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'smtpx'</span></span> == <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Mailer) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;SmtpSend(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;MIMEHeader, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;MIMEBody); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::PostSend(); } <span class="hljs-comment"><span class="hljs-comment">/** *  ,       * IP    . * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $header The message headers * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $body The message body * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@uses</span></span></span><span class="hljs-comment"> SMTP * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@access</span></span></span><span class="hljs-comment"> protected * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SmtpSend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($header, $body)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;PluginDir . <span class="hljs-string"><span class="hljs-string">'class.smtpx.php'</span></span>; $bad_rcpt = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;SmtpConnect()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> phpmailerException(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Lang(<span class="hljs-string"><span class="hljs-string">'connect_host'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::STOP_CRITICAL); } $smtp_from = (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Sender == <span class="hljs-string"><span class="hljs-string">''</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;From : <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Sender; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;smtp-&gt;Mail($smtp_from)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> phpmailerException(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Lang(<span class="hljs-string"><span class="hljs-string">'from_failed'</span></span>) . $smtp_from, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::STOP_CRITICAL); } <span class="hljs-comment"><span class="hljs-comment">// Attempt to send attach all recipients foreach($this-&gt;to as $to) { if (!$this-&gt;smtp-&gt;Recipient($to[0])) { $bad_rcpt[] = $to[0]; // implement call back function if it exists $isSent = 0; $this-&gt;doCallback($isSent, $to[0], '', '', $this-&gt;Subject, $body); } else { // implement call back function if it exists $isSent = 1; $this-&gt;doCallback($isSent, $to[0], '', '', $this-&gt;Subject, $body); } } foreach($this-&gt;cc as $cc) { if (!$this-&gt;smtp-&gt;Recipient($cc[0])) { $bad_rcpt[] = $cc[0]; // implement call back function if it exists $isSent = 0; $this-&gt;doCallback($isSent, '', $cc[0], '', $this-&gt;Subject, $body); } else { // implement call back function if it exists $isSent = 1; $this-&gt;doCallback($isSent, '', $cc[0], '', $this-&gt;Subject, $body); } } foreach($this-&gt;bcc as $bcc) { if (!$this-&gt;smtp-&gt;Recipient($bcc[0])) { $bad_rcpt[] = $bcc[0]; // implement call back function if it exists $isSent = 0; $this-&gt;doCallback($isSent, '', '', $bcc[0], $this-&gt;Subject, $body); } else { // implement call back function if it exists $isSent = 1; $this-&gt;doCallback($isSent, '', '', $bcc[0], $this-&gt;Subject, $body); } } if (count($bad_rcpt) &gt; 0 ) { //Create error message for any bad addresses $badaddresses = implode(', ', $bad_rcpt); throw new phpmailerException($this-&gt;Lang('recipients_failed') . $badaddresses); } if(!$this-&gt;smtp-&gt;Data($header . $body)) { throw new phpmailerException($this-&gt;Lang('data_not_accepted'), self::STOP_CRITICAL); } if($this-&gt;SMTPKeepAlive == true) { $this-&gt;smtp-&gt;Reset(); } return true; } /** *  ,   PHPMailer  *    SMTPX. * @uses SMTP * @access public * @return bool */ public function SmtpConnect() { if(is_null($this-&gt;smtp) || !($this-&gt;smtp instanceof SMTPX)) { $this-&gt;smtp = new SMTPX(); } $this-&gt;smtp-&gt;do_debug = $this-&gt;SMTPDebug; $hosts = explode(';', $this-&gt;Host); $index = 0; $connection = $this-&gt;smtp-&gt;Connected(); // Retry while there is no connection try { while($index &lt; count($hosts) &amp;&amp; !$connection) { $hostinfo = array(); if (preg_match('/^(.+):([0-9]+)$/', $hosts[$index], $hostinfo)) { $host = $hostinfo[1]; $port = $hostinfo[2]; } else { $host = $hosts[$index]; $port = $this-&gt;Port; } $tls = ($this-&gt;SMTPSecure == 'tls'); $ssl = ($this-&gt;SMTPSecure == 'ssl'); $bRetVal = $this-&gt;smtp-&gt;Connect(($ssl ? 'ssl://':'').$host, $port, $this-&gt;Timeout, $this-&gt;Ip); if ($bRetVal) { $hello = ($this-&gt;Helo != '' ? $this-&gt;Helo : $this-&gt;ServerHostname()); $this-&gt;smtp-&gt;Hello($hello); if ($tls) { if (!$this-&gt;smtp-&gt;StartTLS()) { throw new phpmailerException($this-&gt;Lang('tls')); } //We must resend HELO after tls negotiation $this-&gt;smtp-&gt;Hello($hello); } if ($this-&gt;SMTPAuth) { if (!$this-&gt;smtp-&gt;Authenticate($this-&gt;Username, $this-&gt;Password)) { throw new phpmailerException($this-&gt;Lang('authenticate')); } } $connection = true; break; } $index++; } if (!$connection) { throw new phpmailerException($this-&gt;Lang('connect_host')); } } catch (phpmailerException $e) { $this-&gt;SetError($e-&gt;getMessage()); if ($this-&gt;smtp-&gt;Connected()) $this-&gt;smtp-&gt;Reset(); if ($this-&gt;exceptions) { throw $e; } return false; } return true; } }</span></span></code> </pre> <br><br>  A new open Ip field has been added to the MultipleInterfaceMailer class, which should be set to a string representation of the IP address of the network interface from which we want to send mail.  The IsSMTPX () method has also been added, indicating that letters should be sent using a new plug-in.  The PostSend (), SmtpSend () and SmtpConnect () methods are also redesigned to use the SMTPX plugin.  At the same time, objects of the MultipleInterfaceMailer class can be safely used with existing client code, which, for example, sends mail via sendmail or through the original SMTP plugin, since neither the usage procedure nor the class interface has changed. <br><br>  Next, a small example of using a new class: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSmtpHostsByDomain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sRcptDomain)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getmxrr($sRcptDomain, $aMxRecords, $aMxWeights)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($aMxRecords) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; count($aMxRecords); ++$i) { $mxs[$aMxRecords[$i]] = $aMxWeights[$i]; } asort($mxs); $aSortedMxRecords = array_keys($mxs); $sResult = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($aSortedMxRecords <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $r) { $sResult .= $r . <span class="hljs-string"><span class="hljs-string">';'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $sResult; } } <span class="hljs-comment"><span class="hljs-comment">// getmxrr    ,   DNS, //,  RFC 2821,      , //   $sRcptDomain      // 0. return $sRcptDomain; } require 'MultipleInterfaceMailer.php'; $mailer = new MultipleInterfaceMailer(true); $mailer-&gt;IsSMTPX('192.168.1.1'); //   IP    //$mailer-&gt;IsSMTP();      $mailer-&gt;Host = getSmtpHostsByDomain('email.net'); $mailer-&gt;Body = 'blah-blah'; $mailer-&gt;From ='no-replay@yourdomain.net'; $mailer-&gt;AddAddress('sucreface@email.net'); $mailer-&gt;Send();</span></span></code> </pre> <br><br><h4>  Conclusion </h4><br>  Let's summarize: <br><ol><li>  Fixed a bug in PHPMailer, because of which SmtpConnect () always returned true, even in case of unsuccessful attempt to connect to the SMTP server. </li><li>  SmtpConnect () began to honestly check all MX records transferred to it before the first successful attempt. </li><li>  A new plugin has been written, with which you can send mail via SMTP explicitly indicating which network interface of the sending server to use. </li><li>  PHPMailer is painlessly expanded for old client code to use the new SMTPX plugin. </li></ol><br>  Good luck in your endeavors, friends! </div><p>Source: <a href="https://habr.com/ru/post/138878/">https://habr.com/ru/post/138878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138869/index.html">stripe - pay online for programmers</a></li>
<li><a href="../138871/index.html">Google Transit: The Quiet Revolution in Public Transport</a></li>
<li><a href="../138872/index.html">How did I get timeweb.ru!</a></li>
<li><a href="../138874/index.html">As I wrote to the skad. Part two</a></li>
<li><a href="../138876/index.html">Signs of fraud on eBay</a></li>
<li><a href="../138879/index.html">Concept UI for Windows 8</a></li>
<li><a href="../138880/index.html">Full-HD Voice Mobile Codec</a></li>
<li><a href="../138881/index.html">Dragon curves and bug</a></li>
<li><a href="../138883/index.html">Tips for PC buyers in the fall of 1995</a></li>
<li><a href="../138884/index.html">Haskell - Aesthetics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>