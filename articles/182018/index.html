<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Classes in lua, or getting rid of colon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As everyone knows, lua does not have any such classes or objects. However, there are metatables and syntactic sugar. 
 With the help of these mechanis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Classes in lua, or getting rid of colon</h1><div class="post__text post__text-html js-mediator-article">  As everyone knows, lua does not have any such classes or objects.  However, there are metatables and syntactic sugar. <br>  With the help of these mechanisms, it is sufficient to simply implement the similarity of classes. <br>  The result is something like this: <br><div class="spoiler">  <b class="spoiler_title">The easiest class</b> <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> MyClass = {} <span class="hljs-comment"><span class="hljs-comment">-- the table representing the class, which will double as the metatable for the instances MyClass.__index = MyClass -- failed table lookups on the instances should fallback to the class table, to get methods -- syntax equivalent to "MyClass.new = function..." function MyClass.new(init) local self = setmetatable({}, MyClass) self.value = init return self end function MyClass.set_value(self, newval) self.value = newval end function MyClass.get_value(self) return self.value end local i = MyClass.new(5) -- tbl:name(arg) is a shortcut for tbl.name(tbl, arg), except tbl is evaluated only once print(i:get_value()) --&gt; 5 i:set_value(6) print(i:get_value()) --&gt; 6</span></span></code> </pre> <br>  (taken from <a href="http://lua-users.org/wiki/ObjectOrientationTutorial">lua-users.org/wiki/ObjectOrientationTutorial</a> ) <br></div></div><br>  All this is of course good, even with a certain dexterity, inheritance can be realized ... <br>  But where are the public and private members of the class?  In fact, in this example, they are all public.  Yes, and we must remember where to use the colon: <br><pre> <code class="lua hljs">MyClass:myFunc()</code> </pre><br>  where just one point: <br><pre> <code class="lua hljs">MyClass.myOtherFunc()</code> </pre><br>  What about static class members?  Do have to refuse? <br><a name="habracut"></a><br><br>  So I did not want to refuse, and began to collective farm ... <br><br>  So, I present to you my farm: <br><div class="spoiler">  <b class="spoiler_title">My collective farm</b> <div class="spoiler_text"><pre> <code class="lua hljs">createClass = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> creator = {} creator.__private = { object_class = {}, } creator.__oncall = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(class_creator)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- Get the class definition so we can make needed variables private, static, etc. local this = class_creator() -- Initialize class from class definition __init = function() -- Init Public Static local class = {} if (type(this.__public_static) == "table") then class = this.__public_static end -- Init Object local thisClass = this local __constructor = function(...) local object = {} local this = class_creator() -- Init Public if (type(this.__public) == "table") then object = this.__public end -- Init static values of the class this.__public_static = thisClass.__public_static this.__private_static = thisClass.__private_static -- Call Constructor if (type(this.__construct) == "function") then this.__construct(...) end -- Returning constructed object return object end return {class = class, constructor = __constructor} end -- Creating class (returning constructor) local class_data = __init() local class = class_data.class local constructor = class_data.constructor -- Set class metatable (with setting constructor) local class_metatable = { __newindex = function(t, key, value) if type(t[key])=="nil" or type(t[key])=="function" then error("Attempt to redefine class") end rawset(t, key, value) end, __metatable = false, __call = function(t, ...) if type(t) == nil then error("Class object create failed!") end local obj = constructor(...) creator.__private.object_class[obj] = t local object_metatable = { __newindex = function(t, key, value) class = creator.__private.object_class[t] if type(class[key])~="nil" and type(class[key])~="function" then rawset(class, key, value) return end if type(t[key])~="nil" and type(t[key])~="function" then rawset(t, key, value) return end error("Attempt to redefine object") end, __index = t, __metatable = false, } setmetatable(obj, object_metatable) return obj end, } -- Setting class metatable to the class itself setmetatable(class, class_metatable) -- Returning resulting class return class end return creator.__oncall end createClass = createClass()</span></span></code> </pre><br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And how to use?  Very simple, here's a template for you: <br><pre> <code class="lua hljs">myclass_prototype = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> this = {} this.__public_static = { <span class="hljs-comment"><span class="hljs-comment">-- Public Static Variables statvalue = 5, -- Public Static Funcs statfunc = function() print(this.__public_static.statvalue) end, } this.__private_static = { -- Private Static Variables privstatdat = 2, -- Private Static Funcs privstatfunc = function() print(this.__private_static.privstatdat) end, } this.__public = { -- Public Variables pubdata = 3, -- Public Funcs pubfunc = function(newprivate) print(this.__public.pubdata) this.__private.privdata = newprivate end, } this.__private = { -- Private Variables privdata = 1, -- Private Funcs listallprivate = function() print(this.__private.privdata) end, } this.__construct = function() -- Constructor end return this end myclass=createClass(myclass_prototype)</span></span></code> </pre><br>  As you can see, each time you call from inside the class, you will have to specify the path each time, a for ‚Äúthis .__ private.privdata‚Äù, but here is an example of using the created class! <br><pre> <code class="lua hljs">myobject = myclass() myobject.pubfunc(<span class="hljs-number"><span class="hljs-number">999</span></span>)</code> </pre><br>  Calling this code will create a myobject object from the class myclass, and the pubfunc function will be called, which will highlight the contents of the public variable and change the private one. <br>  And no problems with colons! <br>  By the way, static calls also work.  Both from a class, and from object. <br><br>  So, briefly tell you what kind of magic happens here.  And here comes the juggling of the so-called upvalues.  upvalues ‚Äã‚Äãare variables that are visible from the inside, but not from the outside!  Very similar to private, isn't it? <br>  So, having created the ‚Äúprototype‚Äù function, we created a new scope, and placed all the insides of our class in it, bringing out only public and public static class members.  And the rest of the magic is performed by metatables, which allow us to determine what exactly will happen when a ‚Äúnon-existent‚Äù member of an external table is requested, which represents our class / object. <br>  Sounds messy, I know, but I can't explain it better - not special :) <br><br>  I thought for a long time how to do inheritance with such a system, but I never thought of it - upvalues ‚Äã‚Äãseriously limits our actions, and did not want to use perversions like the debug library - it is not included everywhere.  If anyone thinks, I will be glad to see! <br><br>  PS: if for someone my post is something obvious - well, it means I overestimated myself :) Do not judge strictly, maybe this decision will be useful to someone for some reason! </div><p>Source: <a href="https://habr.com/ru/post/182018/">https://habr.com/ru/post/182018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182008/index.html">Symfony 2.3.0! First release with long term support!</a></li>
<li><a href="../182010/index.html">Writing music with PHP</a></li>
<li><a href="../182012/index.html">Modified charging can hack any iOS device in a minute</a></li>
<li><a href="../182014/index.html">Google has banned face recognition software for Google Glass</a></li>
<li><a href="../182016/index.html">Found mutations of the genome responsible for the level of education</a></li>
<li><a href="../182026/index.html">On the kickstarter launched the project "tactile costume"</a></li>
<li><a href="../182030/index.html">Walkers for Kickstar gamers</a></li>
<li><a href="../182032/index.html">Executable Specification: SpecFlow A to Z</a></li>
<li><a href="../182034/index.html">Stack Overflow replaces official documentation on all issues.</a></li>
<li><a href="../182036/index.html">"Sass Support" in Chrome Dev Tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>