<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows hook: just about complicated</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is a hook? 
 What is a function hook and what is it for? In English, ‚Äúhook‚Äù is a trap. Therefore, the purpose of the function hooks in Windows ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows hook: just about complicated</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/011/68d/bec/01168dbec07d45d78e48a598432b9ebe.png" align="right" alt="image">  <b>What is a hook?</b> <br>  What is a function hook and what is it for?  In English, ‚Äúhook‚Äù is a trap.  Therefore, the purpose of the function hooks in Windows can be guessed - this is a trap for the function.  In other words, we catch the function and take control.  After this definition, tempting prospects open up for us: we can intercept the call of any function, replace the code with our own, thereby changing the behavior of any program with the one we need (of course, within certain limitations). <br><br>  The purpose of this article is to demonstrate the installation of the hook and its direct implementation. <a name="habracut"></a><br><br><blockquote>  <i>- You can not believe in the impossible!</i> <i><br></i>  <i>‚ÄúYou just have little experience,‚Äù said the Queen.</i>  <i>- At your age, I gave it half an hour every day!</i>  <i>On other days, I managed to believe in a dozen of impossibilities before breakfast!</i> </blockquote><br>  <b>Where did this knowledge really come in handy to me</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This knowledge is very highly specialized, and in everyday development practice it is unlikely that they will be useful, but it is highly desirable to know about them, even if this knowledge is purely theoretical.  In my practice, this knowledge was useful to me for the following tasks: <br><br>  ‚Ä¢ Control of incoming http-traffic and substitution of ‚Äúadult‚Äù content for more harmless. <br>  ‚Ä¢ Logging information in case of copying any files from the network folder under control. <br>  ‚Ä¢ Minor modification of the code in the project from which the source code was lost (yes, and this also happens) <br><br>  <b>Hook installation methods</b> <br><br>  Let's move on from general phrases to a more detailed look at hooks.  I know of several types of hook implementations: <br><br>  ‚óè Using the SetWindowsHookEx function.  This is a very simple, and therefore limited, method.  It allows you to intercept only certain functions, mainly related to the window (for example, intercepting events that a window receives, mouse clicks, keyboard input).  The advantage of this method is the ability to install global hooks (for example, to intercept keyboard input on all applications at once). <br>  ‚óè Using address spoofing in the DLL import section.  The essence of the method is that any module has an import section, which lists all other modules used in it, as well as addresses in memory for the functions exported by this module.  It is necessary to replace the address in this module with your own and control will be transferred to the specified address. <br>  ‚óè Using the registry key <b>HKEY_LOCAL_MACHINE \ Software \ Microsoft \ Windows NT \ CurrentVersion \ Windows \ AppInit_Dlls</b> .  It is necessary to register the path to the DLL, but only users with administrator rights can do this.  This method is good if the application does not use kernel32.dll (you cannot call the LoadLibrary function). <br>  ‚óè Use injection DLL in the process.  In my opinion, this is the most flexible and most indicative way.  We will consider it in more detail. <br><br>  <b>Injection method</b> <br><br>  Injection is possible because the ThreadStart function, which is passed to the CreateThread function, has a similar signature with the LoadLibrary function (and indeed the structure of the dll and the executable file are very similar).  This allows you to specify the LoadLibrary method as an argument when creating a stream. <br><br>  The DLL injection algorithm looks like this: <br><br>  1. Find the address of the LoadLibrary function from Kernel32.dll for the thread where we want to inject the DLL. <br>  2. Allocate memory to write the arguments of this function. <br>  3. Create a thread and specify the LoadLibrary and its argument as the ThreadStart function. <br>  4. The thread goes to execution, loads the library and ends. <br>  5. Our library is injected into the address space of a foreign thread.  At the same time, when loading a DLL, the DllMain method with the PROCESS_ATTACH flag will be called.  This is exactly the place where you can install hooks on the desired functions.  Next, consider the installation itself hook. <br><br>  <b>Hook installation</b> <br><br>  The approach used when installing the hook can be divided into the following parts: <br><br>  1. Find the address of the function whose call we want to intercept (for example, MessageBox in user32.dll). <br>  2. Store the first few bytes of this function in another memory location. <br>  3. In their place, we insert the machine command JUMP to go to the address of the dummy function.  Naturally, the signature of the function must be the same as the original, that is, all parameters, the return value, and the call rules must match. <br>  4. Now, when the thread calls the intercepted function, the JUMP command will redirect it to our function.  At this stage we can execute any necessary code. <br><br>  Then you can remove the trap, returning the first bytes of paragraph 2 in place. <br><br>  So, now we understand how to inject the DLL we need into the address space of the stream and how to install the hook on the function.  Now we will try to combine these approaches in practice. <br><br>  <b>Test application</b> <br><br>  Our test application will be pretty simple and written in C #.  It will contain a button to display the MessageBox.  For example, set the hook to this function.  Test application code: <br><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">public</span></span> partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">MainForm</span></span> : <span class="hljs-type"><span class="hljs-type">Form</span></span> { [<span class="hljs-type"><span class="hljs-type">DllImport</span></span>(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>, <span class="hljs-type"><span class="hljs-type">CharSet</span></span> = <span class="hljs-type"><span class="hljs-type">CharSet</span></span>.<span class="hljs-type"><span class="hljs-type">Unicode</span></span>)] public static extern int <span class="hljs-type"><span class="hljs-type">MessageBox</span></span>(<span class="hljs-type"><span class="hljs-type">IntPtr</span></span> hWnd, <span class="hljs-type"><span class="hljs-type">String</span></span> text, <span class="hljs-type"><span class="hljs-type">String</span></span> caption, uint <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">); public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MainForm</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InitializeComponent</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Text</span></span></span><span class="hljs-class"> = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ProcessID</span></span></span><span class="hljs-class">: " + </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Process</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetCurrentProcess</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Id</span></span></span><span class="hljs-class">; } private void btnShowMessage_Click(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EventArgs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessageBox</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IntPtr(0)</span></span></span><span class="hljs-class">, "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hello</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">World</span></span></span><span class="hljs-class">!", "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Hello</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dialog</span></span></span><span class="hljs-class">", 0); } }</span></span></code> </pre> <br>  <b>Injector</b> <br><br>  As an injector, we consider two options.  Injectors written in C ++ and C #.  Why bilingual?  The fact is that many people believe that C # is a language in which system things cannot be used, this is a myth, you can :).  So, the code of the C ++ injector: <br><br><pre> <code class="hljs lua">#include <span class="hljs-string"><span class="hljs-string">"stdafx.h"</span></span> #include &lt;iostream&gt; #include &lt;Windows.h&gt; #include &lt;cstdio&gt; int Wait(); int main() { //   ,   . DWORD processId = <span class="hljs-number"><span class="hljs-number">55</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* dllName = <span class="hljs-string"><span class="hljs-string">"C:\\_projects\\CustomHook\\Hooking\\Debug\\HookDll.dll"</span></span>; //  PID    . printf(<span class="hljs-string"><span class="hljs-string">"Enter PID to inject dll: "</span></span>); std::cin &gt;&gt; processId; //    . HANDLE openedProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (openedProcess == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"OpenProcess error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } //  kernel32.dll HMODULE kernelModule = GetModuleHandleW(L<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (kernelModule == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"GetModuleHandleW error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } //  LoadLibrary ( A     ANSI,    ) LPVOID loadLibraryAddr = GetProcAddress(kernelModule, <span class="hljs-string"><span class="hljs-string">"LoadLibraryA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loadLibraryAddr == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"GetProcAddress error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } //     LoadLibrary,   -     DLL LPVOID argLoadLibrary = (LPVOID)VirtualAllocEx(openedProcess, NULL, strlen(dllName), MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argLoadLibrary == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"VirtualAllocEx error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } //     . int countWrited = WriteProcessMemory(openedProcess, argLoadLibrary, dllName, strlen(dllName), NULL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (countWrited == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"WriteProcessMemory error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } //  ,   LoadLibrary     HANDLE threadID = CreateRemoteThread(openedProcess, NULL, <span class="hljs-number"><span class="hljs-number">0</span></span>, (LPTHREAD_START_ROUTINE)loadLibraryAddr, argLoadLibrary, NULL, NULL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (threadID == NULL) { printf(<span class="hljs-string"><span class="hljs-string">"CreateRemoteThread error code: %d\r\n"</span></span>, GetLastError()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Wait(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { printf(<span class="hljs-string"><span class="hljs-string">"Dll injected!"</span></span>); } //  . CloseHandle(openedProcess); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } int Wait() { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> a; printf(<span class="hljs-string"><span class="hljs-string">"Press any key to exit"</span></span>); std::cin &gt;&gt; a; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Now the same, but only in C #.  Consider how much more compact the code is; there is no riot of types (HANDLE, LPVOID, HMODULE, DWORD, which, in essence, mean the same thing). <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Exporter</span></span> { [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProcessAccessFlags processAccess, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bInheritHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> processId</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetModuleHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpModuleName</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, CharSet = CharSet.Ansi, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProcAddress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hModule, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> procName</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VirtualAllocEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpAddress, IntPtr dwSize, AllocationType flAllocationType, MemoryProtection flProtect</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteProcessMemory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpBaseAddress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] lpBuffer, UIntPtr nSize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr lpNumberOfBytesWritten</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRemoteThread</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpThreadAttributes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwCreationFlags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr lpThreadId</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> Int32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hObject</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Injector</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Inject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int32 pid, String dllPath</span></span></span><span class="hljs-function">)</span></span> { IntPtr openedProcess = Exporter.OpenProcess(ProcessAccessFlags.All, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, pid); IntPtr kernelModule = Exporter.GetModuleHandle(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>); IntPtr loadLibratyAddr = Exporter.GetProcAddress(kernelModule, <span class="hljs-string"><span class="hljs-string">"LoadLibraryA"</span></span>); Int32 len = dllPath.Length; IntPtr lenPtr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(len); UIntPtr uLenPtr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntPtr((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)len); IntPtr argLoadLibrary = Exporter.VirtualAllocEx(openedProcess, IntPtr.Zero, lenPtr, AllocationType.Reserve | AllocationType.Commit, MemoryProtection.ReadWrite); IntPtr writedBytesCount; Boolean writed = Exporter.WriteProcessMemory(openedProcess, argLoadLibrary, System.Text.Encoding.ASCII.GetBytes(dllPath), uLenPtr, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> writedBytesCount); IntPtr threadIdOut; IntPtr threadId = Exporter.CreateRemoteThread(openedProcess, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, loadLibratyAddr, argLoadLibrary, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> threadIdOut); Exporter.CloseHandle(threadId); } }</code> </pre><br>  <b>Injectable Library</b> <br><br>  Now the most interesting is the code of the library that installs the hooks.  This library is written in C ++, while without an analog in C #. <br><br><pre> <code class="hljs pgsql">// dllmain.cpp : Defines the entry <span class="hljs-type"><span class="hljs-type">point</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the DLL application. #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "stdafx.h" #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;Windows.h&gt; #define SIZE <span class="hljs-number"><span class="hljs-number">6</span></span> //      typedef <span class="hljs-type"><span class="hljs-type">int</span></span> (WINAPI *pMessageBoxW)(HWND, LPCWSTR, LPCWSTR, UINT); <span class="hljs-type"><span class="hljs-type">int</span></span> WINAPI MyMessageBoxW(HWND, LPCWSTR, LPCWSTR, UINT); <span class="hljs-type"><span class="hljs-type">void</span></span> BeginRedirect(LPVOID); pMessageBoxW pOrigMBAddress = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; BYTE oldBytes[SIZE] = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; BYTE JMP[SIZE] = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; DWORD oldProtect, myProtect = PAGE_EXECUTE_READWRITE; <span class="hljs-type"><span class="hljs-type">BOOL</span></span> APIENTRY DllMain( HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved ) { switch (ul_reason_for_call) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: //       . MessageBoxW(<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, L"I hook MessageBox!", L"Hello", MB_OK); //   MessageBox pOrigMBAddress = (pMessageBoxW)GetProcAddress(GetModuleHandleW(L"user32.dll"), "MessageBoxW"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pOrigMBAddress != <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) { BeginRedirect(MyMessageBoxW); } break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_ATTACH: break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_DETACH: break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_DETACH: break; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>; } <span class="hljs-type"><span class="hljs-type">void</span></span> BeginRedirect(LPVOID newFunction) { // -     BYTE tempJMP[SIZE] = { <span class="hljs-number"><span class="hljs-number">0xE9</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xC3</span></span> }; memcpy(JMP, tempJMP, SIZE); //      DWORD JMPSize = ((DWORD)newFunction - (DWORD)pOrigMBAddress - <span class="hljs-number"><span class="hljs-number">5</span></span>); //     VirtualProtect((LPVOID)pOrigMBAddress, SIZE, PAGE_EXECUTE_READWRITE, &amp;oldProtect); //    memcpy(oldBytes, pOrigMBAddress, SIZE); //  <span class="hljs-number"><span class="hljs-number">4</span></span> . ,     x86 memcpy(&amp;JMP[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;JMPSize, <span class="hljs-number"><span class="hljs-number">4</span></span>); //    memcpy(pOrigMBAddress, JMP, SIZE); //     VirtualProtect((LPVOID)pOrigMBAddress, SIZE, oldProtect, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); } <span class="hljs-type"><span class="hljs-type">int</span></span> WINAPI MyMessageBoxW(HWND hWnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uiType) { //     VirtualProtect((LPVOID)pOrigMBAddress, SIZE, myProtect, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); //    (   ) memcpy(pOrigMBAddress, oldBytes, SIZE); //   ,    <span class="hljs-type"><span class="hljs-type">int</span></span> retValue = MessageBoxW(hWnd, lpText, L"Hooked", uiType); //    memcpy(pOrigMBAddress, JMP, SIZE); //     VirtualProtect((LPVOID)pOrigMBAddress, SIZE, oldProtect, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retValue; }</code> </pre><br>  Well, a few pictures in the end.  Before installing the hook: <br><br><img src="https://habrastorage.org/files/834/ab3/cb6/834ab3cb6ff941288041f76908f563f0.png" alt="image"><br><br>  And after installation: <br><br><img src="https://habrastorage.org/files/bb8/d3d/f94/bb8d3df94745498c845889f6d65bf7ef.png" alt="image"><br><br>  In our next article, we will try to write the library code that sets the hooks to C #, since the mechanism for injecting managed code deserves a separate article. <br><br>  Article authors: <a href="https://habrahabr.ru/users/nikitam/" class="user_link">nikitam</a> , <a href="https://habrahabr.ru/users/thoughtsaboutprogramming/" class="user_link">ThoughtsAboutProgramming</a> </div><p>Source: <a href="https://habr.com/ru/post/324718/">https://habr.com/ru/post/324718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324706/index.html">Updated Yii2 plugin for PhpStorm</a></li>
<li><a href="../324708/index.html">Need an energy efficient data center? Then you should build it under water.</a></li>
<li><a href="../324710/index.html">Elements, universes and registers of rules</a></li>
<li><a href="../324714/index.html">Nearly dismissed under article ... on Habr√©</a></li>
<li><a href="../324716/index.html">Splunk. Introduction to machine data analysis - part 2. Enrichment of data from external directories and work with geo-data</a></li>
<li><a href="../324720/index.html">Ensure the availability of user data in Microsoft Dynamics CRM using Veeam Backup & Replication</a></li>
<li><a href="../324722/index.html">God mode VKontakte</a></li>
<li><a href="../324724/index.html">How to assemble an icon font from a sketch file</a></li>
<li><a href="../324728/index.html">Shader fur on webgl 2</a></li>
<li><a href="../324732/index.html">Mlbootcamp competition from mail.ru. Briefly about the recipe for second place</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>