<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multithreaded Go programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a problem: we have a compiler of our own programming language, with which we compile some BASIC dialect into source code in C. 

 Unfortunat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multithreaded Go programming</h1><div class="post__text post__text-html js-mediator-article">  There was a problem: we have a compiler of our own programming language, with which we compile some BASIC dialect into source code in C. <br><br>  Unfortunately, for historical reasons, we did not have a clear <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B5%25D1%2581%25D1%2581%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">regression test</a> for this compiler.  But now, on the basis of the source code of a business application written on this basic, they decided to do a full test. <br><br>  The plan is this: to accept some current version of the compiler, for which there are no open complaints from customers, as a reference.  Compile with this version a decent amount of sources, save the result, and then every time you make changes to the compiler, run all these sources and see if exactly the same output is generated.  This will not protect against errors in general, but at least there will be confidence that the existing business code is still compiled correctly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Easy task.  Only there is one "but."  The number of sources that are planned to be used as a reference is about 15 thousand files, with a total volume of slightly less than gigabytes (for convenience, they are wrapped in one TAR).  Such a ‚Äúrun‚Äù can be very long.  And there is a natural desire to make the test as fast as possible using a multiprocessor machine, because the task is perfectly parallelized. <br><br>  Alternatively, you can make a Makefile and run it with the "-j" key in GNU Make.  But if you write a specialized multi-threaded program, you can achieve better performance. <br><a name="habracut"></a><br><br>  So, it is obvious: instead of sequential execution, you need to start compiling each file in parallel threads.  But since there are many files (~ 15 thousand), it is inefficient to just simultaneously run so many threads.  It would be more reasonable to have a pool of threads, where their number will be determined, for example, by the number of processors (for example, multiplied by 2).  The pool will assign the next task to the free stream, and if all the threads are busy, it will block until the free one appears. <br><br>  Thus, we will keep busy N threads, ensuring optimal CPU utilization, without wasting time on unnecessary context switches and constantly creating and destroying threads. <br><br>  At first I decided to write everything in C ++ and pthreads.  After several hours of dancing around functors, mutexes, semaphores and conditional variables, nothing really worked out for me.  And then I remembered Go.  Do not believe it - after an hour of work I had the first version ready, including small things like working with TAR, the command line and starting the external process. <br><br>  So: this program takes a TAR with source codes, unpacks it, and runs each file through the compiler. <br><br>  I‚Äôll say at once that the purpose of what I am writing here is to demonstrate this (and no more than that) how easy and convenient it is for Go to write multi-threaded imperative programs. <br><br>  The main concept that is used in this program is the <a href="http://golang.org/doc/effective_go.html">channels</a> .  Channels can synchronously transfer data and functions between threads ( <a href="http://golang.org/doc/effective_go.html">Go-routines</a> ). <br><br>  Further, you can simply look at the source.  The most interesting place where you can see how the ‚Äúcompile ()‚Äù function can be called from several threads without any changes. <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"archive/tar"</span></span> <span class="hljs-string"><span class="hljs-string">"container/vector"</span></span> <span class="hljs-string"><span class="hljs-string">"exec"</span></span> <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"io"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"strings"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//  :     . var jobs *int = flag.Int("jobs", 0, "number of concurrent jobs") var compiler *string = flag.String("cc", "bcom", "compiler name") func main() { flag.Parse() os.Args = flag.Args() args := os.Args ar := args[0] r, err := os.Open(ar, os.O_RDONLY, 0666); if err != nil { fmt.Printf("unable to open TAR %s\n", ar) os.Exit(1) } // defer -   "finally {}",   //     . defer r.Close() //   TAR. fmt.Printf("- extracting %s\n", ar) //    . tr := tar.NewReader( r ) tests := new(vector.StringVector) //    ,     //   . for { //      . hdr, _ := tr.Next() if hdr == nil { break } name := &amp;hdr.Name //     ,  . if !strings.HasPrefix(*name, "HDR_") { tests.Push(*name) } //   . w, err := os.Open("data/" + *name, os.O_CREAT | os.O_RDWR, 0666) if err != nil { fmt.Printf("unable to create %s\n", *name) os.Exit(1) } //     . io.Copy(w, tr) w.Close() } fmt.Printf("- compiling...\n") *compiler , _ = exec.LookPath(*compiler) fmt.Printf("- compiler %s\n", *compiler) if *jobs == 0 { //  "compile()" ,   . fmt.Printf("- running sequentially\n") for i := 0; i &lt; tests.Len(); i++ { compile(tests.At(i)) } } else { //  "compile()"   . fmt.Printf("- running %d concurrent job(s)\n", *jobs) //  :        , //   . -runner'   //    .     // .   ,    // ,   runner' . tasks := make(chan string, *jobs) //     -runner'. //    ,   runner'  //   .     . done := make(chan bool) //  runner'. for i := 0; i &lt; *jobs; i++ { go runner(tasks, done) } //       .  //    ,   //  . for i := 0; i &lt; tests.Len(); i++ { tasks &lt;- tests.At(i) } //        //       . for i := 0; i &lt; *jobs; i++ { tasks &lt;- "" &lt;- done } } } // -runner. func runner(tasks chan string, done chan bool) { //  . for { //    . ,   //   . name := &lt;- tasks //   ,   . if len(name) == 0 { break } //  . compile(name) } //  ,   . done &lt;- true } func compile(name string) { //  . c, err := exec.Run(*compiler, []string{*compiler, name}, os.Environ(), "./data", exec.DevNull, exec.PassThrough, exec.PassThrough) if err != nil { fmt.Printf("unable to compile %s (%s)\n", name, err.String()) os.Exit(1) } c.Wait(0) }</span></span></code> </pre> <br>  Makefile: <br><br><pre> <code class="bash hljs">target = tar_extractor all: 6g $(target).go 6l -o $(target) $(target).6</code> </pre><br>  I drove this stuff under a 64-bit Linux on an eight-processor blade.  During testing, I was on the machine alone, so that the results of different runs can be compared.  The file ‚Äúhuge.tar‚Äù contains ~ 15 thousand sources and is one gigabyte in size. <br><br>  This is how the CPU load looks when the machine does nothing (all processors are almost 100% idle): <br><br><pre> <code class="hljs perl"> Cpu<span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu1 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni, <span class="hljs-number"><span class="hljs-number">99.7</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu2 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu3 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu4 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu5 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni, <span class="hljs-number"><span class="hljs-number">99.3</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu6 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st Cpu7 : <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%us, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%sy, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%ni,<span class="hljs-number"><span class="hljs-number">100.0</span></span>%id, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%wa, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%hi, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%si, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>%st</code> </pre><br>  Run in sequential mode (-jobs 0): <br><br><pre> <code class="bash hljs"> make &amp;&amp; time -p ./tar_extractor -<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> 0 huge.tar</code> </pre><br>  Working hours: <br><br><pre> <code class="bash hljs"> real 213.81 user 187.32 sys 61.33</code> </pre><br>  Almost all processors do 70-80% nothing (I took all the pictures during the compilation stage): <br><br><pre> <code class="bash hljs"> Cpu0 : 11.9%us, 4.3%sy, 0.0%ni, 82.5%id, 1.3%wa, 0.0%hi, 0.0%si, 0.0%st Cpu1 : 9.6%us, 2.7%sy, 0.0%ni, 87.7%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu2 : 4.3%us, 1.3%sy, 0.0%ni, 92.7%id, 1.7%wa, 0.0%hi, 0.0%si, 0.0%st Cpu3 : 16.0%us, 6.0%sy, 0.0%ni, 78.0%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu4 : 12.6%us, 4.3%sy, 0.0%ni, 82.7%id, 0.3%wa, 0.0%hi, 0.0%si, 0.0%st Cpu5 : 11.6%us, 3.3%sy, 0.0%ni, 85.0%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu6 : 4.7%us, 1.3%sy, 0.0%ni, 94.0%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu7 : 16.6%us, 6.3%sy, 0.0%ni, 77.1%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st</code> </pre><br>  Total processor load - 2.7%: <br><br><pre> <code class="bash hljs"> PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 15054 tester 18 0 41420 4980 1068 S 2.7 0.1 0:02.96 tar_extractor</code> </pre><br>  Now we start with a thread pool, but with only one channel (-jobs 1). <br><br>  Time: <br><br><pre> <code class="bash hljs"> real 217.87 user 191.42 sys 62.53</code> </pre><br>  Processors: <br><br><pre> <code class="bash hljs"> Cpu0 : 5.7%us, 1.7%sy, 0.0%ni, 92.7%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu1 : 13.3%us, 5.3%sy, 0.0%ni, 81.3%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu2 : 7.0%us, 2.7%sy, 0.0%ni, 89.3%id, 0.7%wa, 0.0%hi, 0.3%si, 0.0%st Cpu3 : 15.3%us, 5.7%sy, 0.0%ni, 77.7%id, 1.3%wa, 0.0%hi, 0.0%si, 0.0%st Cpu4 : 6.0%us, 2.0%sy, 0.0%ni, 92.0%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu5 : 14.3%us, 7.3%sy, 0.0%ni, 78.4%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu6 : 7.0%us, 2.3%sy, 0.0%ni, 90.7%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu7 : 15.3%us, 6.6%sy, 0.0%ni, 78.1%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st</code> </pre><br>  It is clear that the picture is the same, since in reality we also drive one thread. <br><br>  And now we turn on the thread pool (-jobs 32): <br><br><pre> <code class="bash hljs"> make &amp;&amp; time -p ./tar_extractor -<span class="hljs-built_in"><span class="hljs-built_in">jobs</span></span> 32 huge.tar</code> </pre><br>  Work time fell almost seven times: <br><br><pre> <code class="bash hljs"> real 38.38 user 195.55 sys 69.92</code> </pre><br>  The total processor load (during the compilation stage) increased to 23%: <br><br><pre> <code class="bash hljs"> PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 17488 tester 16 0 45900 9732 1076 S 23.6 0.1 0:06.40 tar_extractor</code> </pre><br>  It can be seen that all processors are really busy: <br><br><pre> <code class="bash hljs"> Cpu0 : 56.3%us, 26.3%sy, 0.0%ni, 17.3%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu1 : 55.5%us, 27.9%sy, 0.0%ni, 15.6%id, 1.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu2 : 56.1%us, 25.9%sy, 0.0%ni, 15.0%id, 0.7%wa, 0.3%hi, 2.0%si, 0.0%st Cpu3 : 58.1%us, 26.2%sy, 0.0%ni, 15.6%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu4 : 57.2%us, 25.8%sy, 0.0%ni, 17.1%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu5 : 56.8%us, 26.2%sy, 0.0%ni, 16.9%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st Cpu6 : 59.0%us, 26.3%sy, 0.0%ni, 13.0%id, 1.7%wa, 0.0%hi, 0.0%si, 0.0%st Cpu7 : 56.5%us, 27.2%sy, 0.0%ni, 16.3%id, 0.0%wa, 0.0%hi, 0.0%si, 0.0%st</code> </pre><br>  This testing is intended solely for understanding how the simplest parallel code speeds up everything at times.  And also to demonstrate how simple and relatively safe it is to program parallel computing in Go. <br><br>  Go ahead.  Let's compare the effectiveness of Go-rutin compared to native streams, for example in C ++. <br><br>  I admit, I am not a fighter in boost and a new C ++, but in C ++ the solution is quite elegant. <br><br>  It was interesting to compare the productivity of streams in both languages ‚Äã‚Äãin terms of speed from creating and assigning them work.  As I understand it, this is a battle between pthreads and the go-rutin system, which are not operating system threads.  As <a href="http://golang.org/doc/effective_go.html">stated in the documentation</a> : <br><br><blockquote>  If so, it would be a rule, for example, to continue, and to continue.  Their design and development. <br></blockquote><br>  I took the last boost, and conducted an experiment on the same eight processor machine. <br><br>  The program will need to do a lot of work of the same type (in fact, call a function).  Tasks will be multiplexed between several parallel streams.  The function itself will be elementary and fast.  I hope these will be able to focus testing specifically on the flow subsystem, rather than on the payload. <br><br>  So, the program on Go: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jobs *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = flag.Int(<span class="hljs-string"><span class="hljs-string">"jobs"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">"number of concurrent jobs"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = flag.Int(<span class="hljs-string"><span class="hljs-string">"tasks"</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>, <span class="hljs-string"><span class="hljs-string">"number of tasks"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { flag.Parse() fmt.Printf(<span class="hljs-string"><span class="hljs-string">"- running %d concurrent job(s)\n"</span></span>, *jobs) fmt.Printf(<span class="hljs-string"><span class="hljs-string">"- running %d tasks\n"</span></span>, *n) tasks := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, *jobs) done := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; *jobs; i++ { <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> runner(tasks, done) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= *n; i++ { tasks &lt;- i } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; *jobs; i++ { tasks &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;- done } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tasks </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, done </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg := &lt;- tasks; arg == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } worker() } done &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br>  Makefile to run on a series of parameters: <br><br><pre> <code class="bash hljs">target = go_threading all: build build: 6g $(target).go 6l -o $(target) $(target).6 run: (time -p ./$(target) -tasks=$(args) \ 1&gt;/dev/null) 2&gt;&amp;1 | head -1 | awk <span class="hljs-string"><span class="hljs-string">'{ print $$2 }'</span></span> n = \ 10000 \ 100000 \ 1000000 \ 10000000 \ 100000000 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: @<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(n); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"`printf '% 10d' $</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">`"</span></span> `$(MAKE) args=$<span class="hljs-variable"><span class="hljs-variable">$i</span></span> run`; \ <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  C ++ program: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;boost/thread.hpp&gt; #include &lt;boost/bind.hpp&gt; #include &lt;queue&gt; #include &lt;string&gt; #include &lt;sstream&gt; class thread_pool { typedef boost::function0&lt;void&gt; worker; boost::thread_group threads_; std::queue&lt;worker&gt; queue_; boost::mutex mutex_; boost::condition_variable cv_; bool done_; public: thread_pool() : done_(false) { for(int i = 0; i &lt; boost::thread::hardware_concurrency(); ++i) threads_.create_thread(boost::bind(&amp;thread_pool::run, this)); } void join() { threads_.join_all(); } void run() { while (true) { worker job; { boost::mutex::scoped_lock lock(mutex_); while (queue_.empty() &amp;&amp; !done_) cv_.wait(lock); if (queue_.empty() &amp;&amp; done_) return; job = queue_.front(); queue_.pop(); } execute(job); } } void execute(const worker&amp; job) { job(); } void add(const worker&amp; job) { boost::mutex::scoped_lock lock(mutex_); queue_.push(job); cv_.notify_one(); } void finish() { boost::mutex::scoped_lock lock(mutex_); done_ = true; cv_.notify_all(); } }; void task() { volatile int r = 0; } int main(int argc, char* argv[]) { thread_pool pool; int n = argc &gt; 1 ? std::atoi(argv[1]) : 10000; int threads = boost::thread::hardware_concurrency(); std::cout &lt;&lt; "- executing " &lt;&lt; threads &lt;&lt; " concurrent job(s)" &lt;&lt; std::endl; std::cout &lt;&lt; "- running " &lt;&lt; n &lt;&lt; " tasks" &lt;&lt; std::endl; for (int i = 0; i &lt; n; ++i) { pool.add(task); } pool.finish(); pool.join(); return 0; }</span></span></span></span></code> </pre><br>  Makefile: <br><br><pre> <code class="bash hljs">BOOST = ~/opt/boost-1.46.1 target = boost_threading build: g++ -O2 -I $(BOOST) -o $(target) \ -lpthread \ -lboost_thread \ -L $(BOOST)/stage/lib \ $(target).cpp run: (time -p LD_LIBRARY_PATH=$(BOOST)/stage/lib ./$(target) $(args) \ 1&gt;/dev/null) 2&gt;&amp;1 | head -1 | awk <span class="hljs-string"><span class="hljs-string">'{ print $$2 }'</span></span> n = \ 10000 \ 100000 \ 1000000 \ 10000000 \ 100000000 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: @<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(n); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"`printf '% 10d' $</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">`"</span></span> `$(MAKE) args=$<span class="hljs-variable"><span class="hljs-variable">$i</span></span> run`; \ <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  In both languages, the number of threads will be equal to the number of processors - 8. The number of tasks that are run through these eight threads will vary. <br><br>  Run the program in C ++: <br><br><pre> <code class="bash hljs">make &amp;&amp; make -s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> g++ -O2 -I ~/opt/boost-1.46.1 -o boost_threading \ -lpthread \ -lboost_thread \ -L ~/opt/boost-1.46.1/stage/lib \ boost_threading.cpp (time -p LD_LIBRARY_PATH=~/opt/boost-1.46.1/stage/lib ./boost_threading \ 1&gt;/dev/null) 2&gt;&amp;1 | head -1 | awk <span class="hljs-string"><span class="hljs-string">'{ print $2 }'</span></span> 10000 0.03 100000 0.35 1000000 3.43 10000000 29.57 100000000 327.37</code> </pre><br>  Go now: <br><br><pre> <code class="bash hljs">make &amp;&amp; make -s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> 6g go_threading.go 6l -o go_threading go_threading.6 10000 0.00 100000 0.03 1000000 0.35 10000000 3.72 100000000 38.27</code> </pre><br>  The difference is obvious. <br><br>  By the way, if you set the GOMAXPROCS = 8 variable, than to tell Go to use all 8 processors (the default is only one, regardless of how many physical processors there are), then the speed of the Go program drops wildly and becomes almost equal to the C ++ program time.  It turns out that the lightweight Go threads, being multiplexed into native threads, work faster. <br><br>  Maybe I am comparing salt with red, and the results are simply inadequate.  I would be very grateful for the hint in which parrots to measure correctly. <br><br>  Posts on Go: <ul><li>  <a href="http://easy-coding.blogspot.com/2011/02/go-url.html">Go language in action - multi-server URL reduction in less than an hour</a> </li><li>  <a href="http://easy-coding.blogspot.com/2010/03/go-c-c.html">Sieve of Eratosthenes - who is faster: Go, C or C ++?</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/117842/">https://habr.com/ru/post/117842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117833/index.html">Become an effective IT manager!</a></li>
<li><a href="../117836/index.html">How to choose a good hosting for a decent site</a></li>
<li><a href="../117838/index.html">What to read to increase your level of JavaScript</a></li>
<li><a href="../117839/index.html">Putin explained the position of the FSB to control Skype</a></li>
<li><a href="../117841/index.html">Comrades children!</a></li>
<li><a href="../117843/index.html">re2c - regular expression compiler</a></li>
<li><a href="../117844/index.html">Hit print</a></li>
<li><a href="../117845/index.html">We invite you to participate in DEVCONF 2011 on June 4 (PHP, PERL, PYTHON, RUBY, .NET, JS)</a></li>
<li><a href="../117846/index.html">Opera Startup Awards begins!</a></li>
<li><a href="../117847/index.html">Do most Android users hate Apple?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>