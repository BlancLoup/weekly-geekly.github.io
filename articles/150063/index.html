<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grouping serial posts close in time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, Habr! 

 The project encountered the following task: there is a news feed of photos, which users can post to only one photo at a time,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grouping serial posts close in time</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, Habr! <br><br>  The project encountered the following task: there is a news feed of photos, which users can post to only one photo at a time, and they need to be displayed together as a gallery.  In other words, all sample lines need to be logically combined into several ‚Äútime windows‚Äù for each author and use this when displaying. <br><br>  It begs to group the following posts one by one, but this does not work: if two users simultaneously upload hundreds of photos in parallel and slowly, they are added to the tape one by one, and when viewing posts, it will be unpleasant to alternate. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Behind the MySQL solution <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br><br>  Immediately, I‚Äôll make a reservation that grouping posts during selection is wrong: it‚Äôs very desirable that groups of images remain static and nothing falls off from anywhere.  Thus, each post must clearly belong to some kind of ‚Äúgroup‚Äù, visually represented by the gallery. <br><br>  The solution is not a panacea, but there is a range of tasks where exactly this approach can be useful. <br><br>  First, create a table for the experiments: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span>( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>, <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'author id'</span></span>, <span class="hljs-string"><span class="hljs-string">`image`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'posted image filename'</span></span>, <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'post group'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(<span class="hljs-string"><span class="hljs-string">`user_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(<span class="hljs-string"><span class="hljs-string">`tm`</span></span>,<span class="hljs-string"><span class="hljs-string">`group`</span></span>) );</code> </pre> <br><br>  The <code>`feed`</code> is a list of posts.  Each post has time to add <code>tm</code> , a link to the <code>user_id</code> , the actual picture, and also we add a special column <code>group</code> which allows you to group images into the gallery.  When adding a new entry <code>group=NULL</code> . <br><br><h4>  The option is wrong </h4><br>  At first it seems: we select the most recent post, then we select the posts of the same user within a radius of one hour, and assign them all to <code>group= id--</code> .  Only in this case each post will turn out to belong only to its own group.  No, it does not fit :) <br><br><h4>  Grouping </h4><br><br>  First you need to determine the criterion of the time proximity of posts: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @granularity:=<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>;</code> </pre><br><br>  So, all posts within one hour are grouped into one gallery. <br><br>  Then we make the following logical move: we give each post to become the ‚Äúbasis‚Äù for the group: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>;</code> </pre><br><br>  And such a group will contain lines in the hourly radius from the ‚Äúwarp‚Äù (time difference - within one hour): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span>, <span class="hljs-string"><span class="hljs-string">`f`</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>-@granularity <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> )</code> </pre><br><br>  So, now each line has a number of candidates for the basics.  Selection criteria: choose the post containing the greatest number of posts in its hourly radius as the ‚Äúbasis‚Äù. <br>  In order not to strain MySQL with extra calculations - instead of a radius, we use the criterion <code>`id`</code> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span>, <span class="hljs-string"><span class="hljs-string">`f`</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>-@granularity <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span></code> </pre><br><br>  So, we selected all lines and for each of them set group. <br><br>  I note that there is a nuance.  When displaying such a tape, we will now sort by <code>`group` DESC</code> .  Then, if the <code>MAX()</code> function is used in the above code, then the most recent ‚Äúgroup‚Äù (which received the last update) will jump to the very top in tape sorting. <br>  This behavior can be easily changed: then we get permanent groups, such that elements cannot move from one to another: it‚Äôs enough to use the <code>MIN()</code> function: the oldest post will always become the basis, and the group can only be supplemented by new incoming photos: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span>, <span class="hljs-string"><span class="hljs-string">`f`</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>+@granularity ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span></code> </pre><br><br>  Now we need to update the table based on the results of this query: set the value of the <code>`group`</code> column.  MySQL does not allow you to update the table from which you are reading in a single <code>UPDATE</code> request, so you must first transfer our sample to a temporary table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`_feedg`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span>, <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>-@granularity <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>()<span class="hljs-number"><span class="hljs-number">-2</span></span>*@granularity) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span>;</code> </pre><br><br>  Pay attention to the <code>WHERE</code> condition that appears: it is used for optimization so that the rearrangement is carried out only at the very top of the table, among the latest records. <br><br>  Now, using a temporary table, you can update the original: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`_feedg`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span>(<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span>;</code> </pre><br><br>  It is desirable to perform the query after each insertion, but for optimization it is possible to do this by cron, leaving part of the work on the output algorithm. <br><br>  <b>UPD:</b> as <a href="https://habrahabr.ru/users/melkij/" class="user_link">Melkij</a> suggested - indeed, you can update if the read request is made a subquery instead of a JOIN.  Then we completely remove the <code>CREATE TEMPORARY TABLE</code> , and the <code>UPDATE</code> query will look like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span>, <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>-@granularity <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`tm`</span></span> &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>()<span class="hljs-number"><span class="hljs-number">-2</span></span>*@granularity) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> ) <span class="hljs-string"><span class="hljs-string">`g`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span>(<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-string"><span class="hljs-string">`f`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span> = <span class="hljs-string"><span class="hljs-string">`g`</span></span>.<span class="hljs-string"><span class="hljs-string">`group`</span></span>;</code> </pre><br><br><h4>  Selections </h4><br><br>  Now, how to correctly select from such a table? <br><br>  If <code>`group`</code> for all lines, then <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, <span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br><br>  However, if the above query runs on the crown and, therefore, we have part of the lines for which <code>group=NULL</code> , part of the output logic should be assigned to the script renderer, and the sample should be done like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`feed`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, <span class="hljs-string"><span class="hljs-string">`tm`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br><br><h4>  Links </h4><br><br>  My question on stackoverflow is: <a href="http://stackoverflow.com/questions/10542647/grouping-serial-posts-in-a-user-feed">Stackoverflow: Grouping serial posts in a user feed</a> .  Here you can admire how it is done in Oracle using "temporary windows". <br><br>  SQLfiddle, play <a href="http://sqlfiddle.com/">around</a> : <a href="http://sqlfiddle.com/">SQLfiddle</a> <br><br>  I hope I was helpful. </div><p>Source: <a href="https://habr.com/ru/post/150063/">https://habr.com/ru/post/150063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150056/index.html">"Unbiased" universal algorithmic intelligence</a></li>
<li><a href="../150059/index.html">PDFsharp and MigraDoc Foundation (Basics)</a></li>
<li><a href="../150060/index.html">Sell ‚Äã‚Äãyourself</a></li>
<li><a href="../150061/index.html">Printing Yandex.Maps under API 2.x with labels and clusters</a></li>
<li><a href="../150062/index.html">War and peace with the Office of "K"</a></li>
<li><a href="../150064/index.html">The insides of the QML engine. Part 1: Downloading Files</a></li>
<li><a href="../150065/index.html">23 reasons not to believe in bullshit about working in large companies</a></li>
<li><a href="../150066/index.html">Major Steam Community Update</a></li>
<li><a href="../150067/index.html">Homomorphic DIY Encryption</a></li>
<li><a href="../150068/index.html">Path with direction signs on a map using Yandex Map Kit for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>