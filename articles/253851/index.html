<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another option for dynamic DNS on its site or how I gave up dyndns</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has long been using the service from the company dyndns, which allowed to bind the domain name to the dynamic ip-address of the computer. It is con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another option for dynamic DNS on its site or how I gave up dyndns</h1><div class="post__text post__text-html js-mediator-article">  It has long been using the service from the company dyndns, which allowed to bind the domain name to the dynamic ip-address of the computer.  It is convenient to administer the client, it is convenient for the client to connect to the work computer from home.  But for some time the service began to tighten the nuts. <br><br>  At first, you could use the same domain name on your account for free.  Later, the domain name began to be reset every month - it periodically required efforts to restore work.  Other free services didn‚Äôt look good and at some point I signed up for their paid service for $ 25 a year, which gave me the opportunity to use up to 30 domain names. <br><br>  There was an inconvenience ‚Äî the Windows client program visualizes all the domain names of my account when it is set up, and any client may accidentally or intentionally damage the binding of someone else‚Äôs domain name.  In general, it is oppressive, but tolerable.  Last week it‚Äôs time to renew for a year.  The price rose to $ 30, and the ruble fell to this point to 60 rubles per dollar.  I felt sorry for the rubles and I decided to press the dynamic DNS on my site. <br><a name="habracut"></a><br>  Initial data: <br><ul><li>  windows and * nix machines with dynamic ip </li><li>  freebsd 9.3 </li><li>  bind9 </li><li>  apache 2.4 </li><li>  php 5.3 </li><li>  your domain </li></ul><br>  What you need to get: <br><ul><li>  easy to use client </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Decision: <br><br>  Suppose our domain is MyDomain.ru.  We describe it as a master zone in /etc/namedb/named.conf: <br><br><pre><code class="bash hljs">zone <span class="hljs-string"><span class="hljs-string">"MyDomain.ru"</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> master; file <span class="hljs-string"><span class="hljs-string">"/etc/namedb/master/MyDomain.ru"</span></span>; };</code> </pre> <br>  Accordingly, in /etc/namedb/master/MyDomain.ru we write something like: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ORIGIN</span></span> . <span class="hljs-variable"><span class="hljs-variable">$TTL</span></span> 3600 ; 1 hour MyDomain.ru IN SOA ns1.MyDomain.ru. root.MyDomain.ru. ( 2015032014 ; serial 10800 ; refresh (3 hours) 3600 ; retry (1 hour) 604800 ; expire (1 week) 86400 ; minimum (1 day) ) NS ns1.MyDomain.ru. NS ns2.MyDomain.ru. A 188.120.254.163 MX 10 mail.MyDomain.ru. MX 20 mail.MyDomain.ru. <span class="hljs-variable"><span class="hljs-variable">$ORIGIN</span></span> MyDomain.ru. mail A 192.168.0.1 ns1 A 192.168.0.1 ns2 A 192.168.0.1 smtp A 192.168.0.1 www A 192.168.0.1</code> </pre><br>  After doing: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'named_enable="YES" '</span></span> &gt;&gt; /etc/rc.conf /etc/rc.d/named start</code> </pre><br><br>  We get a working dns-server, we check by pinging the resolution of names in addresses, if there is a firewall, do not forget to open ports 53 and 953 at the entrance.  Configuring rndc - named daemon management utility. <br><br><pre> <code class="bash hljs">rndc-confgen</code> </pre><br>  Its output is distributed in two files: <br><br><pre> <code class="bash hljs">key <span class="hljs-string"><span class="hljs-string">"rndc-key"</span></span> { algorithm hmac-md5; secret <span class="hljs-string"><span class="hljs-string">"rxeXMLrA\1py6mDLhGO7dA=="</span></span>; }; options { default-key <span class="hljs-string"><span class="hljs-string">"rndc-key"</span></span>; default-server 127.0.0.1; default-port 953; };</code> </pre><br>  We put in /etc/namedb/rndc.conf, and <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># key "rndc-key" { # algorithm hmac-md5; # secret "rxeXMLrA\1py6mDLhGO7dA=="; # }; # # controls { # inet 127.0.0.1 port 953 # allow { 127.0.0.1; } keys { "rndc-key"; }; # };</span></span></code> </pre><br>  before removing the comment, add to /etc/namedb/named.conf.  If everything is correct, the following command should succeed: <br><br><pre> <code class="bash hljs">rndc reload</code> </pre><br><br>  You can see the status <br><pre> <code class="bash hljs">rndc status</code> </pre><br>  You can read man by rndc <br><br>  You need to add some rights to the user, on behalf of which the named operates: <br><br><pre> <code class="bash hljs">chown <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> /etc/named/master</code> </pre><br>  Create the user ddns (with the home directory / home / ddns) on whose behalf the dns server write update script will run. <br>  Create a script with the following content and place it in /home/ddns/ddns.sh, for example: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/local/bin/bash TTL=120 SERVER=127.0.0.1 ZONE=MyDomain.ru. HOSTNAME=$1.$ZONE KEY="rxeXMLrA\1py6mDLhGO7dA==" new_ip_address=$2 nsupdate &lt;&lt; EOF server $SERVER key rndc-key $KEY zone $ZONE update delete $HOSTNAME A update add $HOSTNAME $TTL A $new_ip_address send EOF</span></span></code> </pre><br>  Does not forget <br><pre> <code class="bash hljs">chown ddns:ddns /home/ddns/ddns.sh chmod 700 /home/ddns/ddns.sh</code> </pre><br>  Call it with two parameters <br><br><pre> <code class="bash hljs">/home/ddns/ddns <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> 192.168.0.2</code> </pre><br>  should add to our zone a third level domain test.MyDomain.ru with the address 192.168.0.2. <br><br>  Now it remains to somehow allow clients to access this script so that they can update their names in the zone to the actual ip-addresses.  I solved this with a web server.  In the configuration, Apache allowed virtual servers and created one for his own needs. <br><br><pre> <code class="bash hljs">&lt;VirtualHost *:80&gt; ServerAdmin root@MyDomain.ru DocumentRoot <span class="hljs-string"><span class="hljs-string">"/usr/local/www/ddns"</span></span> ServerName ddns.MyDomain.ru DirectoryIndex index.php ErrorLog <span class="hljs-string"><span class="hljs-string">"/var/log/apache/ddns-error.log"</span></span> CustomLog <span class="hljs-string"><span class="hljs-string">"/var/log/apache/ddns-access.log"</span></span> common &lt;Directory <span class="hljs-string"><span class="hljs-string">"/usr/local/www/ddns"</span></span>&gt; AllowOverride All Order allow,deny Require valid-user Allow from all AuthName <span class="hljs-string"><span class="hljs-string">"Who are you?"</span></span> AuthType Basic AuthUserFile /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/www/ddns/.htpasswd &lt;/Directory&gt; &lt;/VirtualHost&gt;</code> </pre><br>  The main nuance is that access to this site is possible only with the user name and password.  The credentials are stored in /usr/local/www/ddns/.htpasswd, in the same directory we place the php-script with the following content: <br><br><pre> <code class="bash hljs">&lt;?php <span class="hljs-variable"><span class="hljs-variable">$User</span></span> = <span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"REMOTE_USER"</span></span>]; <span class="hljs-variable"><span class="hljs-variable">$IP</span></span> = <span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">"REMOTE_ADDR"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$IP</span></span>; <span class="hljs-variable"><span class="hljs-variable">$CMD</span></span> = <span class="hljs-string"><span class="hljs-string">'sudo -u ddns /home/ddns/ddns.sh '</span></span> . <span class="hljs-variable"><span class="hljs-variable">$User</span></span> . <span class="hljs-string"><span class="hljs-string">' '</span></span> . <span class="hljs-variable"><span class="hljs-variable">$IP</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> (<span class="hljs-variable"><span class="hljs-variable">$CMD</span></span>); ?&gt;</code> </pre><br><br>  Unfortunately, I could not run the bash script directly from php, I suppose this is caused by the security settings of the www user, on whose behalf the web server service is running.  Therefore, I use sudo on behalf of the user ddns (a regular user, in the home directory of which the script itself is located).  Here is the contents of the / usr / local / etc / sudoers file for this: <br><br><pre> <code class="bash hljs">www ALL=(ddns) NOPASSWD: /home/ddns/ddns.sh</code> </pre><br>  Well, do not forget, in fact, fill the file with credentials: <br><br><pre> <code class="bash hljs">htpasswd -b /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/www/ddns/.htpasswd <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-password htpasswd -b /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/www/ddns/.htpasswd test1 test1-password htpasswd -b /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/www/ddns/.htpasswd test2 test2-password</code> </pre><br>  If sudo is properly configured, there are no problems with the user access rights for the www user, then when the client accesses the resource <br><pre> <code class="bash hljs">http://ddns.MyDomain.ru</code> </pre><br>  get an invitation to enter credentials. <br><br>  Enter the login and password, we get the answer in the browser with the ip-address of the client.  On the server, at the same time, the php-script updates the domain name in dns by the client‚Äôs login and ip-address.  I also consider it reasonable to add the following lines to the named setting for our zone: <br><br><pre> <code class="bash hljs"> update-policy { grant rndc-key name test.MyDomain.ru. A; grant rndc-key name test1.MyDomain.ru. A; grant rndc-key name test2.MyDomain.ru. A; };</code> </pre><br>  So that the key rndc-key can only edit the allowed domain names.  It would be good to also communicate with the client and the server via https so that open passwords do not walk on the Internet. <br><br>  It remains only to finish the client.  Everything is simple there. <br><br><pre> <code class="bash hljs">curl -u <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-password http://ddns.MyDomain.ru</code> </pre><br>  The curl utility in * nix systems should be by default, for Windows it will have to be downloaded.  To issue this command in a bat-file or sh-script and place it in the task scheduler or cron, respectively, with a call interval of 5 minutes. <br><br>  To connect the next client to this scheme, we invent a login (domain of the 3rd level) and a password for it.  We correct client script and add credentials to .htpasswd. </div><p>Source: <a href="https://habr.com/ru/post/253851/">https://habr.com/ru/post/253851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253839/index.html">Automation of stock trading on the MICEX on the example of the terminal from Alfa Bank</a></li>
<li><a href="../253841/index.html">20 years of building and maintaining a satellite network</a></li>
<li><a href="../253845/index.html">Overview of the practical side of Bitcoin</a></li>
<li><a href="../253847/index.html">Data center construction boom starts in Iceland</a></li>
<li><a href="../253849/index.html">Free webinar "Virtualization based on Hyper-V 3.0 and Windows Server 2012R2 Virtual Desktop Infrastructure"</a></li>
<li><a href="../253855/index.html">Farewell Note to the Programming Language</a></li>
<li><a href="../253857/index.html">Range functionality with ObservableCollection</a></li>
<li><a href="../253859/index.html">Deconvolutional Neural Network</a></li>
<li><a href="../253861/index.html">3CX updated software client for Mac</a></li>
<li><a href="../253863/index.html">Google Maps History</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>