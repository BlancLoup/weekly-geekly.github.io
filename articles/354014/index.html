<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Heroes of Might and Magic" in the browser: long, difficult and unbearably interesting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to implement a game in the browser, in which years ago it stuck without any browser? What difficulties will you encounter in the process, and how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Heroes of Might and Magic" in the browser: long, difficult and unbearably interesting</h1><div class="post__text post__text-html js-mediator-article">  How to implement a game in the browser, in which years ago it stuck without any browser?  What difficulties will you encounter in the process, and how can they be solved?  And finally, why do it at all? <br><br>  In December, <b>Alexander Korotayev</b> (Tinkoff.ru) told at the HolyJS conference how he made the browser version of Heroes.  The video of the report has already appeared, and now we have also made a text version for Habr.  To whom it is more convenient video - run the movie, and to whom the text - read it under the cut: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/9Ep-1GTQ2hQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  I would like to tell you about how I made those third ‚ÄúHeroes‚Äù in the browser, in which many of you, I think, played in childhood. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before you take on any interesting long journey, you should see the route.  I went to GitHub and saw that every two months a new clone of Heroes appeared.  These are repositories with two or three commits, where literally several functions are added, and the person throws them, because it is difficult to do.  He understands the entire burden of responsibility, which will fall on him, if this finish.  Here I have provided links to the most successful repositories that can be found: <br><br><ol><li>  <a href="https://github.com/sfia-andreidaniel/heroes3">sfia-andreidaniel / heroes3</a> </li><li>  <a href="https://github.com/mwardrop/HOMM3Clone">mwardrop / HOMM3Clone</a> </li><li>  <a href="https://github.com/potmdehex/homm3tools">potmdehex / homm3tools</a> </li><li>  <a href="https://github.com/openhomm/openhomm">openhomm / openhomm</a> </li><li>  <b><a href="https://github.com/vcmi/vcmi">vcmi / vcmi</a></b> </li></ol><br>  I singled out the last one to highlight its importance to the community, because it is the only fully written clone of ‚ÄúHeroes‚Äù in C, using the distribution of original resources that can be put to it.  And this is the only way to run third ‚ÄúHeroes‚Äù on Android devices.  They run through the emulator, the problem is that they are very slow, the touch-interface is not available there, you have to move the mouse - in general, this is only for very large fans. <br><br>  What goals did I set for myself when I took it? <br><br><ul><li>  I really wanted to do something, I wanted to jump above my head.  Naturally, I wanted to show myself.  In general, it was originally planned as a private site. </li><li>  I also wanted to stop playing games in general, and in ‚ÄúHeroes‚Äù in particular.  As you know, the best defense is an attack.  You start to develop games, you start to play them differently and much less. </li><li>  And I also wanted to do something very beautiful, because I always strived for the beauty of the interfaces, and the toy itself is very beautiful. </li></ul><br>  At first I tried to repeat the original image: <br><br><img src="https://habrastorage.org/webt/d7/sk/bw/d7skbwa8luawjkp4adqvmqszxyi.jpeg"><br><br>  Below you can see the original editor and its simple render, and my simple render, which, however, cost without flags at that time.  This is practically the first screenshot of the game development.  By the way, it may also be useful for you to take screenshots of some of your own projects that will kill someone, because one day it may be necessary.  I needed a screenshot for my report, although I didn‚Äôt plan on it initially, I just wanted to save the story.  I thought it was a long story, and I should keep it in pictures. <br><br>  And so, I almost repeated the picture of the original game, but I had to move on. <br><br>  For a start, for those who are not aware of gamedev in JavaScript, I will tell you what a regular game consists of: <br><br><ul><li>  Data model  That is, this is some kind of map, characters, a scene, simply where we have objects. </li><li>  A game loop or game loop that cheats every second, doing something with objects and changing the model. </li><li>  There is also user input processing.  These are reactions to input from the keyboard, joystick, mouse, whatever. </li><li>  And the most beautiful part is the render, which should render the model.  In fact, the model changes, and the drawing works independently. </li></ul><br>  If we present this in the form of code, everything is simple: <br><br><pre><code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> me = {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Alex'</span></span>, <span class="hljs-attr"><span class="hljs-attr">left</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} <span class="hljs-number"><span class="hljs-number">02.</span></span> ... <span class="hljs-number"><span class="hljs-number">03.</span></span> setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> update(), <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-number"><span class="hljs-number">04.</span></span> ... <span class="hljs-number"><span class="hljs-number">05.</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'keyup'</span></span>, () =&gt; me.left++) <span class="hljs-number"><span class="hljs-number">06.</span></span> ... <span class="hljs-number"><span class="hljs-number">07.</span></span> requestAnimationFrame(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> draw())</code> </pre> <br>  What is behind this: <br><br><ul><li>  Line 01: model.  She trite something keeps. </li><li>  Line 03: game loop.  This is setInterval, which calls the update () function. </li><li>  Line 05: input processing.  A regular EventListener for user events, which, for example, shifts a character to the right. </li><li>  Line 07: rendering.  This is a requestAnimationFrame that allows us to call a callback, aiming for 60 frames per second.  When the browser is hidden, it is not called, otherwise it is drawn along with the browser window, very convenient. </li></ul><br>  You can read more about game development on JS in the book <a href="https://bakhirev.biz/book/">‚ÄúSurrealism on JavaScript‚Äù</a> , open it at least for the sake of such wonderful pictures: <br><br><img src="https://habrastorage.org/webt/ii/ne/gk/iinegkryli8pkk-hxjfgjufc1eg.jpeg"><br><br><hr><br><h2>  Brief history of game development </h2><br>  If you want to start making your ‚ÄúHeroes‚Äù, you have: <br><br><ol><li>  Original game </li><li>  Map editor.  The developers at first thought that he would allow the game to live for a maximum of two more years, how badly they were wrong! </li><li>  <a href="https://vk.com/fizmig">FizMig</a> is a great reference for all game mechanics.  Its remarkable fact is that people empirically calculated all probabilities of loss of skills, spells, any damage, and presented it in formulas and tables with a percentage ratio.  People have been working for ten years, that is, they are very big fanatics, even I cannot compare with them. </li><li>  There are many forums with guys who have been digging in ‚ÄúHeroes‚Äù for many years.  By the way, Russian-speaking forums: English-speaking guys almost did not dig. </li><li>  Resource unpacker, thanks to which you can get pictures, data, anything. </li></ol><br>  I started with rendering the usual green field, as in the first picture: <br><br><img src="https://habrastorage.org/webt/ik/cj/xm/ikcjxmk7dwbpy-ewx-yq9l8zquk.jpeg"><br><br>  Here you can see how I drew objects on the green field and debugged their important points.  Red dots - this is obstruction, yellow - some kind of action at this point.  At the castle action is only where you can go, the hero is on the whole model. <br><br>  Next, I worked with the data.  Data is a list of all skills, monsters, characters, maps, everything related to text and binary files that you had to read and somehow accumulate. <br><br><img src="https://habrastorage.org/webt/zo/72/u1/zo72u1atmvthfz4alusigjo_dni.jpeg"><br><br>  Then I worked with algorithms.  I did not get the algorithms right away.  Here I tried to make a path finding algorithm: <br><br><img src="https://habrastorage.org/webt/bj/yj/vc/bjyjvcgg1z0xvdc5jtrl0aeldse.jpeg"><br><br>  But not everything worked smoothly, this is probably one of his best runs. <br><br>  I realized how much I was wrong when I tried to write it myself.  However, in my case nothing was going smoothly, in fact I was walking practically across the field from a rake.  Fortunately, I did not give up and still tried to find a way out of this situation, and I somehow managed to do it. <br><br><hr><br><h2>  Parsing maps </h2><br>  At the beginning there was a very important stage, it was relatively boring, difficult, and this is the parsing of maps.  The fact is that if it were not for him, there would be nothing.  Since it was not interesting for me to draw just a field with objects that I superimposed on each other with the help of some offset, I wanted to read the original maps in order to have a convenient editor with which you can immediately watch the changes in the game: <br><br><img src="https://habrastorage.org/webt/ge/bx/us/gebxusszzm8cieqexbgsa40feeg.jpeg"><br><br>  When you open a map in this editor, you see an excellent visual interface for editing any buildings, objects, and so on.  It is convenient, understandable and intuitive.  Many thousands or tens of thousands of cards for ‚ÄúHeroes‚Äù have already been made, there are still a lot of them. <br><br>  But if you want to read it as a developer, you will see that this is just a binary code that is difficult to read: <br><br><img src="https://habrastorage.org/webt/he/0d/lz/he0dlzgemd9ivgdivzj3jvvlbko.jpeg"><br><br>  I was meditating on this code, I found some poor specifications on how it works and what it has inside, and over time I even began to read it.  I have been looking at it for literally two weeks, and I am already starting to see some regularities! <br><br>  Then I realized that something was wrong with me, I started digging and found out that normal guys read this in editors with template support: <br><br><img src="https://habrastorage.org/webt/r-/3d/pb/r-3dpbhxwkbt3jfnhlha112yj0u.jpeg"><br><br>  <a href="http://heroescommunity.com/viewthread.php3%3FTID%3D25570%26PID%3D593180">Templates</a> have already been written for maps that allow them to be parsed in the 010 Editor.  In it, they open as in a browser.  You see something like dev-tools, you can hover over some section of code, and it will show what's inside there.  This is much more convenient than the one I tried to work with earlier. <br><br>  Suppose there are scripts, it remains to write the code.  At the beginning I tried to do it in PHP, because I did not know another language that could cope with it, but over time I came across <a href="https://github.com/potmdehex/homm3tools">homm3tools</a> .  This is a set of libraries to work with different data "Heroes".  Basically, this is a parser of various card formats, a map generator, a render of inscriptions from trees, and even a game "Snake" from game objects.  When I saw this craft, I realized that with homm3tools you can do anything, and the fanaticism of this person lit me.  I started to communicate with him, and he convinced me that I should learn C and write my converter, which I, in general, did: <br><br><img src="https://habrastorage.org/webt/oy/bt/zp/oybtzpsz1fixarzuqa3ms9nrhda.jpeg"><br><br>  In fact, my <a href="https://github.com/lekzd/h3m-map-convertor">converter</a> allows you to take a regular map file for ‚ÄúHeroes‚Äù and turn it into readable JSON.  Readable for both javascript and humans.  That is, I can see what is in this map, what data is there and quickly understand how to work with it. <br><br>  The data became more and more, the number of objects grew, I ran all the big cards and saw that resources were leaking somewhere.  They became smaller and smaller, and even a small movement on this map caused friezes and brakes.  It was very unplayable and ugly. <br><br><hr><br><h2>  Everything slows down! </h2><br>  What should I do about it?  I never encountered this, and first went to look at the drawing of maps.  The map is big, it probably slows down. <br><br>  But first, a little theory.  Since everything is drawn on Canvas, I would like to explain how it differs from the DOM.  In the DOM, you simply take an element, you can move it, and you do not think about how it is drawn, just move it, and that‚Äôs it.  To move and draw something on the canvas, you need to erase it every time: <br><br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>) <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-number"><span class="hljs-number">03.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">04.</span></span> ctx.clearRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-number"><span class="hljs-number">05.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">06.</span></span> ctx.clearRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-number"><span class="hljs-number">07.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  If there is grass under the hero you are animating in this way, you have to draw grass: <br><br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>) <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-number"><span class="hljs-number">03.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">04.</span></span> ctx.drawImage(grass, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">05.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">06.</span></span> ctx.drawImage(grass, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">07.</span></span> ctx.drawImage(hero, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  This is even more expensive and even more complicated, and in the case of very complex backgrounds, this is a very difficult task at all. <br><br>  Therefore, I propose to draw in layers: <br><br><img src="https://habrastorage.org/webt/cx/-x/dr/cx-xdr5kbc0uwntqftadblfodn4.jpeg"><br><br>  You just take the layers, and mixes their video card, which is what it should do.  So I saved a lot on redrawing, each layer is updated with its order, drawn at different times.  I got a more or less fast render, with which you could really do something complicated. <br><br>  I simply use three Canvas that are superimposed on each other: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùterrain‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùobjects‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùui‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Their names speak for themselves.  Terrain - grass, roads and rivers. <br><br>  If you look at the terrain drawing algorithm, it may seem quite loaded in terms of resources: <br><br><ol><li>  Take soil type tile </li><li>  Draw it with offset and rotation, because the developers of the original game saved a lot on resources </li><li>  Impose river </li><li>  Impose road </li><li>  And there are still special soil types. </li></ol><br>  And all this needs to be rendered, and preferably not in runtime.  Therefore, I advise you to draw it as soon as you make the first render of the map, and put it in the cache.  Drawing finished pictures is much cheaper than drawing roads again each time you need them. <br><br>  How to smoothly move the map?  I had problems with this, but I came across a solution from Yandex.Map: <br><br><img src="https://habrastorage.org/webt/ow/rw/qc/owrwqc8to4mtl8vmjzj9cgvcwh0.jpeg"><br><br>  The fact is that when you move the map, it changes the transformation.  This operation, as many know, is performed only on the video card, without causing Repaint.  Quite a cheap operation to move a rather large picture.  But every 32 pixels I compensate for the left of this card, in fact I‚Äôm just redrawing it, but the user has the impression of a continuous movement of the map.  What I wanted to achieve, so implemented in Yandex.Maps, and so I implemented. <br><br>  Then I started drawing objects, because the optimization of one map was not enough for me.  But first, a little theory.  The fact is that the axis of drawing objects in "Heroes" is inverted.  In fact, objects are drawn from the bottom right corner.  Why is this done?  The fact is that we look at the map as if from above, but in order to give the player the impression that he is looking at three-quarters from the side, the objects are drawn from bottom to top, overlapping each other. <br><br><img src="https://habrastorage.org/webt/k7/f3/hu/k7f3hu-atgmqfl9ot_b9rluurig.jpeg"><br><br>  Algorithm for drawing objects: <br><br><ol><li>  Sort an array of Y lower bound of each object (textures of different heights, you need to take this into account) </li><li>  We filter those that do not fall into the window (to draw what a person does not see is a little expensive) </li><li>  There are a lot of different checks. </li><li>  Draw the texture of the object </li><li>  If necessary, draw a flag player <br>  And this is all despite the fact that the number of objects can reach over 9000!  What to do, how to draw it in runtime?  I think that it is better not to draw it in runtime, and now I will tell you how. <br><br><img src="https://habrastorage.org/webt/xu/ij/vh/xuijvh11bpc4zxxh-yroebpzp5y.jpeg"><br><br>  To begin with, I found a drawing algorithm such as renderTree.  It is used, for example, in the browser to draw DOM elements that hang over each other with a Z-index.  And each branch that is in this tree is the Y axis, by which the objects are sorted.  In turn, on each branch all objects are sorted by the X axis. <br><br>  What do we get from this?  We get a cheaper iteration, because we can immediately cut off branches that do not fall on the screen.  And with each iteration of the branch, we will look at the X object, and as soon as we bump into an object that just does not fit in the map, we stop iterating over this object.  Thus, fewer objects are affected than if we simply ran through the array.  Also, we are immediately given the correct overlapping of objects, because they are already sorted.  Thus, it turns out competent data storage. <br><br>  Next, I went to the drawing function: <br><br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = getObject(id) <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {x, y} = getAnimationFrame(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> offsetleft = getMapLeft() <span class="hljs-number"><span class="hljs-number">04.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> offsetTop = getMapTop() <span class="hljs-number"><span class="hljs-number">05.</span></span> <span class="hljs-number"><span class="hljs-number">06.</span></span> context.drawImage(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>.texture, x - offsetleft, ‚Ä¶</code> </pre><br>  We see that each function consists of the fact that I define the final displacement of an object, its frame for animation, and, most importantly, the drawImage function.  It all came down to this function, and it was necessary to somehow optimize it. <br><br>  I realized that I can simply create this function through bind with the necessary parameters and save it directly in the renderTree.  That is, I stopped storing objects there, and began to store only the functions of drawing.  There‚Äôs nothing more to do, so I got a great performance boost. <br><br><img src="https://habrastorage.org/webt/dh/6k/2f/dh6k2fc2k9slba3cnxhhvttagtw.jpeg"><br><br>  But it‚Äôs not just the objects, it‚Äôs also that the game shouldn‚Äôt slow down in terms of animation.  Konyashka should run around the screen perfectly, otherwise you will get the impression that there is something wrong with the game. <br><br>  Let's go into geometry a little bit to understand what we had to go through.  There, when you lay a segment at a certain distance in any direction - even horizontally, even diagonally - they are equal. <br><br><img src="https://habrastorage.org/webt/cx/qb/3p/cxqb3pt26yg9wfqeyvrny00ckcq.jpeg"><br><br>  But this is geometry.  And we have ‚Äúheroic metric‚Äù.  The problem there is that this is a game on a grid, where the diagonal and horizontal displacements in fact are not equal, but the game considers that it is equal, and everything is fine. <br><br><img src="https://habrastorage.org/webt/l1/m-/bq/l1m-bq2jyk0f0rnbx-qszaoetfg.jpeg"><br><br>  How to live with it?  If to count, then for horizontal movement we make four steps of animation, for diagonal - about six.  I started looking for a solution on how to make this animation really smooth. <br><br>  The problem with JavaScript is that it is single-threaded and handles tasks.  Each setTimeout that we set creates a separate task, it competes with other tasks that we have, for example, with other setTimeout.  And in this regard, nothing will save us. <br><br>  I tried to do it through setTimeout, through setInterval, through requestAnimationFrame - everything creates tasks that compete with each other. <br><br><img src="https://habrastorage.org/webt/im/fq/d2/imfqd2eenohzhl80ke-i7pphd18.jpeg"><br><br>  And with a large number of calculations when a player moves, competing tasks spoil my entire animation. <br><br>  I went to look further and found that in JavaScript, it turns out, there are microtasks that are part of the tasks.  They are needed in cases where the callback that you transmit to, say, in Promise, the only object that does the microtask can occur either immediately or asynchronously.  Therefore, just in case, a microtask was implemented, which takes precedence over the task. <br><br><img src="https://habrastorage.org/webt/rh/7o/-w/rh7o-warujvhzd_wopghtm5wlks.jpeg"><br><br>  In fact, we get a non-blocking loop that can be used for animation.  Read more about this in Jake Archibald‚Äôs <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">article</a> . <br><br>  For starters, I took everything and wrapped it in Promise: <br><br><pre> <code class="hljs javascript"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-number"><span class="hljs-number">02.</span></span> setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-comment"><span class="hljs-comment">//    04. requestAnimationFrame(() =&gt; /*  */) 05. resolve() 06. }) 07. })</span></span></code> </pre><br>  I still needed setTimeout to do the animation, but it was already in Promise.  I did the calculations for the animation and fed to the requestAnimationFrame function what I needed to draw on the basis of these calculations so that the calculations did not block the drawing, and it went when it was really necessary. <br><br>  Thus, I was able to build a whole sequence of animation steps: <br><br><pre> <code class="hljs vbscript"><span class="hljs-number"><span class="hljs-number">01.</span></span> startAnimation() <span class="hljs-number"><span class="hljs-number">02.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) <span class="hljs-number"><span class="hljs-number">03.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) <span class="hljs-number"><span class="hljs-number">04.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) <span class="hljs-number"><span class="hljs-number">05.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) <span class="hljs-number"><span class="hljs-number">06.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(doAction) <span class="hljs-number"><span class="hljs-number">07.</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(endAnimation)</code> </pre><br>  But I realized that this object is not very configurable and does not strongly reflect what I want.  And I thought of storing animations in an object called AsyncSequence: <br><br><pre> <code class="hljs vbscript"><span class="hljs-number"><span class="hljs-number">01.</span></span> AsyncSequence([ <span class="hljs-number"><span class="hljs-number">02.</span></span> startAnimation, [ <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">step</span></span> <span class="hljs-number"><span class="hljs-number">04.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">step</span></span> <span class="hljs-number"><span class="hljs-number">05.</span></span> ...], <span class="hljs-number"><span class="hljs-number">06.</span></span> doAction, <span class="hljs-number"><span class="hljs-number">07.</span></span> endAnimation <span class="hljs-number"><span class="hljs-number">08.</span></span> ])</code> </pre><br>  In essence, this is a kind of reduce, which is traversed by the Promise and calls them sequentially.  But it is not as simple as it seems, the fact is that it also has nested animation loops.  That is, after startAnimation, I could thrust an array from one step.  Suppose there are seven or eight of them, as much as you need for the diagonal animation of the hero. <br><br>  As soon as the hero reaches a certain point, the reject comes out in this animation, the animation stops, and the AsyncSequence understands that it is necessary to switch to the parent branch, and there already the doAction and endAnimation is called.  It is very convenient to do complex animation declaratively, as it seemed to me. <br><br><hr><br><h2>  Data storage </h2><br>  But not only thanks to the renderer we can increase our productivity.  It turned out that most of all it slows down the storage of data, which was for me the greatest surprise in JavaScript. <br><br>  To begin with, we find the data that is most inhibited, and this is a map.  The whole map is a grid, it consists of tiles.  Tiles are some conditional small squares in the grid that have their own texture, their own set of data, and allow us to build a map from a limited number of textures, as all the old games did. <br><br>  This data set contains: <br><br><ol><li>  Type of tile (water, earth, wood) </li><li>  Passability / cost of moving the tile </li><li>  Presence of an event </li><li>  Flag "Who is busy" </li><li>  Other fields depending on the implementation of your engine </li></ol><br>  In the code, this can be represented as a grid: <br><br><pre> <code class="hljs markdown">01.const map = [<span class="hljs-string"><span class="hljs-string"> 02. [{...}, {...}, {...}, {...}, {...}, {...}</span></span>], 03. [<span class="hljs-string"><span class="hljs-string">{...}, {...}, {...}, {...}, {...}, {...}</span></span>], 04. [<span class="hljs-string"><span class="hljs-string">{...}, {...}, {...}, {...}, {...}, {...}</span></span>], 05. ... 06. ] 07.const tile = map[<span class="hljs-string"><span class="hljs-string">1</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">3</span></span>]</code> </pre><br>  The same visual design as the tile grid.  An array of arrays, in each array we have objects that contain something for the tile.  We can get a specific tile by offsetting X and Y. This code works, and it seems to be normal. <br><br>  But.  We have an algorithm for finding a path, which in itself is quite expensive, it has to take into account the mass of details that are not only in the tiles, but also in the objects.  And when we move the mouse, the cursor changes depending on whether we can reach this point, whether the opponent is at this point or some kind of action. <br><br><img src="https://habrastorage.org/webt/hk/hl/pw/hkhlpwoalns_zvrxgjoo3qvmske.jpeg"><br><br>  For example, hovering on a tree - a regular cursor appeared, because it is impossible to pass to this point.  And we need to show the number of days it takes to get to the point.  That is, in fact, we are chasing the pathfinding algorithm all the time, and that same grid works very slowly. <br><br>  To get the tile property, I needed: <br><br><ol><li>  Request an array of tiles </li><li>  Request array array for string </li><li>  Request Tile Object </li><li>  Request Property Property </li></ol><br>  The four heap calls, as it turned out, are very slow when we need to request a map so many times for the pathfinding algorithm. <br><br>  And what can you do about it?  At first, I looked at the data: <br><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tile = { <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-comment"><span class="hljs-comment">//    03. render: {...}, 04. //     05. passability: {...}, 06. //      07. otherStuff: {...}, 08. }</span></span></code> </pre><br>  I saw that each tile object consists of what is needed for the render, what is needed for the pathfinding algorithm, and other data that is needed much less frequently.  They were called each time, despite the fact that they were not needed.  It was necessary to discard these data and figure out how to store them. <br><br>  And I found that the fastest way to read this data is from an array. <br><br><img src="https://habrastorage.org/webt/gs/7o/me/gs7ome7iesjlzgr53dfsx9dvys8.jpeg"><br><br>  After all, a tile object can be divided into arrays.  Of course, if you write the business code at work, there will be questions for you.  But we are talking about performance, and here all the means are good.  We just take a separate array, where we store the type of the object in the tile, or that the tile is empty, and with it an array of numbers for the algorithm for finding the path, which is a simple unit / zero "cell is passable or not." <br><br>  But for the path finding algorithm, you need not only to find out if there is an object or not, and put a one or zero.  Different types of soil have different permeability, different characters walk differently, all this must be considered. <br><br><img src="https://habrastorage.org/webt/lf/3i/w-/lf3iw-0tpja7xz2bj9pztyw0j0u.jpeg"><br><br>  This simple array is calculated by complex algorithms of two large arrays: with tiles and with objects.  Thus, we get the already calculated numbers that can be quickly used in the path finding algorithm.  We consider in advance when the object is updated, update and value. <br><br>  As a result, we have a lot of arrays that cache and bind something: <br><br><ul><li>  An array of drawing functions for the drawing cycle </li><li>  Array of numbers to find the way </li><li>  Array of strings to associate objects to tiles </li><li>  Array of numbers for additional properties of tiles </li><li>  Map of objects with their ID for game logic </li></ul><br>  All that remains is the timely update of data from slow to faster storage. <br><br>  Of course, the question is how to get away from an array of arrays, which is much slower than a regular array. <br><br>  In fact, I switched to a regular array, just by expanding the array of arrays, it works 50% faster: <br><br><img src="https://habrastorage.org/webt/8v/ba/jw/8vbajwxxtqygglquenpaaikt4oa.jpeg"><br><br>  Getting data offset in an array is simple.      Y,   ,      ,  X. <br><br>  Further more.    ,            X  Y .     - , ,    X  Y,  - : <br><br><pre> <code class="hljs cpp"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span> = [{...}, {...}, {...}, {...}, ...] <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tile = <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>[y * width + x] <span class="hljs-number"><span class="hljs-number">04.</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.forEach((value, index) =&gt; { <span class="hljs-number"><span class="hljs-number">05.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> y = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(index / width) <span class="hljs-number"><span class="hljs-number">06.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> x = index - (y * width) <span class="hljs-number"><span class="hljs-number">07.</span></span> })</code> </pre><br>    ,   ,   . ,     ,    ,     . <br><br>      : <br><br><img src="https://habrastorage.org/webt/nh/r6/d6/nhr6d6d5b6wnhwikchh_mxpuraq.jpeg"><br><br>       ¬´Power of 2¬ª,       ¬´ ¬ª  ¬´ ¬ª,  ,     .        ,    ,     . <br><br>   ,       -, ,  ,   ,     .            ,      . <br><br>   ,   ,      ,   ,    ,    ,     ,      ,     ,  ,    . <br><br>  ,    ,        ,   ,     ,  ,  - ,       . <br><br><pre> <code class="hljs javascript"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> map = [{...}, {...}, {...}, {...}, ...] <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> powerOfTwo = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.ceil(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.log2(width)) <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-number"><span class="hljs-number">04.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tile = map[y &lt;&lt; powerOfTwo + x] <span class="hljs-number"><span class="hljs-number">05.</span></span> map.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value, index</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-number"><span class="hljs-number">06.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> y = index &gt;&gt; powerOfTwo <span class="hljs-number"><span class="hljs-number">07.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> x = index - (y &lt;&lt; powerOfTwo) <span class="hljs-number"><span class="hljs-number">08.</span></span> })</code> </pre><br> ,  50x50,       50       (  X  Y,        ). <br><br>   ,      : <br><br><img src="https://habrastorage.org/webt/hl/hf/ot/hlhfot_piismkfvkyzufr-ufmk0.jpeg"><br><br>    ,      MIP-,  - ,       .          ,   ,    ,    . <br><br>     Grid. Grid ‚Äî        ,   ,   X  Y  , , ,    X  Y. <br><br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> grid = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Grid(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-number"><span class="hljs-number">02.</span></span> <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tile = grid.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(x, y) <span class="hljs-number"><span class="hljs-number">04.</span></span> grid.forEach((<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, x, y) =&gt; {})</code> </pre><br>   ,        ,      ,     .     ,        ,  256:   ,  ,     .       ,      .     ,      256x256,    . <br><br><hr><br><h2> UI  Canvas </h2><br>     UI  Canvas.    , ,  ,   UI   HTML.   ,      ,   .         . <br><br>      ,    - ,    eventListener.   ,    - . <br><br><pre> <code class="hljs coffeescript"><span class="hljs-number"><span class="hljs-number">01.</span></span> const okButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buttton(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'Ok'</span></span>) <span class="hljs-number"><span class="hljs-number">02.</span></span> okButton.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ... }) <span class="hljs-number"><span class="hljs-number">03.</span></span> const cancellButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buttton(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'Cancel'</span></span>) <span class="hljs-number"><span class="hljs-number">04.</span></span>cancellButton.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ... })</code> </pre><br>   ,        ,     .    ¬´¬ª ,     . <br><br><pre> <code class="hljs javascript"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> okButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buttton({ <span class="hljs-number"><span class="hljs-number">02.</span></span> left: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">03.</span></span> top: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">04.</span></span> onClick: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ... } <span class="hljs-number"><span class="hljs-number">05.</span></span> }) <span class="hljs-number"><span class="hljs-number">06.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cancellButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Buttton({...})</code> </pre><br>    ,   ,   JSON. <br><br><pre> <code class="hljs coffeescript"><span class="hljs-number"><span class="hljs-number">01.</span></span> [ <span class="hljs-number"><span class="hljs-number">02.</span></span> { <span class="hljs-number"><span class="hljs-number">03.</span></span> id: <span class="hljs-string"><span class="hljs-string">'okButton'</span></span>, <span class="hljs-number"><span class="hljs-number">04.</span></span> options: { <span class="hljs-number"><span class="hljs-number">05.</span></span> left: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">06.</span></span> top: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">07.</span></span> onClick: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ... } <span class="hljs-number"><span class="hljs-number">08.</span></span> }, <span class="hljs-number"><span class="hljs-number">09.</span></span> },</code> </pre><br>    ,     ,    .    ,        .   ,   .  ,  ,   ,     . <br><br>   ,   XML. XML ‚Äî    ,   HTML,      ,        JSON,   ,    . <br><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">01.</span></span> &lt;button <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"okButton"</span></span> <span class="hljs-number"><span class="hljs-number">02.</span></span> left=<span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-number"><span class="hljs-number">03.</span></span> top=<span class="hljs-string"><span class="hljs-string">"10"</span></span> <span class="hljs-number"><span class="hljs-number">04.</span></span> onClick=<span class="hljs-string"><span class="hljs-string">"{doSomething()}"</span></span> <span class="hljs-number"><span class="hljs-number">05.</span></span> /&gt;</code> </pre><br>  ,         .     ,     . <br><br>  ,     ,      ,     ,    .     ,         . <br><br><pre> <code class="hljs xml">01. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> &gt;</span></span> 02. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"header"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> &gt;</span></span> 03. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">text-block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span> 04. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span> 05. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> 06. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"footer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> &gt;</span></span> 07. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">any-component</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span> 08. <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span> 09. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> 10. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  ,   ,    ‚Äî   XML -  Canvas.    ‚Äî <a href="https://github.com/Flipboard/react-canvas">react-canvas</a> ,     ,  ,     - ,     - ,       . <br><br><hr><br><h2>     </h2><br>     , ,  ,  ‚Ä¶ ,    :      ?   - : <br><br><img src="https://habrastorage.org/webt/k6/b4/_4/k6b4_4rygnk8szhxggnqu3fc52u.jpeg"><br><br>   ,   ,         , ,  -   ,    -  ,      ‚Äî       .       , -  ,     . <br><br>      .  ‚Äî  ,     .     , , ,    .     ,  ,   ,    . ,      . <br><br>    ,    ,    .   - ,     .      ? <br><br>    : <br><br><img src="https://habrastorage.org/webt/is/xd/hw/isxdhwujygktroixtgbaetagqrw.jpeg"><br><br>    A*.       .  ‚Äî  ,      ,  ,  ,   .  ,            ‚Äî  ,    .   ¬´¬ª     (    ,     ,   ,     ,    ). <br><br> ,    ,   .          .  Why do you need it?   , ,       ,     ,   ,  : <br><br><img src="https://habrastorage.org/webt/g8/qa/2g/g8qa2gdeap52dsznncsi_dgslks.jpeg"><br><br>        ,           ,    . <br><br>        ,  ,      ,  : <br><br><ul><li>       ID     </li><li>   : ,    </li><li>     ID </li><li> ,         </li></ul><br>  ,     ,        PubSub   events: <br><br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">01.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> objectInAction = Objects.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(ID) <span class="hljs-number"><span class="hljs-number">02.</span></span><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hero = Player.activeHero <span class="hljs-number"><span class="hljs-number">03.</span></span> objectInAction.events.dispatch(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, hero) <span class="hljs-number"><span class="hljs-number">04.</span></span> ... <span class="hljs-number"><span class="hljs-number">05.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.events.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(<span class="hljs-string"><span class="hljs-string">'action'</span></span>, hero =&gt; { <span class="hljs-number"><span class="hljs-number">06.</span></span> hero.owner.resources.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">'gems'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-number"><span class="hljs-number">07.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>() <span class="hljs-number"><span class="hljs-number">08.</span></span> })</code> </pre><br>         ,    ,    callback    (      ¬´action¬ª   ,    ‚Äî  .      ,      ). <br><br> ,       , ,     ,        : <br><br><ul><li>     </li><li>      </li><li>       </li><li>    </li><li>     </li><li>  -,     </li><li>          ( ,   save/load,     ,    ) </li></ul><br>    ,      . ,    ,      ‚Äî   10%,  , , .  ,      90% ,     ,    -    .      ,   ,   ,     . <br><br>             ,            .         ,         ,   ,       ,   .        .      ,      ?     ,    ,  - ,         ? <br><br>   ?    ,     : <br><br><pre> <code class="hljs coffeescript"><span class="hljs-number"><span class="hljs-number">01.</span></span> //        <span class="hljs-number"><span class="hljs-number">02.</span></span> @Mixin(Attacable) <span class="hljs-number"><span class="hljs-number">03.</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TownObject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OwnershipObject</span></span></span><span class="hljs-class"> {...} 04. //     ,    .. 05. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OwnershipObject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MapObject</span></span></span><span class="hljs-class"> {...} 06. //        07.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MapObject</span></span></span><span class="hljs-class"> {...}</span></span></code> </pre><br>    ,    -    .     ,     - . , TownObject,    ,   Attacable,     .  ,      ,        ,     ,  ,  ,     (  ,    ,  ,   ). <br><br>    TownObject   OwnershipObject,   ,   ,      .       ,   ,  ,  ,    -  .   ,   ,    MapObject,       ,   . <br><br><hr><br><h2>  findings </h2><br>        ?       .    ,    ,    ,    (,  ). , ,       . ,          ,          ,   - ,     . <br><br>  :     ?       . ,    -     ?      , ,  ,    , : ¬´      webpack  -      ,      ¬ª.     ,      ,   ,    .   ,    ! <br><br>    : <br><br><ul><li>     </li><li>       .   , ,      ,     web-,  ,       ,    ,  , ,  . </li><li>    ,   ,   . </li><li>     ,   -   ¬´¬ª.         ,  - . -   , -      .  ,  ,     ,     ,      .     . </li></ul><br>   : <br><br><ul><li>   ,   ,   ,      ,     </li><li>       ,     . ,      , , ,    ,     ,   ,    ,        . </li><li>   .     ,       ,     . </li></ul><br>   ,     ,      .    ,  , ,    ,     .          ,      .         ,    ,         50,   ,   . <br><br>      ,      ,      .      ,     ,    ,  -     .      ,    .          ÃÅ . <br><br>     ,    : <br><br><ul><li> <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators">    JS</a> </li><li> <a href="http://gameprogrammingpatterns.com/contents.html"> ¬´Game Programming Patterns¬ª</a> </li><li> <a href="http://qiao.github.io/PathFinding.js/visual/">      </a> </li><li> <a href="https://vk.com/fizmig">FizMig</a> (       ¬´¬ª) </li></ul><br> ,  , <a href="http://homm.lekzd.ru/"></a> ,    .    . <br><blockquote>  Minute advertising.        HolyJS,  :  19-20   <b>HolyJS 2018 Piter</b> .   <a href="https://holyjs-piter.ru/"> </a>    ,   ,        ! </blockquote></li></ol></div><p>Source: <a href="https://habr.com/ru/post/354014/">https://habr.com/ru/post/354014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354002/index.html">Future single B2B market or technology game?</a></li>
<li><a href="../354004/index.html">What happens to the bitten apple? That's right - it spoils</a></li>
<li><a href="../354008/index.html">10,000 likes</a></li>
<li><a href="../354010/index.html">Measurement of fluid level in the rocket fuel tank</a></li>
<li><a href="../354012/index.html">How to improve the channels in the Telegram?</a></li>
<li><a href="../354016/index.html">–ï–ì–ê–ò–° 3.0: the differences in the implementation of the metering in wholesale and retail</a></li>
<li><a href="../354018/index.html">Google blocked by Roskomnadzor</a></li>
<li><a href="../354020/index.html">Solving the riddle of round numbers on the 2018 election chart</a></li>
<li><a href="../354024/index.html">The digest of interesting materials for the mobile developer # 250 (April 16 - April 22)</a></li>
<li><a href="../354026/index.html">Review of OpenDay JetBrains mitap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>