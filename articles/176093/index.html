<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of security of the Android operating system. Security at the Application Framework level. Binder ipc</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 After a short break, I continue to explain the basic principles of how security is provided in the Android operating system. Today I wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of security of the Android operating system. Security at the Application Framework level. Binder ipc</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  After a short break, I continue to explain the basic principles of how security is provided in the Android operating system.  Today I will begin to describe security at the Application Framework level.  But in order to understand this topic, you first need to consider how the Inter-Process Communication (IPC) mechanism is implemented in Android.  This mechanism is called Binder IPC, and today we will consider its features.  All who are interested, welcome! <br><a name="habracut"></a><br><br><br><h4>  List of articles </h4>  Below are links to my articles in this series: <br><ol><li>  <a href="http://habrahabr.ru/post/175517/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/175517/">Core level</a> </li><li>  <a href="http://habrahabr.ru/post/176131/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176131/">Native user space, part 1</a> </li><li>  <a href="http://habrahabr.ru/post/176631/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176631/">Native user space, part 2</a> </li><li>  <a href="http://habrahabr.ru/post/176093/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176093/">Security at the Application Framework level.</a>  <a href="http://habrahabr.ru/post/176093/">Binder ipc</a> </li></ol><br><br><br><h3>  Why binder ipc? </h3><br>  As I wrote in the first article of the cycle, each Android application runs in its own ‚Äúsandbox‚Äù (Application Sandbox).  The sandbox mechanism in Android is based on assigning each application a unique <b>user ID (UID)</b> and <b>group ID (GID)</b> , thus each application (application or app) in this operating system has its own unique non-privileged user.  We considered this topic in the <a href="http://habrahabr.ru/post/175517/">first article of the cycle</a> .  At the same time, the owners of all critical system resources are more privileged users whose names and identifiers are hardcoded into the system (see <i><a href="">system / core / include / private / android_filesystem_config.h</a></i> ).  System services that run on behalf of these users have access to the relevant critical system resources (for example, GPS data), while normal application processes cannot access these resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, applications should be able to ‚Äúask‚Äù system services to provide them with such information, and the latter, in turn, should be able to provide such information to applications.  Since applications and system services run in different processes, to organize such an exchange, the operating system must provide a mechanism for exchanging information between processes.  Moreover, even regular applications sometimes have to interact with each other.  For example, an email client may ‚Äúask‚Äù the image viewer to display a graphic application to the letter. <br><br>  In Android, the exchange of signals and data between processes is organized using the Inter-Process Communication framework ( <b>Binder</b> ).  The standard <i>System V IPC</i> framework is <a href="https://android.googlesource.com/platform/ndk/%2B/android-4.2.2_r1.2/docs/system/libc/SYSV-IPC.html">not supported by</a> this operating system; in particular, the <b>Bionic libc</b> lacks the header files &lt;sys / ipc.h&gt;, &lt;sys / sem.h&gt;, &lt;sys / shm.h&gt;, &lt;sys / msg.h &gt;.  In some specific cases (for example, to interact with the Zygote daemon), <b>Unix domain sockets are used</b> .  All other methods of interaction between processes, including Intents, are implemented using Binder IPC.  This framework allows you to call remote object methods synchronously and asynchronously as if they were local, exchange file descriptors between processes, <b>link to death</b> (automatically notify if the Binder of a specific process was interrupted), etc. <br><br><br><h3>  How does binder ipc work? </h3><br>  The interaction between processes is organized according to a synchronous client-server model.  The client initiates the connection and waits for a response from the server.  Thus, the interaction between the client and the server occurs sequentially.  This design allows the developer to call remote methods as if they were in the same process.  It should be noted that this does not disagree with what I wrote above about the asynchronous method call: in the case of an asynchronous call, the server immediately returns an empty response to the client.  The diagram of the interaction of processes through Binder is presented in the following figure: an application (client) that runs in <i>Process A</i> gains access to the functionality implemented in the service that runs in <i>Process B.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/236/e4b/555/236e4b55544aa9a4485acb60d8c5460a.png"><br><br>  All interactions between the client and the server within Binder occur through the special Linux device driver (device driver) <b>/ dev / binder</b> .  In the article <a href="http://habrahabr.ru/post/176131/">"Fundamentals of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176131/">Native user space, part 1 ‚Äù</a> we looked at the system boot process.  One of the first daemons launched by the <i>init</i> process is ueventd, an external device manager on Android.  This service reads the <a href="">ueventd.rc</a> configuration file during start and plays back events of adding external devices.  These events expose permissions for devices (permissions), as well as the owner (owner) and group (owning group).  In the following example, you can see which permissions are set for <b>/ dev / binder</b> . <br><br><pre><code class="hljs erlang">... /dev/ashmem <span class="hljs-number"><span class="hljs-number">0666</span></span> root root /dev/binder <span class="hljs-number"><span class="hljs-number">0666</span></span> root root ...</code> </pre> <br><br>  As you can see, the permissions for this device are set to 0666. This means that any user of the system (and we remember that different applications on Android are unique users) has the right to write to and read from this device.  To interact with this driver library <b>libbinder</b> was created.  This library allows you to make the process of interaction with the driver transparent to the application developer.  In particular, the interaction between the client and the server occurs through a <b>proxy</b> (proxy) on the client side and a <b>stub</b> on the server side (see figure above).  Proxies and Stubs are responsible for marshaling data and commands transmitted through the driver.  Those.  Proxy builds (marshalling) the data and commands received from the client in such a way that they can be correctly read (unmarshalling) and clearly understood by Stub.  In general, application developers do not even write Stubs and Proxy for their applications.  Instead, they use the interface described by the AIDL language.  During the compilation of the application, based on this interface, the code for the Stubs and Proxy is generated (you can search in your projects to see how they look). <br><br>  On the server side, a separate binder stream is created for each client request (see figure above).  Typically, these threads are called Binder Thread #n.  By the way, if memory serves me, then the maximum number of Binder threads is 255, and the maximum amount of data that can be transferred through Binder in a single transaction is 1Mb.  This should be borne in mind when developing applications that transmit or receive data from other processes. <br><br><br><h3>  Service Manager </h3><br>  Attentive readers should have noted for themselves the fact that before that I had not written anything about how Android understands which process you need to send data.  Technically, each Binder service assigns a 32-bit token, which is unique in all processes of the system (what the driver is monitoring).  This token is used as a pointer to the service.  If the client has this pointer, then it can interact with the service.  But first, the client needs to get this unique value. <br><br>  To do this, the client refers to the <b>Binder context manager</b> , which in the case of Android is called <b>Service Manager</b> (servicemanager).  Service Manager is a special service whose Binder token is known to everyone in advance.  It is not surprising that the value of the token for this service is 0. The binder driver allows registration of only one service with such a token, therefore the servicemanager is one of the first services launched in the system.  Service Manager can be presented in the form of a directory.  You say that you want to find a service with such a name, and you are returned in response to its unique token number, which you can use later to interact with the desired service.  Naturally, the service must first register in this "directory". <br><br><br><h3>  Security </h3><br>  By itself, the Binder framework is not responsible for security in the system, but it provides mechanisms for its maintenance.  First, the binder driver writes the PID and UID of the process that initiates the transaction to each transaction.  The called service can use this information to decide whether to fulfill the request or not.  You can get this information using the methods <b>android.os.Binder.getCallingUid ()</b> , <b>android.os.Binder.getCallingPid ()</b> .  Secondly, since the Binder token is unique within the system and its value is not known a priori, it can itself be used as a security token (see, for example, <a href="http://www.androiddesignpatterns.com/2013/07/binders-window-tokens.html">this article</a> ). <br><br><br><br><h3>  Conclusion </h3><br>  In the next part I plan to write about permissions (permissions).  The material is already there, but you need to translate it and earn some money.  As always I will be grateful for interesting questions and explanations in the comments, maybe I misunderstood some moments for myself. <br><br><br><h4>  Links </h4><br><ol><li>  <a href="https://thenewcircle.com/s/post/1340/Deep_Dive_Into_Binder_Presentation.htm">Deep Dive Into Binder Framework</a> by Aleksandar Gargenta </li><li>  <a href="http://shop.oreilly.com/product/0636920021094.do">"Embedded Android"</a> by Karim Yaghmour </li><li>  <a href="http://www.nds.rub.de/media/attachments/files/2012/03/binder.pdf">‚ÄúAndroid Binder.</a>  <a href="http://www.nds.rub.de/media/attachments/files/2012/03/binder.pdf">Android Interprocess Communication ¬ª</a> by Thorsten Schreiber </li></ol></div><p>Source: <a href="https://habr.com/ru/post/176093/">https://habr.com/ru/post/176093/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176081/index.html">eBay plans to ‚Äúflood the planet‚Äù by 2015</a></li>
<li><a href="../176083/index.html">People began to move to Yukoz</a></li>
<li><a href="../176087/index.html">ASP.NET MVC Lesson B. Json</a></li>
<li><a href="../176089/index.html">Deploy NetScaler VPX Express to Vmware ESX / Hyper-V</a></li>
<li><a href="../176091/index.html">Review of the Chinese tablets Ainol Spark and Ainol Venus: Price vs Quality</a></li>
<li><a href="../176097/index.html">ASP.NET MVC Lesson D. Scaffolding</a></li>
<li><a href="../176101/index.html">Why register a computer program?</a></li>
<li><a href="../176103/index.html">Wikipedia is not going to submit to the pressure of "weak and cowardly politicians"</a></li>
<li><a href="../176113/index.html">Proxifiers or how it works</a></li>
<li><a href="../176115/index.html">Hosting Encrypted Video Content Using HTML5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>