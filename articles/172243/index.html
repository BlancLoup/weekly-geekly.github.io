<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bar of Desires by March 8 in Python and Pyramid</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to congratulate the girls at work with a wonderful holiday of spring? This year I wanted to do something unusual, something to surprise them in ad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bar of Desires by March 8 in Python and Pyramid</h1><div class="post__text post__text-html js-mediator-article">  How to congratulate the girls at work with a wonderful holiday of spring?  This year I wanted to do something unusual, something to surprise them in addition to traditional gifts and flowers.  This is how the Desire Bar web application, created in one day using <a href="http://www.python.org/">Python</a> and <a href="http://www.pylonsproject.org/projects/pyramid/about">Pyramid, appeared</a> . <br><br><img src="https://habrastorage.org/storage2/2fc/22c/13d/2fc22c13dfa748841314d898e0b2443e.png"><br><br>  Maybe after reading the article, someone decides to re-use the ‚ÄúWish Bar‚Äù for congratulations.  Maybe someone will discover Pyramid - a web framework, perfect for quickly creating small web projects.  Finally, you can simply pick up the source code of the application from <a href="https://github.com/rgmih/wishbar">GitHub</a> for your own use. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The article shows the process of developing a small web application, starting with the formulation of the problem and design and ending with the deployment of the application on the server.  In the course of the article, comments are given on the implementation, which explain with examples some principles of web applications in general and Pyramid in particular.  Thus, the article can also be viewed as a guide for Pyramid for beginners on the example of a real problem. <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  On March 1, a week before International Women's Day, the male part of our team gathered in a meeting room to solve a difficult problem - how to congratulate our girls on the wonderful holiday of spring.  During the discussion, a simple and at the same time extremely difficult idea to realize was born - to fulfill all their wishes on this holiday.  And if not all (and we sensibly assessed our strength), then at least some, the simplest.  This is how the concept of the ‚Äúbar of desires‚Äù appeared. <br><br>  ‚ÄúBar of Desires‚Äù is a virtual bar in which a girl can choose everything she likes, specify special wishes and place an order.  This order must be processed by the responsible officer and arrange for the delivery of the chosen ‚Äúwishes‚Äù to the girl.  The menu of the bar includes such "desires" as "A slice of cake" or "Strawberry with ice cream" - desserts, fruits, drinks.  The menu should be made with humor.  Orders must be processed promptly - you can not make the girl wait. <br><br>  First of all - specification and design.  Define usage scenarios. <br><br><ol><li>  Girl: open a web application, select ‚Äúwishes‚Äù from the list, specify if necessary special requests in the form of text, place an order, admire which guys are great.  If desired, repeat the procedure. </li><li>  The waiter (male employee): promptly receive an alert about the order made, prepare a set of ‚Äúwishes‚Äù chosen by the girl, bring the ‚Äúwishes‚Äù to the girl at the workplace. </li></ol><br>  In order for the waiter to know who to carry the completed order, it is necessary to distinguish the users of the web application.  Enough to know the name of the girl.  So ask her to specify the name before placing the order.  We do not need authorization: a) we are in the local network, there are no villains;  b) hardly girls want to fill in authorization forms on such a day.  Knowing the name, you can refer to it in the application by name, it adds a sense of individual approach.  For greater certainty when placing an order, you can remember the IP-address. <br><br>  Notify the waiters by means of Google Talk - the jabber server on the local network did not catch on, many have google accounts, IM is faster than email.  Finally, we have experience with Google Talk in Python via <a href="http://xmpppy.sourceforge.net/">xmpppy</a> - a script works on the server in the office, which periodically selects the person responsible for watering the flowers and sends him a reminder message. <br><br><h4>  Web application </h4><br><blockquote>  The following description assumes that you are familiar with Python and understand the basic principles of building web applications. </blockquote><br>  Start by creating a project directory.  We name the project wishbar (hereinafter, all the paths to the files are given relative to the project directory).  Create a web application module ( <code>server.py</code> file): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wsgiref.simple_server <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> make_server <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyramid.config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Configurator <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> config = Configurator() app = config.make_wsgi_app() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: app = create_app() server = make_server(<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>, app) server.serve_forever()</code> </pre><br><blockquote>  For launching web applications, a simple minimalistic HTTP server with <a href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a> support is used - the <a href="http://docs.python.org/2/library/wsgiref.html">wsgiref.simple_server</a> module from the standard Python library.  It is quite enough for our web application, both for development and use in a local network.  At least for now.  At the end of the article it will be shown how to prepare the Pyramid application for deployment on the server - in combat we will use another server. </blockquote><br>  Check the availability of the application through the browser at <a href="http://localhost:8080/">http: // localhost: 8080 /</a> .  The server is available, but returns only 404 Not found. <br><br>  In the web application, we need styles, scripts and images.  Create directories js, css, img and add view-functions (views, views; eng. Views) to handle statics. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> config = Configurator() path = os.path.abspath(__file__) root = path[:path.rindex(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)] config.add_static_view(<span class="hljs-string"><span class="hljs-string">"css"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}/css"</span></span>.format(root)) config.add_static_view(<span class="hljs-string"><span class="hljs-string">"js"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}/js"</span></span>.format(root)) config.add_static_view(<span class="hljs-string"><span class="hljs-string">"img"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}/img"</span></span>.format(root)) app = config.make_wsgi_app() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app</code> </pre><br>  Now requests to URLs like <code>/css/*</code> , <code>/js/*</code> , <code>/img/*</code> will return files from the corresponding directories. <br><blockquote>  To each request coming to the server, Pyramid must associate a view-function that will process it.  If the function cannot be found, the client will return a response with an error status.  Pyramid has several ways to register view functions.  To register static handlers, we use the imperative approach - when we call <a href="http://www.kemeneur.com/clients/pylons/docs/pyramid/api/configuration.html">add_static_view</a> , an object of the <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/api/static.html">pyramid.static.static_view</a> class is created and registered, which will process requests to URLs starting with the prefix passed in the first parameter. </blockquote><br>  Let's do HTML.  Let's start with "hello world".  Add a route to the web application configuration. <br><br><pre> <code class="python hljs">config = Configurator() config.add_route(<span class="hljs-string"><span class="hljs-string">"index_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/"</span></span>)</code> </pre><br><blockquote>  The route is determined by the URL pattern (second parameter).  The first parameter is the name of the route.  If the requested URL falls under the route pattern, the view request processing function associated with the route is called. <br><br>  Mapping by route is one way to bind view functions to queries.  There is also a traversal - a search engine for view functions based on a resource tree.  In this web application, only the first approach is used.  You can read more about traversal in the <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/traversal.html">documentation</a> . </blockquote><br>  Create the <code>views.py</code> view functions <code>views.py</code> , add the <code>index_route</code> route handler code to it: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@view_config(route_name="index_route") def index(request): return render_to_response('pt/index.pt', { 'name' : 'world' }, request)</span></span></code> </pre><br>  and the primitive <code>pt/index.html</code> template in the <code>pt</code> folder: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:tal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://xml.zope.org/namespaces/tal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:metal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://xml.zope.org/namespaces/metal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>wishbar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> Hello, ${name}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><blockquote>  <code>render_to_response</code> generates an HTML page for the request <code>request</code> for the <code>pt/index.pt</code> template specified in the first parameter, substituting data from the dictionary in the second parameter. </blockquote><br>  We register this handler in the web application.  You can use the imperative approach, but it's easier to ask the web application in <code>create_app</code> ‚Äúscan‚Äù <code>views.py</code> and register all the handlers described in it. <br><br><pre> <code class="python hljs">config = Configurator() config.add_route(<span class="hljs-string"><span class="hljs-string">"index_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/"</span></span>) config.scan(<span class="hljs-string"><span class="hljs-string">"views"</span></span>)</code> </pre><br>  We need three pages ‚Äî a name entry page, a menu page, and an order confirmation page.  All three pages should have a single design.  Therefore, it is desirable to use templates.  In particular, to have one basic HTML page template, into the body of which the corresponding content will be inserted already for each specific screen.  In the delivery of Pyramid is the <a href="http://chameleon.readthedocs.org/en/latest/">Chameleon</a> template engine, we will choose it.  Create a base template <code>pt/base.pt</code> and a template for each of their three pages - <code>pt/login.pt</code> , <code>pt/index.pt</code> (change the ‚Äúhello world‚Äù), <code>pt/confirm.pt</code> .  To use the <code>base.pt</code> template as a base template, create a file <code>subscribers.py</code> next to the <code>server.py</code> file with the following contents: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyramid.renderers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_renderer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyramid.events <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BeforeRender, subscriber @subscriber(BeforeRender) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_base_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span><span class="hljs-function">:</span></span> base = get_renderer(<span class="hljs-string"><span class="hljs-string">'pt/base.pt'</span></span>).implementation() event.update({<span class="hljs-string"><span class="hljs-string">'base'</span></span>: base})</code> </pre><br>  It remains to register all event handlers from <code>subscribers.py</code> in the web application in the <code>create_app</code> function. <br><br><pre> <code class="python hljs">config = Configurator() config.add_route(<span class="hljs-string"><span class="hljs-string">"index_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/"</span></span>) config.scan(<span class="hljs-string"><span class="hljs-string">"subscribers"</span></span>)</code> </pre><br><blockquote>  <a href="http://docs.pylonsproject.org/projects/pyramid/en/1.0-branch/api/events.html">@subscriber</a> defines the <code>add_base_template</code> function as a handler for internal <a href="http://docs.pylonsproject.org/projects/pyramid/en/1.0-branch/narr/events.html">Pyramid events of</a> type <code>BeforeRender</code> .  The <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/api/events.html">BeforeRender</a> event <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/api/events.html">handler</a> is called immediately before the template is rendered.  In the handler, we can change the set of <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/glossary.html">renderer globals</a> ‚Äî the named values ‚Äã‚Äãavailable in the templates.  In particular, we add the renderer of the base template <code>base.pt</code> to this set under the name <code>base</code> . </blockquote><br>  In <code>pt/base.pt</code> declare the necessary expansion slots: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">metal:define-slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now in the <code>login.pt</code> , <code>index.pt</code> and <code>confirm.pt</code> you can ‚Äúinherit‚Äù from the base template: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:tal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://xml.zope.org/namespaces/tal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:metal</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://xml.zope.org/namespaces/metal"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">metal:use-macro</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"base"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">metal:fill-slot</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content"</span></span></span><span class="hljs-tag">&gt;</span></span> Hello, ${name}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The web application framework is ready, you can do the applied logic.  In the view-function of the main page, you need to check whether we know the user name, or is this a new client.  Suppose that when a girl specifies a name, the web application sends her a cookie with the entered name.  Accordingly, in the handler of the main page we can check whether there is a cookie in the request.  If there is - we know the name and we can display a list of desires.  If not, we display the girl a page with a name entry form. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'username'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.cookies: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_to_response(<span class="hljs-string"><span class="hljs-string">'pt/login.pt'</span></span>, {}, request)</code> </pre><br>  A little work on the layout and styles.  To help take <a href="http://www.zurb.com/blog_uploads/0000/0617/buttons-03.html">awesome-buttons</a> . <br><br><img src="http://habrastorage.org/storage2/b3d/2cf/98e/b3d2cf98ec65d78c0a265f9c87f686ef.png"><br><br>  Since awesome buttons are not buttons, but links, we add some <a href="http://jquery.com/">jQuery</a> to submit the form when a button is clicked.  These forms will be sent to the URL <code>/login/</code> in the form of a POST request.  Add a route and a handler.  In the handler, save the girl's name in the form of a cookie with the <code>username</code> key and send 302 Found to the root of the web application. <br><br><pre> <code class="python hljs">config.add_route(<span class="hljs-string"><span class="hljs-string">"index_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/"</span></span>)</code> </pre><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@view_config(route_name="login_route") def login(request): username = request.params['username'] response = Response() response.set_cookie('username', value=username, max_age=86400) return HTTPFound(location = "/", headers=response.headers)</span></span></code> </pre><br><blockquote>  As in any web application, redirection is necessary so that when the page is refreshed, the browser does not offer to re-send a POST request with the form data.  This happens if you return the HTML page in response to a POST request. </blockquote><br>  Now we already have a cookie with the girl‚Äôs name.  When processing a request for the <code>index_route</code> route, <code>index_route</code> can display a list of "desires".  Encode the wish list in the form of a list in Python and transfer it to the template along with the girl's name. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'username'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.cookies: username = request.cookies[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] response = render_to_response(<span class="hljs-string"><span class="hljs-string">"pt/index.pt"</span></span>, { <span class="hljs-string"><span class="hljs-string">"username"</span></span> : username, <span class="hljs-string"><span class="hljs-string">"wishbar"</span></span> : WISHBAR }, request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  In the template, we will generate a table with rows for each of the desires in the list. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">repeat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wish wishbar"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${wish.name}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${wish.name}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wish-${wish.name}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"checkbox"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"checkbox"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag">&gt;</span></span>${wish.title}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"description"</span></span></span><span class="hljs-tag">&gt;</span></span>${wish.description}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tal:block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We look what happened. <br><br><img src="https://habrastorage.org/storage2/1ce/2fe/8f2/1ce2fe8f23fa575eca6f3d667f667f91.png"><br><br><blockquote>  For styling flags, a <a href="http://www.maratz.com/blog/archives/2006/06/11/fancy-checkboxes-and-radio-buttons/">method</a> was used with input substitution to div and their binding through JavaScript.  It would be correct to add preloading images when loading the page in accordance with the recommendations of the author of the article, but I did not.  Since the application was deployed on the local network, the girls did not even notice a delay in downloading images. </blockquote><br>  At the bottom of the page we will add a field for entering ‚Äúspecial wishes‚Äù and a button for sending the form to the server to the root URL in the form of a POST request.  In the corresponding view-function, we add a check of the request type.  In the case of POST, we will receive the form data, create an order object and redirect the user to <code>/confirm/id-</code> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>: username = request.cookies[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] wishlist = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key,value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.POST.items(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key.startswith(<span class="hljs-string"><span class="hljs-string">"wish-"</span></span>): wishlist.append(NAME2WISH[key[<span class="hljs-number"><span class="hljs-number">5</span></span>:]]) special = request.params[<span class="hljs-string"><span class="hljs-string">"special"</span></span>] bequick = request.params[<span class="hljs-string"><span class="hljs-string">"bequick"</span></span>] order = Order(username,request.remote_addr,wishlist,special,bequick) ORDERS[order.id] = order <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPFound(location = <span class="hljs-string"><span class="hljs-string">"/confirm/{}"</span></span>.format(order.id))</code> </pre><br>  Add the appropriate route and the <code>/confirm/*</code> handler. <br><br><pre> <code class="python hljs">config.add_route(<span class="hljs-string"><span class="hljs-string">"confirm_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/confirm/{order}"</span></span>)</code> </pre><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@view_config(route_name="confirm_route") def confirm(request): order_id = request.matchdict['order'] if order_id in ORDERS.iterkeys(): order = ORDERS.pop(order_id) notify(order) return render_to_response('pt/confirm.pt', { "order" : order }, request) else: return HTTPFound(location = "/")</span></span></code> </pre><br>  On the confirmation page, we show the user the contents of the order and offer to ‚Äúwish‚Äù something else. <br><br><img src="https://habrastorage.org/storage2/1d0/2b5/9b2/1d02b59b28f27dd9a41ff7e9d0df2463.png"><br><br>  The <code>notify</code> function <code>notify</code> intended to notify the waiters about the order.  About her a little later.  For now, let's finish with the web application.  It remains a bit: it is necessary to allow the user to "log out" and "log in" under a different name.  To do this, on the wish selection page there is a link to the URL <code>/logout/</code> .  Register the corresponding view <code>logout</code> function.  It is enough to clear the cookie with the username and redirect it to the main one. <br><br><pre> <code class="python hljs">config.add_route(<span class="hljs-string"><span class="hljs-string">"logout_route"</span></span>,<span class="hljs-string"><span class="hljs-string">"/logout/"</span></span>)</code> </pre><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@view_config(route_name="logout_route") def logout(request): response = Response() response.set_cookie('username', value=None) return HTTPFound(location = "/", headers=response.headers)</span></span></code> </pre><br>  Now you can do order processing. <br><br><h4>  Order processing </h4><br>  It was assumed that there will be several "managers" who need to be notified of incoming orders.  Managers must agree on who will accept the order and organize its execution.  For the notification, it was decided to use Google Talk.  It is convenient to work with <a href="http://xmpppy.sourceforge.net/">xmpppy</a> with <a href="http://en.wikipedia.org/wiki/XMPP">XMPP</a> from Python.  <code>notify</code> the <code>notify.py</code> implementation in <code>notify.py</code> . <br><br><pre> <code class="python hljs">USERNAME = <span class="hljs-string"><span class="hljs-string">'username'</span></span> <span class="hljs-comment"><span class="hljs-comment"># @gmail.com PASSWORD = 'password' class User(): def __init__(self,uri,name): self.uri = uri self.name= name USERS = { "user@gmail.com" : User("user@gmail.com",u" ") } def notify(order): cnx = xmpp.Client('gmail.com') cnx.connect( server=('talk.google.com',5223) ) cnx.auth(USERNAME,PASSWORD,'botty') message = order.username + " (" + order.remote_addr + "): " if order.donothing: message += u"  " else: message += order.wishstr if order.bequick: message += u", -" for user in USERS.itervalues(): cnx.send(xmpp.Message(user.uri, message, typ='chat'))</span></span></code> </pre><br>  That's all.  As soon as an order arrives, <code>notify</code> sends a message with order information to all users in the <code>USERS</code> list. <br><br>  It was originally planned to notify several "managers."  Moreover, the "manager" could respond to the address of the "bar of desires" - then all the rest would receive a confirmation of their taking the order for processing.  To do this, even the corresponding gtalk bot was written, the code of which can be found further in the file <code>notify.py</code> .  The bot was launched when the application started in a separate thread, processed incoming messages and sent them to the <code>USERS</code> list. <br><br>  But during the run it turned out that from a certain moment the messages cease to reach the managers.  As a result of a series of experiments, it was found out that Google Talk has built-in protection against a large flow of events - when sending more than 10 events in approximately 100 seconds, Google Talk blocks sending events from the client for a couple of minutes.  What I have found only a <a href="http://stackoverflow.com/questions/1843837/what-is-the-throttling-rate-that-gtalk-applies-to-xmpp-messages">brief mention on StackOverflow</a> without specific numbers. <br><br>  Therefore, it was decided to abandon the idea of ‚Äã‚Äãusing the bot.  Since there was little time left, we created a room at <a href="http://partychapp.appspot.com/">partych.at</a> , added all the waiters and a wish bar account to it.  In the <code>USERS</code> list there is only a room account.  Now, when someone left the order, the message was sent to the room where everyone saw it and could immediately agree on processing. <br><br><h4>  Deployment </h4><br>  After the web application was ready, the question arose of how it could be deployed to a server on a local network running Ubuntu.  I entered the search query ‚ÄúPyramid setup.py‚Äù into the search and found a <a href="http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/project.html">document</a> that I should have read at the very beginning.  The document describes the standard way to create Pyramid projects. <br><blockquote>  I intend to bring this information to the end of the article.  Firstly, in order to start directly with the task and the code and not to confuse the reader.  Second, bring your project to standard Pyramid easily and quickly.  What I did. </blockquote><br>  The <code>pcreate</code> utility automatically generates a typical project structure and creates a <code>setup.py</code> for a new web application, in which all dependencies are already written.  You must go to the level above our project and run in the console <code>pcreate -s starter wishbar</code> . <br><blockquote>  <code>pcreate</code> offers other scaffolds for web applications.  For example, alchemy - creates a web application using <a href="http://www.sqlalchemy.org/">sqlalchemy</a> . </blockquote><br>  The key difference of the Pyramid project is the placement of the web application files in a separate <code>wishbar</code> package.  Which is correct, the modules should be in packages.  In my case, the files were in the root of the project.  The transfer was not difficult - the extra generated code was removed, the missing <code>import</code> directives were added for dependencies between modules, the <code>create_app</code> call from <code>server.py</code> to <code>__init__.py</code> . <br><br>  After the final result was posted on <a href="https://github.com/rgmih/wishbar">GitHub</a> , it was easy to deploy the project to a server on the local network: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ mkdir wishbar <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> wishbar git init git remote add origin <span class="hljs-string"><span class="hljs-string">"https://github.com/rgmih/wishbar.git"</span></span> git pull origin master sudo python ./setup.py develop pserve production.ini</code> </pre><br><blockquote>  With this deployment method, the web application runs under the <a href="http://docs.pylonsproject.org/projects/waitress/en/latest/">Waitress</a> WSGI server on port 7777. </blockquote><br><h4>  Conclusion </h4><br>  The girls were very pleased.  In some cases, even a wow effect has been achieved. <br><br>  The Wish Fulfillment Bar was successfully launched on March 7th and tested under the strictest secrecy.  On the morning of the holiday, the managers and waiters were at their combat posts and chatted in their minds at ease.  The first order arrived at about 9 am with the words "I am in shock" in the "special requests" section.  The application worked successfully until the end of the holiday.  The only thing that we did not take into account in our ‚Äúideal‚Äù scheme is that the gateway will lie in the building and all the offices will remain without the Internet.  Accordingly, notifications about orders ceased to be transmitted to the chat, and the chat itself became inaccessible to the waiters.  Fortunately, the Internet was disconnected ten minutes before the holiday banquet, and no one was hurt. <br><br>  The application is developed and tested under Python 2.7.  But I think that under Python 3 everything will work without significant changes.  Many important tasks for this web application were not solved due to the lack of necessity and time constraints - no logging, localization, error handling, etc. The following were used for development: <a href="http://www.python.org/">Python 2.7.2</a> , <a href="http://www.pylonsproject.org/projects/pyramid/about">Pyramid 1.4</a> , <a href="http://xmpppy.sourceforge.net/">xmpppy 0.5.0rc1</a> , <a href="http://lesscss.org/">LESS 1.3. 0</a> , <a href="http://jquery.com/">jQuery 1.9.1</a> .  I am not a professional Python developer.  Therefore, I would appreciate any constructive criticism and advice that will allow me to improve the article and my skills in this area. <br><br>  The source code for the project is available on <a href="https://github.com/rgmih/wishbar">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/172243/">https://habr.com/ru/post/172243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../172229/index.html">Experience in managing business processes in a new way, or how ACM replaces BPM, CRM, ECM, SCRUM, ITSM - in one fell swoop</a></li>
<li><a href="../172231/index.html">Sparse image processing</a></li>
<li><a href="../172233/index.html">RestKit - description of one of the possibilities</a></li>
<li><a href="../172235/index.html">Mozilla does not plan to return to iOS</a></li>
<li><a href="../172239/index.html">PowerMock (+ Mockito): a new look at unit testing</a></li>
<li><a href="../172245/index.html">Windows Azure Summit: how it was (+ a lot of photos)</a></li>
<li><a href="../172247/index.html">Xbox Hacking Guide: In Memory of Aaron Schwarz</a></li>
<li><a href="../172249/index.html">Discover Marmalade Quick, a new player in fast cross-platform development.</a></li>
<li><a href="../172251/index.html">Synthesis of combinational devices on the example of the converter from direct code to additional</a></li>
<li><a href="../172253/index.html">New videos from Alconost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>