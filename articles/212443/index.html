<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating from raid1 to raid10 without losing data in Debian</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are raid1 of 2 disks, there are 2 additional disks, you need to add these 2 disks to the array and migrate to raid10 without data loss. The situ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating from raid1 to raid10 without losing data in Debian</h1><div class="post__text post__text-html js-mediator-article">  There are raid1 of 2 disks, there are 2 additional disks, you need to add these 2 disks to the array and migrate to raid10 without data loss.  The situation is complicated by the fact that the boot is not located in the raid, but finds only on one of the disks, and to increase the server fault tolerance, the bootloader needs to be moved to raid1. <br><br>  All described actions were carried out on a working battle server.  The scheme is universal, suitable for any other initial conditions.  Similarly, you can migrate from raid10 to raid1. <br><br>  We have: <br>  On disk / dev / sdd1 is / boot <br>  On the array / dev / md1 is / <br>  On the array / dev / md2 is swap <br>  If you have already resolved the issue with the bootloader, you can go directly to the migration section. <br><a name="habracut"></a><br><h4>  We transfer the loader </h4><br>  On the / dev / sdd disk there is data and there is a bootloader, so we will consider it a reference, all other disks can be considered empty.  For reliability, we will not place the bootloader on raid10, but leave it on raid1 from 2 disks (it is possible on both 3x and 4x), for greater fault tolerance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We create one-to-one partitions on the sdb disk as on sdd.  Or manually, for example, using <br><pre><code class="bash hljs">fdisk /dev/sdb</code> </pre> <br>  Or simply duplicate sections. <br><pre> <code class="bash hljs">sfdisk -d /dev/sdd --force | sfdisk /dev/sdb --force</code> </pre><br>  The bootloader itself is on / dev / sdd1, so create a degraded raid1 / dev / md4 as follows <br><pre> <code class="bash hljs">mdadm --create /dev/md4 --level=1 --raid-disks=2 missing /dev/sdb1 mke2fs -j /dev/md4</code> </pre><br>  After creating any new array, you need to update the information about all raid, otherwise everything will collapse after a reboot. <br><pre> <code class="bash hljs">mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf</code> </pre><br>  Now we will restart the server, and after the reboot we will see a strange array / dev / md127 that we need to get rid of, and our / dev / md4, which may not appear, since  instead of it / dev / md127.  Solving this problem is quite simple, just stop these 2 arrays and add / dev / md4 again <br><pre> <code class="bash hljs">mdadm -S /dev/md127 mdadm -S /dev/md4 mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf mdadm --assemble /dev/md4</code> </pre><br>  For reliability, it is worth rebooting again and after that we come to the most critical part, you need to edit the GRUB2 bootloader so that it loads the server from the created array.  To do this, find out the UUID of the old disk with the bootloader / dev / sdd1 and the new array / dev / md4 <br><pre> <code class="bash hljs">root@server:~<span class="hljs-comment"><span class="hljs-comment"># ls -l /dev/disk/by-uuid total 0 lrwxrwxrwx 1 root root 9 Nov 9 20:56 4d7faa7f-25b3-4a14-b644-682ffd52943b -&gt; ../../sdd1 lrwxrwxrwx 1 root root 9 Nov 9 20:56 29683c02-5bd7-4805-8608-5815ba578b6c -&gt; ../../md4</span></span></code> </pre><br>  Edit /boot/grub/grub.cfg.  Everywhere where the old UUID is found - 4d7faa7f-25b3-4a14-b644-682ffd52943b is replaced with our new UUID - 29683c02-5bd7-4805-8608-5815ba578b6c, in fact this will be in each search section. <br>  Wherever there is a set root, you also need to make a replacement.  For example, it was <br> <code>set root='(hd0)'</code> <br>  And we will be like this <br> <code>set root='(md/4)'</code> <br> <br>  An example of the resulting new config <br><blockquote>  insmod raid <br>  insmod mdraid <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod ext2 <br>  set root = '(md / 4)' <br>  search --no-floppy --fs-uuid --set 59f76eb9-00d2-479e-b94e-6eb54fc574d4 <br>  set locale_dir = ($ root) / grub / locale <br><br>  And section ### BEGIN /etc/grub.d/10_linux ### will look like this <br><br>  menuentry 'Debian GNU / Linux, with Linux 2.6.32-5-amd64' --class debian --class gnu-linux --class gnu --class os { <br>  insmod raid <br>  insmod mdraid <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod part_msdos <br>  insmod ext2 <br>  set root = '(md / 4)' <br>  search --no-floppy --fs-uuid --set 59f76eb9-00d2-479e-b94e-6eb54fc574d4 <br>  echo 'Loading Linux 2.6.32-5-amd64 ...' <br>  linux /vmlinuz-2.6.32-5-amd64 root = / dev / md1 ro quiet <br>  echo 'Loading initial ramdisk ...' <br>  initrd /initrd.img-2.6.32-5-amd64 <br>  } <br>  menuentry 'Debian GNU / Linux, with Linux 2.6.32-5-amd64 (recovery mode)' --class debian --class gnu-linux --class gnu --class os { </blockquote><br>  It is very important that now you do not reboot, so by changing this file, the bootloader will already think that the information for the download is on / dev / md4, and there is nothing there yet.  To keep yourself a loophole, do not edit the recovery mode section, so you can boot with old data, although for this you will need access via KVM-IP or for the DC employee to select recovery mode when downloading. <br><br>  Now you need to update the ramdisk, otherwise the system simply will not boot <br><pre> <code class="bash hljs">update-initramfs -u</code> </pre><br>  After we make changes to the bootloader, we can transfer the contents of / boot to the created array / dev / md4 <br><pre> <code class="bash hljs">mkdir /mnt/md4 mount /dev/md4 /mnt/md4 rsync -avHxl --progress --inplace --exclude <span class="hljs-string"><span class="hljs-string">'lost+found'</span></span> /boot/ /mnt/md4/ umount /mnt/md4/</code> </pre><br>  We need to make sure that the GRUB2 boot loader is installed on 2x hard drives (or 4x, depending on how much you wanted to add to the array), as well as on the / dev / md4 array.  The safest way to do this is to execute <br><pre> <code class="bash hljs">dpkg-reconfigure grub-pc</code> </pre><br>  where you need to select all the disks to which you want to add the bootloader. <br><br>  In addition to the bootloader, the system itself must correctly understand that the bootloader is now in a different place; all you need to do is edit the / etc / fstab and / etc / mtab files.  We are interested in the line where / boot is mounted.  We do not need the UUID, instead we specify the name of our raid array. <br>  In the / etc / fstab file <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#UUID=7092eb46-9ee8-4a32-b9a7-5d759cc74af0 /boot ext3 defaults 0 2 /dev/md4 /boot ext3 defaults 0 2</span></span></code> </pre><br>  In the / etc / mtab file <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#/dev/sdd1 /boot ext3 rw 0 0 /dev/md4 /boot ext3 rw 0 0</span></span></code> </pre><br>  Now you can reboot, and if you did everything correctly, the system will boot from / dev / md4, and / dev / sdd1 is no longer used.  It remains only to finish our degraded array <br><pre> <code class="bash hljs">mdadm /dev/md4 --add /dev/sdd1</code> </pre><br><br><h4>  Migrating from raid1 to raid10 without data loss </h4><br>  The situation is the same, there is a raid1 array of 2 disks and 2 free disks, you need to collect it all in raid10 and the data should be intact. <br>  For new drives, you need to create a partition structure identical to those already in the raid <br><pre> <code class="bash hljs">sfdisk -d /dev/sdd --force | sfdisk /dev/sda --force sfdisk -d /dev/sdd --force | sfdisk /dev/sdb --force</code> </pre><br>  On / dev / md4 is / boot <br>  On / dev / md1 is / <br>  Swap is on / dev / md2 <br><br>  We will not touch / boot, leave it as raid1, save the data only to / dev / md1 (the array consists of / dev / sda6, / dev / sdb6, / dev / sdc6, / dev / sdd6). <br><br>  To save the data, we will collect a degraded raid10 array of 3 disks, and transfer the data from raid1 there, then we will analyze raid1 and finish raid10. <br><br>  To get started, pull 1 disk out of raid1, since  we need at least 3 disks to create raid10 <br><pre> <code class="bash hljs">mdadm /dev/md1 --fail /dev/sdc6 --remove /dev/sdc6</code> </pre><br>  We assemble degraded RAID10 as / dev / md3 and mount it.  Be sure to add a record about the new array so that after the reboot it remains <br><pre> <code class="bash hljs">mdadm --create /dev/md3 --level=10 --raid-devices=4 /dev/sda6 /dev/sdb6 /dev/sdc6 missing mke2fs -j /dev/md3 mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf</code> </pre><br>  If you accidentally rebooted before writing data about arrays, then run <br><pre> <code class="bash hljs">mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf mdadm --assemble /dev/md3</code> </pre><br>  Transferring data from / dev / md1 to / dev / md3 <br><pre> <code class="bash hljs">mkdir /mnt/md3 mount -t ext3 /dev/md3 /mnt/md3 rsync -avHxl --progress --inplace --exclude <span class="hljs-string"><span class="hljs-string">'lost+found'</span></span> / /mnt/md3/ umount /mnt/md3</code> </pre><br>  Everything, data is saved on raid10 and migration is almost complete.  Now you need to tell the system to use the new / dev / md3, instead of the old / dev / md1.  To do this, edit the files / etc / fstab and / etc / mtab. <br>  In the / etc / fstab file, you need to replace UUID / dev / md1 with UUID / dev / md3 <br><pre> <code class="bash hljs">ls -l /dev/disk/by-uuid lrwxrwxrwx 1 root root 9 Nov 9 20:56 29683c02-5bd7-4805-8608-5815ba578b6c -&gt; ../../md3</code> </pre><br>  We get the following <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#UUID=4d7faa7f-25b3-4a14-b644-682ffd52943b / ext3 errors=remount-ro 0 1 UUID=29683c02-5bd7-4805-8608-5815ba578b6c / ext3 errors=remount-ro 0 1</span></span></code> </pre><br>  In the / etc / mtab file you just need to replace the new / dev / md3 instead of / dev / md1 everywhere <br><pre> <code class="bash hljs">/dev/md3 / ext3 rw,errors=remount-ro 0 0</code> </pre><br>  When the device changes for / boot or / it is necessary to edit the boot loader configuration / boot / grub / grub.cfg and execute update-initramfs, otherwise it will not be loaded. <br><br>  In the /boot/grub/grub.cfg file, everywhere where 4d7faa7f-25b3-4a14-b644-682ffd52943b (the old UUID of / dev / md1) occurs is replaced with our new UUID - 29683c02-5bd7-4805-8608-5815ba578b6c, this is important for the search sections. <br>  And inside the section <br> <code>### BEGIN /etc/grub.d/10_linux ###</code> <br>  replace root = / dev / md1 with root = / dev / md3 <br><br>  And after that, be sure to perform <br><pre> <code class="bash hljs">update-initramfs -u</code> </pre><br>  You need to reboot so that the root / becomes the new array / dev / md3 and there are no more calls to the old raid1.  You need to finish creating raid10 by adding the disk that is currently in raid1 (/ dev / sdd6).  But first you need to stop it and clear the partition. <br><pre> <code class="bash hljs">mdadm -S /dev/md1 mdadm --zero-superblock /dev/sdd6</code> </pre><br>  And now add the disk to the raid10 array and update the data on the arrays <br><pre> <code class="bash hljs">mdadm /dev/md3 --add /dev/sdd6 mdadm --examine --scan &gt;&gt; /etc/mdadm/mdadm.conf</code> </pre><br>  That's all, migration from raid1 to raid10 without data loss is complete. <br><br>  PS In the end, I went back to raid1, because  in my case, the transition from raid1 to raid10 did not give any impressive results, raid1 from 4 disks showed itself much better. </div><p>Source: <a href="https://habr.com/ru/post/212443/">https://habr.com/ru/post/212443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212425/index.html">Pleasant testing with Espresso</a></li>
<li><a href="../212431/index.html">Artificial cognitive systems of the present and the future</a></li>
<li><a href="../212435/index.html">How we ran 1C-Bitrix in Windows Azure</a></li>
<li><a href="../212437/index.html">StubDb - database on stubs for rapid prototyping and not only</a></li>
<li><a href="../212441/index.html">Anatomy of Ember.js (part one, theoretical)</a></li>
<li><a href="../212447/index.html">Social Cloud - All-In-One Collaboration Solution</a></li>
<li><a href="../212449/index.html">Connecting a Wacom Pro pen tablet to Linux or how bash helps artists</a></li>
<li><a href="../212451/index.html">Fake Debian developers require free access to Valve games</a></li>
<li><a href="../212453/index.html">Netapp - Reality vs. Marketing</a></li>
<li><a href="../212455/index.html">MtGox problems and spambo-smith</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>