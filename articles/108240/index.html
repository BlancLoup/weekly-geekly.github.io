<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Large traffic flows and interrupt management in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I will describe methods for increasing the performance of the Linux router. For me, this topic has become relevant when the passing netwo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Large traffic flows and interrupt management in Linux</h1><div class="post__text post__text-html js-mediator-article"> In this post I will describe methods for increasing the performance of the Linux router.  For me, this topic has become relevant when the passing network traffic through a single Linux router has become quite high (&gt; 150 Mbit / s,&gt; 50 Kpps).  In addition to routing, the router is also engaged in shaping and acts as a firewall. <br><a name="habracut"></a><br>  For high loads, you should use Intel network cards based on 82575/82576 chipsets (Gigabit), 82598/82599 (10 Gigabit), or the like.  Their beauty is that they create eight interrupt queues for one interface ‚Äî four for rx and four for tx (perhaps <a href="http://lwn.net/Articles/362339/">RPS</a> / <a href="http://lwn.net/Articles/382428/">RFS</a> technologies that appeared in the 2.6.35 kernel will do the same for regular network cards).  Also, these chips speed up the processing of traffic at the hardware level. <br>  First, look at the contents of <code>/proc/interrupts</code> , in this file you can see what causes interrupts and which kernels are involved in their processing. <br><pre>  # cat / proc / interrupts 
            CPU0 CPU1 CPU2 CPU3       
   0: 53 1 9 336 IO-APIC-edge timer
   1: 0 0 0 2 IO-APIC-edge i8042
   7: 1 0 0 0 IO-APIC-edge    
   8: 0 0 0 75 IO-APIC-edge rtc0
   9: 0 0 0 0 IO-APIC-fasteoi acpi
  12: 0 0 0 4 IO-APIC-edge i8042
  14: 0 0 0 127 IO-APIC-edge pata_amd
  15: 0 0 0 0 IO-APIC-edge pata_amd
  18: 150 1497 12301 473020 IO-APIC-fasteoi ioc0
  21: 0 0 0 0 IO-APIC-fasteoi sata_nv
  22: 0 0 15 2613 IO-APIC-fasteoi sata_nv, ohci_hcd: usb2
  23: 0 0 0 2 IO-APIC-fasteoi sata_nv, ehci_hcd: usb1
  45: 0 0 0 1 PCI-MSI-edge eth0
  46: 138902469 21349 251748 4223124 PCI-MSI-edge eth0-rx-0
  47: 137306753 19896 260291 4741413 PCI-MSI-edge eth0-rx-1
  48: 2916 137767992 248035 4559088 PCI-MSI-edge eth0-rx-2
  49: 2860 138565213 244363 4627970 PCI-MSI-edge eth0-rx-3
  50: 2584 14822 118410604 3576451 PCI-MSI-edge eth0-tx-0
  51: 2175 15115 118588846 3440065 PCI-MSI-edge eth0-tx-1
  52: 2197 14343 166912 121908883 PCI-MSI-edge eth0-tx-2
  53: 1976 13245 157108 120248855 PCI-MSI-edge eth0-tx-3
  54: 0 0 0 1 PCI-MSI-edge eth1
  55: 3127 19377 122741196 3641483 PCI-MSI-edge eth1-rx-0
  56: 2581 18447 123601063 3865515 PCI-MSI-edge eth1-rx-1
  57: 2470 17277 183535 126715932 PCI-MSI-edge eth1-rx-2
  58: 2543 16913 173988 126962081 PCI-MSI-edge eth1-rx-3
  59: 128433517 11953 148762 4230122 PCI-MSI-edge eth1-tx-0
  60: 127590592 12028 142929 4160472 PCI-MSI-edge eth1-tx-1
  61: 1713 129757168 136431 4134936 PCI-MSI-edge eth1-tx-2
  62: 1854 126685399 122532 3785799 PCI-MSI-edge eth1-tx-3
 NMI: 0 0 0 0 Non-maskable interrupts
 LOC: 418232812 425024243 572346635 662126626 Local timer interrupts
 SPU: 0 0 0 0 Spurious interrupts
 PMI: 0 0 0 0 Performance monitoring interrupts
 PND: 0 0 0 0 Performance pending work
 RES: 94005109 96169918 19305366 4460077 Rescheduling interrupts
 CAL: 49 34 39 29 Function call interrupts
 TLB: 66588 144427 131671 91212 TLB shootdowns
 TRM: 0 0 0 0 Thermal event interrupts
 THR: 0 0 0 0 Threshold APIC interrupts
 MCE: 0 0 0 0 Machine check exceptions
 MCP: 199 199 199 199 Machine check polls
 ERR: 1
 MIS: 0 </pre><br>  In this example, Intel 82576 network cards are used. Here you can see that network interrupts are distributed evenly across the cores.  However, by default it will not.  It is necessary to scatter interruptions on processors.  To do this, you need to execute the <code>echo N &gt; /proc/irq/X/smp_affinity</code> , where <em>N</em> is the processor mask (determines which processor will get the interrupt), and <em>X</em> is the interrupt number, visible in the first column of the <em>/ proc / interrupts</em> output.  To determine the processor mask, you need to raise 2 to the power <em>cpu_N</em> (processor number) and transfer it to the hexadecimal system.  With <code>bc</code> calculated like this: <code>echo "obase=16; $[2 ** $cpu_N]" | bc</code>  <code>echo "obase=16; $[2 ** $cpu_N]" | bc</code> .  In this example, the distribution of interrupts was made as follows: <br><pre>  # CPU0
 echo 1&gt; / proc / irq / 45 / smp_affinity
 echo 1&gt; / proc / irq / 54 / smp_affinity

 echo 1&gt; / proc / irq / 46 / smp_affinity
 echo 1&gt; / proc / irq / 59 / smp_affinity
 echo 1&gt; / proc / irq / 47 / smp_affinity
 echo 1&gt; / proc / irq / 60 / smp_affinity

 # CPU1
 echo 2&gt; / proc / irq / 48 / smp_affinity
 echo 2&gt; / proc / irq / 61 / smp_affinity
 echo 2&gt; / proc / irq / 49 / smp_affinity
 echo 2&gt; / proc / irq / 62 / smp_affinity

 # CPU2
 echo 4&gt; / proc / irq / 50 / smp_affinity
 echo 4&gt; / proc / irq / 55 / smp_affinity
 echo 4&gt; / proc / irq / 51 / smp_affinity
 echo 4&gt; / proc / irq / 56 / smp_affinity

 # CPU3
 echo 8&gt; / proc / irq / 52 / smp_affinity
 echo 8&gt; / proc / irq / 57 / smp_affinity
 echo 8&gt; / proc / irq / 53 / smp_affinity
 echo 8&gt; / proc / irq / 58 / smp_affinity </pre><br>  Also, if the router has two interfaces, one to the input, the other to the output (the classical scheme), then rx from one interface should be grouped with the tx of the other interface on the same processor core.  For example, in this case, interrupts <em>46 (eth0-rx-0)</em> and <em>59 (eth1-tx-0)</em> were defined per core. <br>  Another very important parameter is the delay between interrupts.  You can view the current value with <code>ethtool -c ethN</code> , the <em>rx-usecs</em> and <em>tx-usecs parameters</em> .  The larger the value, the higher the latency, but the lower the CPU load.  Try to reduce this value during peak hours down to zero. <br>  When preparing the server with Intel Xeon E5520 (8 cores, each with HyperThreading), I chose the following interrupt allocation scheme: <br><pre>  # CPU6
 echo 40&gt; / proc / irq / 71 / smp_affinity
 echo 40&gt; / proc / irq / 84 / smp_affinity

 # CPU7
 echo 80&gt; / proc / irq / 72 / smp_affinity
 echo 80&gt; / proc / irq / 85 / smp_affinity

 # CPU8
 echo 100&gt; / proc / irq / 73 / smp_affinity
 echo 100&gt; / proc / irq / 86 / smp_affinity

 # CPU9
 echo 200&gt; / proc / irq / 74 / smp_affinity
 echo 200&gt; / proc / irq / 87 / smp_affinity

 # CPU10
 echo 400&gt; / proc / irq / 75 / smp_affinity
 echo 400&gt; / proc / irq / 80 / smp_affinity

 # CPU11
 echo 800&gt; / proc / irq / 76 / smp_affinity
 echo 800&gt; / proc / irq / 81 / smp_affinity

 # CPU12
 echo 1000&gt; / proc / irq / 77 / smp_affinity
 echo 1000&gt; / proc / irq / 82 / smp_affinity

 # CPU13
 echo 2000&gt; / proc / irq / 78 / smp_affinity
 echo 2000&gt; / proc / irq / 83 / smp_affinity

 # CPU14
 echo 4000&gt; / proc / irq / 70 / smp_affinity
 # CPU15
 echo 8000&gt; / proc / irq / 79 / smp_affinity </pre><br>  <em>/ proc / interrupts</em> on this server without load can be found <a href="http://blog.peter.am/index.php/2010/11/09/big-traffic-linux">here</a> .  I do not give it in the article because of the bulkiness <br><br>  <b>UPD:</b> <br>  If the server works only as a router, then the TCP stack tuning does not really matter.  However, there are sysctl options that allow you to increase the size of the ARP cache, which may be relevant.  If there is a problem with the size of the ARP cache in dmesg, the message ‚ÄúNeighbor table overflow‚Äù will appear. <br>  For example: <br> <code>net.ipv4.neigh.default.gc_thresh1 = 1024 <br> net.ipv4.neigh.default.gc_thresh2 = 2048 <br> net.ipv4.neigh.default.gc_thresh3 = 4096</code> <br> <br>  Description of parameters: <br>  <b>gc_thresh1</b> - the minimum number of entries that should be in the ARP cache.  If the number of entries is less than this value, the garbage collector will not clear the ARP cache. <br>  <b>gc_thresh2</b> - soft limit on the number of entries in the ARP cache.  If the number of records reaches this value, the garbage collector will start within 5 seconds. <br>  <b>gc_thresh3</b> - a hard limit on the number of entries in the ARP cache.  If the number of records reaches this value, the garbage collector will immediately start. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/108240/">https://habr.com/ru/post/108240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108236/index.html">Java Core Task</a></li>
<li><a href="../108237/index.html">InCube ANE business incubator and the contest ‚ÄúI am an entrepreneur‚Äù</a></li>
<li><a href="../108238/index.html">CodeRush custom test templates. Testing the order of method calls</a></li>
<li><a href="../108239/index.html">HTC Desire Z: phone, keyboard, root access</a></li>
<li><a href="../10824/index.html">Another way to watch TV: SlingBox</a></li>
<li><a href="../108241/index.html">You must be kidding, Mr. Dahl, or why Node.js is the crown of web server evolution</a></li>
<li><a href="../108242/index.html">Server redirect to the mobile version of the site</a></li>
<li><a href="../108243/index.html">Read more about closed auctions in the zone. RF</a></li>
<li><a href="../108245/index.html">Lecture about processor architecture</a></li>
<li><a href="../108246/index.html">0W-httpd - simple fast frontend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>