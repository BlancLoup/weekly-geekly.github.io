<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Online flower shop, or how we screwed up on Valentine's Day</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Holidays all passed, the profits and losses are calculated. It's time for the story. This story is about how, due to a technical error, an online flow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Online flower shop, or how we screwed up on Valentine's Day</h1><div class="post__text post__text-html js-mediator-article">  Holidays all passed, the profits and losses are calculated.  It's time for the story.  This story is about how, due to a technical error, an online flower delivery store lost several hundred orders and revenues of <b>1 million rubles</b> for St. Valentine's Day. <a name="habracut"></a><br><br>  In life there are good moments that I want to share, tell, to praise and be glad for you.  And there are situations that are of a negative connotation and from which no one is insured.  They just need to learn and do not allow recurrence in the future.  As promised, in this section I publish not only positive, but also instructive stories.  In the end, the error was not my fault, but somehow I was part of the team that day (and still remain in it), and share responsibility with everyone.  It remains only to tell what happened and what was the root cause. <br><br>  You all know perfectly well that flowers are in demand at any time of the year, as they are given for holidays, birthdays, when they want someone to like or make something pleasant, to love someone, and sometimes even for no reason.  But it is also known that the flower business has some seasonality. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you look at the history of requests through <b>wordstat.yandex</b> on one of the most popular requests <i>‚Äúflower delivery‚Äù</i> , then for any previous year you can see characteristic rises: from the end of January to the middle of March, in August and in the end of November. <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-1-768x241.jpg" alt="image"><br><br>  Here are the dates due to these trends: <br><br><ul><li>  January 25 - Tatiana's Day; </li><li>  February 14 - Valentine's Day; </li><li>  February 23 - Defender of the Fatherland Day; </li><li>  March 8 - International Women's Day; </li><li>  mid-August - preparing children for school, gifts to teachers; </li><li>  November 25 - Mother's Day. </li></ul><br>  And the first three months of each new year are the most intense for the owner of this business.  It is very important to approach these holidays fully armed.  We tried, from year to year everything was fine, but on February 14, 2018 we were disappointed. <br><br>  <i>A little about the project: an</i> online flower shop with delivery in Moscow and Moscow region, the main sources of promotion are contextual advertising (20%, I am responsible for this area) and SEO promotion (75%) and e-mail marketing (5%).  Social networks are practically not involved.  Site on 1C-Bitrix, the usual hosting timeweb.  The latter is very important, then I will explain why.  And the development team that oversees our project was at a distance.  And this to some extent played its role. <br><br>  There is a myth that ‚Äúflorists‚Äù for these holidays earn almost a semi-annual rate of revenue, which allows them to relax their buns in other months.  This is not true.  Yes, there are more orders, more revenue than times.  But not always arrived more.  Because the cost of buying a flower, florist services, packaging, rental of premises, the cost of couriers, advertising costs, returns - all this during a period of high demand increases greatly. <br><br>  So, everything was fine until February 14, 12:30 Moscow time.  By this time, we have already accepted more than 120 orders for a total amount of 500,000 rubles.  And they were going to get another 200+ orders from last year‚Äôs experience.  I even recorded a record of simultaneous visits to 100+ users: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-2-768x358.jpg" alt="image"><br><br>  At 12:43 there was a first failure.  Of course, we immediately turned for help to our developers on the remote.  The correspondence with the owner in WhatsApp was something like this: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-4-768x406.jpg" alt="image"><br><br>  The error was 502 Bad Gateway, and at some point I managed to fix even this: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-5-768x115.jpg" alt="image"><br><br>  And this is the most peak time for sales and orders.  The developers could not figure out the problem on their own and wrote to the hosting support.  After some time, we received the following answer: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-6.jpg" alt="image"><br><br>  Next, here is a chain of site failures: <br><br><ul><li>  12: 43-12: 47 = 4 minutes </li><li>  13: 01-13: 18 = 17 minutes </li><li>  13: 27-13: 42 = 15 minutes </li><li>  13: 57-14: 17 = 20 minutes </li><li>  14: 26-14: 54 = 28 minutes </li><li>  14: 58-15: 15 = 17 minutes </li><li>  15: 30-15: 46 = 16 minutes </li><li>  16: 08-16: 27 = 19 minutes </li><li>  16: 35-16: 37 = 2 minutes </li><li>  16: 48-16: 51 = 3 minutes </li></ul><br>  And such a dialogue with the owner: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-3-768x411.jpg" alt="image"><br><br>  At that moment I was not at the point (thank God!), And therefore I could only guess about all the emotions and experiences from the messages.  It was also scary that there were no copies of the site (or rather, it fell along with the main site), and florists needed to collect all the flowers (bouquets) from memory.  There were orders, they fell to the post office, but now the color solutions, the quantity, the form, the pictures and some non-standard bouquets - all this now had to be asked again from the client or remembered independently. <br><br>  The developers have not been able to determine the cause of the fall of the site.  At some point, they even began to believe in conspiracy theories and DDoS attacks of competitors.  Hosting could not resist?  They also thought about it, but until February 14 there was also February 13, a day no less intense in its loads.  But there everything went without problems. <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-7-768x424.png" alt="image"><br><br>  Our online store remained lying until February 15 (for the remaining time we received only 30 orders), until I turned to the person who recently performed our freelancing task as an independent expert. <br><br>  The first thing that the programmer immediately advised was to change hosting at least to a VPS (virtual server), and take this site to a separate VPS, since the virtual server is more powerful and more stable. <br><br>  Analysis of the log files showed that there was no attack.  True, once someone just turned off the site on the hosting (13: 01-13: 18), i.e.  it most likely was not a DDoS attack or error on the PHP side, and it was more like someone on the hosting turned off this site for a given period of time.  This was the case - the hosting staff disconnected us in manual mode due to the extremely high load on the server.  And what caused such a sharp jump - had to find out further. <br><br><blockquote>  For each virtual account, the hoster allocates certain capacities, and with a dramatic move beyond these allocated capacities, the hoster simply temporarily sends this account to the ignore list, and then writes a message to the account owner: ‚ÄúYou have exceeded the threshold for the allocated capacity ". </blockquote><br><br>  To the question: <br><br>  <i>‚ÄúWhy didn't they tell us (current developers) that it‚Äôs better to switch to a different, more powerful and safer server?‚Äù</i> <br><br>  I received a very specific and sensible answer: <br><br>  <i>- ‚ÄúMany progers will not offer to transfer there.</i>  <i>After all, to do this, we need some knowledge in administering Linux, and this is closer to system administration. ‚Äù</i> <br><br>  All at once it became clear - incompetence.  From them we received the following messages: <br><blockquote>  It looks like it is still DDoS, but some kind of cunning.  Now there are almost no people on the site, and he makes 40,000 requests to the database per minute.  Requests are large, and they overflow the cache, in the end, nothing is loaded.  Yesterday, the load was more in the number of people, but the site coped, there were no such problems.  Deployed a copy of the site, simulated entry of a large number of users.  He starts to hang.  Must move to VDS.  Then the site will work in a planned manner to understand. </blockquote>  Now even I know that DDoS is not about database queries.  If there are no requests to the web server, but there is a database, then this is not DDoS, but some internal problems ... In general, 0 level.  The level of developers immediately became clear in a stressful and non-standard situation.  For 1.5 days, a team of 3-4 people could not understand the reason for the fall of the store and restore its performance. <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-8-768x96.jpg" alt="image"><br><br>  At some point, SEO-shniki came into the business with their own tips.  They: <br><br><ul><li>  We reduced the load on the site from the bots of Yandex through robots.  So far, we have put tough restrictions; </li><li>  Reduced the load from Google bots to the site via Google Webmasters; </li><li>  We reduced the load on the site from various unnecessary bots to us, closing them through the .htaccess file. </li></ul><br>  The developer, who helped us in this whole story, mocked these changes and said that there was absolutely nothing to do with it.  It was necessary to do something, until someone cleared the tracks or made it worse. <br><br>  We completely trusted an independent programmer and waited for news from him.  And the site still hung, did not even let me enter the admin panel.  As a result, the developer took a copy of the site directly from the hosting and hosted it locally. <br><br>  A small digression: the online store has been operating since 2015, during which time it was serviced by several SEO promotion agencies.  In these agencies, a sufficient number of developers changed and each of them had their own access.  As it turned out later, almost every ‚Äúdog‚Äù had administrative access to the site.  And SEO-Schnick as well. <br><br>  First of all, all access was closed.  Yes, of course, 1C-Bitrix is ‚Äã‚Äãso nice - you can not have access, but only a bunch of scripts that can be restored and added to the administrator at startup.  And if someone from the people who had access to the site (and there were about a dozen) such a script was planted somewhere, then without any problems will be able to launch it and get access as admin and spoil ... <br><br>  After some time, we got from him the first results: <br><br><img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-9-768x62.jpg" alt="image"><br><br>  The guilty was not named, but the responsible one who did it: <br><br><pre><code class="hljs tex"><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Bitrix</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CmskassaEkam</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CheckListTable</span></span></span></span>::loadUpdates()</code></pre><br>
     ‚Äî   .   (  ),      .    ()     ,   .   ,    -     ,   -       .<br>
<br>
EKAM ‚Äì  -    .   -        CMS ¬´1-¬ª  ¬´54-   - ¬ª   - .<br>
<br>
    ( ),            ,      EKAM  .<br>
<br>
 ,      ¬´. (cmskassa.ekam) cmskassa.ru¬ª  -         <i>¬´\Bitrix\CmskassaEkam\CheckListTable::loadUpdates()¬ª</i>  .     ()  .  ,      ,   - .<br>
<br>
<img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-10.jpg" alt="image"><br>
<br>
             EKAM .   ,    -      EKAM (   ),   -   ,       .<br>
<br>
   ,       1-2      10-15 . 15                EKAM.   ,       .      ,    EKAM        :<br>
<br>
<img src="https://osipenkov.ru/wp-content/uploads/2018/03/zveti-case-11-768x348.jpg" alt="image"><br>
<br>
    ‚Ä¶     EKAM    ,            .<br>
<br>
     /    ,      .    ,      ,      ,        .<br>
<br>
     ,        8 .         ,           ,   14 .<br>
<br>
            ,  :<br>
<br>
<ul>
<li><b>  ;</b></li>
</ul><br>
  ,   ‚Äì     ,          ,   :<br>
<br>
<ul>
<li><b>    ;</b></li>
</ul><br>
   ,      ;<br>
 LOG-  ,   ,      ;<br>
   ( ,     ,      ), ,  ,        .<br>
<br>
<ul>
<li><b>     ;</b></li>
</ul><br>
 ,         .   ,          ,  .   ,     .  . ,      ,      ,        ‚Äì  / .     ‚Äì   .    ‚Äì  .<br>
<br>
    .        ,   100%,         .<br>
<br>
<ul>
<li><b>    ;</b></li>
</ul><br>
   ,  ‚Äì   ,  ‚Äì   , seo- ‚Äì    ..       . ,    ‚Ä¶<br>
<br>
<ul>
<li><b>  ,     ;</b></li>
</ul><br>
   .    ,     .            .     ,     ,   .      DDoS-        . ,       .<br>
<br>
<ul>
<li><b>    ,    .      ?</b></li>
</ul><br>
,   EKAM      ,             .     .   ,    .   .      .        ,        200   1  .<br>
<br>
    ,       .</div><p>Source: <a href="https://habr.com/ru/post/351396/">https://habr.com/ru/post/351396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351384/index.html">Harmful Keyward Interface</a></li>
<li><a href="../351386/index.html">Decryption of saved passwords in MS SQL Server</a></li>
<li><a href="../351388/index.html">FastTrack Training. "Network Basics". "The Basics of Telephony." Part 3. Eddie Martin. December 2012</a></li>
<li><a href="../351390/index.html">Simple Kanban Board for Jira</a></li>
<li><a href="../351394/index.html">Mathematical model of a nuclear reactor fuel element</a></li>
<li><a href="../351398/index.html">Rewrite the application under Blockchain</a></li>
<li><a href="../351400/index.html">About probabilities</a></li>
<li><a href="../351402/index.html">Installing the Linux + server (Nginx + Apache) + PostgreSQL + PHP on VirtualBox (Ubuntu Server 16.04.3 LTS)</a></li>
<li><a href="../351404/index.html">Richard Hamming: Chapter 6. Artificial Intelligence - 1</a></li>
<li><a href="../351406/index.html">Arrays, pointers and other quantum phenomena around us</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>