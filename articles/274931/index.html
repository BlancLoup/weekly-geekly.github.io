<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django Single Sign-On and Microsoft Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Start 
 Once I had to start developing a web application for corporate use in Python + Django. And the very first question that had to be addressed wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django Single Sign-On and Microsoft Active Directory</h1><div class="post__text post__text-html js-mediator-article"><h3>  <b>Start</b> </h3><br>  Once I had to start developing a web application for corporate use in Python + Django.  And the very first question that had to be addressed was transparent authorization on the site or <b>Single Sign-On (SSO)</b> . <br><br>  The enterprise widely uses the Microsoft Active Directory-based directory service, and by now almost all corporate applications allow using windows-authentication and not constantly entering logins / passwords, so the new application simply had to satisfy the existing state of things and realize the above-mentioned opportunity for ‚Äú transparent user authorization. <br><br>  Although a lot of articles were written on the issue of implementing SSO for Django, however, in order to realize what I needed, I had to spend a lot of time.  Therefore, in order to save some of you from possible long searches for information and its assembly into a working scheme, I offer you my manual how to make transparent authorization in the Django application using Active Directory accounts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>So we have:</b> <a name="habracut"></a><br><br><ul><li>  Microsoft Active Directory, </li><li>  Windows domain name: <b>company.ru</b> </li><li>  Windows 2012 Server Domain Controller Name: <b>DC-1</b> </li><li>  Windows Server 2012 Domain Controller IP Address: <b>192.168.7.110</b> </li><li>  Server for our application: <b>CentOS7, Apache, Python 3.5.1, Django 1.9.1</b> </li><li>  Hostname Linux Server with CentOS7: <b>srv-app</b> </li><li>  IP Address Linux Server with CentOS7: <b>192.168.7.105</b> </li><li>  Application URL on Django: <b>srv-app.company.ru</b> </li></ul><br>  <b>Need to do:</b> <br><br><ul><li>  A user registered in Active Directory when opening any page of the site on srv-app.company.ru must automatically, without requesting a login / password, be authorized by Django.  When authorizing, some information about it from Active Directory (first_name, last_name, mail; the flags is_active, is_staff, is_supersuser must be set based on the user's membership in the corresponding Active Directory groups) must be transferred to the user profile in Django. </li><li>  A user who is not registered in Active Directory should not be allowed to enter the site. </li></ul><br>  <b>After examining a number of published articles and descriptions, it became clear that you can achieve the desired result by performing two basic steps:</b> <br><ul><li>  Setting up transparent authentication when accessing an Apache server using Kerberos. </li><li>  Authorization in Django using LDAP access to the domain controller to obtain the necessary information about the authorizing user. </li></ul><br><h3>  <b>Step 1: Set up transparent authentication using Kerberos</b> </h3><br>  It is clear that the implementation of the principle of SSO in the Windows AD network is possible using the Kerberos protocol.  Therefore, the main task of the first configuration step will be to install Kerberos in a Linux + Apache environment and configure communication with a Windows AD domain controller. <br><br><h4>  <b>Installing and configuring Kerberos on a Linux server</b> </h4><br><h5>  <b>Configure / etc / hosts, /etc/resolv.conf on <b>srv-app</b> , DNS on <b>DC-1</b></b> </h5><br>  On the <b>srv-app</b> add to / etc / hosts: <br><br><pre><code class="bash hljs">192.168.7.105 srv-app.company.ru</code> </pre> <br>  On <b>srv-app we</b> change /etc/resolv.conf (In reality, this file in CentOS7 generates NetworkManager, so changes need to be made to / etc / sysconfig / network-scripts / ifcfg-eth0): <br><br><pre> <code class="bash hljs"> search company.ru nameserver 192.168.7.110</code> </pre><br>  On <b>DC-1</b> Domain Controller: <br><br><ul><li>  using the DNS Manager snap-in, add the <b>srv-app</b> host with the address <b>192.168.7.105</b> </li><li>  using the ‚ÄúAD - users and computers‚Äù snap-in, add the user <b>svc-apache</b> , set the password <b>P @ ssw0rd</b> for it.  We will need this user later to create a keytab file that will connect our Linux machine and Active Directory. </li></ul><br><h4>  <b>Install modules to work with Kerberos</b> </h4><br><pre> <code class="bash hljs"> [root@srv-app ~]<span class="hljs-comment"><span class="hljs-comment"># yum install mod_auth_kerb #    apache [root@srv-app ~]# yum install krb5-workstation #       kerberos</span></span></code> </pre><br><h5>  <b>Configuring Kerberos by editing the /etc/krb5.conf file</b> </h5><br><pre> <code class="bash hljs"> [logging] default = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5libs.log kdc = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5kdc.log admin_server = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/kadmind.log [libdefaults] dns_lookup_realm = <span class="hljs-literal"><span class="hljs-literal">false</span></span> ticket_lifetime = 24h renew_lifetime = 7d forwardable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> rdns = <span class="hljs-literal"><span class="hljs-literal">false</span></span> default_realm = COMPANY.RU default_ccache_name = KEYRING:persistent:%{uid} [realms] COMPANY.RU = { kdc = 192.168.7.110 admin_server = 192.168.7.110 } [domain_realm] .company.ru = COMPANY.RU company.ru = COMPANY.RU</code> </pre><br>  Some explanations about the contents of the configuration file: <br><br><ul><li>  <b>COMPANY.RU</b> - set the kerberos (realm) domain name in linux.  It should be remembered that the kerberos realm is case-sensitive (case-sensetive) </li></ul><br><h5>  <b>We perform several checks on the work of kerberos on the srv-app computer</b> </h5><br>  Earlier, on our domain controller, we created a user <b>srv-apache</b> with the password <b>P @ ssw0rd</b> .  Let's try to log in to the CD using the kinit utility: <br><br><pre> <code class="bash hljs"> [root@dsrv-app ~]<span class="hljs-comment"><span class="hljs-comment"># kinit svc-apache@COMPANY.RU Password for admin@COMPANY.RU: ****</span></span></code> </pre><br>  If there are no errors, let's see which tickets (tickets) we have: <br><br><pre> <code class="bash hljs"> [root@srv-app ~]<span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: FILE:/tmp/krb5cc_0 Default principal: srv-apache@COMPANY.RU Ticket cache: KEYRING:persistent:0:0 Default principal: svc-apache@COMPANY.RU Valid starting Expires Service principal 20.12.2015 16:12:59 21.12.2015 02:12:59 krbtgt/COMPANY.RU@COMPANY.RU renew until 27.12.2015 16:12:55</span></span></code> </pre><br>  So we logged on to the CD using kerberos, now break the connection, removing <br>  ticket received: <br><br><pre> <code class="bash hljs"> [root@srv-app ~]<span class="hljs-comment"><span class="hljs-comment"># kdestroy</span></span></code> </pre><br>  If everything works, then for further configuration we need to create the krb5.keytab file for the authentication service using <br>  Apache and mod_auth_kerb. <br><br><h5>  <b>Keytab generation on Windows Domain Controller</b> </h5><br>  You can generate a keytab on a <b>DC-1</b> domain controller using the ktpass.exe command: <br><br><pre> <code class="bash hljs"> ktpass.exe /princ HTTP/srv-app.company.ru@COMPANY.RU /mapuser svc-apache@COMPANY.RU /crypto ALL /ptype KRB5_NT_PRINCIPAL /mapop <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /pass P@ssw0rd /out c:\share\keytab</code> </pre><br><ul><li>  The <b>/ princ HTTP/srv-app.company.ru@COMPANY.RU key</b> sets the unique client name (principal) on a Linux machine that will be allowed to perform kerberos authentication. </li><li>  The <b>/ mapuser svc-apache@COMPANY.RU</b> and <b>/ pass P @ ssw0rd keys</b> connect the principal to a specific user in Active Directory </li><li>  The <b>/ crypto ALL</b> key sets the encryption method.  Instead of <b>/ crypto ALL,</b> you can specify a specific encryption method such as <b>/ crypto AES256-SHA1</b> </li><li>  The <b>/ mapop set switch</b> sets the mapping between the Linux principal and the Active Directory user account ( <b>/ mapop add</b> will add this mapping to the keytab) </li><li>  The <b>/ ptype switch KRB5_NT_PRINCIPAL</b> - set the type of principal in the request (the specified type is the main one and it is recommended to use it) </li><li>  The <b>/ out c: \ share \ keytab</b> key sets the path for the output keytab file. </li><li>  If desired, additional key values ‚Äã‚Äãcan be viewed using <b>ktpass.exe / help</b> </li></ul><br>  As a result, we get the file c: \ share \ keytab, which must be copied to the <b>srv-app</b> and called /etc/krb5.keytab.  Next, you must provide access to this file to the user, under the account of which the httpd server is running.  In our case, this is <b>apache</b> .  In order for <b>apache</b> to read this file, we just allow it to be read by all users: <br><br><pre> <code class="bash hljs"> chmod a+r /etc/krb5.keytab</code> </pre><br>  Check whether our keytab works as follows: <br><br>  1. With <b>ktutil</b> : <br><br><pre> <code class="bash hljs"> [root@srv-app ~]<span class="hljs-comment"><span class="hljs-comment"># ktutil ktutil: rkt /etc/krb5.keytab ktutil: list slot KVNO Principal ---- ---- --------------------------------------------------------------------- 1 3 HTTP/srv-app.company.ru@COMPANY.RU 2 3 HTTP/srv-app.company.ru@COMPANY.RU 3 3 HTTP/srv-app.company.ru@COMPANY.RU 4 3 HTTP/srv-app.company.ru@COMPANY.RU 5 3 HTTP/srv-app.company.ru@cCOMPANY.RU ktutil: q</span></span></code> </pre><br><br>  2. With <b>kvno</b> : <br><br><pre> <code class="cs hljs"> <span class="hljs-meta"><span class="hljs-meta">#   KDC [root@srv-app ~]# kinit svc-apache Password for svc-apache@COMPANY.RU: #     &lt;b&gt;HTTP/srv-app.company.ru@COMPANY.RU&lt;/b&gt;         keytab [root@srv-app ~]# kvno HTTP/srv-app.company.ru@COMPANY.RU HTTP/srv-app.company.ru@COMPANY.RU: kvno = 3 #   [root@srv-app ~]# kdestroy</span></span></code> </pre><br><h5>  <b>Apache setup</b> </h5><br>  Below is the /etc/httpd/conf.d/company_main.conf file, which contains configuration instructions for configuring Kerberos authentication when accessing the URI "/": <br><br><pre> <code class="apache hljs"> <span class="hljs-section"><span class="hljs-section">&lt;Location "/"&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment"># Kerberos authentication: AuthType Kerberos AuthName "SRV-APP auth" KrbMethodNegotiate on KrbMethodK5Passwd off KrbServiceName HTTP/srv-app.company.ru@COMPANY.RU KrbAuthRealms COMPANY.RU Krb5Keytab /etc/krb5.keytab KrbLocalUserMapping On Require valid-user &lt;/Location&gt;</span></span></code> </pre><br>  I want to pay attention to the <b>KrbMethodK5Passwd off</b> setting.  The specified setting causes kerberos authentication using <b>Single Sign-On</b> technology to be performed when entering the specified section of the site.  In case of unsuccessful authentication, there will be an error ‚Äú401 Unautorized‚Äù immediately.  However, if you change the setting to <b>KrbMethodK5Passwd on</b> , then after unsuccessful authorization <b>Single Sign-On</b> , an attempt will be made to authorize by name and password. <br><br>  And one more undocumented feature that we will use: Configuring <b>KrbLocalUserMapping On</b> causes the REMOTE_USER variable to contain the name of the registered user (in the case of <b>KrbLocalUserMapping Off,</b> REMOTE_USER will contain username @ COMPANY RU). <br><br>  More information on mod_auth_kerb module settings can be found <a href="http://modauthkerb.sourceforge.net/configure.html">here</a> . <br><br><h5>  <b>Single Sign-On (SSO) from Windows Workstations</b> </h5><br>  I repeat once again that all the work on setting up kerberos authentication in Linux was done in order to be able to access portal portal pages published on a Linux machine using corporate accounts stored in Active Directory, besides, to simplify the lives of users, this input should be ‚Äútransparent‚Äù , Without asking for a password, which is achieved using Single Sign-On (SSO) technology, which is supported in Windows 7 and higher and Internet Explorer (and Mozilla Firefox). <br><br>  However, in order for everything to go smoothly, the following settings must be made at the workstation from which this input is made: <br><br><ol><li>  The site to which the entrance is made (in our case, <b>srv-app.company.ru</b> should be entered into the ‚ÄúLocal intranet‚Äù nodes using the menu <br>  Internet Explorer: <b>Tools -&gt; Internet Options -&gt; Security -&gt; Local Intranet -&gt; Nodes -&gt; Advanced</b> </li><li>  The following options should be enabled in IE (as a rule, they are enabled by default): <br><ul><li>  <b>Tools -&gt; Internet Options -&gt; Advanced -&gt; Security -&gt; Allow Windows Integrated Validation = ON</b> </li><li>  <b>Tools -&gt; Internet Options -&gt; Security -&gt; Local Intranet -&gt; Security Level for this Zone -&gt; Other -&gt; User Authentication -&gt; Automatic access to the network only in the intranet zone</b> </li></ul><br></li><li>  In addition, SSO will not work if you try to access the site by IP address.  Be sure to use the domain name srv-app.company.ru! </li></ol><br><h3>  <b>Stage 2. Authorization of the user in Django</b> </h3><br>  So, as a result of the work carried out in the first stage, we obtained the following results: <br><br><ul><li>  When entering into any section of our Django application, by a user who has been authorized by a domain controller, we first get access to our Django application, and secondly, the Apache server places the name of an authorized user that matches the attribute <b>sAMAccountName of</b> this variable into the REMOTE_USER variable user in Active Directory. </li><li>  If the user is not authorized in AD, then Apache will return us the error "401 Unautorized" (With the help of the ErrorDocument option, we can redirect the unauthorized user to any guest page in this case) </li></ul><br>  However, despite the fact that Apache has authorized our user, for the Django application, it is still unknown and, accordingly, the entire user authentication / authorization and session usage mechanism debugged in Django remains untapped. <br><br><h4>  <b>Using RemoteUserBackend</b> </h4><br>  Especially for such purposes in Django there is a <a href="https://docs.djangoproject.com/en/dev/howto/auth-remote-user/">simple solution</a> that includes the authorization mechanism in the system of users already authenticated by external applications, such as IIS or Apache (using methods similar to those used in step 1: mod_authnz_ldap, CAS, Cosign, WebAuth, mod_auth_sspi, mod_auth_krb). <br><br>  According to the description on the official website djangoproject.org, to use transparent authentication and authorization in Django in such a way, it is enough to enable the <b>RemoteUserBackend</b> mechanism by performing the following steps: <br><br>  1. In the Django project settings file settings.py, add <b>django.contrib.auth.middleware.RemoteUserMiddleware</b> to the <b>MIDDLEWARE_CLASSES</b> list immediately after <b>django.contrib.auth.middleware.AuthenticationMiddleware</b> : <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">MIDDLEWARE_CLASSES = [ '...', 'django.contrib.auth.middleware.AuthenticationMiddleware', 'django.contrib.auth.middleware.RemoteUserMiddleware', '...', ]</span></span></code> </pre><br>  2. In the same place, replace <b>ModelBackend</b> with <b>RemoteUserBackend</b> in the <b>AUTHENTICATION_BACKENDS</b> list (or add this list to settings.py): <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">AUTHENTICATION_BACKENDS = [ 'django.contrib.auth.backends.RemoteUserBackend', ]</span></span></code> </pre><br>  As a result of these changes, <b>RemoteUserMiddleware</b> will retrieve the username via <b>request.META ['REMOTE_USER']</b> and automatically perform authentication and authorization (login) of this user using <b>RemoteUserBackend</b> .  In addition <b>,</b> with such an authorization, <b>RemoteUserBackend</b> will add a new user to the auth_user table, thus utilizing the standard Django account management mechanism. <br><br>  But, unfortunately, this method will not allow us to receive information we need from our Active Directory and use the information we need in our application (first_name, last_name, mail, participation in AD groups, etc.). <br><br><h4>  <b>Using django-auth-ldap</b> </h4><br>  So, we need to access Active Directory using the LDAP protocol.  Fortunately, a great Django application for this is <a href="http://pythonhosted.org/django-auth-ldap/">django-auth-ldap</a> .  You can install it as standard with pip: <br><br><pre> <code class="bash hljs">pip install django-auth-ldap</code> </pre><br>  After this, you will have to remove from settings.py the <b>MIDDLEWARE_CLASSES</b> added in the previous section, namely, <b>'django.contrib.auth.middleware.RemoteUserMiddleware'</b> , and the <b>AUTHENTICATION_BACKENDS</b> list should look like this: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">AUTHENTICATION_BACKENDS = ( 'django_auth_ldap.backend.LDAPBackend', 'django.contrib.auth.backends.ModelBackend', )</span></span></code> </pre><br>  In addition, in settings.py you need to enable the following configuration parameters: <br><br><div class="spoiler">  <b class="spoiler_title">settings.py</b> <div class="spoiler_text"><pre> <code class="django hljs"><span class="xml"><span class="xml"># Baseline LDAP configuration. AUTH_LDAP_SERVER_URI = "ldap://DC-1.COMPANY.ru" AUTH_LDAP_AUTHORIZE_ALL_USERS = True AUTH_LDAP_PERMIT_EMPTY_PASSWORD = True #          LDAP ( ) AUTH_LDAP_BIND_DN = "cn=svc-apache,cn=Users,dc=company,dc=ru" AUTH_LDAP_BIND_PASSWORD = "P@ssw0rd" #         OU Django    Users, #   login    sAMAccountName AUTH_LDAP_USER_SEARCH = LDAPSearchUnion( LDAPSearch("ou=Django,dc=company,dc=ru", ldap.SCOPE_SUBTREE, "(sAMAccountName=%(user)s)"), LDAPSearch("cn=Users,dc=company,dc=ru", ldap.SCOPE_SUBTREE, "(sAMAccountName=%(user)s)"), ) # Set up the basic group parameters. AUTH_LDAP_GROUP_SEARCH = LDAPSearch("ou=Groups,ou=Django,dc=company,dc=ru", ldap.SCOPE_SUBTREE, "(objectClass=group)" ) AUTH_LDAP_GROUP_TYPE = GroupOfNamesType(name_attr="cn") # Simple group restrictions # AUTH_LDAP_REQUIRE_GROUP -   DN   ,        #         #   ,             "active" AUTH_LDAP_REQUIRE_GROUP = "cn=active,ou=Groups,ou=Django,dc=company,dc=ru" # AUTH_LDAP_DENY_GROUP -   DN   ,         #      AUTH_LDAP_DENY_GROUP = "cn=disabled,ou=Groups,ou=Django,dc=company,dc=ru" # Populate the Django user from the LDAP directory. #      AD     Django AUTH_LDAP_USER_ATTR_MAP = { "first_name": "givenName", "last_name": "sn", "email": "mail" } #      AD     Django AUTH_LDAP_PROFILE_ATTR_MAP = { "employee_number": "employeeNumber" } #     is_active, is_staff  is_superuser     AD #  is_active   django_remote_auth_ldap          #      Django    AUTH_LDAP_REQUIRE_GROUP (.) AUTH_LDAP_USER_FLAGS_BY_GROUP = { "is_active": "cn=active,ou=Groups,ou=Django,dc=company,dc=ru", "is_staff": "cn=staff,ou=Groups,ou=Django,dc=company,dc=ru", "is_superuser": "cn=superuser,ou=Groups,ou=Django,dc=company,dc=ru" } #          AD AUTH_LDAP_PROFILE_FLAGS_BY_GROUP = { "is_awesome": "cn=awesome,ou=Groups,ou=Django,dc=company,dc=ru", } # This is the default, but I like to be explicit. AUTH_LDAP_ALWAYS_UPDATE_USER = True # Use LDAP group membership to calculate group permissions. AUTH_LDAP_FIND_GROUP_PERMS = True # Cache group memberships for an hour to minimize LDAP traffic AUTH_LDAP_CACHE_GROUPS = True AUTH_LDAP_GROUP_CACHE_TIMEOUT = 3600</span></span></code> </pre><br></div></div><br>  Django-auth-ldap is a great application.  With its help, you can download almost any information on it from AD to a Django user profile, even having the opportunity to ‚Äúpull up‚Äù groups in which this user participates in the appropriate Django model. <br><br>  However, for authorization using django-auth-ldap, you still need to ask the user for his username and password, which is absolutely not suitable for us. <br><br>  Although the documentation states that, it seems, you can "cross" <b>django-auth-ldap</b> and <b>RemoteUserBackend</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Non-LDAP Users</b> <div class="spoiler_text">  LDAPBackend has one more feature  For example, you might be using RemoteUserBackend to map externally authenticated users.  By setting AUTH_LDAP_AUTHORIZE_ALL_USERS, you can use the authorization information.  Note that this doesn‚Äôt work with AUTH_LDAP_MIRROR_GROUPS;  group mirroring is a feature of authentication, not authorization. <br></div></div><br>  But it does not work, as we need.  The user will actually be able to log in, but this happens exactly as if we were just using <b>RemoteUserBackend</b> (see previous section).  Information from AD to the Django user profile is not automatically loaded. <br><br>  Of course, you can do this yourself by using the following recommendation: <br><br><div class="spoiler">  <b class="spoiler_title">Updating Users</b> <div class="spoiler_text">  By default, all fields will be updated each time the user logs in.  To disable this, set AUTH_LDAP_ALWAYS_UPDATE_USER to False.  If you need to be able to create associated data, you can call django_auth_ldap.backend.LDAPBackend.populate_user ().  You'll need an instance of LDAPBackend, yourself.  it couldn‚Äôt be found in LDAP. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django_auth_ldap.backend <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LDAPBackend user = LDAPBackend().populate_user(<span class="hljs-string"><span class="hljs-string">'alice'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'No user named alice'</span></span>)</code> </pre><br></div></div><br><h4>  <b>Using django-remote-auth-ldap</b> </h4><br>  But as it turned out, everything is much simpler.  The bike has already been invented, and we can only use it.  The <b><a href="">django-remote-auth-ldap</a></b> application is a small add-on over <b>django_auth_ldap</b> and allows you to authorize a user without any extra effort and load his data from AD during authorization. <br><br>  Install <b>django-remote-auth-ldap as</b> standard ( <b>django-auth-ldap is</b> also required for this add-in to work): <br><br><pre> <code class="bash hljs">pip install django-remote-auth-ldap</code> </pre><br>  Next, you need to add the following setting in settings.py: <br><br><pre> <code class="bash hljs">DRAL_CHECK_DOMAIN = False</code> </pre><br>  The fact is that <b>django-remote-auth-ldap</b> , apparently designed to work with IIS, which sets the variable REMOTE_USER in the format "DOMAIN / username", we have configured mod_auth_kerb so that the domain name does not fall into REMOTE_USER.  The above setting causes <b>django-remote-auth-ldap to</b> assume that in REMOTE_USER only one user name without specifying a domain, i.e.  exactly as we need. <br>  Well, and again recommendations for setting <b>MIDDLEWARE_CLASSES</b> and <b>AUTHENTICATION_BACKENDS</b> : <br><br>  1. In the Django project settings file settings.py, add <b>django.contrib.auth.middleware.RemoteUserMiddleware</b> to the <b>MIDDLEWARE_CLASSES</b> list immediately after <b>django.contrib.auth.middleware.AuthenticationMiddleware</b> : <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">MIDDLEWARE_CLASSES = [ '...', 'django.contrib.auth.middleware.AuthenticationMiddleware', 'django.contrib.auth.middleware.RemoteUserMiddleware', '...', ]</span></span></code> </pre><br>  2. <b>AUTHENTICATION_BACKENDS</b> should look like this: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">AUTHENTICATION_BACKENDS = [ 'django_remote_auth_ldap.backend.RemoteUserLDAPBackend', ]</span></span></code> </pre><br>  That's all, transparent authentication in Django is configured. <br><br>  If the user is a member of your Django application, is already authorized in Active Directory, then: <br><br>  1. <b>Apache will</b> authorize it with Kerberos, allow it to the pages of your application and write the name of the authorized user to REMOTE_USER. <br>  2. <b>RemoteUserMiddleware</b> ‚Äúsees‚Äù the value of REMOTE_USER and initiates the authentication and authorization of the specified user in Django using <b>django-remote-auth-ldap</b> <br>  3. <b>django-remote-auth-ldap</b> authenticates and authorizes the user using methods inherited from the <b>django-auth-ldap</b> application, which will ‚Äúpull‚Äù in Django the information you need from Active Directory. </div><p>Source: <a href="https://habr.com/ru/post/274931/">https://habr.com/ru/post/274931/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274919/index.html">Asterisk: ngrep, sipgrep, sngrep, protocol diagram</a></li>
<li><a href="../274921/index.html">Beeline Data School, holidays are over</a></li>
<li><a href="../274923/index.html">Farm IIS and Application Request Routing</a></li>
<li><a href="../274925/index.html">ActiveRecord's inheritance describing one table (single table inheritance pattern) in Yii2</a></li>
<li><a href="../274927/index.html">Happiness chart with python, pandas and matplotlib</a></li>
<li><a href="../274933/index.html">What does it cost us to build an ICC? We collect xRM on the pipeline</a></li>
<li><a href="../274935/index.html">Analysis of the decision taken by the second (so far) place in the Hola contest for programming mail filters on JavaScript</a></li>
<li><a href="../274937/index.html">Thematic cartography: one-dimensional maps</a></li>
<li><a href="../274939/index.html">Intel Skylake processor error causes computer to freeze during complex calculations</a></li>
<li><a href="../274941/index.html">A little more about errors in the design of process control systems and PLC programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>