<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mysql performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The writing of this article is inspired by this trilogy: one , two , three . I wanted to add my $ 0.02, on the use of tricks and features. 

 So that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mysql performance</h1><div class="post__text post__text-html js-mediator-article">  The writing of this article is inspired by this trilogy: <a href="http://habrahabr.ru/blogs/mysql/38907/">one</a> , <a href="http://habrahabr.ru/blogs/mysql/39260/">two</a> , <a href="http://habrahabr.ru/blogs/mysql/39818/">three</a> .  I wanted to add my $ 0.02, on the use of tricks and features. <br><a name="habracut"></a><br>  So that I do not get lost in thoughts, in my first post, let's take examples of requests from a single open-source product.  The ‚Äútricks‚Äù used also work on PostgreSQL, Oracle, SQLite, DB2 and are not MySQL focused, although the optimization is primarily aimed at MySQL InnoDB: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> h.hostid,hg.groupid,h.name <br> <font color="#0000ff">FROM</font> hosts h,hosts_groups hg <br> <font color="#0000ff">WHERE</font> (hg.groupid <font color="#0000ff">IN</font> ( <font color="#A31515">'4'</font> )) <br> <font color="#0000ff">AND</font> hg.hostid=h.hostid <br> <font color="#0000ff">AND</font> hg.groupid <font color="#0000ff">BETWEEN</font> 000000000000000 <font color="#0000ff">AND</font> 099999999999999 <br> <font color="#0000ff">AND</font> h.status <font color="#0000ff">IN</font> (0,1) <br> <font color="#0000ff">AND</font> <font color="#0000ff">EXISTS</font> ( <br> <font color="#0000ff">SELECT</font> hh.hostid <br> <font color="#0000ff">FROM</font> hosts hh, hosts_groups hgg, rights r, users_groups ug <br> <font color="#0000ff">WHERE</font> hh.hostid=h.hostid <br> <font color="#0000ff">AND</font> hh.hostid=hgg.hostid <br> <font color="#0000ff">AND</font> r.id=hgg.groupid <br> <font color="#0000ff">AND</font> r.groupid=ug.usrgrpid <br> <font color="#0000ff">AND</font> ug.userid=3 <br> <font color="#0000ff">AND</font> r.permission&gt;=3 <br> <font color="#0000ff">AND</font> <font color="#0000ff">NOT</font> <font color="#0000ff">EXISTS</font> ( <br> <font color="#0000ff">SELECT</font> hggg.groupid <br> <font color="#0000ff">FROM</font> hosts_groups hggg, rights rr, users_groups gg <br> <font color="#0000ff">WHERE</font> hggg.hostid=hgg.hostid <br> <font color="#0000ff">AND</font> rr.id=hggg.groupid <br> <font color="#0000ff">AND</font> rr.groupid=gg.usrgrpid <br> <font color="#0000ff">AND</font> gg.userid=3 <br> <font color="#0000ff">AND</font> rr.permission&lt;3 <br> )) <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> h.name <font color="#0000ff">ASC</font> <br> <font color="#0000ff">LIMIT</font> 1001</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Situation: there is an authorized user, the user belongs to a user group.  There are hosts belonging to a group of hosts. <br>  The bottom line: pull the hosts to which the user has access.  Access is given to user groups on host groups. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing I want to draw attention to is the <a href="http://dev.mysql.com/doc/refman/5.0/en/exists-and-not-exists-subqueries.html">EXISTS</a> condition.  Very rarely see the use of this structure.  EXISTS is a subquery that checks for rows in a subquery.  This query design allows you to manipulate the indices used in the query (both in the main query and in the subquery), regardless of the general query; moreover, if successful, the subquery stops at the first row found that satisfies the query.  Key manipulation is often necessary when sorting is used in a query.  Because MySQL cannot use different keys for searching and sorting. <br><br>  If the query occurs on the same table, then sometimes you can use these tricks: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> events ( <br> eventid         bigint unsigned <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> source <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> <font color="#0000ff">object</font> <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> objectid        bigint unsigned <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> clock <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> <font color="#0000ff">value</font> <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> acknowledged <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> ns <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> value_changed <font color="#0000ff">integer</font> <font color="#0000ff">DEFAULT</font> <font color="#A31515">'0'</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (eventid) <br> ) ENGINE=InnoDB; <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">INDEX</font> events_1 <font color="#0000ff">ON</font> events ( <font color="#0000ff">object</font> ,objectid,eventid); <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">INDEX</font> events_2 <font color="#0000ff">ON</font> events (clock,eventid);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">EXPLAIN <br> <font color="#0000ff">SELECT</font> eventid,clock, <font color="#0000ff">value</font> <br> <font color="#0000ff">FROM</font> events <br> <font color="#0000ff">WHERE</font> objectid=17131 <br> <font color="#0000ff">AND</font> <font color="#0000ff">object</font> =0 <br> <font color="#0000ff">AND</font> clock&gt;=1325635327 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> clock <font color="#0000ff">DESC</font> , eventid <font color="#0000ff">DESC</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br> <code>+----+-------------+--------+------+-------------------+----------+---------+-------------+------+-----------------------------+ <br> | id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | <br> +----+-------------+--------+------+-------------------+----------+---------+-------------+------+-----------------------------+ <br> | 1 | SIMPLE | events | ref | events_1,events_2 | events_1 | 12 | const,const | 113056 | Using where; Using filesort | <br> +----+-------------+--------+------+-------------------+----------+---------+-------------+------+-----------------------------+</code> <br> <br>  For example, MySQL decided that using the "events_1" index is more advantageous in WHERE, this is understandable, because WHERE uses two key fields, but it did not take into account that the result contains 100k rows and they need to be sorted. <br>  In this case, by changing the criteria of the first field of the selected MySQL index in the request: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">EXPLAIN <br> <font color="#0000ff">SELECT</font> eventid,clock, <font color="#0000ff">value</font> <br> <font color="#0000ff">FROM</font> events <br> <font color="#0000ff">WHERE</font> objectid=17131 <br> <font color="#0000ff">AND</font> <font color="#0000ff">object</font> +0=0 <br> <font color="#0000ff">AND</font> clock&gt;=1325635327 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> clock <font color="#0000ff">DESC</font> , eventid <font color="#0000ff">DESC</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br> <code>+----+-------------+--------+-------+---------------+----------+---------+------+------+-------------+ <br> | id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | <br> +----+-------------+--------+-------+---------------+----------+---------+------+------+-------------+ <br> | 1 | SIMPLE | events | range | events_2 | events_2 | 4 | NULL | 113056 | Using where | <br> +----+-------------+--------+-------+---------------+----------+---------+------+------+-------------+</code> <br> <br>  MySQL cannot use indexes on modified field values; in this case, by applying arithmetic assignment, we force the index to use events_2, which is suitable for both data selection and sorting, as can be seen from EXPLAIN. <br><br>  I pay attention that MySQL is not able to sort by an index if the used fields are sorted in a different order: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">EXPLAIN <br> <font color="#0000ff">SELECT</font> eventid,clock, <font color="#0000ff">value</font> <br> <font color="#0000ff">FROM</font> events <br> <font color="#0000ff">WHERE</font> objectid=17131 <br> <font color="#0000ff">AND</font> <font color="#0000ff">object</font> +0=0 <br> <font color="#0000ff">AND</font> clock&gt;=1325635327 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> clock <font color="#0000ff">ASC</font> , eventid <font color="#0000ff">DESC</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br> <code>+----+-------------+--------+-------+---------------+----------+---------+------+------+-----------------------------+ <br> | id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | <br> +----+-------------+--------+-------+---------------+----------+---------+------+------+-----------------------------+ <br> | 1 | SIMPLE | events | range | events_2 | events_2 | 4 | NULL | 113056 | Using where; Using filesort | <br> +----+-------------+--------+-------+---------------+----------+---------+------+------+-----------------------------+</code> <br> <br>  Also, the index is not used if the sorting takes place in fields that are in a different order than in the index.  In general, MySQL stores indices as a <a href="http://en.wikipedia.org/wiki/B-tree">B-tree</a> , so using the fields in the middle or the end of the index will fail. <br><br>  If it is impossible to use a single index for sampling and sorting, then it happened that MySQL did not properly evaluate and select the indexes to sort.  This happens during the passage of a certain number of records in the table, when it becomes more profitable to use the MySQL index for sampling, and not for sorting or vice versa.  Such moments are difficult to predict, and are detected by checking the same requests for different numbers of records. <br><br>  Let's return to the first request.  In my opinion, it is better to sort by the means of the executable script, of course, if the sample is within thousands of lines. <br>  Firstly, in this case MySQL does not have to do a full selection from the table, but stops when LIMIT is reached; <br>  Secondly, it is rarely when you really need to simultaneously display more information, unless it is just reports; <br>  Thirdly, pages with a lot of information will be slow, even if it is just a drop-down list with 1000+ options, it is no longer usable; <br>  Fourth, there is no natural sorting in MySQL; <br><br>  But in real examples it is rarely possible, because  it is necessary to give users the ability to sort, and even without specifying sorting, MySQL does not guarantee the same selection.  Alternatively, the index can be put in the first field, then by which sorting occurs more often, thus MySQL will use one index for searching and for sorting. <br><br>  COUNT, many make the second request for paginated output, but the same Google, although it says that it has found millions of matches +, really gives you about the first thousand and that's it.  And on the last page will report that actually found less.  So, choosing 1001 lines, we simply tell the user that 1000+ matches were found and there is no need to choose more at this stage.  When the user requests more, then we will choose step by step on the 1st page.  Checking for 1 line more than necessary. <br><br>  Indices.  As you query the tables, the indexes of these tables are cached in memory and remain there until the memory runs out and then they are ‚Äúasked‚Äù to exit.  So, if you have gigabytes of information, then the indices will take up ¬± 40% of the space, depending on the number of those indices.  For example, you have a modest server with 16GB of RAM allocated for MySQL.  When querying a table with an index weighing 10GB +, all the memory allocated for MySQL will be released and filled with this index and all previous cached indexes will be thrown into oblivion.  Thus, by making one heavy request you can kill the entire performance of the server.  What to do?  There are many options, but I would not say that they are simple and converge to storing large&gt; 10 million + tables on separate custodians, for example, <a href="http://en.wikipedia.org/wiki/BigTable">BigTable</a> , <a href="http://en.wikipedia.org/wiki/NoSQL">NoSQL</a> or even <a href="http://yoshinorimatsunobu.blogspot.com/2010/10/using-mysql-as-nosql-story-for.html">NoSQL for MySQL</a> , etc. <br><br>  On this, for now.  I will be glad to hear your decisions and advice on the above. </div><p>Source: <a href="https://habr.com/ru/post/135775/">https://habr.com/ru/post/135775/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135770/index.html">New release of NetBeans IDE 7.1 released</a></li>
<li><a href="../135771/index.html">On Monday, Gorilla Glass 2 will be presented.</a></li>
<li><a href="../135772/index.html">Canobuvosti, 125th edition</a></li>
<li><a href="../135773/index.html">Broadcom Launches IEEE 802.11ac Chips</a></li>
<li><a href="../135774/index.html">What can your e-mail say about your computer skills?</a></li>
<li><a href="../135776/index.html">How Google Tests Software</a></li>
<li><a href="../135777/index.html">Generating a unique user ID using Nginx</a></li>
<li><a href="../135778/index.html">Heat Sensing Pillow</a></li>
<li><a href="../135780/index.html">Do you use HP webOS based devices?</a></li>
<li><a href="../135782/index.html">New Year's zip quest 2012 - the passage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>