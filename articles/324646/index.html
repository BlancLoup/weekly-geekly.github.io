<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rust, Eclipse and STM32</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order to make friends with each other, the technologies specified in the title will be needed: 



- Fresh GNU ARM Embedded Toolchain 
- System Wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rust, Eclipse and STM32</h1><div class="post__text post__text-html js-mediator-article">  In order to make friends with each other, the technologies specified in the title will be needed: <br><br><ul><li>  Fresh <a href="https://launchpad.net/gcc-arm-embedded">GNU ARM Embedded Toolchain</a> </li><li>  <a href="http://www.st.com/en/development-tools/sw4stm32.html">System Workbench for STM32</a> (optional) </li><li>  <a href="https://eclipse.org/cdt/">Fresh Eclipse CDT</a> </li><li>  <a href="http://gnuarmeclipse.github.io/">GNU ARM Eclipse Plugin</a> </li><li>  <a href="https://www.rust-lang.org/en-US/install.html">Rusty</a> </li><li>  <a href="https://marketplace.eclipse.org/content/rustdt">RustDT</a> .  For comfortable development it is also recommended to install <a href="">Racer, Rainicorn and rustfmt</a> . </li></ul><br>  The idea is to compile a program written in Rust into a library that can be linked using the toolchain for ARM. <br>  As a result, we can even quite comfortably debug the mixed code on Rust and C. <br><a name="habracut"></a><br><h3>  1. Project generation in C </h3><br>  We will use the STM32CubeMX utility for this.  For the demo project we need: <br><br><ul><li>  SYS = Serial Wire (if the device is connected via SWD) or JTAG </li><li>  USART2 in Asynchronous configuration </li><li>  Several pins on one port in GPIO_Output mode (let's call them LED_R, LED_G, LED_B) </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/729/eda/bf6/729edabf636fcdd62689fce1310d137a.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Check the clocking settings.  Here, if desired, we can specify the clocking from the outer quartz and its frequency. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b50/bd3/85a/b50bd385ada4f3ae8e08aa82f6959b94.png" alt="image"><br><br>  Generate the project.  Let's call it ‚ÄúHwApi‚Äù, because  This layer of code we will have an abstraction over iron, which we will use when writing code on Rust.  For IDE, select SW4STM32. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/725/f21/98a/725f2198af0a5978015b085e9e99275f.png" alt="image"><br><br>  If the Workbench is installed, then we can open the generated project and check that it compiles successfully. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6c/bc2/149/a6cbc21490ea5ebd14b6f1b0491cba02.png" alt="image"><br><br><h3>  2. Create a project for the latest version of Eclipse </h3><br>  Although System Workbench is based on Eclipse, we will have to create a new project in the new major version of Eclipse (Neon), since  RustDT is incompatible with that version of Eclipse. <br><br>  We also need a project template that is installed with the GNU ARM Eclipse Plugin. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/226/eb8/e26/226eb8e26d1095f2a78d87f4113cd2da.png" alt="image"><br><br>  In order to successfully link the lib generated by the rust compiler, we need a pre-installed fresh version of the GNU ARM Embedded Toolchain. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a7/1d7/c4d/2a71d7c4d4c2fffacd67fb2b76566649.png" alt="image"><br><br>  Begin the process of moving a project from System Workbench to Eclipse CDT.  On the Internet, you can find scripts that automate this process, but I will do it manually, because  I am going to reuse HwApiLib in other projects, changing only the part of the code written in Rust. <br>  Copy the following folders / files into the new project: <br><br><ul><li>  Drivers </li><li>  Inc </li><li>  Src </li><li>  startup </li><li>  STM32F103C8Tx_FLASH.ld </li></ul><br>  If the Workbench is installed, then expand the two project settings windows (from the old and new Eclipse) so that it is convenient to copy the values ‚Äã‚Äãfrom one window to another.  The windows are slightly different, so when copying we focus on the flags, which are indicated in brackets. <br><br>  If the Workbench is not installed, you can simply copy the settings from the screenshots attached below. <br><br>  Copy Defined Symbols: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ad/c39/092/4adc39092e438882a39057bc2dc9715d.png" alt="image"><br><br>  Folder paths containing * .h files: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/46c/d76/b50/46cd76b501a805271a1bab32ae0f407e.png" alt="image"><br><br>  On the ‚ÄúOptimization‚Äù tab, you can enable Optimize size (-Os). <br>  Further we specify that we need all warnings of the compiler: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/b2d/e21/56ab2de21706a31015d738fa7564e4d5.png" alt="image"><br><br>  Specify the path to the linker script + check the checkbox to remove unused sections from the linking result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af0/189/0ab/af01890aba95439cbf0ed3d1d71c2d5f.png" alt="image"><br><br>  On the next tab, it is important to check the ‚ÄúUse newlib-nano‚Äù checkbox and manually specify the <code>-specs=nosys.specs</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd9/0c9/94b/cd90c994bdf81cfeb5335741c92ddb1d.png" alt="image"><br><br>  Specify the paths to the folders with files to compile: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e31/303/b47/e31303b478754208a9d52a873d60ace2.png" alt="image"><br><br>  Click OK.  Then we change the startup file extension to the capital .S so that the file is successfully picked up by the compiler.  Check that the project is compiled. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f8f/43d/649/f8f43d64951bce512f1c9ce3e072282b.png" alt="image"><br><br>  Now you need to configure the debugger (Run - Debug Configurations - GDB OpenOCD Debugging).  Create a file for OpenOCD with a description of the hardware in which the program will run (in my case, the file is called STM32F103C8x_SWD.cfg): <br><br><pre> <code class="hljs pgsql">source [find interface/stlink-v2.cfg] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> WORKAREASIZE <span class="hljs-number"><span class="hljs-number">0x5000</span></span> transport <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> "hla_swd" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> CHIPNAME STM32F103C8Tx source [find target/stm32f1x.cfg] # use hardware <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> under <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> reset_config <span class="hljs-keyword"><span class="hljs-keyword">none</span></span></code> </pre> <br>  If you use another microcontroller or another way to connect to it, then the correct file for OpenOCD can be generated in Workbench (using Debugging options - Ac6). <br><br>  In the Config options, specify the -f flag and the path to the file created in the previous step. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/834/db0/25a/834db025a064bdd65ebb7c08f7ac8abb.png" alt="image"><br><br>  Click Debug.  We check that the debugger successfully filled the code into the microcontroller and started debugging. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39e/87b/cc9/39e87bcc9abd157a0d54bdb567cb79c6.png" alt="image"><br><br>  It's time to create a Rust project.  Since  we will need compiler instructions that are not supported in the stable version, we will need to switch us to the nightly version of the compiler by running the following commands in cmd: <br><br><pre> <code class="hljs pgsql">rustup <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> rustup <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> nightly</code> </pre> <br>  Next, you need to get the current version of the compiler: <br><br><pre> <code class="hljs pgsql">rustc -v <span class="hljs-comment"><span class="hljs-comment">--version</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/92f/951/a80/92f951a806fda5964a85b6ab9a0f8150.png" alt="image"><br><br>  Then clone the sources of rust and switch to the commit that was used to build this compiler (specified in commit-hash). <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">git</span></span> clone git<span class="hljs-variable"><span class="hljs-variable">@github</span></span>.com:rust-lang/rust.git cd rust git checkout cab4bff3de1a61472f3c2e7752ef54b87344d1c9</code> </pre> <br>  The next step is to compile the libraries we need under ARM. <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> libs-arm rustc -C opt-level=<span class="hljs-number"><span class="hljs-number">2</span></span> -Z <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-landing-pads --target thumbv7m-none-eabi -g src/libcore/lib.rs --out-dir libs-arm --emit obj,<span class="hljs-keyword"><span class="hljs-keyword">link</span></span> rustc -C opt-level=<span class="hljs-number"><span class="hljs-number">2</span></span> -Z <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-landing-pads --target thumbv7m-none-eabi -g src/liballoc/lib.rs --out-dir libs-arm -L libs-arm --emit obj,<span class="hljs-keyword"><span class="hljs-keyword">link</span></span> rustc -C opt-level=<span class="hljs-number"><span class="hljs-number">2</span></span> -Z <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-landing-pads --target thumbv7m-none-eabi -g src/libstd_unicode/lib.rs --out-dir libs-arm -L libs-arm --emit obj,<span class="hljs-keyword"><span class="hljs-keyword">link</span></span> rustc -C opt-level=<span class="hljs-number"><span class="hljs-number">2</span></span> -Z <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-landing-pads --target thumbv7m-none-eabi -g src/libcollections/lib.rs --out-dir libs-arm -L libs-arm --emit obj,<span class="hljs-keyword"><span class="hljs-keyword">link</span></span></code> </pre> <br>  In the future, with each update of the compiler (rustup update), you will need to switch to the current version of the source code and recompile the libraries for ARM, otherwise you will lose the opportunity to debug the code on rust. <br><br>  Finally you can start creating a Rust project in eclipse. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bdc/1a3/3e4/bdc1a33e4ed1c6277a53710a18ca784b.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/1c8/dca/aac/1c8dcaaac46251623fc661d8b1a4d505.png" alt="image"><br><br>  Eclipse asks to specify the path to the compiler, source code and utilities for working with rust-code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc9/f8a/b25/fc9f8ab2589ee4e0fbd67eabc97860df.png" alt="image"><br><br>  Usually these components can be found in C: \ Users \% username% \. Cargo.  Rust src - the path to the src folder in the source code that we downloaded earlier. <br><br>  Now the main code: <br><br>  lib.rs <br><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#![feature(macro_reexport)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![feature(unboxed_closures)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![feature(lang_items, asm)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![no_std]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![feature(alloc, collections)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![allow(dead_code)]</span></span> <span class="hljs-meta"><span class="hljs-meta">#![allow(non_snake_case)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> alloc; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> runtime_support; <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> api; <span class="hljs-meta"><span class="hljs-meta">#[macro_reexport(vec, format)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> collections; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> api::*; <span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">demo_main_loop</span></span></span></span>() -&gt; ! { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> usart2 = Stm32Usart::new(Stm32UsartDevice::Usart2); <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> u2_byte = usart2.try_read_byte(); <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> u2_byte { <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(v) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> c = v <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> c { <span class="hljs-string"><span class="hljs-string">'r'</span></span> =&gt; { toggle_led(Stm32Led::Red); } <span class="hljs-string"><span class="hljs-string">'g'</span></span> =&gt; { toggle_led(Stm32Led::Green); } <span class="hljs-string"><span class="hljs-string">'b'</span></span> =&gt; { toggle_led(Stm32Led::Blue); } _ =&gt; { usart2.print(<span class="hljs-string"><span class="hljs-string">"cmd not found"</span></span>); } } } _ =&gt; {} } delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre><br>  api.rs - interlayer for integration between Rust and C code <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> collections::<span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm32_delay</span></span></span></span>(millis: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">usart2_send_string</span></span></span></span>(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>: *<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>, len: <span class="hljs-built_in"><span class="hljs-built_in">u16</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">usart2_send_byte</span></span></span></span>(byte: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">usart2_try_get_byte</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">i16</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm32_toggle_led</span></span></span></span>(led: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm32_enable_led</span></span></span></span>(led: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stm32_disable_led</span></span></span></span>(led: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span></span>(millis: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { stm32_delay(millis); } } <span class="hljs-meta"><span class="hljs-meta">#[derive(Copy, Clone)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stm32UsartDevice</span></span></span></span> { Usart2 } <span class="hljs-meta"><span class="hljs-meta">#[derive(Copy, Clone)]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stm32Usart</span></span></span></span> { device: Stm32UsartDevice } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Stm32Usart { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(device: Stm32UsartDevice) -&gt; Stm32Usart { Stm32Usart { device: device } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bytes = <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>.bytes().collect::&lt;<span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.print_bytes(bytes.as_slice()); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_bytes</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, bytes: &amp;[<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.device { Stm32UsartDevice::Usart2 =&gt; usart2_send_string(bytes.as_ptr(), bytes.len() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u16</span></span>) } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">println</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.print(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.print(<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_byte</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, byte: <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.device { Stm32UsartDevice::Usart2 =&gt; usart2_send_byte(byte) } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try_read_byte</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r = usart2_try_get_byte(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> r == -<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">None</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(r <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stm32Led</span></span></span></span> { Red, Green, Blue, Orange } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Stm32Led { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_api</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> { Stm32Led::Green =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, Stm32Led::Blue =&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>, Stm32Led::Red =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, Stm32Led::Orange =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggle_led</span></span></span></span>(led: Stm32Led) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { stm32_toggle_led(led.to_api()); } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable_led</span></span></span></span>(led: Stm32Led) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { stm32_enable_led(led.to_api()); } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable_led</span></span></span></span>(led: Stm32Led) { <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { stm32_disable_led(led.to_api()); } }</code> </pre><br>  runtime_support.rs - to support low-level Rust features <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> core; <span class="hljs-comment"><span class="hljs-comment">/// Call the debugger and halts execution. #[no_mangle] pub extern "C" fn abort() -&gt; ! { loop {} } #[cfg(not(test))] #[inline(always)] /// NOP instruction pub fn nop() { unsafe { asm!("nop" :::: "volatile"); } } #[cfg(test)] /// NOP instruction (mock) pub fn nop() {} #[cfg(not(test))] #[inline(always)] /// WFI instruction pub fn wfi() { unsafe { asm!("wfi" :::: "volatile"); } } #[cfg(test)] /// WFI instruction (mock) pub fn wfi() {} #[lang = "panic_fmt"] fn panic_fmt(_: core::fmt::Arguments, _: &amp;(&amp;'static str, usize)) -&gt; ! { loop {} } #[lang = "eh_personality"] extern "C" fn eh_personality() {} // Memory allocator support, via C's stdlib #[repr(u8)] #[allow(non_camel_case_types)] pub enum c_void { __variant1, __variant2, } extern "C" { pub fn malloc(size: u32) -&gt; *mut c_void; pub fn realloc(p: *mut c_void, size: u32) -&gt; *mut c_void; pub fn free(p: *mut c_void); } #[no_mangle] #[allow(unused_variables)] pub unsafe extern "C" fn __rust_allocate(size: usize, align: usize) -&gt; *mut u8 { malloc(size as u32) as *mut u8 } #[no_mangle] #[allow(unused_variables)] pub unsafe extern "C" fn __rust_deallocate(ptr: *mut u8, old_size: usize, align: usize) { free(ptr as *mut c_void); } #[no_mangle] #[allow(unused_variables)] pub unsafe extern "C" fn __rust_reallocate(ptr: *mut u8, old_size: usize, size: usize, align: usize) -&gt; *mut u8 { realloc(ptr as *mut c_void, size as u32) as *mut u8 }</span></span></code> </pre><br>  <s>Also in the project root you need to create a target platform configuration file</s> <s><br></s>  <s>thumbv7m-none-eabi.json</s> <a href="https://habrahabr.ru/users/grossws/" class="user_link">grossws</a> suggested that now this file is included in the compiler and you can not create it. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"arch"</span></span>: <span class="hljs-string"><span class="hljs-string">"arm"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cpu"</span></span>: <span class="hljs-string"><span class="hljs-string">"cortex-m3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data-layout"</span></span>: <span class="hljs-string"><span class="hljs-string">"em:ep:32:32-i1:8:32-i8:8:32-i16:16:32-i64:64-v128:64:128-a:0:32-n32-S64"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"disable-redzone"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"executables"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"llvm-target"</span></span>: <span class="hljs-string"><span class="hljs-string">"thumbv7m-none-eabi"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"morestack"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"os"</span></span>: <span class="hljs-string"><span class="hljs-string">"none"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"relocation-model"</span></span>: <span class="hljs-string"><span class="hljs-string">"static"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target-endian"</span></span>: <span class="hljs-string"><span class="hljs-string">"little"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target-pointer-width"</span></span>: <span class="hljs-string"><span class="hljs-string">"32"</span></span> }</code> </pre><br>  Copy into the Rust folder of the project the libs-arm folder containing the components compiled to work under ARM from the standard Rust library. <br><br>  We change the Debug target so that it runs the compilation with the parameters we need <br><br><pre> <code class="hljs pgsql">rustc -C opt-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span>=<span class="hljs-number"><span class="hljs-number">2</span></span> -Z <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-landing-pads <span class="hljs-comment"><span class="hljs-comment">--target thumbv7m-none-eabi -g --crate-type lib -L libs-arm src/lib.rs --emit obj,link</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/b8a/d21/a4b/b8ad21a4b52b46632c525ad5447d97ee.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/098/0f4/752/0980f47524beeef25524a6b4ba81d801.png" alt="image"><br><br>  Compile the Rust project.  As a result, the file lib.o will appear in the project folder. <br><br>  Now in the C-project we create files api.h / api.c, in which we declare and implement the functions that are used in api.rs. <br><br>  api.h <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> SERIAL_DEMO_API_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SERIAL_DEMO_API_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f1xx_hal.h"</span></span></span><span class="hljs-meta"> void stm32_delay(uint32_t milli); void usart2_send_string(uint8_t* str, uint16_t len); void usart2_send_byte(uint8_t byte); int16_t usart2_try_get_byte(void); void stm32_toggle_led(uint8_t led); void stm32_enable_led(uint8_t led); void stm32_disable_led(uint8_t led); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  api.c <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f1xx_hal.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f1xx_hal_uart.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> void stm32_delay(uint32_t milli) { HAL_Delay(milli); } extern UART_HandleTypeDef huart2; void usart2_send_string(uint8_t* str, uint16_t len) { HAL_UART_Transmit(&amp;huart2, str, len, 1000); } void usart2_send_byte(uint8_t byte) { while (!(USART2-&gt;SR &amp; UART_FLAG_TXE)); USART2-&gt;DR = (byte &amp; 0xFF); } int16_t usart2_try_get_byte(void) { volatile unsigned int vsr; vsr = USART2-&gt;SR; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (vsr &amp; UART_FLAG_RXNE) { USART2-&gt;SR &amp;= ~(UART_FLAG_RXNE); return (USART2-&gt;DR &amp; 0x1FF); } return -1; } uint16_t stm32_led_to_pin(uint8_t led); void stm32_toggle_led(uint8_t led) { HAL_GPIO_TogglePin(LED_R_GPIO_Port, stm32_led_to_pin(led)); } void stm32_enable_led(uint8_t led) { HAL_GPIO_WritePin(LED_R_GPIO_Port, stm32_led_to_pin(led), GPIO_PIN_SET); } void stm32_disable_led(uint8_t led) { HAL_GPIO_WritePin(LED_R_GPIO_Port, stm32_led_to_pin(led), GPIO_PIN_RESET); } uint16_t stm32_led_to_pin(uint8_t led) { switch (led) { case 1: return LED_R_Pin; case 2: return LED_G_Pin; case 3: return LED_B_Pin; default: return LED_B_Pin; } }</span></span></code> </pre><br>  Add the demo_main_loop () call inside the main function. <br><br>  main.c <br><br><pre> <code class="cpp hljs">... <span class="hljs-comment"><span class="hljs-comment">/* Infinite loop */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN WHILE */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* USER CODE END WHILE */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 3 */</span></span> demo_main_loop(); } <span class="hljs-comment"><span class="hljs-comment">/* USER CODE END 3 */</span></span> ...</code> </pre><br>  It remains to link everything.  To do this, open the project properties in C and tell the linker where to get the missing obj files. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/823/ec6/726/823ec67268d95ed4033d75358cbdcc37.png" alt="image"><br><br>  Compile.  The binary has gained a lot of weight, but still fits in the STM32F103C8. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ee/287/70e/1ee28770e1c9f49cca0c081817a93a3f.png" alt="image"><br><br>  We launch Debug and we see that Eclipse without problems passes from the C-code to Rust. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/20c/b42/e84/20cb42e844e117ece5911f014d7a1b27.png" alt="image"><br><br>  At the end of the article I want to thank the authors of the following posts, without them I would not have mastered this process: <br><br>  <a href="http://www.hashmismatch.net/pragmatic-bare-metal-rust/">www.hashmismatch.net/pragmatic-bare-metal-rust</a> <br>  <a href="https://spin.atomicobject.com/2015/02/20/rust-language-c-embedded/">spin.atomicobject.com/2015/02/20/rust-language-c-embedded</a> <br>  <a href="https://github.com/japaric/rust-cross">github.com/japaric/rust-cross</a> <br><br>  The article was written with the hope that this would serve as an additional step in the emergence of a community of developers using Rust for programming under microcontrollers, since  it is really a convenient and modern language, despite the fact that it has a rather high threshold of entry. </div><p>Source: <a href="https://habr.com/ru/post/324646/">https://habr.com/ru/post/324646/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324636/index.html">UX for application localization: a developer's guide</a></li>
<li><a href="../324638/index.html">90+ free resources for self-study online</a></li>
<li><a href="../324640/index.html">A revolution in javascript. Literally</a></li>
<li><a href="../324642/index.html">Error Handling in C</a></li>
<li><a href="../324644/index.html">On technical aspects of external and internal motivation</a></li>
<li><a href="../324648/index.html">How I started programming better</a></li>
<li><a href="../324650/index.html">Count to three: two</a></li>
<li><a href="../324654/index.html">Infrastructure migration to the ‚Äúcloud‚Äù in steps: what difficulties arise and where</a></li>
<li><a href="../324658/index.html">Launching the project Otus.ru</a></li>
<li><a href="../324660/index.html">Manage domain permissions using PowerShell and the ADSI API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>