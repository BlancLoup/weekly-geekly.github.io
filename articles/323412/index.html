<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OOP is beautifully cracked with C ++ 14</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Recently, when working on a project of educational practice, the need arose from one's own code to generate an arbitrary process and si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OOP is beautifully cracked with C ++ 14</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/666/11f/b69/66611fb69ffa4ae3b0f7a8b69bc43726.png" align="left"><h1>  Introduction </h1><br>  Recently, when working on a project of educational practice, the need arose from one's own code to generate an arbitrary process and simultaneously read its stdout and stderr.  Since the application is written exclusively for linux, I decided to deal with <a href="https://ru.wikipedia.org/wiki/Epoll">epoll</a> at the same time.  To start the process on the Internet, a small library was found that does exactly what is needed, and it also wraps the input-output into the usual streams from the standard library (this is &lt;iostream&gt;). <br><br><br>  Armed with several articles about epoll, I was already going to write code, if not for one ‚Äúbut‚Äù - for epoll, you need access to raw file descriptors, and the author of the library does not provide public access to them.  Class methods that return handles are hidden under the heading "protected". <br><br><h3>  What to do? </h3><br>  The easiest way would be to fix the library code and move the necessary methods to the public section, it would be even better to fork the library and implement the necessary functionality yourself.  But the first would be ugly and would give rise to conflicts when updating the library, and the second would take too much time to parse the library code and then test it under several different * nix-systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, an insane third thought occurred to me: why not try to somehow ‚Äúcrack‚Äù the OOP and ‚Äúlegally‚Äù get access to the protected method without interfering with the source code of the library?  About what barriers arose on this way and how C ++ 14 helped to overcome them, and the story in this publication will go. <br><a name="habracut"></a><br><h3>  Test environment </h3><br>  For example, use the following simple code: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; class A { protected: int f(){ std::cout &lt;&lt; "Protected" &lt;&lt; std::endl; return 0; } }; int main(int argc, char **argv){ A a; int val = 1; //val = af(); //    f()? return val; }</span></span></span></span></code> </pre> <br>  All examples are compiled under Ubuntu 16.04 using gcc (Ubuntu 5.4.0-6ubuntu1 ~ 16.04.4). <br><br>  <strong>Warning: the following sections provide code that is not recommended for use in production!</strong> <br><br><h2>  Idea 1 is a static method </h2><br>  So, my eyes lit up, the task was set, but how to solve it?  We recall the inheritance rules in OOP: protected fields and methods are available only in the scope of the class itself and the classes that inherit it. <br><br>  The first step is clear: create a class that inherits the target class (in our case, this is the ‚ÄúA‚Äù class).  And since we want to call a protected method on an already existing object, the static method of our wrapper should help us to get to it: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _f(A &amp;a){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> af(); } }; <span class="hljs-comment"><span class="hljs-comment">// main(): val = B::_f(a);</span></span></code> </pre><br>  Everything turned out so simple?  Not here it was!  C ++ <a href="http://stackoverflow.com/questions/11631777/accessing-a-protected-member-of-a-base-class-in-another-subclass">prohibits</a> accessing the protected members of the parent class from the child, which the compiler politely reminds us of: <br><br><div class="spoiler">  <b class="spoiler_title">Compilation log</b> <div class="spoiler_text"><pre>  access_protected_fields_hack.cpp: In member function 'int B :: _ f (A &amp;)':
 access_protected_fields_hack.cpp: 15: 6: error: 'int A :: f ()' is protected
   int f () {std :: cout &lt;&lt; "Protected" &lt;&lt; std :: endl;  return 0;  }
       ^
 access_protected_fields_hack.cpp: 20: 27: error: within this context
   int _f (A &amp; a) {return af ();  }
</pre><br></div></div><br><h2>  Idea 2 - Type Substitution </h2><br>  Pure thoughts misfired, so the more ‚Äúdirty‚Äù methods go further: deceive the compiler in such a way that he considers that ‚Äúa‚Äù is an object of class ‚ÄúB‚Äù, and after that we will call our public method: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _f(){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f(); } }; <span class="hljs-comment"><span class="hljs-comment">// main(): B *b = (B *) &amp;a; val = b-&gt;_f();</span></span></code> </pre><br>  Bingo!  This code does what you need, in the console we see the cherished "protected" and return code 0. <br><br>  We do not use virtual inheritance and inherit only one class, so the structure of class ‚ÄúB‚Äù should remain exactly the same as that of the parent ‚ÄúA‚Äù.  This means that all virtual methods will also remain at the same offsets as the parent class.  It turns out that we, as it were, force the compiler to assume that the method we need is not protected, but public, without at the same time changing the object itself. <br><br>  It seems that the problem is solved.  To access a protected method, we inherit from the class of the target object and by this we clog the scope;  spying what type of return value we need for a function or a field ... And so what, every time?  The condition of the problem was in a <i>beautiful</i> "hacking".  But is such a beautiful decision?  Obviously not. <br><br><h2>  Idea 3 - we write macro </h2><br>  For a macro to be convenient, it must have the following properties: <br><br><ul><li>  Embeddable expressions; </li><li>  Do not clutter the scope with variables and classes that are necessary only for the macro to work; </li><li>  Require the transfer of a minimum of arguments to perform the task; </li><li>  Well and, it is desirable that it does not generate unnecessary final code. </li></ul><br>  We define which parts of the code that change from class to class need to be put out of the box: <br><br><ul><li>  The target whose protected member we want to access; </li><li>  The name of the protected member; </li><li>  The type of return value for our public function (corresponds to the type of field / method to which we want to access); </li><li>  The type of class from which inheritance is coming. </li></ul><br>  The first two items legally occupy their places in the macro argument list, but the other two will try to figure out inside the macro using C ++ 14. <br><br>  Thus, we have the following declaration: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ACCESS_PROTECTED(OBJ, FLD) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; &gt;</span></span></span></span></code> </pre> <br>  Now we solve the problems: <br><br>  <b>Buildability</b> <br><br>  To ensure embedding in other expressions, the macro code itself must be an expression.  This is where C ++ 11 comes with lambda functions.  You can wrap all the macro code into it and call it right there on the spot. <br><br>  <b>Visibility area clogged problem</b> <br><br>  Since ancient times, C ++ allows us to define anonymous classes and structures, which is exactly what we need.  And the lambda function creates its isolated scope, so that the variables that we will use inside it will not be visible from the outside. <br><br><div class="spoiler">  <b class="spoiler_title">At this point, the macro code looks like this</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ACCESS_PROTECTED(OBJ, FLD) (([](??? &amp;o) -&gt; ??? {\ class : ??? {\ public: ??? _f(){ return this-&gt;FLD; }\ } *a = (??? *) &amp;o;\ return a-&gt;_f();\ })(OBJ))</span></span></code> </pre> <br></div></div><br>  <b>Automatic type inference</b> <br><br>  Starting with C ++ 11, the keywords ‚Äúauto‚Äù and ‚Äúdecltype‚Äù are available in the language for automatic type inference.  However, only with C ++ 14 they can be used in declarations of lambda functions and methods.  And this is exactly what we need. <br><br>  The only problem remains with the type of the class from which the inheritance comes.  Since an object gets into the lambda function not by copying, but by passing a link to it, decltype (o) from the object will not return the type of the class itself, but the type of reference to it.  It is impossible to inherit from this type, and the compiler appropriately scolds: <br><br><pre>  access_protected_fields_hack.cpp: 7: 8 error: base type
   class: public decltype (o) {\ </pre><br>  Std :: remove_reference from the &lt;type_traits&gt; header file comes to the rescue.  This template structure provides access to the class type of an object, regardless of whether the class itself was passed or only a reference to it. <br><br>  We get the final code: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;type_traits&gt; #define ACCESS_PROTECTED(OBJ, FLD) (([](auto &amp;o) -&gt; auto {\ class : public std::remove_reference&lt;decltype(o)&gt;::type {\ public: auto _f(){ return this-&gt;FLD; }\ } *a = (decltype(a)) &amp;o;\ return a-&gt;_f();\ })(OBJ)) class A { protected: int f(){ std::cout &lt;&lt; "Protected" &lt;&lt; std::endl; return 0; } }; int main(int argc, char **argv){ A a; int val = 1; val = ACCESS_PROTECTED(a, f()); return val; }</span></span></span></span></code> </pre><br>  It seems to me beautiful.  What do you think? <br><br><h3>  And what about the end code? </h3><br>  For comparison with the code generated when using the macro, the code was compiled, in which the f () method of class ‚ÄúA‚Äù was simply made public and called.  In both cases, the -O3 flag was used when compiling. <br><br>  The code of the main () function generated by the compiler turned out to be the same for both cases: <br><br><div class="spoiler">  <b class="spoiler_title">Assembly code</b> <div class="spoiler_text"><pre>  0000000000400730 &lt;main&gt;:
   400730: 48 83 ec 08 sub $ 0x8,% rsp
   400734: ba 09 00 00 00 mov $ 0x9,% edx
   400739: be 14 09 40 00 mov $ 0x400914,% esi
   40073e: bf 60 10 60 00 mov $ 0x601060,% edi
   400743: e8 b8 ff ff ff callq 400700 &lt;_ZSt16__ostream_insertIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_PKS3_l @ plt&gt;
   400748: bf 60 10 60 00 mov $ 0x601060,% edi
   40074d: e8 be ff ff ff callq 400710 &lt;_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_ @ plt&gt;
   400752: 31 c0 xor% eax,% eax
   400754: 48 83 c4 08 add $ 0x8,% rsp
   400758: c3 retq   
   400759: 0f 1f 80 00 00 00 00 nopl 0x0 (% rax) </pre><br></div></div><br>  It contains only the inline body of the function A :: f (). <br><br><h2>  Conclusion </h2><br>  The capabilities of the new standard make it possible to conveniently solve problems that were previously difficult to solve or completely impossible.  I was interested to find the use of some "chips" of the language in a real project.  I hope the publication was also useful for you and it was interesting to read. <br><br>  <b>PS:</b> As for the main task that I solved in my application, reluctantly I had to throw out the freshly written macro.  Still, the conscience is not allowed to apply such code in the open source application.  I also had to forget about the epoll, and the reading from stderr and stdout was implemented using istream :: read_some () and sleep for 50 milliseconds between calls. </div><p>Source: <a href="https://habr.com/ru/post/323412/">https://habr.com/ru/post/323412/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323398/index.html">Why the February update HPE 3PAR StoreServ - the most important since the launch line</a></li>
<li><a href="../323400/index.html">Where do the clouds go? RightScale Study Overview</a></li>
<li><a href="../323402/index.html">How does it feel to write articles</a></li>
<li><a href="../323404/index.html">Application we made for Russian Railways</a></li>
<li><a href="../323410/index.html">New on PHDays VII: Hacking IPv6 Networks, Future WAFs, and POS Terminals</a></li>
<li><a href="../323414/index.html">The history of the engineer-radiophysics, who decided to watch</a></li>
<li><a href="../323416/index.html">Yii2, quick start. The easiest site on Yii2 with static pages without using a database</a></li>
<li><a href="../323420/index.html">My Material Design Framework</a></li>
<li><a href="../323422/index.html">Search without internet. New beta application Yandex</a></li>
<li><a href="../323424/index.html">Search space strategies. AI driver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>