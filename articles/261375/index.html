<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analyzing unusual firmware: analysis of the contest Best Reverser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When we invented the task for the reverse engineering contest , which took place on the PHDays V forum, we wanted to reflect the real problems that RE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analyzing unusual firmware: analysis of the contest Best Reverser</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/pt/blog/261375/"><img src="https://habrastorage.org/files/3c6/f74/d9e/3c6f74d9e3b44f45a2798adc5551304a.png"></a> <br><br>  When we invented the task for <a href="http://www.phdays.ru/program/contests/">the</a> reverse engineering <a href="http://www.phdays.ru/program/contests/">contest</a> , which took place on the PHDays V forum, we wanted to reflect the real problems that RE specialists face, but at the same time tried to avoid patterned solutions. <br><br>  How usually look puzzles on the reverse?  There is an executable file under Windows (or Linux, or MacOS, or another popular operating system), you can run it, look under the debugger, and turn it as you like in virtual environments.  The file format is known.  Processor Command System - x86, AMD64 or ARM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Library functions and system calls are documented.  Access to equipment - only through the mechanisms of the operating system. <br><br>  With the use of existing tools (for example, IDAPro with HexRays and all related capabilities), the analysis of such applications becomes almost childish fun: everything works out simply and quickly. <a name="habracut"></a><br><br>  Of course, sometimes to add complexity to the program, virtual machines are added with their own instruction set, code littering, protection against debugging, etc. But to be honest, how often do large software vendors use all this in their executable files?  Yes, almost never!  What is the point of making a contest aimed at demonstrating skills that are rarely required in real life? <br><br>  However, there is another area of ‚Äã‚Äãapplication for reverse engineering, which is increasingly in demand in recent years, firmware analysis.  And then the situation is not the same as in the traditional RE. <br><br>  The input file (with firmware) can be in any format, it can even be packed or encrypted.  The operating system may not be at all popular - or it may even be missing.  Part of the code can be hardcoded in the device and not updated through the firmware.  The processor architecture can be any!  IDAPro, for example, "knows" more than 100 different processors, but not all.  And, of course, there is almost no documentation, debugging is almost never available, and often even normal code execution is impossible: there is firmware, but there is no device ... <br><br>  We decided to offer approximately this task to the contestants (any Internet user could take part).  Each of them had to analyze the executable <a href="">file</a> and find the correct key corresponding to its email. <br><br><h4>  First part: bootloader </h4><br>  At the first stage, the input file was ELF, compiled by the cross-compiler for the PA-RISC architecture.  IDA can work with this architecture, but not as well as with x86.  Many calls to stack variables are not automatically recognized, and IDA has to be helped by hand.  But at least all library functions are visible (log, printf, memcpy, strlen, fprintf, sscanf, memset, strspn) and even the symbolic names of some program functions (c32, exk, cry, pad, dec, cen, dde). <br><br>  It's quite simple to understand that the program is waiting for two arguments to enter - email and key. <br><br><img src="https://habrastorage.org/files/eb6/ac4/ad3/eb6ac4ad37b242e384d9bc8524b3fcfd.png"><br><br>  It is also easy to find out that the key should consist of two parts, separated by the symbol '-'.  The first part (7 characters) should consist only of allowed MIME64 characters (0-9A-Za-z + /), and the second (32 characters) - from hexadecimal characters, which turn into 16 bytes. <br><br><img src="https://habrastorage.org/files/ba5/d93/35a/ba5d9335a28a4ed0a7a2a522c629940a.png"><br><br>  Further, the <code>c32</code> function calls are <code>c32</code> , folding in: <br><br> <code>t = c32(-1, argv[1], strlen(argv[1])+1)</code> <br> <code>k = ~c32(t, argv[2], strlen(argv[2])+1)</code> <br> <br>  The name c32 is a hint: it is used by the RC32, which is confirmed by the constant <code>0xEDB88320</code> . <br><br>  Next comes the call to the dde function (short for doDecrypt), which takes the inverted CRC32 output in the first argument ‚Äî the encryption key, and in the second and third, the address and size of the decrypted array. <br><br>  Decryption is performed by the BTEA algorithm based on code borrowed from Wikipedia.  You can guess that this is BTEA, you can use the constant <code>DELTA==0x9E3779B9</code> .  True, it is used in other algorithms that are predecessors of the BTEA, but there are very few options. <br><br>  The key must be 128-bit, and CRC32 returns a 32-bit value, so three additional <code>exk (expand_key)</code> are obtained in the <code>exk (expand_key)</code> function <code>exk (expand_key)</code> multiplying the previous value by the same DELTA value. <br><br>  True BTEA is not used very often.  First, this algorithm has a custom block size, and the task uses a 12-byte block: if there are processors with 24-bit registers and memory cells, then why should the block size be a power of two?  :) And secondly, the functions of encryption and decryption are interchanged - this is also possible. <br><br>  Since the data stream is encrypted, blocking in CBC mode (Cipher Block Chaining) is applied.  For the decrypted data in the function cen <code>(calc_enthropy)</code> , the entropy is calculated, and if its value exceeds 7, the decryption result is considered invalid, and the program ends with the corresponding message. <br><br>  Since the encryption key is only 32 bits long, it may seem easy to pick it up.  However, if you follow the logic of the program, to verify each key, you must first decrypt 80 kilobytes of data, and then calculate the entropy for them.  And the search for the encryption key "in the forehead" will take too much time. <br><br>  However, after entropy checking, another function is called, the pad (the original name is strip_pad), which checks and cuts <code>PKCS#7 padding</code> .  Because of the properties of the CBC mode, in order to check the addition, it is necessary to decrypt only one block (the last one), take the last byte N from it, check that its value lies in the range from 1 to 12 inclusive and that each of the last N bytes has the value N. <br><br>  This can significantly reduce the number of operations for checking one key, but if the last decrypted byte is 1 (and this will be true for 1/256 keys), you still have to do a full check ... <br><br>  To find the key faster, it is enough to assume that the decrypted data will have a DWORD length (4 bytes).  Then in the last DWORD of the last block there can be only one of the three possible values ‚Äã‚Äã- <code>0x04040404</code> , <code>0x08080808</code> or <code>0x0C0C0C0C</code> .  And using such heuristics you can sort through all possible keys (and guaranteed to find the right one) in less than 20 minutes. <br><br>  If all checks after decryption (entropy and padding integrity) are successful, the fire_second_proc function is called, which simulates launching a second processor and loading decrypted data (firmware) into it - because in modern devices there are often more than one processor, and with completely different architectures. <br><br>  If the second processor was successfully launched, the user‚Äôs email and 16 bytes with the second part of the key are sent to it via the send_auth_data function.  In this place we accidentally made a mistake: instead of the size of the second part of the key, the size of the string with the email was used. <br><br><h4>  The second part: firmware </h4><br>  With the analysis of the second part is all somewhat more complicated.  There is not ELF, but simply an image of memory - without headers, names of functions and other meta-information.  And of course, neither the type of processor nor the address of the load is known. <br><br>  The algorithm for determining the processor architecture that we conceived is a brute force.  We open it in IDA, set the next type, look at the resulting garbage, and repeat until IDA shows something like code.  A search should ideally lead to the conclusion that this is a big-endian SPARC. <br><br>  Now you need to determine the download address.  The function at offset 0x22E0 is not called anywhere, but it contains quite a lot of code.  It can be assumed that this is the entry point into the program, the start function. <br><br>  In the third statement of the start function, the unknown library function is called with one argument <code>== 0x126F0</code> , and the same function is called from start 4 more times, always with different, but close in value arguments ( <code>0x12718</code> , <code>0x12738</code> , <code>0x12758</code> , <code>0x12760</code> ).  And in the middle of the program, starting at offset <code>0x2490</code> , there are just 5 text lines with messages: <br><br><pre> <code class="bash hljs">00002490 .ascii <span class="hljs-string"><span class="hljs-string">"Firmware loaded, sending ok back."</span></span>&lt;0&gt; 000024B8 .ascii <span class="hljs-string"><span class="hljs-string">"Failed to retrieve email."</span></span>&lt;0&gt; 000024D8 .ascii <span class="hljs-string"><span class="hljs-string">"Failed to retrieve codes."</span></span>&lt;0&gt; 000024F8 .ascii <span class="hljs-string"><span class="hljs-string">"Gratz!"</span></span>&lt;0&gt; 00002500 .ascii <span class="hljs-string"><span class="hljs-string">"Sorry may be next time..."</span></span>&lt;0&gt;</code> </pre><br>  If we assume that the download address is <code>0x126F0-0x2490 == 0x10260</code> , then all arguments when calling the library function will point to the lines exactly, and the unknown function itself will be the printf function (or puts, which is not important in this case). <br><br>  After changing the download base, the code will look like this: <br><br><img src="https://habrastorage.org/files/8dc/a39/4ea/8dca394ea43d4933a495d1044f49cba1.png"><br><br>  The value <code>0x0BA0BAB0</code> , passed to the <code>sub_12194</code> function, is also found in the first part of the job, in the fire_second_proc function, and is compared with what is obtained from <code>read_pipe_u32()</code> .  So, <code>sub_12194</code> should be called <code>write_pipe_u32</code> . <br><br>  Similarly, the two library function <code>sub_24064</code> are <code>memset(someVar, 0, 0x101)</code> for email and code, and <code>sub_121BC</code> is <code>read_pipe_str()</code> , the reverse of <code>write_pipe_str()</code> from the first part. <br><br>  The very first function (at offset 0 or address <code>0x10260</code> ) has characteristic constants that allow it to accurately determine MD5_Init: <br><br><img src="https://habrastorage.org/files/614/a16/51e/614a1651e1ab446280b740f2fa8368bc.png"><br><br>  And right next to the place where <code>MD5_Init</code> a single call, it is easy to detect the functions <code>MD5_Update()</code> and <code>MD5_Final ()</code> , before which the library <code>strlen()</code> called. <br><br><img src="https://habrastorage.org/files/948/66b/5b0/94866b5b08f04d5b97e1eecc2130c1e5.png"><br><br>  In the <code>start()</code> function, very few unknown functions remain. <br><br><img src="https://habrastorage.org/files/154/260/4c0/1542604c00044e4a826668843b4c45a7.png"><br><br>  The <code>sub_12480</code> function reverses a byte array of a given length.  In fact, this is a memrev, to the input of which an array of code 16 bytes is fed. <br><br>  It is obvious that in <code>sub_24040</code> a decision is made on whether the code was correct.  In this case, the arguments are passed a pointer to the calculated MD5 (email) value, a pointer to an array filled in the <code>sub_12394</code> function, and the number 16. It could well have been just a call to <code>memcmp!</code> <br><br>  The main magic is performed in the <code>sub_12394</code> function.  There are almost no clues there, but the algorithm itself is described by one phrase - multiplication of a 128-bit binary matrix by a 128-bit binary vector. The matrix is ‚Äã‚Äãstored in the firmware body at <code>0x240B8</code> . <br><br>  Thus, the code will be recognized as valid if <code>MD5(email) == matrix_mul_vector(matrix, code)</code> . <br><br><h4>  Calculating the correct key </h4><br>  To find the correct value of code, it is necessary to solve the system of binary equations described by the matrix, when the corresponding bits from MD5 (email) are on the right-hand side.  If someone has forgotten linear algebra: this is easy to do by the Gauss method. <br>  When the right part of the key is known (32 hexadecimal characters), it is necessary to select the first 7 characters so that the result of the CRC32 calculation is equal to the found value of the key for the BTEA.  These values ‚Äã‚Äãare approximately 1024 pieces, and you can search for them either by simple enumeration (fairly quickly), and by reversing CRC32 and checking valid symbols (generally instantly). <br><br>  It remains to collect everything together and get a key that will pass all the checks and will be recognized as valid by our verifier :) <br><br>  We were afraid that the task would be too complicated and no one could solve it independently from the beginning to the end.  Fortunately, Viktor Alyushin showed that our fears were groundless, for which he thanks a lot :) His rantup with the solution of our competitive task: <a href="http://nightsite.info/blog/16542-phdays-2015-best-reverser.html">nightsite.info/blog/16542-phdays-2015-best-reverser.html</a> We <a href="http://nightsite.info/blog/16542-phdays-2015-best-reverser.html">will</a> remind you that Victor is victorious in Best Reverser second time: he was the best in 2013. <br><br>  The second place, having completed only part of the task, was taken by the participant who asked not to publish his name. <br><br>  Thanks to all the contestants! <br><br>  <b>Author</b> : Dmitry Sklyarov, Head of Application Analysis, Positive Technologies </div><p>Source: <a href="https://habr.com/ru/post/261375/">https://habr.com/ru/post/261375/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261363/index.html">HP Education Day - a bit of everything HP has</a></li>
<li><a href="../261365/index.html">Wall Street Technology Arms Race: An Inside Look</a></li>
<li><a href="../261367/index.html">Microsoft and the Internet of Things? An introductory article on how we see this concept.</a></li>
<li><a href="../261369/index.html">Financial data transfer protocols. Instructions for use</a></li>
<li><a href="../261371/index.html">Cryptography in the fight for the bright future of the Internet</a></li>
<li><a href="../261379/index.html">How not to ruin the architecture right away? Video from the lecture of Evgeny Krivosheev</a></li>
<li><a href="../261381/index.html">Combinatorial testing: generation of test data and not only</a></li>
<li><a href="../261383/index.html">Do I need to participate in conferences?</a></li>
<li><a href="../261385/index.html">Environment for Dell VDI Virtual Machines</a></li>
<li><a href="../261387/index.html">Budget SMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>