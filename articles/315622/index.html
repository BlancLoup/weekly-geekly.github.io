<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparing objects by value - 5: Structure Equality Problematic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous publication, we derived the most complete and correct way to implement comparison by value of objects ‚Äî instances of classes (which ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparing objects by value - 5: Structure Equality Problematic</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habrahabr.ru/post/315258/">previous publication,</a> we derived the most complete and correct way to implement comparison by value of objects ‚Äî instances of <a href="https://msdn.microsoft.com/library/0b0thckt.aspx">classes</a> (which are <a href="https://msdn.microsoft.com/library/490f96s2.aspx">Reference Types</a> ) for <a href="https://www.microsoft.com/net">.NET</a> . </p><br><p>  How do you need to modify the proposed method for the correct implementation of the comparison by the value of objects - instances of <a href="https://msdn.microsoft.com/library/ah19swz4.aspx">structures</a> (which are <a href="https://msdn.microsoft.com/library/s1ax56ch.aspx">"types by value" - Value Types</a> )? </p><br><p>  Instances of <a href="https://msdn.microsoft.com/library/ah19swz4.aspx">structures</a> , by their very nature, are always compared by value. </p><br><p>  For predefined types, such as <a href="https://msdn.microsoft.com/library/system.boolean.aspx">Boolean</a> or <a href="https://msdn.microsoft.com/library/system.int32.aspx">Int32</a> , comparing by value means comparing directly the values ‚Äã‚Äãof the structure instances. </p><br><p>  If the structure is defined by the developer - user of the platform (User defined struct), then the default comparison is automatically implemented as a comparison of the field values ‚Äã‚Äãof the structure instances.  (For details, see the description of the <a href="https://msdn.microsoft.com/library/2dts52z7.aspx">ValueType.Equals (Object)</a> method and <a href="https://msdn.microsoft.com/library/53k8ybth.aspx">==</a> and <a href="https://msdn.microsoft.com/library/3tz250sf.aspx">! =</a> Operators).  It also automatically implements the <a href="https://msdn.microsoft.com/library/system.valuetype.gethashcode.aspx">ValueType.GetHashCode ()</a> method, which overlaps the <a href="https://msdn.microsoft.com/library/system.object.gethashcode.aspx">Object.GetHashCode ()</a> method in a <a href="https://msdn.microsoft.com/library/system.object.gethashcode.aspx">specific way</a> . </p><br><h4 id="i-v-etom-sluchae-est-neskolko-suschestvennyh-podvodnyh-kamney">  And in this case there are several significant pitfalls: </h4><a name="habracut"></a><br><ol><li><p>  When comparing field values, reflection is used, which affects performance. </p><br></li><li><p>  A structure field may not have a <a href="https://msdn.microsoft.com/library/s1ax56ch.aspx">‚Äúsignificant‚Äù</a> , but a <a href="https://msdn.microsoft.com/library/490f96s2.aspx">reference</a> type, and in this case, a comparison of fields by reference may not be appropriate from the subject (domain) point of view, and it may be necessary to compare fields by value (although in the general case, using reference fields in the structure can considered an incorrect architectural solution). <br>  (The <a href="https://msdn.microsoft.com/library/2dts52z7.aspx">documentation</a> recommends creating for your structure your own implementation of comparison by value to increase performance and most accurately reflect the value of equality for this type.) </p><br></li><li><p>  It may turn out that, from the substantive point of view, not all fields should participate in the comparison (although, again, for structures in general, this can be considered an incorrect decision). </p><br></li><li>  And finally, the default implementation of the <a href="https://msdn.microsoft.com/library/system.valuetype.gethashcode.aspx">ValueType.GetHashCode ()</a> method does not meet the general requirements for implementing the GetHashCode () method (which we talked about in the <a href="https://habrahabr.ru/post/314328/">first publication</a> ): </li></ol><br><ul><li>  the value of the hash code obtained using <a href="https://msdn.microsoft.com/library/system.valuetype.gethashcode.aspx">ValueType.GetHashCode ()</a> may be unsuitable for use as a key in the hash table; </li><li>  if the value of one or several fields of the object has changed, then the value obtained using <a href="https://msdn.microsoft.com/library/system.valuetype.gethashcode.aspx">ValueType.GetHashCode ()</a> may also be unsuitable for using the key in the hash table; </li><li>  the <a href="https://msdn.microsoft.com/library/system.valuetype.gethashcode.aspx">documentation</a> recommends creating your own implementation of the GetHashCode () method, which most accurately reflects the concept of the hash code for this type. </li></ul><br><p>  Thus, on the one hand, there are several reasons of a general nature pushing the structures to implement their own mechanism for comparing objects by value (performance, matching the domain model). </p><br><p>  On the other hand, the need for a correct implementation of the GetHashCode () method automatically leads to the need to implement a comparison by value, since  due to the nature of the hash code (see the <a href="https://habrahabr.ru/post/314328/">first publication</a> ), the GetHashCode () method must "know" what data (fields) and how they participate in the comparison by value. </p><br><p>  On the third hand, a special case is possible when there is a ‚Äúsimple‚Äù structure consisting, for example, only of structure fields, for which a byte-by-by-by-means comparison with reflection deliberately gives a semantically correct result (for example, <a href="https://msdn.microsoft.com/library/system.int32.aspx">Int32</a> ). </p><br><p>  In this case, it is possible to implement GetHashCode () correctly (so that for equal objects the hash code is always the same) without creating your own implementation of the comparison by value. </p><br><p>  For example: </p><br><div class="spoiler">  <b class="spoiler_title">Simple point structure</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Point { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> X { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { x = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Y { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { y = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; x.GetHashCode() ^ y.GetHashCode(); }</code> </pre> </div></div><br><p>  However, in the case of rewriting this simple example using <a href="https://msdn.microsoft.com/library/bb384054.aspx">"automatically implemented properties", the</a> picture looks less clear: </p><br><div class="spoiler">  <b class="spoiler_title">Simple Point Structure with Auto-Implemented Properties</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Point { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> X { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Y { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; X.GetHashCode() ^ Y.GetHashCode(); }</code> </pre> </div></div><br><p>  The <a href="https://msdn.microsoft.com/library/bb384054.aspx">‚Äúautospecs‚Äù</a> documentation talks about the automatic creation of an anonymous backing field corresponding to public properties. </p><br><p>  Strictly speaking, it is not clear from the description whether, from the point of view of the default implementation of the comparison, two Point objects with the same X and Y values ‚Äã‚Äãwill be equal: </p><br><ul><li>  If the default implementation compares the values ‚Äã‚Äãof the fields with the help of reflection, then how do different objects compare anonymous fields - that these fields correspond to each other, since  each corresponds to property X, and these correspond to each other, since  each matches Y? </li></ul><br><p>  What if backing-fields are created in two different objects with different names like (x1, y1) and (x2, y2)? <br>  Will it be taken into account when comparing that x1 corresponds to x2, and y1 corresponds to y2? </p><br><ul><li>  Are there any other auxiliary fields created that may have different values ‚Äã‚Äãfor the same (X, Y) objects from the interface point of view?  If so, will these fields be taken into account when comparing? </li><li>  Or, perhaps in the case of a structure with <a href="https://msdn.microsoft.com/library/bb384054.aspx">auto-properties</a> , will the byte-by-by-by-by-by <a href="https://msdn.microsoft.com/library/bb384054.aspx">-s</a> comparison of the entire contents of the structure be used, without comparing individual fields?  If so, will the backing fields for each object be created in memory always in the same order and with the same offsets? </li></ul><br><p>  Most likely, somewhere in the depths of the documentation or books of authors related to the development of the platform, you can find positive answers to these questions - in the sense that the behavior for structures with explicitly declared fields and structures with <a href="https://msdn.microsoft.com/library/bb384054.aspx">automotive properties</a> will give the same result with default comparison by value </p><br><p>  Or, if some part is undocumented, then, most likely, the behavior of the compiler and the runtime environment will be expected. </p><br><p>  Taking into account the general set of arguments, it seems that in the general case it is preferable for structures to implement their own comparison by value. </p><br><p>  A detailed example with detailed comments, based on the Person entity familiar from previous publications, will be considered in the <a href="https://habrahabr.ru/post/319100/">next publication</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315622/">https://habr.com/ru/post/315622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315610/index.html">Security Week 46: OAuth 2.0 bypass, low-voltage ICMP DDoS, iOS privacy and loxcreen bypass</a></li>
<li><a href="../315614/index.html">SQL: a couple of tricks in SELECT queries</a></li>
<li><a href="../315616/index.html">Briefly and simply about the difficult - tariffing in "8-800"</a></li>
<li><a href="../315618/index.html">Connect Akuvox IP phones to Avaya PBX without a SIP license</a></li>
<li><a href="../315620/index.html">Headman and Neighbors</a></li>
<li><a href="../315624/index.html">Without TK: how do developers get involved in this</a></li>
<li><a href="../315632/index.html">Egor Bugaenko about MVC on jug.msk.ru</a></li>
<li><a href="../315634/index.html">Opencart Integration with 1C Enterprise</a></li>
<li><a href="../315640/index.html">Cleaning the air in the data center as a way to extend the life of the equipment and reduce costs</a></li>
<li><a href="../315642/index.html">Alistair Coburn: Team Development and Agile</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>