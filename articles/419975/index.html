<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we corporate from Windows ran away</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that in our company C # was chosen as the main language for backend development. By the way, we were always satisfied with this choice,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we corporate from Windows ran away</h1><div class="post__text post__text-html js-mediator-article"><p>  It so happened that in our company C # was chosen as the main language for backend development.  By the way, we were always satisfied with this choice, and when MS started developing the .net Core platform, it became even more interesting, since C # is good, but C # under Linux is even better. </p><br><p>  I will not describe the transition to cross-platform development, since many have already gone the way of transition from Framework to Core. </p><br><p>  I will focus on one moment.  In addition, Docker pushed us towards hosting our applications for Linux, because I really wanted to join the youth stream of containerization of everything that was possible. </p><br><p>  Since we are developing an enterprise, we had to escape under linux and pass-through windows authentication with us.  Actually, this was the driving force behind writing an article.  Since the information was very difficult, in separate chunks, and communication with many people, the idea of ‚Äã‚Äãcollecting everything you need in one place and describing the working version seemed good. </p><a name="habracut"></a><br><p>  As a solution, a variant with reverse proxy under nginx with kerberos authentication was selected.  And so that the solution could be used by comrades from different projects, it was decided to file the docker image, which would solve the basic problem, and from which others could be inherited, or use it as it is. </p><br><p>  In order to make kerberos work, it was necessary to build nginx with additional modules. <br>  The result was about this team.  Everything is molded in two calls to create smaller layers. </p><br><p>  Let's sort our Dockerfile.  We will be based on a very compact image with alpine </p><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> alpine:<span class="hljs-number"><span class="hljs-number">3.7</span></span></code> </pre> <br><p>  Next, tighten the necessary packages, the source code of nginx and the required module spnego-http-auth-nginx-module.  The result is something like this. </p><br><pre> <code class="hljs tex">ENV NGINX_VERSION 1.15.1 RUN set -ex <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; apk add --no-cache <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>git <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>krb5 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>krb5-dev <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>ca-certificates <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>libressl <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>pcre <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>zlib <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; apk add --no-cache --virtual .build-deps <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>build-base <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>linux-headers <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>libressl-dev <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>pcre-dev <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>wget <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>zlib-dev <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; cd /tmp <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; wget http://nginx.org/download/nginx-<span class="hljs-formula"><span class="hljs-formula">${NGINX_VERSION}.tar.gz </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&amp;&amp; tar xzf nginx-$</span></span>{NGINX_VERSION}.tar.gz <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; git clone https://github.com/stnoonan/spnego-http-auth-nginx-module.git nginx-<span class="hljs-formula"><span class="hljs-formula">${NGINX_VERSION}/spnego-http-auth-nginx-module</span></span></code> </pre> <br><p>  This block was selected separately so that when reassembling this layer could be taken from the cache, since it is the longest in time. </p><br><p>  The next set of commands will collect nginx and tidy up for themselves, so that the image does not swell in vain </p><br><pre> <code class="hljs tex">RUN cd /tmp/nginx-<span class="hljs-formula"><span class="hljs-formula">${NGINX_VERSION} </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&amp;&amp; ./configure </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--prefix=/etc/nginx </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--sbin-path=/usr/sbin/nginx </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--conf-path=/etc/nginx/nginx.conf </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--error-log-path=/var/log/nginx/error.log </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--pid-path=/var/run/nginx.pid </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--lock-path=/var/run/nginx.lock </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--user=nginx </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--group=nginx </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-threads </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-file-aio </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_ssl_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_v2_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_realip_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_addition_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_sub_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_dav_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_flv_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_mp4_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_gunzip_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_gzip_static_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_auth_request_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_random_index_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_secure_link_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_slice_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-http_stub_status_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-log-path=/var/log/nginx/access.log </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-client-body-temp-path=/var/cache/nginx/client_temp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-proxy-temp-path=/var/cache/nginx/proxy_temp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--http-scgi-temp-path=/var/cache/nginx/scgi_temp </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-mail </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-mail_ssl_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-stream </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-stream_ssl_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--with-stream_realip_module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">--add-module=spnego-http-auth-nginx-module </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&amp;&amp; make -j$</span></span>(getconf _NPROCESSORS_ONLN) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; make install <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; sed -i -e 's/#access_log logs<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span>access.log main;/access_log <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span>dev<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span>stdout;/' -e 's/#error_log logs<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">/</span></span></span></span>error.log notice;/error_log stderr notice;/' /etc/nginx/nginx.conf <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; adduser -D nginx <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; mkdir -p /var/cache/nginx <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; apk del .build-deps <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&amp;&amp; rm -rf /tmp/*</code> </pre> <br><p>  And so that all this makes sense, raise nginx </p><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMD</span></span> [<span class="hljs-string"><span class="hljs-string">"nginx"</span></span>, <span class="hljs-string"><span class="hljs-string">"-g"</span></span>, <span class="hljs-string"><span class="hljs-string">"daemon off;"</span></span>]</code> </pre> <br><p>  We can assume that the image is ready, now we proceed to ensure that our server has the ability to authorize users. </p><br><p>  To do this, you need to find a domain administrator, I was extremely lucky with him - the guy was responsive and did what he was asked for very quickly.  And you need to do the following. <br>  Suppose the hostname of the host machine is "host-linux", and your domain is "DOMAIN.LOCAL". <br>  In the domain, you need to start a machine with the name "host-linux" and create an account to which we will tie it, for example, "host-linux-user".  Next, you need to create an SPN and generate a keytab file, which we will need when lifting the container. </p><br><p>  We have a team like this </p><br><pre> <code class="hljs pgsql">C:\Windows\system32&gt;ktpass -princ HTTP/HOST-LINUX.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> -mapuser host-linux-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> -pass yourpassword -cryptoAll -ptype KRB5_NT_PRINCIPAL -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> C:\<span class="hljs-keyword"><span class="hljs-keyword">Temp</span></span>\web.keytab</code> </pre> <br><p>  After I got the file, you could go experimenting.  As a result, I got the following nginx.conf </p><br><pre> <code class="hljs pgsql">http { #Whatever <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> there <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name localhost; #Here kerberos stuff starts auth_gss <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; auth_gss_realm <span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>; #Keytab file <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the mounted folder auth_gss_keytab /home/spnego/config/web.keytab; auth_gss_service_name HTTP/HOST-LINUX.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>; auth_gss_allow_basic_fallback <span class="hljs-keyword"><span class="hljs-keyword">off</span></span>; #Here kerberos stuff ends <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { root html; <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.htm; } #bla-bla-bla</code> </pre> <br><p>  Now, in order to start everything up, when lifting the container, it is necessary to throw the current nginx.conf to it and feed the received web.keytab.  To do this, use the magic docker-compose </p><br><pre> <code class="hljs lua">version: <span class="hljs-string"><span class="hljs-string">"2"</span></span> services: nginx-spnego: image: fclmman/alpine-nginx-spnego #  .   ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-number"><span class="hljs-number">5010</span></span>:<span class="hljs-number"><span class="hljs-number">5010</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span>:<span class="hljs-number"><span class="hljs-number">443</span></span> - <span class="hljs-number"><span class="hljs-number">8001</span></span>:<span class="hljs-number"><span class="hljs-number">8001</span></span> #   web.keytab,       volumes: - ./<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>:/home/spnego/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> - ./<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>/nginx.conf:/etc/nginx/nginx.conf</code> </pre> <br><p>  We follow in the directory where we have docker-compose.yml.  In our case, in the same folder there should be a directory ./config with the files nginx.conf and web.keytab.  Execute the command </p><br><pre> <code class="hljs">docker-compose -f ./docker-compose.yml up -d</code> </pre> <br><p>  The container rose and did not die.  This gives hope for success. </p><br><p>  Open the browser on a blast machine. </p><br><p>  In one tab, open chrome: // net-internals / and write down the requests that we go.  In another tab, open <a href="http://host-linux/">http: // host-linux: 80 /</a> .  Let's go back to chrome: // net-internals / and see the results. </p><br><pre> <code class="hljs vbscript">#    negotiate t= <span class="hljs-number"><span class="hljs-number">3</span></span> [st= <span class="hljs-number"><span class="hljs-number">3</span></span>] HTTP_TRANSACTION_READ_RESPONSE_HEADERS --&gt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">401</span></span> Unauthorized <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span>: nginx/<span class="hljs-number"><span class="hljs-number">1.15</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Fri, <span class="hljs-number"><span class="hljs-number">10</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> GMT Content-Type: text/html Content-Length: <span class="hljs-number"><span class="hljs-number">597</span></span> Connection: keep-alive WWW-Authenticate: Negotiate t= <span class="hljs-number"><span class="hljs-number">4</span></span> [st= <span class="hljs-number"><span class="hljs-number">4</span></span>] HTTP_TRANSACTION_SEND_REQUEST_HEADERS --&gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: host-linux Connection: keep-alive Pragma: no-cache Cache-Control: no-cache Authorization: Negotiate #    Upgrade-Insecure-Requests: <span class="hljs-number"><span class="hljs-number">1</span></span> User-Agent: Mozilla/<span class="hljs-number"><span class="hljs-number">5.0</span></span> (Windows NT <span class="hljs-number"><span class="hljs-number">6.3</span></span>; Win64; x64) AppleWebKit/<span class="hljs-number"><span class="hljs-number">537.36</span></span> (KHTML, like Gecko) Chrome/<span class="hljs-number"><span class="hljs-number">67.0</span></span><span class="hljs-number"><span class="hljs-number">.3396</span></span><span class="hljs-number"><span class="hljs-number">.99</span></span> Safari/<span class="hljs-number"><span class="hljs-number">537.36</span></span> Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number"><span class="hljs-number">0.9</span></span>,image/webp,image/apng,*/*;q=<span class="hljs-number"><span class="hljs-number">0.8</span></span> Accept-Encoding: gzip, deflate Accept-Language: ru-RU,ru;q=<span class="hljs-number"><span class="hljs-number">0.9</span></span>,en-US;q=<span class="hljs-number"><span class="hljs-number">0.8</span></span>,en;q=<span class="hljs-number"><span class="hljs-number">0.7</span></span> t= <span class="hljs-number"><span class="hljs-number">4</span></span> [st= <span class="hljs-number"><span class="hljs-number">4</span></span>] -HTTP_TRANSACTION_SEND_REQUEST t= <span class="hljs-number"><span class="hljs-number">4</span></span> [st= <span class="hljs-number"><span class="hljs-number">4</span></span>] +HTTP_TRANSACTION_READ_HEADERS [dt=<span class="hljs-number"><span class="hljs-number">47</span></span>] t= <span class="hljs-number"><span class="hljs-number">4</span></span> [st= <span class="hljs-number"><span class="hljs-number">4</span></span>] HTTP_STREAM_PARSER_READ_HEADERS [dt=<span class="hljs-number"><span class="hljs-number">47</span></span>] t=<span class="hljs-number"><span class="hljs-number">51</span></span> [st=<span class="hljs-number"><span class="hljs-number">51</span></span>] HTTP_TRANSACTION_READ_RESPONSE_HEADERS --&gt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span>: nginx/<span class="hljs-number"><span class="hljs-number">1.15</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Fri, <span class="hljs-number"><span class="hljs-number">10</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> GMT Content-Type: text/html Content-Length: <span class="hljs-number"><span class="hljs-number">612</span></span> Last-Modified: Fri, <span class="hljs-number"><span class="hljs-number">10</span></span> Aug <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> GMT Connection: keep-alive WWW-Authenticate: Negotiate #   ETag: <span class="hljs-string"><span class="hljs-string">"5b6d8350-264"</span></span> Accept-Ranges: bytes</code> </pre> <br><p>  As a result, we see that the operation was successful and we see the nginx welcome screen. <br>  It is worth making one clarification, everything will work only according to the hostname, but as far as I understand it correctly, because we tied kerberos to it. </p><br><p>  Thank you for your attention, if you have read this far, and I really hope that the article will be useful. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/419975/">https://habr.com/ru/post/419975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419961/index.html">The digest of interesting materials for the mobile developer # 265 (August 6 ‚Äî August 12)</a></li>
<li><a href="../419963/index.html">Making a smart controller for an air conditioner on an ESP8266</a></li>
<li><a href="../419965/index.html">Features of ExtremeXOS Switch Configuration</a></li>
<li><a href="../419969/index.html">Hiding in Ruby. We also hide classes from Top-Level.</a></li>
<li><a href="../419971/index.html">Rocket lab repairs, expands and accelerates</a></li>
<li><a href="../419979/index.html">How Python Helps Replace Financial Advisors</a></li>
<li><a href="../419981/index.html">The nightlife of the sky or in search of Perseid</a></li>
<li><a href="../419983/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ326 (August 6 - 12, 2018)</a></li>
<li><a href="../419985/index.html">Klats, klats: the story of Cherry, famous for the switches for keyboards</a></li>
<li><a href="../419987/index.html">What do the drops of blood tell: trigonometry of crimes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>