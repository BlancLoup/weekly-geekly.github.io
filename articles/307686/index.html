<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refinement of Squid log parser for correct viewing of resources visited by HTTPS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I received, and I receive many letters from people with questions on Squid, which works on the basis of my article. The most frequently asked q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refinement of Squid log parser for correct viewing of resources visited by HTTPS</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I received, and I receive many letters from people with questions on Squid, which works on the basis of <a href="https://habrahabr.ru/post/267851/">my</a> article.  The most frequently asked question is about viewing Squid logs with any parser.  The problem is that the version of Squid 3.5.8 with HTTPS configured transparent proxying logs the resources visited by HTTPS not as domain names, but as IP addresses with ports (approx. 164.16.43.56reen43).  Accordingly, when viewing visitor statistics, instead of human information, these same IP addresses skip.  It is rather difficult to collect statistics with such data.  I contacted the Squid developers about this, but I never received a clear answer.  The only thing that I found out is that normal logging works in newer versions of Squid, but for me transparent proxying did not work for me personally properly.  Therefore, the question arose of how to rezolv IP addresses in the parser logs. <br><a name="habracut"></a><br>  Personally, I use the <a href="http://break-people.ru/cmsmade/%3Fpage%3Dscriptology_screen_squid">Screen Squid</a> parser, and it was in it that I decided to try to make the necessary changes.  Since I need a similar rezolv just when working in the terminal with Bash, I decided to do the whole rezolv process as a script in Bash, and in Screen Squid I‚Äôll use it in PHP when I need it. <br><br>  So, for all our plans we need: <br><br><ol><li>  in fact, the <a href="http://break-people.ru/cmsmade/%3Fpage%3Dscriptology_screen_squid">Screen Squid</a> parser itself (I will not print the installation instructions, everything is on the offsite). </li><li>  Grep </li><li>  Sed </li><li>  Nslookup </li><li>  Whois </li><li>  Straight arms </li></ol><br>  The Bash script itself is the following: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   - ip ,     IP="$1"; #  IP    NSLOOKUP,  GREP  SED #       hostname=$(nslookup $IP | grep -m 1 "name" | sed 's|.*= ||'|sed -r 's/ Auth.+//' | sed 's/^[ \t]*//;s/[ \t]*$//' ); #     NSLOOKUP  , #    IP    whois,   # GREP  SED        if [[ "$hostname" == '' ]]; then hostname=$(whois $IP | grep -m 1 "owner\|OrgName\|orgname\|NetName\|netname\|origin" | sed 's|.*: ||'|sed -r 's/. Auth.+//' | sed 's/^[ \t]*//;s/[ \t]*$//') fi #     echo "$hostname" exit 0;</span></span></code> </pre> <br>  In principle, he has already been commented out, there is nothing special to describe here.  We get the IP address information first using Nslookup, in parallel filtering the output of the command using grep and sed to eliminate unnecessary information.  In order not to write a bunch of lines, grep features were used to include several conditions for the selection (" <b>\ |</b> " characters).  Save the script in any convenient place, assign execution rights to it.  Suppose it is saved to <b>/ usr / bin</b> as <b>gethost.sh</b> . <br><br>  The script can be used simply from the terminal: <br><br><pre> <code class="bash hljs">gethost.sh ip_address</code> </pre> <br>  Further I will tell how to fasten this script to Screen Squid.  Suppose it is installed in / var / www / html.  In this folder there will be a subfolder of <b>reports</b> , where the <b>reports.php</b> file is located.  That's it is necessary to make changes in it.  In this file you need to find the lines: <br><br><pre> <code class="php hljs">$result=mysql_query($queryOneIpaddressTraffic) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> (mysql_error()); $numrow=<span class="hljs-number"><span class="hljs-number">1</span></span>; $totalmb=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($line = mysql_fetch_array($result,MYSQL_NUM)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;tr&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;td&gt;"</span></span>.$numrow.<span class="hljs-string"><span class="hljs-string">"&lt;/td&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($enableUseiconv==<span class="hljs-number"><span class="hljs-number">1</span></span>) $line[<span class="hljs-number"><span class="hljs-number">0</span></span>]=iconv(<span class="hljs-string"><span class="hljs-string">"CP1251"</span></span>,<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>,urldecode($line[<span class="hljs-number"><span class="hljs-number">0</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;td&gt;&lt;a href='http://"</span></span>.$line[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-string"><span class="hljs-string">"' target=blank&gt;"</span></span>.$line[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-string"><span class="hljs-string">"&lt;/a&gt;&lt;/td&gt;"</span></span>;</code> </pre> <br>  And instead of the last line, insert the following: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//, HTTPS      (   ':') //  ,   HTTP ,     $dv=strpos($line[0], ":") ; if ($dv &lt; 1) { echo "&lt;td&gt;&lt;a href='http://".$line[0]."' target=blank&gt;".$line[0]."&lt;/a&gt;&lt;/td&gt;"; } else { //      ':' ,   HTTPS ,  //  "" ... //  IP    , ..    ':' $str1=strpos($line[0], ":"); $row1=substr($line[0], 0, $str1); $ipaddress = ltrim($ipaddress); $ipaddress = $row1; //   IP     gethost.sh $hostname = shell_exec('/usr/bin/gethost.sh ' . $ipaddress); //       IP  echo "&lt;td&gt;&lt;a href='https://".$ipaddress."' target=blank&gt;".$hostname."&lt;/a&gt;&lt;/td&gt;"; }</span></span></code> </pre> <br>  The code was written in a hurry, but it works.  And it works, when the viewing of the report ‚ÄúTraffic of users of the IP address‚Äù is opened, personally, for the most part, I only need such a report.  If desired, you can add similar code to any other reports. <br><br>  The code itself is quite simple: first it is determined which resource is currently displayed in the table: HTTP or HTTPS, and if it is HTTPS (determined by the presence of the ":" character), then we separate the IP address from the port, pass the IP address to the <b>gethost</b> script <b>.sh</b> , we get the output of the script in the form of information about the IP address, and display it on the screen. <br><br>  There were thoughts to enter the necessary data into the database right away, but resolving the above method at the stage of filling the database leads to a long process of drinking coffee drinks, so I refused it. <br><br>  Oh yeah, I almost forgot, the script should be on the same server where the Screen Squid parser is located.  Well it is, by the way. <br><br>  If there are suggestions for improvement, refinement, alteration of this script, I will be glad to hear. <br><br><blockquote>  <b>Additions:</b> </blockquote><br>  I did a little differently, it seems to me more informative, as comrade <a href="https://habrahabr.ru/users/kbool/" class="user_link">kbool</a> correctly noted <a href="https://habrahabr.ru/users/kbool/" class="user_link">here</a> .  You can get the SSL certificate data of the desired host directly from PHP by reading the information of interest from there.  Below is the code that needs to be inserted into reports.php instead of the above: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//, HTTPS      (   ':') //  ,   HTTP ,     $dv=strpos($line[0], ":") ; if ($dv &lt; 1) { echo "&lt;td&gt;&lt;a href='http://".$line[0]."' target=blank&gt;".$line[0]."&lt;/a&gt;&lt;/td&gt;"; } else { //      ':' ,   HTTPS ,  //  "" ... //  IP    , ..    ':' $str1=strpos($line[0], ":"); $row1=substr($line[0], 0, $str1); $ipaddress = ltrim($ipaddress); $ipaddress = $row1; //   IP  /////////////////////////////////////////////////////////// $options = array( "ssl" =&gt; array( "capture_peer_cert" =&gt; true, "capture_peer_chain" =&gt; true, "capture_peer_cert_chain" =&gt; false, "verify_peer" =&gt; false, "verify_peer_name" =&gt; false, "allow_self_signed" =&gt; false ) ); $get = stream_context_create($options); $read = stream_socket_client("ssl://".$ipaddress.":443", $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $get); $cert = stream_context_get_params($read); $certinfo = openssl_x509_parse($cert['options']['ssl']['peer_certificate']); $certinfo = $certinfo['name']; $CN=strpos($certinfo,"CN=")+3; $CN_end=strlen($certinfo); $hostname = substr($certinfo, $CN, $CN_end); //////////////////////////////////////////////////////////// //       IP  echo "&lt;td&gt;&lt;a href='https://".$ipaddress."' target=blank&gt;".$hostname."&lt;/a&gt;&lt;/td&gt;"; }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/307686/">https://habr.com/ru/post/307686/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307668/index.html">Architecture Standards for Internet of Things</a></li>
<li><a href="../307670/index.html">Recommender systems in online education. Continuation</a></li>
<li><a href="../307672/index.html">Procedural generation of levels for puzzle games</a></li>
<li><a href="../307674/index.html">New user of your product - how to help him?</a></li>
<li><a href="../307680/index.html">Tim Cook's long game at Apple</a></li>
<li><a href="../307688/index.html">How different are sales directors and founders of IT companies?</a></li>
<li><a href="../307690/index.html">Routing in the CleverStyle Framework</a></li>
<li><a href="../307692/index.html">Creating a WebView application based on AWS ApiGateway and AWS Lambda</a></li>
<li><a href="../307694/index.html">Progressive loading of a web application using code sharing</a></li>
<li><a href="../307696/index.html">Juniper Hardware Architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>