<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cybernetic orchestra. Orchestration of Docker containers with .NET Core applications in the cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Orchestrators can be used to provide load balancing, scalability and increase resiliency. Among them, the service Kubernetes is now very popular. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cybernetic orchestra. Orchestration of Docker containers with .NET Core applications in the cloud</h1><div class="post__text post__text-html js-mediator-article"><p>  Orchestrators can be used to provide load balancing, scalability and increase resiliency.  Among them, the service Kubernetes is now very popular.  The easiest way to try it in business is to deploy it in the cloud, which we will do today. </p><br><p><img src="https://habrastorage.org/webt/rx/3u/wn/rx3uwnjkkqp-6azxt-1cso7gbkc.jpeg"><a name="habracut"></a></p><br><p>  <em>Note: we continue the series of publications of the full versions of articles from the magazine Hacker.</em>  <em>Spelling and punctuation of the author saved.</em> </p><br><h2>  Expand AKS </h2><br><p>  We go to the <a href="https://portal.azure.com/">portal Azure</a> , click "Create a resource" and find a service called Kubernetes Service. </p><br><p>  Choose a name and DNS prefix to your taste.  The name affects how you contact your cluster, but the prefix affects its FQDN. </p><br><p><img src="https://habrastorage.org/webt/fl/yt/vb/flytvbkzq8gmeefi7dqyhpkhqlm.png"></p><br><p>  The cheapest virtual machine currently costs just over $ 30 per month. </p><br><p>  The second step is to create a service principal.  Service principal is a kind of service account under which certain specific tasks can be performed.  The advantages are that the rights of such an account can be limited.  In addition, you can create any number of such accounts (while the number of regular accounts is limited by subscription).  You can find the created service principal accounts in Active Directory among the App Registrations </p><br><img src="https://habrastorage.org/webt/9z/de/ml/9zdemlhwxmhnbcf0zg7stsmn1lc.png"><br><p>  RBAC (role-based access control) is the ability to limit or grant access to specific resources (or groups of resources).  That is, you can distinguish which users of your subscription have access rights and which ones do not have. </p><br><img src="https://habrastorage.org/webt/9j/np/bw/9jnpbwgfkbqaydmumcpnlfroonk.png"><br><p>  At the moment, the process takes about 20 minutes, but everything may depend on the configuration. </p><br><p>  You can find official manuals by links. <br>  <a href="https://docs.microsoft.com/ru-ru/azure/aks/kubernetes-walkthrough-portal">Creating an AKS cluster using the portal</a> <br>  <a href="https://docs.microsoft.com/ru-ru/azure/aks/kubernetes-walkthrough">Creating AKS Cluster with CLI</a> </p><br><p>  To work we need the Azure command line - CLI (Command Line Interface).  It can be installed both under Windows and under macOS or Linux.  Personally, I prefer to use the Azure Cloud Shell.  This is a command line that runs from an Azure portal page loaded into a browser.  To work, it requires a blob storage created.  Its cost will be a few cents per month and therefore I prefer not to be soared about installing the CLI on my car. </p><br><p>  Kubernetes supports various container technologies, but let's look at the most popular - Docker.  <a href="https://hub.docker.com/">docker.hub</a> allows <a href="https://hub.docker.com/">you</a> to store one private image of the docker for free.  If you need more, you can place them for money.  But for money, a private docker image can be placed in the Azure Container Registry.  Now the prices start from 5 dollars per month (for the base SKU). </p><br><p>  I created an ACR service called myservice.  If you also decide to use ACR, then having created the service you will need to get its keys. </p><br><img src="https://habrastorage.org/webt/nd/pi/_o/ndpi_oxqlsx4kk8q9vmtepkhiwu.png"><br><p>  Then it will be possible to log in by executing the command: </p><br><pre><code class="plaintext hljs">docker login myservice.azurecr.io</code> </pre> <br><p>  Enter username (myservice) and password from portal (PJSeyO9 = lCMRDI7dGkz68wjhFGRGxSY3) </p><br><p>  Now, going into the project directory, you can build an image, simultaneously marking it with the desired tag.  And then send it to the cloud service: </p><br><pre> <code class="plaintext hljs">docker build -t myservice.azurecr.io/myservice . docker push myservice.azurecr.io/myservice</code> </pre> <br><h2>  Secrets, secrets ... We provide access to the image and save the settings. </h2><br><p>  When working with a deployed AKS you need to get his credits.  Otherwise, kubectl commands will not be executed.  To access the AKS, the following command is executed: </p><br><pre> <code class="plaintext hljs">az aks get-credentials --resource-group KubernetesGroup --name verycoolcluster</code> </pre> <br><p>  In order to access the docker image located in the docker's repository in a private container, you need to create a secret.  If you have a public image, you can skip this step. </p><br><p>  To create a secret file, you need to run the following command: </p><br><pre> <code class="plaintext hljs">kubectl create secret docker-registry regcred --docker-server=&lt;your-registry-server&gt; --docker-username=&lt;your-name&gt; --docker-password=&lt;your-pword&gt; --docker-email=&lt;your-email&gt;</code> </pre> <br><p>  If your image is in the docker's repository, the value of &lt;your-registry-server&gt; will be <a href="https://index.docker.io/v1/">https://index.docker.io/v1/</a> </p><br><p>  For Azure Container Registry, the FQDN will be &lt;registry-name&gt; .azurecr.io </p><br><p>  That is, to create a secret for the container in my case, I ran: </p><br><pre> <code class="plaintext hljs">kubectl create secret docker-registry regcred --docker-server="myservice.azurecr.io" --docker-username="myservice" --docker-password="PJSeyO9=lCMRDI7dGkz68wjhFGRGxSY3" --docker-email="asommer@yandex.ru"</code> </pre> <br><p>  You can now view the contents of the created secret file using the command: </p><br><pre> <code class="plaintext hljs">kubectl get secret regcred --output=yaml</code> </pre> <br><h1>  INFO </h1><br><p>  If you use AKS, you can not create a secret file, but provide access to the AKS service to the ACR service in another way - by running a special script.  You can take it from the next page: </p><br><p>  <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-auth-aks">Authenticate with Azure Container Registry from Azure Kubernetes Service</a> </p><br><pre> <code class="plaintext hljs">#!/bin/bash AKS_RESOURCE_GROUP=KubernetesGroup AKS_CLUSTER_NAME=verycoolcluster ACR_RESOURCE_GROUP=MyACRGroup ACR_NAME=myservice # Get the id of the service principal configured for AKS CLIENT_ID=$(az aks show --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --query "servicePrincipalProfile.clientId" --output tsv) # Get the ACR registry resource id ACR_ID=$(az acr show --name $ACR_NAME --resource-group $ACR_RESOURCE_GROUP --query "id" --output tsv) # Create role assignment az role assignment create --assignee $CLIENT_ID --role Reader --scope $ACR_ID</code> </pre> <br><p>  You can simply modify the values ‚Äã‚Äãof the variables AKS <em>* and ACR</em> *, then copy the script and paste it into the Azure CLI or Cloud Shell. </p><br><p>  Kubernetes contains a secure credential storage.  That is, you can create a file with settings and access to these settings will be difficult to obtain from the outside.  This file usually contains database connection strings and some credits.  If you don‚Äôt have such information in the application (is it true?), Then you can skip this step. </p><br><p>  In order to create a configuration file from the command line, we first need to consider the vi commands. </p><br><pre> <code class="plaintext hljs">vi &lt; &gt;</code> </pre> <br><p>  will create a file if it is missing or open an existing one </p><br><p>  To save the changes made, press ESC and then ZZ </p><br><p>  To just exit without saving ESC and after: q! </p><br><p>  Very abbreviated description, but it should be enough.  I can add that the use of the Insert key can be very useful. </p><br><p>  So, through the Azure Cloud Shell create a file with an arbitrary name (say, appsettings.json) and the necessary content for you.  Suppose so: </p><br><pre> <code class="plaintext hljs">{ "ConnectionString": "some secret string goes there" }</code> </pre> <br><p>  And after you execute the command: </p><br><pre> <code class="plaintext hljs">kubectl create secret generic secret-appsettings --from-file=/home/youraccount/appsettings.json</code> </pre> <br><p>  This command will create a secret with settings named secret-appsettings <br>  Find out which way to replace / home / youraccount with the pwd command </p><br><h2>  Create deployment </h2><br><p>  Deployments are designed for stateless services.  They describe how Pods and ReplicaSets will be created and how they will be updated.  A pod is a group of containers (or one container) that work in the same environment.  The purpose of ReplicaSet is to control that the specified number of pod will be launched and will constantly work. <br>  Based on the previously created, I create a file deploy.yaml which will create 3 pod.  The file contains the following code (remember that spaces in yaml are very important): </p><br><pre> <code class="plaintext hljs">apiVersion: apps/v1beta1 kind: Deployment metadata: name: mydeployment spec: replicas: 3 minReadySeconds: 10 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 template: metadata: labels: app: myapp spec: containers: - name: app image: myservice.azurecr.io/myservice:latest ports: - containerPort: 80 name: http protocol: TCP imagePullPolicy: Always env: - name: "ASPNETCORE_ENVIRONMENT" value: "Production" volumeMounts: - name: secrets mountPath: /app/secrets readOnly: true imagePullSecrets: - name: regcred volumes: - name: secrets secret: secretName: secret-appsettings</code> </pre> <br><p>  Consider the code.  The beginning describes the number of replicas and the update strategy.  Then the deployment is given a name (myapp) and a link to the container image is indicated.  Ports are registered.  80 is the standard port for http.  Next come the ASP.NET Core environment settings.  Then the credits of the private image of the docker and the secret settings of the application, which we recently created, are mounted. </p><br><pre> <code class="plaintext hljs"> strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1</code> </pre> <br><p>  This piece is responsible for the update process.  maxSurge - the number of pods created over existing when upgrading (in pieces or percent).  maxUnavailable - the maximum number of pods that may become unavailable during the update process. <br>  deployment can be created using the command: </p><br><pre> <code class="plaintext hljs">kubectl apply -f deploy.yaml</code> </pre> <br><h2>  Meet Ingress </h2><br><p>  In order to provide access to cluster services and load balancing, a service called ingress is used.  A rather popular solution is ingress created on the basis of nginx.  The easiest way to install it is using the Kubernetes package manager, called helm.  The advantage of Azure Cloud Shell is that helm is already installed in it.  What remains to be done to install nginx-ingress.  Enter: </p><br><pre> <code class="plaintext hljs">helm init</code> </pre> <br><p>  Wait a bit and execute: </p><br><pre> <code class="plaintext hljs">helm install stable/nginx-ingress --namespace kube-system --set rbac.create=false</code> </pre> <br><h2>  Creating SSL Certificates with LetsEncrypt </h2><br><p>  Since the SSL certificate is bound to a domain name, we will give our DNS resource a name. </p><br><p>  Execute the following command and take external (external) IP </p><br><pre> <code class="plaintext hljs">kubectl get service -l app=nginx-ingress --namespace kube-system</code> </pre> <br><p>  Substitute the IP and the name we have invented for the subdomain into the following script </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Public IP address of your ingress controller IP="168.63.19.2" # Name to associate with public IP address DNSNAME="myservice-ingress" # Get the resource-id of the public ip PUBLICIPID=$(az network public-ip list --query "[?ipAddress!=null]|[?contains(ipAddress, '$IP')].[id]" --output tsv) # Update public ip address with DNS name az network public-ip update --ids $PUBLICIPID --dns-name $DNSNAME</code> </pre> <br><p>  We simply copy this script, paste it into the command line and execute it this way.  As a name for the subdomain, I set a very "original" name - myservice-ingress </p><br><p>  Install the certificate manager in the same way by copying and pasting the following script into the command line.  Here, even nothing really needs to be changed. </p><br><pre> <code class="plaintext hljs">helm install \ --name cert-manager \ --namespace kube-system \ stable/cert-manager \ --set ingressShim.defaultIssuerName=letsencrypt-prod \ --set ingressShim.defaultIssuerKind=ClusterIssuer \ --set rbac.create=false \ --set serviceAccount.create=false</code> </pre> <br><h1>  INFO </h1><br><p>  If we had a cluster with RBAC, the script would be different. </p><br><pre> <code class="plaintext hljs">helm install stable/cert-manager --set ingressShim.defaultIssuerName=letsencrypt-staging --set ingressShim.defaultIssuerKind=ClusterIssuer</code> </pre> <br><p>  If the certificate file is available, you can add it as follows: </p><br><pre> <code class="plaintext hljs">kubectl create secret tls tls-secret --cert CERT.crt --key KEY-FOR-CERT.key</code> </pre> <br><p>  But since we do not have a certificate signed by CA, we will have to dance a little with a tambourine.  We will create a CA using a free service called <a href="https://letsencrypt.org/">LetsEncrypt</a> .  LetsEncrypt is a Certificate Authority that issues certificates completely free of charge.  Such is the altruistic organization whose goal is to secure the Internet. </p><br><p>  So, create a cluster-issuer.yaml file. It describes the organization that issued the certificate. </p><br><pre> <code class="plaintext hljs">apiVersion: certmanager.k8s.io/v1alpha1 kind: ClusterIssuer metadata: name: letsencrypt-prod spec: acme: server: https://acme-v02.api.letsencrypt.org/directory email: youeemail@yourdomain.ru privateKeySecretRef: name: letsencrypt-prod http01: {}</code> </pre> <br><p>  You only need to replace the e-mail with your address and you can perform: </p><br><pre> <code class="plaintext hljs">kubectl apply -f cluster-issuer.yaml</code> </pre> <br><p>  Then we create a certificate file certificate.yaml specifying the name of the created ClusterIssuer and the domain for which the certificate is intended - myservice-ingress.westeurope.cloudapp.azure.com </p><br><pre> <code class="plaintext hljs">apiVersion: certmanager.k8s.io/v1alpha1 kind: Certificate metadata: name: tls-prod-secret spec: secretName: tls-prod-secret dnsNames: - myservice-ingress.westeurope.cloudapp.azure.com acme: config: - http01: ingressClass: nginx domains: - myservice-ingress.westeurope.cloudapp.azure.com issuerRef: name: letsencrypt-prod kind: ClusterIssuer</code> </pre> <br><p>  We carry out: </p><br><pre> <code class="plaintext hljs">kubectl apply -f certificate.yaml</code> </pre> <br><h2>  Service Creation and Ingress </h2><br><p>  Four different types of services can be created in Kubernetes. <br>  The default service is ClusterIP.  Access to this service is possible only from a cluster by internal IP. </p><br><p>  NodePort automatically creates the ClusterIP service.  Access to NodePort is possible from the outside via the following route: <br></p><p>  LoadBalancer load balancer provides access to the service from the outside, automatically creating the NodePort and ClusterIP services. </p><br><p>  ExternalName associates a service with an external name. </p><br><p>  We have enough basic service: </p><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: Service metadata: name: myservice spec: type: ClusterIP ports: - port: 80 name: http targetPort: http selector: app: myapp</code> </pre> <br><p>  By the selector value we specify the name of our deployment. <br>  It remains to create a service. </p><br><pre> <code class="plaintext hljs">kubectl apply -f service.yaml</code> </pre> <br><p>  And as a final step we create an ingress with which I already introduced you a little higher in this article.  In yaml, we specify the name of the cluster-issuer and certificate.  We created them earlier. </p><br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Ingress metadata: name: myingress annotations: kubernetes.io/ingress.class: nginx certmanager.k8s.io/cluster-issuer: letsencrypt-prod nginx.ingress.kubernetes.io/rewrite-target: / spec: tls: - hosts: - myservice-ingress.westeurope.cloudapp.azure.com secretName: tls-prod-secret rules: - host: myservice-ingress.westeurope.cloudapp.azure.com http: paths: - path: / backend: serviceName: myservice servicePort: 80</code> </pre> <br><p>  After some time after the creation of ingress using the same kubectl apply command, our microservice should be available at <a href="http://myservice-ingress.westeurope.cloudapp.azure.com/">https: // myservice-ingress.westeurope.cloudapp.azure.com</a> .  By clicking on the lock in the address bar of the browser next to https, you can make sure that the certificate is valid and issued by the CA. </p><br><img src="https://habrastorage.org/webt/kj/e2/gz/kje2gzpczlirmrm5fpmnjigkcxc.png"><br><br>  We remind you that this is the full version of an <a href="https://xakep.ru/2018/10/08/kubernetes-docker/">article from Hacker magazine</a> .  Its author is <a href="https://habrahabr.ru/users/asommer/">Alexey Sommer</a> . </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435870/">https://habr.com/ru/post/435870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435858/index.html">Programmable hardware TOTP keys with the ability to synchronize time</a></li>
<li><a href="../435862/index.html">Hall of Fame Consumer Electronics: Stories of the Best Gadgets of the Last 50 Years, Part 4</a></li>
<li><a href="../435864/index.html">Mapping Netty Requests</a></li>
<li><a href="../435866/index.html">Release IT: a new platform for launching products and services at the SXSW 2019 festival</a></li>
<li><a href="../435868/index.html">Slush 2018. Day preview</a></li>
<li><a href="../435872/index.html">Zig programming language</a></li>
<li><a href="../435874/index.html">How to save your and other people's time at the interviews, or a little bit about the errors of HR</a></li>
<li><a href="../435876/index.html">Detailed setting of the browser Firefox</a></li>
<li><a href="../435878/index.html">Amateur in opensource - lessons learned for 3 years</a></li>
<li><a href="../435880/index.html">Changing the schema of PostgreSQL tables without long locks. Yandex lecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>