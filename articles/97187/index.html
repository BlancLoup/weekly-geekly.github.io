<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP and Yandex Direct: our experience of using</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On June 18, Yandex announced public access to the Yandex Direct API . We, as an advertising agency, received this access a bit earlier and now we use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP and Yandex Direct: our experience of using</h1><div class="post__text post__text-html js-mediator-article">  On June 18, Yandex <a href="http://direct.yandex.ru/help/%3Fid%3D1112215">announced public access to the Yandex Direct API</a> .  We, as an advertising agency, received this access a bit earlier and now we use it to manage the rates in advertising campaigns.  I would like to share our experience. <br><br><a name="habracut"></a><br><br>  Our initial impressions of the API were rather contradictory, all the same it is noticeable that this is the first version.  In some places there are inconsistencies in the naming of API elements, often excessive, in our opinion, the system of types of method parameters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our goal was to provide project developers with a relatively simple mechanism for describing rules for automatic bidding, while the developer should easily describe trivial situations and be able to implement an arbitrary algorithm if required by advertising or promotion of Internet projects. <br><br>  Using a clean API in this regard, we found it unpromising :) and decided to write a more convenient wrapper over it. <br><br>  We immediately faced one unpleasant moment.  The API uses the SOAP protocol, the server uses SOAP :: Lite.  SOAP :: Lite has some specific features when forming the representation of arrays of objects returned by SOAP methods, as a result of which using the standard PHP-module SOAP Client on the client it becomes impossible to use the classmap option. <br><br>  This option allows you to associate SOAP data types with classes of objects that represent these types, and without it, it‚Äôs generally bad.  With other implementations of a SOAP server, for example, in Java, this problem does not arise, has been tested on Google services and various others.  Frankly, our knowledge of SOAP is not enough to offer a reasonable way out of this situation, the problem is likely on the side of PHP, and not SOAP :: Lite.  Yandex, in turn, recommends using NuSOAP. <br><br>  In general, the protocol seems to be standard, but there is no happiness :( <br><br>  By the way, for normal operation, say, with the Google Adwords API, the query formed by the standard PHP Soap Client has to be patched mercilessly; examples can be viewed in the source code of the PHP client for this service. <br><br>  We were afraid to use NuSOAP and decided to do without a classmap, working with simple stdClass objects that the API returns, adding behavior to them with the help of wrappers.  In addition, the wrappers perform the translation of property names from our standard (with underscores) to CamelCase - it's good when everything is the same. <br><br>  The vast majority of API methods return lists of objects.  In some cases it is convenient not only to use them as containers, but also to attach some kind of behavior to them, so we made the base class of the collections Service.Yandex.Direct.Collection, which: <br><ol><li>  stores the returned data as ordinary stdclass structures </li><li>  when accessing by index, it creates a wrapper over the corresponding elements of the collection, so data is stored inside, and wrappers are created as needed </li><li>  allows you to select individual elements not only by the ordinal index, but also by the value of the identifier of the stored entity; </li><li>  allows to generate child collections that contain only elements that satisfy a certain condition; </li><li>  Allows you to call API methods that operate on collection data (if supported). </li></ol><br>  Actually, access to the API was placed in the Service.Yandex.Direct.APIMapper class, which connects to the service, dispatches SOAP calls using __call, and tries to be polite, making pauses between requests if necessary (at least for testing time there were restrictions on the frequency of calls ). <br><br>  Thus, a developer can call API methods in standard notation of our library, with call logging, keeping time between them, etc. <br><br>  Based on this, we add the behavior to the entities and collections.  Using our own collections is very useful to us, because it allows us, for example, to write like this: <br><br><pre> <code class="hljs rust">Service_Yandex_Direct::api()-&gt; campaigns_for($login)-&gt; by_id($campaign_id)-&gt; all_banners()-&gt; by_id($banner_id)-&gt; all_phrases();</code> </pre><br><br>  Currently, for most of the samples in the API, it is not possible to apply filtering rules (some methods allow, but not all).  Since we needed sampling under various conditions, we had to implement it on the client again in the base class of the collection. <br><br>  It looks like this: <br><br><pre> <code class="hljs php">$phrases-&gt; select()-&gt; where(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'phrase ~'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'{^ }'</span></span>, <span class="hljs-string"><span class="hljs-string">'{^ }'</span></span>)));</code> </pre><br><br>  In this case, from the set of phrases that was returned by the web service, we select phrases starting with ‚Äúadvertising photography‚Äù and ‚Äúadvertising photography‚Äù. <br><br>  A where condition is an array, the keys of which contain the name of the field on which the condition is imposed, and the operation that is used for matching, and the values ‚Äã‚Äãrepresent a sample or a list of samples with which matching is made.  The result of the execution is a collection of the same class as the original one, but containing filtered elements. <br><br>  While we have enough of such operations: <br><ul><li>  ~ - matching with a regular expression; </li><li>  = - equality test; </li><li>  in - check for entry into a set of values. </li><li>  ! in - check for the absence of a set of values. </li></ul><br>  Well, the behavior of the collections and entities also help: <br><br><pre> <code class="hljs rust">Service_Yandex_Direct::api()-&gt; campaigns_for($client)-&gt; all_banner()-&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>(array(<span class="hljs-symbol"><span class="hljs-symbol">'id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>', $ids))-&gt; stop();</code> </pre><br><br>  Now how we adapted all this for project developers. <br><br>  For each project, an advertising campaign management script is created.  It is a PHP script, such as the following: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt; stay_special(</span><span class="hljs-number"><span class="php"><span class="hljs-number">5.0</span></span></span><span class="php">, $campaigns-&gt;by_id(</span><span class="hljs-number"><span class="php"><span class="hljs-number">2059530</span></span></span><span class="php">)-&gt; all_banners()-&gt; where(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'BannerID in'</span></span></span><span class="php"> =&gt; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-number"><span class="php"><span class="hljs-number">6989002</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989179</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989186</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989202</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989206</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989209</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989212</span></span></span><span class="php">))), </span><span class="hljs-number"><span class="php"><span class="hljs-number">0.01</span></span></span><span class="php">)-&gt; try_special(</span><span class="hljs-number"><span class="php"><span class="hljs-number">2.0</span></span></span><span class="php">, $campaigns-&gt;by_id(</span><span class="hljs-number"><span class="php"><span class="hljs-number">2059530</span></span></span><span class="php">)-&gt; all_banners()-&gt; where(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'BannerID !in'</span></span></span><span class="php"> =&gt; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">array</span></span></span><span class="php">(</span><span class="hljs-number"><span class="php"><span class="hljs-number">6989002</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989179</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989186</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989202</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989206</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989209</span></span></span><span class="php">, </span><span class="hljs-number"><span class="php"><span class="hljs-number">6989212</span></span></span><span class="php">))), </span><span class="hljs-number"><span class="php"><span class="hljs-number">0.01</span></span></span><span class="php">); </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  Scripts are launched by the command line application, implemented as a module Service.Yandex.Direct.Manager, the application, in turn, is launched by cron. <br><br>  The variable $ campaigns is automatically created by the task class and contains a list of campaigns for the current client, which is determined by the name of the script file. <br><br>  In each call we define a list of ads for which you need to change prices.  This is done by sequentially sampling the ‚Äúcampaign ‚Üí ads ‚Üí phrases‚Äù. <br><br>  In the first case: <br><ul><li>  <code>$campaigns</code> - all client campaigns; </li><li>  <code>$campaigns-&gt;by_id(2059530)</code> - campaign with id = 2059530; </li><li>  <code>$campaigns-&gt;by_id(2059530)-&gt;all_banners()</code> - all campaign announcements with id = 2059530; </li><li>  <code>$campaigns-&gt;by_id(2059530)-&gt;all_banners()-&gt;where(array('BannerID in' =&gt; array(...)))</code> - all campaign announcements with id = 2059530, with the identifiers listed in </li></ul><br>  Thus, in words, the above expression can be described as follows: all advertisements of the company 2059530 of the client studylab, falling into the specified id list. <br><br>  In fact, we are interested in prices, and prices are tied to phrases.  However, the application itself is able to complete the missing links in the chain.  In our case, the full expression would look like this: <br><br><pre> <code class="hljs rust">$campaigns-&gt; by_id(<span class="hljs-number"><span class="hljs-number">2059530</span></span>)-&gt; all_banners()-&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>(array(<span class="hljs-symbol"><span class="hljs-symbol">'BannerId</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>' =&gt; array(...)))-&gt; all_phrases();</code> </pre><br><br>  In principle, nothing prevents you from writing code in the script file that performs certain actions on prices and then calls the standard update_prices () method.  For example, you could write this: <br><br><pre> <code class="hljs php">$phrases = $campaigns-&gt;by_id(<span class="hljs-number"><span class="hljs-number">2059530</span></span>)-&gt;all_banners()-&gt;all_phrases(); $prices = $phrases-&gt;prices; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($phrases <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $phrase) $prices-&gt;by_id($phrase-&gt;id)-&gt;price = $phrase-&gt;premium_min &lt; $limit ? (($phrase-&gt;premium_min + $delta &lt; $phrase-&gt;premium_max) ? $phrase-&gt;premium_min + $delta : $phrase-&gt;premium_min + <span class="hljs-number"><span class="hljs-number">0.01</span></span>) : $limit; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;api-&gt;update_prices($prices);</code> </pre><br><br>  The above code passes through all the phrases, checks whether the current rate provides a display in special allocations, and adjusts it accordingly. <br><br>  If the project imposes some special requirements on campaign management, this should be done, however, in most projects, price management tasks are usually similar and very simple, so these standard actions can be distinguished into ready-made methods that implement this or that rate change strategy. <br><br>  Three strategies are enough for us now, but probably we will need more: <br><ul><li>  <code>stay_special</code> - hold ad in special placements (but not necessarily in the first place) </li><li>  <code>stay_visible</code> - hold ad in shows; </li><li>  <code>try_special</code> - to keep an ad in shows, trying to get into special placements whenever possible. </li><li>  Each of these strategies is parameterized by the maximum value of the bet and the delta by which it can be increased.  The default delta is 0.01. </li></ul><br>  Thus, instead of the above code, it is enough to write (for example, for all the phrases of a given client) <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stay_special($campaigns-&gt;by_id(<span class="hljs-number"><span class="hljs-number">2059530</span></span>));</code> </pre><br><br>  The programmer tests the script, after which the script is added to the application that manages the campaigns.  So far we have enough of one process, but in general it is possible to run several instances of the campaign manager with separate queues for different clients. <br><br>  What did we get in the end?  Writing an object wrapper over the SOAP API allowed us to minimize the amount of code to solve routine tasks and at the same time make this code sufficiently readable so that, if necessary, even a non-programmer could understand by what rules the rates are formed.  In this case, we leave for the programmer the possibility of implementing an arbitrary algorithm for manipulating the rates. <br><br>  The module code is <a href="http://github.com/techart/tao-service/">available on github</a> , <a href="http://github.com/techart/tao-base/">our internal PHP framework is used</a> . </div><p>Source: <a href="https://habr.com/ru/post/97187/">https://habr.com/ru/post/97187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../97178/index.html">Development of .NET applications for AutoCAD within the framework of MVC architecture</a></li>
<li><a href="../97180/index.html">Time machine for your business</a></li>
<li><a href="../97181/index.html">At the start, attention, N900!</a></li>
<li><a href="../97182/index.html">QRoom - Social Q & A in Russian</a></li>
<li><a href="../97186/index.html">HP has announced a new netbook for schoolchildren HP Mini 100e</a></li>
<li><a href="../97188/index.html">Attention, the announcement! Google Wave Polar Marathon</a></li>
<li><a href="../97191/index.html">New improved Evernote add-on for Firefox</a></li>
<li><a href="../97192/index.html">Workshop "LINQ'building and SharePoint"</a></li>
<li><a href="../97193/index.html">How to teach Windows Search to look for information in pictures</a></li>
<li><a href="../97194/index.html">The graphic style of the 1972 Olympics in Munich</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>