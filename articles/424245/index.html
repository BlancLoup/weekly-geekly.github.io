<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Write a Telegram client - easy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What distinguishes Telegram from other popular messengers? He is open! 
 Other messengers also have an API, but for some reason is telegram known as t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Write a Telegram client - easy</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/74/05/en/7405endgngr3x59c7slog56gha0.png"></p><br><p>  What distinguishes Telegram from other popular messengers?  He is open! <br>  Other messengers also have an API, but for some reason is telegram known as the most open of the most popular ones? </p><br><p>  To begin with, Telegram has a truly completely open client <br>  <a href="https://github.com/TelegramOrg">code</a>  Unfortunately, we don‚Äôt see commits every day right on GitHub, but we have code under an open source license.  Telegram architecture implies that both Bot and API have almost the same methods - <a href="https://core.telegram.org/methods">https://core.telegram.org/methods</a> . </p><br><p>  In fact, Telegram is not just a chat messenger, but a social platform, access to which is open to all sorts of applications.  They can provide additional chips to users, instead of using a ready-made network of users and servers for message delivery.  It sounds so attractive that we wanted to try to write our "client" for Telegrams. </p><a name="habracut"></a><br><h3 id="sut-prilozheniya">  The essence of the application </h3><br><p>  We mainly deal with maps and navigation, so we immediately looked at something related to geolocation.  I really liked that Telegram, before all other applications, had a convenient way to share a location in real time ( <a href="https://telegram.org/blog/live-locations">https://telegram.org/blog/live-locations</a> ), and I use it quite often: to help a friend orient, show and most importantly answer the main question "When will you be?".  In principle, this is enough for most people, but as always there are scenarios when there are not enough simple opportunities.  For example, it may be a group of more than 10 people, with different devices (some devices may not be telephones) and different people.  It would be convenient for these people to exchange messages in a group, as well as see each other‚Äôs movements on the map. </p><br><p>  At the forefront we set the task of creating additional value for the Telegram, and not trying to use it for other purposes.  We did not want people who do not have a special Telegram client, to see a mess of messages in a chat or something unintelligible.  For people with an ‚Äúimproved‚Äù client, additional opportunities appear, for example: </p><br><ol><li>  More refined time management when sending locations in real time to chat. </li><li>  View the location of contacts on the map. </li><li>  Connecting to the chat beacon devices via an external API (Bot). </li></ol><br><h3 id="kak-my-eto-delali">  How we did it </h3><br><p>  Fortunately, all the code we write is Open-Source, so I can immediately give a link to its implementation - <a href="">Bot</a> <a href="https://github.com/osmandapp/Osmand/tree/master/OsmAnd-telegram">implementation</a> and <a href="https://github.com/osmandapp/Osmand/tree/master/OsmAnd-telegram">Komlin Telegram Client implementation</a> . </p><br><h5 id="bot---osnovy">  Bot - the basics </h5><br><p>  There are a lot of documentation and examples on the implementation of Bot, but I still want to go and tell about some of the pitfalls.  To begin with, we wrote the server part <br>  Java and chose the org.telegram: telegrambots library.  Since our server is a regular SpringBoot, initialization is extremely simple: </p><br><pre><code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Gradle implementation <span class="hljs-string"><span class="hljs-string">"org.telegram:telegrambots:3.6"</span></span> TelegramBotsApi telegramBotsApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBotsApi(); telegramBotsApi.registerBot(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramLongPollingBot() {...});</code> </pre> <br><p>  The main feature of the transfer location is that it needs to be updated frequently, and the bot needs to edit the already sent messages.  If this were not possible, the Bot would simply have started spamming the chat, and this, of course, would be Epic Fail.  Thank God, Telegram grants the bot the right to edit messages for 24 hours (at least, possibly longer). </p><br><p>  You can send a message in many ways.  There is a type of Plain Text, Venue, Location, Game, Contact, Invoice, etc.  It seemed that the Location was perfect for our task, but an unpleasant feature was revealed.  Location can be transferred only from one device for one account or bot at a time!  Imagine you have 2 phones and from two phones you sent your Location in one chat.  So, an error will happen on the server and the first Location Sharing will just stop.  It would seem that this is clearly a bad case, but imagine that you have a lot of Chinese beacons that can send Location to a given URL, but they don‚Äôt know how to send directly to Telegram.  You are writing a Bot, which picks up from the server and pulls into telegrams.  This is where it climbs out, that the Bot will not be able to send more than one message from the location type.  It turns out that this is great for one-time sending, but not suitable for Live Location. </p><br><p>  The solution is simple - send text messages, and the client will parse the text and show locations on the map.  Unfortunately, only text messages will be visible in the standard Telegram client, but there you can insert a link to open the map. </p><br><h5 id="bot---podvodnye-kamni">  Bot - Reefs </h5><br><p>  Unfortunately, Bot had to be rewritten 2.5 times.  The main problem is the wrong design of communication. </p><br><ol><li>  For some reason, at first it seemed like a good idea if the bot would be a full member of the chat and send messages.  But, this is bad both in terms of privacy correspondence and in terms of interaction with the bot.  The right decision to use <a href="https://core.telegram.org/bots/inline">inline bots</a> .  Thus, it is guaranteed that the bot does not see anything except its Location and can be used in any chat.  Humanly speaking, it is uncivilized to drag your bot to some kind of general chat, but you need to talk with the bot one-on-one and set it up, and then he will be able to send the necessary messages to any selected chat. </li><li>  The Telegram Message API has 2 types of interaction historically: the buttons below the text ((inline buttons) [ <a href="https://core.telegram.org/bots/2-0-intro">https://core.telegram.org/bots/2-0-intro#switch-to-inline-buttons</a> ]) and the answers to the bot directly text.  In general, the answers with the bot are hopelessly outdated.  Buttons are a bit more complicated from the point of view of implementation, but this completely pays off with ease of use and they should be used for all non-text input. </li><li>  As an example of a bot, you can see the popular @vote_bot or our @osmand_bot. </li></ol><br><h5 id="telegram-client">  Telegram Client </h5><br><p>  We did not manage to find examples of ready telegram clients other than the main one, but the rather simple tdlib structure helped us create the base client in just a couple of days. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle setting:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">task downloadTdLibzip { doLast { ant.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(src: <span class="hljs-string"><span class="hljs-string">'https://core.telegram.org/tdlib/tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, skipexisting: <span class="hljs-string"><span class="hljs-string">'true'</span></span>) ant.unzip(src: <span class="hljs-string"><span class="hljs-string">'tdlib.zip'</span></span>, dest: <span class="hljs-string"><span class="hljs-string">'tdlib/'</span></span>) } } task copyNativeLibs(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/libs" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "libs" } task copyJavaSources(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>) { dependsOn downloadTdLibzip <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> "tdlib/libtd/src/main/java/org/drinkless/td" <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> "src/org/drinkless/td" } dependencies { implementation fileTree(dir: <span class="hljs-string"><span class="hljs-string">'libs'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'*.jar'</span></span>]) }</code> </pre> </div></div><br><p>  Almost all the insides of the Telegram are written in C ++ and from the Android point of view, only the 1.5 Mb API class of the proxy <a href="">TdApi.java is visible</a> .  By comparing the documentation of the bots and the names of the methods, you can simply navigate where to go. </p><br><div class="spoiler">  <b class="spoiler_title">Initializing a client with a global handler:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (libraryLoaded) { <span class="hljs-comment"><span class="hljs-comment">// create client client = Client.create(UpdatesHandler(), null, null) true } else { false } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Request user photo:</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestUserPhoto</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">TdApi</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> remotePhoto = user.profilePhoto?.small?.remote <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remotePhoto != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; remotePhoto.id.isNotEmpty()) { downloadUserFilesMap[remotePhoto.id] = user client!!.send(TdApi.GetRemoteFile(remotePhoto.id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { obj -&gt; <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (obj.<span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>) { TdApi.Error.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> error = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.Error <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> code = error.code <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code != IGNORED_ERROR_CODE) { listener?.onTelegramError(code, error.message) } } TdApi.File.CONSTRUCTOR -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> file = obj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TdApi.File client!!.send(TdApi.DownloadFile(file.id, <span class="hljs-number"><span class="hljs-number">10</span></span>), defaultHandler) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; listener?.onTelegramError(-<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Receive wrong response from TDLib: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$obj</span></span></span><span class="hljs-string">"</span></span>) } } } }</code> </pre> </div></div><br><h5 id="telegram-client---podvodnye-kamni">  Telegram Client - pitfalls </h5><br><ol><li>  Registration / Login and Logout.  When registering, it is necessary to take into account different scenarios: when an access code is sent by SMS or to another telegram client, two-factor authorization, etc.  The biggest challenge is testing.  Any authorization more than 3 times led to account blocking for 24 hours, so testing Logout was especially fun.  Despite the fact that registration is needed only once, this is probably the most difficult part of the integration. </li><li>  Determine how and in what order to read messages.  Any client has access to all messages in all chats, but they must be read sequentially.  In our case, 99% of the messages need to be discarded.  At first, for some reason, we made reading all the messages for the last 3 days at login, but later it only caused problems and when restarting, we lost the messages.  Therefore, now we read only new messages, and for those messages that we need, we store id in the internal database. </li></ol><br><h3 id="chto-poluchilos">  What happened </h3><br><p>  Probably, knowing all the pitfalls could all be done many times faster, but it turned out somewhere 1-2 months for three people.  The final application can be found on <a href="https://play.google.com/store/apps/details%3Fid%3Dnet.osmand.telegram">Google Play</a> . </p><br><p><img src="https://habrastorage.org/webt/gf/o0/zs/gfo0zsgavbn09pkswyzurjoibik.png"></p><br><p>  The main question in this story is how correct this interaction is from the point of view of the Telegram and whether users of this kind of integration will like it.  In any case, the idea itself is niche and it has already found individual customers. </p><br><p>  I will be glad to answer your questions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/424245/">https://habr.com/ru/post/424245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424235/index.html">How to use STATSPACK instead of AWR in Oracle Standard Edition</a></li>
<li><a href="../424237/index.html">Charge your brains directly! Rantime, compilers and performance on Joker 2018</a></li>
<li><a href="../424239/index.html">IBM's Autumn Seminars - Containers, Computer Vision, Digital Transformation</a></li>
<li><a href="../424241/index.html">Print your world</a></li>
<li><a href="../424243/index.html">5 easy ways to improve communication with customers</a></li>
<li><a href="../424247/index.html">KotlinConf 2018 Live - see the broadcast on October 4-5</a></li>
<li><a href="../424249/index.html">Materials from the #RuPostgres meeting - videos, presentations, quiz screening and photo report</a></li>
<li><a href="../424251/index.html">We consider the statistics on the experiments on hh.ru</a></li>
<li><a href="../424255/index.html">How to use static analysis correctly</a></li>
<li><a href="../424257/index.html">Hexagon Cards in Unity: Parts 1-3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>