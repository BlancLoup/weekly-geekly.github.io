<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking IronPython and IronRuby with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, we released a new version of our PVS-Studio analyzer with support for checking C # projects. While at the time of release the further d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking IronPython and IronRuby with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article">  Most recently, we released a new version of our PVS-Studio analyzer with support for checking C # projects.  While at the time of release the further development of the product was suspended, I was engaged in testing the analyzer.  As projects for my experiments, I took IronPython and IronRuby.  And since these projects have been verified, I decided to write a small article report. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/151/718/fc4/151718fc401e86e72f3fc8ce459e0e1d.png" align="left"><br><br><h2>  IronPython and IronRuby </h2><br>  IronPython and IronRuby are an implementation of the Python and Ruby programming languages ‚Äã‚Äãon the .NET platform.  The source code for these projects is available on GitHub at this <a href="https://github.com/IronLanguages/main">link</a> .  Also included is the source code <a href="https://en.wikipedia.org/wiki/Dynamic_Language_Runtime">DLR</a> .  Since the .NET Framework 4.0, DLR is part of it, and IronPython and IronRuby use it.  Nevertheless, I still checked the old version of the DLR, since it was there. <br><a name="habracut"></a><br><h2>  About project validation </h2><br>  So, the whole code consists of three large parts: DLR, IronPython and IronRuby and contains 1630 * .cs files.  For verification, I used PVS-Studio 6.00, which can be downloaded from <a href="http://www.viva64.com/ru/pvs-studio/">our website</a> .  Checking the solution took a little more than a minute.  As a result, the analyzer issued 34 warnings of the first, 15 warnings of the second and 280 warnings of the third level. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the first level of 34 warnings, 19 turned out to be real mistakes - a pretty good result, 6 places look suspicious - they should be paid attention to.  The remaining 9 messages are false positives, half of which can be eliminated by editing the analyzer itself, which we will do in the near future. <br><br>  At the second and third level errors and suspicious places were found significantly less. <br><br><h2>  Bugs found </h2><br>  And now let's look at examples of real errors found with PVS-Studio: <br><br>  <b>Examples 1 and 2. Inattention.</b> <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Enter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RangeExpression</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> node, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isCondition)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isCondition &amp;&amp; litBegin != null &amp;&amp; litEnd != null &amp;&amp; litBegin.Value is <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> &amp;&amp; litBegin.Value is <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { _result = MakeNode(NodeKind.lit, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Range( (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)litBegin.Value, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)litEnd.Value, node.IsExclusive)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0381/">warning</a> : <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are identical sub-expressions' litBegin.Value is the '&amp;&amp;' operator.  IronRubyParseTreeOps.cs 277 <br><br>  The condition checks twice that litBegin.Value is of type int instead of also checking litEnd.Value. <br><br>  Similar tests of the same expressions are present in two more places, for example, here: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PythonTuple </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReduceProtocol2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( CodeContext</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> context, object self)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self is PythonDictionary || self is PythonDictionary) { dictIterator = PythonOps.Invoke(context, self, <span class="hljs-string"><span class="hljs-string">"iteritems"</span></span>, ArrayUtils.EmptyObjects); } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0381/">warning</a> : <a href="http://www.viva64.com/ru/d/0381/">V3001</a> There are no sub-expressions.  operator.  IronPython ObjectOps.cs 452 <br><br>  <b>Example 3. Identical expressions.</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> override MSAst.<span class="hljs-function"><span class="hljs-function">Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitTry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( MSAst.TryExpression node)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newHandlers != null || newFinally != null) { node = Ast.MakeTry(node.Type, node.Body, newFinally != null ? newFinally : node.Finally, node.Fault, newHandlers != null ? newHandlers : newHandlers ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0383/">warning</a> : <a href="http://www.viva64.com/ru/d/0383/">V3012</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: newHandlers.  DebugInfoRewriter.cs 252 <br><br>  Here newHandlers is used in both branches of the conditional expression.  It was supposed to use node.Handlers in case newHandlers is null. <br><br>  <b>Examples 4 and 5. Inattention.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RubyContext</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> context, object</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> self, object value)</span></span></span><span class="hljs-function"> </span></span>{ var strValue = value as MutableString; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } var clrStrValue = strValue.ConvertToString(); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0388/">warning</a> : <a href="http://www.viva64.com/ru/d/0388/">V3019</a> Possibly an incorrect variable is compared to null after type conversion using 'as' keyword.  Check variables 'value', 'strValue'.  EnvironmentSingletonOps.cs 189 <br><br>  This is a fairly common mistake when, due to carelessness after type casting, using the 'as' operator, the result is not checked for null, but the original object, and then use an unchecked reference. <br><br>  Here is another similar case: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RubyRegex<span class="hljs-comment"><span class="hljs-comment">/*!*/</span></span> ConstructRubyRegexp( RubyConstructor<span class="hljs-comment"><span class="hljs-comment">/*!*/</span></span> ctor, Node<span class="hljs-comment"><span class="hljs-comment">/*!*/</span></span> node) { ScalarNode scalar = node as ScalarNode; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> RubyExceptions.CreateTypeError( <span class="hljs-string"><span class="hljs-string">"Can only create regex from scalar node"</span></span>); } Match match = _regexPattern.Match(scalar.Value); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0388/">warning</a> : <a href="http://www.viva64.com/ru/d/0388/">V3019</a> Possibly an incorrect variable is compared to null after type conversion using 'as' keyword.  Check variables 'node', 'scalar'.  RubyConstructor.cs 230 <br><br>  <b>Example 6. Copy-Paste.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadNewObj</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CodeContext</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> context)</span></span></span><span class="hljs-function"> </span></span>{ PythonTuple args = PopStack() as PythonTuple; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> PythonOps.TypeError(<span class="hljs-string"><span class="hljs-string">"expected second argument, got {0}"</span></span>, DynamicHelpers.GetPythonType(args)); } PythonType cls = PopStack() as PythonType; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> PythonOps.TypeError(<span class="hljs-string"><span class="hljs-string">"expected first argument, got {0}"</span></span>, DynamicHelpers.GetPythonType(args)); } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0390/">warning</a> : <a href="http://www.viva64.com/ru/d/0390/">V3021</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  This means that the statement is senseless.  cPickle.cs 2194 <br><br>  In the above code snippet, the two conditions and the calls to the GetPythonType () function are exactly the same.  Obviously, the second condition was obtained by copying the first one, but the author forgot to change the variable name.  There are a couple of similar situations in the project. <br><br>  <b>Example 7. Same conditions.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceLocation left, SourceLocation right)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left &lt; right) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (right &gt; left) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0390/">warning</a> : <a href="http://www.viva64.com/ru/d/0390/">V3021</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains method return.  This means that the statement is senseless.  SourceLocation.cs 156 <br><br>  This method is quite simple, and it seems that there is nowhere to be mistaken.  Nevertheless, in the second condition, the parameters left and right were swapped for some reason, as a result of which both conditions checked the same thing that the analyzer found. <br><br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceLocation left, SourceLocation right)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left &lt; right) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (left &gt; right) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  <b>Example 8. Excess condition.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteSingleQuoted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> split)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ending &lt;= text.Length) { c = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ending &lt; text.Length) { c = text[ending]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spaces) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0</span></span> || c != <span class="hljs-number"><span class="hljs-number">32</span></span>) { .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0411/">warning</a> : <a href="http://www.viva64.com/ru/d/0411/">V3023</a> Consider inspecting the 'c == 0 ||  c! = 32 'expression.  The expression is misprint.  Emitter.cs 308 <br><br>  First, the variable 'c' is assigned the default value - '\ 0'.  Then, if you have not yet processed the entire string, 'c' gets the value of the next character.  And at the end it is checked whether the default value in the 'c' variable remains or whether something is counted there but a space.  In fact, a comparison with zero here is superfluous, since zero is already different from 32 (space code).  This code does not lead to errors, but makes understanding difficult, so a comparison with zero can be thrown out.  The analyzer found some more similar unnecessary checks in this project. <br><br>  <b>Examples 9 and 10. Incorrect format string.</b> <br><br>  A common problem with the use of the String.Format function is that the number and numbers of the format string parameters are not checked by the compiler against the number of parameters passed to String.Format.  As a result, an incorrect string may be generated, or a FormatException exception will be thrown.  Consider the examples. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Current { get { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T)enumerable.Current; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidCastException iex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidCastException(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">"Error in IEnumeratorOfTWrapper.Current. Could not cast: {0} in {0}"</span></span>, typeof(T).ToString(), enumerable.Current.GetType().ToString()), iex); } } }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0392/">warning</a> : <a href="http://www.viva64.com/ru/d/0392/">V3025</a> Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Expected: 1. Present: 2. ConversionWrappers.cs 235 <br><br>  In this example, the last parameter is not used, but instead the typeof (T) .ToString () value will be printed twice. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DumpGenericParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( MetadataTableView genericParams, MetadataRecord owner)</span></span></span><span class="hljs-function"> </span></span>{ foreach (GenericParamDef gp in genericParams) { _output.WriteLine(<span class="hljs-string"><span class="hljs-string">" generic parameter #{0}: {1}"</span></span>, gp.Index, gp.Name, gp.Attributes); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0392/">warning</a> : <a href="http://www.viva64.com/ru/d/0392/">V3025</a> Incorrect format.  A different number of items is expected while calling the 'WriteLine' function.  Expected: 2. Present: 3. Program.cs 268 <br><br>  And in this code snippet, the WriteLine function is passed one more parameter than the format string requires. <br><br>  <b>Example 11. Check for null after access.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MutableString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChompInPlace</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ MutableString result = InternalChomp(self, separator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Equals(self) || result == null) { self.RequireNotFrozen(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0414/">warning</a> : <a href="http://www.viva64.com/ru/d/0414/">V3027</a> The variable "result" was used.  MutableStringOps.cs 1097 <br><br>  In this condition, you should swap the check for null and call the Equals method.  In this form, the application can now fall with a NullReferenceException. <br><br>  <b>Example 12. Problems with synchronization.</b> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictThreadGlobalState</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DoneCount; .... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunThreadTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DictThreadGlobalState globalState)</span></span></span><span class="hljs-function"> </span></span>{ .... globalState.DoneEvent.Reset(); globalState.Event.Set(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (globalState.DoneCount != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// wait for threads to get back to finish } .... }</span></span></code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0419/">warning</a> : <a href="http://www.viva64.com/ru/d/0419/">V3032</a> Waiting on this expression is unreliable, as the compiler may optimize some of the variables.  Use volatile variable (s) or synchronization primitives to avoid this.  EngineTest.cs 2558 <br><br>  This code contains an error, which may not always manifest itself, but depending on the runtime environment, the version of the .NET Framework, the number of processors in the system, or even some implementation details.  Such errors can be very difficult to catch.  The reason is that the DoneCount variable is not declared as volatile, and if so, the compiler believes that it is used only by one thread, and its value can, for example, be cached and returned all the time from the cache, since within the loop this variable does not change .  But in our case, its value changes in another thread, so in such cases, when a variable is used to synchronize threads, it must be declared as volatile.  Read more about this in <a href="https://msdn.microsoft.com/en-us/library/x13ttww7.aspx">MSDN</a> . <br><br>  <b>Example 13. Dual Assignment</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, EncodingInfoWrapper&gt; MakeCodecsDict() { .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (normalizedName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"iso_8859_1"</span></span>: d[<span class="hljs-string"><span class="hljs-string">"8859"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"latin_1"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"latin1"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"iso 8859_1"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"iso8859_1"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"cp819"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"819"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"latin"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"latin1"</span></span>] = d[<span class="hljs-string"><span class="hljs-string">"l1"</span></span>] = encs[i]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0403/">warning</a> : <a href="http://www.viva64.com/ru/d/0403/">V3005</a> The 'd ["latin1"]' variable is assigned to itself.  StringOps.cs 1905 <br><br>  In this code, the value is assigned twice to the variable d ["latin1"].  Most likely, this is just an extra code, not an error.  But maybe they forgot about some code page.  Anyway worth a look. <br><br>  <b>Example 14. Comparing unsigned variable with zero</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __hash__(UInt64 x) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> total = unchecked((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (((uint)x) + (uint)(x &gt;&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unchecked(-total); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> total; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0391/">warning</a> : <a href="http://www.viva64.com/ru/d/0391/">V3022</a> Expression 'x &lt;0' is always false.  Unsigned type value is always&gt; = 0. IntOps.Generated.cs 1967 <br><br>  Probably, it was necessary to compare 'total' with zero, not 'x', because it is strange to always perform some actions with 'x', and then check the particular case.  Yes, and 'total' has a signed type, so comparing ‚Äútotal &lt;0‚Äù looks more logical. <br><br>  <b>Example 15. Identical checks.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectTypes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type[]</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*!*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> allTypes)</span></span></span><span class="hljs-function"> </span></span>{ .... def.Super = null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cls != null &amp;&amp; def.Extends != typeof(BasicObject) &amp;&amp; !def.Extends.IsInterface) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cls != null &amp;&amp; cls.Inherits != null) { def.Super = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeRef(cls.Inherits); .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0415/">warning</a> : <a href="http://www.viva64.com/ru/d/0415/">V3030</a> Recurring check.  The 'cls! = Null' condition was already verified in line 373. LibraryDef.cs 374 <br><br>  Here, in both conditions, the variable 'cls' is checked for null.  Most likely, the author wanted to check 'def' for null in the first condition, since there he immediately accesses his Extends property.  But doing this would also be unnecessary, because null is written right in front of the condition in 'def.Super', which means that 'def' is no longer null.  In general, this is just an extra check. <br><br>  <b>Example 16. Copy-paste.</b> <br><br>  I got to the third level errors, of which only 280 pieces.  Of these, the overwhelming majority are warnings that the bodies of the two functions are the same, and warnings about the comparison of floating point numbers.  I did not think that I could find something serious here, so I began to skim through the errors, and nevertheless I found it. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsPositiveOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BigDecimal x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsOne(x) &amp;&amp; IsPositive(x); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNegativeOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BigDecimal x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsOne(x) &amp;&amp; IsPositive(x); }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0389/">warning</a> : <a href="http://www.viva64.com/ru/d/0389/">V3013</a> It‚Äôs odd that the body of the body is 'IsPositiveOne' function is fully equivalent to the body of the 'IsNegativeOne' function (351, line 355).  BigDecimal.cs 351 <br><br>  This is really a real mistake, which is the result of copying code from one function to another.  The correct code should be: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNegativeOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BigDecimal x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsOne(x) &amp;&amp; IsNegative(x); }</code> </pre> <br>  <b>Example 17 Strange NaN test.</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !Single.IsNaN(x); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x == y; }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0412/">warning</a> : <a href="http://www.viva64.com/ru/d/0412/">V3024</a> An odd precise comparison: x == y.  Consider using a precision with a precision: Math.Abs ‚Äã‚Äã(A - B) &lt;Epsilon.  FloatOps.cs 1048 <br><br>  I did not understand what is the meaning of a special test on NaN.  If the condition (x == y) is met, then this means that both 'x' and 'y' are different from NaN, because NaN is not equal to any other value, including itself.  That is, the first return will always return true.  It seems that checking for NaN is just superfluous. <br><br><h2>  Conclusion </h2><br>  According to the results of the verification of the project, I was pleased with the work of the analyzer, because, first, he found a couple of dozen real errors, after correcting which, the project code will become better.  And secondly, I identified several false positives that can be eliminated, thereby improving our product at the same time.  Therefore, I recommend everyone to download the demo version of PVS-Studio and check its code. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0367/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Ilya Ivanov.  <a href="http://www.viva64.com/en/b/0367/">Analyzing IronPython and IronRuby with PVS-Studio</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2016</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/274863/">https://habr.com/ru/post/274863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274851/index.html">Mikhail Romanovich Shura-Bura - the patriarch of domestic programming and its development</a></li>
<li><a href="../274853/index.html">Community DevCamp reports are available.</a></li>
<li><a href="../274855/index.html">Dangerous video: how I found a vulnerability in video hosting and did not die after 7 days</a></li>
<li><a href="../274857/index.html">New in Wolfram Language | Analytical solution of partial differential equations</a></li>
<li><a href="../274859/index.html">Implementing a list of used libraries using DialogFragment in Android application</a></li>
<li><a href="../274865/index.html">Sir Charles Anthony Richard Hoare or just Dad Quicksort, NULL and Problems of Dining Philosophers</a></li>
<li><a href="../274867/index.html">As I wrote the web app angular + material and REST on Yii2 + webserver nginx</a></li>
<li><a href="../274871/index.html">Linus Torvalds announced the release of the Linux 4.4 LTS kernel (Long-Term Support)</a></li>
<li><a href="../274873/index.html">Static, Aggregate and Generate routes at JunOS</a></li>
<li><a href="../274875/index.html">Debugging Groovy scripts with Grape based on maven aether</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>