<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Three eyes hang on a pole, or the tale that ATtiny13 has five legs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="KDPV "Oh, everything." 


 There is little chance that this longrid will become a life-giving source of wisdom to intellectuals, tempted in the secret...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Three eyes hang on a pole, or the tale that ATtiny13 has five legs</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/51/tw/-p/51tw-pewtw_nf5txookeohz5qga.jpeg"><br>  <em>KDPV "Oh, everything."</em> </p><br><p>  There is little chance that this longrid will become a life-giving source of wisdom to intellectuals, tempted in the secrets of fortune-telling on Carnot cards, and who have learned the hidden meaning of the Third Normal Form.  But if for some reason you touched the arduino with your hands, a soldering iron gathers dust in the pantry, you understand why the battery has one plus, and C ++ has two, then truly magical and amazing wonders will not leave you indifferent.  So, I have the pleasure of recommending to you the numbers of today's presentation of the traveling circus <abbr title="these are not artists' names, adobe - bricks made of twigs, clay and other things, but boxwood is a breed of precious tree.">"Saman with Boxwood"</abbr> : </p><br><ul><li>  Adding RAM and ROM to ATtiny13! </li><li>  Artificial intelligence in the microprocessor - pro and contra, or sleeping beauty - well, is she not a fool? </li><li>  Or all the same dura lex sed lex? </li><li>  How to add legs in ATtiny13? </li><li>  A few words about the fifth dimension: how to cram in nevpihuemoe? </li><li>  Sawing in half non-devistenits with mixing the contents of the halves (with a guarantee of recovery). </li><li>  Room ‚ÄúFeeding the afflicted‚Äù (see earlier case of saturation of five thousand people with five barley loaves and two fish). </li></ul><br><p>  If at least one of the tricks is useful in the future to every twentieth reader, I will be satisfied, the article was written not in vain. </p><a name="habracut"></a><br><h2 id="svetofor-pervyy-ili-kaa-prinimaet-boy">  Traffic light first or Kaa takes the fight. </h2><br><p>  The story began, as in the classic pre-Christmas video entry, when the camera peeks through a frosty window into a small cozy room: a Christmas tree in tinsel, cotton and toys, the smell of tangerine and mulled wine, a warm shake of the shadows from a candlelight.  On a large couch, She straightens the rug and gently presses her cheek against His shoulder, absently listening to enthusiastically gesturing angelic little girl ... </p><br><p>  Those who have parental experience are well aware that at such a moment one can hear.  I will explain to those who have not yet acquired such a skill - with a high degree of probability, parents are now dumbfounded with something like: ‚ÄúDad!  Us tomorrow!  In kindergarten!  It is necessary!  Bring crafts to the contest of Christmas tree toys!  And I want first place! ‚Äù. </p><br><p>  It is necessary.  Tomorrow.  Us.  Under the tree.  The best. </p><br><p>  The interview with the Customer involved shows the outlines of the TK: we need a traffic light.  And so beautiful and glowing, like a real one.  Already at this stage, the ranks of candidates in the project's GUI are dramatically thinning: the pope fails to substantiate the idea that the charming, soft, stitched from shreds or knitted or crocheted traffic light is an embodiment of the Customer‚Äôs dream: the traffic light should be lit - what is there to understand? </p><br><p>  Night rolled over the country, and our work began to boil. </p><br><p> The material of the traffic light body is a toilet paper sleeve compressed so as to form a parallelepiped.  The ten-ruble coin was encircled with a pencil, and then the holes for the lights of the signal light were cut out with a stationery knife (traumatic work is not trusted to children). </p><br><p><img src="https://habrastorage.org/webt/op/0f/az/op0fazb4pjg1z5mtam3hvudxve4.jpeg"></p><br><p>  The top and bottom covers of the traffic lights are cut out of cardboard in place.  Visors above the lamps on the made pattern were outlined on ordinary 80 gram paper and cut by hand. </p><br><p><img src="https://habrastorage.org/webt/rm/ga/5u/rmga5uloolpi1di2umlqxn9lzmw.jpeg"></p><br><p>  Then they were glued to the PVA. </p><br><p><img src="https://habrastorage.org/webt/9x/ql/ff/9xqlfftsq_fphcorsj7nimjlqo8.jpeg"></p><br><p>  The assembled constructions were pulled out into the courtyard and painted with spray acrylic paints: generously silver, after slightly black on top. </p><br><p><img src="https://habrastorage.org/webt/hh/bm/ha/hhbmhaz7bod1ntgplrtyfeu3bgq.jpeg"></p><br><p>  In case of damage at any stage, three copies were made at once.  Light filters inside the most successful pasted three strips of colored paper - red, yellow and green. </p><br><p>  It was decided to illuminate from the inside with a pair of superbright white LEDs from the generous bins of the motherland (SchZR).  The cadets' toad flatly refused to give the Pope three more lithium tablet batteries from the presence of the SCHR, and the LEDs did not agree to light up one, stating that they were white and bright, and the voltage drop on them was from 2.8 to 3.9 volts.  The maximum that was managed to bargain with the toad was for one AA battery, a ferrite ring from the choke of a burnt-out motherboard and the KT315 transistor.  After thinking and googling, Dad had to accept the offer.  And considering the number of playful pens in each group of the kindergarten, the idea with lithium batteries didn‚Äôt look particularly attractive. </p><br><p>  The corpus of traffic lights on the battery with a tough smell of paint displaced the aromas of pine needles and tangerines, the father thoughtfully poked a soldering iron into the rosin, the children wound transformers for the blocking generators (duplication of copies), everything went according to plan ... </p><br><p>  And no, "and all of a sudden" that evening did not happen: all the tricks when winding a transformer - immediately wind the maximum possible number of turns with folded wire.  Do not confuse the anode and cathode of the LED, and the leads of the KT315 transistor and correctly connect the ends of the windings (or swap them if not lit) according to the circuit diagram.  J1 - power switch from a computer jumper, derived later "on the roof" of a traffic light. </p><br><p>  A completely simple scheme for producing alternating voltages with peaks of 3-7V from 1.5V of a G1 battery has long been <a href="https://www.google.com/search%3Fq%3D%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B8%25D0%25BD%25D0%25B3-%25D0%25B3%25D0%25B5%25D0%25BD%25D0%25B5%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%2B%25D0%25B4%25D0%25BB%25D1%258F%2B%25D0%25B1%25D0%25B5%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25BE%2B%25D1%2581%25D0%25B2%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4%25D0%25B8%25D0%25BE%25D0%25B4%25D0%25B0%26tbm%3Disch">widely known</a> . </p><br><p><img src="https://habrastorage.org/webt/fx/on/h5/fxonh57exbpayjclrpo3k05sazg.png"></p><br><p>  Physically, the concept was embodied like this: </p><br><p><img src="https://habrastorage.org/webt/tt/aq/4u/ttaq4unttq55rdeg-f0tr0ti3zq.png"></p><br><p>  In the red tape - alkaline AA battery. </p><br><p>  And the traffic light assembly - that's it. </p><br><p><img src="https://habrastorage.org/webt/2s/5w/dd/2s5wddfdxjkcl34w1mgj_neduyg.jpeg"></p><br><p>  In the morning, the proud child dragged the product to the kindergarten, where the toy created a sensation and took center stage on the Christmas tree. </p><br><p><img src="https://habrastorage.org/webt/zz/fy/yc/zzfyyckk-i-jdncvaangd1cee8u.jpeg"></p><br><p>  With the first place in the competition, however, did not work out - the deadline for submission of entries, as it turned out, several days had passed. </p><br><p>  The houses remained two buildings on the windowsill and daddy's itchy dissatisfaction with the task ‚ÄúI want like a real traffic light.‚Äù  And the thought was spinning, ‚Äúis it possible to fit the complete solution, say in the 13th tinkle, that the toad in <abbr title="Generous bins of the motherland, or, in the words of his wife, plushkin stocks.">the SCHZR has</abbr> been lying <abbr title="Generous bins of the motherland, or, in the words of his wife, plushkin stocks.">around for a</abbr> long time? Will there be enough five legs, a kilobyte for the code and 64 bytes of RAM, and that, as ordered, like a real one‚Äù? </p><br><p>  So all this was just a saying, a tale about the final solution of the traffic light issue ahead. </p><br><h2 id="svetofor-vtoroy-kak-nastoyaschiy">  Traffic light second, like a real </h2><br><h3 id="ispolzuemyy-instrumentariy-materialy-i-dokumentaciya">  Used tools, materials and documentation </h3><br><p>  <em>Language / Framework</em> : C / Arduino 1.6 / 1.8. <br>  <em>IDE</em> : MS Visual Studio 2012 + Visual Micro plugin + git. <br>  <em>CAD</em> : DipTrace. <br>  <em>HW</em> : MK ATtiny13, Arduino Nano Clone on ATmega328, USB-UART on FT232R, china-noname USBISP programmer. <br>  <em><abbr title="PCB board.">PP</abbr> technology</em> : <abbr title="Laser-Iron Technology.">LUT</abbr> . <br>  <em>Tools</em> : Soldering iron, glue gun, kitchen oven, knife, scissors, cutting pliers. <br>  <em>Materials</em> : From <abbr title="The storage of electronic components with difficult fate - vypayannyh, used, once bought on Aliexpress, etc.">‚ÄúSCHZR‚Äù</abbr> - 4 noname red, yellow, green output LEDs, SMD tantalum capacitor and a pair of resistors 0805 through 10k, half a dozen output 0.25W current limiting resistors MF-25, Chinese boost DC-DC 5V converter, aerosol cans with silver and black paint, A4 paper, polymer clay with a sale. </p><br><p>  <em>Sources and documents are available on <a href="https://github.com/lugovskovp/TrafficLight13">Github</a> under the MIT license, source code commits coincide with the firmware iterations described below, all mentioned paths to files are relative to the repository root.</em> </p><br><p>  <em>Documentation</em> : <br>  ./docs/ATtiny13A datasheet.pdf [Specification for Atmel ATtiny13A MK] <br>  ./docs/ATmega328 datasheet.pdf [Specification for Atmel ATmega328 MC] <br>  ./docs/AVR4027 - Tips and Tricks to Optimize Your C Code for AVR Microcontrollers] <br>  ./docs/AVR4013 - PicoPower basics.pdf [Notes on Energy Saving Modes] </p><br><p>  From the Arduino <abbr title="English Integrated Development Environment, integrated development environment">IDE</abbr> , like a blanket from a cloud.  Their wizard is a Jesuit subtle mockery of everything that can be held by embed programmers.  But Arduino, as an ecosystem, lived, lives and will live, and because of the ease of installing the environment on computers under different operating systems, and because they were the first to give the opportunity, without much expense to the hardwired programmer-debugger, using the cheap UART and proprietary bootloader development in a fairly serious stuffing MK.  And then there's Uncle Liao, ready to sell a fistful of clones for the price of one original.  The fact that in the senior atmega you can debug the logic and the work of the program, and then with minimal changes to transfer to the same tyinki - this is also an Argument. </p><br><p>  I am accustomed to working comfortably in <a href="http://visualstudioshortcuts.com/2012/">MS VisualStudio</a> , there is no extra space for AtmelStudio or WinAVR and I don‚Äôt want to search, they don‚Äôt carry the ultimate amenities without a <a href="https://www.microchip.com/Developmenttools/ProductDetails/ATAVRDRAGON">hardware debugger</a> .  About the VisualMicro plugin, which adds support for Arduino in MS VisualStudio <a href="https://habr.com/ru/post/216029/">, it was already</a> quite detailed and well-written on Habr√©. <br>  Focus "Arduino on ATtiny13" on Habr√© was also <a href="https://habr.com/ru/post/234477/">considered a</a> long time and <a href="https://habr.com/ru/post/245429/">repeatedly</a> . </p><br><p>  In short, in the installed installation of the Arduino environment, add the <a href="https://github.com/MCUdude/MicroCore">MicroCore</a> module, after which it becomes possible to select the ATKinyK MK target cards. </p><br><p><img src="https://habrastorage.org/webt/9f/rm/fe/9frmfek8wvpfsphvtyhedqiiuoy.png"></p><br><p>  Git - no alternative for any, even the most domestic projects.  The habit is simple but correct: when starting work on any program, just type "git init" in the directory on the command line.  The support of comets in the local repository built into MS Visual Studio will save time and nerves more than once. </p><br><p>  DipTrace, as CAD for circuitry and PCB - convenient, domestic, schematics and wiring is user-friendly, easy to add custom components (CVD, contacts), if desired, the PCB with components can be twisted in 3D, high-quality help and tutorials in the kit.  In addition, I am impressed by their licensing policy: the restrictions of the Non-profit standard license free for Russia, Ukraine, and the Republic of Belarus (1000 pins, 4 signal layers) are enough for home crafts in 99% of cases. </p><br><p>  I didn‚Äôt manage to get Arduino Nano to make money normally, like a programmer for tinky, but if there is a USB ISP programmer, the problem can be solved easily.  Quickly sketched command files for compilation / firmware - in the ./gcc directory in the project. </p><br><p>  The .ino file (and actually it is C / C ++) is unmistakably compiled in the studio "under arduino under ATtiny13", simply served by the parameter of this batch file on the command line: </p><br><pre><code class="plaintext hljs">&gt;"./gcc/0_MAKE &amp; upload.cmd" MyArduinoFile.ino</code> </pre> <br><p>  If at this moment an ISP programmer is plugged in, and the MK is attached to it, then both compilation and firmware will run. </p><br><pre> <code class="plaintext hljs">&gt;"./gcc/0_MAKE &amp; asm.cmd" MyArduinoFile.ino</code> </pre> <br><p>  As the name implies, having compiled it will create an assembler listing of the firmware ‚Äî it can be very useful, even if the <a href="http://www.gaw.ru/html.cgi/txt/doc/micros/avr/asm/start.htm">assembler for AVR is</a> not the strongest <a href="http://microsin.net/programming/AVR/avr-gcc-memory-sections.html">side of the</a> skills.  <strong>Important</strong> : <em>If you want to use command files, you will need to change inside the path, they are absolute</em> . </p><br><h3 id="dusha-svetofora">  Soul traffic light </h3><br><h4 id="upgrade-romram-pod-arduino-dlya-attiny13">  Upgrade ROM &amp; RAM for Arduino for ATtiny13 </h4><br><p>  The skeleton of the Arduino programs (sequentially setup () {...}; loop () {...};) invisibly for the arduinschik when compiled actually "wraps" into the classic C-shnu int main () {setup ();  loop ();}, <em>slightly gaining</em> weight due to overhead by Arduino. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> cnt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ cnt=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ cnt++; } <span class="hljs-comment"><span class="hljs-comment">//Program size: 164 bytes (used 16% of a 1 024 byte maximum) (0,57 secs) //Minimum Memory Usage: 5 bytes (8% of a 64 byte maximum)</span></span></code> </pre> <br><p>  Actually the exact same thing, but without calling functions on a simple C: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> cnt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ cnt=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt; setup() while(1){ cnt++; // &lt; loop() } } //Program size: 60 bytes (used 6% of a 1 024 byte maximum) (1,23 secs) //Minimum Memory Usage: 1 bytes (2% of a 64 byte maximum)</span></span></code> </pre> <br><p>  In addition to reducing from 16% to 6% of the required program memory, note that 6% of free random access memory for variables was added.  And still, the call of any function until its completion invisibly consumes memory at least at the return address in the stack, and the stack is also part of the 64 byte of the physical physically present. </p><br><h4 id="intellekt-spyaschey-krasavicy">  Sleeping Beauty Intellect </h4><br><p>  Obligatory sign of intelligence, of course, is laziness: a rational being will not begin to perform useless work.  A non-intelligent processor will scroll through an infinite loop over and over again, it is useless to convert energy into heat, and only occasionally, when the external conditions change, do the work of changing the state.  A smarter processor, in contrast, only works when external conditions have changed.  In order to improve the integration index of the mind on the planet Dirt, we transfer the tinsel to the next stage of intellectual development: our <abbr title="central processing unit = Arithmetic logic unit + general purpose registers and commands + command counter + RAM">CPU</abbr> will sleep most of the time, waking up and working only when necessary.  His job is to increment a global variable that stores a time value every N time units.  During sleep without the participation of the ‚Äúbrain‚Äù -CPU, the timer will continue to operate, increasing in sleep by one every (9.6 MHz cycles per second / divider value of the timer 1024 = 9370 Hz, so many times per second the timer is incremented) 1/9370 = 0.0001067 seconds .  But the CPU will wake up only when the 8-bit timer overflows.  And having woken up, first of all it is thrown, as at night, into the toilet, into the procedure of handling the "timer overflow" event.  And after that, he will run on the program further, starting from the place where he fell asleep, until he reaches the place in an endless loop with the "sleep" command.  He will have such awakenings 37 times in a second (256 x 0.0001067 = 0.027315; 0.027315 x 37 = 1.01065 ~ = 1s). </p><br><p>  Program skeleton change: we set the clocking and the timer-counter divider (HW block, incrementing its value every 1024 cycles), when 8 bits overflow this counter, the overflow interrupt handler is started, then control is transferred to the next line of the program after the one in which it fell asleep. </p><br><p>  <strong>Important</strong> : the <em>globalTimer variable is defined as volatile, which means that it changes at a completely unpredictable and unknown time, as a result, before any use of it, the CPU must first read its current value from memory, even if the actions with it were in the previous line of the program</em> . </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt; //     IDE -   #include &lt;avr/sleep.h&gt; // ,   #include &lt;avr/interrupt.h&gt; //    volatile uint16_t globalTimer; //     64    //  -    globalTimer  1/37  ISR(TIM0_OVF_vect){ globalTimer++; //       . , ,  while(1)   . } int main() { //     "  -". set_sleep_mode(SLEEP_MODE_IDLE); //   - . sleep_enable(); //     TCCR0B = _BV(CS02) | _BV(CS00); //  0 - clock frequency / 1024 TIMSK0 |= _BV(TOIE0); //      overflow interrupt sei(); //     while(1){ //.........    sleep_cpu(); //     -   . } } //Program size: 128 bytes (used 13% of a 1 024 byte maximum) (0,86 secs) //Minimum Memory Usage: 2 bytes (3% of a 64 byte maximum)</span></span></span></span></code> </pre> <br><h4 id="u-koshki-4-nogi-vhod-vyhod-zemlya-i-pitanies-zhalostlivaya-studencheskaya-pesnya">  "The cat has 4 legs: entrance, exit, earth and food" (c) pitiful student song </h4><br><p>  A small digression explaining what strange abbreviations appeared in the listing. <br>  In microprocessors, the control of <a href="http://easyelectronics.ru/avr-uchebnyj-kurs-arxitektura.html">peripheral blocks</a> , in the same way as the CPU control, is done by writing / reading values ‚Äã‚Äãto / from certain addresses of the memory space.  Using the example of a <abbr title="General-Purpose Input / Output, General Purpose Input / Output (I / O) Port">GPIO</abbr> peripheral module. </p><br><p>  The signal level and type of foot in the Arduino are very easy to set: first, for the Arduino board pin pin number we turn on the input mode (or output): </p><br><pre> <code class="cpp hljs">pinMode(pin_number, OUTPUT); <span class="hljs-comment"><span class="hljs-comment">//   INPUT -   </span></span></code> </pre> <br><p>  And then either expose the high / low value on the leg to exit, or read - what voltage comes to foot for entry. </p><br><pre> <code class="cpp hljs">Value = digitalRead(pin_input_number); <span class="hljs-comment"><span class="hljs-comment">//Value -  HIGH  LOW (1  0) digitalWrite(pin_outpit_number, Value); //   pin_outpit_number - HIGH  LOW</span></span></code> </pre> <br><p>  To "simplify" the lives of users, the creators of the Wiring language went for some substitution using numbers printed on the Arduino board (white on the board or in pale fuchsia rectangles) instead of the foot numbers of the microcircuit (white on gray) or port accessories numbers (black on yellow ) (which is more logical and correct). </p><br><p><img src="https://habrastorage.org/webt/fp/di/ni/fpdiniruiiujuodrtyzrcfyljr8.png"></p><br><p>  So  the pin number of the Arduino 7 is equivalent to the pin number 11 or PD7 - the seventh bit of port D. <br>  All the constructions of digitalRead, digitalWrite, pinMode, etc., all the same, when compiling, come to the installation of operating modes and values ‚Äã‚Äãin numbering close to the processor, alas, adding to each Wiring-function just an awesome bunch of additional actions, making the code harder and slow down the work order. </p><br><p>  Management of leg states - it is even easier than what arduin teaches us.  Better than <a href="https://habr.com/ru/users/dihalt/" class="user_link">DIHALT</a> <a href="http://easyelectronics.ru/avr-uchebnyj-kurs-ustrojstvo-i-rabota-portov-vvoda-vyvoda.html">to explain the</a> modes of operation and the installation of ports, I‚Äôm unlikely to succeed. </p><br><p><img src="https://habrastorage.org/webt/rk/y8/sj/rky8sjzln3u1k3lndv0inksdxjm.jpeg"></p><br><p>  From inside the processor, general purpose input / output ( <abbr title="General Purpose I / O Ports">GPIO</abbr> ) legs are seen grouped by logical ports, for 8-bit processors - a maximum of 8 legs per port.  In a low-legged pairing, it is not enough that only 6 legs can be physically involved (Fig. ATtiny13 pinout, white on green), from PB0 to PB6, and also using PB6 - the possibility of programming MK without a special high-voltage programmer disappears.  Any general-purpose I / O port is controlled by three registers: (for example, a port with the name "B") <abbr title="Data Direction Register B, direction register - input or output">DDRB</abbr> , <abbr title="Port B Input Pins Register, physical value of level 0 or 1 on legs, read only">PINB</abbr> and <abbr title="Port B Data Register, setting the logical level of the values ‚Äã‚Äãon the legs">PORTB</abbr> .  The I / O Control Register is a memory cell with which you can assign values ‚Äã‚Äãor read them.  Legend PB0, PB1, PB2, PB3, PB4, PB5 - matching the legs to the bytes of the ports in the port registers B. When added to the beginning of the program, include #include &lt;avr / io.h&gt; (or even iotn13.h for tyinki), these definitions will get the numbers bits (PB0 will be 0, ..., PB5 - 5) in bytes of register values ‚Äã‚Äãin the IDE, and it will be possible to compile without involving the Arduino framework. </p><br><p>  <strong>Important</strong> : <em>if the program does not access the peripherals registers, this is the same as writing zero values ‚Äã‚Äãto these registers.</em>  <em>As a rule, the default values ‚Äã‚Äãleave the peripherals block in the off state, but, for example, the zeros in the DDRx GPIO determine that the legs are inputs.</em>  <em>And at the same time, zero in PORTx - the internal tightening is NOT included, the potential is ‚Äúsomewhere between zero and one‚Äù, the legs are sensitive to which direction they will bow - up or down, what to write in PINx.</em>  <em>The electromagnetic field from the wiring is enough for them to change the state between 0 and 1 50 times a second. And the processor will spend electricity for each switch, meaningless and not obvious to a programmer</em> . </p><br><div class="spoiler">  <b class="spoiler_title">Let, for example</b> <div class="spoiler_text"><p>  on PB2 I want to bring HIGH, + 5V, on PB3, LOW, 0V, and from PB0 on ‚Äã‚Äãthe contrary, read what is the logical voltage level on it. <br>  DDRB assign the value of the number for which the PB0 bit, the number zero (leftmost) = 0 (PB0 is defined as an input), the second and third bits = 1 (PB2, PB3 - outputs), i.e.  in the binary notation, the number xxxx11x0, where x is anything, even 1, at least 0, is not specified in the conditions. </p><br><pre> <code class="cpp hljs">DDRB = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  000001100    - 12 //        (!) //        pinMode().</span></span></code> </pre> <br><p>  To set the setpoints on the pins - assign the PORTB number, whose second bit = 1 (PB2 to HIGH), and the third to zero (PB3 to LOW), the rest is not important, xxxxx01xx </p><br><pre> <code class="cpp hljs">PORTB = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-comment"><span class="hljs-comment">//(dec)8 === (bin)000001000 //  -        .</span></span></code> </pre> <br><p>  To read the level from the legs, the port has the third and last control register of PINB, there is a number in it, the values ‚Äã‚Äãof which bits are the logical voltage levels of the corresponding legs. <br>  Everything would be fine, but converting from binary numbers to decimal and back is some confusion. <br>  How to set bit number 3 (PB3) to one: just put 1 at zero, and move it 3 times to the left. <br>  3 &lt;&lt; 00000001 === PB3 &lt;&lt; 1 // Result - 00001000 <br>  For a very easy life, there is a macro, _BV (x), which when compiled is replaced by (x &lt;&lt; 1), so  _BV (PB3) - sets the third bit to 1. <br>  Recording _BV (PB3) |  _BV (PB2) at compilation will turn into the number 00001100 (| - logical bitwise OR). <br>  <strong>Important</strong> : the <em>macro expands to a number already at compilation, there will be no bit actions in the firmware, but the resulting constant will be used</em> . </p><br><pre> <code class="cpp hljs">PORTB |= _BV(PB3) | _BV(PB2); <span class="hljs-comment"><span class="hljs-comment">// 2  3   == 1,     PB2  PB3  HIGH,   PORTB  </span></span></code> </pre> <br><p>  For setting 0, the logical OR will not work, so just move the unit to the right place in the byte, and then invert the byte.  The resulting value will have 0 at the required place and 1 at the rest.  Adding according to the logical AND with the register value, those bits, where 1 of the current register values ‚Äã‚Äãwill not change, and where 0 - the corresponding ones will be reset to 0. </p><br><pre> <code class="cpp hljs">PORTB &amp;= ~(_BV(PB3) | _BV(PB2)); <span class="hljs-comment"><span class="hljs-comment">//   PORTB 2  3  -  , LOW,   .</span></span></code> </pre> </div></div><br><p>  In the listing above, another HW block is initialized, timer-counter 0, Timer0.  It is more complicated than GPIO, it is controlled not by three, but by seven registers, their values ‚Äã‚Äãare described in detail in datasheet ATtiny13, if someone wants to read more in Russian, you can see the bit assignments in <abbr title="besides translating datashit atmegi328 into Russian, very reasonable articles on development.">Ilya Ananev's</abbr> <a href="http://avrprog.blogspot.com/">blog</a> in a very similar <a href="http://avrprog.blogspot.com/2013/03/t0-8.html">timer-counter 0</a> in the senior ATmega328. </p><br><p>  I change only those registers whose functionality runs what I need. </p><br><pre> <code class="cpp hljs">TCCR0B = _BV(CS02) | _BV(CS00); <span class="hljs-comment"><span class="hljs-comment">//    CS02  CS00  1 -   0 = clock frequency / 1024 TIMSK0 |= _BV(TOIE0); //   TOIE0  1 -     TIM0_OVF //      TIMSK0 = _BV(TOIE0);</span></span></code> </pre> <br><h4 id="gost-ili-zakon-est-zakon">  GOST or law is the law. </h4><br><p>       ,       .    ,    ,          .    -  ,        ,      ,    (!)   . </p><br><p>     ,       .           " <a href="http://rosavtodor.ru/docs/prikazy-rasporyazheniya/13324">   27.02.13</a> "  7    52289-2004     ,          . <br>      (  ): ,   , ,  , , . </p><br><p> "*    "  "     2 ,    ‚Äî 3 . </p><br><p>                3        1 /.*" </p><br><p>    ,      (    ,      /  ‚Äî PERIOD_0  PERIOD_4,    ‚Äî  ). </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ONE_SECOND 37 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     1  #define QT_SECOND 9 //   #define PERIOD_FLASH_GREEN QT_SECOND //    ( ) -     #define PERIOD_FLASH_YELLOW ONE_SECOND * 1 //    -    -  //  ---  #define PERIOD_0 ONE_SECOND * 10 //RGRG 0.  ---  (10 ) #define PERIOD_1 ONE_SECOND * 3 //R g R g 1.  ---   (3 ) #define PERIOD_2 ONE_SECOND * 1 //RYRY 2.  ---  (1 ) #define PERIOD_3 ONE_SECOND * 2 //RY Y RY Y 3. + ---  (2 ) #define PERIOD_4 ONE_SECOND * 7 //GRGR 4.  ---  (7 ) #define PERIOD_5 ONE_SECOND * 3 //g R g R 5.   --- (3 ) #define PERIOD_6 ONE_SECOND * 1 //YRYR 6.  ---  (1 ) #define PERIOD_7 ONE_SECOND * 2 //Y RY Y RY 7.  --- + (2 )</span></span></span></span></code> </pre> <br><p>   ,      ,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ddr_val_0; <span class="hljs-comment"><span class="hljs-comment">// DDRB value -    const uint8_t port_val_0; // PORTB value -    const uint8_t ddr_val_1; // DDRB value -   "",    const uint8_t port_val_1; // PORTB value -  const uint16_t flash_period; // period of flashing -   _val_1  _val_0 const uint16_t signal_period; // period of this lighting state }lightSignalization; //   , _0  _1 -   , flash_long -    // flash_period == 0,   ,   _val_0. // signal_period == 0,         .</span></span></code> </pre> <br><p>   ,        128  ‚Äî     ,      . </p><br><h4 id="kak-nayti-v-attiny13-vosem-ili-devyat-pinov-vvoda-vyvoda">    ATtiny13  ( ?)  - </h4><br><p>    ,  ,   -  -     ,  :       6  . -  <a href="https://habr.com/ru/users/denvo/" class="user_link">denvo</a>   " <a href="https://habr.com/ru/post/110894/"> ?  RESET</a> "       5-     ,     ,      ,      ,   -   . </p><br><p>    -     :    --, ..      ,  7  . </p><br><p>      ‚Äî   , ,  ,   8,  ? </p><br><p>  ,  -,      "reset", PB6,      . </p><br><p>    ,  ? , ,   ,    . , , ,  ,   ,  . </p><br><p>  ,  , 8  9  -  ,    8  ‚Äî       .    ,    -,   , , ,   . </p><br><p>    ‚Äî    . </p><br><p>    :           ‚Äî         .           . </p><br><p>         : </p><br><p><img src="https://habrastorage.org/webt/hw/6_/6a/hw6_6aeekqqdlt7a0cqnk9kf2pa.png"></p><br><p>  1    PORTB |= _BV(GREEN_PIN) ‚Äî    (  ) ,   0 .. PORTB &amp;= ~(_BV(GREEN_PIN)) ‚Äî  (  ). <br>   ,     ,      ? <br>      (DDRB |= _BV(GREEN_PIN))   , DDRB &amp;= ~(_BV(GREEN_PIN)), GREEN_PIN   Hi-Z      .      (2.2 * 4)    5,   <abbr title=".  ,       ,        .">   </abbr> . </p><br><p>           . <br>             ‚Äî ..    ,     ,    . </p><br><div class="spoiler"> <b class="spoiler_title">, ,      </b> <div class="spoiler_text"><p> ,               .   ,    ‚Äî     ,   37/2=18      ,          ,    .  But: <br> )   ,     ,  ,  ,     ; <br> )   ‚Äî        ,      " "       4  ; <br> )  ,       4 ( PERIOD_2-&gt;PERIOD_3  PERIOD_6-&gt;PERIOD_7); <br> )  4                 . </p></div></div><br><p>   . </p><br><p><img src="https://habrastorage.org/webt/35/in/ym/35inymyguij4kl6qnsuckgz_ukq.png"></p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// PINB === 0 0 0 gr y0 btt y1 #define RED_PIN PB3 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define YELLOW0_PIN PB2 // OUT: 1 -  "-" #define YELLOW1_PIN PB0 // OUT: 1 -  "-" #define GREEN_PIN PB4 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define RED _BV(RED_PIN) // _BV -     (), 1&lt;&lt;VALUE #define YELL0 _BV(YELLOW0_PIN) //    - #define YELL1 _BV(YELLOW1_PIN) #define GREEN _BV(GREEN_PIN) //    - (  0 -   -)  DDRB.GreenPin=1</span></span></code> </pre> <br><p>  ‚Äî  <abbr title=" ,      reset,     ISP "> </abbr> .    ,            ,   ‚Äî      ,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BUTTON_PIN PB1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BUTTON_ON !(PINB &amp; _BV(BUTTON_PIN)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//( (PINB &amp; _BV(BUTTON_PIN)) == 0) //  " " -   LOW #define BUTTON_OFF (PINB &amp; _BV(BUTTON_PIN)) //  " " -    HIGH, (     )</span></span></span></span></code> </pre> <br><p> <strong><em>       ,   <a href="https://en.wikipedia.org/wiki/Charlieplexing"></a> ,   n   ( ) n(n‚àí1) = n¬≤‚àín .  4   12  ,         .   <abbr title=" +  + ">¬´ , ¬ª</abbr>  <abbr title=" + ">¬´ ,   ¬ª</abbr>        .</em></strong> </p><br><div class="spoiler"> <b class="spoiler_title">    12 LED</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/oq/sn/le/oqsnlertvho7jlbhqt5ehp_fcks.png"></p></div></div><br><p> *** ‚Äî   ,         DDRx|PORTx,       , ..       .          ‚Äî   ,        ,         . </p><br><p>                      .*** </p><br><h4 id="paru-slov-o-pyatom-izmerenii-kak-vpihnut-nevpihuemoe">     :   ? </h4><br><p>          lightSignalization.    lightSignalization        .    0  7  , 8 ‚Äî  ,  9 ‚Äî ,   ""   .     ,         0  7,      . ,  ,      .     3    ( 0  7)  8   --             .   if-   ,    .     ,   . </p><br><pre> <code class="cpp hljs">lightSignalization traffic_signals[] = {<span class="hljs-comment"><span class="hljs-comment">//    // {DDRB0, PORTB0, DDRB_when_flashingif, PORTB_when_flasingif (if flashing), continous of half-period flashing, continous curr mode runing} {RED|GREEN, RED, 0, 0, 0, PERIOD_0}, // RGRG {RED, RED, RED|GREEN, RED, QT_SECOND, PERIOD_1}, // R g R g - flash east green {RED|YELL1, RED|YELL1, 0, 0, 0, PERIOD_2 }, // R Y1 R Y1 {RED|YELL0|YELL1, RED|YELL0|YELL1, 0, 0, 0, PERIOD_3 }, // RY0 Y1 RY0 Y1 {RED|GREEN, GREEN, 0, 0, 0, PERIOD_4}, // GRGR {RED|GREEN, GREEN, RED, 0, QT_SECOND, PERIOD_5 }, // g R g R - flash nord green {RED|YELL0, YELL0, 0, 0, 0, PERIOD_6}, // Y0 R Y0 R {RED|YELL0|YELL1, YELL0|YELL1, 0, 0, 0, PERIOD_7 }, // Y0 RY1 Y0 RY1 {YELL0|YELL1, YELL0|YELL1, YELL0|YELL1, 0, ONE_SECOND, 0}, // y0 y1 y0 y1 - flash yellows lights {0, 0, 0, 0, 0, 0} // traffic lights off, DDR in, Hi-Z }; //      lightSignalization traffic_signals[] #define LIGHT_NUM_YELLOW_FLASH 8 //       -  - flash yellows lights #define LIGHT_NUM_STD_START 0 //        #define LIGHT_NUM_LIGHTS_OFF 9 //      -   - traffic lights off</span></span></code> </pre> <br><p>   lightSignalization  8   . ..     traffic_signals[]  10     80  (,  64  ,  2     ).  ,        . </p><br><p>  ,  , ,          ‚Äî    ROM,  ,    RAM   ,     . </p><br><p> -      </p><br><pre> <code class="plaintext hljs">const lightSignalization traffic_signals[] PROGMEM= {...</code> </pre> <br><p>  ,           </p><br><pre> <code class="plaintext hljs">&lt;avr/pgmspace.h&gt; pgm_read_byte_near()  pgm_read_word_near()</code> </pre> <br><p>  char  shortint . </p><br><p>      3   . </p><br><ol><li><p>  ,   . <br>    traffic_signals[] ‚Äî <strong>LIGHT_NUM_LIGHTS_OFF</strong> <br> {0, 0, 0, 0, 0, 0} // traffic lights off <br>    ‚Äî  lightSignalization  ,     ‚Äî ,   lightSignalization.signal_period==0 (.. ),   lightSignalization.flash_period==0, ..   . </p><br></li><li><p>  ,  . <br>    traffic_signals[] ‚Äî <strong>LIGHT_NUM_YELLOW_FLASH</strong> <br> {YELL0|YELL1, YELL0|YELL1, YELL0|YELL1, 0, ONE_SECOND, 0}, // y0 y1 y0 y1 ‚Äî flash yellows lights <br>    : lightSignalization.signal_period==0.      lightSignalization.flash_period=ONE_SECOND,    : </p><br><pre> <code class="cpp hljs">DDRB = YELL0|YELL1; <span class="hljs-comment"><span class="hljs-comment">// YELL0, YELL1 -  PORTB = YELL0|YELL1; // YELL0, YELL1 = HIGH -  </span></span></code> </pre> <br><p>  and </p><br><pre> <code class="cpp hljs">DDRB = YELL0|YELL1; <span class="hljs-comment"><span class="hljs-comment">// // YELL0, YELL1 -    PORTB = 0; // YELL0, YELL1 = LOW -  </span></span></code> </pre> <br></li><li><p>  , --. </p><br></li></ol><br><p>  ,   . </p><br><p>   traffic_signals[]     ‚Äî <strong>LIGHT_NUM_STD_START</strong> <br> {RED|GREEN, RED, 0, 0, 0, PERIOD_0}, // RGRG <br>    : lightSignalization.flash_period==0. <br> DDRB = RED|GREEN; //RED  GREEN ‚Äî  ,  . <br> PORTB = RED; //  RED ‚Äî HIGH (-      ) <br> //   GREEN ‚Äî LOW (  ,  - ‚Äî  ) <br>       lightSignalization.signal_period==PERIOD_0,       . </p><br><p>         current_signal.   2   ‚Äî        ,     lightSignalization. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> current_signal; <span class="hljs-comment"><span class="hljs-comment">// 1    ,   traffic_signals uint16_t tl_flash_end; // 2       ( !0), uint16_t tl_signal_end; // 2            ( !0)</span></span></code> </pre> <br><p>  tl_signal_end != 0,   globalTimer&gt;tl_signal_end  current_signal.     0   current_signal,  3, . <br> current_signal = current_signal &amp; B00000111; <br>    </p><br><pre> <code class="plaintext hljs">current_signal &amp;= LIGHT_NUM_STD_MASK ; //current_signal &amp; B00000111;</code> </pre> <br><p>   current_signal  ,       0  7. <br>    globalTimer ‚Äî       . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;limits.h&gt; // USHRT_MAX #include &lt;avr/sleep.h&gt; // ,   #include &lt;avr/interrupt.h&gt; //    #include &lt;avr/pgmspace.h&gt; //     #define ONE_SECOND 37 //     1  #define QT_SECOND 9 //   #define MAX_GLOBAL_TIMER_VALUE (USHRT_MAX / 2) // uint16_t globalTimer -   . 65535 /2 //     ,  MAX_GLOBAL_TIMER_VALUE - 1 #define PERIOD_FLASH_GREEN QT_SECOND //    ( ) -     #define PERIOD_FLASH_YELLOW ONE_SECOND * 1 //    -    -  //  ---  #define PERIOD_0 ONE_SECOND * 10 //RGRG 0.  ---  (15 ) #define PERIOD_1 ONE_SECOND * 3 //R g R g 1.  ---   (3 ) #define PERIOD_2 ONE_SECOND * 1 //RYRY 2.  ---  (1 ) #define PERIOD_3 ONE_SECOND * 2 //RY Y RY Y 3. + ---  (2 ) #define PERIOD_4 ONE_SECOND * 7 //GRGR 4.  ---  (10 ) #define PERIOD_5 ONE_SECOND * 3 //g R g R 5.   --- (3 ) #define PERIOD_6 ONE_SECOND * 1 //YRYR 6.  ---  (1 ) #define PERIOD_7 ONE_SECOND * 2 //Y RY Y RY 7.  --- + (2 ) typedef struct{ const uint8_t ddr_val_0; // DDRB value     const uint8_t port_val_0; // PORTB value const uint8_t ddr_val_1; // DDRB value     const uint8_t port_val_1; // PORTB value const uint16_t flash_period; // period of flashing -   _val_1  _val_0 const uint16_t signal_period; // period of this lighting state }lightSignalization; //   , _0  _1 -   , flash_long -    //    (PINS === 0 0 0 gr y0 btt y1): //     ""      #define BUTTON PB1 #define RED_PIN PB3 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define YELLOW0_PIN PB2 // OUT: 1 -  "-" #define YELLOW1_PIN PB0 // OUT: 1 -  "-" #define GREEN_PIN PB4 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define BUTTON_ON !(PINB &amp; _BV(BUTTON)) //( (PINB &amp; _BV(BUTTON)) == 0) //  " " #define BUTTON_OFF (PINB &amp; _BV(BUTTON)) // ~(PINB &amp; _BV(BUTTON)) -\\- " " #define RED _BV(RED_PIN) // _BV -     (), 1&lt;&lt;VALUE #define YELL0 _BV(YELLOW0_PIN) // #define YELL1 _BV(YELLOW1_PIN) #define GREEN _BV(GREEN_PIN) //      lightSignalization traffic_signals[] #define LIGHT_NUM_YELLOW_FLASH 8 //       -  - flash yellows lights #define LIGHT_NUM_STD_START 0 //        #define LIGHT_NUM_LIGHTS_OFF 9 //      -   - traffic lights off #define LIGHT_NUM_STD_MASK 7 // ___++ &amp;LIGHT_NUM_STD_MASK -    0  7   //....................................   // const lightSignalization traffic_signals[] PROGMEM= { //   ,  ,   -, PINS === 0 0 0 gr y0 btt y1 // {DDRB0, PORTB0, DDRB_flashing, PORTB_flasinf (if flashing), continuous of half-period flashing, continuous id mode running} {RED|GREEN, RED, 0, 0, 0, PERIOD_0}, // RGRG {RED, RED, RED|GREEN, RED, QT_SECOND, PERIOD_1}, // R g R g - flash east green {RED|YELL1, RED|YELL1, 0, 0, 0, PERIOD_2 }, // R Y1 R Y1 {RED|YELL0|YELL1, RED|YELL0|YELL1, 0, 0, 0, PERIOD_3 }, // RY0 Y1 RY0 Y1 {RED|GREEN, GREEN, 0, 0, 0, PERIOD_4}, // GRGR {RED|GREEN, GREEN, RED, 0, QT_SECOND, PERIOD_5 }, // g R g R - flash nord green {RED|YELL0, YELL0, 0, 0, 0, PERIOD_6}, // Y0 R Y0 R {RED|YELL0|YELL1, YELL0|YELL1, 0, 0, 0, PERIOD_7 }, // Y0 RY1 Y0 RY1 {YELL0|YELL1, YELL0|YELL1, YELL0|YELL1, 0, ONE_SECOND, 0}, // y0 y1 y0 y1 - flash yellows lights {0, 0, 0, 0, 0, 0} // traffic lights off, }; volatile uint16_t globalTimer; //     64    uint8_t current_signal; // 1    ,   traffic_signals uint16_t tl_flash_end; // 2       ( !0), uint16_t tl_signal_end; // 2            ( !0) //....................................   void setPeriods(uint8_t num, bool set_both_flash_and_signal); //  tl_flash_end, tl_signal_end void setPorts(uint8_t num, bool use_main_values); //     //....................................   // //  -    globalTimer  1/37  ISR(TIM0_OVF_vect){ globalTimer++; //       . ,   while(1)   . } int main() { // bool use_main_values = true; // lightSignalization._val_0 (1)  lightSignalization._val_1 (0)? -   current_signal = LIGHT_NUM_STD_START; //   .     . //     "  -". set_sleep_mode(SLEEP_MODE_IDLE); //   - . sleep_enable(); //     TCCR0B = _BV(CS02) | _BV(CS00); //  0 - clock frequency / 1024 TIMSK0 |= _BV(TOIE0); //      overflow interrupt sei(); //     while(1){ //   ? if(globalTimer &gt; MAX_GLOBAL_TIMER_VALUE){ globalTimer -= MAX_GLOBAL_TIMER_VALUE; //    // if(tl_flash_end){ tl_flash_end -= MAX_GLOBAL_TIMER_VALUE; //   ,   } if(tl_signal_end){ tl_signal_end -= MAX_GLOBAL_TIMER_VALUE; // //   ,   } // setPeriods(currentMode, false); //   12  ,  tl_.._end   ,      } //      (tl_flash_end !=0 ) if(tl_flash_end){ //      if(globalTimer &gt; tl_flash_end){ use_main_values = !use_main_values; // !use_main_values -      )) setPorts(current_signal, use_main_values); //       setPeriods(current_signal, false); //     ,    } } //         -    operating_std     - -- if(tl_signal_end){ //       (use_main_values -       -  ) if((globalTimer &gt; tl_signal_end) &amp;&amp; use_main_values){ current_signal ++; //    current_signal &amp;= LIGHT_NUM_STD_MASK; //    3-,        0  7 use_main_values = true; //  -     setPorts(current_signal, use_main_values); //         setPeriods(current_signal, true); //        } } sleep_cpu(); //      -   . } } //    void setPorts(uint8_t num, bool use_main_values){ uint8_t val; DDRB = 0; PORTB = 0; //    () - ddr_val_0, else = ddr_val_1 // val = (use_main_values) ? pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_0)) // : pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_1)); //   ,  , ,  ,   ,   14 (!!!)   . val = pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_0)+( (use_main_values) ? 0 : 2) ); val &amp;= ~_BV(BUTTON); //     -  DDRB = val; //     val = (use_main_values) ? pgm_read_byte_near(&amp;(traffic_signals[num].port_val_0)) : pgm_read_byte_near(&amp;(traffic_signals[num].port_val_1)); val|= _BV(BUTTON); //     -  -     PORTB = val; //       } //     ( void setPeriods(uint8_t num, bool set_both_flash_and_signal){ //   tl_flash_end = pgm_read_word_near (&amp;(traffic_signals[num].flash_period)); //   tl_flash_end = (tl_flash_end)? tl_flash_end + globalTimer : 0; //    -      //if(tl_flash_end){ tl_flash_end += globalTimer; } &lt;-     8   //     -     if(set_both_flash_and_signal){ tl_signal_end = pgm_read_word_near(&amp;(traffic_signals[num].signal_period)); tl_signal_end = (tl_signal_end)? tl_signal_end + globalTimer : 0; //     ,     } } //Program size: 610 bytes (used 60% of a 1 024 byte maximum) (0,58 secs) //Minimum Memory Usage: 7 bytes (11% of a 64 byte maximum)</span></span></span></span></code> </pre> </div></div><br><h4 id="slozhnaya-logika-prostoy-knopki">     </h4><br><p>      ,          .         ‚Äî   btn_cnt (     ),    (        )               . </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PERIOD_PRESS_BUTTON_SHORT QT_SECOND </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//      -   #define PERIOD_PRESS_BUTTON_LONG QT_SECOND*6 //      - / uint8_t scan_button_cnt; //     //   if(BUTTON_ON){ if(scan_button_cnt&lt;USHRT_MAX){ scan_button_cnt++; //   1/37      } if(scan_button_cnt &gt; PERIOD_PRESS_BUTTON_SHORT){ // ,      } if(scan_button_cnt &gt; PERIOD_PRESS_BUTTON_LONG){ //      } }</span></span></span></span></code> </pre><br><p>     ‚Äî      . </p><br><p><img src="https://habrastorage.org/webt/fe/k6/6_/fek66_j4lcziqglnpmyudph1ujc.jpeg"></p><br><p>      SLEEP_MODE_IDLE (     CPU),   PwrDown    SLEEP_MODE_PWR_DOWN ‚Äî         <del>    </del>   watchdog     INT0,   ,     ‚Äî      INT0. </p><br><p><img src="https://habrastorage.org/webt/0w/82/0k/0w820klrlwg0enib-pznejydfp0.png"></p><br><p>  <abbr title=""></abbr>      .   7.Power management and sleep modes   ATtiny13  ,      5-10 ,          . </p><br><p>              8- ,    ‚Äî 2        . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// uint8_t f_button_state_flags; //         //      MODES: wakeup 11 -&gt; work 00 -&gt; tosleep 01 -&gt; pwrdown 11 -&gt; wakeup 11 #define MODE_LBIT 0 #define MODE_HBIT 1 #define FORCE_SET_NEW_SIGNAL_BIT 2 //             current_signal //    3 #define LIGHT_SIGNAL_ALT_MODE_BIT 4 // =0 (--)  =1 ( )    #define USE_FIRST_VALUES_LIGHT_BIT 5 //     -  lightSignalization   #define SHORT_PRESS_FLAG_BIT 6 // , 1        #define LONG_PRESS_FLAG_BIT 7 // , 1       </span></span></code> </pre> <br><p>  ,       ‚Äî    ,    ‚Äî   CPU     .          ,         if-. </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;limits.h&gt; // USHRT_MAX #include &lt;avr/io.h&gt; //     IDE #include &lt;avr/sleep.h&gt; // ,      #include &lt;avr/interrupt.h&gt; //    #include &lt;avr/pgmspace.h&gt; //     #ifdef GIMSK //  ATtiny13 -        #define F_CPU 9600000UL //      ,    #define ONE_SECOND 37 //     1  #define QT_SECOND 9 //   // GIMSK &amp;= ~_BV(INT0); -   INT0 #define DISABLE_EXTERNAL_INT0 GIMSK &amp;= ~(_BV(INT0)); GIFR &amp;= ~(_BV(INTF0)) //EIMSK/EIFR   //GIMSK |= _BV(INT0) -   INT0 #define ENABLE_EXTERNAL_INT0 GIMSK |= _BV(INT0) ; GIFR &amp;= ~(_BV(INTF0)) #else // 328 -    #define F_CPU 16000000UL #define ONE_SECOND 64 //     1  - .    #define QT_SECOND 16 //   // 328 INT0 -  PD2...     ,       (,  ),             #define DISABLE_EXTERNAL_INT0 EIMSK &amp;= ~(_BV(INT0)); EIFR &amp;= ~(_BV(INTF0)) // ,   - EICRA - ISC00-ISC01 == 00, lo level, EIMSK - INT0, EIFR-INTF0 #define ENABLE_EXTERNAL_INT0 EIMSK |= _BV(INT0) ; EIFR &amp;= ~(_BV(INTF0)) #endif #define MAX_GLOBAL_TIMER_VALUE (USHRT_MAX / 2) // uint16_t globalTimer -   . 65535 /2 //     ,  MAX_GLOBAL_TIMER_VALUE - 1 #define PERIOD_PRESS_BUTTON_SHORT QT_SECOND/2 //      ( - ) -   #define PERIOD_PRESS_BUTTON_LONG QT_SECOND*4 //      - / #define PERIOD_FLASH_GREEN QT_SECOND //     ( ) -     #define PERIOD_FLASH_YELLOW ONE_SECOND * 1 //     -    -  //  ---  #define PERIOD_0 ONE_SECOND * 5 // RGRG 0.  ---  (5 ) #define PERIOD_1 ONE_SECOND * 3 //R g R g 1.  ---   (3 ) #define PERIOD_2 ONE_SECOND * 1 //RYRY 2.  ---  (1 ) #define PERIOD_3 ONE_SECOND * 2 //RY Y RY Y 3. + ---  (2 ) #define PERIOD_4 ONE_SECOND * 7 // GRGR 4.  ---  (7 ) #define PERIOD_5 ONE_SECOND * 3 //g R g R 5.   --- (3 ) #define PERIOD_6 ONE_SECOND * 1 //YRYR 6.  ---  (1 ) #define PERIOD_7 ONE_SECOND * 2 //Y RY Y RY 7.  --- + (2 ) //  /  .     -      typedef struct{ const uint8_t ddr_val_0; // DDRB value     const uint8_t port_val_0; // PORTB value const uint8_t ddr_val_1; // DDRB value     const uint8_t port_val_1; // PORTB value const uint16_t flash_period; // period of flashing -   _val_1  _val_0 ( =0,  ) const uint16_t signal_period; // period of this lighting state ( =0,       ) }lightSignalization; //   , _0  _1 -   , flash_long -    //    (PINS === 0 0 0 gr y0 btt y1): //     ""      #define BUTTON_PIN PB1 // ,   INT0. ,   ,  = LOW #define RED_PIN PB3 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define YELLOW0_PIN PB2 // OUT: 1 -  "-" #define YELLOW1_PIN PB0 // OUT: 1 -  "-" #define GREEN_PIN PB4 // OUT: 1 - "-" , 0 - "-" , IN -  , ,  (!)  #define BUTTON_ON !(PINB &amp; _BV(BUTTON_PIN)) //( (PINB &amp; _BV(BUTTON)) == 0) //  " " #define BUTTON_OFF (PINB &amp; _BV(BUTTON_PIN)) // ~(PINB &amp; _BV(BUTTON)) -\\- " " #define RED _BV(RED_PIN) // _BV -     (), 1&lt;&lt;VALUE #define YELL0 _BV(YELLOW0_PIN) //    - #define YELL1 _BV(YELLOW1_PIN) #define GREEN _BV(GREEN_PIN) //    - (  0 -   -)  DDR=1 //      lightSignalization traffic_signals[] #define LIGHT_NUM_YELLOW_FLASH 8 //       ( ) -  - flash yellows lights #define LIGHT_NUM_STD_START 0 //        (--) #define LIGHT_NUM_LIGHTS_OFF 9 //      -   - traffic lights off #define LIGHT_NUM_START_SHOW 10 //          #define LIGHT_NUM_ERR 11 //   -      #define MASK_LIGHT_NUM_STD 7 // ___++ &amp;= LIGHT_NUM_STD_MASK -    0  7   //....................................   // const lightSignalization traffic_signals[] PROGMEM= { //   ,  ,   -, PINS === 0 0 0 gr y0 btt y1 // {DDRB0, PORTB0, DDRB_flashing, PORTB_flasinf (if flashing), continuous of half-period flashing, continuous id mode running} {RED|GREEN, RED, 0, 0, 0, PERIOD_0}, // RGRG {RED, RED, RED|GREEN, RED, QT_SECOND, PERIOD_1}, // R g R g - flash east green {RED|YELL1, RED|YELL1, 0, 0, 0, PERIOD_2 }, // R Y1 R Y1 {RED|YELL0|YELL1, RED|YELL0|YELL1, 0, 0, 0, PERIOD_3 }, // RY0 Y1 RY0 Y1 {RED|GREEN, GREEN, 0, 0, 0, PERIOD_4}, // GRGR {RED|GREEN, GREEN, RED, 0, QT_SECOND, PERIOD_5 }, // g R g R - flash nord green {RED|YELL0, YELL0, 0, 0, 0, PERIOD_6}, // Y0 R Y0 R {RED|YELL0|YELL1, YELL0|YELL1, 0, 0, 0, PERIOD_7 }, // Y0 RY1 Y0 RY1 {YELL0|YELL1, YELL0|YELL1, YELL0|YELL1, 0, ONE_SECOND, 0}, // y0 y1 y0 y1 - flash yellows lights {0, 0, 0, 0, 0, 0}, // traffic lights off, {RED|GREEN|YELL0, RED|YELL0, RED|GREEN|YELL1, GREEN|YELL1, 1, PERIOD_2}, // PERIOD_2  -      ,      {YELL0|GREEN, YELL0, YELL1|GREEN, YELL1|GREEN, 1, 0} //  -      }; volatile uint16_t globalTimer; //      64    uint8_t scan_button_cnt; //       uint16_t tl_flash_end; // 2       ( !0), uint16_t tl_signal_end; // 2            ( !0) uint8_t f_button_state_flags; // 1,         // , 8     #pragma region bits_of_f_button_state_flags //      MODES: wakeup 11 -&gt; work 00 -&gt; tosleep 01 -&gt; pwrdown 11 -&gt; wakeup 11 #define MODE_LBIT 0 #define MODE_HBIT 1 #define MODE_VALUE ( f_button_state_flags &amp; 3 ) //  -   MODE_ #define SET_MODE_WORK f_button_state_flags &amp;= ~(_BV(MODE_HBIT) ); f_button_state_flags &amp;= ~(_BV(MODE_LBIT) );// 00 - work // f_button_state_flags &amp;= ~( _BV(MODE_HBIT) | _BV(MODE_LBIT) ) -    ,   #define MODE_WORK_VALUE 0 #define SET_MODE_TOSLEEP f_button_state_flags &amp;= ~(_BV(MODE_HBIT)); f_button_state_flags |= _BV(MODE_LBIT) // 01 - tosleep #define MODE_TOSLEEP_VALUE 1 #define SET_MODE_PWRDOWN f_button_state_flags |= _BV(MODE_HBIT); f_button_state_flags &amp;= ~(_BV(MODE_LBIT)) // 10 - pwrdown #define MODE_PWRDOWN_VALUE 2 #define SET_MODE_WAKEUP f_button_state_flags |= _BV(MODE_HBIT); f_button_state_flags |= _BV(MODE_LBIT) // 11 - wakeup #define MODE_WAKEUP_VALUE 3 #define FORCE_SET_NEW_SIGNAL_BIT 2 //             current_signal #define IF_FORCE_SET_SIGNAL_FLAG ( f_button_state_flags &amp; _BV(FORCE_SET_NEW_SIGNAL_BIT) ) // IF_ -     #define SET_FORCE_SET_SIGNAL_FLAG f_button_state_flags |= _BV(FORCE_SET_NEW_SIGNAL_BIT) // SET_ -    1 #define RES_FORCE_SET_SIGNAL_FLAG f_button_state_flags &amp;= ~( _BV(FORCE_SET_NEW_SIGNAL_BIT) ) // RES_ -    0 //  3    #define LIGHT_SIGNAL_ALT_MODE_BIT 4 // =0 (--)  =1 ( )    #define IF_LIGHT_SIGNAL_ALT_MODE_FLAG ( f_button_state_flags &amp; _BV(LIGHT_SIGNAL_ALT_MODE_BIT) ) //1( )  0(--)   ? #define SET_LIGHT_SIGNAL_ALT_MODE_FLAG f_button_state_flags |= _BV(LIGHT_SIGNAL_ALT_MODE_BIT) #define RES_LIGHT_SIGNAL_ALT_MODE_FLAG f_button_state_flags &amp;= ~( _BV(LIGHT_SIGNAL_ALT_MODE_BIT) ) #define FLIP_LIGHT_SIGNAL_ALT_MODE_FLAG f_button_state_flags ^= _BV(LIGHT_SIGNAL_ALT_MODE_BIT) #define USE_FIRST_VALUES_LIGHT_BIT 5 //     -  lightSignalization   #define IF_USE_FIRST_VALUES_LIGHT_FLAG (f_button_state_flags &amp; _BV(USE_FIRST_VALUES_LIGHT_BIT)) // lightSignalization._val_0 (1)  lightSignalization._val_1 (0)? -   #define SET_USE_FIRST_VALUES_LIGHT_FLAG f_button_state_flags |= _BV(USE_FIRST_VALUES_LIGHT_BIT) #define RES_USE_FIRST_VALUES_LIGHT_FLAG f_button_state_flags &amp;= ~( _BV(USE_FIRST_VALUES_LIGHT_BIT)) #define FLIP_USE_FIRST_VALUES_LIGHT_FLAG f_button_state_flags ^= _BV(USE_FIRST_VALUES_LIGHT_BIT) //   #define SHORT_PRESS_FLAG_BIT 6 // , 1        #define IF_SHORT_PRESS_FLAG ( f_button_state_flags &amp; _BV(SHORT_PRESS_FLAG_BIT) ) // -   == 1 #define SET_SHORT_PRESS_FLAG f_button_state_flags |= _BV(SHORT_PRESS_FLAG_BIT) #define RES_SHORT_PRESS_FLAG f_button_state_flags &amp;= ~(_BV(SHORT_PRESS_FLAG_BIT)) #define LONG_PRESS_FLAG_BIT 7 // , 1        #define IF_LONG_PRESS_FLAG ( f_button_state_flags &amp; _BV(LONG_PRESS_FLAG_BIT) ) // -   == 1 #define SET_LONG_PRESS_FLAG f_button_state_flags |= _BV(LONG_PRESS_FLAG_BIT) #define RES_LONG_PRESS_FLAG f_button_state_flags &amp;= ~(_BV(LONG_PRESS_FLAG_BIT)) #pragma endregion //....................................   void setPeriods(uint8_t num, bool set_both_flash_and_signal); //  tl_flash_end, tl_signal_end void setPorts(uint8_t num, bool use_main_values); //     void inline init_timer_clock(){ //      #ifdef GIMSK //  ATtiny13 - TCCR0B = _BV(CS02) | _BV(CS00); //  0 - clock frequency / 1024 TIMSK0 |= _BV(TOIE0); //      overflow interrupt #else //   , 328/16 // 100 - prescaler 64; Foverflow = 16M/64*256 ~=976.56Hz, TCCR2B = (1&lt;&lt;CS22) | (1&lt;&lt;CS21) | (1&lt;&lt;CS20) ; // 111 - CLK/1024, 16M/1024*254 - 1/64  TIMSK2 |=(1&lt;&lt;TOIE0); // interrupt ovfl enable //Serial.begin(115200); #endif } //....................................   // //  -  -    globalTimer  1/37  #ifdef GIMSK //  ATtiny13 ISR(TIM0_OVF_vect){ globalTimer++; //       . ,   while(1)   . } #else //   0 -     , -   - -     2 ISR(TIMER2_OVF_vect){ globalTimer++; } #endif //   -    (,  ,    0) ISR(INT0_vect){ DISABLE_EXTERNAL_INT0; SET_MODE_WAKEUP; //      POWER DOWN globalTimer = 0; //  -   scan_button_cnt = 0; //    RES_SHORT_PRESS_FLAG; // RES_LONG_PRESS_FLAG; //   } /* //   -  void inline dbg(){ DDRB |= YELL0; PORTB ^= YELL0; } */ //....................................   // int main() { uint8_t current_signal; // 1    ,   traffic_signals #pragma region Initialisation&amp;setup //     "  -". set_sleep_mode(SLEEP_MODE_IDLE); //   - . sleep_enable(); //     init_timer_clock(); //      globalTimer = 0; //  -   SET_MODE_WORK; //     SET_USE_FIRST_VALUES_LIGHT_FLAG; //   scan_button_cnt = 0; //    //        current_signal = LIGHT_NUM_START_SHOW; //     -   / SET_FORCE_SET_SIGNAL_FLAG; //    current_signal sei(); //     #pragma endregion while(1){ #pragma region TimerOVF //   ? if(globalTimer &gt; MAX_GLOBAL_TIMER_VALUE){ globalTimer -= MAX_GLOBAL_TIMER_VALUE; //    // if(tl_flash_end){ tl_flash_end -= MAX_GLOBAL_TIMER_VALUE; //   ,   } if(tl_signal_end){ tl_signal_end -= MAX_GLOBAL_TIMER_VALUE; // //   ,   } // setPeriods(currentMode, false); //   12  ,  tl_.._end   ,      } #pragma endregion #pragma region ButtonState //   if(BUTTON_ON){ if(scan_button_cnt &lt; USHRT_MAX){ scan_button_cnt++; //   1/37      } //   -  ,     if(scan_button_cnt &gt; PERIOD_PRESS_BUTTON_SHORT){ SET_SHORT_PRESS_FLAG; // ,     ,  } if(scan_button_cnt &gt; PERIOD_PRESS_BUTTON_LONG){ SET_LONG_PRESS_FLAG; //      } } #pragma endregion #pragma region LightWorkLogic //      (tl_flash_end !=0 ) if(tl_flash_end){ //      if(globalTimer &gt; tl_flash_end){ FLIP_USE_FIRST_VALUES_LIGHT_FLAG; // !use_main_values -      )) setPorts(current_signal, IF_USE_FIRST_VALUES_LIGHT_FLAG); //       setPeriods(current_signal, false); //     ,    } } //         // -    operating_std     - -- //    ,   +1   7 if(tl_signal_end){ //       (use_main_values -       -  ) if((globalTimer &gt; tl_signal_end) &amp;&amp; IF_USE_FIRST_VALUES_LIGHT_FLAG){ current_signal ++; //    current_signal &amp;= MASK_LIGHT_NUM_STD; //    3-,        0  7 SET_FORCE_SET_SIGNAL_FLAG; //    current_signal } } #pragma endregion #pragma region MODE_VALUELogic //   , 2  f_button_state_flags //? MODE_VALUE === pwrdown -&gt; wakeup -&gt; work -&gt; tosleep -&gt; pwrdown switch (MODE_VALUE){ case (MODE_WAKEUP_VALUE): set_sleep_mode(SLEEP_MODE_IDLE); //  ! //   ,       - IF_BUTTON_LONG_FLAG if(IF_LONG_PRESS_FLAG){ //      ?   ! if(current_signal == LIGHT_NUM_LIGHTS_OFF){ //          ? LIGHT_NUM_ERR current_signal = (IF_LIGHT_SIGNAL_ALT_MODE_FLAG) ? LIGHT_NUM_YELLOW_FLASH : LIGHT_NUM_STD_START; SET_FORCE_SET_SIGNAL_FLAG; //    current_signal } } //,  ... if(BUTTON_OFF){ //      ,    if(IF_LONG_PRESS_FLAG){ SET_MODE_WORK; }else{ //  , ,   ,   SET_MODE_PWRDOWN; //         } scan_button_cnt = 0; //        RES_SHORT_PRESS_FLAG; //   ,  RES_LONG_PRESS_FLAG; } break; case (MODE_WORK_VALUE): //  ? if(scan_button_cnt &gt; 0){ //   ? if(IF_LONG_PRESS_FLAG){ current_signal = LIGHT_NUM_LIGHTS_OFF; //   SET_FORCE_SET_SIGNAL_FLAG; //   -   " " SET_MODE_TOSLEEP; //   ! } // ? if(BUTTON_OFF){ //     ? if(IF_SHORT_PRESS_FLAG){ FLIP_LIGHT_SIGNAL_ALT_MODE_FLAG; //      current_signal = (IF_LIGHT_SIGNAL_ALT_MODE_FLAG) ? LIGHT_NUM_YELLOW_FLASH : LIGHT_NUM_STD_START; //    .  SET_FORCE_SET_SIGNAL_FLAG; //      current_signal } scan_button_cnt=0; RES_SHORT_PRESS_FLAG; //     RES_LONG_PRESS_FLAG; } } break; case (MODE_TOSLEEP_VALUE): //    -    . if(BUTTON_OFF){ SET_MODE_PWRDOWN; //     } break; case (MODE_PWRDOWN_VALUE): // !  , !  ? if(BUTTON_ON){ set_sleep_mode(SLEEP_MODE_IDLE); SET_MODE_WAKEUP; }else{ //  ?  . scan_button_cnt = 0; RES_LONG_PRESS_FLAG; RES_SHORT_PRESS_FLAG; current_signal = LIGHT_NUM_LIGHTS_OFF; //  SET_FORCE_SET_SIGNAL_FLAG; set_sleep_mode(SLEEP_MODE_PWR_DOWN); //    -   while(1) ENABLE_EXTERNAL_INT0; //      } break; default: //!       -    .  -       current_signal = LIGHT_NUM_ERR; SET_FORCE_SET_SIGNAL_FLAG; //setPorts(current_signal,true); //setPeriods(current_signal,true); break; } #pragma endregion //   ,      - ? if(IF_FORCE_SET_SIGNAL_FLAG){ //       current_signal RES_FORCE_SET_SIGNAL_FLAG; //   SET_USE_FIRST_VALUES_LIGHT_FLAG; //   -   0-   - setPorts(current_signal, IF_USE_FIRST_VALUES_LIGHT_FLAG); //      #current_signal   setPeriods(current_signal, true); } //    1/37 . , ,  . sleep_cpu(); //       -   . } //....................................  // //     void setPorts(uint8_t num, bool use_main_values){ uint8_t val; DDRB = 0; PORTB = 0; //    () - ddr_val_0, else = ddr_val_1 // val = (use_main_values) ? pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_0)) // : pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_1)); //   ,    ,  ,   ,   14 (!!!)   . val = pgm_read_byte_near(&amp;(traffic_signals[num].ddr_val_0)+( (use_main_values) ? 0 : sizeof(uint8_t)*2 ) ); val &amp;= ~_BV(BUTTON_PIN); //    ,    -  DDRB = val; //     val = (use_main_values) ? pgm_read_byte_near(&amp;(traffic_signals[num].port_val_0)) : pgm_read_byte_near(&amp;(traffic_signals[num].port_val_1)); val|= _BV(BUTTON_PIN); //     -  -     PORTB = val; //       } //     (    ) void setPeriods(uint8_t num, bool set_both_flash_and_signal){ //   tl_flash_end = pgm_read_word_near (&amp;(traffic_signals[num].flash_period)); //   tl_flash_end = (tl_flash_end)? tl_flash_end + globalTimer : 0; //    -      //if(tl_flash_end){ tl_flash_end += globalTimer; } &lt;-     8   //     -     if(set_both_flash_and_signal){ tl_signal_end = pgm_read_word_near(&amp;(traffic_signals[num].signal_period)); tl_signal_end = (tl_signal_end)? tl_signal_end + globalTimer : 0; //     ,     } } //Program size: 976 bytes (used 95% of a 1 024 byte maximum) (0,83 secs) //Minimum Memory Usage: 8 bytes (13% of a 64 byte maximum)</span></span></span></span></code> </pre> </div></div><br><p> <em>Program size: 976 bytes (used 95% of a 1 024 byte maximum) (0,83 secs) <br> Minimum Memory Usage: 8 bytes (13% of a 64 byte maximum)</em> </p><br><p>  Everything. </p><br><p>     <del>    </del>      ATtiny13 . </p><br><h3 id="anatomiya--samshitovo-samannogo-svetofora">  -  </h3><br><p>   (    ?)   .   ‚Äî   .           ,    ,  ,   .  ,     ,    . </p><br><div class="spoiler"> <b class="spoiler_title">,  </b> <div class="spoiler_text"><h4 id="mozgi">  </h4><br><p>  DipTrace       ¬´¬ª      ¬´PCB Layout¬ª,     .        ,    . </p><br><p><img src="https://habrastorage.org/webt/0j/vq/ag/0jvqagommqperqd6t4vsqpuywbg.png"></p><br><p>    ‚Äî       . </p><br><p><img src="https://habrastorage.org/webt/ye/zr/b0/yezrb07pnfknal2yrkkkt8z24ew.jpeg"></p><br><p> ,           ,    . </p><br><p>               (      ,      80-    ). </p><br><p><img src="https://habrastorage.org/webt/a-/vw/zq/a-vwzqrzc8ttmxfyidyx5gku_e0.jpeg"></p><br><p>        CD . </p><br><p><img src="https://habrastorage.org/webt/be/84/yr/be84yr9lcf5qr9xmhfubcc0xi-q.jpeg"></p><br><p>   , ,  ,  . </p><br><p><img src="https://habrastorage.org/webt/4w/4p/ed/4w4pedh-im9ttbm6uhngc24vpge.jpeg"></p><br><p>   ‚Äî    . </p><br><p> <strong></strong> : <em>        ,                 </em> . </p><br><p>  ,  ,             .    ‚Äî   ,    . </p><br><p><img src="https://habrastorage.org/webt/wd/mv/p_/wdmvp_puf54uysk-0og-9lhogvk.jpeg"></p><br><h4 id="vnutrennosti">  Insides </h4><br><p>        ‚Äî  .  -  - "Craft&amp;Clay" 50-     70.    ,        . </p><br><p><img src="https://habrastorage.org/webt/v2/jw/q6/v2jwq6mmb4gvxkpljgamjqavhj4.jpeg"></p><br><p>           . </p><br><p><img src="https://habrastorage.org/webt/w9/jf/8f/w9jf8f1ze2h5lytg9rgy0c4yy8s.jpeg"></p><br><p>        15     130   . </p><br><p><img src="https://habrastorage.org/webt/a4/uf/n-/a4ufn-djsbpg3386o4pvqqcpjua.jpeg"></p><br><p>       ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/ud/tf/nz/udtfnznphbnuq_wmaap31rafnuq.jpeg"></p><br><p><img src="https://habrastorage.org/webt/ex/7j/xb/ex7jxbgh1bhqsmzbep9t9fnrije.jpeg"></p><br><p>    ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/5i/qs/1v/5iqs1v1pa6jqhnmjjfyuxmcqhgy.jpeg"></p><br><p>   ‚Äî     . </p><br><p><img src="https://habrastorage.org/webt/8l/hs/8x/8lhs8xpxud7pcd-w9ixy-qg-9a0.jpeg"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/xj/se/tn/xjsetne6jay2dlqlk_3mgsq4ica.jpeg"></p><br><p>   4     ,   2-3  ,  <br>   ,      . </p><br><p><img src="https://habrastorage.org/webt/xu/6y/pl/xu6yplqtnq8o2yhdtj2cyjcbd3e.jpeg"></p><br><p>   .  , ,   ,  "   ". </p><br><p><img src="https://habrastorage.org/webt/ck/w7/id/ckw7idpowfs9zlrxpok7gqrhsso.jpeg"></p><br><p> ,          . </p><br><p><img src="https://habrastorage.org/webt/wo/jn/rj/wojnrj1diuqw5hf8h56sxjdxyzs.jpeg"></p><br><p>        KSP.        ‚Äî    4  LED     5     . </p><br><p><img src="https://habrastorage.org/webt/kg/f7/qy/kgf7qyhiebdqb5seavzrvekyqaq.jpeg"></p><br><p>                 ,    ,   DC-DC 0.9-5  ,     . </p><br><p><img src="https://habrastorage.org/webt/ol/5v/bz/ol5vbz1tlc-lmcmuczwf77obixc.jpeg"></p><br><p>      .  ,    ,         . </p><br><p><img src="https://habrastorage.org/webt/fb/jf/8-/fbjf8-u-p8gjm2u3ccnwfk9wzdk.jpeg"></p><br><h4 id="ozhivlenie">  </h4><br><p> , ,  ,   . </p><br><p><img src="https://habrastorage.org/webt/wm/8v/ej/wm8vejbxienobpdzeretpbxp3yi.jpeg"></p><br><p>       ISP     10-   . </p><br><p><img src="https://habrastorage.org/webt/tn/eu/7u/tneu7uxc7bewhl9g_lfsajgx9ra.png"></p></div></div><br><h3 id="izuchenie-zhiznedeyatelnosti-svetofora">    </h3><br><p>      , ,  ,  -   .        ,     ,      "  ".      1.5 ,         ‚Äî   .      <a href="http://www.gammon.com.au/power">  </a>     ,      . </p><br><table><thead><tr><th>   </th><th> ,  </th><th> , %/ </th><th>  ,  </th></tr></thead><tbody><tr><td> CR1212 </td><td>  18 </td><td>  one </td><td> 0.250 </td></tr><tr><td> CR1620 </td><td>  68 </td><td>  one </td><td> 0.950 </td></tr><tr><td>  CR2032 </td><td>  210 </td><td>  one </td><td>  3 </td></tr><tr><td> NiCD AAA </td><td>  350 </td><td>  20 </td><td>  98 </td></tr><tr><td> NiMH AAA </td><td>  900 </td><td>  thirty </td><td>  375 </td></tr><tr><td> NiCd AA </td><td>  1000 </td><td>  20 </td><td>  270 </td></tr><tr><td> Alkaline AAA </td><td> 1250 </td><td>  2 </td><td>  35 </td></tr><tr><td> NiMH AA </td><td>  2400 </td><td>  thirty </td><td>  1000 </td></tr><tr><td> <strong>Alkaline AA</strong> </td><td> <strong>2890</strong> </td><td>  <strong>2</strong> </td><td>  <strong>80</strong> </td></tr><tr><td> Li-Ion </td><td>  4400 </td><td>  ten </td><td>  600 </td></tr></tbody></table><br><p>      ,      . ,    ,     (2/100) <em>2890/(24</em> 30) = 80 .  ,    2    ,  32      ATtiny13. </p><br><p>          :       ,    GPIO,      .    ‚Äî ,        ( 4   14   ""),      ,        40 . </p><br><p> ,        ‚Äî    .      ,      .  ,      :      5      DC-DC ,   ,          DC-DC      1.5  -&gt; 5 .        , -       +-20%,   . </p><br><p><img src="https://habrastorage.org/webt/ab/3v/sb/ab3vsbnwkhp2rc9tvyzv6ltyypy.png"></p><br><p>   ,     ""   4-5 (5 ) ,    , 25 (1.5 ),    </p><br><p><img src="https://habrastorage.org/webt/wx/nl/q5/wxnlq5fnsspt1cpgsdpwngtbwos.png"></p><br><p> .. 2890       116 ,    .   ATtiny13    POWER DOWN        . ,       ‚Äî       .         20-50 ,    , Hi-Z,   1 .  ,   DC-DC      . </p><br><p>          2  5 . :         . </p><br><h2 id="nekotorye-processy-mozhno-tolko-prekratit-no-ne-zakonchit">     ,    </h2><br><p>   ,      : </p><br><ul><li>    ,   ‚Äî ,      R2,       ,    .     . </li><li>    .           ‚Äî         1/37 ,          . </li><li>                ,      ,  .    POWER_DOWN     30 ,      ,     ,         . </li><li>   traffic_signals   8   4,   .   4 pin ‚Äî  1     DDR  PORTB </li><li>   uint16_t  signal_period  flash_period ‚Äî  ,     ,   1    . </li><li>    ‚Äî  ROM    2 ,    ‚Äî     -      . </li><li>              /UART. </li><li>    main   ‚Äî      ‚Äî  +50   ROM. </li><li>        9,6    128 ,       . </li></ul><br><p>  But. </p><br><p>        :    " ", ,  8 ,   ,    ¬´¬ª    . </p><br><p>          . </p><br><h2 id="video-raboty">   </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/23ju4JVKMeA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>    <a href="https://github.com/lugovskovp/TrafficLight13">Github</a> ,   MIT. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/443188/">https://habr.com/ru/post/443188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443174/index.html">hellOGL: OpenGL hello world</a></li>
<li><a href="../443176/index.html">7 chrome extensions for learning English</a></li>
<li><a href="../443182/index.html">Pull YPbPr from Commodore 64</a></li>
<li><a href="../443184/index.html">From love to control one step</a></li>
<li><a href="../443186/index.html">Technical support 3CX answers - 5 rules of IP-PBX security</a></li>
<li><a href="../443194/index.html">WFIRM engineers invented a bioprinter that prints the skin directly on the wound.</a></li>
<li><a href="../443198/index.html">Mark Zuckerberg said Facebook is working on a neurointerface to read thoughts</a></li>
<li><a href="../443200/index.html">Iranian hackers stole terabytes of data from Citrix</a></li>
<li><a href="../443202/index.html">Rally against Runet isolation</a></li>
<li><a href="../443208/index.html">Corporate mouse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>