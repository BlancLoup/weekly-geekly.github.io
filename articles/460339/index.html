<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Race condition in web applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR. The article describes unpopular tricks with race condition, which are usually not used in attacks of this type. As a result of research, we ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Race condition in web applications</h1><div class="post__text post__text-html js-mediator-article">  <b>TL; DR.</b> The article describes unpopular tricks with race condition, which are usually not used in attacks of this type.  As a result of research, we have made our own framework for racepwn attacks. <br><br>  Vasya wants to transfer 100 dollars that he has in his account, Pete.  He goes to the translations tab, drives in Petin's nickname and in the field with the number of funds that need to be transferred - the number 100. Next, he presses the transfer button.  Data to whom and how much is sent to the web application.  What can happen inside?  What does a programmer need to do to make everything work correctly? <br><a name="habracut"></a><br><ul><li>  You need to make sure that the amount is available to Vasya for transfer. </li></ul><br>  You need to get the value of the current balance of the user, if it is less than the amount that he wants to transfer - to tell him about it.  Taking into account the fact that there are no credits on our website and should not go into the minus balance. <br><br><ul><li>  Subtract the amount you want to transfer from the user's balance </li></ul><br>  It is necessary to record in the current user's balance value its balance minus the amount to be transferred.  It was 100, it became 100-100 = 0. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Add to the balance of user Peter the amount that was transferred. </li></ul><br>  Pety on the contrary, it was 0, it became 0 + 100 = 100. <br><br><ul><li>  Display a message to the user that he is well done! </li></ul><br>  When writing programs, a person takes the simplest algorithms that he combines into a single plot, which will be the script of the program.  In our case, the programmer‚Äôs task is to write the logic of money transfer (points, credits) from one person to another in a web application.  Guided by logic, you can create an algorithm consisting of several checks.  Imagine that we simply removed all unnecessary and compiled pseudocode. <br><br><pre><code class="plaintext hljs"> (. &gt;= _)  .=.-_ .=.+_ ()  ()</code> </pre> <br>  But everything would be fine if everything happened in the order of the queue.  But the site can serve multiple users at the same time, and this does not happen in one stream, because modern web applications use multiprocessing and multithreading for parallel data processing.  With the advent of multithreading, a funny architectural vulnerability appeared in the programs - a race condition (or race condition). <br><br>  Now imagine that our algorithm runs simultaneously 3 times. <br><br>  Vasya still has 100 points on his balance, but somehow he turned to a web application with three threads simultaneously (with a minimum amount of time between requests).  All three streams check if the user Petya exists, and check if Vasya has enough balance to transfer.  At that moment in time when the algorithm checks the balance, it is still equal to 100. As soon as the check is passed, 100 is deducted from the current balance 3 times, and Pete is added. <br><br>  What we have?  Vasya has a minus balance on the account (100 - 300 = -200 points).  Meanwhile, Petya has 300 points, although in fact, it should be 100. This is a typical example of the exploitation of a race condition.  It is comparable with the fact that several people pass by one pass at once.  Below is a screen shot of this situation from <a href="https://habr.com/ru/users/4lemon/" class="user_link">4lemon</a> <br><br><img src="https://habrastorage.org/webt/qp/px/l2/qppxl2frreqvbhf6ehxgt0it-vi.png"><br><br>  The race condition can be both in multi-threaded applications and in the databases in which they work.  Not necessarily in web applications, for example, it is a frequent criterion for elevating privileges in operating systems.  Although web applications have their own characteristics for successful operation, which I want to talk about. <br><br><h2>  Typical operation race condition </h2><br><blockquote>  A hacker enters a hookah room, a quest and a bar, and he has race condition!  Omar Ganiev </blockquote><br>  In most cases, multithreaded software is used as a client to check / exploit race conditions.  For example, Burp Suite and its tool Intruder.  They put one HTTP request for repetition, set up many threads and include flood.  Like for example <a href="https://medium.com/%40valeriyshevchenko/how-to-check-race-conditions-in-web-applications-338f73937992">in this article</a> .  Or <a href="https://medium.com/%40ciph3r7r0ll/race-condition-bug-in-web-app-a-use-case-21fd4df71f0e">in this one</a> .  This is quite a working method, if the server allows the use of multiple threads to its resource and as written in the articles above - if it did not work out, try again.  But the fact is that in some situations, this may not be effective.  Especially if you remember how similar applications access the server. <br><br><h4>  What is there on the server </h4><br>  Each stream establishes a TCP connection, sends data, waits for a response, closes the connection, opens again, sends data, and so on.  At first glance, all data is sent at the same time, but the HTTP requests themselves may not arrive synchronously and at odds due to the transport layer, the need to establish a secure connection (HTTPS) and rezolvit DNS (not in the case of a burp) and multiple layers abstractions that pass data before being sent to the network device.  When it comes to milliseconds, this can play a key role. <br><br><h2>  HTTP pipelining </h2><br>  You can recall HTTP-Pipelining, where you can send data using a single socket.  You can see how it works by using the netcat utility (you have GNU / Linux, right?). <br><br>  <i>In fact, it is necessary to use linux for many reasons, because there is a more modern TCP / IP stack, which is supported by the operating system kernels.</i>  <i>The server is probably also on it.</i> <br><br>  For example, run the <i>nc google.com 80</i> command and insert the lines <br><br><pre> <code class="markdown hljs">GET / HTTP/1.1 Host: google.com GET / HTTP/1.1 Host: google.com GET / HTTP/1.1 Host: google.com</code> </pre><br>  Thus, within one connection, three HTTP requests will be sent, and you will receive three HTTP responses.  This feature can be used to minimize the time between requests. <br><br><h4>  What is there on the server </h4><br>  The web server will receive requests sequentially (keyword), and will process the responses in turn.  This feature can be used to attack in several steps (when it is necessary to perform two actions in a minimum amount of time) or, for example, to slow down the server in the first request in order to increase the success of the attack. <br>  The trick is that you can stop the server from processing your request by loading it with a DBMS, especially if INSERT / UPDATE is used.  Heavier requests can ‚Äúslow down‚Äù your load, thus, there will be a high probability that you will win this race. <br><br><h2>  Splitting an HTTP request into two parts </h2><br>  First, remember how an HTTP request is formed.  Well, as you know, the first line is the method, the path and the protocol version: <br><br> <code>GET / HTTP/1.1</code> <br> <br>  Next are the headers before the line break: <br><br> <code>Host: google.com <br> Cookie: a=1</code> <br>  But how does the web server know that the HTTP request has ended? <br><br>  Let's look at an example, enter <i>nc google.com 80</i> , and there <br><br> <code>GET / HTTP/1.1 <br> Host: google.com</code>  <code>GET / HTTP/1.1 <br> Host: google.com</code> , after you press ENTER, nothing will happen.  You press again - you will see the answer. <br><br>  That is, in order for the web server to accept an HTTP request, you need two line breaks.  And the correct query looks like this: <br><br> <code>GET / HTTP/1.1\r\nHost: google.com\r\n\r\n</code> <br> <br>  If this were the POST method (don't forget about the Content-Length), then the correct HTTP request would be like this: <br><br> <code>POST / HTTP/1.1 <br> Host: google.com <br> Content-Length: 3 <br> <br> a=1</code> <br> <br>  or <br><br> <code>POST / HTTP/1.1\r\nHost: google.com\r\nContent-Length: 3\r\n\r\na=1</code> <br> <br>  Try sending a similar request from the command line: <br><br><pre> <code class="markdown hljs">echo -ne "GET / HTTP/1.1\r\nHost: google.com\r\n\r\n" | nc google.com 80</code> </pre> <br>  As a result, you will receive a response, since our HTTP request is complete.  But if you remove the last character \ n, you will not get an answer. <br><br>  In fact, many web servers can be used as a transfer \ n, so it‚Äôs important not to swap \ r and \ n, otherwise further tricks may not work. <br><br>  What does this give?  You can simultaneously open multiple connections to a resource, send 99% of your HTTP request and leave the last byte unsent.  The server will wait until you get the last line feed.  After it will be clear that the main part of the data has been sent - send the last byte (or several). <br><br>  This is especially important when it comes to a large POST request, for example, when you need to upload a file.  But even in a small request it makes sense, since delivering several bytes is much faster than kilobytes of information at the same time. <br><br><h2>  The delay before sending the second part of the request </h2><br>  According to the research of <a href="https://twitter.com/leetmore">Vlad Roskov</a> , it is necessary not only to split the request, but it also makes sense to delay a few seconds between sending the main part of the data and the final one.  And all because the web server begins to parse requests before they receive it entirely. <br><br><img src="https://habrastorage.org/webt/ey/cy/pm/eycypmp2hxca1gxe_-xee3zeeh8.png"><br><br><h4>  What is there on the server </h4><br>  For example, nginx when receiving HTTP request headers will start parsing them, adding the defective request to the cache.  When the last byte arrives, the web server will take the partially processed request and send it directly to the application, thereby reducing the request processing time, which increases the likelihood of an attack. <br><br><h2>  How to deal with it </h2><br>  First of all, this is of course an architectural problem; if you design the web application correctly, you can avoid such races. <br><br>  Usually, the following methods of dealing with an attack are used: <br><br><ul><li>  Use <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B8">locks</a> . </li></ul><br>  The operation blocks in the DBMS calls to the locked object until it is unlocked.  Others are standing and waiting on the sidelines.  It is necessary to work correctly with locks, do not block anything extra. <br><br><ul><li>  Taxied <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B5%25D0%25BD%25D1%258C_%25D0%25B8%25D0%25B7%25D0%25BE%25D0%25BB%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8_%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B0%25D0%25BA%25D1%2586%25D0%25B8%25D0%25B9">transaction isolation</a> . </li></ul><br>  Ordered transactions (serializable) - ensure that transactions are executed strictly sequentially, however, this may affect performance. <br><br><ul><li>  Use <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D0%25BA%25D1%2581">mutex semaphores</a> (hehe). </li></ul><br>  Take some thing (for example etcd).  At the time of the function call, create a record with a key, if you did not manage to create a record, then it already exists and then the request is interrupted.  At the end of the request processing, the entry is deleted <br><br>  And in general, I liked the <a href="https://www.youtube.com/watch%3Fv%3DAYWiRVdJFTI">video of Ivan Zvityagi‚Äôs speech</a> about blocking and transactions, very informative. <br><br><h2>  Features of sessions in race condition </h2><br>  One of the features of the sessions may be that she herself does not allow herself to exploit the race.  For example, in PHP, after session_start (), the session file is locked, and it will be unlocked only at the end of the script (if there was no call to <a href="https://www.php.net/manual/ru/function.session-write-close.php">session_write_close</a> ).  If at this moment another script is called that uses the session, it will wait. <br><br>  To circumvent this feature, you can use a simple trick - perform authentication the necessary number of times.  If the web application allows you to create multiple sessions for a single user, simply collect all PHPSESSID and make each request its own identifier. <br><br><h2>  Proximity to the server </h2><br>  If the site on which you want to exploit the race condition is hosted by AWS - take the car in AWS.  If in DigitalOcean - take it there. <br><br>  When the task is to send requests and minimize the dispatch interval between them, close proximity to the web server will undoubtedly be a plus. <br><br>  After all, there is a difference when ping to the server 200 and 10 ms.  And if you're lucky, you can generally end up on the same physical server, then it will be a bit easier to zareys :) <br><br><h3>  Drawing the line </h3><br>  For a successful race condition, various tricks can be applied to increase the likelihood of success.  Send multiple requests (keep-alive) in one, slowing down the web server.  Split the request into several parts and create a delay before sending.  Reduce the distance to the server and the number of abstractions to the network interface. <br><br>  As a result of this analysis, we, together with Michail Badin, developed the <a href="https://github.com/racepwn/racepwn">RacePWN</a> tool <a href="https://github.com/racepwn/racepwn">.</a> <br><br>  It consists of two components: <br><br><ul><li>  The librace library in C, which in the shortest time and using most of the chips from the article sends a lot of HTTP requests to the server </li></ul><br><ul><li>  Utilities racepwn, which accepts a json configuration as input and generally drives it with this library. </li></ul><br>  RacePWN can be integrated into other utilities (for example, in Burp Suite), or you can create a web-based interface for flight management (you can‚Äôt reach it anyway).  Enjoy! <br><br>  But in fact, there is still room to grow and you can remember about HTTP / 2 and its prospects for attack.  But at the moment HTTP / 2, most resources are only up front, proxying requests to the good old HTTP / 1.1. <br><br>  Maybe you know some other details? <br><br>  <a href="https://bo0om.ru/race-condition-ru">Original</a> </div><p>Source: <a href="https://habr.com/ru/post/460339/">https://habr.com/ru/post/460339/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46032/index.html">RESTful PHP - 5 simple tips</a></li>
<li><a href="../460321/index.html">Gallery of the best notebooks for ML and Data Science</a></li>
<li><a href="../460325/index.html">Algorithm of the search engine SVLAB Search</a></li>
<li><a href="../46033/index.html">Layout of rounded borders and sharp corners</a></li>
<li><a href="../460335/index.html">Will Google Chrome stop protecting against XSS attacks?</a></li>
<li><a href="../460341/index.html">Continuing ASO: trends, ratings and a bit of feedback</a></li>
<li><a href="../460343/index.html">The story of how the development of the game has become part of my life</a></li>
<li><a href="../460345/index.html">Installing and configuring Sonata Admin on symfony 4</a></li>
<li><a href="../460347/index.html">Mobile device management and more with the Sophos UEM solution</a></li>
<li><a href="../460349/index.html">Check Point Falcon Acceleration Cards - we accelerate the processing of traffic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>