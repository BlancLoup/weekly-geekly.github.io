<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unexpected need for data versioning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the project is closer to the end of the development, it becomes clear that you cannot do without the versioning of the data, because any user can...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unexpected need for data versioning</h1><div class="post__text post__text-html js-mediator-article">  When the project is closer to the end of the development, it becomes clear that you cannot do without the versioning of the data, because any user can go in and delete what has been created for a long time by dozens of other people, you have to find a solution that requires minimal effort.  Without going into the details of a specific project on which such a need arose, imagine a google docs spreadsheets document editable to any site visitor. <br><br><a name="habracut"></a><br><br>  Suppose Google engineers are using a MySQL database with this structure: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      documents <br>  --id <br>  --name <br>  --creator_id <br><br>  sheets <br>  --id <br>  --document_id <br>  --name <br><br>  rows <br>  --number <br>  --sheet_id <br>  --height <br><br>  columns <br>  --number <br>  --sheet_id <br>  --width <br><br>  cells <br>  --id <br>  --sheet_id <br>  --color <br>  --content <br>  --row_number <br>  --col_number <br>  --creator_id <br><br>  As it was already written above, anyone has access to the document, and, for example, changing the value of a cell to a swear word will permanently destroy the previous value. <br><br><h4>  Structure requirements </h4><br><h5>  Required </h5><br><ul><li>  Ability to save previous cell values </li><li>  Ability to view previous revisions of the online document </li><li>  The ability to roll back to the previous version </li><li>  Some parameters may not have different versions (id, sheet_id) </li><li>  Implementing the used ORM </li></ul><br><h5>  Desirable </h5><br><ul><li>  Minimum possible labor for data transfer to a new structure, selection, modification and addition of data </li><li>  Saving disk space </li><li>  Highlighting changed cells when viewing old revisions </li></ul><br><br><h4>  Implementation </h4><br><br>  After much thought, the "formula" was derived.  What if you make an additional table and zadzhoyny the main table and the new table containing different versions of values. <br><br>  First of all, we need a table with revisions: <br><br>  revisions <br>  --id <br>  --parent_id <br>  --document_id <br>  --created_date <br><br>  Spreading the cells table by 2, so that the cells remain information that does not require versioning, and the cells_data - user-modified information.  In addition, we add the created_in_revision_id, deleted_in_revision_id fields to the cells_data table, and the user ID that made the changes. <br><br>  cells <br>  --id <br>  --sheet_id <br>  --row_number <br>  --col_number <br>  --creator_id <br><br>  cells_data <br>  --cell_id <br>  --color <br>  --content <br>  --data_creator_id <br>  --created_in_revision_id <br>  --deleted_in_revision_id <br>  (primary key on cell_id + created_in_revision_id) <br><br>  In the code for the Document object (if we program objectally) we add the getRevisionCondition method ($ revisionId = false), which should return a prefix to the SQL Quarae like "created_in_revision_id in (0,100,300,301) and deleted_in_revision_id not in (0,100,300,301)".  Those.  contain the current revision and all its parentes in the ‚Äúin (...)‚Äù and ‚Äúnot in (...)‚Äù construction <br><br><h5>  Sample </h5><br>  Next kvar, which previously looked like this: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cells <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> row_number=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> col_number=<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  turns into: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.*,cd.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cells c,cells_data cd <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> row_number=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> col_number=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=cell_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $revisionCondition</code> </pre> <br>  Of course, the field names of these tables should not be duplicated. <br><br><h5>  Insert a new entry </h5><br>  Here everything is as simple as when sampling.  Check if the revision has expired and take the last one.  For example: <br><pre> <code class="php hljs">$revision=$document-&gt;updateRevisionIfExpired()</code> </pre> <br>  We first insert into the main table (cells), then into the table with versioned data (cells_data).  In the created_in_revision_id field, we write the ID of the last revision. <br><br><h5>  Delete record </h5><br>  Here we will try to save disk space.  If, for example, we set 30 minutes as the revision lifetime, then we compare the revision of the deleted record with the current revision and: <br><ul><li>  if they are the same, just delete from the database </li><li>  if the revision has already been changed, then we just write a fresh revision id in the table field cells_data - deleted_in_revision_id </li></ul><br>  For node.js, it would look like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cellRevisionId==currentRevision.getId()){ db.online.query(<span class="hljs-string"><span class="hljs-string">"delete from cells_data where cell_id="</span></span>+cellId+<span class="hljs-string"><span class="hljs-string">" and created_in_revision_id="</span></span>+cellRevisionId) }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ db.online.update(<span class="hljs-string"><span class="hljs-string">'cells_data'</span></span>,{<span class="hljs-string"><span class="hljs-string">'deleted_in_revision_id'</span></span>:currentRevision.getId()},{<span class="hljs-string"><span class="hljs-string">'cell_id'</span></span>: cellId, <span class="hljs-string"><span class="hljs-string">'created_in_revision_id'</span></span> : cellRevisionId}) }</code> </pre><br><h5>  Record Update </h5><br>  Changing data is something like deletion.  If the revision has not changed, the data is simply updated; if it has changed, the deleted_in_revision_id field is updated and a new record is inserted into the cells_data table with the ID of the new revision created_in_revision_id. <br><br><h4>  Instead of conclusion </h4><br>  Because  Most of the tables that need versioning have now been transferred to a new structure - I can highlight advantages and disadvantages: <br><br><h5>  Virtues </h5><br><ul><li>  All selections and insertions (in other words, selects and inserts) were redone as quickly as possible and without any complications. </li><li>  Does everything that was required and almost everything that was desired. </li></ul><br><h5>  disadvantages </h5><br><ul><li>  Deleting, updating the record still happens a little too tightly wound and a more automated script would not hurt </li><li>  Perhaps you need to do something with requests like in (...) and not in (...), since  they list all revisions for the document </li></ul></div><p>Source: <a href="https://habr.com/ru/post/136202/">https://habr.com/ru/post/136202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136195/index.html">The thinnest Toshiba Excite X10 tablet and 4 brothers under glass. Video</a></li>
<li><a href="../136196/index.html">Sony's Google TV Preview</a></li>
<li><a href="../136197/index.html">CES 2012 // Fujifilm X-Pro1</a></li>
<li><a href="../136199/index.html">Oatmeal - The Pros and Cons of the Pros and Cons Lists</a></li>
<li><a href="../136201/index.html">CES 2012 // Fujitsu Arrows X</a></li>
<li><a href="../136203/index.html">WAW - Words do not need to be conveyed by the senses</a></li>
<li><a href="../136205/index.html">Configuring Squid 3 + QuintoLabs Content Security 1.4 and Integration with Active Directory</a></li>
<li><a href="../136206/index.html">At first they don't notice you, then they laugh at you, then they fight with you. And then you win. Mahatma Gandhi</a></li>
<li><a href="../136209/index.html">CyberPlat has closed acceptance of credit cards from abroad</a></li>
<li><a href="../136210/index.html">Why C is faster than Java (from the perspective of a Java developer)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>