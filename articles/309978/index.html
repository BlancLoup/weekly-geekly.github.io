<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One-way data binding with ECMAScript-2015 Proxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, habravchane. Today we will create a data warehouse with the function of one-way data binding using Proxy and some other ECMAScript 2015 buns...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One-way data binding with ECMAScript-2015 Proxy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d72/8cd/383/d728cd38361a4395994259f034d0c9c3.jpg"><br><br>  Good day, habravchane.  Today we will create a data warehouse with the function of one-way data binding using Proxy and some other ECMAScript 2015 buns. <br><br><h3>  What is a proxy? </h3><br>  Simply put, a proxy is a <s>wrapper</s> object that allows you to intercept a call to the object on the basis of which it was created.  To intercept appeals, a proxy <s>armed with an arsenal of traps</s> has several functions of interceptors.  Full information about the list of interceptors and all methods of proxy can be found <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What do we do? </h4><br>  We implement object storage with change tracking functionality using a proxy, i.e.  some semblance of the late Oo with some extra buns. <br><br>  So let's go ... <br><a name="habracut"></a><br><h4>  For work </h4><br>  We imply that our repository is an instance of a certain storage factory class. <br><br><pre><code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">"use strict"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OS</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    } window.ObserveStorage = new OS();</span></span></code> </pre> <br>  Everything that happens in the future will occur within the OS class. <br><br>  Our repository should have the following data structure: <br><br><pre> <code class="javascript hljs">{  : {  :    }  :{  :{   :{ id :  } } } }</code> </pre> <br>  Accordingly, in order to implement all the necessary functionality, we define in the designer objects for storing data: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OS</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//   this.listeners = new Map(); //   this.serviceField = new Set([`on`, 'un']); //‚Äù‚Äù , ..    . } }</span></span></code> </pre> <br>  I will intentionally omit the description of the <i>Map</i> and <i>Set</i> classes.  In case you want to know about them in detail, then you are <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">here</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set">here</a> . <br><br>  The <i>serviceField</i> field <i>is</i> necessary in order to exclude the possibility of rewriting or busting service ones, but more on that later. <br><br>  The next step is to organize adding a new object to our repository. <br><br>  Having an object: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> object = {<span class="hljs-attr"><span class="hljs-attr">key1</span></span>: ‚Äùdata‚Äù, <span class="hljs-attr"><span class="hljs-attr">key2</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre> <br>  implement the following method of adding an object to the repository: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> wrapper = ObserveStorage.add(key, object); <span class="hljs-comment"><span class="hljs-comment">//return Proxy</span></span></code> </pre> <br><br>  The first parameter we will define the key under which the object will be recorded in the storage, and the second - the object itself.  At the output we get the proxy wrapper of the base object. <br><br>  In advance, we mean that not all users will be interested in the functionality of receiving an object from the storage, and monitoring all keys is not always convenient, so this entry will be valid as well: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> wrapper = ObserveStorage.add(object);</code> </pre> <br>  Since we use different keys and id, we make a simple method for generating them. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> __getId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">Math</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.random().toFixed(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">10</span></span></span></span><span class="hljs-string"><span class="hljs-subst">).toString().replace(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0."</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">""</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">Date</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.now()}</span></span></span><span class="hljs-string">`</span></span>) }</code> </pre> <br>  Now that we have defined the interface and have a tool for generating various kinds of identifiers, we can start developing the method. <br><br><pre> <code class="javascript hljs">add(...arg) { <span class="hljs-comment"><span class="hljs-comment">//    1  2  let key, object; if(arg.length == 1){ [object] = arg; key = OS.__getId(); //  id } else [key, object] = arg; //       ,  ,    ,  . //      ,     . // 1)     : if (this.storage.has(key)) { throw new Error(`key ${key} is already in use`); } // 2)     () ,     ,     (:  ,    ,      ‚Äì      ): let self = this; object.on = (...arg)=&gt; self.on(key, ...arg); //  object.un = (...arg)=&gt; self.un(key, ...arg); //  //        storage const proxy = this.getProxy(key, object); //return Proxy //    Map  this.listeners.set(key, new Map()); //, ,     this.storage.set(key, proxy); // ,     ,     return proxy; }</span></span></code> </pre> <br>  The <i>getProxy</i> method remained <i>undisclosed</i> , I don‚Äôt know about you, but I hate secrets.  Therefore, let's go: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// getProxy  2 , 1 ‚Äì  ,    ,  2 ‚Äì   . getProxy(key, object){ let self = this; //    ,      return new Proxy(object, { //       get(target, field) { return target[field]; }, //       set(target, field, value) { // ,       if(self.serviceField.has(field)) throw new Error(`Field ${field} is blocked for DB object`); const oldValue = target[field]; target[field] = value; //       fire  OS. self.fire(key, { type: oldValue ? "change" : "add", property: field, oldValue: oldValue, value: value, object: self.get(key) }); //       , ,           Oo,    -  . return true }, //     deleteProperty(target, field) { //       if (!field in target || self.serviceField.has(field)) { return false; } const oldValue = target[field]; delete target[field]; self.fire(key, { type: "delete", property: field, oldValue: oldValue, value: undefined, object: self.get(key) }); return true; }, //  Object.getOwnPropertyNames() ,         ‚Äú‚Äù      ownKeys(target) { let props = Object.keys(target) .filter(function (prop) { return !(self.serviceField.has(prop)); }); return props; } } ); }</span></span></code> </pre> <br>  It is important to note that when generating an event <br><br><pre> <code class="javascript hljs">self.fire(key, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: oldValue ? <span class="hljs-string"><span class="hljs-string">"change"</span></span> : <span class="hljs-string"><span class="hljs-string">"add"</span></span>, <span class="hljs-attr"><span class="hljs-attr">property</span></span>: field, <span class="hljs-attr"><span class="hljs-attr">oldValue</span></span>: oldValue, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: value, <span class="hljs-attr"><span class="hljs-attr">object</span></span>: self.get(key) });</code> </pre> <br>  The object is not the <i>target</i> , but the wrapper.  This is necessary so that the user, while changing the object in the <i>callback</i> , does not make any untraceable changes.  Initially, I passed a copy of the object there, which, in fact, is also not very good.  In the block above, methods such as .get and .fite were lit up, so, following in order, let's talk about them. <br><br>  The .get method only checks for the presence of an object in the repository and returns it. <br><br><pre> <code class="javascript hljs">get(key) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage.has(key)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storage.get(key); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.warn(<span class="hljs-string"><span class="hljs-string">`Element </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${key}</span></span></span><span class="hljs-string"> is not exist`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; } }</code> </pre><br>  Before talking about the .fire method, it‚Äôs worth mentioning the event subscription.  The subscription uses the following interface: <br><br><pre> <code class="javascript hljs">wrapper.on(callback, property = <span class="hljs-string"><span class="hljs-string">"*"</span></span>);</code> </pre> <br>  Where <br><br><pre> <code class="javascript hljs">property = <span class="hljs-string"><span class="hljs-string">"*"</span></span></code> </pre> <br>  is the default value and indicates a subscription to all fields of this object. <br><br>  For example: <br><br><pre> <code class="javascript hljs">wrapper.on(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(event)), <span class="hljs-string"><span class="hljs-string">"value"</span></span>); wrapper.data = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   wrapper.value = 2; // Object{"type":"change","property":"value","oldValue":4,"value":2,"object":{"data":"test","value":2}} wrapper.on(event =&gt; console.log(JSON.stringify(event)), "*"); wrapper.data = "test"; // Object{"type":"change","property":"data","oldValue":‚Äùtext‚Äù,"value":‚Äùtest‚Äù,"object":{"data":"test","value":1}}</span></span></code> </pre><br>  We integrate this method into the object at the time the object is written to the storage (see above).  The method itself is the following function: <br><br><pre> <code class="javascript hljs">on(key, callback, property = <span class="hljs-string"><span class="hljs-string">"*"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   callback   if (!key || !callback) { throw new Error("Key or callback is empty or not exist"); } // Map     const listeners = this.listeners.get(key), //  id    subscriptionId = OS.__getId(); //  ,     ,    ,      Map !listeners.has(property) &amp;&amp; listeners.set(property, new Map()); //        id listeners .get(property) .set(subscriptionId, callback); //  id     return subscriptionId; }</span></span></code> </pre> <br>  We pay special attention to the first parameter of the .on method.  Attentive ones noticed that 1 or 2 parameters are passed, but the method expects 3, one of which is the key. <br><br>  And especially attentive ones remember that we locked the key in the method at the moment of initialization of the object in the repository, namely in the line: <br><br><pre> <code class="javascript hljs">object.on = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...arg</span></span></span><span class="hljs-function">)=&gt;</span></span> self.on(key, ...arg);</code> </pre> <br>  To unsubscribe, you must use the subscription Id received during the subscription. <br><br><pre> <code class="javascript hljs">wrapper.un(subscriptionId);</code> </pre> <br>  Function Description: <br><br><pre> <code class="javascript hljs">un(key, subscriptionId) { <span class="hljs-comment"><span class="hljs-comment">//    ,   if (!key) { throw new Error("Key is empty or not exist"); } //     const listeners = this.listeners.get(key); if (listeners) //      Map for (let listener of listeners.values()) { //        if (listener.delete(subscriptionId)) return true; } return false; }</span></span></code> </pre> <br>  I like the use of id for various kinds of operations, since it allows you to clearly identify user actions in a fairly transparent form. <br><br>  And so, we got to the method call .fire, which pulls all the callback hung on the wrapper: <br><br><pre> <code class="javascript hljs">fire(key, event) { <span class="hljs-comment"><span class="hljs-comment">//   let listeners = this.listeners.get(key) ,property = event.property; //    listeners.has(property) &amp;&amp; this.fireListeners(event, listeners.get(property)); //    listeners.has("*") &amp;&amp; this.fireListeners(event, listeners.get("*")); }</span></span></code> </pre> <br>  The fireListeners method is transparent and does not need to be explained: <br><br><pre> <code class="javascript hljs">fireListeners(event, listeners) { listeners.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">listener</span></span></span><span class="hljs-function">)=&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">=&gt;</span></span> listener(event), <span class="hljs-number"><span class="hljs-number">0</span></span>); }) }</code> </pre> <br><h4>  Summing up </h4><br>  Thus, we wrote our data warehouse for only 150 lines of code, while still being able to subscribe to object changes.  Following the legacy of Oo, we do not currently wrap nested objects and do not process arrays, but all this can be done with the proper desire. <br><br>  The full code can be found <a href="https://github.com/sinires/Observe-storage">here</a> . <br><br>  Has been with you, <a href="https://habrahabr.ru/users/sinires/" class="user_link">sinires</a> . <br>  Good to you, earthlings. </div><p>Source: <a href="https://habr.com/ru/post/309978/">https://habr.com/ru/post/309978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309968/index.html">Why I refused to Rust</a></li>
<li><a href="../309970/index.html">How we helped to return to the client 60 thousand dollars accrued for international communication</a></li>
<li><a href="../309972/index.html">Communication opportunities of Internet projects</a></li>
<li><a href="../309974/index.html">Apple Pay will be available in Russia this fall.</a></li>
<li><a href="../309976/index.html">Difficult quest for habravchan: 25 levels</a></li>
<li><a href="../309980/index.html">Automatic deployment of the ElasticBeanstalk application using Bitbucket Pipelines</a></li>
<li><a href="../309984/index.html">Comparison of EDS available on the Kazakhstan market</a></li>
<li><a href="../309986/index.html">Reaching goals: 9 life hacking from SmartProgress</a></li>
<li><a href="../309988/index.html">Keen observer</a></li>
<li><a href="../309990/index.html">The architecture of the network core in the iOS application on Swift 3. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>