<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go application development: logic reuse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my opinion, writing libraries on Go is a fairly well-lit topic ... but there are much less about writing applications (teams) of articles. When it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go application development: logic reuse</h1><div class="post__text post__text-html js-mediator-article"><p>  In my opinion, writing libraries on Go is a fairly well-lit topic ... but there are much less about writing applications (teams) of articles.  When it comes to this, all the code on Go is a command.  So let's talk about it!  This post will be the first in the series, because  I have a lot of information that I have not yet shared. </p><br><p>  In today's article we will focus on the basic layout of the project, we will improve the reuse and test code. </p><a name="habracut"></a><br><p>  When I develop not a library, but a program, I have three unique code organization rules: </p><br><h2 id="paket-main">  Main package </h2><br><p> This is the only package in the Go program that must be available.  In addition to instructing the <code>go</code> tool to create an executable file, this package has another unique thing ‚Äî you cannot import code from it.  This means that any code you put into the <code>main</code> package cannot be used directly by another project, and this upsets the gods of open source software.  Since one of the main reasons why I am writing open source projects is that other developers can use it, this inability to reuse the code from <code>main</code> against my wishes. </p><br><p>  Many times there were situations when I thought: "I would use the logic of program X in my code."  But if the logic was in the <code>main</code> package, it was impossible. </p><br><h2 id="osexit">  os.Exit </h2><br><p>  If you care about creating a program that does exactly what the user expects, then you should take care of what exit code it ends with.  The only way to do this is to call <code>os.Exit</code> (or call something that calls <code>os.Exit</code> , for example <code>log.Fatal</code> ). </p><br><p>  However, you cannot test the function that calls <code>os.Exit</code> .  Why?  Because the <code>os.Exit</code> call during the execution of the test <em>will lead to the termination of the application under test</em> .  It is quite difficult to detect if you got it by chance (I know this from personal experience).  When you start testing, no testing actually takes place, these tests simply end earlier than they should have, and all you have to do is scratch your head. </p><br><p>  The simplest thing to do is <em>not to call <code>os.Exit</code></em> .  Most of your code in any case should not call <code>os.Exit</code> ... someone can really "go to the roof" if he imports your library, and it will randomly, under certain conditions, stop its application. </p><br><p>  Thus, call <code>os.Exit</code> exactly one place, as close as possible to the "appearance" of your application, with the minimum number of entry points.  By the way, let's talk about them ... </p><br><h2 id="func-main">  func main () </h2><br><p>  This is the only function any Go program should have.  You probably think that every <code>main</code> function should differ from program to program, since all programs are different, right?  Well, it turns out, if you really want to make your code testable and reusable, there is, by and large, only one correct answer to the question "what is in your main function?" </p><br><p>  Looking ahead, I think that there is also only one correct answer to the question "what is in your main package?"  and this answer looks like this: </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// command main documentation here. package main import ( "os" "github.com/you/proj/cli" ) func main() { os.Exit(cli.Run()) }</span></span></code> </pre> <br><p>  That's all.  This is the most minimal code that should be in your useful <code>main</code> package.  We spent almost no effort on code that others cannot reuse.  At the same time, we isolated <code>os.Exit</code> in a single-line function, which is the outermost part of our project and, in fact, does not need to be tested. </p><br><h2 id="shema-proekta">  Project outline </h2><br><p>  Let's take a look at the overall design of the project: </p><br><pre> <code class="bash hljs">/home/you/src/github.com/you/proj $ tree . ‚îú‚îÄ‚îÄ cli ‚îÇ ‚îú‚îÄ‚îÄ parse.go ‚îÇ ‚îú‚îÄ‚îÄ parse*test.go ‚îÇ ‚îî‚îÄ‚îÄ run.go ‚îú‚îÄ‚îÄ LICENSE ‚îú‚îÄ‚îÄ main.go ‚îú‚îÄ‚îÄ README.md ‚îî‚îÄ‚îÄ run ‚îú‚îÄ‚îÄ command.go ‚îî‚îÄ‚îÄ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>*test.go</code> </pre> <br><p>  We already know what we have in <code>main.go</code> ... and, in fact, <code>main.go</code> is the only go file in the <code>main</code> package.  The <code>LICENSE</code> and <code>README.md</code> files are <code>LICENSE</code> explanatory.  (Always indicate the license! Otherwise, many people will not be able to use your code.) </p><br><p>  Now we go to two subdirectories - <code>run</code> and <code>cli</code> . </p><br><h2 id="cli">  CLI </h2><br><p>  The <code>cli</code> package contains the command line parsing logic.  Here you define the interface (UI) of your program.  The package contains the analysis of flags, the analysis of arguments, help texts and so on. </p><br><p>  It also contains the source code, which returns the exit code for the <code>main</code> function (which passes it to <code>os.Exit</code> ).  That way, you can test the exit codes returned by these functions, instead of trying to test the exit codes of your program as a whole. </p><br><h2 id="run">  Run </h2><br><p>  If the <code>main</code> and <code>cli</code> are the "bones" of the logic of your program, then the <code>run</code> package contains its "meat".  You should write this package as if it were a separate library.  During its development, you should not think about CLI, flags, and the like.  The packet should receive the structured data and return errors.  Imagine that it might be called by another library, or a web service, or someone else‚Äôs program.  Make as few assumptions as possible about how it will be applied ... well, it should be a regular library. </p><br><p>  Obviously, larger projects will require more than one directory.  In fact, you can divide your logic into separate repositories.  It depends on how likely you think that other people will want to reuse your logic.  If you think this is very likely, I recommend implementing the logic in a separate directory (repository).  In my opinion, a separate directory for logic requires more quality and stability than some random directory, hidden somewhere deep in the repository. </p><br><h2 id="sobiraem-vse-vmeste">  Putting it all together </h2><br><p>  The <code>cli</code> package forms the command line interface for the logic implemented in the <code>run</code> package.  If someone sees your program and wants to use its web API logic, they will just need to import the <code>run</code> package and use this logic directly.  Similarly, if someone doesn‚Äôt like your command line parameters, they can simply write their own argument parser and use it as an interface to the <code>run</code> package. </p><br><p>  This is what I mean when it comes to code reuse.  I don‚Äôt want anyone to ‚Äúhack‚Äù pieces of my code to use it more.  And the best way to facilitate code reuse is to separate the interface from the logic.  This is the key part.  <strong>Do not let ideas from your interfaces (UI / CLI) leak into the logic</strong> .  This is the best way to keep logic in a general form, and the interface is manageable. </p><br><h2 id="bolee-krupnye-proekty">  Larger projects </h2><br><p>  This scheme is good for small and medium projects.  There is a single program that is in the root of the repository, so it is easier to get (go-get) than if it were in several subdirectories.  In large projects, things can be completely different.  There may be several executable files, but they cannot all lie in the root of the repository.  However, such projects usually have custom assembly steps and require more than just go-get (which I will discuss later). </p><br><p>  Details will be soon. </p><br><p>  <em>October 18, 2016</em> </p><br><p>  <strong>Series: Go application development.</strong> </p><br><p>  <em>Note: the series as such has not happened, this is the only article in the ‚Äúseries‚Äù since its publication.</em>  <em>However, the article is quite interesting.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325454/">https://habr.com/ru/post/325454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325444/index.html">WebRTC video chat development between iOS, Android and browser</a></li>
<li><a href="../325446/index.html">Scala: parser combinators on the example of the formula parser</a></li>
<li><a href="../325448/index.html">The holy family of information technology (April theses in the form of critical criticism)</a></li>
<li><a href="../325450/index.html">We set up a free build for writing and debugging programs for microcontrollers based on the ARM kernel under Windows 10</a></li>
<li><a href="../325452/index.html">PHP: Storing sessions in protected cookies</a></li>
<li><a href="../325456/index.html">Create a bot for Skype. Step by step through REST API and in Python</a></li>
<li><a href="../325458/index.html">Secure access from anywhere in the world using Microsoft DirectAccess and Windows To Go. Part One - Theory</a></li>
<li><a href="../325460/index.html">Product Design Digest March 2017</a></li>
<li><a href="../325462/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ256 (March 27 - April 2, 2017)</a></li>
<li><a href="../325464/index.html">Vector pictures with gradient in Android 5.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>