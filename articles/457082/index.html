<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Imperceptible issuance of administrator rights</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All with Friday, friends. Today we are sharing with you one more material that was translated on the eve of the launch of the course ‚ÄúReverse Engineer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Imperceptible issuance of administrator rights</h1><div class="post__text post__text-html js-mediator-article">  All with Friday, friends.  Today we are sharing with you one more material that was translated on the eve of the launch of the course <a href="https://otus.pw/j9xR/">‚ÄúReverse Engineering‚Äù</a> . <br><br><img src="https://habrastorage.org/webt/cv/me/5s/cvme5snsza_im0wjpdevttzzcz4.png"><br><br>  I had a cool idea how to force a user to run your application without social engineering or using third-party exploits.  Then you can simply move forward and initiate a massive infection of executable files, but this can cause many unforeseen problems, and will also mean that applications with digital signatures from trusted vendors will appear as unreliable files.  A good idea would be to ‚Äúcapture‚Äù just one dll.  I will not call this method the UAC (User account Control) bypass, because you still need to get permission to launch the application (just not yours). <br><a name="habracut"></a><br><h2>  LoadLibrary </h2><br>  You may already be familiar with this concept, but I will still explain what it is.  When an application calls LoadLibrary in a dll, but does not provide the full path to the file, the system first checks the KnownDlls registry key in which it searches for the path, if it is not there, the system will search in the directory from which the application was executed, and then look for in system paths such as system32 / syswow64. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can easily put your dll in the same directory as the application, and give it the same name as a normally loaded system dll, but in any case, your dll must meet the following requirements: <br><br><ul><li>  The application must load the dll by name, not the full path (as is often the case); </li><li>  The required library should not exist in HKLM \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ KnownDLLs; </li><li>  Your dll must match the processor architecture (remember that 64-bit processors will simply skip 32-bit libraries and vice versa); </li><li>  The library is in System32 or Syswow64, since specific paths often do not work. </li></ul><br>  The ZeroAccess virus used this method to take advantage of "social engineering" and force the user to run the file.  To begin with, the Adobe Flash installer was downloaded from the official, the bot dll was written to the same directory where the installer was located, and then the installer was launched.  When the installer is executed, the user account control reports that the application is delivered by a trusted source ‚ÄúAdobe Systems Incorporated‚Äù, and the user is most likely to install this application (this causes the bot to execute a malicious dll). <br><br><img src="https://habrastorage.org/webt/nv/9y/me/nv9ymec9x5znwvun7_kiiihga6a.png"><br>  <i>Is this a true flash player update?</i>  <i>Or ZeroAccess?</i>  <i>Nobody knows.</i> <br><br><h2>  Less invasive method </h2><br>  Imagine that there is a folder in which there are 90% of applications that require elevated account rights, and that it is writable without such rights.  Well, this folder exists and it is the <code>%userprofile%Downloads</code> folder.  You probably understand what I'm getting at. <br><br>  I did not expect to find the dll, which is loaded by most applications and meets all the criteria of the malicious dll, and after about five minutes of searching, I found a gold mine: <code>dwmapi.dll</code> .  This library not only met all the criteria, but also downloaded all the installation files.  Now let's create our own dll, call it <code>‚Äúdwmapi.dll‚Äù</code> , place it in the Downloads folder and run the installation file. <br><br><img src="https://habrastorage.org/webt/8w/qr/2u/8wqr2u8hmdbdwm4nkuzb81leen4.png"><br><br>  Success!  But the fact is that as soon as we start the installation, it will not work, since we have replaced an important library, but this is easy to fix.  We infect dll. <br><br><h2>  Creating a DLL infector </h2><br>  At first, I just wanted to add a new section header, change the NumberOfSections field in the PE header, and then just add my section to the end of the PE file.  It turned out that immediately after the last section header there is a directory of the related import, which will be overwritten by our section header.  Therefore, after about 2 hours of writing an application to restore the entire PE from scratch, someone reminded me that the associated import directory exists only to speed up the loading of imported files and can be overwritten and then simply disabled in the PE header. <br><br>  For the next 15 minutes, I held CTRL + Z to go back to where I started and felt silly.  After two lines of code, my infector earned as it should, and I could move on to the next step.  Now the infector simply disables and overwrites the directory of the associated import with a new section header, adds a new section to the end of the RE file, adjusts the SizeOfImage to accommodate the new section, and then changes the AddressOfEntryPoint to point to our new section. <br><br>  All we need now is the code that we put there. <br><br><h2>  Shell code </h2><br>  The obvious choice was to force the added partition to execute the shellcode, so we don‚Äôt need to worry about relocation and import.  The actual code is fairly simple and written using some convenient FASM macros, I will quickly go over how it works. <br><br><ul><li>  The stack is checked to ensure that dwmapi.dll was caused by DLL_PROCESS_ATTACH; </li><li>  The Ldr PEB structure is used to get the base address of Kernel32 and Ntdll; </li><li>  A simple implementation of GetProcAddress is used to import the following functions: NtOpenProcessToken, NtQueryInformationToken, NtClose, ExpandEnvironmentStringsA, CreateProcessA; </li><li>  The current process token opens and the code requests it to confirm that the application you are running from has UAC administrator rights; </li><li>  The path to cmd.exe is obtained, and then the command line is invoked; </li><li>  Execution is transferred back to the real entry point dwmapi.dll, which is why execution can continue. </li></ul><br><h2>  Let's put it all together </h2><br>  The final result of the work infects dwmapi.dll with our shellcode and places it in the downloads folder as soon as the user downloads and launches an installer that requires administrator rights, a command line running as an administrator will be called (due to Wow64FsRedirect and the fact that most of the settings work under wow64, we can use the same code on 32-bit and 64-bit Windows systems). <br><br>  You can find the full infector and shellcode on my github: <a href="https://github.com/MalwareTech/UACElevator">https://github.com/MalwareTech/UACElevator</a> . <br><br>  That's all.  See you on the course! </div><p>Source: <a href="https://habr.com/ru/post/457082/">https://habr.com/ru/post/457082/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457070/index.html">Textolite instead of cardboard. A couple of words about the interactive badge OFFZONE 2019</a></li>
<li><a href="../457072/index.html">How to solve the old problem with ML in Python and .Net</a></li>
<li><a href="../457074/index.html">Evolution of developers: what games to expect in the future</a></li>
<li><a href="../457078/index.html">How to turn your avatar in Telegram into a clock</a></li>
<li><a href="../45708/index.html">Software self motivation</a></li>
<li><a href="../457084/index.html">How to live with professional lighting. Videos from Badoo Techleads Meetup # 4</a></li>
<li><a href="../457086/index.html">Architectural template "Builder" in the universe "Swift" and "iOS" / "macOS"</a></li>
<li><a href="../457090/index.html">Security Cheat Sheets: JWT</a></li>
<li><a href="../457092/index.html">We study MITER ATT & CK. Mobile Matrices: Device Access. Part 5</a></li>
<li><a href="../457096/index.html">We free our hands to several analysts: API Livy to automate typical banking tasks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>