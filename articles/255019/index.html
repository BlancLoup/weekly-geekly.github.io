<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Clouds - white-manned horses or secure ownCloud for ‚Äúsmall‚Äù ones in FreeNAS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ownCloud , according to Wikipedia, is a Free and open web application for data synchronization, file sharing and remote storage of documents in the ‚Äúc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Clouds - white-manned horses or secure ownCloud for ‚Äúsmall‚Äù ones in FreeNAS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/26c/de9/5b3/26cde95b370af67ae80dbc34b2a76543.jpg" alt="image"><br>  <b>ownCloud</b> , according to Wikipedia, is a Free and open web application for data synchronization, file sharing and remote storage of documents in the ‚Äúcloud‚Äù.  And, as it seems to me, quite an interesting solution for organizing your own home cloud. <br><br>  However, ownCloud, which is installed as a plug-in on <b>FreeNAS</b> , and just out of the box, has several disadvantages that I would like to get rid of even when using at home: <br><ul><li>  First, it is installed in conjunction with <b>SQLite</b> , which is suitable only if you have a small number of files and users, and absolutely not suitable if you plan to synchronize with the help of the client.  In my case, the repository has already spilled over almost 5Tb and the ownCloud installed in this way simply refused to see some of the files.  And without synchronization, the return from the cloud is not great.  <b>Replace the database with MariaDB</b> . </li><li>  Secondly, there is no work on https, but I do not like the idea that someone can intercept my files.  Enable https. </li><li>  Thirdly, there is absolutely no protection against the banal password selection by the brute force method.  Defend against brute force with fail2ban. </li><li>  Fourthly, I am too lazy to often look through the logs for hacking, but I really want to quickly find out about such attempts.  Set up push notifications about password guessing using the pushover.net service. </li></ul><br><a name="habracut"></a><br>  I want to immediately make a reservation.  I am not an IT specialist, I am only a project manager in one of the Russian system integrators, and this ‚Äúinstruction‚Äù was born in attempts to configure all 4 specified points on my home system, FreeNAS, working from Esxi.  The instruction is written by a newbie for beginners, so if there are obvious blunders or errors in commands and configs somewhere, then please indicate them in the comments. <br><br>  All the settings will be done from the console, handles, as close as possible to how this, as I see it, make "adult" IT people. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>1 Preparing Jail for ownCloud</b> </h5><br><h6>  <b>1.1 Create Jail</b> </h6><br>  I will not describe this step.  If you managed to install FreeNAS and it works for you, then you should have no problems with this step.  Creating the first jail can take quite a long time. <br><br><h6>  <b>1.2 Open SSH access to this Jail</b> </h6><br>  It is most convenient to perform further configuration not through a web terminal, but through a full-fledged terminal program.  For example, <b>putty</b> .  To do this, open <b>SSH</b> access to our <b>Jail</b> and create a new user, from which we will carry out further configuration. <br><br>  Select the Jail created by us in the <b>FreeNAS</b> web-interface and click the <b>Shell</b> button below. <br><br><img src="https://habrastorage.org/files/be2/2f0/195/be22f0195c634c698235afdff463cd53.png" alt="image"><br><br>  In the web console Jail enter: <br><br><pre><code class="dos hljs"># sysrc sshd_enable="YES"</code> </pre> <br>  Start the daemon for <b>ssh</b> to work: <br><br><pre> <code class="dos hljs"># service sshd <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre><br>  Create a user on behalf of which we will then configure our system.  The user will have <b>superuser</b> privileges, for which we will include him in the <b>wheel</b> group. <br><br><pre> <code class="dos hljs"># adduser</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Adduser settings</b> <div class="spoiler_text"><blockquote><br>  <b>Usrname:</b> New user on whose behalf we will perform all manipulations in the terminal.  Enter, for example, <b>superstepa</b> . <br>  <b>Full name: The</b> full name of this user.  Enter, for example, <b>Dyadya Stepa Policeman</b> . <br>  <b>Uid (Leave empty for default):</b> Well, if asked to leave empty, then do so.  Feel free to press <b>Enter</b> . <br>  <b>Login group [superstepa]:</b> We want our user to have all the rights of the local administrator - superuser, and therefore include it in the <b>wheel</b> group. <br>  <b>Login group is wheel.</b>  <b>Invite superstepa into other groups?</b>  <b>[]:</b> Press <b>Enter</b> . <br>  <b>Login class [default]:</b> Click <b>Enter</b> . <br>  <b>Shell (sh csh tcsh git-shell nologin) [sh]: Leave the</b> default sh.  Just hit <b>Enter</b> . <br>  <b>Home directory [/ home / superstepa]:</b> And again <b>Enter</b> . <br>  <b>Home directory permissions (Leave empty for default):</b> <b>Enter</b> again. <br>  <b>Use password-based athentications?</b>  <b>[yes]:</b> We want this user to authenticate with a password?  Of course yes!  Hit <b>Enter</b> . <br>  <b>Use an empty password?</b>  <b>(yes / no) [no]:</b> We are for security and do not want a new user with superuser rights to have an empty password.  So again press <b>Enter</b> . <br>  <b>Use a random password?</b>  <b>(yes / no) [no]:</b> I'm just sure that the password we invented is the most reliable.  And we want to use it.  And therefore <b>Enter</b> . <br>  <b>Enter password:</b> Yeah, and here he is.  Enter your password. <br>  <b>Enter password again: Enter</b> it again. <br>  <b>Lock out the account after creation?</b>  <b>[no]:</b> No, you do not need to block this account.  <b>Just Enter</b> . <br>  <b>OK?</b>  <b>(yes / no):</b> Whether we check everything is correct and, if so, then <b>yes</b> . <br>  <b>Add another user?</b>  <b>(yes / no):</b> We don‚Äôt need other users.  <b>No.</b> <br></blockquote></div></div><br><h5>  <b>2 Installation and preparation for work ownCloud</b> </h5><br>  We join with the help of the terminal program to our Jail. <br>  Enter the name of the user created by us and his password. <br>  At the command prompt <b>$,</b> we write <b>su</b> .  Now the command line prompt will change to something like <b>root @ ownCloud: / usr / home / superstepa #</b> , and all our commands will be executed on behalf of the superuser. <br>  To simplify, I will denote the command line prompt with the <b>#</b> symbol, and my comments, which need not be entered, will start with <b>//</b> . <br><br><h6>  <b>2.1 Install the necessary packages</b> </h6><br>  First we update the current packages: <br><br><pre> <code class="dos hljs"># pkg upgrade</code> </pre><br>  Then we install the packages required for ownCloud operation (we answer <b>yes</b> to all questions that arise): <br><br><pre> <code class="dos hljs"># pkg install mariadb100-server php56-extensions php56-bz2 php56-curl php56-exif php56-fileinfo php56-gd php56-mbstring php56-mcrypt php56-pdo_mysql php56-openssl php56-zip php56-zlib pecl-APCu pecl-intl</code> </pre><br>  In order to enable work on <b>https</b> , we collect with the packages we need, and then install the <b>nginx</b> web server from the ports: <br><br><pre> <code class="dos hljs"># portsnap fetch extract //    ,      # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/www/nginx &amp;&amp; make config //    web- nginx</code> </pre><br>  During the build process, we make sure that the following packages are selected: <br><blockquote>  IPV6 <br>  HTTP <br>  HTTP_CACHE <br>  HTTP_DAV <br>  HTTP_FLV <br>  HTTP_GZIP_STATIC <br>  HTTP_PERL <br>  HTTP_REWRITE <br>  HTTP_SSL <br>  HTTP_STATUS <br>  Www <br></blockquote><br><pre> <code class="dos hljs"># make install</code> </pre><br><h6>  <b>2.2 Create self-signed keys and certificates</b> </h6><br><br><pre> <code class="dos hljs"># <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/local/etc/nginx/</code> </pre><br>  Create the server.key root key (des3 encryption <b>algorithm</b> , 1024 bit long): <br><br><pre> <code class="dos hljs"># openssl genrsa -des3 -out server.key <span class="hljs-number"><span class="hljs-number">1024</span></span></code> </pre><br>  To do this, the system will ask for the password phrase twice.  We invent it and enter it. <br><br>  Create a root certificate: <br><br><pre> <code class="dos hljs"># openssl req -new -key server.key -out server.csr</code> </pre><br>  You can answer questions as you please.  The main thing: <br>  - on the first request <b>Enter pass phrase for server.key</b> enter the correct password from the root key created earlier, <br>  - it is necessary to answer all the questions, otherwise the client ownCloud may later refuse to synchronize files, <br>  - remember the entered data so that in the future you can easily remember that the certificate is yours, <br>  - remember the password entered on the question <b>A challenge password []:.</b> <br>  You can change the validity period of our certificate, for example, up to 10,000 days, by adding the argument <b>-days 10,000</b> to the command above. <br><br><pre> <code class="dos hljs"># cp server.key server.key.org //   # openssl rsa -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> server.key.org -out server.key //    # openssl x509 -req -days <span class="hljs-number"><span class="hljs-number">3650</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> server.csr -signkey server.key -out server.crt //  </code> </pre><br><h6>  <b>2.3 Enable the autorun web server, PHP and database</b> </h6><br><pre> <code class="dos hljs"># sysrc nginx_enable="YES" php_fpm_enable="YES" mysql_enable="YES"</code> </pre><br><h6>  <b>2.4 Install the editor for easy editing configs</b> </h6><br>  Still, we are still ‚Äúsmall‚Äù and it‚Äôs still difficult for us to use the pre-installed <b>vi</b> editor, so we‚Äôll put a simple <b>nano</b> editor (we answer <b>yes</b> to all the questions that arise). <br><br><pre> <code class="dos hljs"># pkg install nano</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Attention:</b> <div class="spoiler_text">  After installing the editor, try running it with the <b>nano</b> command.  In some cases that are not clear to me, something is going wrong and instead of starting the following error appears: <br><blockquote>  Shared object "libiconv.so.2" not found, required "libgmoudle-2.0.so.0 </blockquote><br>  In order to fix this, we execute only 2 commands: <br><br><pre> <code class="dos hljs"># pkg delete -f gettext # pkg upgrade</code> </pre><br></div></div><br><h6>  <b>2.5 Correcting the nginx web server config</b> </h6><br>  As real administrators, we always make a copy of it before adjusting the config, so that in case of problems, you can always roll back: <br><br><pre> <code class="dos hljs"># cp /usr/local/etc/nginx/nginx.conf /usr/local/etc/nginx/nginx.old</code> </pre><br>  And edit the config file: <br><br><pre> <code class="dos hljs"># nano /usr/local/etc/nginx/nginx.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">We replace all contents of a config with the following:</b> <div class="spoiler_text"><pre> <code class="php hljs">worker_processes <span class="hljs-number"><span class="hljs-number">2</span></span>; events { worker_connections <span class="hljs-number"><span class="hljs-number">1024</span></span>; } http { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> mime.types; default_type application/octet-stream; log_format main <span class="hljs-string"><span class="hljs-string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span> access_log logs/access.log main; sendfile off; keepalive_timeout <span class="hljs-number"><span class="hljs-number">65</span></span>; gzip off; ssl_certificate /usr/local/etc/nginx/server.crt; <span class="hljs-comment"><span class="hljs-comment">//     https ssl_certificate_key /usr/local/etc/nginx/server.key; //     https server { listen 443 ssl; //     https root /usr/local/www; location = /robots.txt { allow all; access_log off; log_not_found off; } location = /favicon.ico { access_log off; log_not_found off; } location ^~ /owncloud { index index.php; try_files $uri $uri/ /owncloud/index.php$is_args$args; client_max_body_size 512M; //      location ~ ^/owncloud/(?:\.|data|config|db_structure\.xml|README) { deny all; } location ~ \.php(?:$|/) { fastcgi_split_path_info ^(.+\.php)(/.*)$; fastcgi_pass unix:/var/run/php-fpm.sock; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $fastcgi_path_info; include fastcgi_params; fastcgi_param MOD_X_ACCEL_REDIRECT_ENABLED on; } location ~* \.(?:jpg|gif|ico|png|css|js|svg)$ { expires 30d; add_header Cache-Control public; } } } }</span></span></code> </pre><br></div></div><br>  Exit the editor by pressing Ctrl + X.  Do not forget to save changes when exiting. <br><br><h6>  <b>2.6 Correct php config</b> </h6><br><pre> <code class="dos hljs"># cp /usr/local/etc/php.ini-production /usr/local/etc/php.ini # nano /usr/local/etc/php.ini</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the file we find the following lines (we use Ctrl + W to search) and give them the specified values:</b> <div class="spoiler_text"><pre> <code class="php hljs">always_populate_raw_post_data = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-comment"><span class="hljs-comment">//    ;    date.timezone = Europe/Moscow //      cgi.fix_pathinfo=0 upload_max_filesize = 512M //            post_max_size = 512M //           </span></span></code> </pre><br></div></div><br><h6>  <b>2.7 Correct php-fpm.conf:</b> </h6><br><pre> <code class="dos hljs"># cp /usr/local/etc/php-fpm.conf /usr/local/etc/php-fpm.old # nano /usr/local/etc/php-fpm.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the file we find the following lines (we use Ctrl + W to search) and give them the specified values:</b> <div class="spoiler_text"><pre> <code class="php hljs">listen = /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/php-fpm.sock listen.owner = www <span class="hljs-comment"><span class="hljs-comment">//    ;    listen.group = www env[PATH] = /usr/local/bin:/usr/bin:/bin</span></span></code> </pre><br></div></div><br><h6>  <b>2.8 Adjust /var/db/mysql/my.cnf:</b> </h6><br><pre> <code class="dos hljs"># cp /var/db/mysql/my.cnf /var/db/mysql/my.old # nano /var/db/mysql/my.cnf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">The file will be empty, so we add the following lines to it:</b> <div class="spoiler_text"><pre> <code class="php hljs">[server] skip-networking skip-name-resolve innodb_flush_method = O_DIRECT skip-innodb_doublewrite innodb_flush_log_at_trx_commit = <span class="hljs-number"><span class="hljs-number">2</span></span> innodb_file_per_table expire_logs_days = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br></div></div><br><h6>  <b>2.9 Start the nginx web server, PHP, MariaDB and set up the database:</b> </h6><br><pre> <code class="dos hljs"># service nginx <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> &amp;&amp; service php-fpm <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> &amp;&amp; service mysql-server <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre><br>  If everything was done correctly, then everything will start without errors and you can try to go through the browser at <b>https: // &lt;YOUR_JAIL_IP&gt;</b> . <br>  We will be reminded that the certificate is self-signed, but by accepting it we will get to the page with the inscription <b>403 Forbidden</b> . <br><br><img src="https://habrastorage.org/files/0c6/ea0/e0b/0c6ea0e0b96a4c87a00e8c44292f6efb.png" alt="image"><br><br>  Configure the MariaDB database: <br><br><pre> <code class="dos hljs"># mysql_secure_installation</code> </pre><br><div class="spoiler">  <b class="spoiler_title">MariaDB settings:</b> <div class="spoiler_text">  <b>Enter current password for root (enter for none):</b> By default, there is no password, press <b>Enter</b> . <br>  <b>Set root password?</b>  <b>[Y / n]</b> : Enter <b>Y.</b> <br>  <b>New password:</b> Enter the new root password. <br>  <b>Re-enter new password:</b> We repeat the <b>password</b> entered earlier. <br>  All other questions are answered with <b>Y</b> , or simply click <b>Enter.</b> <br></div></div><br>  Configure the <b>ownloud</b> database <b>by</b> entering your values, where <b>owncloud</b> is the name of the database, <b>ownclouduserdb</b> is the user name for working with the database, and <b>passwordownclouddb</b> is the password of this user: <br><br><pre> <code class="dos hljs"># mysql -u root -p CREATE DATABASE owncloud; GRANT ALL PRIVILEGES ON owncloud.* TO 'ownclouduserdb' IDENTIFIED BY 'passwordownclouddb'; FLUSH PRIVILEGES; quit;</code> </pre><br><h6>  <b>2.10 Download and install the current version of OwnCloud</b> </h6><br>  Under the <a href="http://owncloud.org/install/">link</a> we look the current actual version of <b>ownCloud</b> .  At the time of this writing, it was version <b>8.0.2</b> . <br><br>  Download the archive, where instead of <b>8.0.2 we</b> indicate the current current version: <br><br><pre> <code class="dos hljs"># fetch "http://download.owncloud.org/community/owncloud-<span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.tar.bz2"</code> </pre><br>  Unarchive: <br><br><pre> <code class="dos hljs"># tar jxf owncloud-*.tar.bz2 -C /usr/local/www</code> </pre><br>  Now we delete the unnecessary archive: <br><br><pre> <code class="dos hljs"># rm owncloud-*.tar.bz2</code> </pre><br>  Assign system owners (user and group) ownCloud: <br><br><pre> <code class="dos hljs"># chown -R www:www /usr/local/www/owncloud /mnt/files</code> </pre><br><h6>  <b>2.11 Create a task in crone:</b> </h6><br><pre> <code class="dos hljs"># setenv EDITOR nano //        nano # crontab -u www -e</code> </pre><br>  Register in it: <br><br><pre> <code class="php hljs">*/<span class="hljs-number"><span class="hljs-number">15</span></span> * * * * /usr/local/bin/php -f /usr/local/www/owncloud/cron.php</code> </pre><br>  If everything was spelled correctly, then we will receive the following system message: <br><blockquote>  crontab: installing new crontab </blockquote><br>  Now go to the browser at <b>https: // &lt;YOUR_JAIL_IP&gt; / owncloud</b> and make the latest settings there.  Do not forget that we need to change the type of database used, and to do this, click <b>Storage and database</b> and select our database type: <b>MySQL / MariaDB</b> . <br><img src="https://habrastorage.org/files/b8e/8fd/d64/b8e8fdd64d8145de8ad17562f86401aa.png" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Fill in the fields</b> <div class="spoiler_text"><blockquote>  <b>Username</b> : The name of our cloud administrator.  For example, <b>Stepanadministratovich</b> . <br>  <b>Password</b> : Administrator password. <br>  <b>The data directory</b> : I prefer <b>/ mnt / files /</b> .  In this directory, I then mount my FreeNAS storage Volumes.  If you need to explain how, then write in the comments. <br>  <b>Database User</b> : We created it earlier in step 2.9 of <b>our ownclouduserdb</b> . <br>  <b>Database password</b> : Also assigned earlier in step 2.9 <b>passwordownclouddb</b> . <br>  <b>Database name</b> : All the same step 2.9 <b>owncloud</b> . <br></blockquote><br></div></div><br>  Our ownCloud is ready to go. <br><br><img src="https://habrastorage.org/files/e67/001/4f5/e670014f5da84611aca8643ae849c57c.png" alt="image"><br><br><h5>  <b>3 Advanced Settings</b> </h5><br><hr><br><h6>  <b>3.1 We ask the search robots (Yandex, Google, etc.) not to index our site:</b> </h6><br><pre> <code class="dos hljs"># ln -s /usr/local/www/owncloud/robots.txt /usr/local/www</code> </pre><br><h5>  <b>4 Password protection</b> </h5><br><hr><br><h6>  <b>4.1 Install fail2ban from ports:</b> </h6><br><pre> <code class="dos hljs"># <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/security/py-fail2ban # make install clean</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Directory structure fail2ban</b> <div class="spoiler_text">  Fail2ban is in the following path: / usr / local / etc / fail2ban.  The structure of the directories and files there: <br>  folder action.d - contains action files <br>  folder filter.d - filter files <br>  file fail2ban.conf - main configuration file <br>  jail.conf file - specific services protection configuration file <br></div></div><br><h6>  <b>4.2 Configuring logging in ownCloud:</b> </h6><br>  Create a file in which your ownCloud logs will be written if the login attempt fails: <br><br><pre> <code class="dos hljs">touch /var/log/owncloud-acces.log</code> </pre><br>  The file must be writable by the user www: <br><br><pre> <code class="dos hljs"># <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/log/ # chown www:www owncloud-acces.log</code> </pre><br>  Enable logging of unsuccessful logins in ownCloud: <br><br><pre> <code class="dos hljs"># nano /usr/local/www/owncloud/config/config.php</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the file we find or add the following lines before the very last line (use the search Ctrl + W) and give them the specified values:</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'logtimezone'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Europe/Moscow'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//      'logfile' =&gt; '/var/log/owncloud-acces.log', 'loglevel' =&gt; '2', 'log_authfailip' =&gt; true,</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Check whether logging failed inputs:</b> <div class="spoiler_text">  Several times we try to log into our <b>ownCloud</b> web-interface with obviously wrong password or username. <br><br>  Then execute the command in the console: <br><br><pre> <code class="dos hljs"># nano /var/log/owncloud-acces.log</code> </pre><br>  If everything is done correctly, the following entries will appear in the file: <br><blockquote>  {"ReqId": "es09787k250rv52fu0iu44124z494687", "remoteAddr": "192.168.1.1", "app": "core", "message": "Login failed: 'Admin' (Remote IP: '192.168.1.10', X- Forwarded-For: '') "," level ": 2," time ":" 2015-04-04T18: 59: 50 + 03: 00 "} <br></blockquote><br></div></div><br><br><h6>  <b>4.3 Create a filter file for fail2ban:</b> </h6><br><pre> <code class="dos hljs">nano /usr/local/etc/fail2ban/filter.d/owncloud.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the file we write the following:</b> <div class="spoiler_text"><pre> <code class="php hljs">[Definition] failregex={<span class="hljs-string"><span class="hljs-string">"app"</span></span>:<span class="hljs-string"><span class="hljs-string">"core"</span></span>,<span class="hljs-string"><span class="hljs-string">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"Login failed: user '.*' , wrong password, IP:&lt;HOST&gt;"</span></span>,<span class="hljs-string"><span class="hljs-string">"level"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">".*"</span></span>} <span class="hljs-comment"><span class="hljs-comment">//   ownCloud&lt;= 7.0.1 {"app":"core","message":"Login failed: '.*' \(Remote IP: '&lt;HOST&gt;', X-Forwarded-For: '.*'\)","level":2,"time":".*"} //   ownCloud=7.0.2-7.0.5 {"reqId":".*","remoteAddr":"&lt;HOST&gt;","app":"core","message":"Login failed: .*","level":2,"time":".*"} //   ownCloud&gt;=8</span></span></code> </pre><br></div></div><br>  In essence, this is a parser, which, in all the service information that ownCloud writes to its log, must find the ip-address of the one who tried to pick up the password for entry.  Those elements that never change in log entries are explicitly indicated here.  Those that change are replaced by *.  Well, actually the ip-address that we are looking for is replaced by the variable &lt;\ HOST&gt; \. <br><br><h6>  <b>4.4 Editing the service settings file:</b> </h6><br><pre> <code class="dos hljs"># cp /usr/local/etc/fail2ban/jail.conf /usr/local/etc/fail2ban/jail.old # nano /usr/local/etc/fail2ban/jail.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Add to the bottom of the jail.conf file:</b> <div class="spoiler_text"><pre> <code class="php hljs">[owncloud] enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> filter = owncloud port = https logpath = /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/log/owncloud-acces.log <span class="hljs-comment"><span class="hljs-comment">//     ownCloud,     4.2 ignoreip = 192.168.1.59 //   ip-     maxretry = 2 //      bantime = 86400 //     findtime = 600 //         -    action = bsd-ipfw //      pushover-notify //         ,              Tab.</span></span></code> </pre><br></div></div><br><h6>  <b>4.5 Check whether our filter is working and whether it can find the necessary rows in the ownCloud log with attempts to log in unsuccessfully:</b> </h6><br><pre> <code class="dos hljs"># fail2ban-regex /var/log/owncloud-acces.log /usr/local/etc/fail2ban/filter.d/owncloud.conf</code> </pre><br>  If everything is correct, at the bottom of the output there will be a line like <br><blockquote>  Lines: 2 lines, 0 ignored, 2 matches, 0 missed [processed in 0.0 sec] </blockquote><br><h6>  <b>4.6 Configuring actions that will be performed in case of failed login attempts:</b> </h6><br><pre> <code class="dos hljs"># cp /usr/local/etc/fail2ban/action.d/bsd-ipfw.conf /usr/local/etc/fail2ban/action.d/bsd-ipfw.local # nano /usr/local/etc/fail2ban/action.d/bsd-ipfw.conf</code> </pre><br>  We leave everything in it by default.  It already has a rule that when sent to the ban, the ip-address is added to the table (1) of the <b>ipfw</b> firewall: <br><blockquote>  actionban = ipfw table \ &lt;table \&gt; add \ &lt;ip \&gt; </blockquote><br>  Add to the <b>ipfw</b> firewall itself a rule that blocks all ip-addresses that are in the table (1), since  While there are no rules for the firewall, what to do with addresses from this table of ours (1): <br><pre> <code class="dos hljs"># ipfw add <span class="hljs-number"><span class="hljs-number">1</span></span> deny all from table\(<span class="hljs-number"><span class="hljs-number">1</span></span>\) to me</code> </pre><br><div class="spoiler">  <b class="spoiler_title">A few examples of working with ipfw:</b> <div class="spoiler_text"><pre> <code class="dos hljs">ipfw list //   ipfw delete <span class="hljs-number"><span class="hljs-number">13</span></span> //  <span class="hljs-number"><span class="hljs-number">13</span></span> ipfw add <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&gt; //  <span class="hljs-number"><span class="hljs-number">14</span></span> ipfw table <span class="hljs-number"><span class="hljs-number">1</span></span> add <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span> //   ipfw table <span class="hljs-number"><span class="hljs-number">1</span></span> add <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> //    ipfw table <span class="hljs-number"><span class="hljs-number">1</span></span> list //    ipfw add deny ip from table(<span class="hljs-number"><span class="hljs-number">10</span></span>) to me //   <span class="hljs-number"><span class="hljs-number">50</span></span>   ipfw table <span class="hljs-number"><span class="hljs-number">1</span></span> delete <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span> //   ipfw table <span class="hljs-number"><span class="hljs-number">1</span></span> flush //  </code> </pre><br></div></div><br><h6>  <b>4.7 Run fail2ban:</b> </h6><br>  Before launching, we will create for <b>fail2ban a</b> file describing the pushover-notify action, which was already mentioned above and which we will talk about later: <br><br><pre> <code class="dos hljs">#touch /usr/local/etc/fail2ban/action.d/pushover-notify.conf</code> </pre><br>  We set fail2ban autostart in /etc/rc.conf: <br><br><pre> <code class="dos hljs"># sysrc fail2ban_enable="YES"</code> </pre><br>  And run it: <br><br><pre> <code class="dos hljs"># /usr/local/etc/rc.d/fail2ban <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre><br>  If everything is done correctly, then it will start, if not - sort out where the error is.  If it is launched, then we check for a ban: we go from a third-party ip-address with the wrong password.  It should be banned for the time we specified in the <b>jail.conf</b> file. <br><div class="spoiler">  <b class="spoiler_title">A few examples of working with fail2ban that may come in handy during the debugging process:</b> <div class="spoiler_text"><pre> <code class="php hljs">fail2ban-client status <span class="hljs-comment"><span class="hljs-comment">//     fail2ban-client status owncloud //    ,  owncloud -     fail2ban-client set owncloud unbanip MYIP //   ip-  ,  MYIP -   ip-</span></span></code> </pre><br></div></div><br>  Actually, we now have our ownCloud operating on an ‚Äúadult‚Äù https database with password protection. <br>  Almost everything, but let's also add a blocking notification if the password is entered incorrectly as push notifications on our phone. <br><br><h5>  <b>5 Notification about blocking ip-address</b> </h5><br>  For push notifications, we will use the pushover.net service.  I think now you will not be difficult to deal with its API.  But if difficulties arise, please write in the comments and I will add an appropriate description of how to work with this service. <br><br><h6>  <b>5.1 Configure pushover notifications about unsuccessful login attempts and a bath:</b> </h6><br><pre> <code class="dos hljs"># nano /usr/local/etc/fail2ban/action.d/pushover-notify.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the file we write the following:</b> <div class="spoiler_text"><pre> <code class="php hljs">[Definition] actionstart= actionstop= actioncheck= actionban = url -k https:<span class="hljs-comment"><span class="hljs-comment">//api.pushover.net/1/messages.json -F token=&lt;token&gt; -F user=&lt;user&gt; -F title="ownCloud Alarm" -F message="&lt;ip&gt; is banned after &lt;failures&gt; attemts against &lt;name&gt;" actionunban = url -k https://api.pushover.net/1/messages.json -F token=&lt;token&gt; -F user=&lt;user&gt; -F title="ownCloud Alarm" -F message="&lt;ip&gt; is unbanned" [Init] name = default token = [API Token/key (application key)] user = [User key]</span></span></code> </pre><br></div></div><br>  where <b>[API Token / key (application key)]</b> and <b>[User key] are the</b> corresponding values ‚Äã‚Äãfrom <b>pushover.net</b> . <br>  Restart <b>fail2ban</b> <br><br><pre> <code class="dos hljs"># /usr/local/etc/rc.d/fail2ban restart</code> </pre><br>  We check the work of notifications by performing several unsuccessful attempts to log into ownCloud: <br><br><img src="https://habrastorage.org/files/7bf/2a3/978/7bf2a3978cb64bfdba0cf874b3b52c68.png" alt="image"><br><br>  That's all.  We do not forget to forward ports 80 and 443 on the router to access our <b>ownCloud</b> . <br>  And yes, for more security, you can replace the standard ports with something more exotic. </div><p>Source: <a href="https://habr.com/ru/post/255019/">https://habr.com/ru/post/255019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255007/index.html">In the wake of WinHEC (Hardware Engineering Conference) 2015 - Windows 10, IoT, AllJoyn, clouds, and more</a></li>
<li><a href="../255009/index.html">Self-assembly 3d-printer or purchase ready-made equipment for the design. 3d printing. Part 3</a></li>
<li><a href="../255011/index.html">Improving sound quality on Android tablets with Intel Atom processors using the Dolby Digital API</a></li>
<li><a href="../255013/index.html">Cloud services under high load. Cackle experience</a></li>
<li><a href="../255015/index.html">How to catch what is not. Part sad: what is an antivirus?</a></li>
<li><a href="../255021/index.html">Top 100+ Wolfram | Alpha Sine Functions, or Wolfram | Alpha Overview of Mathematical Features and Syntax</a></li>
<li><a href="../255025/index.html">The story of creating another robot. Part One, Design</a></li>
<li><a href="../255027/index.html">DevCon 2015: announcement of the speakers - representatives of the community</a></li>
<li><a href="../255029/index.html">Creation of microservices</a></li>
<li><a href="../255033/index.html">What is under the hood of a dynamic magnetic strip?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>