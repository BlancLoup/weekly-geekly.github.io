<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Smart home" with their own hands. Part 4. We organize a web interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we were able to teach our ‚Äúsmart home‚Äù system to recognize what we said and synthesize voice responses using Google. 
 Today ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Smart home" with their own hands. Part 4. We organize a web interface</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/hardware/129936/">previous article,</a> we were able to teach our ‚Äúsmart home‚Äù system to recognize what we said and synthesize voice responses using Google. <br>  Today I want to tell you how to organize access to our system through a web interface. <br><a name="habracut"></a><br><br><h4>  Technology </h4><br>  As you remember, the software for managing our ‚Äúsmart home‚Äù is written in the <b>Perl</b> language.  A modern information system is practically unthinkable without a database.  We also will not stay aside and will use <b>MySQL</b> for the storage of our data.  To implement the web server, I decided to use not a third-party software, but a module for perl - <b>HTTP :: Server :: Simple</b> , in particular - <b>HTTP :: Server :: Simple :: CGI</b> .  Why did I do this?  In large part, for the sake of interest;) But in theory, you can get access to low-level processing of HTTP requests / responses without cluttering up the Apache / mod_perl complex.  In general, nothing prevents the project from being transferred to Apache rails if you have the desire and enough time. <br><br><h4>  Database </h4><br>  First, install the MySQL DBMS and create a database with tables from db.sql.  Here is the listing: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> ion; <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> ion; <span class="hljs-comment"><span class="hljs-comment"># # Table structure for table 'calendar' # DROP TABLE IF EXISTS calendar; CREATE TABLE `calendar` ( `id` int(15) NOT NULL AUTO_INCREMENT, `date` datetime NOT NULL, `message` text, `nexttimeplay` datetime NOT NULL, `expired` datetime NOT NULL, `type` int(1) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=MyISAM DEFAULT CHARSET=latin1; # # Table structure for table 'commandslog' # DROP TABLE IF EXISTS commandslog; CREATE TABLE `commandslog` ( `id` int(15) NOT NULL AUTO_INCREMENT, `date` datetime NOT NULL, `cmd` varchar(255) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=latin1; # # Table structure for table 'log' # DROP TABLE IF EXISTS log; CREATE TABLE `log` ( `id` int(15) NOT NULL AUTO_INCREMENT, `date` datetime NOT NULL, `message` varchar(255) NOT NULL, `level` int(1) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=latin1;</span></span></code> </pre> <br><br>  Perform the necessary actions: <br><br> <code>nix@nix-boss:~$ sudo apt-get install mysql-server <br> nix@nix-boss:~$ mysql -uroot -ppassword &lt; db.sql <br></code> <br><h4>  Modifying the code </h4><br>  Now we need to create the <b>lib</b> , <b>html</b> and <b>config</b> folders (next to the <b>data</b> folder).  In the <b>lib</b> folder we put the module responsible for implementing the web server and processing our HTTP requests. <br><br>  We need to tweak the <b>srv.pl</b> script a <b>bit</b> .  Add to the initialization block: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">our</span></span> %cfg = readCfg(<span class="hljs-string"><span class="hljs-string">"common.cfg"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">our</span></span> $dbh = dbConnect($cfg{<span class="hljs-string"><span class="hljs-string">'dbName'</span></span>}, $cfg{<span class="hljs-string"><span class="hljs-string">'dbUser'</span></span>}, $cfg{<span class="hljs-string"><span class="hljs-string">'dbPass'</span></span>});</code> </pre><br>  Add the lines responsible for starting the HTTP server below the initialization block: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">##  HTTP- ################################ my $pid = lib::HTTP-&gt;new($cfg{'httpPort'})-&gt;background(); print "HTTP PID: $pid\n"; logSystem(" HTTP - PID: $pid, : $cfg{'httpPort'}, : $cfg{'httpHost'}", 0); ################################</span></span></code> </pre><br>  And now add the missing functions to the end of the file: <br><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCfg</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $file = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> %cfg; <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(CFG, <span class="hljs-string"><span class="hljs-string">"&lt;config/$file"</span></span>) || <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> $!; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @cfg = &lt;CFG&gt;; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $line (@cfg) { <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $line =~ <span class="hljs-regexp"><span class="hljs-regexp">/^\#/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($line =~ <span class="hljs-regexp"><span class="hljs-regexp">/(.*?) \= \"(.*?)\"\;/</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">chomp</span></span> $2; $cfg{$1} = $2; } } <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(CFG); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> %cfg; } <span class="hljs-comment"><span class="hljs-comment">######################################## sub dbConnect { my ($db, $user, $pass) = @_; return $dbh = DBI-&gt;connect("DBI:mysql:$db", $user, $pass) || die "Could not connect to database: $DBI::errstr"; } ######################################## sub logSystem { my ($text, $level) = @_; my %cfg = readCfg("common.cfg"); dbConnect($cfg{'dbName'}, $cfg{'dbUser'}, $cfg{'dbPass'}); $dbh-&gt;do("INSERT INTO log (date, message, level) VALUES (NOW(), '$text', $level)"); }</span></span></code> </pre><br><br>  As can be understood by the function names, dbConnect () is responsible for connecting to our DBMS, logSystem () is for logging, readCfg () is for loading the configuration.  Let us dwell on it in more detail.  The configuration is a simple text file in the config directory.  In our case, it is called <b>common.cfg</b> .  It looks like this: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">##  daemonMode = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"undef"</span></span></span><span class="hljs-meta">; logSystem = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1"</span></span></span><span class="hljs-meta">; logUser = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1"</span></span></span><span class="hljs-meta">; dbName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ion"</span></span></span><span class="hljs-meta">; dbUser = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"root"</span></span></span><span class="hljs-meta">; dbPass = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"password"</span></span></span><span class="hljs-meta">; camNumber = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"4"</span></span></span><span class="hljs-meta">; camMotionDetect = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1"</span></span></span><span class="hljs-meta">; httpPort = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"16100"</span></span></span><span class="hljs-meta">; httpHost = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"localhost"</span></span></span><span class="hljs-meta">; telnetPort = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"16000"</span></span></span><span class="hljs-meta">; telnetHost = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"localhost"</span></span></span><span class="hljs-meta">; micThreads = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"5"</span></span></span><span class="hljs-meta">;</span></span></code> </pre><br><br>  Some lines in it will be used later.  We are still interested only in lines beginning with the prefix <b>db</b> .  As we can see, these are the settings for connecting to our database. <br><br>  Now I will tell you how to overcome the repeated execution of a command.  Edit the <b>checkcmd ()</b> function: <br><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkcmd</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $text = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">chomp</span></span> $text; $text =~ <span class="hljs-regexp"><span class="hljs-regexp">s/ $//g</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"+OK - Got command \"$text\" (Length: "</span></span>.length($text).<span class="hljs-string"><span class="hljs-string">")\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($text =~ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>) { <span class="hljs-comment"><span class="hljs-comment">################################################# my $sth = $dbh-&gt;prepare('SELECT cmd FROM commandslog WHERE DATE_SUB(NOW(),INTERVAL 4 SECOND) &lt;= date LIMIT 0, 1'); $sth-&gt;execute(); my $result = $sth-&gt;fetchrow_hashref(); if($result-&gt;{cmd} ne "") { return; } $dbh-&gt;do("INSERT INTO commandslog (date, cmd) VALUES (NOW(), '$text')"); ################################################# if($text =~ //) { my $up = `uptime`; $up =~ /up (.*?),/; sayText("   - $1.    - $parent."); } if($text =~ //) { my $up = `uptime`; $up =~ /(.*?) up/; sayText(" $1"); } if($text =~ // || $text =~ //) { sayText(" .  !"); system("killall motion"); system("rm ./data/*.flac &amp;&amp; rm ./data/*.wav"); system("killall perl"); exit(0); } if($text =~ //) { my ($addit, $mod); my %wh = lib::HTTP::checkWeather(); $wh{'condition'} = Encode::decode_utf8( $wh{'condition'}, $Encode::FB_DEFAULT ); $wh{'hum'} = Encode::decode_utf8( $wh{'hum'}, $Encode::FB_DEFAULT ); $wh{'wind'} = Encode::decode_utf8( $wh{'wind'}, $Encode::FB_DEFAULT ); if($wh{'temp'} &lt; 0) { $mod = " "; } if($wh{'temp'} &gt; 0) { $mod = " "; } $wh{'wind'} =~ s/: ,//; $wh{'wind'} =~ s/: ,//; $wh{'wind'} =~ s/: ,//; $wh{'wind'} =~ s/: ,//; $wh{'wind'} =~ s/: ,/-/; $wh{'wind'} =~ s/: ,/-/; $wh{'wind'} =~ s/: ,/-/; $wh{'wind'} =~ s/: ,/-/; sayText(" $wh{'condition'}, $wh{'temp'}  $mod. $wh{'hum'}. $wh{'wind'}"); if ($wh{'temp'} &lt;= 18) { $addit = sayText(" ,   !"); } if ($wh{'temp'} &gt;= 28) { $addit = sayText("   !"); } } } #sayText("  - $text"); return; }</span></span></code> </pre><br>  We select the last command executed in the interval of four seconds and if it coincides with the current one, we exit the function.  As you can see, I added some commands compared to the function described in the last article.  The most interesting is the weather.  The implementation of receiving data for it is slightly lower. <br><br><h4>  <b>HTTP.pm</b> module </h4><br>  Let's go back to the implementation of the embedded HTTP server.  Create an <b>HTTP.pm</b> file in the <b>lib</b> directory.  We write the following code there: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> lib::HTTP; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> HTTP::Server::Simple::CGI; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> LWP::UserAgent; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> URI::Escape; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> base <span class="hljs-string"><span class="hljs-string">qw(HTTP::Server::Simple::CGI)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Template; <span class="hljs-comment"><span class="hljs-comment">######################################### ######################################### our %dispatch = ( '/' =&gt; \&amp;goIndex, '/index' =&gt; \&amp;goIndex, '/camers' =&gt; \&amp;goCamers, ); our $tt = Template-&gt;new(); ######################################### ######################################### sub handle_request { my $self = shift; my $cgi = shift; my $path = $cgi-&gt;path_info(); my $handler = $dispatch{$path}; if ($path =~ qr{^/(.*\.(?:png|gif|jpg|css|xml|swf))}) { my $url = $1; print "HTTP/1.0 200 OK\n"; print "Content-Type: text/css\r\n\n" if $url =~ /css/; print "Content-Type: image/jpeg\r\n\n" if $url =~ /jpg/; print "Content-Type: image/png\r\n\n" if $url =~ /png/; print "Content-Type: image/gif\r\n\n" if $url =~ /gif/; print "Content-Type: text/xml\r\n\n" if $url =~ /xml/; print "Content-Type: application/x-shockwave-flash\r\n\n" if $url =~ /swf/; open(DTA, "&lt;$url") || die "ERROR: $! - $url"; binmode DTA if $url =~ /jpg|gif|png|swf/; my @dtast = &lt;DTA&gt;; foreach my $line (@dtast) { print $line; } close(DTA); return; } if (ref($handler) eq "CODE") { print "HTTP/1.0 200 OK\r\n"; $handler-&gt;($cgi); } else { print "HTTP/1.0 404 Not found\r\n"; print $cgi-&gt;header, $cgi-&gt;start_html('Not found'), $cgi-&gt;h1('Not found'), $cgi-&gt;h2($cgi-&gt;path_info()); $cgi-&gt;end_html; } } ##   / ######################################## sub goIndex { my $cgi = shift; # CGI.pm object return if !ref $cgi; my %w = checkWeather(); my $cmd; my $dbh = iON::dbConnect($iON::cfg{'dbName'}, $iON::cfg{'dbUser'}, $iON::cfg{'dbPass'}); my $sth = $dbh-&gt;prepare('SELECT cmd FROM commandslog WHERE id &gt; 0 ORDER BY id DESC LIMIT 0, 1'); $sth-&gt;execute(); my $result = $sth-&gt;fetchrow_hashref(); if($result-&gt;{cmd} ne "") { $cmd = $result-&gt;{cmd}; } else { $cmd = " ..."; } print "Content-Type: text/html; charset=UTF-8\n\n"; my $uptime = `uptime`; $uptime =~ /up (.*?),/; $uptime = $1; my $videosys = `ps aux | grep motion`; if ($videosys =~ /motion -c/) { $videosys = "&lt;font color=green&gt;&lt;/font&gt;"; } else { $videosys = "&lt;font color=red&gt; &lt;/font&gt;"; } my $micsys = `ps aux | grep mic`; if ($micsys =~ /perl mic\.pl/) { $micsys = "&lt;font color=green&gt;&lt;/font&gt;"; } else { $micsys = "&lt;font color=red&gt; &lt;/font&gt;"; } my $vars = { whIcon =&gt; $w{'icon'}, whCond =&gt; $w{'condition'}, whTemp =&gt; $w{'temp'}, whHum =&gt; $w{'hum'}, whWind =&gt; $w{'wind'}, cmd =&gt; $cmd, uptime =&gt; $uptime, video =&gt; $videosys, mic =&gt; $micsys, threads =&gt; $iON::cfg{'micThreads'}, }; my $output; $tt-&gt;process('html/index', $vars, $output) || print $tt-&gt;error(), "\n"; } ##   /camers ######################################## sub goCamers { my $cgi = shift; # CGI.pm object return if !ref $cgi; my %w = checkWeather(); my $cmd; my $dbh = iON::dbConnect($iON::cfg{'dbName'}, $iON::cfg{'dbUser'}, $iON::cfg{'dbPass'}); my $sth = $dbh-&gt;prepare('SELECT cmd FROM commandslog WHERE id &gt; 0 ORDER BY id DESC LIMIT 0, 1'); $sth-&gt;execute(); my $result = $sth-&gt;fetchrow_hashref(); if($result-&gt;{cmd} ne "") { $cmd = $result-&gt;{cmd}; } else { $cmd = " ..."; } if($cgi-&gt;param("text") ne "") { my $txt = $cgi-&gt;param('text'); require Encode; $txt = Encode::decode_utf8( $txt, $Encode::FB_DEFAULT ); iON::sayText($txt); } print "Content-Type: text/html; charset=UTF-8\n\n"; my $vars = { camera1 =&gt; 'video-0/camera.jpg', camera2 =&gt; 'video-1/camera.jpg', camera3 =&gt; 'video-2/camera.jpg', camera4 =&gt; 'video-3/camera.jpg', whIcon =&gt; $w{'icon'}, whCond =&gt; $w{'condition'}, whTemp =&gt; $w{'temp'}, whHum =&gt; $w{'hum'}, whWind =&gt; $w{'wind'}, cmd =&gt; $cmd, }; my $output; $tt-&gt;process('html/camers', $vars, $output) || print $tt-&gt;error(), "\n"; } ##  ######################################## sub checkWeather { my %wh; my $ua = LWP::UserAgent-&gt;new( agent =&gt; "Mozilla/5.0 (Windows NT 5.1; ru-RU) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.872.0 Safari/535.2"); my $content = $ua-&gt;get("http://www.google.com/ig/api?hl=ru&amp;weather=".uri_escape("-")); $content-&gt;content =~ /&lt;current_conditions&gt;(.*?)&lt;\/current_conditions&gt;/g; my $cond = $1; $cond =~ /&lt;condition data="(.*?)"/g; $wh{'condition'} = $1; $cond =~ /temp_c data="(.*?)"/g; $wh{'temp'} = $1; $cond =~ /humidity data="(.*?)"/g; $wh{'hum'} = $1; $cond =~ /icon data="(.*?)"/g; $wh{'icon'} = $1; $cond =~ /wind_condition data="(.*?)"/g; $wh{'wind'} = $1; return %wh; } ######################################### ######################################### 1;</span></span></code> </pre><br><br>  We analyze the content in more detail.  In the <b>% dispatch</b> hash, we determine the correspondence between the URL and the function being called.  All other URLs not described in this hash will display a <b>404</b> page. <br>  The template engine will be a powerful and flexible <b>Template Toolkit</b> library.  We initialize it with the string: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">our</span></span> $tt = Template-&gt;new();</code> </pre><br>  <b>By</b> overloading the <b>handle_request ()</b> function of the parent class, we get control over the processing of requests to the HTTP server.  To return static content to the browser (png, gif, jpg, css, xml, swf) a block is used: <br><br><pre> <code class="perl hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($path =~ <span class="hljs-string"><span class="hljs-string">qr{^/(.*\.(?:png|gif|jpg|css|xml|swf))}</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $url = $1; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"HTTP/1.0 200 OK\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: text/css\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/css/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: image/jpeg\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/jpg/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: image/png\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/png/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: image/gif\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/gif/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: text/xml\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/xml/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: application/x-shockwave-flash\r\n\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/swf/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(DTA, <span class="hljs-string"><span class="hljs-string">"&lt;$url"</span></span>) || <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"ERROR: $! - $url"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">binmode</span></span> DTA <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $url =~ <span class="hljs-regexp"><span class="hljs-regexp">/jpg|gif|png|swf/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @dtast = &lt;DTA&gt;; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $line (@dtast) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $line; } <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(DTA); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  Since I got a bit of MIME types, I wrote them down a little Hindu;) <br>  Then begin the functions responsible for generating the content of a specific URL.  So far there are only two - an index and a camera page. <br>  On the index, we can see whether subsystems such as video and audio capture work.  A separate line is: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> %w = checkWeather();</code> </pre><br>  This function returns a hash with current city weather data that will be displayed on our page.  Such a nice little bun;) <br>  In the same place next to we will display the last received and recognized command for the ‚Äúsmart home‚Äù. <br><br>  The next function <b>goCamers ()</b> performs the same functions as the index, only instead of displaying information on the state of the subsystems, it shows an image from our cameras and it is possible to write some text that will be synthesized and voiced by our ‚Äúsmart home‚Äù. <br><br>  All pages are based on templates that are in the <b>html</b> folder.  Lay out the listing here is not convenient, so I will give a link to the archive - <a href="http://narod.ru/disk/28163772001/html.zip.html">html.zip</a> . <br><br><h4>  Total </h4><br>  After all the changes, we will get a properly working web interface on port <b>16100</b> , which will now allow you to view the status of smart home subsystems, data from webcams, and voice the text you entered.  In the future, we will add to it another, more important functionality. <br><br>  In the next article I will discuss how to work with <b>X10</b> devices and integrate them into our ‚Äúsmart home‚Äù system. <br><br>  <b>upd</b> : <a href="http://habrahabr.ru/blogs/hardware/136066/">Continued</a> </div><p>Source: <a href="https://habr.com/ru/post/130239/">https://habr.com/ru/post/130239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130233/index.html">Copyright and servers at hetzner.de</a></li>
<li><a href="../130234/index.html">Google Voice in Russia</a></li>
<li><a href="../130235/index.html">PayPal earned an admission to Russia</a></li>
<li><a href="../130236/index.html">Overview of salaries of system administrators Part 1 (Windows)</a></li>
<li><a href="../130238/index.html">Novelties on the State Duma website: deputies have become more accessible</a></li>
<li><a href="../130240/index.html">Cautiously phishing FirstVDS</a></li>
<li><a href="../130241/index.html">Tech-Talk by Dart Language at the Moscow office of Google</a></li>
<li><a href="../130242/index.html">New design, API and Android app</a></li>
<li><a href="../130243/index.html">Rambler-Cashier started working with Yandex.Fashion</a></li>
<li><a href="../130244/index.html">Master in South Korea</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>