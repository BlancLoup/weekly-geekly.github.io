<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About CMTime</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I propose to get acquainted with the translation of the article by Warren Moore on the understanding and application of CMTime. In my previo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About CMTime</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/2a6/b47/053/2a6b470536720e2f42a765e6d83ed7f1.jpg" alt="image" align="left">  Hi, Habr!  I propose to get acquainted with the translation of the article by <b>Warren Moore</b> on the understanding and application of CMTime.  In my previous post <a href="http://habrahabr.ru/post/173599/">related to working with video</a> , I promised to tell you more about these wonderful and so important structures.  The main focus will be on the importance of looking at the time, describing the structure of CMTime, but without the simplest examples will not do. <a name="habracut"></a><br><br><h5>  About the importance and accuracy of time evaluation </h5><br>  Most people do not need to think about the accuracy of time.  Take the extreme case, perhaps you are an Olympic runner who cares about the difference in milliseconds between your speed and the world record on the hundred-meter mark.  These results are almost the same.  However, when it comes to timely information, we take care of very short intervals (tens of microseconds), but sometimes these segments are several days or weeks. <br>  Suppose you need to set the exact frame in the film, for example, at <b>35:06</b> .  It will naively represent time as a double-precision floating-point number, for example: <br><pre><code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">NSTimeInterval</span></span> t = <span class="hljs-number"><span class="hljs-number">2106.0</span></span>;</code> </pre> <br>  Quite often, such a representation fits well with the conditions of the problem, but is inapplicable when it comes to very long intervals with fragmentation into small components.  Without going into the specifics of floating-point numbers, a double can contain 16 (in decimal) significant digits in eight bytes: <br><pre> <code class="hljs lisp">sizeof(<span class="hljs-name"><span class="hljs-name">NSTimeInterval</span></span>) == sizeof(<span class="hljs-name"><span class="hljs-name">Float64</span></span>) == sizeof(<span class="hljs-name"><span class="hljs-name">double</span></span>) == <span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre> <br>  Floating point numbers are one problem: repeated operations (addition, multiplication, etc.) lead to an increase in inaccuracy, which can lead to a noticeable discrepancy after a long period of time.  And this, in turn, can lead to errors in the synchronization of several streams of information. <br><br><div class="spoiler">  <b class="spoiler_title">Simplest example</b> <div class="spoiler_text">  Summing a million elements equal to 0.000001, we end up with 1.0000000000079181.  The error is caused by the fact that 1e-6 cannot be accurately represented in floating point format (in the example), instead we use a binary approximation, which is distinguished by less significant bits.  This error is not so significant, but when it comes to using the HTTP Streaming Server, the error increases several thousand times per second for an indefinite period of time. </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is what prompted us to find a way to more accurately represent the time, ending with the use of a floating point number and this inaccuracy (not to mention the hard behavior when rounding). <br><br><h5>  Time as a rational number </h5><br>  There are many data structures created by Apple for representing the time for both the MAC OS and iOS.  With the advent of MAC OS X 10.7 and iOS 4, two more have been added: <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMTime</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CMTimeRange</span></span></code> </pre> <br>  Having dealt with the first, you will easily understand the second, so the article will focus the reader‚Äôs attention on <b>CMTime</b> . <br><br>  In fact, CMTime is no more than a four-member sash structure, and looks like this: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">CMTimeValue</span></span> value; <span class="hljs-built_in"><span class="hljs-built_in">CMTimeScale</span></span> timescale; <span class="hljs-built_in"><span class="hljs-built_in">CMTimeFlags</span></span> flags; <span class="hljs-built_in"><span class="hljs-built_in">CMTimeEpoch</span></span> epoch; } <span class="hljs-built_in"><span class="hljs-built_in">CMTime</span></span>;</code> </pre> <br><br>  Next, consider in detail the <i>value</i> and <i>timescale</i> , but the <i>flags</i> deserve a mention.  Different values ‚Äã‚Äãof the flags show us that the timestamp ( <i>hereinafter, the time interval</i> ) can be equal to the plus or minus of infinity, or it has been rounded as a result of some calculations.  Thus, the structure is more expressive in comparison with <i>NSTimeInterval</i> and has a number of advantages.  What is actually expressed in <i>CMTime</i> ? <br><br>  It is very important to understand that <i>value</i> and <i>timescale</i> are stored as integers: 64 and 32 bits, respectively.  This should be obvious from the text above, since <i>value</i> is presented in such a way as to avoid errors identical to those given in the example.  In addition, by allocating only 64 bits to the denominator, we can use up to 19 decimal digits for each of the possible <i>timescale</i> values. <br><br>  What is <i>timescale</i> ?  It represents the number of ‚Äúslices‚Äù into which each second is divided.  This is important because the accuracy of the CMTime object as a whole is limited to this value. <br><br><div class="spoiler">  <b class="spoiler_title">One more example</b> <div class="spoiler_text">  If the <i>timescale</i> value is 1, the time interval represented in the object will be no shorter than one second, the step will also be one second.  Similarly, if <i>timescale = 1000</i> , every second will be divided into 1000 pieces, and <i>value</i> will contain the number of milliseconds that we want to denote. <br></div></div><br><br>  How to choose a reasonable <i>timescale</i> , so as not to get a cut piece?  Apple recommends 600 for video (explaining that 600 is universal for most videos with a frequency of 24, 25, and 30 frames per second).  You may want to set the value to 60000 if you need precise indexing for the audio file.  What else is cool about this 64-bit <i>value</i> is that <u>you can imagine 5.8 million years in steps of 1/60000 seconds</u> along the way. <br><br>  The number of seconds in a time <i>span is</i> nothing more than <i>t.value / t.timescale</i> .  You can use <i>CMTimeGetSeconds</i> to easily convert <i>CMTime</i> to <i>float64</i> in such a way as to ensure maximum accuracy. <br><br><h5>  Not-so-and-convenient convenient methods. </h5><br>  <i>CMTimeGetSeconds</i> may be a friendly and useful method, but its wicked twin brother, <i>CMTimeMakeWithSeconds is</i> far from being so friendly to our brother: <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMTime</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CMTimeMakeWithSeconds</span></span> ( Float64 seconds, int32_t preferredTimeScale );</code> </pre> <br><br>  The first couple of times when using this function, I could not get her to do what I wanted ( <i><b>comment of the translator</b></i> , damn vital).  Now that we have gone through all the insides of <i>CMTime</i> , I hope that you will understand my mistakes.  I tried performing the submission in 0.5 seconds in order to receive periodic callbacks from an <i>AVPlayer</i> object (streaming MP3). <br>  I tried to do the following: <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMTime</span></span> interval = <span class="hljs-built_in"><span class="hljs-built_in">CMTimeMakeWithSeconds</span></span>(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  If you've read this far, you know that the interval will actually be zero, not 0.5.  It does not make sense to request half of the unit in the sequence of integers, but this is exactly what I tried to do.  Our <i>value has been</i> truncated because <i>timescale is</i> not accurate enough here. <br><br>  The <i><b>Core Media API</b></i> includes a complete set of functions for building, comparing, and performing <i>CMTime-</i> related arithmetic operations.  Although it is not easy to perform arithmetic operations on <i>CMTime</i> using these functions, it is important to use them if you want to maintain accuracy and integrity.  Each of these functions performs special overflow and rounding checks and sets the appropriate flags for CMTime objects when necessary. <br><br>  To add two <i>CMTimes</i> , use the <i>CMTimeAdd</i> function.  For comparison, use <i>CMTimeCompare</i> (the return value of this function follows the convention of the function comparator, which is used in the standard C library and is known by the name <i>qsort</i> ).  To learn more from <i>CMTime</i> , use <i>CMTimeMaximum</i> .  Familiarize yourself with the documentation for learning the other methods, but this set of functions is usually sufficient. <br><br><h5>  Uncertainties and infinity: set your ‚Äúweird‚Äù flag </h5><br>  The final part of the CMTime related article is the presentation of flags of infinity, undefined values, and rounding.  An ‚Äúindefinite‚Äù time is a time whose value is unknown.  You can get such a time period of an object if you request its elapsed time before it is initialized.  Flag values ‚Äã‚Äãcan be checked for each exception: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">kCMTimeFlags_PositiveInfinity</span></span> kCMTimeFlags_NegativeInfinity kCMTimeFlags_Indefinite</code> </pre> <br>  Since the bitwise OR (in the original, OR'ing) is not used by everyone, there are useful macros to check for the presence of these flags: <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMTIME_IS_POSITIVE_INFINITY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CMTIME_IS_NEGATIVE_INFINITY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CMTIME_IS_INDEFINITE</span></span></code> </pre> <br>  By the way, they can also be used to check the validity of the time interval.  The result of such an operation will be NO if the <i>timestamp is</i> not valid. <br><br>  In addition, here is a long list of how the comparison of different time categories works: <br><ul><li>  <b>Invalid time</b> will be equal to another invalid time, and more than any other time. </li></ul><br><ul><li>  <b>Plus infinity (Positive infinity)</b> will be less than any invalid time, equal to another plus infinity and more than any other time. </li></ul><br><ul><li>  <b>An indefinite time (An indefinite time)</b> will be less than any invalid time, less than plus infinity, equal to the same indefinite time, more than any other time. </li></ul><br><ul><li>  <b>Negative infinity</b> will be the same and less than any other. </li></ul><br><br>  <i><b>Now you know.</b></i> <br><br>  <i>Note:</i> <br>  Of course, the topic under consideration is rather narrow, but still it may seem interesting to some.  Moreover, the information in runet is slightly less than zero.  To obtain the approval of the author, as well as clarify some of the points had to contact him by mail, and eventually got what happened.  Please do not write comments and errors in the comments, but send to internal mail, thank you. </div><p>Source: <a href="https://habr.com/ru/post/173897/">https://habr.com/ru/post/173897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173879/index.html">What prevents domestic programmers to repeat the success of Zuckerberg</a></li>
<li><a href="../173881/index.html">Icon Fonts for Mobile</a></li>
<li><a href="../173887/index.html">How education is created. History Online Science Classroom</a></li>
<li><a href="../173891/index.html">Second wind of the era of invention</a></li>
<li><a href="../173893/index.html">We design on DDD. Part 1: Domain & Application</a></li>
<li><a href="../173899/index.html">AVR Video Tutorials</a></li>
<li><a href="../173903/index.html">Technique: Compilation of methods (refactoring M. Fowler)</a></li>
<li><a href="../173905/index.html">On the laws of universality or what Tetris can tell us about coffee stains</a></li>
<li><a href="../173907/index.html">VKontakte updated API documentation</a></li>
<li><a href="../173911/index.html">Posters applications for iOS, Android and Windows Phone. Big spring update and numbers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>