<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multiple dispatch in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have already reviewed two articles where C # dynamic functionality could lead to unexpected code behavior. 
 This time I would like to show a posit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multiple dispatch in C #</h1><div class="post__text post__text-html js-mediator-article">  We have already reviewed <a href="https://habrahabr.ru/post/280234/">two</a> <a href="https://habrahabr.ru/post/281274/">articles</a> where C # <font color="#2E74B5"><b>dynamic</b></font> functionality could lead to unexpected code behavior. <br>  This time I would like to show a positive side, where dynamic scheduling allows you to simplify the code while remaining strictly typed. <br><br>  In this post we will learn: <br><ul><li>  Possible options for the implementation of the template multiple dispatch (multiple / double dispatch &amp; co.) </li><li>  how to <s>get rid of</s> implement Exception Handling Block from Enterprise Library in a couple of minutes.  And, of course, simplify the policy-based error handling model </li><li>  <font color="#2E74B5"><b>dynamic</b></font> - more efficient than your code </li></ul><br><a name="habracut"></a><br><h3>  <font color="#2E74B5">And we need it?</font> </h3><br>  Sometimes we may face the problem of choosing overloading methods.  For example: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sanitize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{ Node node = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Document(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sanitizer().Cleanup(node); <span class="hljs-comment"><span class="hljs-comment">// void Cleanup(Node node) } class Sanitizer { public void Cleanup(Node node) { } public void Cleanup(Element element) { } public void Cleanup(Attribute attribute) { } public void Cleanup(Document document) { } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">[class hierarchy]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> {</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attribute</span></span></span><span class="hljs-class"> :</span></span> Node { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Document</span></span></span><span class="hljs-class"> :</span></span> Node { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Element</span></span></span><span class="hljs-class"> :</span></span> Node { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class"> :</span></span> Node { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HtmlElement</span></span></span><span class="hljs-class"> :</span></span> Element { } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HtmlDocument</span></span></span><span class="hljs-class"> :</span></span> Document { }</code> </pre><br></div></div><br>  As we can see, only the <code>void Cleanup(Node node)</code> method will be selected.  This problem can be solved by OOP-approach, or use type conversion. <br><br>  Let's start with the simple: <br><div class="spoiler">  <b class="spoiler_title">[cast]</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sanitize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{ var sanitizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sanitizer(); var document = node as Document; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (document != null) { sanitizer.Cleanup(document); } var element = node as Element; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (element != null) { sanitizer.Cleanup(element); } <span class="hljs-comment"><span class="hljs-comment">/* *     */</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  - sanitizer.Cleanup(node); } }</span></span></code> </pre><br></div></div><br>  It does not look very "beautiful." <br><div class="spoiler">  <b class="spoiler_title">Therefore, apply the PLO:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sanitize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{ var sanitizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sanitizer(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (node.NodeType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NodeType.Node: sanitizer.Cleanup(node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NodeType.Element: sanitizer.Cleanup((Element)node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NodeType.Document: sanitizer.Cleanup((Document)node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NodeType.Text: sanitizer.Cleanup((Text)node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NodeType.Attribute: sanitizer.Cleanup((Attribute)node); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(); } } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> NodeType { Node, Element, Document, Text, Attribute } abstract <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> abstract NodeType NodeType { get; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attribute</span></span></span><span class="hljs-class"> :</span></span> Node { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> override NodeType NodeType { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeType.Attribute; } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Document</span></span></span><span class="hljs-class"> :</span></span> Node { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> override NodeType NodeType { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeType.Document; } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Element</span></span></span><span class="hljs-class"> :</span></span> Node { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> override NodeType NodeType { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeType.Element; } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class"> :</span></span> Node { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> override NodeType NodeType { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeType.Text; } } }</code> </pre><br></div></div><br>  Well, we declared enumeration <b>NodeType</b> , entered the abstract property with the same name in class <b>Node</b> .  Problem solved.  <s>Thank you for your attention</s> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This pattern helps in cases where it is necessary to have cross-platform portability;  whether it is a programming language or execution environment.  On this path went the standard <a href="https://www.w3.org/TR/DOM-Level-1/level-one-core.html">W3C DOM</a> , for example. <br><br><h3>  <font color="#2E74B5">Multiple dispatch pattern</font> </h3><br>  Multiple dispatching or multimethod (multiple dispatch) is a variation of the concept in OOP to select the method to be called at runtime rather than compilation. <br><br>  To get an idea, let's start with a simple one: double dispatch (more on this <a href="https://habrahabr.ru/post/201996/">here</a> ). <br><div class="spoiler">  <b class="spoiler_title">Double dispatch</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Program</span></span></span><span class="hljs-class"> {</span></span> interface ICollidable { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ICollidable other)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Asteroid</span></span></span><span class="hljs-class"> :</span></span> ICollidable { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Asteroid other)</span></span></span><span class="hljs-function"> </span></span>{ Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Asteroid collides with Asteroid"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Spaceship spaceship)</span></span></span><span class="hljs-function"> </span></span>{ Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Asteroid collides with Spaceship"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ICollidable other)</span></span></span><span class="hljs-function"> </span></span>{ other.CollideWith(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spaceship</span></span></span><span class="hljs-class"> :</span></span> ICollidable { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ICollidable other)</span></span></span><span class="hljs-function"> </span></span>{ other.CollideWith(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Asteroid asteroid)</span></span></span><span class="hljs-function"> </span></span>{ Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Spaceship collides with Asteroid"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollideWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Spaceship spaceship)</span></span></span><span class="hljs-function"> </span></span>{ Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Spaceship collides with Spaceship"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args)</span></span></span><span class="hljs-function"> </span></span>{ var asteroid = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Asteroid(); var spaceship = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spaceship(); asteroid.CollideWith(spaceship); asteroid.CollideWith(asteroid); } }</code> </pre><br></div></div><br>  The essence of double dispatch is that the method is bound by the successor in the class hierarchy, and not at the place of a particular call.  The disadvantages are also attributed to the problem of extensibility: with an increase in the elements in the system, you will have to deal with copy-paste. <br><br>  - <i>So where <s>is the</s> C # dynamic <s>problem</s> ?!</i>  - you ask. <br>  In the example of type casting, we have already become acquainted with the <i>primitive</i> implementation of the multimethod pattern, where the choice of the required method overload occurs at the place of a particular call, in contrast to double dispatch. <br><br>  But constantly writing a bunch of ifs <s>not Feng Shui</s> is bad! <br><br>  Not always, of course.  Just the examples above are synthetic.  Therefore, we consider more realistic. <br><br><h3>  <font color="#2E74B5">I'll take two</font> </h3><br>  Before moving on, let's remember what an Enterprise Library is. <br><br>  <a href="https://msdn.microsoft.com/ru-ru/library/ff648951.aspx">The Enterprise Library</a> is a set of reusable components / blocks (logging, validation, data access, exception handling, etc.) for building applications.  There is a separate <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D41145">book</a> where all the details of the work are reviewed. <br><br>  Each of the blocks can be configured both in XML and in the code itself. <br><br>  Error handling unit today we will consider. <br><br>  If you are developing an application that uses the ASP.NET pipeline pattern, then the Exception Handling Block (hereinafter simply ‚ÄúEHB‚Äù) can greatly simplify life.  After all, the key place is always the error handling model in the language / framework, etc. <br><br>  Suppose we have a section of code where we have replaced the imperative code with a more OOP type with the policy template (strategy variation). <br><br>  It was: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// code to throw exception } catch (InvalidCastException invalidCastException) { // log ex // rethrow if needed } catch (Exception e) { // throw new Exception with inner }</span></span></code> </pre><br>  It has become (using EHB): <br><br><pre> <code class="cpp hljs">var policies = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ExceptionPolicyDefinition&gt;(); var myTestExceptionPolicy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ExceptionPolicyEntry&gt; { { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExceptionPolicyEntry(typeof (InvalidCastException), PostHandlingAction.NotifyRethrow, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IExceptionHandler[] {<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingExceptionHandler(...),}) }, { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExceptionPolicyEntry(typeof (Exception), PostHandlingAction.NotifyRethrow, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IExceptionHandler[] {<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplaceHandler(...)}) } }; policies.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExceptionPolicyDefinition(<span class="hljs-string"><span class="hljs-string">"MyTestExceptionPolicy"</span></span>, myTestExceptionPolicy)); ExceptionManager manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExceptionManager(policies); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// code to throw exception } catch (Exception e) { manager.HandleException(e, "Exception Policy Name"); }</span></span></code> </pre><br>  Well, it looks more "enterprise".  But is it possible to avoid massive dependencies and be limited to the capabilities of the C # language itself? <br><br>  ‚ÄúThe <i>imperative approach is the very possibilities of the language</i> ,‚Äù one may argue. <br>  <u>However, not only</u> . <br><br>  Let's try to write our Exception Handling Block, but only easier. <br><br>  To do this, consider the implementation of the promotion of exception handlers in the EHB itself. <br>  So, the source code again: <br><br><pre> <code class="cpp hljs">ExceptionManager manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExceptionManager(policies); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// code to throw exception } catch (Exception e) { manager.HandleException(e, "Exception Policy Name"); }</span></span></code> </pre><br>  Call chain starting with <br> <code>manager.HandleException(e, "Exception Policy Name")</code> <br> <div class="spoiler">  <b class="spoiler_title">ExceptionPolicyDefinition.FindExceptionPolicyEntry</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ExceptionPolicyEntry FindExceptionPolicyEntry(Type exceptionType) { ExceptionPolicyEntry policyEntry = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (exceptionType != typeof(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)) { policyEntry = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetPolicyEntry(exceptionType); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (policyEntry != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> policyEntry; } exceptionType = exceptionType.BaseType; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> policyEntry; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ExceptionPolicyEntry.Handle</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exceptionToHandle)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exceptionToHandle == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"exceptionToHandle"</span></span>); } Guid handlingInstanceID = Guid.NewGuid(); Exception chainException = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ExecuteHandlerChain(exceptionToHandle, handlingInstanceID); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RethrowRecommended(chainException, exceptionToHandle); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ExceptionPolicyEntry.ExecuteHandlerChain</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Exception </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteHandlerChain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception ex, Guid handlingInstanceID)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { foreach (IExceptionHandler handler in <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handlers) { name = handler.GetType().Name; ex = handler.HandleException(ex, handlingInstanceID); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exception) { <span class="hljs-comment"><span class="hljs-comment">// rest of implementation } return ex; }</span></span></code> </pre><br></div></div><br><br>  And this is just the tip of the iceberg. <br><br>  The key interface is the IExceptionHandler: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Microsoft.Practices.EnterpriseLibrary.ExceptionHandling { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface IExceptionHandler { <span class="hljs-function"><span class="hljs-function">Exception </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception ex, Guid handlingInstanceID)</span></span></span></span>; } }</code> </pre><br>  Take it as a basis and nothing more. <br><hr><br>  Let's declare two interfaces (why we need it - we'll see later): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface IExceptionHandler { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HandleException&lt;T&gt;(T exception) where T : Exception; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface IExceptionHandler&lt;T&gt; where T : Exception { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T exception)</span></span></span></span>; }</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">As well as a handler for input / output (I / O) exceptions:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileSystemExceptionHandler</span></span></span><span class="hljs-class"> :</span></span> IExceptionHandler, IExceptionHandler&lt;Exception&gt;, IExceptionHandler&lt;IOException&gt;, IExceptionHandler&lt;FileNotFoundException&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HandleException&lt;T&gt;(T exception) where T : Exception { var handler = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> as IExceptionHandler&lt;T&gt;; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != null) handler.Handle(exception); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Handle((dynamic) exception); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ OnFallback(exception); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnFallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// rest of implementation Console.WriteLine("Fallback: {0}", exception.GetType().Name); } public void Handle(IOException exception) { // rest of implementation Console.WriteLine("IO spec"); } public void Handle(FileNotFoundException exception) { // rest of implementation Console.WriteLine("FileNotFoundException spec"); } }</span></span></code> </pre><br></div></div><br>  Apply: <br><br><pre> <code class="cpp hljs">IExceptionHandler defaultHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileSystemExceptionHandler(); defaultHandler.HandleException(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IOException()); <span class="hljs-comment"><span class="hljs-comment">// Handle(IOException) overload defaultHandler.HandleException(new DirectoryNotFoundException()); // Handle(IOException) overload defaultHandler.HandleException(new FileNotFoundException()); // Handle(FileNotFoundException) overload defaultHandler.HandleException(new FormatException()); // Handle(Exception) =&gt; OnFallback</span></span></code> </pre><br>  Everything worked!  But how?  After all, we have not written a single line of code to resolve exception types, etc. <br><br><div class="spoiler">  <b class="spoiler_title">Consider the scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1f0/d32/21b/1f0d3221b2734801802709ac06b98b6a.png"><br></div></div><br>  So, if we have an appropriate IExceptionHandler implementation, then we use it. <br>  If not, <b>multiple dispatch</b> via <font color="#2E74B5"><b>dynamic</b></font> . <br><br>  Thus, example No. 1 can be solved with just one line of code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sanitize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sanitizer().Cleanup((dynamic)node); }</code> </pre><br><h3>  <font color="#2E74B5">Summing up</font> </h3><br>  At first glance, it is not very obvious that the whole pattern can fit only in one language construct, but it is. <br>  On closer examination, we saw that building a simple policy-based exception handler is quite possible. <br></div><p>Source: <a href="https://habr.com/ru/post/283522/">https://habr.com/ru/post/283522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283512/index.html">How does cross-device advertising work: the complexity and prospects of technology development</a></li>
<li><a href="../283514/index.html">Bushido Mobius: Member Path</a></li>
<li><a href="../283516/index.html">.NET development: nine questions for adults</a></li>
<li><a href="../283518/index.html">Data on the frontend: a step towards future applications</a></li>
<li><a href="../283520/index.html">JPoint 2016: Faster, higher, more productive</a></li>
<li><a href="../283526/index.html">35 useful tips for Ludum Dare members</a></li>
<li><a href="../283528/index.html">What makes a programmer a good programmer?</a></li>
<li><a href="../283530/index.html">Interfaces in the real world: we design the most hellish interface</a></li>
<li><a href="../283532/index.html">Game that is not a game</a></li>
<li><a href="../283536/index.html">Security Week 19: AI in security, zero days at Microsoft and Adobe, a different look at crypto-fiber</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>