<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network installation of workstations based on Debian GNU / Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 Automatic deployment of the workplace - the task, one can say, is typical. Surely many people decided it - starting from the network infrast...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network installation of workstations based on Debian GNU / Linux</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  Automatic deployment of the workplace - the task, one can say, is typical.  Surely many people decided it - starting from the network infrastructure and <s>instructions from the authorities of</s> personal preferences;  using ready-made solutions, or creating your own. <br><br>  In this article, I would like to share with the community my way of building an automated network installation system for workstations running under Debian GNU / Linux.  No flash drives, disks and other external hard drives, which for some reason I personally have the habit of regularly getting lost in the cracks of a working mess, do not read or be cleaned to write some incredibly necessary garbage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If for you this state of affairs seems close and familiar - welcome under cat. <br><a name="habracut"></a><br><h4>  Wednesday deployment </h4><br>  For the network installation to work, you first need a configured DHCP and TFTP server.  Unfortunately, I cannot now remember what I was guided by when choosing them, since the first successful experiments were made a year and a half ago, or even earlier.  At that time, isc-dhcp-server and tftpd-hpa were chosen as dhcp and tftp servers, respectively. <br><br><pre><code class="bash hljs">aptitude install isc-dhcp-server tftpd-hpa</code> </pre> <br>  For the dhcp server, you must specify the interface to use in / etc / default / isc-dhcp-server and set the settings for your network in /etc/dhcp/dhcpd.conf.  For the 192.168.121.0/24 network and the eth0 interface, it looks like this: <br><br><pre> <code class="bash hljs"> sed -i <span class="hljs-string"><span class="hljs-string">'s/INTERFACES=""/INTERFACES="eth0"/g'</span></span> /etc/default/isc-dhcp-server sed -i <span class="hljs-string"><span class="hljs-string">'s/#authoritative;/authoritative;/g'</span></span> /etc/dhcp/dhcpd.conf <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">' subnet 192.168.121.0 netmask 255.255.255.0 { range 192.168.121.128 192.168.121.200; option domain-name-servers 192.168.121.1; option routers 192.168.121.1; filename "pxelinux.0"; }'</span></span> &gt;&gt; /etc/dhcp/dhcpd.conf</code> </pre><br>  It goes without saying that you may have other parameters and settings.  The only line we are interested in here is the penultimate one, where the name of the file that will be transmitted via tftpd over the network for initial loading of the created system is indicated. <br><br>  I left tftpd on the default settings;  changed only the TFTP_DIRECTORY parameter in the / etc / default / tftpd-hpa file, which is not necessary in principle.  Next, download the image for the Debian network installation to this directory and unpack it. <br><br><pre> <code class="bash hljs">wget http://ftp.debian.org/debian/dists/wheezy/main/installer-i386/current/images/netboot/netboot.tar.gz tar -xzvf netboot.tar.gz rm netboot.tar.gz</code> </pre><br>  At this stage, we can already install the system over the network (yes, that's how simple it is), but so far only in manual mode.  That although it saves time and nerves in search of a bootable flash drive / compact, but not really, so go to the next part of our automation - creating a so-called ‚Äúanswer file‚Äù for all questions of the installer. <br><br><h4>  Answers and questions </h4><br>  The response file can be embedded in the initrd, can be placed on external media, or on a web server, which will be available during the installation process.  The last option turned out to be the most convenient for me both for making changes (no need to reassemble the initrd), or directly in the process of work (no need to look for a flash drive with answers).  I want to note that although I have this whole thing spinning on one computer, this is completely optional. <br><br>  In order for the installer to ‚Äúfind out‚Äù where to look for answers to all his questions, in the $ TFTP_DIRECTORY / debian-installer / i386 / boot-screens / txt.cfg file, you need to add the auto and url parameters to the last line (which starts with append).  As a result, the file will be about the following <br><br><pre> <code class="bash hljs">default install label install menu label ^Install menu default kernel debian-installer/i386/linux append vga=788 initrd=debian-installer/i386/initrd.gz -- quiet auto=<span class="hljs-literal"><span class="hljs-literal">true</span></span> url=http://192.168.121.1/pxeinstall/preseed.cfg</code> </pre><br>  If desired, you can also change the timeout 0 in the configuration of the menu to timeout 5, for example, and save yourself the trouble of pressing ‚ÄúEnter‚Äù before starting the installation.  Personally, I returned the ‚Äúeternal‚Äù timeout after a neighbor, who was upset with feelings, ran to me, who sent a reboot to restart the car and went out to smoke, and when he returned, he saw the newly installed Debian instead of the favorite ‚Äúsevens‚Äù.  My exhortations that the newly installed system, too, of the seventh version did not comfort him :( <br><br>  Of course, on the appropriate host, you need a web server with a pxeinstall directory, which is still useful to us.  Here I didn‚Äôt think of anything - apache was already standing for internal needs.  If you do not have a web server yet, the command <br><br><pre> <code class="bash hljs"> aptitude install apache2 &amp;&amp; mkdir /var/www/pxeinstall</code> </pre><br>  should solve this problem.  So go to writing answers. <br><br>  The official sample file can be found <a href="https://www.debian.org/releases/stable/example-preseed.txt">here</a> .  You can also get a ready-made response file for your system by running the command <br><br><pre> <code class="bash hljs"> debconf-get-selections --installer &gt; my.preseed.cfg</code> </pre><br>  And with the help <br><br><pre> <code class="bash hljs"> debconf-get-selections &gt;&gt; my.preseed.cfg</code> </pre><br>  You will supplement this file with all the answers that you gave when installing additional software. <br><br>  True, I somewhere met the statement that the file obtained in this way can work incorrectly and, as a result, the recommendation to correct the original file to fit my needs, using my.preseed.cfg only as a hint. <br><br>  In general, the study and editing of this file is not a problem - everything is well commented;  the necessary values ‚Äã‚Äãof the necessary parameters can be found in the file that generated debconf.  And yet there are several nuances that I would like to dwell upon. <br><br><h5>  Disk partitioning </h5><br>  There are two ways to carry out a breakdown of disks at this stage - select the preset automatic splitting option, or set the size of the partitions manually.  Three pre-installed options - all files on one partition;  a separate partition under / home and a separate partition under / home, / tmp, / usr and / var.  Specified in the answer file line <br><br><pre> <code class="bash hljs"> di partman-auto/choose_recipe select atomic</code> </pre><br>  Instead of atomic, you can use home and multi respectively. <br><br>  As an experiment, and for many typical breakdown options, this is quite enough, but we use markup, which traditionally allocates a separate section for service needs, so <br><br><pre> <code class="bash hljs"> di partman-auto/expert_recipe string \ boot-root :: \ 30000 5000 40000 ext4 \ <span class="hljs-variable"><span class="hljs-variable">$primary</span></span>{ } <span class="hljs-variable"><span class="hljs-variable">$bootable</span></span>{ } \ method{ format } format{ } \ use_filesystem{ } filesystem{ ext4 } \ mountpoint{ / } \ . \ 20000 3000 40000 ext3 \ method{ format } format{ } \ use_filesystem{ } filesystem{ ext3 } \ mountpoint{ /srv } \ . \ 10000 2000 10000000 ext4 \ method{ format } format{ } \ use_filesystem{ } filesystem{ ext4 } \ mountpoint{ /home } \ . \ 50% 6000 200% linux-swap \ method{ swap } format{ } \ .</code> </pre><br>  In short, what is what. <br><br>  boot-root is some kind of a witch, without which the whole canoe refuses to work :) After it, there are parameters for each of the created partitions.  In the first line, three digits respectively indicate the minimum size of the section, the priority for the section calculation algorithm, and the maximum size of the section.  The size is indicated in megabytes, while at the breakdown it will be trimmed according to the size of the cylinder.  In addition to integer values, you can also use a percentage of the size of RAM.  Variants of the type ‚Äú2000 + 50%‚Äù are also allowed, that is 2000MB + half RAM.  Priority is a conditional "mid-ceiling" number.  The lower it is, the smaller the size of the partition will be closer to the minimum value.  It is recommended that one of the sections indicate the maximum size of a larger one, but not more than 1,000,000,000 so as not to run into overflow: on i386 integer arithmetic is limited to 31 bits.  The remaining value is, of course, the file system type. <br><br>  The $ primary {} and $ bootable {} specifiers indicate respectively that the partition being created will be primary and / or bootable.  method {format} must be specified if the partition will be formatted.  In addition to ‚Äúformat‚Äù, ‚Äúswap‚Äù values ‚Äã‚Äãfor the swap partition and ‚Äúkeep‚Äù to keep the partition intact can also be used.  If method {format} is specified, you must also additionally set another format {} specifier.  The following use_filesystem {} and filesystem {ext4} specifiers determine in which file system the partition will be formatted.  The last specifier used - mountpoint - defines the mount point of the partition being created.  It is crowned with a good dot symbol, which separates the descriptions of sections from each other. <br><br>  All these parameters should be specified in one line, which makes editing or searching for an error a rather fun exercise, so we traditionally use beksleshy to make our markup more or less friendly. <br><br>  A more detailed description of the disk layout process, including lvm, raid and other joys, can be found <a href="http://anonscm.debian.org/gitweb/%3Fp%3Dd-i/debian-installer.git%3Ba%3Dblob%3Bf%3Ddoc/devel/partman-auto-recipe.txt%3Bh%3D7313ddacbfb107fe0694a41ae7002f3ecde79d80%3Bhb%3DHEAD">here</a> and <a href="http://anonscm.debian.org/gitweb/%3Fp%3Dd-i/debian-installer.git%3Ba%3Dblob%3Bf%3Ddoc/devel/partman-auto-raid-recipe.txt%3Bh%3Ddaa7727c9ecaac45aa6a11a0b31613edcabd5a03%3Bhb%3DHEAD">here</a> . <br><br><h5>  Expanding opportunities </h5><br>  Despite the fact that using the answer file, you can fully automate the process of installing the system, yet there remain tasks that it does not solve.  This is a variety of configs edits, and a standard set of documents / settings that the user should have at hand, and of course the <s>seals</s> corporate logo on the desktop.  To solve this problem, I use the ability to execute any command after installing the system, but with the / target still mounted: <br><br><pre> <code class="bash hljs"> di preseed/late_command string \ chroot /target sh -c <span class="hljs-string"><span class="hljs-string">"/usr/bin/wget -O /tmp/postinstall http://192.168.121.1/pxeinstall/postinstall &amp;&amp; /bin/sh -x /tmp/postinstall"</span></span></code> </pre><br>  Ie, just download the prepared script and run it. <br><br>  There is nothing particularly outstanding in the postinstall file ‚Äî repositories with additional software are connected, the same software is installed.  Then the configuration files are corrected and the reference home directory along with all the necessary settings is rolled out to the user. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash deployserver=192.168.121.1 deployconfig=/pxeinstall/configs # # Installing additional software # wget $deployserver$deployconfig/apt_sources.list -O /etc/apt/sources.list export DEBIAN_FRONTEND=noninteractive aptitude update #Installing unzip with full cyryllic support apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4EEBB18420019065 aptitude -y install unzip p7zip-full #opera has own repo wget -O - http://deb.opera.com/archive.key | apt-key add - aptitude update aptitude -y install opera #For skype we do the following aptitude install libasound2-plugins wget -O skype-install.deb http://www.skype.com/go/getskype-linux-deb dpkg -i skype-install.deb # wvdial cofig for intertelecom. Just in case. wget $deployserver$deployconfig/wvdial.conf -O /etc/wvdial.conf #Set adequate editor by default update-alternatives --set editor /usr/bin/vim.basic # # User profile # username=`cat /etc/passwd | grep 1000 | awk 'BEGIN { FS = ":" } ; { print $1 }'` cd /home/$username wget $deployserver$deployconfig/home.tar.gz # This archive is made by commands # cd home &amp;&amp; tar -czvf ../home.tar.gz . # to include also hidden (config) files tar -xzvf home.tar.gz chown -R $username /home/$username rm home.tar.gz # # Additional system configs # wget $deployserver$deployconfig/10-service.rules -O /etc/udev/rules.d/10-service.rules wget $deployserver$deployconfig/service-blacklist.conf -O /etc/modprobe.d/service-blacklist.conf sed -i 's/#AutoLoginEnable=true/AutoLoginEnable=true/g' /etc/kde4/kdm/kdmrc sed -i 's/#AutoLoginAgain=true/AutoLoginAgain=true/g' /etc/kde4/kdm/kdmrc sed -i 's/#AutoLoginUser=fred/AutoLoginUser='$username'/g' /etc/kde4/kdm/kdmrc sed -i 's/"syntax on/syntax on/g' /etc/vim/vimrc exit 0</span></span></code> </pre><br><br>  If desired, in the preceed.cfg you can generally put only the base system, and do everything else from this script.  The advantage of this approach is that you have a separate ready-made script that installs and configures the workstation on any working debian, and not only in the installer environment.  Or maybe he already has it and it would be nice to use it instead of looking for the necessary keys in preseed.cfg.  In this case, the postinstall only downloads a full-fledged script, an example of which we have just reviewed, and which will start after a reboot already in the installed system. <br><br>  For us personally, another reason for just such a two-step approach was the very slow execution of the script in the installer environment.  For example, installing packages of about 600 MB from the repository on the local network plus unpacking the archive of the home directory takes more than a day.  I could not find the reason for such a slow execution of the script, which on the same machine after a reboot, works in a matter of minutes and will be very happy if someone from experienced habrazhiteley tells you where the dog rummaged. <br>  The last line with the forced installation of the bootloader appeared here after the installer stubbornly refused to install grub on some branded computer with windows7 preinstalled. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # Get firstboot script /usr/bin/wget -O /root/firstboot http://192.168.121.1/pxeinstall/firstboot chmod +x /root/firstboot # create a service that will run our firstboot script cat &gt; /etc/init.d/firstboot &lt;&lt;EOF ### BEGIN INIT INFO # Provides: firstboot # Required-Start: $networking # Required-Stop: $networking # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: A script that runs once # Description: A script that runs once ### END INIT INFO cd /root /usr/bin/nohup sh -x /root/firstboot &amp; EOF chmod +x /etc/init.d/firstboot update-rc.d firstboot defaults 99 grub-install --recheck --no-floppy /dev/sda</span></span></code> </pre><br><br>  Needless to say, in this case, in our firstboot script, you need to remember to delete yourself after completing the work: <br><pre> <code class="bash hljs">update-rc.d firstboot remove</code> </pre><br><h4>  Conclusion </h4><br>  The above method for deploying workstations allows you to keep everything in one place as regards OS installation - scripts, configs, additional files - which simplifies backup and allows you not to search for a USB flash drive with the correct version of the system image.  Well, this method is flexible enough to simply and quickly change the installation script. <br><br>  We are happy to review your comments and answer the questions that appear. </div><p>Source: <a href="https://habr.com/ru/post/231967/">https://habr.com/ru/post/231967/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231957/index.html">Memory management in the Linux kernel. Yandex Workshop</a></li>
<li><a href="../231959/index.html">Who are you? A freelance artist, a gzhel tableware or a house painter?</a></li>
<li><a href="../231961/index.html">Non-functional software requirements. Part 1</a></li>
<li><a href="../231963/index.html">As we did a small security system on the RPi. Part 2</a></li>
<li><a href="../231965/index.html">Digest photo news # 8: the best materials of the end of July</a></li>
<li><a href="../231969/index.html">Java Gadget Switch</a></li>
<li><a href="../231971/index.html">Introduction to sbt</a></li>
<li><a href="../231973/index.html">20 excellent quotes about the conversion of the "guru"</a></li>
<li><a href="../231979/index.html">Simulation of the procedure for connecting bluetooth devices and whether there is a need for models of this kind</a></li>
<li><a href="../231981/index.html">From idea to Google Play in 30 hours</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>