<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unicorn became interested in the microworld</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This time, interesting examples of errors were presented to us by the microworld. We checked the open project ŒºManager using the PVS-Studio code analy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unicorn became interested in the microworld</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2b1/578/3f2/2b15783f2f481b823c3b50bcadaca205.png" alt="PVS-Studio and ŒºManager (Micro-Manager)" align="left"><br>  This time, interesting examples of errors were presented to us by the microworld.  We checked the open project ŒºManager using the PVS-Studio code analyzer.  This is a software package for automated microscope imaging. <br><a name="habracut"></a><br><h2>  ŒºManager </h2><br>  This is a relatively small project.  The source code is about 11 megabytes.  What exactly this project is for, I do not know.  I was asked to check it out.  And now the unicorn is in a hurry to help.  Probably a necessary and useful project, once asked. <br><br>  Project site: <a href="http://www.micro-manager.org/">Micro-Manager</a> . <br><br>  The analysis is as always done using the <a href="http://www.viva64.com/en/pvs-studio/">PVS-Studio</a> analyzer.  By the way, if you missed, then here is the comparison that our potential users have been waiting for: " <a href="http://www.viva64.com/ru/b/0241/">Comparing code analyzers: CppCat, Cppcheck, PVS-Studio, Visual Studio</a> ." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At this lyrical digression is over.  Let's start looking at interesting code snippets. <br><br><h2>  long! = int </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2e1/a9e/f58/2e1a9ef5869d1f3e9060271faddda42c.png" alt="long!  = int"></div><br><br>  The ŒºManager project claims to be cross-platform.  Therefore, you need to be careful with the 'long' type.  On 32-bit systems, the size of the 'long' type is the same as the size of the 'int' type.  But in 64-bit systems it can be different.  In Win64, the 'long' type remains 32-bit.  In the 64-bit Linux world, another <a href="http://www.viva64.com/ru/t/0012/">data model is</a> adopted, in which the 'long' is 64-bit.  You need to be vigilant using this type. <br><br>  The ŒºManager project contains the following bad code: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DCMOTSTATUS</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> wChannel; <span class="hljs-comment"><span class="hljs-comment">// Channel ident. unsigned int lPosition; // Position in encoder counts. unsigned short wVelocity; // Velocity in encoder counts/sec. unsigned short wReserved; // Controller specific use unsigned int dwStatusBits; // Status bits (see #defines below). } DCMOTSTATUS; int MotorStage::ParseStatus(...., DCMOTSTATUS&amp; stat) { .... memcpy(&amp;stat.lPosition, buf + bufPtr, sizeof(long)); //&lt;&lt;&lt;(1) bufPtr += sizeof(long); memcpy(&amp;stat.wVelocity, buf + bufPtr, sizeof(unsigned short)); bufPtr += sizeof(unsigned short); memcpy(&amp;stat.wReserved, buf + bufPtr, sizeof(unsigned short)); bufPtr += sizeof(unsigned short); memcpy(&amp;stat.dwStatusBits, buf + bufPtr, sizeof(unsigned long)); //&lt;&lt;&lt;(2) return DEVICE_OK; }</span></span></code> </pre> <br>  In line (1) and (2), data is copied into variables of the type 'int'.  Copies a number of bytes equal to the size of the 'long' type.  Recall that in the 64-bit program the 'long' can occupy 8 bytes.  And the type 'int' takes only 4 bytes. <br><br>  In case (1) there is nothing to worry about.  Change the value of the following members of the structure.  Then these members will be filled again.  Already correct. <br><br>  But the case (2) is critical.  The value of the last member changes.  There will be a record for the redistribution of the structure.  What this leads to depends on the luck and the phase of the moon. <br><br>  Errors are detected due to the PVS-Studio diagnostic messages: <ul><li>  V512 A call of the memcpy function will lead to overflow of the buffer &amp; stat.lPosition.  MotorStage.cpp 247 </li><li>  V512 A call of the memcpy function will lead to overflow of the buffer &amp; stat.dwStatusBits.  MotorStage.cpp 256 </li></ul><br><h2>  Stop the garbage compactor! </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2fe/539/c72/2fe539c727a96dfd4b9a3a5e2f913e04.png" alt="R2D2, stop the Garbage Compactor 3263827"></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> stopSgn[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {<span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x66</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MotorStage::Stop() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(stopSgn, answer, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(stopSgn) != <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERR_UNRECOGNIZED_ANSWER; .... }</code> </pre> <br>  The error is that the memcmp () function compares only one byte.  Why?  Offensive error.  Not there is a closing bracket.  The number of bytes for comparison is calculated as follows: sizeof (stopSgn)! = 0. This expression is equal to the value of 'true', which turns into one. <br><br>  The condition should be: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(stopSgn, answer, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(stopSgn)) != <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  Error detected using diagnostics: V526 The 'memcmp' function returns 0 if the corresponding buffers are equal.  Consider examining the condition for mistakes.  MotorStage.cpp 385 <br><br><h2>  Identical comparisons </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0bc/c42/ead/0bcc42ead0006c252c1df995a15a00d4.png" alt="Identical comparisons"></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* g_Out = <span class="hljs-string"><span class="hljs-string">"Out"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FieldDiaphragm::OnCondensor(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> value; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == g_Out) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g_hub.SetCondensorPosition(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, *GetCoreCallback(), <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == g_Out) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g_hub.SetCondensorPosition(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, *GetCoreCallback(), <span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  The second if statement contains an invalid condition.  What should be the second condition, I do not know.  However, it is clearly seen that the second condition will never be fulfilled. <br><br>  Diagnostics that detected the error: V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1455, 1457. LeicaDMR.cpp 1455 <br><br>  There is another code fragment with a similar error.  Apparently, with the installation of the position of a wheel there will be problems: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wheel</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CStateDeviceBase&lt;Wheel&gt; { .... <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> wheelNumber_; .... }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Wheel::SetWheelPosition(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> position) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cmd[<span class="hljs-number"><span class="hljs-number">4</span></span>]; cmd[<span class="hljs-number"><span class="hljs-number">0</span></span>] = moduleId_; cmd[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; cmd[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">58</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wheelNumber_ == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (position) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">49</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">51</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">52</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">53</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">54</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wheelNumber_ == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (position) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">33</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">35</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">36</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">37</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: cmd[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">94</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  PVS-Studio diagnostic message: V517 The use of 'if (A) {...} else if (A) {...}' pattern was detected.  There is a possibility of logical error presence.  Check lines: 645, 654. Ludl.cpp 645 <br><br><h2>  It seems we have forgotten something </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fff/0b4/dd3/fff0b4dd3fd434af8eda9ed4c6d4da67.png" alt="Feel like we've missed something"></div><br><br>  I propose to look at this code here.  Notice what is missing in it? <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MP285</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMotionMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_nMotionMode; } .... }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ZStage::_SetPositionSteps(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MP285::GetMotionMode == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lOldZPosSteps = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)MP285::Instance()-&gt;GetPositionZ(); dSec = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">labs</span></span>(lZPosSteps-lOldZPosSteps) / dVelocity; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dSec = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">labs</span></span>(lZPosSteps) / dVelocity; } .... }</code> </pre> <br>  Lacking a very important thing.  Lost brackets ().  The program should call the GetMotionMode () function and compare the value returned to it with zero.  Instead, the address of the function is compared with zero. <br><br>  The error was detected using the diagnostic: V516 Consider inspecting an odd expression.  Non-null function pointer is compared to null: 'MP285 :: GetMotionMode == 0'.  MP285ZStage.cpp 558 <br><br><h2>  Lonely wanderer </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e6f/678/fd5/e6f678fd51a622bae68db9bb0ae30470.png" alt="wanderer"></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HalogenLamp::SetIntensity(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> intensity) { .... command_stream.str().c_str(); .... }</code> </pre> <br>  What it is?  Side effect of refactoring?  Unfinished code?  Harmless extra line or error? <br><br>  There are two places where you can see such lonely wanderers: <ul><li>  V530 The return value of the 'c_str' is required to be utilized.  ZeissCAN.cpp 1553 </li><li>  V530 The return value of the 'c_str' is required to be utilized.  ZeissCAN.cpp 2800 </li></ul><br><h2>  Brahmins </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c32/702/828/c327028283a01e47d18cc37bf1d5d0d7.png" alt="Brahmins"></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LeicaScopeInterface::GetDICTurretInfo(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> tmp; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmp == <span class="hljs-string"><span class="hljs-string">"DIC-TURRET"</span></span>) scopeModel_-&gt;dicTurret_.SetMotorized(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> scopeModel_-&gt;dicTurret_.SetMotorized(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); .... }</code> </pre> <br>  This is what the <a href="http://www.viva64.com/go.php%3Furl%3D1365">Brahmin</a> looks like.  Regardless whether the condition is met or not, the same code is executed. <br><br>  Warning: V523 The 'then' statement is equivalent to the 'else' statement.  LeicaDMIScopeInterface.cpp 1296 <br><br>  Another mistake of a similar kind.  Here the same strings are compared.  Probably, this code contains a typo: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> XLedDev::Initialize() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( XLed::Instance()-&gt;GetXLedStr(XLed::XL_WLedDevName + m_nLedDevNumber).c_str(), XLed::Instance()-&gt;GetXLedStr(XLed::XL_WLedDevName + m_nLedDevNumber).c_str() ) != <span class="hljs-number"><span class="hljs-number">0</span></span>) .... }</code> </pre> <br>  Warning: V549 The first argument of 'strcmp' function is equal to the second argument.  XLedDev.cpp 119 <br><br><h2>  Something does not fit </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18b/bd3/272/18bbd32724005d628f89092f157a876d.png" alt="A mismatch"></div><br><br>  Values ‚Äã‚Äãof 'false' and 'true' can be implicitly cast to the type 'int': <ul><li>  false becomes 0; </li><li>  true turns to 1. </li></ul>  For example, the following code will compile successfully: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  The F () function returns 0. <br><br>  Sometimes people make mistakes, and instead of the error status, which is of type 'int', they return 'false' or 'true'.  This happens because of forgetfulness.  It's okay if the error status is encoded with a value of 0. <br><br>  A trouble arises if error statuses are encoded with values ‚Äã‚Äãother than zero.  That is what happens in the ŒºManager project. <br><br>  The following predefined values ‚Äã‚Äãare available: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEVICE_OK 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEVICE_ERR 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// generic, undefined error #define DEVICE_INVALID_PROPERTY 2 #define DEVICE_INVALID_PROPERTY_VALUE 3 #define DEVICE_INVALID_PROPERTY_TYPE 5 ....</span></span></span></span></code> </pre> <br>  Note that 0 means everything is fine.  Other values ‚Äã‚Äãreport some kind of error. <br><br>  It seems to me that there is a confusion in the code of the ŒºManager project with the statuses and values ‚Äã‚Äãof 'true', 'false'. <br><br>  Consider the CreateProperty () function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MM::PropertyCollection::CreateProperty(....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Find(pszName)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DEVICE_DUPLICATE_PROPERTY; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pProp-&gt;Set(pszValue)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DEVICE_OK; }</code> </pre> <br>  Note that if the pProp-&gt; Set (pszValue) call fails, the function returns 'false'.  It turns out that the function returns the status DEVICE_OK.  It is very strange. <br><br>  Another suspicious code snippet: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MM::PropertyCollection::RegisterAction( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pszName, MM::ActionFunctor* fpAct) { MM::Property* pProp = Find(pszName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pProp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DEVICE_INVALID_PROPERTY; pProp-&gt;RegisterAction(fpAct); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  At the end, we see "return true;".  This means that the function will return the status DEVICE_ERR 1 (generic, undefined error).  At the same time, it seems to me that everything is really good. <br><br>  It may seem strange to read, why I call these places suspicious, rather than saying that these are errors.  The fact is that in places 'false' is used specifically to highlight special cases.  Example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> XYStage::Home() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret != DEVICE_OK) { <span class="hljs-built_in"><span class="hljs-built_in">ostringstream</span></span> os; os &lt;&lt; <span class="hljs-string"><span class="hljs-string">"ReadFromComPort failed in "</span></span> <span class="hljs-string"><span class="hljs-string">"XYStage::Busy, error code:"</span></span> &lt;&lt; ret; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;LogMessage(os.str().c_str(), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Error, let's pretend all is fine } .... }</span></span></code> </pre> <br>  Pay attention to the comment.  An error has occurred.  But we pretend that everything is good, returning zero.  Perhaps 'false' is written instead of DEVICE_OK to emphasize the peculiarity of this code. <br><br>  There are only a couple of such comments.  But in other places it is not clear if this is a mistake or ‚Äúsly feint with ears‚Äù.  I would venture to suggest that in half the places everything is correct, and half really turn out to be mistakes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98d/849/f0b/98d849f0b58b3c5c3b15186bd5e885a0.png" alt="Smells"></div><br><br>  In any case, this code smells really bad. <br><br>  Here is a list of all suspicious sites: <ul><li>  V601 The 'false' value is an implicitly casted to the integer type.  Property.cpp 364 </li><li>  V601 The 'true' value is implicitly casted to the integer type.  Property.cpp 464 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  PIGCSControllerCom.cpp 405 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Prior.cpp 778 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Prior.cpp 2308 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Prior.cpp 2313 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Prior.cpp 2322 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  SutterLambda.cpp 190 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  SutterLambda.cpp 269 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  SutterLambda.cpp 285 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Tofra.cpp 900 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Tofra.cpp 1806 </li><li>  V601 The 'false' value is an implicitly casted to the integer type.  Tofra.cpp 1830 </li></ul><br><h2>  Weird get </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/b6c/519/ae4b6c51932cc34d7510155fe0bbaa77.png" alt="Strange"></div><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pgFocus::GetOffset(<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&amp; offset) { MM_THREAD_GUARD_LOCK(&amp;mutex); deviceInfo_.offset = offset; MM_THREAD_GUARD_UNLOCK(&amp;mutex); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DEVICE_OK; }</code> </pre> <br>  It seems to me, or is there something wrong with this code? <br><br>  The analyzer does not like this code: V669 The 'offset' argument is a non-constant reference.  The analyzer is unable to determine where this argument is being modified.  It is possible that the function contains an error.  pgFocus.cpp 356 <br><br>  And indeed, strange.  The function is called "Get____".  The function returns the status.  It also takes the 'offset' argument by reference.  And ... And does not write anything into it.  I do not know how it all works.  But perhaps it was necessary to do the assignment in reverse?  Something like this: <br><pre> <code class="cpp hljs">offset = deviceInfo_.offset;</code> </pre> <br>  Another suspicious GetTransmission () function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SpectralLMM5Interface::GetTransmission(...., <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&amp; transmission) { .... <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> tr = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;tr, answer + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); tr = ntohs(tr); transmission = tr/<span class="hljs-number"><span class="hljs-number">10</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V636 The 'tr / 10' expression was implicitly casted from 'int' type to 'double' type.  Consider using a fractional part.  An example: double A = (double) (X) / Y ;.  SpectralLMM5Interface.cpp 198 <br><br>  Please note that the return value is of type double (we are talking about transmission).  But this value is calculated strange.  The integer value is divided by 10. I have a strong suspicion that a loss of precision occurs.  For example, if 'tr' is 5, then after division we get 0, and not at all 0.5. <br><br>  Probably the correct code should look like this: <br><pre> <code class="cpp hljs">transmission = tr/<span class="hljs-number"><span class="hljs-number">10.0</span></span>;</code> </pre> <br><h2>  Error or not error?  The first impression can be deceptive. </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/184/bdf/8e0/184bdf8e023a42e18b5692f1e607c34a.png" alt="Error or not?"></div><br><br>  In C / C ++, numbers starting with zero are considered to be given in octal format.  There is one suspicious place in the ŒºManager project: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LeicaDMSTCHub::StopXY(MM::Device&amp; device, MM::Core&amp; core) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SetCommand(device, core, xyStage_, <span class="hljs-number"><span class="hljs-number">010</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret != DEVICE_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DEVICE_OK; }</code> </pre> <br>  PVS-Studio warning: V536 Be advised that it is not possible.  Oct: 010, Dec: 8. LeicaDMSTCHub.cpp 142 <br><br>  It is not clear, really wanted to use the number 8, written in octal format, or this is a mistake.  In other places, the numbers written in the decimal number system are passed to the SetCommand () function.  For example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SetCommand(device, core, xyStage_, <span class="hljs-number"><span class="hljs-number">35</span></span>, ack);</code> </pre> <br>  I do not know if an error was found or not, but it is worth mentioning this place. <br><br><h3>  Perfectionist indignant </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d4/266/7c7/1d42667c7e353a21ddc1305838af0046.png" alt="Perfectionist"></div><br><br>  There are lots of little things that are not essential.  However, almost all programmers are perfectionists.  Let's grumble. <br><br>  Full of extra lines.  One example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> XYStage::OnTriggerEndX(MM::PropertyBase* pProp, MM::ActionType eAct){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eAct == MM::BeforeGet) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = GetCommandValue(<span class="hljs-string"><span class="hljs-string">"trgse"</span></span>,xChannel_,chx_.trgse_); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret!=DEVICE_OK) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret!=DEVICE_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; ..... }</code> </pre> <br>  The second check is clearly superfluous. <br><br>  Another example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AFC::Initialize() { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = DEVICE_OK; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret != DEVICE_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; AddAllowedValue(<span class="hljs-string"><span class="hljs-string">"DichroicMirrorIn"</span></span>, <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); AddAllowedValue(<span class="hljs-string"><span class="hljs-string">"DichroicMirrorIn"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret != DEVICE_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; .... }</code> </pre> <br>  The second check again does not make sense.  Before it, the variable 'ret' will not change anywhere.  The second check can be safely removed. <br><br>  There are a lot of such extra checks.  I will give them a list: <a href="http://www.viva64.com/external-pictures/txt/Micro-Manager-V571-V649.txt">Micro-Manager-V571-V649.txt</a> . <br><br>  Even from the little things can be noted the wrong format when working with functions sprintf ().  The unsigned variable is printed as signed.  This can lead to incorrect printing of large values. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MP285Ctrl::Initialize() { .... <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nUm2UStepUnit = MP285::Instance()-&gt;GetUm2UStep(); .... <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(sUm2UStepUnit, <span class="hljs-string"><span class="hljs-string">"%d"</span></span>, nUm2UStepUnit); .... }</code> </pre> <br>  There were three such places: <ul><li>  V576 Incorrect format.  Consider checking the sprintf function.  The SIGNED integer type argument is expected.  MP285Ctrl.cpp 253 </li><li>  V576 Incorrect format.  Consider checking the sprintf function.  The SIGNED integer type argument is expected.  MP285Ctrl.cpp 276 </li><li>  V576 Incorrect format.  Consider checking the sprintf function.  The SIGNED integer type argument is expected.  MP285Ctrl.cpp 327 </li></ul><br><h2>  Conclusion </h2><br>  A single check of this and any other project is ineffective.  Benefit can be obtained only with regular use of static code analyzers.  Then many errors and typos will be corrected at an early stage.  Consider static analysis as an extension of the warnings that the compiler issues. <br><br>  For teams creating medium and large projects for the Windows operating system, we recommend using our static analyzer <a href="http://www.viva64.com/ru/b/0222/">PVS-Studio</a> .  The price depends on the size of the team and the required level of support. <br><br>  For small teams and individual developers, we offer the <a href="http://www.cppcat.com/">CppCat</a> tool.  Individual license - $ 250.  Renewal - $ 200.  When buying multiple licenses - discounts. <br><br>  For those who work with Linux, we suggest paying attention to the free <a href="http://www.viva64.com/ru/t/0083/">Cppcheck</a> code <a href="http://www.viva64.com/ru/t/0083/">analyzer</a> .  Or try the <a href="http://www.viva64.com/ru/b/0219/">Standalone</a> version of PVS-Studio. <br><br><h2>  PS </h2><br>  Translation of this article: " <a href="http://www.viva64.com/en/b/0242/">The Unicorn's Travel to the Microcosm</a> ". <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/216157/">https://habr.com/ru/post/216157/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216141/index.html">Rails 4 Engines. Gem development through mountable engine - we read server logs</a></li>
<li><a href="../216145/index.html">Neuroplasticity - 8 changes in man, formed under the influence of technology</a></li>
<li><a href="../216149/index.html">Simple transmission to Google Analytics of form filling error events in Magento (and not only)</a></li>
<li><a href="../216153/index.html">"Forbid them to ban" or the reverse side of the registry of banned sites</a></li>
<li><a href="../216155/index.html">The realities of working in Smart TV application projects</a></li>
<li><a href="../216159/index.html">Cellular network in Yakutia: what happens to base stations at -60 Celsius</a></li>
<li><a href="../216163/index.html">Sculpting pixel cartoon Simpsons Coach Gag in Excel</a></li>
<li><a href="../216167/index.html">Chromebook + Haswell = Acer C720</a></li>
<li><a href="../216169/index.html">Interaction of vulnerability scanners with Metasploit. Part 2</a></li>
<li><a href="../216173/index.html">Samba4 as AD + file server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>