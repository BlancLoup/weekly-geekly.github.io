<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CloudFlare + nginx, or save with the help of the "coffee maker" (upd2: fast speakers dynamics!)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good Friday, dear% username%, greedy reader and fighter for justice on the Internet! 

 We all remember (Google remembers!) That there was such an art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CloudFlare + nginx, or save with the help of the "coffee maker" (upd2: fast speakers dynamics!)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://blog-static.saraeff.net/uploads/2014/12/cloudflare_cache_et_nginxl.png"></div><br>  Good Friday, dear% username%, greedy reader and fighter for justice on the Internet! <br><br>  We all remember (Google remembers!) That there was such an article <a href="https://habrahabr.ru/post/245165/">CloudFlare + nginx = we cache everything on a free plan</a> .  In which the basic principles of saving on tariffs and servers were considered, by omnivorous caching on the side of CloudFlare files up to 512MB. <br><br>  In this article we will play with the response codes of our server to save even more. <del>  gold to build a ziggurat </del>  and do not switch to the ‚Äúenterprise plan‚Äù that ‚Äúoffer‚Äù us a similar result in our ‚Äúoffers‚Äù. <br><a name="habracut"></a><br>  The free TTL tariff is 2 hours.  This is what they have written in the free plan.  If we dig <a href="https://support.cloudflare.com/hc/en-us/articles/202775670-How-Do-I-Tell-Cloudflare-What-to-Cache-">deeper</a> , we get: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  200 301 120m; </li><li>  302 303 20m; </li><li>  403 1m; </li><li>  404 5m; </li><li>  any 0s; </li></ul><br>  More deployed: redirects are cached for 20 minutes, authorization errors for a minute and classic 404 for 5 minutes.  Other codes are not cached. <br><br>  This means that if you have a cool dynamic website that, for example, provides an API for some operations, etc.  etc.  and you have it wrapped through CF, because it generates files and pictures and a lot of traffic, and the dynamics hurt ... then if someone understands how answers are generated (bare counter in base64 or your base or hashes, but the latter are harder to find ), then he (a person from the <em>dark side of the</em> room without lighting) can deceive other users with a false answer, namely 404. <br><br>  For example: <br><br><ul><li> A simple service that pulls EXIF ‚Äã‚Äãfrom photos that have been uploaded.  Link example <code>http://example.com/api/image/exif/1.txt</code> - which means to give EXIF ‚Äã‚Äãas TXT from a photo with id = 1. </li></ul><br>  Suppose you have 1336 photos there.  This means that 1, 2..1336th will give out the 200th answer, which will be cached on the side of the cloudflare. <br><br><h3>  <a href="https://habr.com/ru/post/321592/">Solution # 2, without a crutch with 418 code</a> (a consequence of <a href="https://habrahabr.ru/post/321592/">this</a> comment). </h3><br><h3>  Solution # 1, crutch through 418 "i'm teapot" code. </h3><br><br>  Here is our emulation (nginx): <br><br><pre> <code class="hljs kotlin">location ~* <span class="hljs-string"><span class="hljs-string">"^/api/image/exif/(.*?)\.txt$"</span></span> { default_type text/plain; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> $testimageid $<span class="hljs-number"><span class="hljs-number">1</span></span>; ##backend <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($testimageid ~ <span class="hljs-number"><span class="hljs-number">1337</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-string"><span class="hljs-string">"Image </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$testimageid</span></span></span><span class="hljs-string"> not found"</span></span>; } ##backend <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"EXIF for </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$testimageid</span></span></span><span class="hljs-string"> image"</span></span>; }</code> </pre><br><img src="https://blog-static.saraeff.net/uploads/2017/02/cf_test_api_1.txt_9aabb4025dcca082.png"><br><br>  And so on‚Ä¶ <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/cf_test_api_1000.txt_883241d68cbb36d5.png"><br><br>  Until we reach the photo with Aidi 1337, which is <strong>not</strong> on the server yet.  What will our dynamics do?  It is logical that it will give some text about the error and the code 404. <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/cf_test_api_1337_404.txt_118877180928cded.png"><br>  Which will be <strong>cached next</strong> .  And all subsequent requests to this URL will issue a response from the CF cache for the next <strong>5 minutes</strong> . <br><br>  Is it critical?  Yes and no.  It depends on how many users you make unhappy and how many millions on the CDN (thanks to me) you will lose millions. <br><br>  What to do?  We look at the <a href="https://support.cloudflare.com/hc/en-us/articles/202775670-How-Do-I-Tell-Cloudflare-What-to-Cache-">official material</a> and understand that it is necessary to change the code ... the server response code in the case of 404. <br><br>  But not everything is so simple.  <em>It is impossible to read_account_and_to change_code_re answer.jpg</em> , since each code carries some semantic load, which will be interpreted or simply hammered into it! <br><br>  For this purpose, a code was invented that does not carry any semantic load, this is code 418, which is described in <a href="https://tools.ietf.org/html/rfc2324">rfc2324</a> . <br><br>  Change our emulation code (and clear the cache for this link in the CF panel): <br><br><pre> <code class="bash hljs">location ~* <span class="hljs-string"><span class="hljs-string">"^/api/image/exif/(.*?)\.txt$"</span></span> { default_type text/plain; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$testimageid</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; <span class="hljs-comment"><span class="hljs-comment">##backend if ($testimageid ~ 1337){ return 418 "Image $testimageid not found"; } ##backend return 200 "EXIF for $testimageid image"; }</span></span></code> </pre><br>  And we get the following picture: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/cf_test_api_1337_418.txt_90ac4ba5091e0401.png"><br><br>  This signifies the fact that <em>as long as there are no pictures, CF does not cache the response from our server, sending a fresh response to clients each time with an error 418 [from our server]</em> .  Following, as the picture appears on the server, and our dynamics gives the answer 200, CF caches this answer for 2 hours. <br><br>  Code 418 refers to the 4xx group of codes.  And even if the end user does not have the definition of this code in the browser (or in the self-written software), then there is at least (must be!) A check on 4x as in the screenshots of this article (firefox, red square). <br><br>  This is how you can simply report an error (4xx) and ask cloudflare not to cache this response with the policy when we are all caching.  This saves from false 404 responses from the server when someone requested <em>future material</em> <strong>before</strong> the publication. <br><br><a name="solution2"></a><h3>  <strong>upd2:</strong> Solution # 2, without a crutch with 418 code.  Corollary from <a href="https://habrahabr.ru/post/321592/">this</a> comment. </h3><br>  In the beginning we set the condition for Browser Cache Expiration: <br><img src="https://blog-static.saraeff.net/uploads/2017/02/Screenshot-02102017-040804-PM_b018c05e7bc9b17b.png"><br><br>  Then create this Page Rule: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/Screenshot-02102017-040828-PM_aa3785df66a82a33.png"><br><br>  The main point: the lack of <strong>Browser Cache TTL</strong> and the presence of <strong>Cache Level: Cache Everything</strong> ! <br><br>  Then, if you have a TTL for valid answers of 315360000, then you need to add <br><pre> <code class="bash hljs">add_header Cache-Control <span class="hljs-string"><span class="hljs-string">"public, max-age=315360000"</span></span>;</code> </pre> <br>  in location'y, without adding it in the server! <br>  eg <br><pre> <code class="bash hljs">location / { add_header Cache-Control <span class="hljs-string"><span class="hljs-string">"public, max-age=315360000"</span></span>; }</code> </pre><br><br>  Location with dynamics is: <br><pre> <code class="bash hljs">location ~* <span class="hljs-string"><span class="hljs-string">"^/api/image/jexif/(.*?)\.txt$"</span></span> { <span class="hljs-comment"><span class="hljs-comment">##backend proxy_pass http://localhost:8080/headerstest/headerstest.jsp?imgid=$1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; ##backend }</span></span></code> </pre><br>  Following makes our dynamics give errors with code 404 with such a header (for example, JSP) <br><pre> <code class="java hljs">response.setHeader(<span class="hljs-string"><span class="hljs-string">"Cache-Control"</span></span>, <span class="hljs-string"><span class="hljs-string">"private, max-age=0"</span></span>);</code> </pre> <br>  As a result, Cloudflare on the above settings does not cache errors, but that's not all! <br><br>  If you need frequent cache updates for 200 responses of your dynamics, you need to specify (again using the example of JSP) <br><pre> <code class="java hljs">response.setHeader(<span class="hljs-string"><span class="hljs-string">"Cache-Control"</span></span>, <span class="hljs-string"><span class="hljs-string">"public, max-age=20"</span></span>);</code> </pre> <br>  And thus you get a 20 <strong>second</strong> cache of answers to your speakers!  What is less than on the rate of Enterprise! <br><br>  In fact, while this works, you can completely remove the site on the cloudflare and hide the server IP (provided that records other than A / AAAA / CNAME / TXT are located on <strong>different</strong> ip). <br><br>  May the force be with you! <br><br>  ZY, <code>set $testimageid $1;</code>  It is used because nginx cannot compare $ 1 in the if expression (but it can operate $ 1 in the config or in the content), for this you need to enter a variable, but <a href="https://habrahabr.ru/users/yourchief/" class="user_link">YourChief</a> <a href="https://habrahabr.ru/post/321592/">showed a</a> more beautiful solution .. For the second solution you need to remove <br>  <code>add_header</code> from server and leave it in location so that the first does not ‚Äústick‚Äù nginx to the second (this is the miracle in the response ‚Äúpublic, max-age = 20, public, max-age = 315360000‚Äù). <br>  Chipped <del>  boilers </del>  the pictures are aligned with each other and compressed in png- <strong>8</strong> , perfectionists on the dial-up can smile! </div><p>Source: <a href="https://habr.com/ru/post/321592/">https://habr.com/ru/post/321592/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321580/index.html">Trigger mailings: how to increase conversion</a></li>
<li><a href="../321582/index.html">PVS-Studio and GitHub-community: the beginning of friendship</a></li>
<li><a href="../321584/index.html">Angular 1.x: creeping webpack, hidden grunt</a></li>
<li><a href="../321586/index.html">Artificial Intelligence Attacks You</a></li>
<li><a href="../321590/index.html">Why VIPER is a good choice for your next application.</a></li>
<li><a href="../321594/index.html">Introduction to CDRS, Apache Cassandra driver fully written in Rust</a></li>
<li><a href="../321596/index.html">How IT professionals work. Dmitry Tsimoshko, director of information technology at Century 21</a></li>
<li><a href="../321598/index.html">Implementation of the procedure ‚ÄúPlanning Release Release by Product‚Äù by the tools of the Atlassian family</a></li>
<li><a href="../321600/index.html">Kotlin Video Tutorial Series</a></li>
<li><a href="../321602/index.html">Procedural level generation for MERC in Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>