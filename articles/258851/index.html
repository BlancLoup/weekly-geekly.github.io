<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing an image file plugin for OpenSceneGraph</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about writing a plugin for OpenSceneGraph. The plugin adds the ability to use the PCX format from ZSoft Corporation. The code is simpl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing an image file plugin for OpenSceneGraph</h1><div class="post__text post__text-html js-mediator-article">  This article is about writing a plugin for OpenSceneGraph.  The plugin adds the ability to use the PCX format from ZSoft Corporation.  The code is simplified to the limit and includes only the reading function, I suggest writing the writing function yourself.  I understand that on the site <a href="http://www.openscenegraph.org/">www.openscenegraph.org</a> you can download the source code of the plug-ins and see how everything works, but the formatting of the source was somewhat surprising and I decided to sort it out.  And leave a note for yourself, so as not to forget. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/ad4/c18/3c3/ad4c183c3fc845b79231abb14129dcde.png" alt="image"><br><br><h4>  Main class </h4><br>  First, we need to create a class, a successor of the osgDB :: ReaderWriter class.  3D plug-ins also use this class: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReaderWriterPCX</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> osgDB::ReaderWriter { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ReaderWriterPCX(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">className</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ReadResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::istream&amp; fin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* options = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ReadResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* options = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ReadResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::istream&amp; fin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* options = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ReadResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* options = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WriteResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osg::Image&amp; image, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::ostream&amp; fout, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WriteResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osg::Image&amp; img, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; fileName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Options* options = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ReadResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readPCXStream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::istream&amp; fin)</span></span></span></span>; };</code> </pre> <br>  As is clear from the code above, this is a description of the functions of the plug-in for reading and writing the file, as well as setting the class name and the file extension used.  I will not give the rest of the code.  You can see it at the link at the end of the article or in the OpenSceneGraph source for another example.  It opens the file, checks for matching extensions, file availability, and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs">ReaderWriterPCX::ReaderWriterPCX() { supportsExtension(<span class="hljs-string"><span class="hljs-string">"pcx"</span></span>,<span class="hljs-string"><span class="hljs-string">"PCX Image format"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ReaderWriterPCX::className() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PCX Image Reader"</span></span>; }</code> </pre><br><h4>  Main function </h4><br>  Although the function type is returned and osgDB :: ReaderWriter :: ReadResult, but in this case it returns osg :: Image.  First of all, we need to know some image parameters, such as image dimensions and the pixel data itself.  The alpha channel does not use this format, and we will make only 256+ support for the palette.  This format uses <s>super duper</s> RLE data compression.  Quote from wiki: <br><blockquote>  The algorithm of such compression is very fast and takes up a small amount of memory, however, it is not very effective, impractical for compressing photos and more detailed computer graphics. <br><br>  Lossless compression is used.  When saving an image, successive pixels of the same color are combined, and instead of specifying the color for each pixel, the color of the group of pixels and their number are indicated.  Such an algorithm compresses well images in which there are areas of the same color. </blockquote><br>  So, open the file and read its signature.  If it is correct, go ahead.  We also check the rest of the data, read the dimensions, the palette (it is located at the end of the file for 256 colors). <br><br><pre> <code class="cpp hljs">fin.read((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*) &amp;pcx-&gt;Identifier, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(pcx-&gt;Identifier)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pcx-&gt;Identifier != <span class="hljs-number"><span class="hljs-number">0x0a</span></span>) { OSG_WARN &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Invalid PCX Identifier\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  And the decompression algorithm itself: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h = height_ret - <span class="hljs-number"><span class="hljs-number">1</span></span>; h &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; --h) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> w = <span class="hljs-number"><span class="hljs-number">0</span></span>; w &lt; width_ret; ++w) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!count) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!fin.read((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*) &amp;tmp, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tmp))) { OSG_WARN &lt;&lt; <span class="hljs-string"><span class="hljs-string">"file truncated\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( (tmp &amp; <span class="hljs-number"><span class="hljs-number">0xc0</span></span>) == <span class="hljs-number"><span class="hljs-number">0xc0</span></span>) { count = tmp &amp; <span class="hljs-number"><span class="hljs-number">0x3f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!fin.read((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*) &amp;tmp, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tmp))) { OSG_WARN &lt;&lt; <span class="hljs-string"><span class="hljs-string">"file truncated\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { count = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } index = h * width_ret + w; imageBuffer[index].red = colorPalette[tmp].red; imageBuffer[index].green = colorPalette[tmp].green; imageBuffer[index].blue = colorPalette[tmp].blue; --count; } }</code> </pre><br>  The imageBuffer array is our data.  It consists of three colors, multiplied by the number of pixels.  That is, this is our unpacked data.  They will be used when installing image data, and the format and size will be selected GL_RGB and 3 bytes, respectively. <br><br>  The plugin must be copied to the folder with the plug-ins.  I have this /usr/lib/osgPlugins-3.2.0/ (I use Linux).  You can check it by using osgmovie, which is in the examples.  At the end of the file should be specified the code connecting the plugin: <br><br><pre> <code class="cpp hljs">REGISTER_OSGPLUGIN(pcx, ReaderWriterPCX)</code> </pre><br><h4>  Epilogue </h4><br>  The presence of plug-ins makes it possible to use OpenSceneGraph to write engines for old games with new graphics or to use their data storage formats in games.  In the next article we plan to write a plugin for reading the 3D format. <br><br>  Sources: <a href="https://bitbucket.org/darkprof/pcx/src">bitbucket.org/darkprof/pcx/src</a> </div><p>Source: <a href="https://habr.com/ru/post/258851/">https://habr.com/ru/post/258851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258833/index.html">Displaying the content of iOS applications in Google Search results and other good news</a></li>
<li><a href="../258841/index.html">Criteria for the quality of video analytics. Part 4</a></li>
<li><a href="../258845/index.html">SAN soup. We build virtual SAN on the Windows Server 2012 R2 platform</a></li>
<li><a href="../258847/index.html">Brief Making of Pinup Character</a></li>
<li><a href="../258849/index.html">Case development of the mobile application "My Beeline" under the Apple Watch: how the spears broke</a></li>
<li><a href="../258853/index.html">Fake Minecraft apps on Google Play downloaded hundreds of thousands of times</a></li>
<li><a href="../258859/index.html">How to develop a multiplayer 3D game without artists, designers and modelers in six months</a></li>
<li><a href="../258861/index.html">Introducing XACML - the standard for Attribute-Based Access Control</a></li>
<li><a href="../258863/index.html">Video from the user: ReactOS is installed and works on a "modern" computer</a></li>
<li><a href="../258865/index.html">.NET conference .NEXT 2015 Piter: Short tour of reports - part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>