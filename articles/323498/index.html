<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ideal catalog, an implementation option</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the continuation of the article " Ideal catalog, architecture sketch ", I will show with examples how to use the proposed database structure to sto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ideal catalog, an implementation option</h1><div class="post__text post__text-html js-mediator-article">  In the continuation of the article " <a href="https://habrahabr.ru/post/322930/">Ideal catalog, architecture sketch</a> ", I will show with examples how to use the proposed database structure to store arbitrary data and perform arbitrary searches on this data.  The scripts are in the repository - <a href="https://github.com/SbWereWolf/universal_data_catalog_idea">universal_data_catalog_idea</a> . <br><br>  I invite under the cut, those who are interested to look at these scripts with author comments. <br><a name="habracut"></a><br><h2>  Repository content </h2><br>  In the repository a full set of infrastructure scripts: <br><br><ol><li>  creating tables </li><li>  filling data; </li><li>  cleaning tables from data; </li><li>  deletion of all created tables; </li></ol><br>  When I started writing scripts, their volume was small, but when I got to create test suites, the amount of code grew to 1000+ lines.  It seems to me that such large scripts should be inserted into the article unnecessary, so if you want to touch the ‚Äúlive‚Äù data, then clone the repository and see how it turns out in real life. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the database schema, I made some small changes - the editors (redactor_id) took out from the content (content), now the content itself, the editors themselves. <br><br><h2>  Highlights of data organization </h2><br>  The system itself does not dictate the rules of use, any logic can be applied to it. <br><br>  The main purpose of the system is data retrieval, data storage is a necessary, but nonetheless secondary functionality. <br><br>  You can store any data, any configuration.  Catalog data consists of Entities (item) and their Values ‚Äã‚Äã(content).  Each Value is a value of a specific Characteristic (property).  Entities with the same set of Characteristics can be combined into Rubric. <br><br>  An entity may belong to one Category, maybe to several, in the present embodiment, only to one. <br><br><h2>  Adding data (storage) </h2><br>  How to add data to the directory can be found in \ deploy \ commit_dml.sql.  The sequence is as follows: <br><br><ol><li>  create rubrics; </li><li>  if the hierarchy of Rubrics is necessary, then create a Hierarchy (element_tree) and distribute the rubrics across the hierarchy (rubric_element_tree); </li><li>  add Characteristics (property); </li><li>  if it is intended to use the Characteristics in accordance with any rules, then you can add the Options of these rules (tag) and dock the Characteristics and Options (property_tag) accordingly; </li><li>  assign rubrics for characteristics (rubric_property); </li><li>  add Entities (item); </li><li>  Group Entities by Rubrics (rubric_item); </li><li>  add content (content) for the characteristics; </li><li>  dock Values ‚Äã‚Äãwith Entities (item_content); </li><li>  if it is assumed that Values ‚Äã‚Äãwill have several editors, then add Editors (redactor) and assign Editors Values ‚Äã‚Äã(redactor_content); </li><li>  if not only string search is expected, then convert user input (content.raw) into a specific data type and write data to the appropriate table (date_matter.date_time, digital_matter.digital, duration_matter.duration, string_matter.string); </li></ol><br>  The list came out long, but in fact all the steps fit into two steps: <br><br><ol><li>  add Entity; </li><li>  set values; </li></ol><br>  The remaining steps as necessary.  With the theory of information storage sorted out.  Now practical application. <br><br><h2>  Practical content catalog </h2><br>  Suppose we want to make our own Avito for the sale of excavators. <br>  To do this, we will add the ‚ÄúExcavators‚Äù root heading, and to it, two subsidiaries: ‚ÄúExcavators for mining‚Äù and ‚ÄúExcavators for loaders‚Äù. <br>  For the category "Excavators career" assign properties: <br>  "Product Model"; <br>  "Trademark"; <br>  "Bucket capacity"; <br>  "The price of goods in rubles"; <br>  "Units of measurement for the item"; <br>  For the category "Excavators loaders" we assign a similar set of properties plus the property "Spade capacity". <br>  Specifications: <br>  "Product Model", <br>  "Trademark", <br>  "Bucket capacity", <br>  "Shovel capacity", <br>  are system values, the values ‚Äã‚Äãof these Characteristics are set by the content manager, we assign the Option to them - ‚ÄúSYSTEM_PROPERTY‚Äù. <br>  ‚ÄúBucket capacity‚Äù and ‚ÄúSpade capacity‚Äù are numerical data - The ‚ÄúDIGITAL_DATA_TYPE‚Äù option, search by them will be a search by value range - ‚ÄúBETWEEN_SEARCH_TYPE‚Äù. <br>  ‚ÄúProduct model‚Äù and ‚ÄúTrademark‚Äù are string data - ‚ÄúSTRING_DATA_TYPE‚Äù, search by ‚ÄúTrademark‚Äù characteristic will be like in the manufacturers reference list - by enumeration - ‚ÄúENUMERATION_SEARCH_TYPE‚Äù, by ‚ÄúProduct model‚Äù we will look for the substring entry - ‚ÄúLIKE_SEARCH_TYPE‚Äù . <br><br>  We hammer in Essences and Values.  Now you can perform a general search. <br><br><h2>  General search </h2><br>  General search implies search everywhere, our everywhere is limited only by Rubrics and Entities, in principle, you can also search in Values, since they store user input in the format of strings.  Search everywhere means searching for substrings, in which columns?  Apparently only the "title" and "description". <br><br>  Go! <br><br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  "" (       ) SELECT 'RUBRIC', rr.code, rr.title, rr.description FROM rubric rr WHERE (rr.title ILIKE '%' || :SEARCH_PATTERN || '%' OR rr.description ILIKE '%' || :SEARCH_PATTERN || '%') AND EXISTS ( SELECT NULL FROM ( WITH RECURSIVE road_map ( id, element_tree_id, code, horizont ) AS ( SELECT cet.id AS id, cet.element_tree_id AS element_tree_id, r.code AS code, 0 AS horizont FROM element_tree cet LEFT JOIN rubric_element_tree ret ON cet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id WHERE r.code = rr.code UNION SELECT pet.id, pet.element_tree_id, r.code, horizont + 1 FROM element_tree pet JOIN road_map c ON (c.element_tree_id = pet.id) LEFT JOIN rubric_element_tree ret ON pet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id ) SELECT NULL FROM road_map rm WHERE rm.code = :CATALOG_ROOT ORDER BY horizont DESC LIMIT 1 ) R ) UNION SELECT 'ITEM', i.code, i.title, i.description FROM rubric rr JOIN rubric_item ri ON rr.id = ri.rubric_id JOIN item i ON ri.item_id = i.id WHERE (i.title ILIKE '%' || :SEARCH_PATTERN || '%' OR i.description ILIKE '%' || :SEARCH_PATTERN || '%') AND EXISTS ( SELECT NULL FROM ( WITH RECURSIVE road_map ( id, element_tree_id, code, horizont ) AS ( SELECT cet.id AS id, cet.element_tree_id AS element_tree_id, r.code AS code, 0 AS horizont FROM element_tree cet LEFT JOIN rubric_element_tree ret ON cet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id WHERE r.code = rr.code UNION SELECT pet.id, pet.element_tree_id, r.code, horizont + 1 FROM element_tree pet JOIN road_map c ON (c.element_tree_id = pet.id) LEFT JOIN rubric_element_tree ret ON pet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id ) SELECT NULL FROM road_map rm WHERE rm.code = :CATALOG_ROOT ORDER BY horizont DESC LIMIT 1 ) R );</span></span></code> </pre> <br><h3>  Request parameters </h3><br><h4>  Root heading </h4><br><pre> <code class="sql hljs">:CATALOG_ROOT</code> </pre> <br>  The root heading code (rubric.code) serves to limit the search area, we can search in ‚ÄúExcavators‚Äù in general, but we can search only in the quarry ones, or we can search in goods in general, but we can only in excavators. <br><br>  Determining whether the next object in the ancestors has a given Rubric is made through a hierarchical query specific to each DBMS. <br><br>  You can search without restrictions in the region, then if we added services to our catalog (for example, for renting excavators) and a resume (for example, an excavator driver) and looking for the substring ‚Äúexcavator‚Äù, then we also have the result of renting excavators and positions for an engineer excavator. <br><br><h4>  Search line </h4><br><pre> <code class="sql hljs">:SEARCH_PATTERN</code> </pre> <br>  The search string is actually the substring that we are looking for; you can split the search string into spaces (or any other delimiter) and search with the condition: <br><br><pre> <code class="sql hljs">WHERE (i.title ILIKE '%' || :PATTERN_PART1|| '%' OR i.description ILIKE '%' || :PATTERN_PART1 || '%') AND (i.title ILIKE '%' || :PATTERN_PART2|| '%' OR i.description ILIKE '%' || :PATTERN_PART2|| '%') <span class="hljs-comment"><span class="hljs-comment">--       AND (i.title ILIKE '%' || :PATTERN_PART_N|| '%' OR i.description ILIKE '%' || :PATTERN_PART_N|| '%')</span></span></code> </pre><br>  The resulting script certainly looks ‚Äúgigantic‚Äù, but it is not written manually, our application writes it, and the DBMS swallows any script, so do not look at the number of letters - this is not significant. <br><br>  Suppose with the help of this search, the user has found the heading he needs, now in the heading it is necessary to find an interesting position, for this it is necessary to make a search among the Entities in the specified parameters. <br><br><h3>  Search by parameters </h3><br>  What would the user imagine the search boundaries, for him it is necessary to calculate these boundaries. <br>  If we do a search by category, then we show the parameters (boundaries) of the search only for system characteristics. <br><br>  To do this, let's see what our heading has, there are system characteristics and what search methods are set: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--         -       SELECT btrim(p.code) AS "property", btrim(tu.code) AS "author_type", btrim(ts.code) AS "search_type", btrim(tt.code) AS "data_type" FROM rubric r JOIN rubric_property rp ON rp.rubric_id = r.id JOIN property p ON rp.property_id = p.id JOIN property_tag ptu on p.id = ptu.property_id JOIN tag tu on ptu.tag_id = tu.id JOIN property_tag pts on p.id = pts.property_id JOIN tag ts on pts.tag_id = ts.id JOIN property_tag ptt on p.id = ptt.property_id JOIN tag tt on ptt.tag_id = tt.id WHERE r.code = 'ekskavatory-karernye' AND tu.code = 'SYSTEM_PROPERTY' AND ts.code IN ('LIKE_SEARCH_TYPE','BETWEEN_SEARCH_TYPE','ENUMERATION_SEARCH_TYPE') AND tt.code IN ('DIGITAL_DATA_TYPE','STRING_DATA_TYPE') ; /* MANUFACTURER_MODEL, SYSTEM_PROPERTY, LIKE_SEARCH_TYPE, STRING_DATA_TYPE TRADE_MARK, SYSTEM_PROPERTY, ENUMERATION_SEARCH_TYPE, STRING_DATA_TYPE BUCKET_CAPACITY_M3, SYSTEM_PROPERTY, BETWEEN_SEARCH_TYPE, DIGITAL_DATA_TYPE */</span></span></code> </pre><br><h4>  Explanation of the request </h4><br>  We look at what characteristics are systemic: <br><br><pre> <code class="sql hljs">tu.code = 'SYSTEM_PROPERTY'</code> </pre><br>  We look at what type of search is defined for these Characteristics: <br><br><pre> <code class="sql hljs">ts.code IN ('LIKE_SEARCH_TYPE','BETWEEN_SEARCH_TYPE','ENUMERATION_SEARCH_TYPE')</code> </pre><br>  We look at the data type for these Characteristics: <br><br><pre> <code class="sql hljs">tt.code IN ('DIGITAL_DATA_TYPE','STRING_DATA_TYPE')</code> </pre><br>  If one of the three search parameters for the Characteristics is not specified, then the search is not possible (joining the tu ts tt tables via JOIN). <br><br>  Determine the properties for the category "Excavators career." <br><br><pre> <code class="sql hljs">r.code = 'ekskavatory-karernye'</code> </pre><br><h4>  Query result </h4><br>  As a result, we obtain three characteristics and search parameters: <br><br><ol><li>  <b>MANUFACTURER_MODEL</b> , SYSTEM_PROPERTY, LIKE_SEARCH_TYPE, STRING_DATA_TYPE </li><li>  <b>TRADE_MARK</b> , SYSTEM_PROPERTY, ENUMERATION_SEARCH_TYPE, STRING_DATA_TYPE </li><li>  <b>BUCKET_CAPACITY_M3</b> , SYSTEM_PROPERTY, BETWEEN_SEARCH_TYPE, DIGITAL_DATA_TYPE </li></ol><br>  Now for each Characteristics we are looking for boundaries. <br><br><h2>  Calculation of search boundaries </h2><br><br><h3>  Calculation of search bounds for ‚ÄúMANUFACTURER_MODEL‚Äù </h3><br>  For ‚ÄúMANUFACTURER_MODEL‚Äù - the type of search by entry (‚ÄúLIKE_SEARCH_TYPE‚Äù) - we do not calculate the boundaries, we display the <b>field for entering the search string for</b> this Characteristic <b>to the user</b> . <br><br><h3>  Calculation of search bounds for TRADE_MARK </h3><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    SELECT sm.string FROM rubric r JOIN rubric_item ri ON r.id = ri.rubric_id JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN property p ON c.property_id = p.id JOIN string_matter sm ON c.id = sm.content_id WHERE p.code = 'TRADE_MARK' AND r.code = 'ekskavatory-karernye' GROUP BY sm.string; /*   */</span></span></code> </pre><br>  Data type - "STRING_DATA_TYPE" - means we are analyzing - string_matter.string.  The search method is ‚ÄúENUMERATION_SEARCH_TYPE‚Äù - it means that we are doing ‚ÄúGROUP BY‚Äù.  Calculated two values ‚Äã‚Äã- "Uralmash" and "Donex", the user displays <b>two checkboxes</b> . <br><br><h3>  Calculation of search bounds for "BUCKET_CAPACITY_M3" </h3><br><pre> <code class="hljs vbscript">--    <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> max(dm.digital) AS maximum, min(dm.digital) AS minimum FROM rubric r <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> rubric_item ri <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.id = ri.rubric_id <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> item i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ri.item_id = i.id <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> item_content ic <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = ic.item_id <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> content c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ic.content_id = c.id <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.property_id = p.id <span class="hljs-built_in"><span class="hljs-built_in">JOIN</span></span> digital_matter dm <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = dm.content_id WHERE p.code = <span class="hljs-comment"><span class="hljs-comment">'BUCKET_CAPACITY_M3' AND r.code = 'ekskavatory-karernye'; /* 25,0.75 */</span></span></code> </pre><br>  Data type - ‚ÄúDIGITAL_DATA_TYPE‚Äù - means analyzing - digital_matter.digital.  Search method - ‚ÄúBETWEEN_SEARCH_TYPE‚Äù - then we do MIN () and MAX ().  Calculated the boundaries from 0.75 to 25, the user displays something like this: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"range"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h2>  Search by parameters </h2><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    /* 'ekskavatory-karernye' 'MANUFACTURER_MODEL' '12' 'TRADE_MARK' '' '' 'BUCKET_CAPACITY_M3' 0.75 25 */ SELECT i.code FROM rubric_item ri join rubric r on ri.rubric_id = r.id JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN string_matter sm ON c.id = sm.content_id JOIN rubric_property rp ON ri.rubric_id = rp.rubric_id JOIN property p ON c.property_id = p.id AND p.id = rp.property_id WHERE r.code = :CODE AND p.code = :MODEL_PROPERTY AND sm.string LIKE '%'||:MODEL_LIKE||'%' INTERSECT SELECT i.code FROM rubric_item ri join rubric r on ri.rubric_id = r.id JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN string_matter sm ON c.id = sm.content_id JOIN rubric_property rp ON ri.rubric_id = rp.rubric_id JOIN property p ON c.property_id = p.id AND p.id = rp.property_id WHERE r.code = :CODE AND p.code = :MARK_PROPERTY AND sm.string IN ( :MARK1 , :MARK2) INTERSECT SELECT i.code FROM rubric_item ri join rubric r on ri.rubric_id = r.id JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN digital_matter dm ON c.id = dm.content_id JOIN rubric_property rp ON ri.rubric_id = rp.rubric_id JOIN property p ON c.property_id = p.id AND p.id = rp.property_id WHERE r.code = :CODE AND p.code = :BUCKET_PROPERTY AND dm.digital BETWEEN :MIN_BUCKET AND :MAX_BUCKET ;</span></span></code> </pre><br>  For each Characteristic, we make a search in accordance with the conditions set by the user and select those Entities that satisfy all the conditions, that is, we intersect - INTERSECT - the results of each separate search with each other. <br><br>  If the user sets one condition, then the search will be based on one Characteristic, if there are 100 conditions, then 100 subqueries will be executed and the Entities will be given to the user who are present in the results of each of the 100 subqueries. <br><br>  As a result of the search by parameters, the user has determined an interesting position (Entity). <br>  It should be noted that a good search had to be done with the selection of the user "SYSTEM", but I missed this point. <br><br><h2>  Search by user values </h2><br>  I remind you that we are doing Avito for excavators.  That is, each position of the catalog has its price, and each user has his own price.  And when our user opened the catalog position card, he saw several offers and accordingly wanted to perform a search on these offers. <br><br>  We had the properties: <br><br><ul><li>  "The price of goods in rubles"; </li><li>  "Units of measurement for the item"; </li></ul><br>  These are user properties, their values ‚Äã‚Äãare set by users, this is regulated by the ‚ÄúUSER_PROPERTY‚Äù Option. <br><br><h3>  Search boundaries </h3><br>  Define a set of custom characteristics for the Excavators Loaders category: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> btrim(p.code) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"property"</span></span>, btrim(tu.code) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"author_type"</span></span>, btrim(ts.code) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"search_type"</span></span>, btrim(tt.code) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"data_type"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> rubric r <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rubric_property rp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rp.rubric_id = r.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> property p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rp.property_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> property_tag ptu <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = ptu.property_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> tag tu <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ptu.tag_id = tu.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> property_tag pts <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = pts.property_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> tag ts <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pts.tag_id = ts.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> property_tag ptt <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id = ptt.property_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> tag tt <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ptt.tag_id = tt.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> r.code = <span class="hljs-string"><span class="hljs-string">'ekskavatory-pogruzchiki'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tu.code = <span class="hljs-string"><span class="hljs-string">'USER_PROPERTY'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ts.code <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'LIKE_SEARCH_TYPE'</span></span>,<span class="hljs-string"><span class="hljs-string">'BETWEEN_SEARCH_TYPE'</span></span>,<span class="hljs-string"><span class="hljs-string">'ENUMERATION_SEARCH_TYPE'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tt.code <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'DIGITAL_DATA_TYPE'</span></span>,<span class="hljs-string"><span class="hljs-string">'STRING_DATA_TYPE'</span></span>) ; <span class="hljs-comment"><span class="hljs-comment">/* GOODS_ITEM_PRICE_RUB,USER_PROPERTY,BETWEEN_SEARCH_TYPE,DIGITAL_DATA_TYPE GOODS_ITEM_UNITS_OF_MEASURE,USER_PROPERTY,ENUMERATION_SEARCH_TYPE,STRING_DATA_TYPE */</span></span></code> </pre><br>  GOODS_ITEM_PRICE_RUB: <br><br><ul><li>  "BETWEEN_SEARCH_TYPE" - search by range; </li><li>  "DIGITAL_DATA_TYPE" - numeric data; </li></ul><br>  GOODS_ITEM_UNITS_OF_MEASURE: <br><br><ul><li>  "ENUMERATION_SEARCH_TYPE" - search with listing; </li><li>  "STRING_DATA_TYPE" - character data; </li></ul><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      'jcb-4cx' SELECT min(dm.digital) AS minimum, max(dm.digital) AS maximum FROM item i JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN property p ON c.property_id = p.id JOIN digital_matter dm ON c.id = dm.content_id WHERE p.code = 'GOODS_ITEM_PRICE_RUB' AND i.code = 'jcb-4cx'; /* 3400000 4700000 */ SELECT sm.string FROM item i JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN property p ON c.property_id = p.id JOIN string_matter sm ON c.id = sm.content_id WHERE p.code = 'GOODS_ITEM_UNITS_OF_MEASURE' AND i.code = 'jcb-4cx' GROUP BY sm.string; /* /  . */</span></span></code> </pre><br><h3>  Search query </h3><br>  We see that all positions have a unit of measure in pieces, recorded simply in different ways, so we are only looking for the price. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* :ITEM_CODE =&gt; 'jcb-4cx' :PRICE_PROPERTY =&gt; 'GOODS_ITEM_PRICE_RUB' :MIN_PRICE =&gt; 3400000 :MAX_PRICE =&gt; 4000000 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.id, r.title, r.description, c.raw <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> item i <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> item_content ic <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = ic.item_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">content</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ic.content_id = c.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> redactor_content rc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = rc.content_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> redactor r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rc.redactor_id = r.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> digital_matter dm <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = dm.content_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rubric_item ri <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = ri.item_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rubric_property rp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ri.rubric_id = rp.rubric_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> property p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.property_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.id = rp.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> i.code = :ITEM_CODE <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.code = :PRICE_PROPERTY <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dm.digital <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> :MIN_PRICE <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> :MAX_PRICE ; <span class="hljs-comment"><span class="hljs-comment">/*   , -3,3 800 000 ,      ,3 400 000 */</span></span></code> </pre><br>  Actually this is a simplified search purely for one Characteristic "price". <br>  As a result of the request, you can also issue digital_matter.digital, but then (if we have INTERSECT on several Characteristics), you should cast to the TEXT type (digital_matter.digital::TEXT), in principle, we output the data in text form, so you can issue content.raw. <br><br><h2>  Conclusion </h2><br>  Actually, this is enough to understand how to apply the idea of ‚Äã‚Äãthe ideal catalog in practice.  Cases certainly an order of magnitude more than the search for goods and supplier. <br><br>  The most important thing I wanted to show is that the idea <b>is flexible enough</b> to be perfect Universal :) <br><br>  Given my recovery_mode, in another week I will be able to lay out php scripts to dynamically generate SQL queries. <br><br>  Thanks to everyone who read, I will be grateful for any criticism and any advice. <br><br><h2>  Addon </h2><br>  For the sake of completeness, there are not enough hierarchical scripts, for the withdrawal of all rubrics from the root, and for the withdrawal of all parents for an arbitrary element.  These scripts are in \ deploy \ view_catalog_settings_and_data.sql. <br><br>  Map rubrics: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--       ,    'GOODS' WITH RECURSIVE road_map ( id, element_tree_id, code, horizont ) AS ( SELECT pet.id AS id, pet.element_tree_id AS element_tree_id, r.code AS code, 0 AS horizont FROM element_tree pet LEFT JOIN rubric_element_tree ret ON pet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id WHERE r.code = :ROOT UNION SELECT cet.id, cet.element_tree_id, r.code, horizont + 1 FROM element_tree cet JOIN road_map c ON (c.id = cet.element_tree_id) LEFT JOIN rubric_element_tree ret ON cet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id ) SELECT code, horizont FROM road_map ORDER BY horizont ASC;</span></span></code> </pre><br>  Path from the root to the specified node (rubric) <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--         'ekskavatory-karernye' WITH RECURSIVE road_map ( id, element_tree_id, code, horizont ) AS ( SELECT cet.id AS id, cet.element_tree_id AS element_tree_id, r.code AS code, 0 AS horizont FROM element_tree cet LEFT JOIN rubric_element_tree ret ON cet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id WHERE r.code = :CHILD UNION SELECT pet.id, pet.element_tree_id, r.code, horizont + 1 FROM element_tree pet JOIN road_map c ON (c.element_tree_id = pet.id) LEFT JOIN rubric_element_tree ret ON pet.id = ret.element_tree_id LEFT JOIN rubric r ON ret.rubric_id = r.id ) SELECT code, horizont FROM road_map ORDER BY horizont DESC;</span></span></code> </pre><br>  Show all Values ‚Äã‚Äãof all Characteristics of one Entity <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     'doneks-eo-4112a-1' SELECT i.title, p.title, dm.digital::TEXT FROM rubric_item ri JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN digital_matter dm ON c.id = dm.content_id JOIN rubric_property rp ON ri.rubric_id = rp.rubric_id JOIN property p ON c.property_id = p.id AND p.id = rp.property_id WHERE i.code = :CODE UNION SELECT i.title, p.title, sm.string::TEXT FROM rubric_item ri JOIN item i ON ri.item_id = i.id JOIN item_content ic ON i.id = ic.item_id JOIN content c ON ic.content_id = c.id JOIN string_matter sm ON c.id = sm.content_id JOIN rubric_property rp ON ri.rubric_id = rp.rubric_id JOIN property p ON c.property_id = p.id AND p.id = rp.property_id WHERE i.code = :CODE;</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/323498/">https://habr.com/ru/post/323498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323488/index.html">What Steam Direct can mean for indie developers</a></li>
<li><a href="../323490/index.html">Evolution of nature</a></li>
<li><a href="../323492/index.html">What startups use IaaS</a></li>
<li><a href="../323494/index.html">Chronic Fatigue Syndrome: how to deal with sleep if you are tired of getting tired</a></li>
<li><a href="../323496/index.html">Ansible: configure a zsh terminal with antigen, autosuggestions, fzf and a beautiful prompt with one command</a></li>
<li><a href="../323500/index.html">Simplify the universal / isomorphic application on React + Router + Redux + Express</a></li>
<li><a href="../323508/index.html">Eclipse as a technology platform for 1C: Enterprise Development Tools</a></li>
<li><a href="../323510/index.html">Veeam Availability Suite now supports integration with Cisco HyperFlex</a></li>
<li><a href="../323512/index.html">Who is interested in the Russian IaaS</a></li>
<li><a href="../323514/index.html">CocoaHeads video footage March 1, 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>