<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart Lock on Android Things and Raspberry Pi3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In December 2016, Google announced the release of the first Developer Preview version of Android Things. Since then, the project has changed a lot. On...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart Lock on Android Things and Raspberry Pi3</h1><div class="post__text post__text-html js-mediator-article"><p>  In December 2016, Google <a href="https://android-developers.googleblog.com/2016/12/announcing-googles-new-internet-of-things-platform-with-weave-and-android-things.html">announced the</a> release of the first Developer Preview version of Android Things.  Since then, the project has changed a lot.  Only a preview version is still available, but with each step the platform has new features and the number of supported devices is growing. </p><br><p>  Every day there are new examples of using IoT devices in the real world, and the platform itself is becoming more and more attractive.  We at <a href="https://livetyping.com/ru/">Live Typing</a> also decided to dive into the most interesting world of the Internet of Things and tell about our experience.  This article is for those who have heard about Android Things, but were afraid to try.  And also about how we implemented our ‚Äúsmart lock‚Äù and use it in our own office. </p><br><p><img src="https://monosnap.com/file/83zgUOAoG7u7cSzuPaW0lHJ2R5F02Z.png" alt="img"></p><a name="habracut"></a><br><h2 id="opisanie-idei">  Description of the idea </h2><br><p>  Problem # 1: Our company rents an office with an electronic pass system and glass doors.  Often, employees forget their cards at home or simply go outside without them, and then knock or call colleagues to get back.  The card must be applied to the magnetic lock and inside and outside the office.  If inside we just tied a card on a string, then getting into the office without a key outside is a problem that we would like to solve. </p><br><p>  Problem number 2: On weekends, various kinds of meetings are held in our office.  The main part of those present are not our colleagues.  Their number varies, but no matter how many of them we cannot give a key to a stranger, as well as keeping the door open all the time is not safe for our property.  Therefore, it is now necessary to appoint a special "man-porter" or prop up the door than you have to. </p><br><p>  We do not have the right to disable, remove or upgrade the gateway system, but restrictions are not applied to connecting something outside.  We decided to equip the door with a servo drive, which will rotate the attached card to the reading sensor with successful face recognition.  A face photo is provided by the camera.  Thus we get a sort of smart door lock. </p><br><p>  With such a lock, we have our own identification system with blackjack and ample opportunities.  (For example, funny photos of employees, from which you can make stickers for internal humorous use).  If we talk about the second problem, the lock allows you to register and pass through the photographs of the participants in the meeting.  Awesome, is not it? </p><br><p>  Further the idea was overgrown with accompanying nuances and questions.  When to start and finish taking pictures?  How often and how long to take photos?  Should I turn off the system during off-hours and at night?  How to visualize the system?  But about all this further and separately.  As a basis for the project, we took the example of <a href="https://developer.android.com/things/training/doorbell/index.html">Doorbell</a> from the official page of Android Things.  The original example is called the ‚Äúbell‚Äù, however, we wanted the system user to unlock the door with minimal effort, and strangers did not get inside.  Therefore, we considered it more correct to call it ‚Äúsmart lock‚Äù. </p><br><h2 id="blagodarnosti">  Thanks </h2><br><p>  At first we had nothing.  Neither the Raspberry itself, nor the components, nor the experience of working with them - only theoretical knowledge obtained from articles and documentation.  For the first time, it was possible to try to play <a href="https://github.com/Mobilatorium/smart-doorbell-codelab">around</a> with Android Things on a <a href="https://github.com/Mobilatorium/smart-doorbell-codelab">CodeLab</a> held in our IT capital of Siberia, Omsk, by the guys from the <a href="http://mobilatorium.org/">Mobilatorium</a> .  We quickly started a project where, instead of Google Cloud Vision, we implemented our implementation of FindFace on <a href="https://www.tensorflow.org/">Tensor Flow</a> .  If you are interested in how the back-end works, then you can read the excellent article <a href="https://habrahabr.ru/post/317798/">‚ÄúWe are looking for familiar faces‚Äù</a> , where the author described in detail the principles and algorithms for working with face recognition.  If not, you can use a bunch of <a href="https://cloud.google.com/vision/">Google Cloud Vision</a> + <a href="https://firebase.google.com/docs/database/">Firebase Realtime Database</a> , as is done in the above CodeLab. </p><br><p>  When we returned to the office, it turned out that our employee Misha has all the necessary components and even the Raspberry Pi3 itself, which he recently acquired, wanting to indulge in something like that.  Also there are components from the guys who conducted the [summer school] ( <a href="https://vk.com/mobilatorium%3Fw%3Dwall-130802553_81%252Fall">https://vk.com/mobilatorium?w=wall-130802553_81%2Fall</a> ) with the study of Arduino.  Many thanks to them for providing the pieces of iron. </p><br><h2 id="komplektuyuschie">  Accessories </h2><br><p>  To implement a smart lock, we needed: </p><br><ul><li>  Raspberry Pi 3 - 1pc; </li><li>  MicroSD 8Gb - 1pc; </li><li>  NoIR Camera V2 - 1pc; </li><li>  Breadboard - 1pc; </li><li>  Infrared PIR Motion Sensor Module - 1pc; </li><li>  SG90 Servo Motor - 1pc; </li><li>  Photoresistor (Light Sensor) - 1pc; </li><li>  Push Button - 1pc; </li><li>  LED - 3 pcs; </li><li>  Resistors (1k) - 3pcs; </li><li>  Resistors (10k) - 1 pc; </li><li>  Pin Jumper Wires - many pieces; </li><li>  Insulating tape - 1 pc. </li></ul><br><p>  All components are easy to find and cheap to order on Chinese sites, and we specifically left their names in English for easy retrieval.  It is worth mentioning that the kit will cost you about $ 100-125.  The most expensive components are the camera and the Raspberry Pi3 itself. </p><br><h2 id="realizaciya">  Implementation </h2><br><p>  For better understanding, we will break the implementation description into separate steps.  Connecting the scheme in parts, it is more convenient to restore the picture at any step.  The code is small, and if you wrote at least one application for Android, then you will not have problems, in my opinion.  For the development we will use the familiar Android Studio.  You can even use your favorite libraries and frameworks such as Dagger, RxJava, Retrofit, OkHttp, Timber, etc. </p><br><p>  Before starting work, you should familiarize yourself with a brief introduction to <a href="https://habrahabr.ru/post/318296/">Android Things</a> , as well as <a href="">pins on the Raspberry Pi3</a> .  And this color picture with pinout is a great visual guide and will come in handy for you more than once. </p><br><p>  Raspberry Pi supports a different set of hardware interfaces.  But we are mainly interested in <a href="https://developer.android.com/things/sdk/pio/gpio.html">GPIO</a> (General-purpose input / output) and <a href="https://developer.android.com/things/sdk/pio/pwm.html">PWM</a> (Pulse Width Modulation).  They will be the main ways of interaction between the board and sensors in the implementation of our project. </p><br><p>  Libraries for various peripheral devices have already been written to us, and many of them are available even immediately from the box.  Therefore, when you begin to integrate a new sensor, first familiarize yourself with <a href="https://github.com/amitshekhariitbhu/awesome-android-things">this</a> and <a href="https://github.com/androidthings/contrib-drivers">this</a> repositories.  There are a lot of drivers here.  Most likely, you will find the right one.  If not, Google provided a special concept of <a href="https://developer.android.com/things/sdk/drivers/index.html">User Drivers</a> , which extends the capabilities of the <a href="https://anatomyofandroid.com/2013/10/12/android-framework/">Android Framework Services</a> .  It redirects what is happening in the gland to the framework and allows you to process them with standard Android API tools and thus create your own driver.  Briefly work with any driver can be divided into the following steps: </p><br><ul><li>  create a driver object; </li><li>  register the driver; </li><li>  subscribe to events; </li><li>  unsubscribe and cancel registration; <br>  You can familiarize yourself with an example of implementing your own driver in <a href="https://www.novoda.com/blog/writing-your-first-android-things-driver-p1/">this article</a> . </li></ul><br><h3 id="shag-1-ustanovka-android-things">  Step 1: Install Android Things </h3><br><p>  Install the latest <a href="https://developer.android.com/things/hardware/raspberrypi.html">Android Things image</a> on the Raspberry Pi3.  It also provides links to installation instructions for various operating systems. </p><br><p>  You can make sure that everything is successfully installed by connecting any display to the Raspberry via an HDMI cable.  If everything is okay, then you will see on the screen an Android Things download animation. </p><br><p><img src="http://cdn01.androidauthority.net/wp-content/uploads/2017/01/android-things-booting-in-tv-16x9-720p-840x472.jpg" alt="img"></p><br><p> For more comfortable interaction with the device, the documentation suggests setting <a href="https://developer.android.com/things/hardware/raspberrypi.html">up a WiFi connection</a> .  After that, at the bottom of the screen under the Android Things screen, the IP address of the device will appear in your WiFi network. </p><br><p><img src="https://androidthings.rocks/images/android-things-ethernet.png" alt="img"></p><br><p>  If there is only one such device in your network, then you can not remember the address and do not check it every time you change, but use the reserved Raspberry host name and connect via the adb command. </p><br><pre><code class="java hljs">$ adb connect Android.local</code> </pre> <br><h3 id="shag-2-sozdanie-prilozheniya">  Step 2: Create the application </h3><br><p>  Create a new application through Android Studio.  You can visualize the work of your program with standard Android widgets by placing them on the screen, although this is not necessary.  Check out the <a href="https://developer.android.com/things/training/first-device/create-studio-project.html">full instructions for creating the first Android Things app</a> on the official website, and we will analyze only the main points. </p><br><p>  Minimum requirements: </p><br><ul><li>  Android Studio 2.2 and up; </li><li>  SDK Tools 25.0.3 and higher; </li><li>  Min SDK 24 and higher; </li><li>  Target SDK 24 and higher. </li></ul><br><p>  Add the Android Things support library to the <code>app/build.gradle</code> , which will give us access to the right API, which is not part of the standard Android SDK. </p><br><pre> <code class="java hljs">dependencies { ... provided <span class="hljs-string"><span class="hljs-string">'com.google.android.things:androidthings:0.4-devpreview'</span></span> ... }</code> </pre> <br><p>  Each application is associated with the default Android library, which contains basic packages for building applications (with standard classes such as Activity, Service, Intent, View, Button, Application, ContentProvider, and so on). <br>  However, some packages are in their own libraries.  If your application uses code from one of these packages, it should explicitly require that it be associated with this package.  This is done through a separate &lt;uses-library&gt; element. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-library</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.things"</span></span></span><span class="hljs-tag">/&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Android Things allows you to simultaneously install only one application, and the more we do not.  Thanks to this restriction, it is possible to declare <code>&lt;intent-filter&gt;</code> for an Activity, like <code>IOT_LAUCHER</code> in an AndroidManifest application, which allows you to start this Activity by default immediately when the device starts.  Also leave the standard <code>&lt;intent-filter&gt;</code> so that Android Studio can launch our application after the build and deployment. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Launch activity as default from Android Studio --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MAIN"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.LAUNCHER"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Launch activity automatically on boot --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MAIN"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.IOT_LAUNCHER"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3 id="shag-3-knopka">  Step 3: Button </h3><br><p>  Let's start by connecting the clock button, when clicked, the camera will take one shot.  This is a simple mechanism: the pusher is pressed - the circuit is closed.  The button with four contacts consists of two pairs of connecting rails.  When closing and opening between the plates of the button, micro-sparks appear, causing multiple switchings in an extremely short period of time.  This phenomenon is called chatter.  More about the <a href="https://goo.gl/6SymSw">button</a> . </p><br><p><img src="https://monosnap.com/file/hasVSud1ExjRLG0Uy2KfDLNQMralP0.png" alt="raspberry_step # 1"></p><br><p>  The button is connected through a prototype board using a 1 kŒ© resistor.  In order not to get confused in the resistors, pay attention to their <a href="https://goo.gl/TlsUYf">color coding</a> .  We will not describe in detail the connection process.  Just match the presented circuit with the Raspberry pinout given just above. </p><br><p>  To integrate the buttons, we use a <a href="https://github.com/androidthings/contrib-drivers/tree/master/button">ready-made driver</a> , which already takes into account the bounce effect.  Add a dependency </p><br><pre> <code class="java hljs">dependencies { ... compile <span class="hljs-string"><span class="hljs-string">'com.google.android.things.contrib:driver-button:0.3'</span></span> ... }</code> </pre> <br><p>  Let's write a wrapper class for working with a button.  Perhaps the implementation through the wrapper will seem a bit unnecessary, but in this way we will be able to encapsulate the work with the button driver code and create our own interaction interface. </p><br><div class="spoiler">  <b class="spoiler_title">ButtonWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.android.things.contrib.driver.button.Button; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ButtonWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> Button mButton; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> OnButtonClickListener mOnButtonClickListener; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ButtonWrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String gpioPin)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Button(gpioPin, Button.LogicState.PRESSED_WHEN_HIGH); mButton.setOnButtonEventListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Button.OnButtonEventListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onButtonEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Button button, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pressed)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pressed &amp;&amp; mOnButtonClickListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mOnButtonClickListener.onClick(); } } }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOnButtonClickListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OnButtonClickListener listener)</span></span></span><span class="hljs-function"> </span></span>{ mOnButtonClickListener = listener; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mButton == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mButton.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { mButton = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnButtonClickListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } }</code> </pre> </div></div><br><p>  We will use this wrapper in our Activity.  Simply transfer the name of the GPIO port ("BCM4") on the Raspberry Pi3, to which it is connected in the diagram, to the button object constructor </p><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GPIO_PIN_BUTTON = <span class="hljs-string"><span class="hljs-string">"BCM4"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ButtonWrapper mButtonWrapper; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); ... mButtonWrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ButtonWrapper(GPIO_PIN_BUTTON); mButtonWrapper.setOnButtonClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ButtonWrapper.OnButtonClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Timber.d(<span class="hljs-string"><span class="hljs-string">"BUTTON WAS CLICKED"</span></span>); startTakingImage(); } }); ... } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); ... mButtonWrapper.onDestroy(); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startTakingImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// TODO take photo ... } }</span></span></code> </pre> </div></div><br><h3 id="shag-4-kamera">  Step 4: Camera </h3><br><p>  We used the <a href="https://www.raspberrypi.org/products/pi-noir-camera-v2/">NoIR Camera V2</a> .  For about $ 45 you will receive the characteristics sufficient for our project: </p><br><ul><li>  maximum resolution: 8 Mp (3280 √ó 2464); </li><li>  supported video formats: 1080p (30fps), 720p (60fps), 640 √ó 480p (90fps); </li><li>  power consumption: 250 mA </li></ul><br><p>  The camera connects to the control board with a loop through the CSI video input (Camera Serial Interface).  This method reduces the load on the CPU in comparison with the connection of similar cameras via USB. </p><br><p>  Add to the manifest permission to use the camera and the requirements that the device must have it.  Adding permissions is necessary, but consent for all Permissions, including Dangerous Permissions, is obtained automatically when you install the application (there is a known problem that when you add a new perm after reinstalling the application, you need to completely reboot the device). </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.CAMERA"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera.autofocus"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  To further connect the camera, you need to write pieces of code large by the standards of this article.  Please read them yourself at <a href="https://developer.android.com/things/training/doorbell/camera-input.html">this link</a> on the official website.  The code sets the camera settings.  We did not use all its power and chose a resolution of 480x320. </p><br><h3 id="shag-5-svetodiod">  Step 5: LED </h3><br><p>  An LED is a type of diode that glows when current flows through it.  His own resistance after saturation is very small.  When you connect, you will need a resistor that will limit the current passing through the LED, otherwise the latter will simply burn out.  More about <a href="https://goo.gl/GmjwMl">LEDs</a> </p><br><p>  We will use three LEDs of different colors: </p><br><ul><li>  yellow ( <code>BCM20</code> ) - the indicator of the start of work, which continues the specified time interval by the developer; </li><li>  Green ( <code>BCM21</code> ) - the program successfully recognized the face from the database; </li><li>  red ( <code>BCM16</code> ) - the program did not recognize the face during the specified time interval </li></ul><br><p>  You can use one tricolor LED instead of three monochrome.  We enjoyed what was at hand.  Using 1 kOhm resistors, we alternately connect our LEDs through a prototype board in accordance with the diagram. </p><br><p><img src="https://monosnap.com/file/aVjGeFIjTqUQ2W97bUpqgsihE9Y6D3.png" alt="raspberry_step # 2"></p><br><p>  When implementing a wrapper for working with LED, we will use <code>PeripheralManagerService</code> , a service that gives access to the GPIO interface.  Open the connection and configure it to transmit the signal.  Unfortunately, if you look at the implementation of the abstract <code>com.google.android.things.pio.Gpio</code> class, you can see that calling almost every method can generate a <code>java.io.IOException</code> .  For simplicity, hide all <code>try-catch</code> expressions in our wrapper. </p><br><div class="spoiler">  <b class="spoiler_title">LedWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LedWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> Gpio mGpio; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LedWrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String gpioPin)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PeripheralManagerService service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeripheralManagerService(); mGpio = service.openGpio(gpioPin); mGpio.setDirection(Gpio.DIRECTION_OUT_INITIALLY_LOW); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mGpio == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.setValue(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mGpio == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.setValue(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { mGpio = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } }</code> </pre> </div></div><br><p>  We implement it into our Activity for each LED separately. </p><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String GPIO_PIN_LED_GREEN = ‚ÄúBCM21‚Äù; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LedWrapper mLedWrapper; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); ... mLedWrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LedWrapper(GPIO_PIN_LED_GREEN); mLedWrapper.turnOff(); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mLedWrapper.turnOn(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); ... mLedWrapper.onDestroy(); ... } }</code> </pre> </div></div><br><h3 id="shag-6-datchik-dvizheniya">  Step 6: Motion Sensor </h3><br><p>  Each time, approaching the door and pressing the button, as if it were a doorbell, is boring.  We wanted to save the guest of our office from unnecessary actions or even completely open the door while the person is just coming to the door.  Therefore, we decided to use the motion sensor as the main trigger to start the work of the entire system.  Just in case, leave the button with duplicate functionality as is.  More about <a href="https://learn.adafruit.com/pir-passive-infrared-proximity-motion-sensor%3Fview%3Dall">the motion sensor</a> . </p><br><p>  We connect the motion sensor via <code>BCM6</code> pin according to the scheme below. </p><br><p><img src="https://monosnap.com/file/6NwCcv0SVY6d30VTu3EKQ3sKca7UZ7.png" alt="img_motion"></p><br><div class="spoiler">  <b class="spoiler_title">MotionWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MotionWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> Gpio mGpio; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> MotionEventListener mMotionEventListener; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MotionWrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String gpioPin)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PeripheralManagerService().openGpio(gpioPin); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMotionEventListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MotionEventListener listener)</span></span></span><span class="hljs-function"> </span></span>{ mMotionEventListener = listener; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.setDirection(Gpio.DIRECTION_IN); mGpio.setActiveType(Gpio.ACTIVE_HIGH); mGpio.setEdgeTriggerType(Gpio.EDGE_RISING); mGpio.registerGpioCallback(mCallback); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mGpio == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.unregisterGpioCallback(mCallback); mGpio.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mGpio.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { mGpio = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> GpioCallback mCallback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GpioCallback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onGpioEdge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Gpio gpio)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mMotionEventListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mMotionEventListener.onMovement(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MotionEventListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMovement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><p>  public class MainActivity extends Activity { </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GPIO_PIN_MOTION_SENSOR = <span class="hljs-string"><span class="hljs-string">"BCM6"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MotionWrapper mMotionWrapper; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); ... mMotionWrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MotionWrapper(GPIO_PIN_MOTION_SENSOR); mMotionWrapper.setMotionEventListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MotionWrapper.MotionEventListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMovement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ startTakingPhotos(); } }); mMotionWrapper.startup(); ...</code> </pre> <br><p>  } </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); ... mMotionWrapper.shutdown(); mMotionWrapper.onDestroy(); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startTakingPhotos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  } </p></div></div><br><h3 id="shag-7-servoprivod">  Step 7: Servo Drive </h3><br><p>  The servo performs the basic mechanical work in our device.  It is he who turns the output shaft 180 degrees brings the card to the reader.  More about <a href="https://goo.gl/djxOOz">servos</a> . </p><br><p>  We again use the already <a href="https://github.com/androidthings/contrib-drivers/tree/master/pwmservo">existing driver</a> , over which we will write our wrapper.  Add dependency to <code>app/build.gradle</code> . </p><br><pre> <code class="java hljs">dependencies { ... compile <span class="hljs-string"><span class="hljs-string">'com.google.android.things.contrib:driver-pwmservo:0.2'</span></span> ... }</code> </pre> <br><p>  We connect the drive through the <code>PWM1</code> <a href="https://goo.gl/2WiaR5">pulse width modulation interface</a> in accordance with the diagram below.  The use of the <code>PWM</code> interface is due to the fact that, unlike in the previous cases, a specific value is required to be transmitted via a control signal, and not just a binary pulse.  The control signal is pulses of constant frequency and variable width.  The servo drive uses a pulse-width incoming PWM signal, converting it into a specific angle of rotation of the output shaft. </p><br><p><img src="https://monosnap.com/file/Ilby67uLNTie3owuee9DDd7BjnGxk7.png" alt="img_servo"></p><br><div class="spoiler">  <b class="spoiler_title">ServoWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServoWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ANGLE_CLOSE = <span class="hljs-number"><span class="hljs-number">0f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ANGLE_OPEN = <span class="hljs-number"><span class="hljs-number">180f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Servo mServo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Handler mHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServoWrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String gpioPin)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mServo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Servo(gpioPin); mServo.setAngleRange(ANGLE_CLOSE, ANGLE_OPEN); mServo.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> delayMillis)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mServo.setAngle(ANGLE_OPEN); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } mHandler.removeCallbacks(mMoveServoRunnable); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delayMillis &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { mHandler.postDelayed(mMoveServoRunnable, delayMillis); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mServo == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mServo.setAngle(ANGLE_CLOSE); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mHandler.removeCallbacks(mMoveServoRunnable); mMoveServoRunnable = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mServo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mServo.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { mServo = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Runnable mMoveServoRunnable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mHandler.removeCallbacks(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); close(); } }; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><p>  public class MainActivity extends Activity { </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GPIO_PIN_SERVO = <span class="hljs-string"><span class="hljs-string">"PWM1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServoWrapper mServoWrapper; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); ... mServoWrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServoWrapper(GPIO_PIN_SERVO); ...</code> </pre> <br><p>  } </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openDoor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... mServoWrapper.open(DELAY_SERVO_MS); ... } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); ... mServoWrapper.onDestroy(); ... }</code> </pre> <br><p>  } </p></div></div><br><h3 id="shag-8-fotorezistor">  Step 8: Photo Resistor </h3><br><p>  At night, the work of the castle is meaningless, because the photographs obtained make it more difficult to recognize faces.  This means that the system can be temporarily disabled.  To do this, as a light sensor we use a photoresistor - Light Dependent Resistors (LDR).  More about the <a href="http://www.resistorguide.com/photoresistor/">photoresistor</a> . </p><br><p>  The button driver described earlier is suitable for working with a photoresistor.  This is logical, because the essence and mechanics of work really coincide.  The library must already be connected to <code>app/build.gradle</code> . </p><br><pre> <code class="java hljs">dependencies { ... compile <span class="hljs-string"><span class="hljs-string">'com.google.android.things.contrib:driver-button:0.3'</span></span> ... }</code> </pre> <br><p>  The connection scheme to the breadboard board is similar to the button connection scheme.  The only difference is the use of a 10 kŒ© resistor.  Use the <code>BCM25</code> port. </p><br><p><img src="https://monosnap.com/file/mwJWD2hqHmrIitj3H3vSl2WOtUy0Z9.png" alt="doorbell_full_scheme_version"></p><br><p>  Despite all the similarity, we will write a separate wrapper for it. </p><br><div class="spoiler">  <b class="spoiler_title">BrightrWrapper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BrightrWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> Button mLightDetector; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> OnLightStateChangeListener mOnLightStateChangeListener; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BrightrWrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String gpioPin)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mLightDetector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Button(gpioPin, Button.LogicState.PRESSED_WHEN_HIGH); mLightDetector.setOnButtonEventListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Button.OnButtonEventListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onButtonEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Button button, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isLighted)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mOnLightStateChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mOnLightStateChangeListener.onLightStateChange(isLighted); } } }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOnLightStateListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OnLightStateChangeListener listener)</span></span></span><span class="hljs-function"> </span></span>{ mOnLightStateChangeListener = listener; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mLightDetector == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mLightDetector.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnLightStateChangeListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLightStateChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isLighted)</span></span></span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GPIO_PIN_LIGHT_DETECTOR = <span class="hljs-string"><span class="hljs-string">"BCM25"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BrightrWrapper mBrightrWrapper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mIsTakePhotoAllowed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); ... mBrightrWrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrightrWrapper(GPIO_PIN_LIGHT_DETECTOR); mBrightrWrapper.setOnLightStateListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrightrWrapper.OnLightStateChangeListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLightStateChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isLighted)</span></span></span><span class="hljs-function"> </span></span>{ mIsTakePhotoAllowed = isLighted; handleLightState(); } }); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleLightState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mIsTakePhotoAllowed) { ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ... } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); ... mBrightrWrapper.onDestroy(); ... } }</code> </pre> </div></div><br><h2 id="demonstraciya-realizacii">  Implementation demonstration </h2><br><p>  After reviewing all the episodes of the TV show ‚ÄúCrazy Pens,‚Äù we skillfully packed our ‚Äúmonster‚Äù into a box from under the old phone.  You could see the result at the beginning of the article. </p><br><p>  Video demonstration </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7S_EBAqtHpI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="problemy">  Problems </h2><br><p>  Poor quality sensors and sensors.  Work or do not work, when it is necessary and when not necessary.  Servo crackles in standby mode. </p><br><p>  If you are familiar with the principle of the motion sensor, you could understand that it does not work through glass.  So I had to take him outside. </p><br><p>  Having placed our design from the inside on a triple glazed window, all the photos turned out to be strongly exposed.  Quickly realizing that the problem lies in the reflection of light from the white surface of the box and its multiple refraction through the glass unit, we simply stuck a black sheet of paper around the camera so that it absorbs some of the light. </p><br><p>  No protection against printed photos. </p><br><h2 id="itogi">  Results </h2><br><p>  Sample code on <a href="https://github.com/LiveTyping/door-unlocker-android-things/tree/habrahabr">Github</a> . </p><br><p>  Interesting, exciting, fashionable, youth.  It was an interesting project, and there are still ideas for its development.  For example, inside the door also opens on the card.  You can solve this problem - open the door to everyone who comes to it from the inside.  Please suggest in the comments your options for finalizing our smart lock.  If we like them, we will definitely implement them. </p><br><p>  What options of monetization of development under IoT do you know?  Share your experiences in the comments. </p><br><p>  Not as an advertisement I want to share a great article where the author came up with and implemented a self-made news reader in Braille <a href="https://medium.com/exploring-android/braillebox-building-a-braille-news-reader-with-android-things-f848fe6de596">BrailleBox</a> for those who can hardly see on Android Things.  Looks and implemented as cool as it sounds.  Excellent, inspiring project. </p><br><h2 id="poleznye-ssylki">  useful links </h2><br><ul><li>  <a href="https://developer.android.com/things/sdk/index.html">Android Things</a> </li><li>  <a href="https://developer.android.com/things/hardware/raspberrypi.html">Raspberry PI3</a> </li><li>  <a href="https://github.com/androidthings/contrib-drivers">Drivers # 1</a> </li><li>  <a href="https://github.com/amitshekhariitbhu/awesome-android-things">Drivers # 2</a> </li><li>  <a href="https://github.com/Mobilatorium/smart-doorbell-codelab">Mobilatorium</a> </li><li>  <a href="https://developer.android.com/things/training/doorbell/index.html">Building a Cloud Doorbell</a> </li><li>  <a href="http://blog.blundellapps.co.uk/tut-android-things-writing-a-pir-motion-sensor-driver/">Sensor Motion # 1</a> </li><li>  <a href="https://github.com/blundell/PirMotionSensorModuleTut">Sensor Motion # 2</a> </li><li>  <a href="https://learn.adafruit.com/pir-passive-infrared-proximity-motion-sensor%3Fview%3Dall">How sensor motion works</a> </li><li>  <a href="https://github.com/androidthings/drivers-samples/tree/master/pwmservo">Servo</a> </li><li>  <a href="https://androidthings.rocks/2017/01/08/your-first-blinking-led/">LED</a> </li><li>  <a href="http://www.resistorguide.com/photoresistor/">Photoresistor</a> </li><li>  <a href="https://github.com/Polidea/at_candle">Photoresistor Sample</a> </li><li>  <a href="https://hackernoon.com/android-things-basics-measure-distance-with-ultrasonic-sensor-3196fe5d7d7c">Ultrasonic sensor</a> </li><li>  <a href="https://www.raspberrypi.org/documentation/usage/gpio-plus-and-raspi2/">Rasberry3 pins</a> </li><li>  <a href="https://www.raspberrypi.org/documentation/usage/gpio-plus-and-raspi2/">About GPIO pins on Raspberry Pi</a> </li><li>  <a href="https://developer.android.com/things/sdk/pio/gpio.html">About GPIO pins</a> </li><li>  <a href="https://developer.android.com/things/sdk/pio/pwm.html">About PWM pins</a> </li><li>  <a href="https://www.novoda.com/blog/writing-your-first-android-things-driver-p1/">Writing your first Android Things driver</a> . </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/331888/">https://habr.com/ru/post/331888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331878/index.html">AGAIN UPDATED: Technical details of the new global attack Trojan.Encoder.12544 (in various sources - Petya, etc.)</a></li>
<li><a href="../331880/index.html">[Peter] Meeting JUG.ru with the parallel programming legend Maurice Herlihy - Transactional Memory and Beyond</a></li>
<li><a href="../331882/index.html">How to confuse the analyst. Part one</a></li>
<li><a href="../331884/index.html">What should be the perfect report configurator</a></li>
<li><a href="../331886/index.html">Incident Report: GoldenEye / Petya</a></li>
<li><a href="../331890/index.html">Digest of IT events for July</a></li>
<li><a href="../331892/index.html">PSEFABRIC - a new approach to network management and automation</a></li>
<li><a href="../331894/index.html">How does a store in a mall recognize you via Wi-Fi (more precisely, by MAC address) - based on regular hotspots</a></li>
<li><a href="../331896/index.html">"Saved": What is the result of excessive IT cuts in the store?</a></li>
<li><a href="../331898/index.html">Conferences for developers as a way to senior? And what works?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>