<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Architecture Bitrix24 - Inside View</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 12, we launched a large new project, Bitrix24 : a social intranet, a SaaS service that combines classic teamwork tools (calendars, tasks, CRM...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Architecture Bitrix24 - Inside View</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/fee/0fe/e2d/fee0fee2d0cb4c38917ed53202b03bf6.png"><br><br>  On April 12, we launched a large new project, <a href="http://www.bitrix24.ru/"><b>Bitrix24</b></a> : a social intranet, a SaaS service that combines classic teamwork tools (calendars, tasks, CRM, work with documents) and social communications (likes, social search, instant messages). and much more). <br><br>  The first prototype of this service was launched in February last year.  On one server, without any special opportunities for scaling, without redundancy at the data center level ... :) Only concept. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With this publication we will open a series of posts in which we would like to tell you what was done during the year of development, what the resulting architecture of the project turned out to be;  what we are doing to ensure real ‚Äú24‚Äù hours of project work per day;  what changes had to be made in the 1C-Bitrix development platform;  features of working in the Amazon cloud and more. <br><br>  We really want our experience to be useful for all developers who are only planning to launch or are already exploiting and supporting large web projects and services. <br><br>  * * * <br><br>  So, the first post is about the architecture of the project as a whole.  Go! <br><a name="habracut"></a><br>  In the process of developing the very idea <a href="http://www.bitrix24.ru/">of Bitrix24,</a> we formulated for ourselves several business objectives: <br><br><ul><li>  From the very beginning, we assumed that the first tariff for Bitrix24 would be free. </li><li>  This means that the cost of such a free account for us should be very low. </li><li>  Our project is a business application, and it means that the load on it will be very uneven: more during the day, less at night.  Ideally, it would be good to be able to scale (in both directions) and at each moment of time use exactly as many resources as necessary. </li><li>  At the same time - for any business application reliability is extremely important: the constant availability of data and their safety. </li><li>  We started in several markets at once: Russia, USA, Germany. </li></ul><br><br>  These business requirements ultimately formed two large ‚Äúfronts‚Äù of work: the formation of a scalable fault-tolerant (running a little ahead - ‚Äúcloud‚Äù) development platform and the choice of a technological platform for the project infrastructure. <br><br>  <b>Development Platform "1C-Bitrix"</b> <br><br><img src="https://habrastorage.org/storage2/53f/798/b27/53f798b27ebe5c2040d2e12a9f6d9a32.png" align="left">  The traditional device of web applications is very poorly scaled and reserved.  At best, we can spread the application itself, the cache and the database to different servers.  We can somehow scale the web (but at the same time we will have to solve the issue of data synchronization on web servers).  The cache and base scale is worse.  And we are not talking about a distributed geo-cluster (for redundancy at the level of data centers). <br><br>  A huge step in the development of the 1C-Bitrix platform was the emergence of <a href="http://www.1c-bitrix.ru/products/cms/features/webcluster.php">the Web Cluster</a> module in version 10.0 last spring. <br><br>  We <a href="http://habrahabr.ru/company/bitrix/blog/123375/">wrote</a> in detail <a href="http://habrahabr.ru/company/bitrix/blog/123375/">about him on Habr√©</a> .  I will briefly repeat the main features: <br><br><ul><li>  Vertical sharding (making separate modules on separate MySQL servers) </li><li>  MySQL replication and load balancing between servers at the platform core level </li><li>  Distributed data cache (memcached) </li><li>  Session Continuity Between Web Servers (Storing Sessions in Database) </li><li>  Web server clustering </li></ul><br><br>  As a result, we were able to present our project in the form of a web cluster of interchangeable servers.  Everything looked very, very good: with an increase in attendance it was possible to quickly add new servers to the cluster;  in case of failure of one or several servers of the cluster, everything continued to work on the remaining servers, the system continued to continuously serve clients. <br><br><img src="https://habrastorage.org/storage2/4eb/be4/6ef/4ebbe46efcf191c85529534c63252df2.png"><br><br>  But the ideal was still far away, there were ‚Äúnarrow‚Äù places: <br><br><ul><li>  The issue of file synchronization across different web servers was not fully resolved.  On our own site, we used <i>csync2</i> , it has proven itself very well.  However, on large amounts of data, we simply would not have time to transfer changes across all servers. </li><li>  The failure of the master server in MySQL replication meant some manual or semi-automatic operations to transfer one of the slaves to master mode.  It took time, which means we could not guarantee the uninterrupted operation of the service. </li><li>  slaves allow you to distribute the load on the database to read, and master is still alone.  This means that the record remains a bottleneck in the database. </li><li>  As our own sad experience has shown, <a href="http://habrahabr.ru/company/bitrix/blog/125932/">lightning strikes datacents</a> and can completely disable them.  So, you need to reserve not only individual servers, but also the entire data center. </li></ul><br><br>  In the 1C-Bitrix platform version 11.0, released in the fall of 2011, we also solved these tasks.  <a href="http://habrahabr.ru/company/bitrix/blog/130595/">Cloud file storage support</a> solved the problem of synchronization of static content, and the implementation of master-master replication support in MySQL allowed us to build geographically distributed web clusters. <br><br>  And we came close to the second big task ... <br><br>  <b>Platform for deploying infrastructure</b> <br><br>  To be honest, the choice was not very difficult.  :) <br><br>  ‚ÄúCloud‚Äù or not ‚Äúcloud‚Äù - this question did not even stand.  :) <br><br>  Own or rented equipment requires quite serious investments in infrastructure at the start of the project.  Scaling physical "glands" is quite difficult (long and expensive).  To administer (especially in different DCs) is inconvenient. <br><br>  Therefore - the "cloud"! <br><br>  Which one exactly?  We chose Amazon AWS. <br><br>  All of our sites are working in Amazon for a long time.  We like the fact that there are many ready-made services that you can just take and use in your project, and not reinvent your own bikes: cloud storage <a href="http://aws.amazon.com/s3/">S3</a> , <a href="http://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancing</a> , <a href="http://aws.amazon.com/cloudwatch/">CloudWatch</a> , <a href="http://aws.amazon.com/autoscaling/">AutoScaling</a> and much more. <br><br>  In a very simplified form, the entire architecture <a href="http://www.bitrix24.ru/">of Bitrix24</a> looks like this: <br><br><img src="https://habrastorage.org/storage2/5f1/9cc/095/5f19cc09562fc69c2ee66f88300d78b1.png"><br><br>  <b>Web - auto scaling</b> <br><br>  The application (web) is scaled not vertically (increase in server capacity), but horizontally (we add new machines). <br><br>  For this we use a bunch of Elastic Load Balancing + CloudWatch + Auto Scaling.  All client requests (HTTP and HTTPS) arrive at one or more Amazon balancers (ELB).  Growth and load reduction monitor through CloudWatch.  There are two interesting metrics - the state of EC2 nodes (% CPU Utilization) and the balancer (latency time - in seconds). <br><br>  We use data on the load of machines as the main characteristic, since latency can vary not only because of the real load, but also for some other reasons: network delays, errors in the application, etc.  In this case, "false" triggers are possible, and then we will be extremely inefficient to add new cars. <br><br>  Now, as a result, new machines will automatically start if the average utilization of the CPU (in terms of Amazon) exceeds 60%, and automatically stops and is taken out of service if the average load is less than 30%. <br><br>  We experimented with these threshold values ‚Äã‚Äãfor a long time and now we consider them optimal.  If the upper threshold is set higher (for example, 70-80%), then a general degradation of the system begins - users are uncomfortable to work (pages load for a long time).  The lower threshold is less - the balancing system becomes not very efficient, the machines can run idle for a long time. <br><br><img src="https://habrastorage.org/storage2/dab/8ed/c24/dab8edc240b830b58c60498dc1d497ef.png"><br><br>  <b>Static content of service users</b> <br><br>  In the scheme described above, web nodes essentially become "consumable".  They can start at any time and be extinguished at any time.  This means that there should be no user content on them. <br><br>  That is why when you create each new portal in Bitrix24, it creates a personal account in Amazon for storing data in S3.  Thus, the data of each portal are completely isolated from each other. <br><br>  At the same time, the S3 storage itself is very reliable.  Amazon itself describes in detail its device (and, in principle, there is no reason not to believe them). <br><br>  Data in S3 is replicated at several points.  At the same time - to geographically distributed points (different data centers). <br><br>  Each of the storage devices is monitored and quickly replaced in the event of certain failures. <br><br>  When you upload new files to the repository, you will receive an answer about successful upload only when the file is completely saved at several different points. <br><br>  Typically, data is replicated to three or more devices - to ensure fault tolerance even in case of failure of two of them. <br><br>  In other words, reliability is good.  The same Amazon, for example, says that their S3 architecture is designed in such a way that they are ready to ensure availability at the level of two nines after the comma.  And the probability of data loss is one billionth of a percent. <br><br>  <b>Two data centers and master-master replication</b> <br><br>  The whole project is now located in two data centers.  We solve two problems with this: first, we distribute the load (now Russian users work in one DC, and American and European - in the other), and second, we reserve all services - in case of failure of one of DC, we just switch traffic to another. <br><br>  A little bit more - how it all works. <br><br>  The base in each DC is a master relative to the slave in the second DC and simultaneously a slave relative to the master. <br><br>  Important settings in MySQL for implementing this mechanism are <i>auto_increment_increment</i> and <br>  <i>auto_increment_offset</i> .  They set the offset values ‚Äã‚Äãfor the <i>auto_increment</i> fields - in order to avoid duplicate entries.  Roughly speaking, in one master - only even IDs, in the other - only odd ones. <br><br>  Each portal (all employees registered in it), started up in Bitrix24, at each particular time works with only one DC and one base.  Switching to another DC is carried out only in case of any failure. <br><br>  Databases in different data centers are synchronous, but independent of each other: the loss of connectivity between data centers can be hours, data is synchronized after recovery. <br><br>  <b>Reliability, Reliability, Reliability</b> <br><br>  One of the most important priorities in Bitrix24 is the constant availability of the service and its resiliency. <br><br>  Remember the simple service scheme?  As a result (it‚Äôs still simplistic, but nonetheless :)) it looks like this: <br><br><img src="https://habrastorage.org/storage2/730/4bc/48f/7304bc48f432a1f83879c6faec378115.png"><br><br>  In the event of an accident on one or several web nodes, Load Balancing determines the failed machines and, based on the specified parameters of the balancing group (the minimum number of running machines), the necessary number of instances is automatically restored. <br><br>  If the connectivity between data centers is lost, then each data center continues to serve its customer segment.  After the restoration of connectivity, the data in the databases are automatically synchronized. <br><br>  If the data center fails, or, for example, a failure occurs at the base, then all traffic automatically switches to a working data center. <br><br>  If this causes an increased load on the machines, then CloudWatch determines the increased utilization of the CPU and adds the necessary number of machines in one data center in accordance with the rules for AutoScaling. <br><br>  At the same time, our master replication is suspended.  After carrying out the necessary work (recovery - in the event of an accident, or planned - for example, we, at exactly the same time, made the transition from standard MySQL to Percona Server - without any downtime for users of the service) , we include base in work and we restore replication. <br><br>  If everything went smoothly, the traffic is again distributed to both data centers.  If at the same time the average load was below the threshold value, then the extra machines that we raised to service the increased load are automatically extinguished. <br><br>  * * * <br><br>  I tried to make this first post an ‚Äúeasy‚Äù review.  :) If I had put together everything that I wanted to share, in one text and told about all our experiences at once, then there would have been too many letters.  :) <br><br>  It seems to me more logical to make a series of thematic posts.  Topics that we are already preparing: <br><br><ul><li>  Amazon's nuances: non-obvious limits, different operating modes of balancers, working with AMI images </li><li>  The specifics of web nodes: software update mechanisms, Apache / non Apache, user security and isolation </li><li>  MySQL: why Percona, master-master features, replication of large amounts of data, nuances of query cache, sharding </li><li>  Data backups and most importantly - their recovery </li><li>  Monitoring thousands of objects, how not to spam yourself with alerts, automate the response to notifications </li></ul><br><br>  What is most interesting for you?  You can take a spontaneous vote and mark directly in the comments.  :) <br><br>  And of course - try <a href="http://www.bitrix24.ru/">Bitrix24</a> itself!  The first fare is free.  If its limits or functionality is not enough - it will be possible to switch to higher tariffs.  :) <br><br>  Get connected - and work with pleasure! </div><p>Source: <a href="https://habr.com/ru/post/142859/">https://habr.com/ru/post/142859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142853/index.html">5 new courses Udacity</a></li>
<li><a href="../142854/index.html">Postgraduate Studies in Japan - Admission Experience and Personal Impressions</a></li>
<li><a href="../142856/index.html">Mail.Ru and Rambler covered up the possibility of registering new users with Cyrillic logins</a></li>
<li><a href="../142857/index.html">Google Drive against other cloud services</a></li>
<li><a href="../142858/index.html">SysAdmin Anywhere: Using UDP Hole Punching to implement remote desktop</a></li>
<li><a href="../142860/index.html">Google launched Trusted Stores service in test mode</a></li>
<li><a href="../142861/index.html">TSM service for managing NFC SIM applications</a></li>
<li><a href="../142862/index.html">Getting cross-domain data in Google Chrome via user scripts (bypassing a bug)</a></li>
<li><a href="../142863/index.html">Flickr has undergone major changes.</a></li>
<li><a href="../142864/index.html">Sales funnel: we make an automatically updated report from the database using Excel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>