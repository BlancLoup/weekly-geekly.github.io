<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web-based smart home with Perl XS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some point, it became very lazy to tear off his fifth point in order to turn off the lights in the room before going to bed. And I decided to autom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web-based smart home with Perl XS</h1><div class="post__text post__text-html js-mediator-article"> At some point, it became very lazy to tear off his fifth point in order to turn off the lights in the room before going to bed.  And I decided to automate this business.  As a result, a bicycle was invented for remote control of the power load - a software and hardware system with the following features: <br><a name="habracut"></a><br>  <b>*</b> Ability to control the power load, powered by a voltage of 220V, from any place where there is access to the Internet, regardless of the territorial distance. <br>  <b>*</b> Management of power load through the website <br>  <b>*</b> Client-server architecture <br>  <b>*</b> Access to the website of the system from mobile devices, including via cell phones with WAP support <br>  <b>*</b> Using the widespread physical layer RS232 protocol for connecting the hardware component of the system with a computer. <br>  <b>* The</b> hardware component is based on the microcontroller PIC micro.  (PIC18F452 in dip-package). <br><br><br>  Those.  thanks to such a simple thing, it becomes possible to control _ any devices (albeit only at the ‚Äúon-off‚Äù level), be it a kettle, an iron, a TV, a refrigerator, lights in a room, etc., with Internet access.  You can manage with _lyublyu_ device that has Internet access and html / wap-browser - mobile phone, iPhone, iPad, laptop, computer, TV and other devices.  I implemented my ‚Äúsmart home‚Äù in PHP (client), Perl (server), C (server, low-level functions library), assembler (mpasm, microcontroller firmware). <br><br><br>  The system access options are as follows: <br>  1) web site for stationary and mobile devices user with html support <br>  2) wap-version of the site to provide access to the system from mobile devices that support WAP. <br>  3) telnet access for console access to the system 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br>  And now - the general structure of the system: <br><br><img src="https://habrastorage.org/storage2/ec6/fc3/f76/ec6fc3f7637b4e0151b43101535eda72.jpg"><br><br>  Consider in detail the levels of implementation of the system: <br><br>  1) The highest (client) level - is the entry point to the system for users.  The website (see picture below) and its wap version, running under the CMSBuilder content management system (CMS) written in Perl, in conjunction with MySQL + Apache, accept user requests from both computer and mobile devices. <br><br><img src="https://habrastorage.org/storage2/2be/9c7/a76/2be9c7a76082f48a7100395eea31de8f.jpg"><br><br><br>  2) At the middle (server) level, there is a daemon, which is a multiprocess tcp server with pre-branching, also written in Perl.  The interaction with the highest level is carried out using its own application protocol.  A library of low-level functions written in C is intended for communication with the lowest physical level.  The library is connected to the daemon via the perlxstut tool, which allows you to connect libraries written in C to the Perl applications.  The C library used at this level implements work with the rs232 ports of the computer using the standard library termios.h. <br><br><br>  3) The lowest (hardware) level (see the picture below, drawn in Proteus) is implemented on the PIC18F452 microcontroller, which is connected to the computer via the rs232 interface.  The control of the connected load is carried out by switching the power lines with a voltage of 220V through a relay connected to the microcontroller through a transistor. <br><br><br><img src="https://habrastorage.org/storage2/8ac/97f/d38/8ac97fd3806d32641a5c27901e87b77f.jpg"><br><br>  Here is how the device looks live (without rs232 cord and relay): <br><br><br><img src="https://habrastorage.org/storage2/945/648/ebc/945648ebc59dabc5603b6834af4491b3.jpg"><br><br><br>  It works only under * nix.  Archive with all necessary can be downloaded <a href="http://files.mail.ru/0YUCJ00YUCJ00YUCJ00YUCJ00YUCJ0XX">from here</a> .  To use, you need to build an APM (makefile attached), run prefork_pipe.pl (by default it will listen on port 8080 to receive load control commands via a socket).  Understands the WRITE [value] and READ commands.  (the value is written immediately to the 8-bit port, i.e. it is possible to control only all eight tracks simultaneously).  The client part in the archive - in PHP.  If you want to use the module from a site in PHP - connect apm.inc, an example of using in index.php.  To implement interaction with devices that have a WAP-browser, the wap.php file is intended.  In Web.pm, the Perl implementation of the system interaction protocol of the read / write command) on the server side.  As you can see, nothing complicated.  In reality, the client part is implemented as modules for a CMS written in Perl. <br><br><br>  Perhaps someone will seem a serious disadvantage of the need to have a constantly turned on computer to control the equipment via the Internet.  But no one bothers to use a miniature raspberry pi.  Or adapt the router with Linux. <br><br>  The second drawback you can see is the need for an rs232 port.  But this problem is easily solved by purchasing a usb-rs232 adapter.  Or you can buy a microcontroller with USB hardware peripherals.  For example, for about 1500 rubles you can buy a ready-made kit, which includes a debug board with a pic18f14k50 microcontroller (built-in usb on board) and a PicKit2 in-circuit programmer / debugger: <br><br><img src="https://habrastorage.org/storage2/a22/277/8de/a222778dec57ba438c97ceaaacfd9aa0.jpg"><br>  - already unsoldered usb ports, com-port + prototyping field + one more such board, unsoldered.  The package includes, among other things, a laboratory work with a library that implements the USB CDC class (what it is - see below) - i.e.  quite often you can repair your smart home. &lt;br <br>  And do not be afraid of USB in terms of programming - nothing complicated here.  The fact is that in general there are cases when it is necessary to climb into USB at a low level (write drivers, operate with end points from the MK side), etc.  happen very rarely.  For most needs, there are ready-made USB classes that allow you not to delve into the work of USB at a low level, not to write drivers, but to immediately solve the problem you need.  In this case, such a class is CDC - from the microcontroller's side you use a ready-made library that implements this class, and operate with functions of working with a com-port.  On the computer side, you see a virtual com port in the system.  Thus, you continue to work with rs232, although the actual interaction is conducted via USB. <br><br>  <b>Speech recognition and synthesis</b> <br><br>  There is another way to implement interaction with the system, except to press the buttons of the cellular / computer and other device with access to the network ‚Äî you can implement speech recognition to receive commands, and synthesis to get a response.  For example, say "wife, turn off the iron" - the system for the keyword "wife" understands that the command will now follow.  After receiving the command, a request to the microcontroller to control one (or all) channels from the relay, followed by a voice confirmation of execution (speech synthesis). <br><br>  There are three ways of implementation: <br><br>  1) Used to connect to the Internet and computer.  The most popular solution is to use the API from Google - when recognizing speech, we record sound from a microphone into a file, recode it into flac, send it to Google, get a text response - parse it and give the command to the microcontroller.  When speech synthesis text is sent to Google, we get a response with mp3-data, output to the speaker.  You can read more here: <a href="http://habrahabr.ru/blogs/hardware/129936/">habrahabr.ru/blogs/hardware/129936</a> <br><br>  2) Local speech recognition and synthesis, without the Internet, but again with a computer.  For speech synthesis, the <a href="http://www.cstr.ed.ac.uk/projects/festival/download.html">festival</a> is often used ( <a href="http://festlang.berlios.de/docu/doku.php%3Fid%3Drussianru">Russian language pack for it</a> ), for recognition - the <a href="http://cmusphinx.sourceforge.net/">Sphrinx</a> voice engine with support for recognition of Russian speech <br><br>  3) There are still solutions for embedded systems, without using an external computer for speech recognition and synthesis.  An example of this is the HM2007 speech recognition chip (alas, already taken off the market).  In short, we close her leg, set the code to which the team will be assigned, say the command, open the leg, and so on for each team.  Then when we use it, if the microcircuit recognizes the command we are talking about, it sets the binary code corresponding to it at the output.  For robotics - the most it.  There is also a Microchip library for dsPIC30F - Microchip Speech Recognition Library.  Minus - such single-chip solutions are bad friends with the Russian language.  It is necessary to give commands in the English-language manner. <br><br>  With the help of the solutions described above, it is quite realistic to modify the example from pic18f452 given in the article, implementing the commercial solution described on <a href="http://habrahabr.ru/blogs/startup/128656/">habrahabr.ru/blogs/startup/128656</a> (controlling the equipment through the IR channel with voice) ‚Äîand if in an industrial version (home sapiens) if the load is not directly controlled (only via IR adapters), here we are able to directly interact with the load and save our hard-earned money.  The only pity is that you do not create a solution that can say ‚ÄúWife, fulfill marital debt‚Äù and get the desired result.  So you have to remain a monk in the world.  :) <br><br>  PS Something has recently become lazy to go to the toilet.  Here's how to automate this business ... :-) <br></div><p>Source: <a href="https://habr.com/ru/post/137726/">https://habr.com/ru/post/137726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137720/index.html">Yota antenna do it yourself</a></li>
<li><a href="../137721/index.html">Java DNS API, Wikipedia and twitter-marathon in one bottle</a></li>
<li><a href="../137722/index.html">Microsoft removed the start button</a></li>
<li><a href="../137723/index.html">Teamviewer analogue from VNC, SSH and superglue</a></li>
<li><a href="../137725/index.html">Image Catalyst 2.2</a></li>
<li><a href="../137730/index.html">We interpret Go as Python, Ruby, Bash</a></li>
<li><a href="../137732/index.html">Comparison of iOS and Android on the probability of crash reports</a></li>
<li><a href="../137734/index.html">Neurorents disconnected the tracker part</a></li>
<li><a href="../137735/index.html">Once again about IPSec, racoon and stereotypical thinking</a></li>
<li><a href="../137737/index.html">Toll road architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>