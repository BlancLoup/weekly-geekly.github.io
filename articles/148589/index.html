<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows programming difficulties</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you are involved in the development of fairly complex projects, then writing the incorrectly working code is easier than ever. The whole snag is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows programming difficulties</h1><div class="post__text post__text-html js-mediator-article">  When you are involved in the development of fairly complex projects, then writing the incorrectly working code is easier than ever.  The whole snag is that you start to look for a mistake in the darkest back streets of the project, in its most difficult parts.  At the same time, even thoughts do not come to mind that the simplest code, the basis of the whole project, the framework, may not work. <br>  In this post, I will describe two problems that I encountered in practice: the inability to create another stream and rename the file.  Used programming language: C / C ++. <br><a name="habracut"></a><br><h2>  Fight, thread, do not be afraid </h2><br>  So, the first situation. <br><br>  <b>Given</b> : on one of the laptops in the office (not developers) while the program is running, at one point, the <i>CreateThread ()</i> function stops working with the return code <i>‚ÄúFailed to create thread.</i>  <i>Not enough storage is available to process this command. ‚Äù</i> <br><br>  It is worth noting that when this error occurred, a substantial part of the functionality did not work on the target laptop.  While all the errors were cleared and the result was remotely checked using logs (it was not possible to install the IDE on the laptop and debug the program), quite a long time passed.  And so, there was only the problem of creating a stream. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As soon as it became clear that the program did not have enough memory for this task (judging by the return code), the witch hunt began: suspicion began to fall on all the complex libraries, in the code of which the devil himself would break his leg.  This was facilitated by the fact that when the program used the GPU, the problem manifested itself.  If only the CPU was used, there was no problem. <br>  Naturally, we began to carefully look at the library, providing work with the GPU.  Along the way, several important errors were found and fixed that caused a memory leak.  However, this did not solve the original problem.  Flows all the same at one point ceased to be created. <br><br>  Another snag was that the memory didn't end there!  Task Manager showed that the program at the critical moment used about 220 MB, while the laptop was equipped with 8 GB of RAM. <br><br><h3>  Stress Testing </h3><br>  It turned out that the problem manifested itself when the program created more than 90 threads.  They began to sin on a pool of threads: they thought that it was starting to create threads indefinitely.  It was decided to remove the limit on the number of threads created by the program at a time, and select, say, 1000 threads.  On the debugging machine, all a thousand threads were created with a bang, but on the target laptop there were even more problems: the GUI began to fall apart. <br><br>  But all hopes that the source of the problem was found were broken by the <b>TestLimit</b> program from Sysinternals: on the target laptop, this test program created 1000 threads or more without problems.  Even the hope that in our program each thread is allocated more memory than the default, melted away like a light haze.  The error was in our program. <br><br><h3>  RTFM </h3><br>  We have already begun to think that this problem is associated exclusively with the target notebook and is manifested only on a specific hardware.  However, there is also a misfire: if you create a new user, then under it our program works without fail. <br><br>  When the hands had already begun to fall, one of the employees once again (for the umpteenth time) read the help for CreateThread () in MSDN.  And the casket just opened: <br>  <i>"If you have created a</i> <i>CRT, you can terminate the process</i> <b>in low-memory conditions</b> <i>."</i> ( <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682453%2528v%3Dvs.85%2529.aspx">Proof</a> ) <br><br>  <b>Solution:</b> use <i>_beginthreadex ()</i> to create threads, instead of <i>CreateThread ()</i> .  The same was written in the comments to the help page with the theme <i>"_beginthread vs CreateThread: which should you use?"</i> <br><br>  Immediately I remembered that on the target laptop really heavyweight applications were spinning, which corresponds to the <i>low-memory</i> condition.  The thread pool was rewritten to use <i>_beginthreadex ()</i> and eventually ... the problem <i>persists</i> .  But already manifested less frequently.  And all because in some parts of the program threads were created manually, and were not taken from the pool. <br>  When all calls to <i>CreateThread ()</i> were replaced with calls to <i>_beginthreadex ()</i> (including in third-party libraries), the problem was finally solved. <br><br>  The main difficulty in solving this problem was that the problem was reproduced only on a specific machine with a certain use.  At the same time, all our code tests were useless, since in this case we also needed emulation of the load on the OS. <br><br><h2>  Are you sure you want to rename the file? </h2><br>  Situation two. <br><br>  <b>Given</b> : at an indefinite moment of the program, after the file &lt;filename&gt; has been deleted, the function for checking the existence of the file &lt;filename&gt; returns <i>true</i> . <br><br>  First we look at the function of checking the existence of a file: <br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">wchar_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* filename )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = !_waccess( filename, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( result ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } WIN32_FIND_DATAW attrs; HANDLE handle = FindFirstFileW( filename, &amp;attrs ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( handle == INVALID_HANDLE_VALUE ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } FindClose( handle ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !!attrs.dwFileAttributes; }</code> </pre> <br>  Remembering the problem with CRT that arose in the previous example, I begin to sin on the <i>_waccess ()</i> function.  However, after writing a small test for creating / deleting a file, it becomes clear that it has nothing to do with it. <br><br>  It turned out that <b>after</b> the file was deleted using the <i>_wremove ()</i> function, the <i>FindFirstFileW ()</i> function can still find attributes for this file!  It turns out that the NTFS file system driver requires some non-zero time to remove the file attributes.  Therefore, one cannot rely on the existence of file attributes in the function of checking for existence. <br>  OK, no problems.  Just remove this attribute availability check. <br><br>  The <i>exist ()</i> function now works correctly.  Problem solved?  Not here it was! <br><br><h3>  I can not create a file, a crib! </h3><br>  Initially, the problem was in the following algorithm: <br><ul><li>  delete the file &lt;dest_file&gt; </li><li>  rename file &lt;source_file&gt; to &lt;dest_file&gt; </li></ul>  namely, in the renaming function: it had the function <i>exist ()</i> described above before starting the renaming.  After correction, the algorithm began to work correctly.  The test for this piece of code looked like this: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> test() { const wchar_t firstName[] = "alice.txt"; const wchar_t secondName[] = "bob.txt"; <span class="hljs-type"><span class="hljs-type">int</span></span> mode = _S_IREAD | _S_IWRITE; //    <span class="hljs-type"><span class="hljs-type">int</span></span> handle = _wcreat( firstName, mode ); ::<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>( handle ); //    handle = _wcreat( secondName, mode ); ::<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>( handle ); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ) { //    _wremove( secondName ); // ,    <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( !exist( secondName ) ); //      _wrename( firstName, secondName ); //    _wrename( secondName, firstName ); //    handle = _wcreat( secondName, mode ); ::<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>( handle ); } }</code> </pre><br>  However, the original test looked like this: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> test() { const wchar_t fileName[] = "test.txt"; <span class="hljs-type"><span class="hljs-type">int</span></span> mode = _S_IREAD | _S_IWRITE; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ) { //   <span class="hljs-type"><span class="hljs-type">int</span></span> handle = _wcreat( fileName, mode ); ::<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>( handle ); // ,    <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( exist( fileName ) ); //   _wremove( fileName ); // ,    <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( !exist( fileName )); } }</code> </pre><br>  So, at first, the function <i>exist ()</i> did not work correctly: over time, checking for the absence of a file produced an incorrect result.  We fixed this by removing the check for the attributes of the requested file.  And then the <i>_wcreat ()</i> function started to <i>fail</i> !  After about the 800th iteration of the loop (or even earlier), it ended with an error ... <br><br>  It is known that <i>_wcreat ()</i> is a wrapper over <i>CreateFile ()</i> .  So at the time of the error, the last function terminated with the return code <i>"ACCESS_DENIED"</i> !  That is, despite the fact that we told the system to delete the file and even checked that the file is no longer there, in fact, the file system driver still deleted the file.  Hence the denial of access. <br><br>  <b>Solution:</b> we did not find it.  Because  in a real project there was no similar situation with the creation / deletion of the same file, then they decided to score a mistake.  It is noteworthy that in such a situation, <i>MoveFile ()</i> works correctly, i.e.  can rename a third-party file to the remote! <br>  Another solution to this situation: turn off antivirus and / or other programs that may request access to the file being created. <br><br><h2>  Epilogue </h2><br>  I like programming and solving various algorithmic problems.  But how, however, it is difficult to solve the problem in the program when the OS is buggy!  Well, not OS, but libraries and drivers for it.  And in such moments, when you come across such errors, only one picture comes to mind: <br><img src="https://habrastorage.org/storage2/860/d19/acc/860d19accfce847cd5a835cc13a95eaa.png"><br><br><h2>  Links </h2><br>  If anyone is interested in reading about other interesting cases, here is a good blog (thanks for the link thanks <a href="https://habrahabr.ru/users/unkinddragon/" class="user_link">unkinddragon</a> ): <br>  <a href="http://blogs.msdn.com/b/oldnewthing">blogs.msdn.com/b/oldnewthing</a> <br><br>  Literature: <br>  <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D3988952">Richter J. "Windows.</a>  <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D3988952">Creating effective Win32-based applications, taking into account the specifics of the 64-bit version of Windows</a> <br>  <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D3583753">Mark Russinovich, David Solomon, Alex Ionescu "Windows Internals (5th Edition)"</a> <br><br>  <b>UPD 1:</b> if anyone is interested, here is my test: <br><div class="spoiler">  <b class="spoiler_title">Test source</b> <div class="spoiler_text"><pre> <code class="hljs go">#include <span class="hljs-string"><span class="hljs-string">"sys/stat.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"stdio.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"io.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"Windows.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"Share.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"fcntl.h"</span></span> #include <span class="hljs-string"><span class="hljs-string">"assert.h"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> createFile( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* fileName ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mode = _S_IREAD | _S_IWRITE; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> handle = _wcreat( fileName, mode ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( handle == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) { printf( <span class="hljs-string"><span class="hljs-string">"_wcreat failed with error code %u\n"</span></span>, errno ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _close( handle ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handle != <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> createFileSafe( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* fileName ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> operMode = _O_CREAT; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sharMode = _SH_DENYNO; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> permMode = _S_IREAD | _S_IWRITE; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> handle = <span class="hljs-number"><span class="hljs-number">0</span></span>; errno_t error = _wsopen_s( &amp;handle, fileName, operMode, sharMode, permMode ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( handle == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) { printf( <span class="hljs-string"><span class="hljs-string">"_wsopen_s failed with error code %u\n"</span></span>, errno ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _close( handle ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handle != <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> deleteFile( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* fileName ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = _wremove( fileName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( result == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) { printf( <span class="hljs-string"><span class="hljs-string">"_wremove failed with error code %u\n"</span></span>, errno ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !result; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> renameFile( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* src, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* dst ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = _wrename( src, dst ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( result ) { printf( <span class="hljs-string"><span class="hljs-string">"_wrename failed with error code %u\n"</span></span>, errno ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !result; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> exist( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t* fileName ) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mode = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = _waccess( fileName, mode ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !result; } void testCreateFile() { printf( <span class="hljs-string"><span class="hljs-string">"Testing _wcreate()...\n"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t testFileName[] = L<span class="hljs-string"><span class="hljs-string">"test.txt"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span>; while( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = createFile( testFileName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( exist( testFileName ) ); result = deleteFile( testFileName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( !exist( testFileName ) ); ++iteration; } printf( <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span> ); } void testCreateFileSafe() { printf( <span class="hljs-string"><span class="hljs-string">"Testing _wsopen_s()...\n"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t testFileName[] = L<span class="hljs-string"><span class="hljs-string">"test_safe.txt"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span>; while( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = createFileSafe( testFileName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( exist( testFileName ) ); result = deleteFile( testFileName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( !exist( testFileName ) ); ++iteration; } printf( <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span> ); } void testRenameFile() { printf( <span class="hljs-string"><span class="hljs-string">"Testing _wrename()...\n"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t firstName[] = L<span class="hljs-string"><span class="hljs-string">"first.txt"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wchar_t secondName[] = L<span class="hljs-string"><span class="hljs-string">"second.txt"</span></span>; createFileSafe( firstName ); createFileSafe( secondName ); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iteration = <span class="hljs-number"><span class="hljs-number">1</span></span>; while( <span class="hljs-literal"><span class="hljs-literal">true</span></span> ) { assert( exist( firstName ) ); assert( exist( secondName ) ); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = deleteFile( secondName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( !exist( secondName ) ); result = renameFile( firstName, secondName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( exist( !firstName ) ); assert( exist( secondName ) ); result = renameFile( secondName, firstName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } assert( exist( firstName ) ); assert( !exist( secondName ) ); result = createFileSafe( secondName ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !result ) { printf( <span class="hljs-string"><span class="hljs-string">"Iteration = %d"</span></span>, iteration ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } ++iteration; } printf( <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> char argv[] ) { testCreateFile(); testCreateFileSafe(); testRenameFile(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br>  According to the results of testing, I can say that on my laptop the second situation is reproduced stably.  From antiviruses: Windows Security Essentials. <br><br>  <b>UPD 2:</b> Situation 2 can be avoided by disabling the antivirus and / or other programs that may request access to the file being created (thanks to the community for the tip to this solution). </div><p>Source: <a href="https://habr.com/ru/post/148589/">https://habr.com/ru/post/148589/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148583/index.html">Happy holiday, dear sysadmins</a></li>
<li><a href="../148584/index.html">Why programming is a good way to express incomprehensible and vaguely formulated ideas.</a></li>
<li><a href="../148585/index.html">Autonomous router for 4G Megaphone</a></li>
<li><a href="../148587/index.html">Second dotcom bubble or new era?</a></li>
<li><a href="../148588/index.html">IT R & D Cream (Issue 18) - Old Mop</a></li>
<li><a href="../14859/index.html">Super Sensitive Touchscreens: Apple's New Patent</a></li>
<li><a href="../148590/index.html">First base station and first call</a></li>
<li><a href="../148591/index.html">Constantly falls off the Flash Plugin in Google Chrome? There is a solution!</a></li>
<li><a href="../148595/index.html">Cinema Park invests about 19 million dollars in cinema halls of 4DX format</a></li>
<li><a href="../148596/index.html">PHP process manager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>