<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SOC for intermediate. We understand what we are protecting, or how to make an inventory of infrastructure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again. The cycle ‚ÄúSOC for ...‚Äù continues its movement and development. We have already covered the first layer of the internal kitchen of the ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SOC for intermediate. We understand what we are protecting, or how to make an inventory of infrastructure</h1><div class="post__text post__text-html js-mediator-article">  Hello again.  The cycle ‚ÄúSOC for ...‚Äù continues its movement and development.  We have already covered the first layer of the internal kitchen of the centers for monitoring and responding to incidents in previous articles, so we will try to go a little further into the technical details and more subtle problems. <br><br>  We have already indirectly dealt with the topic of asset management several times: both in the <a href="https://habrahabr.ru/company/solarsecurity/blog/341530/">article on security control</a> , and in <a href="https://habrahabr.ru/company/solarsecurity/blog/345648/">matters of automation and artificial intelligence in SOC</a> .  Obviously, without an inventory of the customer‚Äôs infrastructure, the monitoring center cannot protect it.  In this case, to make its detailed description is not a trivial task.  And the main thing is that in a couple of months it is again irrelevant: some hosts have disappeared, others have appeared, new services or systems have appeared.  But the protection of infrastructure is a continuous process, and SOC cannot slow down its activities until it receives relevant information about the assets of the customer.  Let me remind you that the quality of Solar JSOC‚Äôs work is not governed by abstract promises, but by quite concrete SLA, followed by various sky punishments.  How to get out in such a situation and not lose as a service provided? <br><br><img src="https://habrastorage.org/webt/cq/ca/3m/cqca3m4hwgwyes5srqibczapd8k.png"><br><a name="habracut"></a><br>  We now propose to return to this issue through one of the comparative examples of incident alerts: <br><blockquote>  RAT utility AmmyAdmin is launched on host 172.16.13.2. </blockquote>  vs <br><blockquote>  The RAT utility AmmyAdmin was launched on host 172.16.13.2, the Moscow office at Kuznetsky Most, the machine Ivanov Peter Mikhailovich, the deputy head of the communication center, the functionality - processing the flights of the IRC and working with the AWS KBR, remote work of the administrator is prohibited. </blockquote><br>  It would seem that the difference between these two notifications is in depth.  In the first case, the notification looks as if it was received automatically from the SIEM platform, while in the second case, the operator‚Äôs work and incident enrichment are visible.  This is so and not so.  In order for the operator to analyze the incident and draw any conclusions, it is extremely important for him to understand that (or who) lies behind these mysterious and almost identical IP addresses with customers, and use this information in the analysis of the incident. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      20% of our readers will say about percents: ‚ÄúWell, for this, CMDB system is implemented in all companies, which is simpler than connecting data from it to the SIEM?  Even the connector does not need to write. "  Leave on this conviction colleagues from integrators and vendors.  From our practice, sadly aware of this, information from the CMDB should not even be connected or exported to the SIEM due to its complete irrelevance.  So you have to roll up your sleeves and do everything yourself.  Let's look at this question more attentively and try to understand how to understand the depths of the infrastructure, <s>without attracting the attention of nurses</s> without relying on the full support of IT departments. <br><br><h3>  Eating an elephant in parts or immersed in the description of the infrastructure <br></h3><br>  In our move to an inventory of assets, we usually try to pass four control points. <br><br>  <b>1. Building a high-level but detailed organization network map</b> <br><br>  Here, the customer‚Äôs IT departments are the first and main contact (except for cases when the network equipment management system or firewall management is correctly implemented and configured in the company, but this is still an exception).  The descriptive parts of information from network equipment, network diagrams, and so on are also used. <br><br>  The target result of this stage is the ability to split all internal addresses into network zones with the identification of the following information: <br><br><ul><li>  Which site (geolocation / location, if applicable) refers to a specific IP address. </li><li>  What type of site (data center / head office / branch / point of sale) it belongs to. </li><li>  The global purpose of a dedicated network segment is user / corporate Wi-Fi / guest Wi-Fi / admins / server. </li><li>  The application purpose of this network segment is relative to the system or business application, if possible. </li></ul><br>  This leads to the <b>first important conclusion</b> : assets are not only a description of specific hosts with detailed inventory information about them, but also the ability to describe network segments and use this data in reports / correlation / search by events. <br><br>  Here is how it looks in SIEM: <br><br><img src="https://habrastorage.org/webt/np/ld/si/npldsic5fbz-atbk75naqy_alvy.png"><br><br>  <b>2. Description of the main subsystems in the data center</b> <b><br></b> <br>  As a rule, the initial identification of these machines appears on the basis of the first business interviews.  Communicating with security, IT, networkers and applied workers allows us, as a first approximation, to understand how the company's infrastructure is organized and which resources / systems in it are the most critical.  Collecting information about their addressing and network accessories is quite easy.  Further, in the point questions mode, it is already possible to obtain the required information: <br><br><ul><li>  What exactly are the services and applications deployed on this host. </li><li>  What class of criticality according to IT is it assigned to? </li><li>  What is the functional role of the system (planned). </li></ul><br>  At this stage, unloadings from various centralization systems usually help: <br><br><ul><li>  Virtualization systems.  Often, comments on the creation of virtual machines describe their functional roles. </li><li>  Active Directory and other directories.  At a minimum, the domain structure very often gives answers about the functional purpose of the systems: <br><br><img src="https://habrastorage.org/webt/jy/dv/4p/jydv4p07megqsrhxokc03fftzjg.png"><br></li><li>  Various SZI (as a rule, antiviruses) have a large amount of inventory information: <br><br><img src="https://habrastorage.org/webt/sd/_j/xc/sd_jxc6novpw-jnxovnrzct42ki.png"><br></li><li>  Or just a large Excel file, which lists key systems with reference to platforms, addressing, etc. </li></ul><br>  A <b>second important conclusion</b> follows from this: you need to be able to ‚Äúpick up‚Äù information about assets from completely different sources and add this information to the SIEM in accordance with the configured monitoring scenarios and logic. <br><br>  <b>3. Description of critical hosts and assets in terms of information security</b> <b><br></b> <br>  When the customer has identified his ‚Äúpain points‚Äù and the most critical systems, we enter into a dialogue with those responsible for them, to figure out how these systems are related to each other, what data is stored there and what risks of information security are associated with them.  We also evaluate them by additional parameters, after which we assign coefficients to some of the systems that increase the level of criticality.  Here is what we pay attention to: <br><br><ul><li>  How dangerous this system is in terms of monetizing the attack.  Examples are the AWS of the CBD, the machines of the settlement center in banks, the machines of the treasury and the bank clients in other companies. </li><li>  How critical this system is in terms of compromising the data on it.  Examples are management reporting systems, folders that store information with a commercial secret, etc. </li><li>  As far as this system is concerned, a burglary can be used to develop an attack on an infrastructure.  Examples are central network equipment, antivirus servers, AD, and a security scanner (with the help of which, an attacker can often get access anywhere). </li><li>  Another reason for the high criticality of this host, which tells us the customer. </li></ul><br>  Example descriptions: <br><br><img src="https://habrastorage.org/webt/y5/cg/5h/y5cg5hmkxiovdy7tmq-p90kq2su.png"><br><br>  <b>The third important conclusion</b> : the SOC should be able to add its own descriptions of the purpose, functionality and criticality of the host for each asset and for each subnet entered into the system.  As the saying goes, ‚Äúthe taste and color of all the markers are different,‚Äù and what is good in IT is not always necessary in information security. <br><br>  <b>4. Enriching Host / Asset Information</b> <b><br></b> <br>  In the final, we are trying to enrich the information on the host / asset with data from information security inventory systems or security scanners: <br><br><ul><li>  Hardware characteristics (processors, memory, disks, etc.). </li><li>  Information on the OS and all installed patches (and, if lucky, even with vulnerabilities that are relevant to them). </li><li>  List of installed software with versioning. </li><li>  List of processes running at the time of scanning. </li><li>  A lot of additional information (MD5 libraries, etc.). </li></ul><br>  This information is extremely useful for investigation, although, in our opinion, it is not primary in identifying and assessing the criticality of the incident itself associated with the host. <br><br><h3>  We understand the problems <br></h3><br>  Although even at first glance, the process of describing the infrastructure looks rather complicated, in reality these are only those difficulties that lie on the surface.  As always, inside you can find a number of underwater <s>rakes of</s> stones.  Let's try to discuss them and share possible solutions. <br><br>  <b>Choosing a unique asset identifier</b> <b><br></b> <br>  It would seem that the question is banal and obvious.  Choose anything: even the IP-address (if several interfaces - assign the main), even the domain name, even the serial number.  But in life, everything is not so simple. <br><br>  Any hardware or software identifiers are really very good for their uniqueness and direct connection with the device.  The problem is the same - we work with logs, and we detect incidents based on logs, but they simply do not have these unique identifiers.  Therefore, we do not have (almost) any opportunity to correctly associate what is happening in our network with an asset. <br><br>  The DNS name is also good in terms of its uniqueness (ignoring those companies that prefer not to use it).  But the problem, unfortunately, is quite similar - the absolute majority of the logs do not contain any information about this DNS name itself.  Therefore, matching an incident with an asset also remains a problem. <br><br>  It would seem that we have no options left, we will have to work with an IP address.  It appears in the vast majority of logs with which we have to deal, and in the case of the server segment is almost a guaranteed criterion for determining the device. <br><br>  But things get more complicated when we try to use it to identify user hosts.  Quite often, in user networks or parts of them, we are faced with DHCP and randomly issuing the IP address of a host within a segment.  This breaks all the logic of the incident: at the time of the event, the IP address could relate to one machine, and by the time the analyst connects to the parsing or the customer's IT service blocks it, this IP address may already belong to a completely different host. <br><br>  There are even more enchanting cases.  Look, for example, at logging Windows with RDP authentication: <br><br><img src="https://habrastorage.org/webt/2a/ka/zl/2akazle6_jokyf8m_iux0mrftmq.png"><br><br><img src="https://habrastorage.org/webt/xg/zr/ec/xgzreca7at8bbdjdyeubdb36kt0.png"><br><br><img src="https://habrastorage.org/webt/-_/td/gr/-_tdgrgnmhcm8-y36w9vsvjykhm.png"><br><br>  As a result, depending on the type of event, the identifier will be either a host or IP.  And this problem is generally better solved at the level of parsing the event. <br><br>  Most often we use the following host definition scheme.  When processing events, a number of conditions are sequentially checked and the first non-zero value is selected (problems with parsing from the example above are solved at the level of parsers :)): <br><br><ul><li>  The network has static addressing, and in SIEM, an asset is created for this IP (identifier = asset name). </li><li>  In active DHCP leases there is information on HostName when sampling by IP from the log (identifier = host name, without domain). </li><li>  Does HostName log (id = hostname, without domain)? </li><li>  Is there an IP address (id = IP address) in the log? </li></ul><br>  This process is performed for each incoming event and is used when checking all exclusion lists, profiles, etc. <br><br>  It is important to note here that it‚Äôs never possible to acquire assets for all the hosts in the company and keep them up to date.  In any case, there are guest networks, VPN address pools, test environments, the Internet ÔÅä.  In these networks, you can not start an asset, because everything is constantly changing.  But at the same time, it is still important to correctly determine the source of the activity, and not to generate alerts for the same host present in the logs in a different format (for example, nb-hostname.domain.local, nb-hostname, 10.10.10.10 (but there is nb -hostname in DHCP)). <br><br>  <b>Use of current inventory information when enriching events</b> <b><br></b> <br>  When we talk about incident analysis, it is very important to operate with actual data on the presence of updates / software / vulnerabilities on the host, etc. <br><br>  As a rule, regular scans (and, respectively, and updating information about assets) occur at best once a month.  Scanning the entire infrastructure more often is practically unrealistic, and at some point this gives rise to another very important detail in incident handling, which is often overlooked: between two inventory scans, the state of the host can change as often as desired and at the same time eventually return to the original condition  For example, in incidents involving malicious mailings, referrals to infected websites, identifying indicators of compromise, etc., it is very important to understand whether the antivirus was active at that particular moment. <br><br>  We solve this problem in two ways: <br><br><ul><li>  Separate alerts for disconnection / status changes of the software or host. </li><li>  Uploading statuses by host or using host logs to update current status. </li></ul><br>  This information is automatically added to the appropriate incident: <br><br><img src="https://habrastorage.org/webt/nv/rp/42/nvrp42v5n0dfs-_2btgubp_3-aq.png"><br><br>  <b>Keeping asset information up to date.</b> <b><br></b> <br>  As we have already said, no matter how thoroughly you approach the description of the infrastructure, it will soon become obsolete.  Literally in a month or two, the customer‚Äôs network will begin to change: new services or hosts will appear, old ones will disappear, some systems will change their purpose. <br><br>  Here are a few approaches that we use in Solar JSOC to maintain the current context: <br><br><ol><li>  Replenishment of information on on-demand assets, upon the occurrence of suspicions of an incident.  When analyzing the incident revealed that the asset (IP address) was not included in our network model, upon notification, we ask the customer for information on the host.  This applies to filling in information about both the asset and subnets. </li><li>  Regular inventory of potential new hosts.  There are several options: <br><ul><li>  Unload hosts from a domain, antivirus, etc., and compare it with the current state.  This is done with the help of the simplest correlation rule, under which you can specify a specific OrganizationUnit, hostname by mask, etc.  - depending on what you want to see. <br><br><img src="https://habrastorage.org/webt/4p/nx/an/4pnxany-02aonfraghsvi2adr7m.png"><br></li><li>  Unload IP-MAC matching on switches in some network segments. <br><br><img src="https://habrastorage.org/webt/t3/x7/hi/t3x7hifql3e0vef2yw3xv6qpa6q.png"><br></li><li>  Monitor the network activity of the host. <br><br><img src="https://habrastorage.org/webt/na/bu/0l/nabu0l5f97wd4korjmf9vfxaooq.png"><br><br>  ‚ÄúOn delivery‚Äù to the process described above, we receive information about hosts that have not appeared for a long time in the designated reports and which probably no longer exist.  For example, you can ‚Äúfollow the process of dismissal of employees‚Äù and make alerts / reports on the movement of the host / UZ in ‚ÄúOU = disabled‚Äù. <br><br><img src="https://habrastorage.org/webt/nh/py/ng/nhpyng-b7fyxcddpvesisfizn1y.png"><br></li></ul><br></li><li>  Finally, the most difficult, but very important process is the ‚Äúmanual‚Äù gathering from the responsible specialists of the customer information about changes, new subsystems, or scaling up old ones.  In Solar JSOC, the contract service manager deals with this, and often this work brings significantly more results than the automation described above. </li></ol><br><h3>  The game is not worth the candle, and the result - labor? <br></h3><br>  Surely, by the end of this article, not one of our practical readers has wondered: why do we need to fence all this insane construction, taking into account and updating the asset model?  Maybe it's easier and ‚Äúcheaper‚Äù to manually deal with each host in the event of an incident, and the end customer does not need such a meticulous inventory? <br><br>  We will try with a few examples to show how the asset model simplifies and automates part of the activities of the SOC operator and helps in its daily work. <br><br>  <b>Ability to filter excess</b> <b><br></b> <br>  "Correct" SIEM systems allow you to automatically use the asset model to filter potential incidents into exceptions.  This can significantly reduce the time that the operator has to spend on the analysis of "garbage". <br><br>  For example, we often begin to collect primary information about script triggers from a customer before we fill in the first network model, because the rule for identifying calls to C &amp; C servers and malicious sites can be started fairly quickly. <br>  Does this mean that the entire customer network is full of malware or, conversely, the reputational bases of C &amp; C servers give so many false positives?  As a rule, neither one nor the other.  Just in the offices of the customer company there is a guest wifi, all user sessions of which use the same infrastructure of access to the Internet as the main client network, and therefore come into the view of monitoring. <br><br>  Is it interesting to the customer how safe are the phones of external people who just used his guest Wi-Fi?  Should SOC operator handle such incidents?  Most likely no.  So filtering Wi-Fi networks from this scenario is a very reasonable and desirable step. <br><br>  Or another example: usually in a company at the level of security policy there is a restriction on using Remote Admin Tools.  But helpdesk employees, whose duties include servicing remote machines, users on business trips or remote sales points, are often forced to use this tool in their daily work.  Wouldn't it be easier for SOC to identify the helpdesk locations and ignore such events than to handle each suspicion of the incident manually? <br><br>  <b>Increasing the criticality and priority of the incident, depending on the specific asset</b> <b><br></b> <br>  The situation, in my opinion, also does not require additional comments.  An incident that occurred on the AWS of the CBD in a bank or at the junction of the main and technological segment in the energy sector will always be many times more important and more important than even fixing the launch of hacker tools in the user segment.  And such an incident should be detected and processed much faster. <br><br>  From our practice in recent years, it is clear that attackers have learned to use the weak prioritization of incidents in young SOCs.  As one of the final stages of the attack, they use the so-called "incident storm", creating several dozen suspicions of the incident in different parts of the infrastructure, before seizing the target resource or compromising information.  The SOC operator, processing several dozen incidents in turn, simply does not have time to get to the right, really critical, until it is too late.  Whereas a proper prioritization would allow him to focus his attention on the most important incident and prevent the consequences of the attack. <br><br>  <b>Seeing the strange</b> <b><br></b> <br>  The more information about the asset and the situation as a whole the operator has at the beginning of the analysis of the incident, the faster he will make a decision, and the more correct it will be.  And of course, the greater the chance that a real complex attack, caught on the basis of a small anomaly, will be effectively identified and dismantled in a SOC. <br><br>  Well, in general, who owns the information, he owns the world.  On this we would like to finish our immersion in the subject of asset management.  For all the remaining practical and not very questions - welcome to the comments.  And to new meetings in the cycle "SOC for ....". </div><p>Source: <a href="https://habr.com/ru/post/353314/">https://habr.com/ru/post/353314/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353304/index.html">The best game in 2048 with a Markov decision process</a></li>
<li><a href="../353306/index.html">Solidity 0.5.0 - what's new for us</a></li>
<li><a href="../353308/index.html">Mail.Ru Mail will hold the first ML-hakaton SmartMail Hack 2018</a></li>
<li><a href="../353310/index.html">IT courses: what remains behind the scenes</a></li>
<li><a href="../353312/index.html">TDD wrong?</a></li>
<li><a href="../353316/index.html">How to set up various notifications about problems with the site</a></li>
<li><a href="../353318/index.html">State space in problems of designing optimal control systems</a></li>
<li><a href="../353320/index.html">Vulnerability found in Vesta CP hosting control panel</a></li>
<li><a href="../353322/index.html">Visualizing Process Connections in Linux</a></li>
<li><a href="../353324/index.html">How is information security operational management center (SOC-center) built today?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>