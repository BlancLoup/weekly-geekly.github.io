<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting Facebook SDK for Xamarin.Forms</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Social networks, and especially Facebook, have long been used in mobile applications. Today we will look at how to connect the native Facebook SDK to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting Facebook SDK for Xamarin.Forms</h1><div class="post__text post__text-html js-mediator-article">  Social networks, and especially Facebook, have long been used in mobile applications.  Today we will look at how to connect the native Facebook SDK to a project based on Xamarin.Forms (iOS and Android) for easy authorization of users and getting basic information about them.  You can also easily expand the methods described in the article in order to realize full-fledged interaction with this wonderful service.  The topic is simple and understandable, therefore, without theories and preludes, we will proceed immediately to practice. <br><br><img src="https://habrastorage.org/files/65c/d3d/c42/65cd3dc4255c46e2b669fc90b0c251d7.jpg"><br><a name="habracut"></a><br><h2>  Create an application on Facebook </h2><br>  For those who first create their application in Facebook, we will briefly describe how this is done. <br><br>  The process itself is quite simple and will require the following data from you: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> Package Name for the Android project (for example, <code>com.binwell.login</code> ) </li><li>  Bundle Identifier for an iOS project (for example, <code>com.binwell.login</code> ) </li></ul><br>  For Android, you still need Key Hashes, which can be obtained with the command: <br><br>  Windows: <br><br><pre> <code class="cpp hljs">keytool -exportcert -alias androiddebugkey -storepass android -keystore C:\Users\[USERNAME]\AppData\Local\Xamarin\Mono <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Android\debug.keystore | openssl sha1 -binary | openssl base64</code> </pre> <br>  macOS: <br><br><pre> <code class="cpp hljs">keytool -exportcert -alias androiddebugkey -storepass android -keystore /Users/[USERNAME]/.local/share/Xamarin/Mono <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Android/debug.keystore | openssl sha1 -binary | openssl base64</code> </pre> <br>  Instead of <code>[USERNAME]</code> you must substitute your username in the system.  Plus, you can register the path to <code>openssl</code> , if the path to it is not specified in the <code>PATH</code> .  Download <code>openssl</code> for Windows <a href="http://gnuwin32.sourceforge.net/packages/openssl.htm">here</a> . <br><br>  At the output, we get the necessary <code>Key Hashes</code> following form: <code>kGP2WMxohvxm/NiwR7H+Eb3/8qw=</code> <br><br>  Now go to <a href="https://aka.ms/habr_321454_1">developers.facebook.com</a> and create a new application.  Separately for iOS and Android.  When creating an application, we can use the Quick Start mode, which additionally describes how to set up a project.  We will need code examples from this guide. <br><br><img src="https://habrastorage.org/files/cfc/01f/0b5/cfc01f0b5b1142488b1dc28f70dce027.jpg"><br><br><img src="https://habrastorage.org/files/67a/292/55d/67a29255dd2b45f0a7ab5304c52138d4.jpg"><br><br><h2>  We connect Facebook SDK to iOS and Android projects </h2><br>  First you need to install the Facebook SDKs from Xamarin for iOS and Android from Nuget: <br><br><img src="https://habrastorage.org/files/18e/51b/7fc/18e51b7fcaea4f689dbc9525013705f4.jpg"><br><br>  Please note that only Xamarin.Facebook.Android 4.11.0.1 is currently compatible with Xamarin.Forms 2.3.  Version Xamarin.Facebook.iOS has no compatibility limitations. <br><br><h4>  Connect to Android </h4><br>  First we need to write special values ‚Äã‚Äãin the file <code>Resources/values/strings.xml</code> : <br><br><pre> <code class="cpp hljs">&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name=<span class="hljs-string"><span class="hljs-string">"facebook_app_id"</span></span>&gt;<span class="hljs-number"><span class="hljs-number">1102463466549096</span></span>&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name=<span class="hljs-string"><span class="hljs-string">"fb_login_protocol_scheme"</span></span>&gt;fb1102463466549096&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;</code> </pre> <br>  Where, <code>1102463466549096</code> is your App ID from the settings of the Facebook application.  Additionally, we will need to make the following changes to <code>AndroidManifest.xml</code> : <br><br><pre> <code class="cpp hljs"> &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.INTERNET"</span></span> /&gt; &lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span></span> /&gt; &lt;application android:label=<span class="hljs-string"><span class="hljs-string">"@string/app_name"</span></span>&gt; &lt;meta-data android:name=<span class="hljs-string"><span class="hljs-string">"com.facebook.sdk.ApplicationId"</span></span> android:value=<span class="hljs-string"><span class="hljs-string">"@string/facebook_app_id"</span></span>/&gt; &lt;activity android:name=<span class="hljs-string"><span class="hljs-string">"com.facebook.FacebookActivity"</span></span> android:configChanges=<span class="hljs-string"><span class="hljs-string">"keyboard|keyboardHidden|screenLayout|screenSize|orientation"</span></span> android:theme=<span class="hljs-string"><span class="hljs-string">"@android:style/Theme.Translucent.NoTitleBar"</span></span> android:label=<span class="hljs-string"><span class="hljs-string">"@string/app_name"</span></span> /&gt; &lt;activity android:name=<span class="hljs-string"><span class="hljs-string">"com.facebook.CustomTabActivity"</span></span> android:exported=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.VIEW"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.BROWSABLE"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"@string/fb_login_protocol_scheme"</span></span> /&gt; &lt;/intent-filter&gt; &lt;provider android:authorities=<span class="hljs-string"><span class="hljs-string">"com.facebook.app.FacebookContentProvider1102463466549096"</span></span> android:name=<span class="hljs-string"><span class="hljs-string">"com.facebook.FacebookContentProvider"</span></span> android:exported=<span class="hljs-string"><span class="hljs-string">"true"</span></span> /&gt; &lt;/activity&gt; &lt;/application&gt;</code> </pre> <br>  Next, we make minor improvements to <code>MainActivity.cs</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ TabLayoutResource = Resource.Layout.Tabbar; ToolbarResource = Resource.Layout.Toolbar; base.OnCreate(bundle); FacebookSdk.SdkInitialize(ApplicationContext); Forms.Init(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, bundle); LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ base.OnResume(); AppEventsLogger.ActivateApp(Application); }</code> </pre><br>  This completes the initial initialization of the Facebook SDK. <br><br><h4>  We connect in iOS </h4><br>  Similar to Android, we will need to make changes to the <code>Info.plist</code> file, insert the following lines between <code>&lt;dict&gt;...&lt;/dict&gt;</code> : <br><br><pre> <code class="cpp hljs">&lt;key&gt;CFBundleURLTypes&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;dict&gt; &lt;key&gt;CFBundleURLSchemes&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fb1102463466549096&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;/<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;/dict&gt; &lt;/<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;key&gt;FacebookAppID&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;<span class="hljs-number"><span class="hljs-number">1102463466549096</span></span>&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;key&gt;FacebookDisplayName&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;Binwell Social Demo&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;key&gt;LSApplicationQueriesSchemes&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fbapi&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fb-messenger-api&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fbauth2&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fbshareextension&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;/<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;key&gt;NSAppTransportSecurity&lt;/key&gt; &lt;dict&gt; &lt;key&gt;NSExceptionDomains&lt;/key&gt; &lt;dict&gt; &lt;key&gt;facebook.com&lt;/key&gt; &lt;dict&gt; &lt;key&gt;NSIncludesSubdomains&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>/&gt; &lt;key&gt;NSThirdPartyExceptionRequiresForwardSecrecy&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">false</span></span>/&gt; &lt;/dict&gt; &lt;key&gt;fbcdn.net&lt;/key&gt; &lt;dict&gt; &lt;key&gt;NSIncludesSubdomains&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>/&gt; &lt;key&gt;NSThirdPartyExceptionRequiresForwardSecrecy&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">false</span></span>/&gt; &lt;/dict&gt; &lt;key&gt;akamaihd.net&lt;/key&gt; &lt;dict&gt; &lt;key&gt;NSIncludesSubdomains&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>/&gt; &lt;key&gt;NSThirdPartyExceptionRequiresForwardSecrecy&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">false</span></span>/&gt; &lt;/dict&gt; &lt;/dict&gt; &lt;/dict&gt;</code> </pre> <br>  And some code in <code>AppDelegate.cs</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinishedLaunching</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIApplication app, NSDictionary options)</span></span></span><span class="hljs-function"> </span></span>{ Xamarin.Forms.Forms.Init(); LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); Facebook.CoreKit.Profile.EnableUpdatesOnAccessTokenChange(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); Facebook.CoreKit.ApplicationDelegate.SharedInstance.FinishedLaunching(app, options); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base.FinishedLaunching(app, options); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIApplication application, NSUrl url, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sourceApplication, NSObject annotation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Facebook.CoreKit.ApplicationDelegate.SharedInstance.OpenUrl(application, url, sourceApplication, annotation); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActivated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIApplication application)</span></span></span><span class="hljs-function"> </span></span>{ Facebook.CoreKit.AppEvents.ActivateApp(); }</code> </pre> <br>  This completes the preliminary preparation and we can proceed to use the Facebook SDK in our application. <br><br><h2>  Integrating with Xamarin.Forms </h2><br>  We will use the Facebook SDK through the <code>DependencyService</code> mechanism.  To do this, first of all, we describe the necessary data and service interface: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface IFacebookService { Task&lt;LoginResult&gt; Login(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> LoginState { Failed, Canceled, Success } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginResult</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> FirstName { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> LastName { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Email { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> ImageUrl { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> UserId { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Token { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeOffset ExpireAt { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LoginState LoginState { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> ErrorString { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } }</code> </pre> <br>  One of the goals of connecting social networks is the ability to easily and conveniently retrieve user data, so we will need an additional request to receive email, which Facebook does not give by default.  These requests will need to be implemented separately for each platform. <br><br><h4>  Implementation for android </h4><br>  For Android, the implementation of the interface is as follows: <br><br><pre> <code class="cpp hljs">[assembly: Dependency(typeof(AndroidFacebookService))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Login.Droid { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AndroidFacebookService</span></span></span><span class="hljs-class">:</span></span> Java.Lang.Object, IFacebookService, GraphRequest.IGraphJSONObjectCallback, GraphRequest.ICallback, IFacebookCallback { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AndroidFacebookService Instance =&gt; DependencyService.Get&lt;IFacebookService&gt;() as AndroidFacebookService; readonly ICallbackManager _callbackManager = CallbackManagerFactory.Create(); readonly <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[] _permissions = { @<span class="hljs-string"><span class="hljs-string">"public_profile"</span></span>, @<span class="hljs-string"><span class="hljs-string">"email"</span></span>, @<span class="hljs-string"><span class="hljs-string">"user_about_me"</span></span> }; LoginResult _loginResult; TaskCompletionSource&lt;LoginResult&gt; _completionSource; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AndroidFacebookService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LoginManager.Instance.RegisterCallback(_callbackManager, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;LoginResult&gt; Login() { _completionSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;LoginResult&gt;(); LoginManager.Instance.LogInWithReadPermissions(Forms.Context as Activity, _permissions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _completionSource.Task; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ LoginManager.Instance.LogOut(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ _callbackManager?.OnActivityResult(requestCode, resultCode, data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JSONObject data, GraphResponse response)</span></span></span><span class="hljs-function"> </span></span>{ OnCompleted(response); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GraphResponse response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response?.JSONObject == null) _completionSource?.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult {LoginState = LoginState.Canceled}); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _loginResult = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { FirstName = Profile.CurrentProfile.FirstName, LastName = Profile.CurrentProfile.LastName, Email = response.JSONObject.Has(<span class="hljs-string"><span class="hljs-string">"email"</span></span>) ? response.JSONObject.GetString(<span class="hljs-string"><span class="hljs-string">"email"</span></span>) : <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Empty, ImageUrl = response.JSONObject.GetJSONObject(<span class="hljs-string"><span class="hljs-string">"picture"</span></span>)?.GetJSONObject(<span class="hljs-string"><span class="hljs-string">"data"</span></span>)?.GetString(<span class="hljs-string"><span class="hljs-string">"url"</span></span>), Token = AccessToken.CurrentAccessToken.Token, UserId = AccessToken.CurrentAccessToken.UserId, ExpireAt = FromJavaDateTime(AccessToken.CurrentAccessToken?.Expires?.Time), LoginState = LoginState.Success }; _completionSource?.TrySetResult(_loginResult); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _completionSource?.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Canceled }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FacebookException exception)</span></span></span><span class="hljs-function"> </span></span>{ _completionSource?.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Failed, ErrorString = exception?.Message }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Java.Lang.Object result)</span></span></span><span class="hljs-function"> </span></span>{ var facebookLoginResult = result.JavaCast&lt;Xamarin.Facebook.Login.LoginResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (facebookLoginResult == null) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; var parameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); parameters.PutString(<span class="hljs-string"><span class="hljs-string">"fields"</span></span>, <span class="hljs-string"><span class="hljs-string">"id,email,picture.type(large)"</span></span>); var request = GraphRequest.NewMeRequest(facebookLoginResult.AccessToken, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); request.Parameters = parameters; request.ExecuteAsync(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DateTimeOffset </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromJavaDateTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">? longTimeMillis)</span></span></span><span class="hljs-function"> </span></span>{ var epoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> longTimeMillis != null ? epoch.AddMilliseconds(longTimeMillis.Value) : DateTimeOffset.MinValue; } } }</code> </pre> <br>  Additionally, you need to add a handler to <code>MainActivity.cs</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, Result resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ base.OnActivityResult(requestCode, resultCode, data); AndroidFacebookService.Instance.OnActivityResult(requestCode, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)resultCode, data); }</code> </pre> <br><h4>  Implementation for iOS </h4><br>  Making interface implementation for Facebook iOS SDK. <br><br><pre> <code class="cpp hljs">[assembly: Dependency(typeof(AppleFacebookService))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Login.iOS { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppleFacebookService</span></span></span><span class="hljs-class">:</span></span> IFacebookService { readonly LoginManager _loginManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginManager(); readonly <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[] _permissions = { @<span class="hljs-string"><span class="hljs-string">"public_profile"</span></span>, @<span class="hljs-string"><span class="hljs-string">"email"</span></span>, @<span class="hljs-string"><span class="hljs-string">"user_about_me"</span></span> }; LoginResult _loginResult; TaskCompletionSource&lt;LoginResult&gt; _completionSource; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;LoginResult&gt; Login() { _completionSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;LoginResult&gt;(); _loginManager.LogInWithReadPermissions(_permissions, GetCurrentViewController(), LoginManagerLoginHandler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _completionSource.Task; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _loginManager.LogOut(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoginManagerLoginHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoginManagerLoginResult result, NSError error)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.IsCancelled) _completionSource.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult {LoginState = LoginState.Canceled}); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error != null) _completionSource.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Failed, ErrorString = error.LocalizedDescription }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _loginResult = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { Token = result.Token.TokenString, UserId = result.Token.UserID, ExpireAt = result.Token.ExpirationDate.ToDateTime() }; var request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphRequest(@<span class="hljs-string"><span class="hljs-string">"me"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NSDictionary(@<span class="hljs-string"><span class="hljs-string">"fields"</span></span>, @<span class="hljs-string"><span class="hljs-string">"email"</span></span>)); request.Start(GetEmailRequestHandler); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEmailRequestHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GraphRequestConnection connection, NSObject result, NSError error)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error != null) _completionSource.TrySetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Failed, ErrorString = error.LocalizedDescription }); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _loginResult.FirstName = Profile.CurrentProfile.FirstName; _loginResult.LastName = Profile.CurrentProfile.LastName; _loginResult.ImageUrl = Profile.CurrentProfile.ImageUrl(ProfilePictureMode.Square, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CGSize()).ToString(); var dict = result as NSDictionary; var emailKey = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NSString(@<span class="hljs-string"><span class="hljs-string">"email"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict != null &amp;&amp; dict.ContainsKey(emailKey)) _loginResult.Email = dict[emailKey]?.ToString(); _loginResult.LoginState = LoginState.Success; _completionSource.TrySetResult(_loginResult); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> UIViewController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrentViewController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ var viewController = UIApplication.SharedApplication.KeyWindow.RootViewController; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (viewController.PresentedViewController != null) viewController = viewController.PresentedViewController; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> viewController; } } }</code> </pre> <br><h4>  We connect to Xamarin.Forms </h4><br>  To access the created implementations, simply insert the following <code>Clicked</code> event <code>Clicked</code> for the Facebook Login button: <br><br><pre> <code class="cpp hljs">var loginResult = await DependencyService.Get&lt;IFacebookService&gt;().Login(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (loginResult.LoginState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LoginState.Canceled: <span class="hljs-comment"><span class="hljs-comment">//  break; case LoginState.Success: var str = $"Hi {loginResult.FirstName}! Your email is {loginResult.Email}"; break; default: //   break; }</span></span></code> </pre> <br>  This coding is complete! <br><br><h2>  We use </h2><br>  So, an exciting moment.  We build, run and ... easily log in using native SDKs. <br><br><img src="https://habrastorage.org/files/343/67a/229/34367a2299cd490cbbfb21bbe53bc4fd.jpg"><br><br>  The complete project code with step changes is located in <a href="https://aka.ms/habr_321454_2">the Bitbucket repository</a> . <br><br>  So, today we connected the native Facebook SDK to the application on Xamarin.Forms.  Authorization and getting basic information about the user is already working, but if you wish, you can easily expand the set of methods for accessing all the features of the Facebook SDK.  Next time we will take the puzzle more interesting and connect the native VKontakte SDK. <br><br>  Stay in touch, ask your questions in the comments and join the <a href="https://aka.ms/habr_321454_3">Xamarin Developers</a> group in Telegram! <br><br><h3>  about the author </h3><br><img src="https://habrastorage.org/files/f70/e9c/e7a/f70e9ce7a2bd45a98e19652a08b15e26.JPG" align="left" width="120">  Vyacheslav Chernikov - head of development at <a href="https://aka.ms/habr_321454_4">Binwell</a> .  In the past, he was one of the Nokia Champion and Qt Certified Specialists, currently he is the Xamarin and Azure platform specialist.  He came to the sphere of mobile in 2005, since 2008 he has been developing mobile applications: he started with Symbian, Maemo, Meego, Windows Mobile, then switched to iOS, Android and Windows Phone. <br><br>  <b>Other articles by the author:</b> <br><ul><li>  <a href="https://habrahabr.ru/company/microsoft/blog/332970">OAuth Authorization for Xamarin Applications</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/329908/">Deploy mobile software with Microsoft devops pipeline</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/325184/">DevOps in the service of man</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/327900/">Automate non-automated, or about Xamarin in real projects</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/310704/">Convenient REST for Xamarin Applications</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/281897/">Quickly create MVP (minimum viable product) based on Microsoft Azure and Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/303630/">Preparing Xamarin.Forms: Setting Up the Environment and First Steps</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/304678/">Increase work efficiency in Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/307890/">Working with screen states in Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/323296/">We connect VKontakte SDK for Xamarin.Forms</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/321454/">https://habr.com/ru/post/321454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321442/index.html">Openstack. Detective story or where the connection is lost? Part one</a></li>
<li><a href="../321444/index.html">We read Google tables from the web application</a></li>
<li><a href="../321446/index.html">How does it feel to be a developer in Russia when you're forty</a></li>
<li><a href="../321448/index.html">Load balancing and fault tolerance in Odnoklassniki</a></li>
<li><a href="../321452/index.html">CEF, Angular 2 using .Net Core class events</a></li>
<li><a href="../321456/index.html">The method of recursive coordinate bisection for decomposition of computational grids</a></li>
<li><a href="../321458/index.html">How we made the application of the international loyalty program PINS: case</a></li>
<li><a href="../321460/index.html">Games do not have to entertain</a></li>
<li><a href="../321462/index.html">Changes in the procedure for issuing a certificate for signing the code for Certum</a></li>
<li><a href="../321464/index.html">Stack Overflow told what languages ‚Äã‚Äãand programming technologies are popular as a hobby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>