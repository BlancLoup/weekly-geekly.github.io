<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SaltStack: managing an arbitrary number of configuration files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is interesting here? 
 The article will help to understand how to manage an arbitrary number of configuration files of a certain service in SaltS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SaltStack: managing an arbitrary number of configuration files</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>What is interesting here?</b> </h4><br>  The article will help to understand how to manage an arbitrary number of configuration files of a certain service in SaltStack. <br><br><h4>  <b>SaltStack (underfloor): what is it and how to deal with it?</b> </h4><br>  Many have already had experience with automated configuration management systems, which include Salt, and talk in detail about how to prepare it and what it may I do not, <a href="http://www.saltstack.com/integrations/">then</a> you can read what it is, and <a href="http://docs.saltstack.com/en/latest/topics/tutorials/walkthrough.html">then</a> read how to quickly and easily prepare it. <br><br><h4>  <b>SaltStack (lobby): a typical application for a simple example</b> </h4><br>  So, suppose you have a task to automate the installation, the deployment of configuration files and the monitoring of their changes, and the reboot if necessary for such a popular service as nginx.  To simplify the system, we assume that the servers being serviced are based on Debian Wheezy.  (For everyone else, we read about the <a href="http://docs.saltstack.com/en/latest/topics/targeting/grains.html">grains</a> system, it will help determine on which system we use the state and change its behavior accordingly). <br>  So: <br><a name="habracut"></a><br><pre><code class="python hljs">nginx-repo-key-install: cmd.run: - name: <span class="hljs-string"><span class="hljs-string">'apt-key adv --keyserver keys.gnupg.net --recv-keys ABF5BD827BD9BF62'</span></span> - unless: <span class="hljs-string"><span class="hljs-string">'apt-key list | grep -q 7BD9BF62'</span></span> nginx-repo: pkgrepo.managed: - humanname: nginx-repo - name: deb http://nginx.org/packages/mainline/debian/ wheezy nginx - require_in: - pkg: nginx-pkg - required: - cmd: nginx-repo-key-install nginx-pkg: pkg.installed: - name: nginx - refresh: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> - require: - pkgrepo: nginx-repo nginx-service: service.running: - name: nginx - full_restart: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> - require: - pkg: nginx-pkg - watch: - file: nginx-config-vhost nginx-config-vhost: file.managed: - name: /etc/nginx/conf.d/vhost.conf - source: salt://__CONFIGS/vhost.conf - user: root - group: root - mode: <span class="hljs-number"><span class="hljs-number">644</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It's all like the ‚Äúbook writes‚Äù, but let's take a closer look (very important as a background for the following calculations): <br><ul><li>  nginx-repo-key-install: import the official repository key into the system </li><li>  nginx-repo: we are adding the official repository to apt </li><li>  nginx-pkg: we put a fresh package </li><li>  nginx-service: we take control of the service and make monitor the changes to the configuration file </li><li>  nginx-config-vhost: actually - the configuration file and the place to get it from </li></ul><br>  For inquisitive minds, with the naked eye, omissions are visible (for example, control over nginx.conf is not described), but all of them are made in order to reduce the information load not related to the problem area. <br><br><h4>  <b>SaltStack (second floor): Many configuration files</b> </h4><br>  In the first example, a service was shown in which there is one file where some kind of virtual server nginx is described.  If it is changed on the Salt wizard (salt: //__CONFIGS/vhost.conf) and the state is restarted, the file will be updated on the machine and the nginx service will be restarted (full_restart: True) automatically. <br>  Often there will be several virtual hosts on a machine with nginx.  Consider how to organize their management. <br>  Suppose there are vhost files {1,2,3,4,5} .conf.  In this case, the lower part of the state will look like this: <br><pre> <code class="python hljs">...... nginx-service: service.running: - name: nginx - full_restart: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> - require: - pkg: nginx-pkg - watch: {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cnf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'vhost1.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost2.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost3.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost4.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost5.conf'</span></span>] %} - file: nginx-config-{{ cnf }} {% endfor %} {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cnf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'vhost1.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost2.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost3.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost4.conf'</span></span>, <span class="hljs-string"><span class="hljs-string">'vhost5.conf'</span></span>] %} nginx-config-{{ cnf }}: file.managed: - name: /etc/nginx/conf.d/{{ cnf }} - source: salt://__CONFIGS/{{ cnf }} - user: root - group: root - mode: <span class="hljs-number"><span class="hljs-number">644</span></span> {% endfor %}</code> </pre><br><br>  Here begins a little Salt magic, namely: <a href="http://jinja.pocoo.org/">Jinja</a> - a template engine for Python (on which SaltStack is written).  Everything is obvious in the stack: we make many file objects with different names and tie all of them to the service so that when changes are made, it is restarted.  For optimization, you can use a <a href="http://docs.saltstack.com/en/latest/topics/pillar/index.html">pillar</a> system to store the names of files with configurations.  But this is homework. <br><br><h4>  <b>SaltStack (one floor upper): Many configuration files ‚Äî but how many and which ones ‚Äî are unknown.</b> </h4><br>  So, the reason why this article was conceived is a fairly common situation for most virtual hosting systems: a large, previously unknown and constantly changing number of configuration files.  How, then, to do with the deployment of infrastructure through Salt?  There is a solution!  Unfortunately, the obvious is not enough (even the developers had to ask for clarification), but it worked. <br>  So: <br><pre> <code class="python hljs">...... nginx-service: service.running: - name: nginx - full_restart: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> - require: - pkg: nginx-pkg - watch: {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cnf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> salt[<span class="hljs-string"><span class="hljs-string">'cp.list_master'</span></span>](prefix=<span class="hljs-string"><span class="hljs-string">'__CONFIGS/'</span></span>) %} - file: nginx-config-{{ cnf }} {% endfor %} {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cnf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> salt[<span class="hljs-string"><span class="hljs-string">'cp.list_master'</span></span>](prefix=<span class="hljs-string"><span class="hljs-string">'__CONFIGS/'</span></span>) %} {% set items = cnf.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) %} nginx-config-{{ cnf }}: file.managed: - name: /etc/nginx/conf.d/{{ items|last }} - source: salt://{{ cnf }} - user: root - group: root - mode: <span class="hljs-number"><span class="hljs-number">644</span></span> {% endfor %}</code> </pre><br><br>  Actually now about the most interesting places: <br><pre> <code class="python hljs">{% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cnf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> salt[<span class="hljs-string"><span class="hljs-string">'cp.list_master'</span></span>](prefix=<span class="hljs-string"><span class="hljs-string">'__CONFIGS/'</span></span>) %}</code> </pre><br>  call the list_master function from the <a href="http://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.cp.html%3Fhighlight%3Dcp.list_master">cp</a> module with the prefix '__CONFIGS /' (the folder name on the Salt wizard where all the configuration files for this service are located), which s lists the files in this directory and iterates over the list with a for loop. <br><pre> <code class="python hljs">{% set items = cnf.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) %}</code> </pre><br>  The cp.list_master problem is that it gives the full path to the file (along with the prefix), and we only need the file name in order to specify it in the "- name:" directive.  In this regard, we split the full path by slashes and use only the last element of the list - i.e.  file name: <br><pre> <code class="python hljs">- name: /etc/nginx/conf.d/{{ items|last }}</code> </pre><br>  As a result, we obtain a revised directory, configuration files included in the turnover that are available in this directory, and immediately we tied it to an automatic restart of the service in case of edits in the files. <br><br><h4>  Conclusion </h4><br>  Very briefly, but I hope it will help those Habr readers who are just starting to implement SaltStack and want to go a little further than book examples with simple package management.  Successes! </div><p>Source: <a href="https://habr.com/ru/post/218231/">https://habr.com/ru/post/218231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218217/index.html">[video] How to put a person in place: 10 real questions about the pressure in the negotiations</a></li>
<li><a href="../218221/index.html">April 4 - the Day of St. Isidore of Seville and the day of the webmaster</a></li>
<li><a href="../218225/index.html">Micro ORM one class</a></li>
<li><a href="../218227/index.html">Autoconfiguration (Auto Setup) of Polycom Phones Using Asterisk</a></li>
<li><a href="../218229/index.html">Compile life</a></li>
<li><a href="../218233/index.html">LPC1102 and warm lamp indicator</a></li>
<li><a href="../218237/index.html">Creating a hosting site based on Proxmox + HP ProLiant</a></li>
<li><a href="../218241/index.html">Happy webmasters!</a></li>
<li><a href="../218243/index.html">Big data and their storage</a></li>
<li><a href="../218245/index.html">How do we do trello</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>