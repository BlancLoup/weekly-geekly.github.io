<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unleash the game code using the Command pattern, and debugging while flying on the time machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I write articles on architecture in game development. In this article I want to make out the pattern Command (Command) . It is multifaceted, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unleash the game code using the Command pattern, and debugging while flying on the time machine</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/post/350630/"><img src="https://habrastorage.org/getpro/habr/post_images/8af/c00/9de/8afc009de5d35da786062bf1538e8a2c.png" alt="Picture to attract attention: &amp; gt;  Replay bug-10492;  going back in time"></a> </p><br><p>  Hello!  I write articles on architecture in game development.  In this article I want to make out the pattern <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Command (Command)</a> .  It is multifaceted, and can be applied in different ways.  But I'll show you how to do my favorite trick ‚Äî a time machine for debugging game state changes. </p><br><p>  This thing saved me a lot of time searching and playing complex bugs.  It allows you to make "snapshots" of the game state, its history of changes, and use them step by step. </p><br><p>  Beginner developers will get familiar with the pattern, and advanced ones will probably find the trick useful. </p><br><p>  Want to know how to do this?  I ask under the cat. </p><a name="habracut"></a><br><p>  If you are already familiar with the Command pattern, then go directly to the section "Making a State Modification Unidirectional". </p><br><h2>  Command Pattern </h2><br><p>  What do we mean by the word "team"?  This is something like an order.  With the help of a team, a person expresses the need to perform an action.  Action is inseparable from the team. </p><br><p>  The Command pattern is a way of representing action in the world of object-oriented programming.  And it is thanks to polymorphism that this becomes possible. </p><br><p>  The idea behind the pattern is that all the commands for the system are the same.  In terms of OOP, all commands have a common interface.  The system can transparently execute any of them.  This means that the team must be completely independent, and encapsulate all the data necessary for its execution. </p><br><p>  While the description is rather abstract.  Let's get to the specifics.  Basic interface for all commands: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br><p>  Now an example of a specific command implementation: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WriteToConsoleCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(Message); } }</code> </pre> <br><p>  This is a kind of "Hello world" on the teams.  And how to execute them?  Let's write a simple command processing system. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGameSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ICommand cmd</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoggableGameSystem</span></span> : <span class="hljs-title"><span class="hljs-title">IGameSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoggableGameSystem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ILogger log</span></span></span><span class="hljs-function">)</span></span> { _log = log; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ICommand cmd</span></span></span><span class="hljs-function">)</span></span> { _log.Debug(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Executing command &lt;{0}&gt;: {1}"</span></span>, cmd.GetType(), cmd); cmd.Execute(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ILogger _log; }</code> </pre> <br><p>  Now we can log every executable command for debugging.  Is it convenient?  But the command needs to be prepared for the debug output, we add the ToString () method. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WriteToConsoleCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(Message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Message; } }</code> </pre> <br><p>  Check how it works. </p><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gameSystem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggableGameSystem(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WriteToConsoleCommand(<span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WriteToConsoleCommand(<span class="hljs-string"><span class="hljs-string">"Hello world2"</span></span>); gameSystem.Execute(cmd); gameSystem.Execute(cmd2); } }</code> </pre> <br><p>  This is a fairly simple example.  Of course, the debugging output is useful, but it is not clear what else useful can be learned from this pattern. </p><br><p>  In my projects I constantly use this pattern for several reasons: </p><br><ul><li>  The team retains everything that is necessary until its execution.  It is essentially an immutable object.  Therefore, it is easy to transmit over the network, and equally execute both on the client and on the server.  Of course, this is assuming that with the same input parameters, both the client and the server give the same results. </li><li>  A command is a very small piece of logic.  It is easy to write, easy to understand, and easy to debug.  Since the command is immutable and does not contain any additional dependencies, it is easy for it to write unit tests. </li><li>  Complex business logic is easy to express through a set of simplest commands.  Commands are easy to reuse and link in sequence. </li><li>  A team can act as a checkpoint, or as a transaction, as you like.  If the change in the state of the data occurs only through commands, it simplifies debugging, and even the understanding of the program.  If something breaks down, you can always trace which team caused the error.  What is convenient - you can see the parameters with which the command was executed. </li><li>  Command execution may be delayed.  A typical example is sending a command to a server.  When the user initiated any action in the game, a command is created and added to the queue for execution.  The actual execution of the command occurs only after confirmation from the server. </li><li>  Since the commands are rather abstracted from all dependencies, it is easy to change the architecture.  For example, if before the code was only offline and the control of AI occurred only locally, then it is easy to change to control AI using the server.  After all, the code does not matter who sends commands, local code, or server. </li><li>  A well-known command trick - you can not only apply changes, but also make support for the "undo" action </li><li>  The code written with the ideology of commands is slightly different from the traditional approach with calling functions.  When a programmer creates a command, he reports the need to change the state.  How and when it will be done - he is not interested.  This allows you to create interesting things. </li></ul><br><p>  A little more about the last item.  For example, you had a synchronous function that should become asynchronous.  To do this, you need to change its signature, and write a mechanism for processing an asynchronous result in the form of a callback, or corutine, or async / await (if you crawled to .net 4.6).  And so every time, for each individual function. </p><br><p>  The mechanism of commands allows to abstract from the mechanism of execution.  Therefore, if a command was previously executed instantly, it can easily be made asynchronous.  It can even be changed dynamically, in runtime. </p><br><p>  Specific example.  The game supports partial offline.  If the network connection is now unavailable, then the commands go to the queue and are executed when the connection is restored.  If there is a connection, then the commands are executed instantly. </p><br><h2>  Simple unlinking of a state from logic using Commands </h2><br><h3>  Theory </h3><br><p>  This item is not necessary for the implementation of the "time machine", but it is useful, since the reactivity of the UI can still be useful during debugging. </p><br><p>  To begin, I wanted to tell you about the simple decoupling of UI from logic.  In Unity, various patterns are applicable, including MVVM, and there are a number of frameworks for this.  But in general, this is not so much about the UI, as about the state modification itself. </p><br><p>  Let's look at the general concepts and try to build a simple system ourselves. </p><br><p>  What is one-way modification of the state?  The idea is borrowed from the approach of <a href="https://github.com/facebook/flux/tree/master/">Flux</a> , described by the guys from Facebook.  On this approach, all sorts of newfangled libraries like <a href="https://redux.js.org/">Redux are built</a> . </p><br><p>  In traditional MV * approaches, View interacts with the model bilaterally. </p><br><p>  In Unity, the situation is often worse.  Traditional MVC does not fit here, and the data is often modified directly from View, as I will show below.  In complex applications, the number of links goes off scale, the update is lost in the update, everything gets confused, and it turns out spaghetti. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/554/e57/a5d/554e57a5dc15123dcc8079ed28c5c6bd.png" alt="Interacting with model views in MV * architectures"></p><br><p>  (Source: <a href="https://medium.com/e-fever/revised-qml-application-architecture-guide-with-flux-a1de143fe13e">medium.com</a> ) </p><br><p>  I suggest to play and make the system similar to Redux.  The basic idea that Redux proposes to store all the state of an application in one object.  That is one model. </p><br><p>  Some here will be horrified.  But after all, the serialization of the game state, most often, is reduced to the serialization of a single object.  This is a fairly natural approach to gaming. </p><br><p>  The second idea is that the state is modified using Actions.  In essence, this is exactly the same as the Command described earlier.  View can not modify the state directly, but only through the command. </p><br><p>  The third idea is a natural continuation, View can only read the status and subscribe to its updates. </p><br><p>  This is how it looks in Flux ideology: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0bf/404/3fd/0bf4043fd7f6d2b108b2a7f315993067.png" alt="Flux ideology data flow"></p><br><p>  (Source: <a href="https://medium.com/e-fever/revised-qml-application-architecture-guide-with-flux-a1de143fe13e">medium.com</a> ) </p><br><p>  In our case, the Store is a game state.  And Action is a team.  Dispatcher, respectively, that executes commands. </p><br><p>  This approach will give a lot of goodies.  Since the state object is only one, and its modification is performed only through commands, it is easy to make a single state update event. </p><br><p>  Then the UI is easy to make reactive.  That is, automatically update the data when updating the state (hello <a href="https://github.com/neuecc/UniRx">UniRx</a> , its application will be discussed in another article). </p><br><p>  With this approach, changing the state of the game can be initiated from the server side.  Also through the team.  Since the update event state is exactly the same, the UI is absolutely violet, where the update came from. </p><br><p>  Another good thing is cool debugging features.  Since View can only give birth to commands, it becomes easier to follow the changes of the state to the steamed turnip. </p><br><p>  Detailed logging, command history, reproduction of bugs, etc., all this becomes possible thanks to this pattern. </p><br><h3>  Implementation </h3><br><p>  For a start, we will define the state of the game.  Let it be the next class: </p><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">System.Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GameState</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> coins; }</code> </pre> <br><p>  Add save game state to JSON file.  To do this, make a separate manager. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGameStateManager</span></span> { GameState GameState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LocalGameStateManager</span></span> : <span class="hljs-title"><span class="hljs-title">IGameStateManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GameState GameState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!File.Exists(GAME_STATE_PATH)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } GameState = JsonUtility.FromJson&lt;GameState&gt;(File.ReadAllText(GAME_STATE_PATH)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { File.WriteAllText(GAME_STATE_PATH, JsonUtility.ToJson(GameState)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GAME_STATE_PATH = Path.Combine(Application.persistentDataPath, <span class="hljs-string"><span class="hljs-string">"gameState.json"</span></span>); }</code> </pre> <br><p>  In the <a href="http://goo.gl/NP9Yfy">previous article,</a> I looked at the problem of dependencies, and talked about the Dependency Injection (DI) pattern.  It's time to use it. </p><br><p>  For Unity3d there is a simple and convenient <a href="https://github.com/modesttree/Zenject">Zenject</a> DI framework.  I will use it.  Installation and configuration are rather trivial, and are described in detail in the documentation.  Therefore, immediately to the point.  Let's declare a binding for IGameStateManager. </p><br><p>  I created my own <code>MonoInstaller</code> instance called <code>BindingsInstaller</code> , according to the documentation, and added it to the scene. </p><br><pre> <code class="hljs ruby">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BindingsInstaller</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MonoInstaller</span></span></span><span class="hljs-class">&lt;BindingsInstaller&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InstallBindings</span></span></span><span class="hljs-class">() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bind</span></span></span><span class="hljs-class">&lt;IGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">To</span></span></span><span class="hljs-class">&lt;LocalGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsSingle</span></span></span><span class="hljs-class">();</span></span> Container.Bind&lt;Loader&gt;().FromNewComponentOnNewGameObject().NonLazy(); }</code> </pre> <br><p>  I also added banding for the Loader component, which will monitor the loading and exit of the game. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Loader</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { [Inject] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IGameStateManager gameStateManager</span></span></span><span class="hljs-function">)</span></span> { _gameStateManager = gameStateManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Loading started"</span></span>); _gameStateManager.Load(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnApplicationQuit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Quitting application"</span></span>); _gameStateManager.Save(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IGameStateManager _gameStateManager; }</code> </pre> <br><p>  Script Loader runs the very first in the game.  I use it as a starting point.  And also as a script that monitors the loading and saving game state. </p><br><p>  Now I am throwing in the simplest View for UI. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoinsView</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Text currencyText; [Inject] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IGameStateManager gameStateManager</span></span></span><span class="hljs-function">)</span></span> { _gameStateManager = gameStateManager; UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _gameStateManager.GameState.coins += Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _gameStateManager.GameState.coins -= Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { currencyText.text = <span class="hljs-string"><span class="hljs-string">"Coins: "</span></span> + _gameStateManager.GameState.coins; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IGameStateManager _gameStateManager; }</code> </pre> <br><p>  Here I added two methods for adding and removing an arbitrary number of coins.  The standard approach that I often see in the code is to push business logic right into the UI. </p><br><p>  So do not do :).  But for now, let's make sure our little prototype works. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/52b/f52/bc3/52bf52bc3387c23f20c89eafa7ce8298.png" alt="UI Screenshot"></p><br><p>  Buttons work, the state is saved and restored at boot. </p><br><p>  Now let's brush our code. </p><br><p>  Let's make a separate type of command that is modified by GameState. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGameStateCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ICommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gameState</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  The common interface is empty to denote a single type of command.  For commands that modify GameState, we denote the Execute method, which accepts a state as a parameter. </p><br><p>  Let's create a service that will run commands that modify the state, like the one I showed before.  The interface is generic to fit any type of command. </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface ICommandsExecutor&lt;TCommand&gt; where TCommand: ICommand { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TCommand command)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameStateCommandsExecutor</span></span></span><span class="hljs-class"> :</span></span> ICommandsExecutor&lt;IGameStateCommand&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameStateCommandsExecutor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IGameStateManager gameStateManager)</span></span></span><span class="hljs-function"> </span></span>{ _gameStateManager = gameStateManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IGameStateCommand command)</span></span></span><span class="hljs-function"> </span></span>{ command.Execute(_gameStateManager.GameState); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly IGameStateManager _gameStateManager; }</code> </pre> <br><p>  We register the manager in DI. </p><br><pre> <code class="hljs ruby">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BindingsInstaller</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MonoInstaller</span></span></span><span class="hljs-class">&lt;BindingsInstaller&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InstallBindings</span></span></span><span class="hljs-class">() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bind</span></span></span><span class="hljs-class">&lt;IGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">To</span></span></span><span class="hljs-class">&lt;LocalGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsSingle</span></span></span><span class="hljs-class">();</span></span> Container.Bind&lt;Loader&gt;().FromNewComponentOnNewGameObject().AsSingle().NonLazy(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> added this line Container.Bind&lt;ICommandsExecutor&lt;IGameStateCommand<span class="hljs-meta"><span class="hljs-meta">&gt;&gt;</span></span>().To&lt;GameStateCommandsExecutor&gt;().AsSingle(); } }</code> </pre> <br><p>  Now let's do the implementation of the command itself. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddCoinsCommand</span></span> : <span class="hljs-title"><span class="hljs-title">IGameStateCommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCoinsCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount</span></span></span><span class="hljs-function">)</span></span> { _amount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gameState</span></span></span><span class="hljs-function">)</span></span> { gameState.coins += _amount; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _amount; }</code> </pre> <br><p>  Change the CoinsView to use commands. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoinsView</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Text currencyText; [Inject] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IGameStateManager gameStateManager, ICommandsExecutor&lt;IGameStateCommand&gt; commandsExecutor</span></span></span><span class="hljs-function">)</span></span> { _gameStateManager = gameStateManager; _commandsExecutor = commandsExecutor; UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddCoinsCommand(Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)); _commandsExecutor.Execute(cmd); UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddCoinsCommand(-Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)); _commandsExecutor.Execute(cmd); UpdateView(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { currencyText.text = <span class="hljs-string"><span class="hljs-string">"Coins: "</span></span> + _gameStateManager.GameState.coins; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IGameStateManager _gameStateManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ICommandsExecutor&lt;IGameStateCommand&gt; _commandsExecutor; }</code> </pre> <br><p>  CoinsView now uses GameState for reading only.  And all changes to the state occur through teams. </p><br><p>  What spoils the picture here is the call to UpdateView manually.  We can forget to call it.  Or the status can be updated by sending a command from another View. </p><br><p>  Add a status update event to <code>ICommandExecutor</code> .  Plus we will make a separate interface-alias for Executor'a game state commands to hide the extra types in the generic. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICommandsExecutor&lt;TState, TCommand&gt; { // added event event <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Action&lt;TState&gt; stateUpdated; <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(TCommand command); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IGameStateCommandsExecutor : ICommandsExecutor&lt;GameState, IGameStateCommand&gt; { }</code> </pre> <br><p>  Update the registration in DI </p><br><pre> <code class="hljs ruby">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BindingsInstaller</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MonoInstaller</span></span></span><span class="hljs-class">&lt;BindingsInstaller&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InstallBindings</span></span></span><span class="hljs-class">() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Container</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bind</span></span></span><span class="hljs-class">&lt;IGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">To</span></span></span><span class="hljs-class">&lt;LocalGameStateManager&gt;().</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsSingle</span></span></span><span class="hljs-class">();</span></span> Container.Bind&lt;Loader&gt;().FromNewComponentOnNewGameObject().AsSingle().NonLazy(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> updated this line Container.Bind&lt;IGameStateCommandsExecutor&gt;() .To&lt;DefaultCommandsExecutor&gt;().AsSingle(); } }</code> </pre> <br><p>  Add an event to <code>DefaultCommandsExecutor</code> . </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DefaultCommandsExecutor : IGameStateCommandsExecutor { // this event added <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> event Action&lt;GameState&gt; stateUpdated { <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> { _stateUpdated += <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>(_gameStateManager.GameState); } } remove { _stateUpdated -= <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DefaultCommandsExecutor(IGameStateManager gameStateManager) { _gameStateManager = gameStateManager; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(IGameStateCommand command) { command.<span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(_gameStateManager.GameState); // these lines added <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stateUpdate != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { _stateUpdated(_gameStateManager.GameState); } } private readonly IGameStateManager _gameStateManager; // this <span class="hljs-type"><span class="hljs-type">line</span></span> added private Action&lt;GameState&gt; _stateUpdated; }</code> </pre> <br><p>  It is worth paying attention to the implementation of the event.  Since the executor fumbles the state only inside the event, it is important to immediately pull it when subscribing. </p><br><p>  Now, finally, update the View. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoinsView</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Text currencyText; [Inject] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IGameStateCommandsExecutor commandsExecutor</span></span></span><span class="hljs-function">)</span></span> { _commandsExecutor = commandsExecutor; _commandsExecutor.stateUpdated += UpdateView; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddCoinsCommand(Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)); _commandsExecutor.Execute(cmd); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveCoins</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddCoinsCommand(-Random.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)); _commandsExecutor.Execute(cmd); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gameState</span></span></span><span class="hljs-function">)</span></span> { currencyText.text = <span class="hljs-string"><span class="hljs-string">"Coins: "</span></span> + gameState.coins; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _commandsExecutor.stateUpdated -= UpdateView; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IGameStateCommandsExecutor _commandsExecutor; }</code> </pre> <br><p>  <code>IGameStateManager</code> is no longer needed for View, since UpdateView takes a GameState as a parameter.  Great, got rid of excess dependence!  UpdateView itself, we subscribe to an event in the <code>IGameStateCommandsExecutor</code> .  It will be called at any state change.  Also, we do not forget to unsubscribe from the event in OnDestroy. </p><br><p>  Here is such an approach.  Pretty clean.  Not intricate.  Now it is impossible to forget to call UpdateView in some place, under some damn condition, which is reproduced only in a certain phase of the moon. </p><br><p>  Well.  Breathed out, and we go on, there are even more buns. </p><br><h2>  Use command history as a time machine for debugging complex logic </h2><br><p>  How do you test bugs?  Run the application, and follow the steps to reproduce the bug.  Often these steps are performed manually, we walk along the UI, poke buttons, everything. </p><br><p>  Nothing, if the bug is simple, or the conditions of the playback of the bug are easy to repeat  But what if the bug is tied to network logic and time.  For example, in the game there is any event going for 10 minutes.  Bug occurs upon completion of the event. </p><br><p>  Each test iteration will take <strong>at least</strong> 10 minutes.  Usually you need several iterations, and between them you need to fix something. </p><br><p>  I will show an interesting technique using the above pattern, which will save you from some headache. </p><br><p>  In the code from the previous paragraph, a bug has clearly crept in.  After all, the number of coins can be negative.  Of course, the case is far from the most difficult, but I hope you have a good imagination. </p><br><p>  Imagine that the logic is complex and time-consuming to reproduce the bug every time.  But here we are, or the tester accidentally stumbled upon it.  What if this bug could be "saved"? </p><br><blockquote>  Now the trick itself: let's keep the state that was at the start of the game, as well as the entire history of the teams performed on it during the game session. </blockquote><p>  This data is enough to reproduce the bug as many times as necessary in a split second.  At the same time, there is even no need to run the UI.  After all, all modifications of the broken state are stored in history.  This is like a small integration test case. </p><br><p>  We proceed to the implementation.  Since this solution assumes a slightly more advanced serialization, such as interface serialization, JsonUtility will not be enough.  Therefore I will put Json.Net for Unity from the asset store. </p><br><p>  First, let's make a debug version of <code>IGameStateManager</code> , which copies the ‚Äúinitial‚Äù state of the game into a separate file.  That is, the condition that was at the time of launching the game. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DebugGameStateManager : LocalGameStateManager { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>() { base.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(); File.WriteAllText(BACKUP_GAMESTATE_PATH, JsonUtility.ToJson(GameState)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveBackupAs(string <span class="hljs-type"><span class="hljs-type">name</span></span>) { File.<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>( <span class="hljs-type"><span class="hljs-type">Path</span></span>.Combine(Application.persistentDataPath, "gameStateBackup.json"), <span class="hljs-type"><span class="hljs-type">Path</span></span>.Combine(Application.persistentDataPath, <span class="hljs-type"><span class="hljs-type">name</span></span> + ".json"), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> RestoreBackupState(string <span class="hljs-type"><span class="hljs-type">name</span></span>) { var <span class="hljs-type"><span class="hljs-type">path</span></span> = <span class="hljs-type"><span class="hljs-type">Path</span></span>.Combine(Application.persistentDataPath, <span class="hljs-type"><span class="hljs-type">name</span></span> + ".json"); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.Log("Restoring state from " + <span class="hljs-type"><span class="hljs-type">path</span></span>); GameState = JsonUtility.FromJson&lt;GameState&gt;(File.ReadAllText(<span class="hljs-type"><span class="hljs-type">path</span></span>)); } private static readonly string BACKUP_GAMESTATE_PATH = <span class="hljs-type"><span class="hljs-type">Path</span></span>.Combine(Application.persistentDataPath, "gameStateBackup.json"); }</code> </pre> <br><p>  Behind the scenes, I left the conversion methods of the parent class to virtual.  I'll leave it to you as an exercise.  In addition, the <code>SaveBackupAs</code> method has been <code>SaveBackupAs</code> , which will be needed later on so that we can save our "snapshots" with a specific name. </p><br><p>  Now we will create a debug version of the executor who is able to keep the history of commands, and generally retains a full cast of the form ‚Äúinitial state + commands‚Äù. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DebugCommandsExecutor</span></span> : <span class="hljs-title"><span class="hljs-title">DefaultCommandsExecutor</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IList&lt;IGameStateCommand&gt; commandsHistory { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _commands; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DebugCommandsExecutor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DebugGameStateManager gameStateManager</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gameStateManager</span></span></span><span class="hljs-function">)</span></span> { _debugGameStateManager = gameStateManager; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveReplay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { _debugGameStateManager.SaveBackupAs(name); File.WriteAllText(GetReplayFile(name), JsonConvert.SerializeObject(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandsHistory { commands = _commands }, _jsonSettings)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadReplay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { _debugGameStateManager.RestoreBackupState(name); _commands = JsonConvert.DeserializeObject&lt;CommandsHistory&gt;( File.ReadAllText(GetReplayFile(name)), _jsonSettings ).commands; _stateUpdated(_gameStateManager.GameState); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Replay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> toIndex</span></span></span><span class="hljs-function">)</span></span> { _debugGameStateManager.RestoreBackupState(name); LoadReplay(name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> history = _commands; _commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IGameStateCommand&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Math.Min(toIndex, history.Count); ++i) { Execute(history[i]); } _commands = history; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetReplayFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Path.Combine(Application.persistentDataPath, name + <span class="hljs-string"><span class="hljs-string">"_commands.json"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IGameStateCommand command</span></span></span><span class="hljs-function">)</span></span> { _commands.Add(command); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Execute(command); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;IGameStateCommand&gt; _commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IGameStateCommand&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CommandsHistory</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;IGameStateCommand&gt; commands; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> JsonSerializerSettings _jsonSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializerSettings() { TypeNameHandling = TypeNameHandling.All }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DebugGameStateManager _debugGameStateManager; }</code> </pre> <br><p>  Here you can see that the standard JsonUtility capabilities would not be enough.  I had to set <code>TypeNameHandling</code> for the serialization settings so that when loading / saving the nugget, the commands are deserialized into typed objects, because the logic is tied to them. </p><br><p>  What else is remarkable about this executor? </p><br><ul><li>  Keeps every team in history. </li><li>  Able to save and restore the history of teams and state games </li><li>  The key Replay method "loses" all teams, starting with the initial state of the game, and up to the team with the specified index </li></ul><br><p>  I would not want a release project to have a history of memory clogging, so I will register this service with DI only if there is a DEBUG define. </p><br><pre> <code class="hljs objectivec">public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BindingsInstaller : MonoInstaller&lt;BindingsInstaller&gt; { public override <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> InstallBindings() { Container.Bind&lt;Loader&gt;().FromNewComponentOnNewGameObject().AsSingle().NonLazy(); <span class="hljs-meta"><span class="hljs-meta">#if DEBUG Container.Bind</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;IGameStateManager&gt;</span></span></span><span class="hljs-meta">().To</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DebugGameStateManager&gt;</span></span></span><span class="hljs-meta">().AsSingle(); Container.Bind</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DebugGameStateManager&gt;</span></span></span><span class="hljs-meta">().AsSingle(); Container.Bind</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;IGameStateCommandsExecutor&gt;</span></span></span><span class="hljs-meta">().To</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DebugCommandsExecutor&gt;</span></span></span><span class="hljs-meta">().AsSingle(); #else Container.Bind</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;IGameStateManager&gt;</span></span></span><span class="hljs-meta">().To</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;LocalGameStateManager&gt;</span></span></span><span class="hljs-meta">().AsSingle(); Container.Bind</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;IGameStateCommandsExecutor&gt;</span></span></span><span class="hljs-meta">().To</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DefaultCommandsExecutor&gt;</span></span></span><span class="hljs-meta">().AsSingle(); #endif } }</span></span></code> </pre> <br><p>  Oh yeah, you need to prepare the command for serialization: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddCoinsCommand</span></span> : <span class="hljs-title"><span class="hljs-title">IGameStateCommand</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCoinsCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount</span></span></span><span class="hljs-function">)</span></span> { _amount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gameState</span></span></span><span class="hljs-function">)</span></span> { gameState.coins += _amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetType().ToString() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + _amount; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _amount; }</code> </pre> <br><p>    JsonProperty,    .     ToString(),      . </p><br><p>    ,    "DEBUG"  Player Settings -&gt; Other Settings -&gt; Scripting define symbols. </p><br><p>      /        Unity.   EditorWindow. </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CommandsHistoryWindow : EditorWindow { [MenuItem("Window/CommandsHistoryWindow")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static CommandsHistoryWindow GetOrCreateWindow() { var <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> = EditorWindow.GetWindow&lt;CommandsHistoryWindow&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.titleContent = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GUIContent("CommandsHistoryWindow"); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> OnGUI() { // this part <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> required <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> // DI context <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the scene var sceneContext = GameObject.FindObjectOfType&lt;SceneContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sceneContext == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || sceneContext.Container == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } // this guard ensures that OnGUI runs <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> IGameStateCommandExecutor <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> other words <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> runtime var executor = sceneContext.Container.TryResolve&lt;IGameStateCommandsExecutor&gt;() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DebugCommandsExecutor; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (executor == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } // general buttons <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> save "snapshot" EditorGUILayout.BeginHorizontal(); _replayName = EditorGUILayout.TextField("Replay name", _replayName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button("Save")) { executor.SaveReplay(_replayName); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button("Load")) { executor.LoadReplay(_replayName); } EditorGUILayout.EndHorizontal(); // <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> the main block which allows us <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> walk through commands step <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> step EditorGUILayout.LabelField("Commands: " + executor.commandsHistory.Count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; executor.commandsHistory.Count; ++i) { var cmd = executor.commandsHistory[i]; EditorGUILayout.BeginHorizontal(); EditorGUILayout.LabelField(cmd.ToString()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUILayout.Button("Step to")) { executor.Replay(_replayName, i + <span class="hljs-number"><span class="hljs-number">1</span></span>); } EditorGUILayout.EndHorizontal(); } } private string _replayName; }</code> </pre> <br><p>   .    ? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/19b/203/72c/19b20372cdbdb02e6480f30d90b7ca0e.gif" alt="Animated GIF of commandHistoryWindow"></p><br><p>     "initial" , ,     . <br>      ,   ,       ,   . </p><br><p>        version1. </p><br><p>     Step to,  ""   ,   . </p><br><p>        .      .    " "   ,        .   ,      "negativeCoins"     save. </p><br><p>        ,     negativeCoins.json  negativeCoins_commands.json,    .         ,     negativeCoins,  Load  .       . </p><br><p>  ,    ,  UI,          .      . </p><br><p>         . ,    "",       ,  ,    . </p><br><p>    ,   . </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AddCoinsCommand : IGameStateCommand { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> AddCoinsCommand(<span class="hljs-type"><span class="hljs-type">int</span></span> amount) { _amount = amount; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(GameState gameState) { gameState.coins += _amount; // this <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the fix <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gameState.coins &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { gameState.coins = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override string ToString() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetType().ToString() + " " + _amount; } [JsonProperty("amount")] private <span class="hljs-type"><span class="hljs-type">int</span></span> _amount; }</code> </pre> <br><p>      <code>version1</code> ,      . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/176/27a/a9a/17627aa9ae7c0fc77eb89cece2df7e1b.gif" alt="GIF of fixed bug replayed with CommandsHistoryWindow"></p><br><p>   ,      .  Victory! </p><br><h2>   </h2><br><p>        Command.        .       ,   . </p><br><p>          : </p><br><ul><li>       </li><li>         </li></ul><br><p>       UI,  Flux,       UI. </p><br><p>    ,    ,  , ,   ,   . </p><br><p>    ,    ,   , , . ,     /.       =). </p><br><p>     .  ,    ,  UI,     ,   . ,        GameStateManager'a,  UI     . </p><br><p>  UI ‚Äî    ,      .  ,    ,      .           . </p><br><p>       <a href="https://github.com/PoisonousJohn/articles/tree/master/Telegram_Posts/decoupling-via-commands/Patterns"></a> . </p><br><p>     ,   =),  . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350630/">https://habr.com/ru/post/350630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350620/index.html">Change of profession: from graphic designer to front-end developer</a></li>
<li><a href="../350622/index.html">Eternally Open Sesame, or Several Loopholes in Your IT Landscape</a></li>
<li><a href="../350624/index.html">Neural network that determines the age of the blood test - the development of scientists of the ITMO University</a></li>
<li><a href="../350626/index.html">Flask Mega-Tutorial, Part XIV: Ajax</a></li>
<li><a href="../350628/index.html">Software Transactional Memory on Free Monads</a></li>
<li><a href="../350632/index.html">Security Week 7: Dating through a coder and spam updates</a></li>
<li><a href="../350636/index.html">Cooking Juniper Network with Ansible</a></li>
<li><a href="../350638/index.html">Hardcore Java / JVM puzzles</a></li>
<li><a href="../350640/index.html">Bathroom mosaic and Diophantine equations</a></li>
<li><a href="../350642/index.html">How I earned $ 200,000 at 16</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>