<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of Losharik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 It was Thursday evening, when spiff and I got the idea to write an OpenSource game on HTML5, which is progressive in our time, as they say,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of Losharik</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/4a0/898/da5/4a0898da515d8125c66ff4d2a83b0c68.png" align="right" alt="image">  It was Thursday evening, when <a href="https://habrahabr.ru/users/spiff/" class="user_link">spiff and I</a> got the idea to write an OpenSource game on HTML5, which is progressive in our time, as they say, from scratch and just for fun. <br><br>  Since we work in the field of system programming and web application development experience, we had very little, it was decided to implement a fairly simple clone of the world famous and popular game for the first Nokia phones - <a href="http://www.youtube.com/watch%3Fv%3D94A4IXIfFjI%26feature%3Drelated">RapidRoll</a> . <br><br>  A week later, we released the first stable <a href="http://losharik.googlecode.com/git-history/stable_1.0/src/index.html">release</a> , and are ready to share the first gained experience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  Step 1. Design Document </h4><br>  Any game that will conquer the world, in our opinion, must begin with a design document.  Usually it consists of the following items: <br><ul><li>  scheme of the game (gameplay, the goal of the game and what prevents it from achieving); </li><li>  interface (basic graphic elements); </li><li>  game mechanics (device of the game world, physics, interaction of objects, etc.); </li><li>  software algorithms (high-level description of the main game algorithms); </li><li>  sounds and music; </li><li>  game world (game characters and their interaction); </li><li>  participants and deadlines; </li></ul><br>  The meaning of the game is to keep Losharik in the visible part of the screen, by moving it along the rising platforms, preventing it from falling or leaving the upper edge of the screen. <br><br>  <a href="https://docs.google.com/document/d/1BC7nEpz5oyTjBO6ZwAVh6MpQn6ZOfWzLJJ8eoyV5nPg/edit">Link to the design document</a> <br><br><h4>  Step 2. Architecture </h4><br>  The architecture of the application is shown in the following diagram: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a0/a00/a3a/7a0a00a3ab19a6b28698a294f1d2ca9e.png" alt="image"><br><br>  As you can see, the diagram resembles the MVC model.  The following main classes are available: <br><ul><li>  Game.  The main class of the game is responsible for the interaction of the other classes; </li><li>  GameModel.  Model of the game, responsible for the formation of game scenes; </li><li>  KeyboardController.  One of the possible controllers for controlling the game from the keyboard; </li><li>  HTML5View.  One of the possible representations of the game.  Renders scenes created by the HTML5 canvas model based on resources. </li><li>  Resources.  Stores game resources such as sounds, sprites, etc. </li></ul><br>  The implementation of the skeleton architecture is presented below: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function">) </span></span>{ view = v; }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> view; }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.moveLeft = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.moveRight = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.next = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// build next/new frame ... view.update(); //update view }; } function HTML5View(canvas) { var model; this.setModel = function(m) { model = m; }; this.getModel = function() { return model; }; var context = canvas.getContext("2d"); this.update = function() { // clear view ... // drawing model to canvas ... }; } function KeyboardController() { var model = null; this.setModel = function(m) { model = m; }; this.getModel = function() { return model; }; this.keydown = function(event) { if (event.keyCode == LEFT_KEY_CODE) { model.moveLeft(); } else if (event.keyCode == RIGHT_KEY_CODE) { model.moveRight(); } }; document.onkeydown = this.keydown; } function Game(model, view, ctrl) { view.setModel(model); ctrl.setModel(model); model.setView(view); this.run = function() { setInterval(model.next, 1000 / DEFAULT_FPS); }; } function main(canvas) { var view = new HTML5View(canvas); var model = new GameModel(); var ctrl = new KeyboardController(); var game = new Game(model, view, ctrl); game.run(); }</span></span></code> </pre> <br><br><h4>  Step 3. First prototype </h4><br>  A day later, the first working prototype was received, measuring 150 lines of HTML5 code. <br><br><img src="http://img220.imageshack.us/img220/6185/losuu.png" alt="image"><br><br>  Algorithms for platform generation, Losharik and world movement were added to the framework code.  And it was already possible to play, although there were problems with physics and testing of hitting the platforms. <br><br>  The main feature of the prototype was the algorithm for generating platforms - new platforms are generated after the destruction of the topmost one and this provides the ability to dynamically change the number of platforms on the screen and the distance between them.  The algorithm code is presented below: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> generatePlatforms = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() <span class="hljs-number"><span class="hljs-number">0.6</span></span>) ? PLATFORM_TYPE.SOLID : PLATFORM_TYPE.KILLER; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseline = pCounter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? platforms[pCounter - <span class="hljs-number"><span class="hljs-number">1</span></span>].y : <span class="hljs-number"><span class="hljs-number">0</span></span>; platforms[pCounter++] = { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (WIDTH - DEFAULT_PLATFORM_WIDTH)), <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(baseline + (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (DEFAULT_MAX_PLATFORM_INTERVAL - DEFAULT_MIN_PLATFORM_INTERVAL + <span class="hljs-number"><span class="hljs-number">1</span></span>)) + DEFAULT_MIN_PLATFORM_INTERVAL), <span class="hljs-attr"><span class="hljs-attr">w</span></span>: DEFAULT_PLATFORM_WIDTH, <span class="hljs-attr"><span class="hljs-attr">h</span></span>: DEFAULT_PLATFORM_HEIGHT, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: type }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (platforms[pCounter - <span class="hljs-number"><span class="hljs-number">1</span></span>].y &lt; (HEIGHT + DEFAULT_PLATFORM_HEIGHT)); };</code> </pre><br><br><h4>  Step 4. Second prototype </h4><br>  In the second prototype, the algorithm for checking platform hit was revised and rewritten to the method of checking the intersection of segments.  First, a new one is built on the basis of the previous Losharik, taking into account the proposed movement in space.  The coordinates of the new, current Losharik and the platform under test are transferred to a function that searches for the intersection points P1 and P2 and returns them true when they are found, taking into account this, the decision is made whether to attach Losharika to the platform or not. <br><br><img src="http://goo.gl/G1GxR" alt="image"><br><br>  Later, the function was optimized and performed only for those platforms that could fall into the intersection. <br><br>  As a result, the following code was born: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isRollCrossPlatform = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">platform, rollPrev, rollNext</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// we should to check only platforms between prev roll and next roll if (platform.y &lt;= rollPrev.y || platform.y &gt; rollNext.y + rollNext.h) return false; var s1 = { x1: platform.x, y1: platform.y, x2: platform.x + platform.w, y2: platform.y }; var s2 = { x1: rollPrev.x, y1: rollPrev.y + rollPrev.h - worldSpeed, x2: rollNext.x, y2: rollNext.y + rollNext.h }; var s3 = { x1: rollPrev.x + rollPrev.w, y1: rollPrev.y + rollPrev.h - worldSpeed, x2: rollNext.x + rollNext.w, y2: rollNext.y + rollNext.h }; var zn1 = (s2.y2 - s2.y1) * (s1.x2 - s1.x1) - (s2.x2 - s2.x1) * (s1.y2 - s1.y1); var zn2 = (s3.y2 - s3.y1) * (s1.x2 - s1.x1) - (s3.x2 - s3.x1) * (s1.y2 - s1.y1); if (Math.abs(zn1) &lt; Math.EPS &amp;&amp; Math.abs(zn2) &lt; Math.EPS) return false; var ch11 = (s2.x2 - s2.x1) * (s1.y1 - s2.y1) - (s2.y2 - s2.y1) * (s1.x1 - s2.x1); var ch21 = (s1.x2 - s1.x1) * (s1.y1 - s2.y1) - (s1.y2 - s1.y1) * (s1.x1 - s2.x1); if ((ch11/zn1 &lt;= 1.0 &amp;&amp; ch11/zn1 &gt;= 0.0) &amp;&amp; (ch21/zn1 &lt;= 1.0 &amp;&amp; ch21/zn1 &gt;= 0.0)) { return true; } var ch12 = (s3.x2 - s3.x1) * (s1.y1 - s3.y1) - (s3.y2 - s3.y1) * (s1.x1 - s3.x1); var ch22 = (s1.x2 - s1.x1) * (s1.y1 - s3.y1) - (s1.y2 - s1.y1) * (s1.x1 - s3.x1); if ((ch12/zn2 &lt;= 1.0 &amp;&amp; ch12/zn2 &gt;= 0.0) &amp;&amp; (ch22/zn2 &lt;= 1.0 &amp;&amp; ch22/zn2 &gt;= 0.0)) { return true; } return false; };</span></span></code> </pre><br><br>  In the second prototype, various types of platforms were added: moving, killing and melting, and the ability to move beyond the side borders of the screen. <br><br><h4>  Step 4. The third prototype </h4><br>  An algorithm was implemented for counting and drawing the number of points that are multiples of the distance traveled in free fall, as well as the counter of lives and the possibility of losing this life. <br><br><img src="http://img827.imageshack.us/img827/3722/los3r.png" alt="image"><br><br><h4>  Step 5. Release! </h4><br>  Almost a week has passed since the beginning of the project and we already had a fully functional working prototype, which until the release had only one class to change - HTML5View and add some additional features: <br><ul><li>  The background of the world is replaced with a full-fledged relief, moving evenly to the platforms; </li><li>  Table of records; </li><li>  ‚ÄúLike‚Äù button for integration with VKontakte; </li><li>  The minimum animation for Losharik in the form of two sprites has been implemented (‚ÄúLoharik moves to the left‚Äù, ‚ÄúLosharik moves to the right‚Äù); </li><li>  Added FPS counter; </li></ul><br>  All drawing graphics in the form of canvas shapes, was replaced by drawing sprites (images). <br><br><pre> <code class="javascript hljs">context.fillRect(x, y, width, height) -&gt; context.drawImage(roll, x, y, width, height)</code> </pre><br><br>  It was decided to receive the FPS counter value on the basis of the last 10 frames and the total time of their drawing.  Ultimately, the counter code looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// draw current fps var fps = (frameCounter / totalTime) * 1000.0; context.fillText(fps.toFixed(2) + " fps", 4, HEIGHT - 6); // calc FPS if (frameCounter &gt; FPS_REFRESH_INTERVAL) { frameCounter = 0; totalTime = 0; } frameCounter++; var currentTime = new Date().getTime(); totalTime += (currentTime - lastTime); lastTime = currentTime;</span></span></code> </pre><br><br>  In addition, in the release, the game physics coefficients ‚Äî gravity, acceleration along X for more confident control ‚Äî were worked out, and difficulty switching points (levels) were changed for a longer game. <br><br><img src="http://img405.imageshack.us/img405/1529/release10.png" alt="image"><br><br><h4>  Statistics </h4><br>  In one week, a working release of Losharik was received, containing 1130 lines of code: <br><ul><li>  163 for PHP for server side; </li><li>  50 on CSS for menus and buttons; </li><li>  71 to HTML5 to display; </li><li>  846 on JS for game engine. </li></ul><br><h4>  Plans for Losharika 2.0 </h4><br><ul><li>  Recognizable logo; </li><li>  New bonuses (parachute, core, body armor, ...); </li><li>  Improved physics and performance; </li><li>  Monsters; </li><li>  New types of platforms (wooden / fragile, ...); </li><li>  Completely redesigned graphics; </li><li>  Sounds (HTML5 audio); </li><li>  Social component (Twitter / FB / Google+); </li><li>  Build for Google web-store (Chrome app); </li><li>  Build for: Andriod app / WAC app / IPhone app (WebGL implementation); </li></ul><br><h4>  Instead of conclusion </h4><br>  We would like to make a small announcement.  As you can see, Loshariku needs a good designer in the team to conquer the world.  If someone has a desire to participate in an interesting OpenSource project and upgrade their skills, you are welcome - you can leave comments or contact <a href="https://habrahabr.ru/users/spiff/" class="user_link">spiff</a> . <br><br>  PS Once again the link to <a href="http://losharik.googlecode.com/git-history/stable_1.0/src/index.html">PLAY!</a> <br>  PPS <a href="http://code.google.com/p/losharik/">Losharik on Googlecode</a> . <br><br>  UPDATE: thanks to the user <a href="https://habrahabr.ru/users/qmax/" class="user_link">qmax</a> for the <a href="http://code.google.com/p/losharik/source/detail%3Fr%3Dd9a5602b96e41feb63096b1ef002fe618cd8e148%26name%3Dstable_1.0">patch</a> that adds the rotation to Losharik! </div><p>Source: <a href="https://habr.com/ru/post/131366/">https://habr.com/ru/post/131366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131357/index.html">Starcraft 2 bot based on interception and analysis rendering</a></li>
<li><a href="../131360/index.html">Codify: native development environment for iPad</a></li>
<li><a href="../131361/index.html">"Oh brave new world" or dreams of EDS-future</a></li>
<li><a href="../131363/index.html">Announcement of the creation of the jQuer Standard Group</a></li>
<li><a href="../131364/index.html">Microsoft for Mac</a></li>
<li><a href="../131367/index.html">Electronic signature of an individual (part 1)</a></li>
<li><a href="../131369/index.html">Design patterns for Android development. Part 1 - Introduction</a></li>
<li><a href="../131370/index.html">Who is stronger - a whale or an elephant?</a></li>
<li><a href="../131371/index.html">Productivity Future Vision (2011)</a></li>
<li><a href="../131372/index.html">How to use C ++ AMP from C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>