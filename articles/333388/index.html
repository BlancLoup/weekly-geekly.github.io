<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of creating a library for group communication of android devices via Wi-Fi Peer-to-Peer connection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 The motive for writing this application was coursework in the discipline "Computer systems and networks". Honestly, this is one of the mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of creating a library for group communication of android devices via Wi-Fi Peer-to-Peer connection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/48f/776/267/48f776267de8f7dbb0a4b5350cc2078e.png" alt="image"><br><h2>  Prehistory </h2><br>  The motive for writing this application was coursework in the discipline "Computer systems and networks".  Honestly, this is one of the most unloved of me in computer technology, and I decided to ‚Äútune‚Äù the course project for my interests, namely, for Android development. <br><br>  It was decided to create a library for connecting Android devices using Wi-Fi Direct technology and transferring data between them (Wi-Fi Peer-to-Peer connection is made using Wi-Fi Direct technology). <br><a name="habracut"></a><br><h2>  Why Wi-Fi Direct? </h2><br>  After approval of the idea of ‚Äã‚Äãlocal connection of devices, the question arose before me: What technology would I use to accomplish this?  The following options were considered: <br><br><ul><li>  Bluetooth </li><li>  Wi-Fi hotspot </li><li>  Wi-Fi Direct or Wi-Fi Peer-to-Peer </li></ul><br><h4>  Bluetooth </h4><br>  The main disadvantages of this approach are the restriction of users in one network and a small radius of action.  I want to create a group of devices that communicate with each other at a distance of at least 10 meters. <br><cut></cut><br><h4>  Wi-Fi hotspot </h4><br>  Creating an access point is not a bad option, but I am confused by the situation with the loss of the main Wi-Fi connection.  I would like users to be on the local network and at the same time have access to the global network, for example, to be connected to their home router. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, using Wi-Fi Hotspot you can achieve maximum data transfer speeds ( <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.pushbullet.android.portal%26hl%3Den">Portal</a> applications, <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.lenovo.anyshare.gps%26hl%3Den">SHAREit</a> ). <br><cut></cut><br><h4>  Wi-Fi Direct or Wi-Fi Peer-to-Peer </h4><br>  This approach solves all the above problems: <br><br><ol><li>  unlimited number of clients (if not, please correct me) </li><li>  long range </li><li>  connecting to devices via Wi-Fi without creating an access point </li><li>  technology supported with API 14 (Android 4.0) </li></ol><br>  But at once a doubt creeps in, saying Wi-Fi Peer-to-Peer, while we are going to create a group with the owner and clients, and all the more so that everyone can communicate with each other.  This is precisely the main reason for writing this article. <br><cut></cut><br><h4>  Wi-Fi Aware </h4><br>  This option is not mentioned in the main list, because  I do not think that he can fully approach the task.  However, Wi-Fi Aware is a relatively young technology for sending messages in a certain range. <br><cut></cut><br><h2>  Let's start with the problems </h2><br>  To be honest, the <a href="https://developer.android.com/guide/topics/connectivity/wifip2p.html">documentation</a> provided by developer.android.com was not easy for me.  And I started looking for samples.  After going through a bunch of material, I came across the most interesting <a href="https://android.googlesource.com/platform/development/%2B/master/samples/WiFiDirectServiceDiscovery/">sample by Google</a> . <br><br>  I never thought that on the official website from Google you can find govnokod, but this is exactly the case.  However, even this should be given its due, since thanks to this resource I realized what I wanted. <br><br>  The sample demonstrates an example of the chat of two devices that found each other in the list, displaying nearby Wi-Fi Direct devices running a chat application.  When you select a partner, ChatActivity opens directly. <br><br>  A very important point is the search for interlocutors: the list will not display such Wi-Fi Direct devices as a TV set or some kind of headset.  Only devices with a chat application are displayed. <br><br>  There was also a problem with testing.  Testing the performance of the application was necessary only on real devices. <br><cut></cut><br><h2>  What has been implemented to demonstrate the performance of the library </h2><br>  The application presents the following functionality: <br><br><ol><li>  choice of role in the process of working with the application (for example, were created "Mafia" and "Peaceful Resident") </li><li>  group creation </li><li>  joining an existing group </li><li>  communication between devices (when the button is pressed, its color changes both in the initiator and in all the others corresponding to the current role (or broadcast)) </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/7ad/877/64d/7ad87764db45bcdb1e0918c3bcb1e538.png" alt="image"><br><cut></cut><br>  Description of screens from left to right: <br><br><ul><li>  start screen with a choice of action and role </li><li>  list of devices that have joined the current owner of the group </li><li>  list of active groups to join </li><li>  application settings (device login, group name, password to join the group) </li><li>  Gaming screen </li></ul><br>  After the user selects which group to join, the group owner receives a message about establishing connection with this device. <br><cut></cut><br><img src="https://habrastorage.org/getpro/habr/post_images/dfc/d58/1e9/dfcd581e99d64191d8f49f3607b20ac0.png" alt="image"><br><cut></cut><br><h2>  The basic concept of the library </h2><br>  The logic is based on the client-server architecture.  The server is the owner of the group, the clients are the connected users. <br><br>  The application has its own Serializer / Deserializer to convert the transmitted data into an array of bytes and vice versa.  The following information is stored in the transmitted data: <br><br><ul><li>  whom to send (mafias, civilians, everyone) </li><li>  what kind of data (for example: changing the button color) </li><li>  the data itself (serialized Object) </li></ul><br>  The first item ‚Äúto whom to send‚Äù is not entirely correct, since  data is sent to all.  First, the server, then the server sends this packet to all clients.  But the client himself decides whether he should process this data or not.  This is done for the simple reason that the server does not know the roles of its clients.  In this way equality was achieved in the group.  The owner differs from all the others only in that he is burdened by the transfer of data to all his clients. <br><cut></cut><br><h2>  Library components </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/4cf/2db/402/4cf2db402cd966c6f7aafd8c81a3b9f1.png" alt="image"><br><cut></cut><br><ul><li>  <i>WifiDirectManager</i> - the main class of the library;  responsible for creating a group, searching for devices, attaching a device to a group or inviting it into it, sending a data packet to all members of a group </li><li>  <i>WifiP2pDeviceObservable</i> - implementation of the Observable pattern;  when finding the Wi-Fi Direct device notifies the observer </li><li>  <i>WifiDirectBroadcastReceiver</i> is engaged in notifying the application about changes to the Wi-Fi Direct connection (for example: whether the connection with another device was successful), Wi-Fi status on the device (for example, disconnecting should be followed by warning the user that the application cannot continue) </li><li>  <i>MessageShaper</i> is responsible for serializing / deserializing transmitted data;  when deserializing, we get an object of type android.os.Message (obj - object, what - for what purpose an object (for example: change the color of the button), arg1 - access type (for mafia, civilians, or broadcast)) </li><li>  <i>Serializer is</i> directly involved in the serialization / deserialization of objects </li><li>  <i>Status</i> - characterizes each device as an owner of a group or a client </li><li>  <i>ChatNeedle</i> stores a socket on which two devices are connected to each other;  processes input / output data streams;  the client has only one ChatNeedle - with the owner, the owner has their number equal to the number of clients </li><li>  <i>Member</i> - a class describing a member of a group (not himself) for further use in a game scenario;  keeps ChatNeedle to connect with this group member </li><li>  <i>MemberList</i> - a class that stores in itself all the devices with which our device is connected;  in the case of the owner of the group - all clients, in the case of the client - the owner </li><li>  <i>GroupOwnerSocketHandler</i> is used by the group owner to open a certain number of sockets to which clients connect. </li><li>  <i>ClientSocketHandler is</i> used to establish a connection between the client and the group owner. </li></ul><br><h2>  The most difficult problem during development </h2><br>  When the project reached the stage of testing multiplayer (&gt; 2 devices), then the heat started.  Two devices, as before, were connected without problems (for which, by the way, Wi-Fi Peer-to-Peer was created), but when the third link was connected, almost always trash occurred.  When you press the button at the "owner" (later you will understand why in quotes) the color changed only for the client with whom the "owner" last communicated. <br><br>  After long and hard hours of thinking, I decided to connect the devices via the Wi-Fi Direct option in the Wi-Fi settings of each, and noticed a thing that turned my mind and added just one line to the code of the method to establish the connection. <br><br>  Before that, I believed that the device that connects to another one will always be a client ... and this is far from the case.  When devices were connected, the owner's rights were randomly transferred to one of them, which prompted me to search for a config setting that would correct this situation and make the device to be connected as a client. <br><br>  When two devices are connected, a special config is written, which contains: <br><br><ul><li>  the address of the device we want to join </li><li>  wps.setup allows you to set how we will connect: with a password or just by pressing a button </li><li>  groupOwnerIntent - here he (caught!), the one who solved my problem;  an integer field whose value varies from 0 to 15 (0 - we want to be a client, 15 - we want to be an owner);  the default is -1, which gives the system the right to choose the role in this connection </li></ul><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WifiP2pConfig config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiP2pConfig(); config.deviceAddress = deviceAddress; config.wps.setup = WpsInfo.PBC; config.groupOwnerIntent = status.getIntent(); mWifiP2pManager.connect(mWifiP2pManagerChannel, config, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>);</code> </pre> <br>  The status (enum) above is the current position of the device, if it is the creator of the group - GroupOwner, otherwise - Client. <br><cut></cut><br><h2>  Necessary improvements </h2><br>  So far there is no solution to the problem of reconnecting.  For example, when you exit the application, for example, to make a call after waiting for us waiting ... nothing.  After the destruction of activity, it is necessary again to pull customers to themselves, and to customers - the owner. <br>  I would also like to introduce the concept of transferring the owner‚Äôs rights to one of the clients in case the group owner needs to leave the game. <br><br>  Protection.  To enter a specific group, it would be nice to implement authorization. <br><cut></cut><br><h2>  Conclusion </h2><br>  I don‚Äôt think that I implemented something new or revolutionary, but this project served as a good example of the unusual use of Wi-Fi Peer-to-Peer connections.  I have successfully built a network between devices using Wi-Fi Direct, which allowed us to communicate seamlessly between them. <br><br>  This is my first article, so judge strictly.  Thanks for attention. <br><br>  ‚Üí <a href="https://github.com/chelsenok/WiFi-Direct-Game">Link to GitHub</a> <br>  (wifidirect module can be easily transferred to any android project) </div><p>Source: <a href="https://habr.com/ru/post/333388/">https://habr.com/ru/post/333388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333378/index.html">IBM and the US Air Force are developing a new generation neuromorphous supercomputer</a></li>
<li><a href="../333380/index.html">AWS DeepLearning AMI - why (and how) is it worth using</a></li>
<li><a href="../333382/index.html">Non-productive training of a single-layer perceptron. Classification task</a></li>
<li><a href="../333384/index.html">How large companies monitor employees</a></li>
<li><a href="../333386/index.html">LibGDX + Scene2d (we program on Kotlin). Part 2</a></li>
<li><a href="../333390/index.html">Programming Contest: JSDash (Intermediate Results)</a></li>
<li><a href="../333392/index.html">Yandex shares soared after the deal with Uber</a></li>
<li><a href="../333396/index.html">PHP Reflection on closures</a></li>
<li><a href="../333398/index.html">Talk about Yii 2</a></li>
<li><a href="../333400/index.html">We make a website for virtual reality. We build the monitor into the monitor and reflect on the future</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>