<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Digital filtering on FPGA - Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I have long wanted to start a series of articles on digital signal processing on FPGAs, but for various reasons I could not get down to this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Digital filtering on FPGA - Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I have long wanted to start a series of articles on digital signal processing on FPGAs, but for various reasons I could not get down to this.  Fortunately, there is some free time available, so from time to time I will publish materials that reflect various aspects related to DSP on the FPGA. <br><img src="https://habrastorage.org/files/0af/fff/e14/0affffe14bba4f85a86dbc293b92f198.png"><br><br>  In these articles I will try to minimize the theoretical description of various algorithms and devote most of the material to the practical subtleties that I personally and my colleagues and acquaintances faced, one way or another connected with the development of FPGAs.  I hope this series of articles will benefit both novice engineers and experienced developers. <br><a name="habracut"></a><br><h4>  Part 1: CIC Filter </h4><br>  In the first part, we consider the simplest <b>CIC filter</b> .  CIC - ‚Äúcascaded integral-comb‚Äù, in Russian - cascade integral-comb filter type IIR (with infinite impulse response).  The class of such filters is widely used in tasks where work at several data transfer speeds is required.  CIC filters are actively used for decimation and interpolation, that is, to reduce and increase the sampling rate.  The CIC filter itself is nothing but a low pass filter (LPF).  That is, such a filter passes the lower frequencies of the spectrum, chopping off the upper ones after the cutoff frequency.  The frequency response of the filter is based on the law <b>~ sin (x) / x</b> .  The main advantage of CIC filters is that they do not require multiplication operations at all (unlike other types of filters, for example, FIR). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  <b>Introduction</b> </h6><br>  From the name you can guess that the base CIC filter is based on two basic blocks: an integrator and a comb filter (differentiator).  <b>The integrator</b> (int) is a simple first-order IIR filter, made as the simplest battery.  <b>A comb filter</b> is a first-order FIR filter. <br><br>  Between the integrator and the comb filter, a node is often placed to increase or decrease the sampling frequency by an integer number of times - <b>R.</b> <br><ul><li>  In the case of lowering the sampling frequency, each R count is selected from the input sequence, forming a thinned output sequence. </li><li>  In the case of an increase in the sampling frequency between the samples of the input sequence, zeroes are simply inserted, which are then smoothed in the integrating section, forming a sequence at an increased sampling rate. </li></ul><br>  Formulas for the transfer and amplitude-frequency characteristics are given below: <br><img src="https://habrastorage.org/files/b03/8be/756/b038be7562e147b6832c13932907bd0a.png"><br>  In more detail, with all the mathematical calculations about all aspects of decimation and interpolation, you can read in other sources, to which at the end of the article I will give links. <br><br><h6>  <b>Decimator</b> </h6><br>  If a CIC filter is used to lower the sampling rate, then it is called a decimator.  In this case, the integrator is the first link, then the sampling rate decreases and, finally, the differentiating filter link goes. <br><img src="https://habrastorage.org/files/5ff/5da/1f2/5ff5da1f2a8745f08f13f5151ab713f3.png"><br><br><h6>  <b>Interpolator</b> </h6><br>  If a CIC filter is used to increase the sampling rate, then it is called an interpolator.  In this case, the differentiating link is in the first place, then the sampling rate is increased and, finally, the link of the integrating filter comes. <br><img src="https://habrastorage.org/files/6ca/dee/ce1/6cadeece162940d585401ec6314fbf12.png"><br><br>  Depending on the delay of the input signal in the differentiating link, you can get different frequency characteristics of the filter.  It is known that with an increase in the delay parameter <b>D</b> , the number of ‚Äúzeros‚Äù of the amplitude-frequency characteristic (AFC) of the filter increases. <br><br>  Note that for the integrator and comb filter (CIC filter), as the parameter D in the differentiating section increases, the frequency response zeros are shifted to the center ‚Äî the cutoff frequency of the filter changes to <b>Fc = 2 pi / D.</b> <br><br>  The cascade connection of the integrator and the comb filter without decimation and interpolation operations is called a ‚Äúmoving average‚Äù filter.  The level of the first side lobe of such a filter is only -13 dB, which is small enough for serious DSP tasks. <br>  Due to the linearity of mathematical operations occurring in the CIC filter, it is possible to cascade several filters in a row.  This gives a proportional decrease in side-lobe level, but also increases the collapse of the main lobe of the spectrum (by spectrum I will often understand the frequency response of the filter).  Thus, when the <b>N-</b> cascade connection of the same type of CIC filters is the multiplication of identical transfer characteristics.  As a rule, sections of integrators and comb filters are combined together by type.  For example, first sequentially put N sections of the same type of integrators, then N sections of the same type of differentiating filters. <br><br>  The following figure shows the frequency response of the filter with different parameters of the sampling coefficient R (the calculation was made in MathCAD 14). <br><img src="https://habrastorage.org/files/5c7/d32/52d/5c7d3252dd0c48d1865fa1c39ed16540.png"><br>  The frequency response of the CIC filter is fully equivalent to the frequency response of the FIR filter with a rectangular impulse response (IH).  The total IM filter is defined as the convolution of all the impulse characteristics of the integrator and comb filter cascades.  With increasing order of the CIC filter, its IM integrates the corresponding number of times.  Thus, for the CIC filter of the first order, the EM is a rectangle, for the filter of the second order the EM is an isosceles triangle, for the third order the EM is a parabola, etc. <br><br><h6>  <b>The increase in data width</b> </h6><br>  Unfortunately, an increase in the delay value D in the comb structure and an increase in the order of the filter N lead to an increase in the transmission coefficient.  This in turn leads to an increase in the bit width at the output of the filter.  In DSP tasks where CIC filters are applied, one should always remember this and make sure that the transmitted signals do not go beyond the bit grid used.  For example, the negative effect of the increase in the digit capacity is manifested in a significant increase in the used resources of the FPGA crystal. <br><br>  <i>Interpolator: the</i> use of limited precision does not affect the internal digit capacity of registers, only the last output stage is scaled.  A significant increase in data width occurs in integrator sections. <br><img src="https://habrastorage.org/files/e0c/485/0ee/e0c4850eebb94cc1887d05bf375d741b.png"><br>  <i>Decimator: The</i> CIC filter decimator is very sensitive to the parameters D, R, and N, on which the capacity of the intermediate and output data depends.  Both the differentiator and the integrator affect the final bit depth of the output signal. <br><img src="https://habrastorage.org/files/c24/8d1/c82/c248d1c82dc242dd8e35250326fe1889.png"><br>  In these formulas: <b>B</b> is the input data width, <b>Bmax</b> is the output data width, <b>R</b> is the sampling rate, <b>D</b> is the delay parameter, <b>N</b> is the filter order (number of stages). <br><br>  <i>Comment!</i>  The Hogenauer article describes the principles for choosing the width for each decimator cascade.  When implementing their filters, Xilinx and Altera take into account the negative effect of the increase in the filter capacity and are struggling with this phenomenon using the methods described in the article. <br><br><h6>  <b>Xilinx CIC Filter</b> </h6><br>  Since I have 99% of my work related to Xilinx chips, I will give a description of the IP filter core for this vendor.  But I dare to assure you that for Altera everything is almost the same. <br>  In order to create a CIC filter, you need to go into the <b>CORE Generator</b> application and create a new project in which you specify the type of FPGA chip used and various other non-essential settings in this case. <br><br>  <b>CIC Compiler - Tab 1:</b> <br><img src="https://habrastorage.org/files/7ba/148/eb0/7ba148eb07724be88aa04cb2a5a0e3aa.png"><br><br>  <b>Component name is the</b> name of the component (the Latin letters az, the numbers 0-9, and the symbol "_" are used). <br><br>  <b>Filter Specification:</b> <br><ul><li>  <b>Filter type</b> - filter type: interpolating / decimator. </li><li>  <b>Number of stages</b> - the number of cascades of integrators and comb filters: 3-6. </li><li>  <b>Differential delay</b> - delay in differential filter cells: 1-2. </li><li>  <b>Number of channels</b> - the number of independent channels: 1-16. </li></ul><br>  <b>Sample Rate Change Specification:</b> <br><ul><li>  <b>Fixed / Programmable</b> - type of discretization R: constant / programmable. </li><li>  <b>Fixed or Initial Rate</b> - the value of the sampling rate R: 4..8192. </li><li>  <b>Minimum Rate</b> - the minimum value of the sampling rate R: 4..8. </li><li>  <b>Maximum Rate</b> - the maximum value of the sampling rate R: 8..8192. </li></ul><br>  <b>Hardware Oversampling Specification:</b> these parameters affect the output sampling rate, the number of ticks required for data processing.  The level of parallelism inside the kernel and the amount of resources occupied also depend on these parameters. <br><ul><li>  <b>Select format</b> ‚Äî select the frequency ratio of the filter: Frequency Specification / Sample period. </li><li>  <b>Frequency Specification</b> - Frequency specification: the user sets the sampling rate and the frequency of data processing. </li><li>  <b>Sample period</b> - Clock specification: the user sets the ratio of the processing frequency to the clock frequency of the data. </li><li>  <b>Input Sampling Frequency</b> - input sampling rate: <b>*</b> . </li><li> <b>Clock frequency</b> - filter processing frequency: <b>*</b> . </li><li>  <b>Input Sampling period</b> - the ratio of the processing frequency to the frequency of the input clock signal: <b>*</b> . </li></ul><br>  <b>*</b> - the range depends on the general settings and the sampling rate R. <br><br>  <b>CIC Compiler - Tab 2:</b> <br><img src="https://habrastorage.org/files/b27/31b/787/b2731b78729b4391afafbefea66142f8.png"><br><br>  <b>Numerical Precision:</b> <br><ul><li>  <b>Input Data Width</b> - input data width: 2..20. </li><li>  <b>Quantization</b> - output rounding: full accuracy / rounding of the discharge grid. </li><li>  <b>Output Data Width</b> - the width of the output data, the range depends on the coefficients of N, D and R (the maximum value - 48 bits). </li></ul><br>  <b>Optional:</b> <br><ul><li>  <b>Use Xtreme DSP Slice</b> - use embedded DSP blocks to implement the filter. </li><li>  <b>Use Streaming Interface</b> - use streaming interface for multichannel filter implementation. </li></ul><br>  <b>Control Options:</b> <br><ul><li>  <b>ND</b> - ‚ÄúNew data‚Äù, the input signal that determines the flow of data to the input of the filter. </li><li>  <b>SCLR</b> - synchronous filter reset (a logical unit at this input resets). </li><li>  <b>CE</b> - ‚ÄúClock Enable‚Äù, filter enable signal. </li></ul><br>  <b>CIC Compiler - Tab 3:</b> <br><img src="https://habrastorage.org/files/efd/d02/dc6/efdd02dc654e429b9916e6731b786a31.png"><br><br>  <b>Summary</b> - this tab in the form of a list reflects the final settings of the filter (the number of stages, the frequency parameters, the width of the input, output and intermediate data, the delay in the filter, etc.). <br><br>  On the left side of the CIC Compiler window there are three useful additional tabs: <br><ul><li>  <b>IP-symbol</b> - a schematic view of an IP block with active I / O ports. </li><li>  <b>Freq.</b>  <b>response</b> is the transfer characteristic of the CIC filter. </li><li>  <b>Resource estimate</b> - estimated resources occupied. </li></ul><br>  After setting all the settings you need to click on the <b>Generate</b> button.  As a result, after some time, the CORE Generator application will generate a whole set of files, of which we need the most basic ones: <br><ul><li>  <b>* .VHD</b> (or <b>* .V</b> ) - source file for modeling on VHDL or Verilog. </li><li>  <b>* .VHO</b> - useless file, but from it you can take a description of the component and porting to insert into the project. </li><li>  <b>* .NGC</b> - <b>netlist</b> file.  It contains a description of the architecture of the IP core (used components and signal connections between them) for the selected FPGA chip. </li><li>  <b>* .XCO</b> is a log file in which all parameters and settings of the IP core are stored.  Useful file when working in <b>Xilinx ISE Design Suite</b> . </li></ul><br>  If you work in the ISE Design Suite environment, the CORE Generator will automatically create the necessary files in the working directory.  For other development tools (such as Modelsim or Aldec Active-HDL), you need to transfer the necessary files to the appropriate working directory. <br><br><h6>  <b>CIC Filter in MATLAB</b> </h6><br>  <b>Example 1:</b> For simulation, a very convenient tool is the MATLAB program.  For example, take the 4-order CIC filter model, made on logical elements from Xilinx System Generator Toolbox.  Decimation and interpolation are not used (CIC degenerates into a moving average filter with a window of 16).  Filter parameters: R = 1, N = 4, D = 16. The following figure shows the model of a single cascade in MATLAB. <br><img src="https://habrastorage.org/files/392/e48/414/392e484144644ae59a9f2dcc56972d49.png"><br><br>  Let's see what the impulse response looks like after each filter cascade. To do this, we apply a periodic single impulse to the system input. <br><img src="https://habrastorage.org/files/acd/937/5ef/acd9375ef62043be92044b69ac5a8a40.png"><br><br>  It can be seen that the signal at the output of the first link forms a rectangular pulse of duration = D, at the output of the second link a triangular signal of duration 2D, at the output of the third link a parabolic pulse, at the output of the third a cubic parabola.  The result is completely consistent with the theory. <br><br>  <b>Example 2:</b> Directly the IP core of the CIC filter.  Parameters: N = 3, R = 4, D = 1. The following figure shows the filter model. <br><img src="https://habrastorage.org/files/00d/c48/1a5/00dc481a5dd94a25839fb39eaefaac05.png"><br><br>  If a single pulse with a duration of several cycles (for example, 32) is applied to the input of such a filter, then a parabolic-shaped signal is generated at the output, resembling a third-order moving average filter. <br><img src="https://habrastorage.org/files/961/adb/b00/961adbb00bb640fcbf0d45151c96a11c.png"><br><br>  <b>Summary</b> <br><br>  On this I would like to summarize.  CIC filters are used in many tasks where you need to change the sampling rate.  CIC filters are used in systems operating at several sampling rates (multirate processing), for example, in audio technology to change the bit rate (from 44.1 kHz to 48 kHz and vice versa).  CIC filters are used in communication systems to implement DDC (digital down converter) and DUC (digital up converters).  An example of using CIC filters: the <a href="http://www.analog.com/media/en/technical-documentation/data-sheets/AD6620.pdf">AD6620 digital reception microcircuit</a> from Analog Devices. <br><br>  Implementing your own FPGA filter in HDL languages ‚Äã‚Äãis often not required, and you can safely use ready-made kernels from vendors, or ready-made opensource projects.  If you still need to implement your own CIC filter for an application, then you need to remember the following principles. <br><br>  <b>CIC filters have several features:</b> <br><ol><li>  Simple to implement and do not require multiplication. </li><li>  Decimation and interpolation on CIC filters is used everywhere to quickly change the sampling rate, both integer and fractional number of times. </li><li>  With increasing order of the filter N and the magnitude of the delay D, the bit depth of the intermediate and output data increases. </li><li>  With increasing order of the N filter, side lobe suppression increases and the main lobe of the frequency response increases. </li><li>  It is recommended to use filters of the order of no more than 6-8, since  with an increase in the order, the implementation becomes more complicated, the volume of occupied resources increases, and distortion of the frequency response of the filter within the passband occurs. </li><li>  As the delay parameter D of the comb filter increases, the cutoff frequency of the filter changes, but for practical purposes, if the connection is cascaded, the parameter D &lt;3. </li><li>  When decimation R times significantly increases the bit at the output of the filter. </li><li>  During interpolation, only integrating links make the main contribution to the bit depth of intermediate and output data. </li><li>  The frequency response of the CIC filter is equivalent to the frequency response of the FIR filter with a rectangular impulse response.  The total IM filter is defined as the convolution of all the impulse characteristics of the integrator and comb filter cascades. </li><li>  When the frequency at the output of the filter in the FPGA is changed, the enable signal ‚Äúclock enable‚Äù is used, and the processing frequency is not changed. </li><li>  If the ratio "processing frequency / sampling frequency" &gt;&gt; 1, in the FPGA it is possible to reuse filter resources, thereby implementing processing with a minimum expenditure of crystal resources for a multi-channel system. </li><li>  In modern CIC FPGAs, filters are implemented on DSP blocks (Xilinx, Altera), but in the absence of free resources, implementation on logical cells (SLICEs) is possible. </li><li>  After the CIC filter, it is recommended to set a multiplier with a programmable gain (gain multiplier), which will adjust the signal level to the desired dynamic range. </li><li>  CIC filters introduce distortion into the spectrum of the output signal, so after the CIC filter it is necessary to put a compensating FIR filter (the calculation method is presented in the Altera datasheet, MATLAB is required for the calculation). </li></ol><br>  <b>Literature</b> <br><ul><li>  <a href="http://www.amazon.com/Digital-Signal-Processing-Practical-Approach/dp/0201596199">E. Ifeachor, B. Jervis.</a>  <a href="http://www.amazon.com/Digital-Signal-Processing-Practical-Approach/dp/0201596199">Digitaal Signprocessing: A Practical Approach (2nd Edition).</a> </li><li>  <a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp%3Freload%3Dtrue%26arnumber%3D1163535">Hogenauer, E. An economical class of digital filters for decimation and interpolation.</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Cascaded_integrator%25E2%2580%2593comb_filter">Wikipedia CIC filter</a> </li><li>  <a href="https://www.altera.com/en_US/pdfs/literature/ug/ug_cic.pdf">Altera CIC Filter Userguide</a> </li><li>  <a href="http://www.xilinx.com/support/documentation/ip_documentation/cic_compiler_ds613.pdf">Xilinx CIC Compiler DS613</a> </li><li>  <a href="http://www.mathworks.com/help/dsp/ref/mfilt.cicdecim.html">MATLAB CIC Filter</a> </li><li>  <a href="http://www.dsplib.ru/content/cic/cic.html">DSPLIB - CIC filters</a> </li><li>  <a href="http://www.dsplib.ru/content/cicid/cicid.html">DSPLIB - CIC decimator and interpolator</a> </li><li>  <a href="http://old.myhdl.org/doku.php/projects:gcicexample">Source codes on Verilog with explanations</a> </li><li>  <a href="http://opencores.org/project,cic_core">OpenCores project 1. The author‚Äôs last name is very interesting :)</a> </li><li>  <a href="http://opencores.org/project,cic">OpenCores project 2</a> </li></ul><br>  <i>To be continued...</i> </div><p>Source: <a href="https://habr.com/ru/post/274845/">https://habr.com/ru/post/274845/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274837/index.html">Installing Quartus II Web Edition for Linux</a></li>
<li><a href="../274839/index.html">MIPSfpga: outside of canon</a></li>
<li><a href="../27484/index.html">Remote restart of the hung Win server.</a></li>
<li><a href="../274841/index.html">Minesweeper on FPGA</a></li>
<li><a href="../274843/index.html">‚ÄúStupid‚Äù watches on FPGA</a></li>
<li><a href="../274847/index.html">Digital filtering on FPGA - Part 2</a></li>
<li><a href="../274849/index.html">How we started production, or my software development experience for a Siemens Simatic PLC</a></li>
<li><a href="../27485/index.html">Printable version: HTML vs CSS vs JavaScript</a></li>
<li><a href="../274851/index.html">Mikhail Romanovich Shura-Bura - the patriarch of domestic programming and its development</a></li>
<li><a href="../274853/index.html">Community DevCamp reports are available.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>