<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Old technology in a new way. FreeBSD Jails + CBSD Project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 About 9 years ago, when the first unlimited tariffs appeared in my city (something like 128 kbit / s for 500 rubles), I decided to keep my ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Old technology in a new way. FreeBSD Jails + CBSD Project</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  About 9 years ago, when the first unlimited tariffs appeared in my city (something like 128 kbit / s for 500 rubles), I decided to keep my own ‚Äúserver‚Äù in the apartment for solving various tasks.  One of the first ideas was raising a mirror for the FreeBSD.org project.  It worked for about 2 years.  Then there was no point in it, due to the expansion of channels and other reasons. <br><br>  In addition, the server assumed other tasks for different periods of time: <br><br><ul><li>  Storage backup copies of data, documents and distributions; </li><li>  Download torrents; </li><li>  Distribution of torrents for DLNA and SMB to various devices; </li><li>  VPN client to the provider (there was even a period when the server kept two PPTP connections via MPD - for local traffic and slow no-limit); </li><li>  VPN server and connection to the office gateway (channel to work); </li><li>  Asterisk server for IP-telephony (later in the house there were all sorts of SPA-3112, radio-tubes, etc.); </li><li>  FTP service for receiving data from an IP camera, for dumping backups from Mikrotik-s scripts; </li><li>  Etc.  etc. </li></ul><br>  The general idea - in the hands was a designer with a bunch of multi-colored parts and a great desire to fasten something else.  In general, this is the usual situation for most system administrators who know and love * nix-systems. <br><a name="habracut"></a><br><h3>  operating system </h3><br>  As an operating system, for the first 4-5 years I had FreeBSD.  At a certain point, when I changed jobs and began to sink into Microsoft technologies, I had absolutely no time to work on my home server.  I also remember that I was really sick of wasting time on portupgrade.  Maybe there were other reasons, I do not remember exactly.  But the result was a move to Debian (half a day) and the server was abandoned for a long time (used, but not modified - only occasionally updated). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And just recently, on the January holidays, another return to the sources took place - the server was reinstalled again - already on FreeBSD 11. And the reason for that is my acquaintance and admiration for the <a href="https://www.bsdstore.ru/ru/about.html">CBSD</a> project. <br><br><h3>  Reasons to love the CBSD project </h3><br>  To do this, you need to recall the reasons why I left FreeBSD about 5 years ago - the lack of free time, the outdated system for installing binary packages (pkg_ *), and the inconvenient control of Jails.  It's hard to say exactly why I switched from FreeBSD to Linux then.  But what I'm sure of right now - using the CBSD project with FreeBSD on my server allows me to finally combine both convenience and security. <br><br>  All my previous installations were tuned by the principle - all the eggs in one basket.  The compromise of one service automatically meant the compromise of all.  With the arrival of CBSD on my server, I took it as a rule to place each service in my cell, limiting the interaction and leaving only the most necessary minimum. <br><br>  So - my reasons: <br><br><ul><li>  Easy installation (install the cbsd package, run the initial wizard and answer typical questions - these are 2 minutes); </li><li>  The speed of creating new cells (1 minute is spent on having executed just one command to get a new cell, with a dedicated IP address, assigned quotas, placed in its FS on ZFS and with an already initialized pkgng, which will work); </li><li>  The ease of transferring cells with all the settings between servers (this is very convenient and important - since I currently have 5 FreeBSD-based servers (at home, for parents, mother-in-law, a couple at work) - and it‚Äôs enough for me to make and configure the cell only once - and in the future I can transfer it anywhere via export / import or clone / migrate; </li><li>  Safety and convenience.  Usually poorly compatible things.  But - here it seems it was possible to combine: </li></ul><br><ol><li>  You can make cells with Read-Only root system.  What complicates the introduction of RootKit-tools into the cell (replacing the basic utilities); </li><li>  Just to limit the interaction of the cell with other cells and with the Internet - PF / IPFW control is integrated into CBSD; </li><li>  Due to the simplicity and speed of creating new environments, there is no temptation to put new software into the base system (laziness ... laziness); </li><li>  Cells simply reserve export / import - it means that you can make copies more often and on schedule; </li><li>  Cells are simply updated by controlling them from the main system (update the world and update installed software).  You do not need to raise the SSH service and configure Ansible and others like it; </li><li>  Content Security.  CBSD has a built-in ability to place content and Jail itself in different places.  And when starting the cell, mount the content directory in Jail to the specified directory via mount_nullfs.  And it is possible in the mode Read-Write, and it is possible in Read-Only.  This is very convenient - because it allows, for example, to write a script that stops the cell, produces backup (export), and starts the cell again.  As a result, the archive will contain only software and settings (200-300 MB in compressed form), and the content will be separate and will not be exported (for example, I have 1TB torrents).  Similarly with ownCloud.  Samba servers.  Etc. </li></ol><br><h3>  Finally pkgng </h3><br>  I want to say a special thank you to the creators of pkgng.  Without the development of a modern batch (binary) management system, the CBSD project would not be as convenient as it is now. <br><br>  The emergence of pkgng is a reason ‚Äúalmost completely‚Äù to abandon / usr / ports - or rather, to consider it as an addition to pkg.  I use the following principles: <br><br>  1. I install all possible software via pkg.  At the same time, I get updates from the latest branch (editing the /etc/pkg/FreeBSD.conf file); <br>  2. If I understand (pkg info) that some software is collected in the pkg repository with flags that do not suit me, I mount / usr / ports inside the cell (and not with my hands, but through the CBSD framework - cbsd jset mode = quiet jname = dokuwiki mount_ports = "1"), and collect this software from the ports with the necessary USE flags; <br>  3. With the help of pkg lock, this software, assembled with unique options, is closed from further automatic updating via pkg upgrade; <br><br>  The result is that on any number of cells I can update 99% of the programs with one script and with a probability of 99% I will not break the services at the same time.  Alas - 1% always remains.  BUT - there are automated backups of cells.  And also there is a directory with a cache of previous installed packages.  Therefore, there are two options for rollback (roll back the package or roll back the entire cell).  Let me remind you - I have one cell - one service / service. <br><br><h3>  Examples of scripts and settings written during the study of CBSD: </h3><br><div class="spoiler">  <b class="spoiler_title">We test the presence of vulnerable software in the cells:</b> <div class="spoiler_text">  #! / bin / sh <br><br>  echo "Checking local SYSTEM" <br>  pkg audit -F <br>  echo "" <br>  echo "Checking DokuWiki JAIL" <br>  / usr / local / bin / cbsd jexec jname = dokuwiki pkg audit -F <br>  echo "" <br>  echo "Checking OwnCloud JAIL" <br>  / usr / local / bin / cbsd jexec jname = owncloud pkg audit -F <br>  echo "" <br>  echo "Checking FTP Backup JAIL" <br>  / usr / local / bin / cbsd jexec jname = ftpbackup pkg audit -F <br>  echo "" <br>  echo "Checking SAMBA JAIL" <br>  / usr / local / bin / cbsd jexec jname = samba pkg audit ‚ÄìF <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script output after launch:</b> <div class="spoiler_text">  Checking local SYSTEM <br>  vulnxml file up-to-date <br>  0 problem (s) in the installed packages found. <br><br>  Checking DokuWiki JAIL <br>  vulnxml file up-to-date <br>  0 problem (s) in the installed packages found. <br><br>  Checking OwnCloud JAIL <br>  vulnxml file up-to-date <br>  0 problem (s) in the installed packages found. <br><br>  Checking FTP Backup JAIL <br>  vulnxml file up-to-date <br>  0 problem (s) in the installed packages found. <br><br>  Checking SAMBA JAIL <br>  vulnxml file up-to-date <br>  0 problem (s) in the installed packages found. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">We list the packages available for updating:</b> <div class="spoiler_text">  #! / bin / sh <br><br>  echo "Checking local SYSTEM" <br>  pkg upgrade -n <br>  echo "" <br>  echo "Checking DokuWiki JAIL" <br>  / usr / local / bin / cbsd jexec jname = dokuwiki pkg upgrade -n <br>  echo "" <br>  echo "Checking OwnCloud JAIL" <br>  / usr / local / bin / cbsd jexec jname = owncloud pkg upgrade -n <br>  echo "" <br>  echo "Checking FTP Backup JAIL" <br>  / usr / local / bin / cbsd jexec jname = ftpbackup pkg upgrade -n <br>  echo "" <br>  echo "Checking SAMBA JAIL" <br>  / usr / local / bin / cbsd jexec jname = samba pkg upgrade ‚Äìn <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Running both previous scripts and sending to the mail on schedule:</b> <div class="spoiler_text">  #! / bin / sh <br><br>  sleep 1 <br>  echo "To: vershinin.e@gmail.com"&gt; /root/Scripts/audit-pkg.mail <br>  echo "Subject: Audit PKG on MAIN and JAILed systems !!!" &gt;&gt; /root/Scripts/audit-pkg.mail <br>  echo "" &gt;&gt; /root/Scripts/audit-pkg.mail <br>  echo "" &gt;&gt; /root/Scripts/audit-pkg.mail <br>  sleep 1 <br>  `/root/Scripts/pkg-audit-all-sys.sh &gt;&gt; / root / Scripts / audit-pkg.mail` <br>  sleep 1 <br>  `/root/Scripts/pkg-upgrade-all-sys.sh &gt;&gt; / root / Scripts / audit-pkg.mail` <br>  sleep 1 <br>  `cat /root/Scripts/audit-pkg.mail |  / usr / local / bin / msmtp vershinin.e @ gmail.com` <br>  sleep 1 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">PF rules restricting access to and from cells:</b> <div class="spoiler_text">  ###### JAIL RULES ###### <br><br>  ###### DokuWiki ######## <br>  # Default block rule <br>  block from $ dokuwiki to any <br>  block from any to $ dokuwiki <br>  # Pass from ANY to Dokuwiki Apache HTTP <br>  pass proto tcp port state to keep dokuwiki port 80 <br><br>  ###### FTP BACKUP ###### <br>  # Default block rule <br>  block from $ ftpbackup to any <br>  block from any to $ ftpbackup <br>  # Pass from LAN to FTP Ports: <br>  pass proto tcp from $ mylans to $ ftpbackup port 21 <br>  pass proto tcp from $ mylans to $ ftpbackup port {20000&gt; &lt;20100} <br><br>  ###### OwnCloud ######## <br>  # Default block rule <br>  block from $ owncloud to any <br>  block from any to $ owncloud <br>  # Pass from LAN to OwnCloud HTTP port <br>  pass proto tcp from $ mylans to $ owncloud port 80 keep state <br>  # Pass from WAN to OwnCloud HTTPS port <br>  pass protocc port 443 keep state <br><br>  ###### ALL Rules for JAILs ####### <br>  pass proto icmp from $ mylans to $ mylans <br>  pass proto udp from $ mylans to {$ dns_local $ dns_google} port 53 keep state <br>  pass proto tcp $ mylans to {$ pkg_mirror1 $ pkg_mirror2 $ pkg_mirror3 $ pkg_mirror4} keep state <br></div></div><br><div class="spoiler">  <b class="spoiler_title">An example of a command that lists all cells and their status from all connected servers:</b> <div class="spoiler_text">  cbsd jls alljails = 1 shownode = 1 (alias jall) <br><br>  Her conclusion: <br><br><img src="https://habrastorage.org/web/6a8/5d0/16b/6a85d016b68049a8be6e3252d9ee8bfe.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script for regular export of cells:</b> <div class="spoiler_text">  #! / bin / sh <br><br>  jailname = $ 1 <br><br>  CBSDPATH = / CBSD <br><br>  JAILBACKUPTARGET = / data / JAILS <br><br>  backupdate = `/ bin / date" +% Y-% m-% d "` <br><br>  jstatus = `/ usr / local / bin / cbsd jstatus $ jailname` <br><br>  if [$ jstatus -ne "0"];  then <br>  / usr / local / bin / cbsd jstop $ jailname <br>  sleep 15 <br>  fi <br><br>  jstatus2 = `/ usr / local / bin / cbsd jstatus $ jailname` <br><br>  if [$ jstatus2 -eq "0"];  then <br>  / usr / local / bin / cbsd jexport jname = $ jailname compress = 0 <br>  sleep 15 <br>  fi <br><br>  if [-f $ CBSDPATH / export / $ jailname.img];  then <br>  cp $ CBSDPATH / export / $ jailname.img $ JAILBACKUPTARGET / $ jailname- $ backupdate.img <br>  sleep 5 <br>  fi <br><br>  jstatus3 = `/ usr / local / bin / cbsd jstatus $ jailname` <br><br>  if [$ jstatus3 -eq "0"];  then <br>  / usr / local / bin / cbsd jstart $ jailname <br>  sleep 5 <br>  fi <br><br>  jstatus4 = `/ usr / local / bin / cbsd jstatus $ jailname` <br><br>  if [$ jstatus4 -ne "0"];  then <br>  echo ‚ÄúBackup JAIL Finish Successfull!  Jail restarted! ‚Äù <br>  fi <br></div></div><br><h3>  Summary: </h3><br>  <a href="https://www.bsdstore.ru/ru/about.html">CBSD is a</a> very interesting project, which I recommend getting to know better and having it in my ‚Äúportfolio of ready-made and successful solutions‚Äù. </div><p>Source: <a href="https://habr.com/ru/post/330168/">https://habr.com/ru/post/330168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330158/index.html">How to reduce the number of abandoned baskets in online sales</a></li>
<li><a href="../330160/index.html">Reduced read / write operations on the Raspberry Pi</a></li>
<li><a href="../330162/index.html">Dynamic connection of external native modules and plug-ins in Gradle</a></li>
<li><a href="../330164/index.html">Azure-IaaS-Digest # 16 (May)</a></li>
<li><a href="../330166/index.html">Your brand is at EuroPython 2017</a></li>
<li><a href="../330170/index.html">CNC (SEF URLs) in symfony 3 - slug autogeneration, configuration and routing</a></li>
<li><a href="../330172/index.html">We add cycles and conditions to jsx</a></li>
<li><a href="../330176/index.html">When 2 + 2 = "4"</a></li>
<li><a href="../330178/index.html">‚ÄúSnooze a little bit‚Äù: check list for a short break for sleep</a></li>
<li><a href="../330180/index.html">Dell EMC Cloud for Microsoft Azure key features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>