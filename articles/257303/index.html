<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Processing and display of signals at the conversion frequency of the ADC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objective: To consider the features of the input and display of broadband signals. 
 The task of the work: Construction of the channel input, processi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Processing and display of signals at the conversion frequency of the ADC</h1><div class="post__text post__text-html js-mediator-article">  Objective: To consider the features of the input and display of broadband signals. <br>  The task of the work: Construction of the channel input, processing and display of signals at the maximum frequency conversion of the ADC controller Arduino. <br>  Instruments and accessories: Arduino UNO controller, SimLink MatLAB package (R2012). <br><br><h4>  INTRODUCTION </h4><br>  Developing software for monitoring, analyzing and processing signals at the controller level is time consuming.  Connecting the controller to a high-level specialized environment (Fig. 1) significantly reduces the design time of the algorithm for the controller, taking into account the limitations of its resources. <br><br>  A good example of a powerful specialized environment for working with signals is MatLAB.  Signal analysis often requires observing its spectrum in the widest possible frequency band.  For this, the controller must receive signals at the maximum conversion frequency of the ADC. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The construction of the working channel ‚ÄúArduino UNO - MatLAB‚Äù for observing and processing signals in real time at the limiting frequency of the ADC conversion is described in detail in this work.  A feature of this channel is that the real-time ticks are not set by MatLAB, but by the Arduino controller.  Such a construction does not require compiling Simulink models with real-time (rtwin.tlc), which allows using virtually any blocks of the Simulink library in the model. <br><br><img src="https://habrastorage.org/files/c89/756/fc9/c89756fc9aa043ec8d12c57f3884482d.PNG" alt="image"><br>  Fig.  1. Comparison of algorithm development tools.  For designing algorithms at the level of a specialized environment, a data channel is required between the controller and the design environment. <br><a name="habracut"></a><br><h4>  GENERAL INFORMATION </h4><br>  <b>Means of accumulation, analysis, processing and display of signals</b> <br>  This work uses the Simulink environment to receive and display Arduino controller data. <br><br>  Simulink is an interactive environment and programming language for simulation modeling, which allows building dynamic models of processes using block diagrams.  Simulink is integrated into MatLAB.  The integration allows using ready-made block libraries, built-in mathematical algorithms, powerful tools for processing and graphical data display for solving the entire spectrum of problems from developing a concept of a model to testing, checking, code generation and hardware implementation. <br><br>  The composition of the Simulink library expansion packs is shown in Fig. 4 by the example of the ‚ÄúDSP System Toolbox‚Äù digital signal processing package.  2 <br><br><img src="https://habrastorage.org/files/7e3/e07/bb0/7e3e07bb08b34728b1bcacfe62b83aef.PNG" alt="image"><br>  Fig.  2. An example of an additional Simulink extension package for modeling signal processing systems: DSP System Toolbox [1].  The package uses the latest spectral analysis algorithms.  The contents of the Power Spectrum Estimation section are highlighted - blocks for spectral signal evaluation. <br><br>  <b>Streaming data</b> <br>  The use of two buffers for data accumulation and transmission allows you to organize the collection, processing and visualization of data without interruption (to avoid data loss, the speed of the subsequent process should not be lower than the speed of the previous process). <br><br>  An example of such an organization could be the E14-440 module [2] for multichannel input, output and processing of analog and digital information that is connected to a computer via the USB bus. <br><br>  Input data is first entered into the first half of the FIFO buffer of the ADC.  After it is filled, the data begins to be transmitted to the PC, at the same time, data collection into the second half of the FIFO buffer does not stop.  After the accumulation of data in the second half of the FIFO buffer, the data transfer to the PC begins again and in parallel the data collection continues to the first half. <br><br><h4>  BUILDING AN OSCILLOGRAPH ON THE BASIS OF ARDUINO CONTROLLER </h4><br>  <b>Maximum data accumulation rate of the ADC</b> <br>  Using the output of the result on the monitor of the Arduino editor at the maximum frequency (57600 bps) we will write a program for calculating the conversion of ADC for a fixed period. <br><br><img src="https://habrastorage.org/files/4dc/ccf/571/4dcccf57160f445db46036c63871530c.PNG" alt="image"><br><br>  The program for measuring the conversion rate of the ADC: <br><br>  const int adc_5 = A5;  // ADC port number <br>  unsigned long time_start;  // Start of capturing, ms <br>  unsigned long time_end;  // End of capturing, ms <br><br>  void setup () { <br>  Serial.begin (57600);  // 9600, 19200, 38400, 57600 and 115200 bit / s <br>  } <br><br>  void loop () { <br>  time_start = millis (); <br>  for (int i = 0; i &lt;1024; i ++) { <br>  int val = analogRead (adc_5); <br>  } <br>  time_end = millis (); <br>  int period = time_end - time_start; <br>  Serial.println (period); <br><br><img src="http://habrastorage.org/files/3fd/edd/17a/3fdedd17a8e24363be2b95f5738e6708.PNG" alt="image"><br>  Fig.  3. Time (in ms) 1024 and 512 ADC conversions.  Average ADC conversion time: 0.1123 ms (as 115/1024). <br><br>  <b>ADC data scaling time</b> <br>  To convert 10 bit ADC data to 8 bit, use the function <br>  map (val, 0, 1023, 0, 255); <br>  where val is an int variable with 10 significant digits. <br>  Program for measuring the conversion time of the ADC with scaling and writing to an array: <br><br>  const int adc_5 = A5;  // ADC port number <br>  unsigned long time_start;  // Start of capturing, ms <br>  unsigned long time_end;  // End of capturing, ms <br>  byte adc_bytes [1024];  // Buffer for ADC data <br><br>  void setup () { <br>  Serial.begin (57600);  // bit / s <br>  } <br><br>  void loop () { <br>  time_start = millis (); <br>  for (int i = 0; i &lt;1024; i ++) { <br>  int val = analogRead (adc_5); <br>  adc_bytes [i] = map (val, 0, 1023, 0, 255); <br>  } <br>  time_end = millis (); <br>  int period = time_end - time_start; <br>  Serial.println (period); <br>  } <br><br><img src="http://habrastorage.org/files/48f/798/94b/48f79894b9904d74bcacdea693e74b8a.PNG" alt="image"><br>  Fig.  4. Time (in ms) 1024 ADC conversions, translation 10 p.  data in 8 bit and write to the array.  The ADC conversion period with scaling: 0.1611 ms (as 165/1024). <br><br>  Since the conversion time of the ADC is 0.13 ms, one transfer of 10-bit data to byte format (scaling) is 0.0424 ms. <br><br>  <b>Serial data rate</b> <br>  To determine the rate of byte transfer to the serial channel, the code of the symbol Serial.write (1) is transmitted in a loop, which is not displayed on the monitor. <br><br>  The main block of the program for determining the transmission rate: <br><br>  void loop () {// Do stuff here <br>  unsigned long time = millis (); <br>  Serial.write (1); <br>  rate = rate + 1; <br>  if (time&gt; set_time) { <br>  set_time = set_time + 30;  // 30 ms RT clock <br>  Serial.println (rate); <br>  rate = 0; <br>  } <br>  } <br><br><img src="https://habrastorage.org/files/b35/dba/f39/b35dbaf39fa64023bbb358b2ca61ebf5.PNG" alt="image"><br>  Fig.  5. Test data: the number of bytes transferred to the serial channel in 30 ms at 57600 bps. <br>  The test showed that the transmission of 173 bytes takes 30 ms, on the other hand, for 30 ms at a speed of 57600 bps, 1728 bits can be transmitted.  Consequently, the transmission of one byte consumes a transmission time of 10 bits.  Using this relationship for transmit mode <br>  ‚Ä¢ Data bits: 8 <br>  ‚Ä¢ Parity: none <br>  ‚Ä¢ Stop bits: 1 <br>  ‚Ä¢ Flow control: none <br>  You can calculate the time of streaming a dataset at different speeds. <br>  Transmission, for example, 256 bytes at a speed of 9600 baud (bit / s) takes 267 ms, at a speed of 57600 baud - 44 ms;  and at a speed of 115200 baud - 22 ms (as 256 * 10/115200). <br><br>  <b>The size of the array for the accumulation and transmission of data</b> <br>  The size of operational (SRAM) memory Arduino UNO is 2 KB.  Testing the program for cyclic readout of the ADC, scaling 10 bit data to 8 bit, clocking and byte-by-bit data showed that the maximum size of the array for accumulating and sending data should not exceed 1800 bytes. <br><br>  More complex programs may require more additional SRAM memory.  Therefore, the array for accumulating and transmitting ADC data is limited to 1024 bytes or 512 words. <br><br><img src="https://habrastorage.org/files/216/d2e/adb/216d2eadb5c647a29e572f2ed11a4895.PNG" alt="image"><br>  Fig.  6. A piece of wire connected to the analog input A5 of the Arduino controller to enhance the observed network pickup 50 Hz. <br><br>  <b>Table 1</b> .  Times of program operations taking into account cycle instability <br><img src="https://habrastorage.org/files/d34/f76/0f8/d34f760f886b4404b4dbb0f1b36111f9.PNG" alt="image"><br><br>  <b>An example of setting the display channel 256 scaled ADC values ‚Äã‚Äãat the maximum rate of accumulation and transmission of data.</b> <br>  Arduino controller program code: <br>  const int adc_5 = A5;  // ADC port number <br>  unsigned long set_time;  // Time of next clock <br>  byte adc_bytes [256];  // Buffer for scaled ADC data <br><br>  void setup () { <br>  Serial.begin (115200);  // bit / s <br>  } <br><br>  void loop () { <br>  unsigned long time = millis ();  // Current time in ms <br><br>  // ADC data capturing <br>  for (int i = 0; i &lt;256; i ++) { <br>  int val = analogRead (adc_5); <br>  adc_bytes [i] = map (val, 0, 1023, 0, 255); <br>  } <br><br>  // send ADC data into serial port <br>  Serial.print ("A");  // "A" is header <br>  for (int i = 0; i &lt;256; i ++) { <br>  Serial.write (adc_bytes [i]); <br>  } <br><br>  if (time&gt; set_time) { <br>  set_time = set_time + 70;  // RT clock is 70 ms <br>  } <br>  } <br><habracut><br><img src="https://habrastorage.org/files/a16/617/701/a16617701caf4ce9aa858f9ca4d1470e.PNG" alt="image"><br>  Fig.  7. Determine the port number in the Arduino environment. <br><br><img src="https://habrastorage.org/files/a69/bcf/bbe/a69bcfbbe8a845828b7a7dc00a4c7ea6.PNG" alt="image"><br>  Fig.  8. Simulink model for receiving the controller's ADC data, scaling the vector of data over time, displaying data in real time and saving the data flow in the workspace. <br><br><img src="https://habrastorage.org/files/899/2a4/0ba/8992a40ba48c496cbd77762fc82d198f.PNG" alt="image"><br>  Fig.  9. COM port parameters in Simulink environment (model block: Serial Configuration) <br><br><img src="https://habrastorage.org/files/fc7/b5c/a8b/fc7b5ca8b679454cba40c5d79a6c4d8c.PNG" alt="image"><br>  Fig.  10. Parameters of the Simulink model and simulation mode blocks. <br><br>  The model is launched by pressing the Start simulation button: <br><img src="https://habrastorage.org/files/066/121/b5c/066121b5cb9c47e1a34ca91db04e13bf.PNG" alt="image"><br>  Fig.  11. Start button model. <br><br><img src="https://habrastorage.org/files/2c7/2cd/084/2c72cd08485244ee8636a40d07fed3d2.PNG" alt="image"><br>  Fig.  12. Type of network pickup (connection is shown in Fig. 6) with overlapping frames (left window) and in a separate frame (right window).  The reason for the signal offset when overlaying frames is the lack of display synchronization.  Note: Simulink has enough tools to build a sync channel. <br><br><h4>  EXAMPLES OF OBTAINING PROVEN RESULTS AND OPTIONS FOR SELF-CONTROL </h4><br>  <b>Task 1</b> .  The accumulation, transmission and display of scaled data (see an example and a table of times on page 8). <br>  1. Write for the Arduino UNO controller a program for cyclic reading of ADC readings, scaling, writing data to a 1024 byte array, and transmitting the array to a serial channel.  The program must run at maximum speed.  Symbol A is the header of the transmitted array. <br><br>  Sample program: <br><br>  const int adc_5 = A5;  // ADC port number <br>  unsigned long set_time;  // Time of next clock <br>  byte adc_bytes [1024];  // Buffer for ADC data <br><br>  void setup () { <br>  Serial.begin (115200);  // bit / s <br>  } <br><br>  void loop () { <br>  unsigned long time = millis ();  // Current time in ms <br><br>  // ADC data capturing <br>  for (int i = 0; i &lt;1024; i ++) { <br>  int val = analogRead (adc_5); <br>  adc_bytes [i] = map (val, 0, 1023, 0, 255); <br>  } <br><br>  // send ADC data into serial port <br>  Serial.print ("A");  // "A" is header <br>  for (int i = 0; i &lt;1024; i ++) { <br>  Serial.write (adc_bytes [i]); <br>  } <br><br>  if (time&gt; set_time) { <br>  set_time = set_time + 270;  // RT clock is 270 ms <br>  } <br>  } <br><br>  2. In the Matlab environment, compose a program of Simulink blocks for receiving and displaying controller data in real time.  The speed, packet size, the period of received data and the cycle of the model should correspond to the corresponding parameters of the controller.  Scale the time of the displayed data. <br><br><img src="https://habrastorage.org/files/105/d76/919/105d7691970d43a680586dd7996ef630.PNG" alt="image"><br>  Fig.  13. Simulink model for receiving data at maximum frequency: 115200 baud.  Vector concatenate is used to scale the signal along the frame time scale. <br><br>  3. Check the quality of the channel ‚ÄúADC Input - MatLAB Display‚Äù, for example, by the period of 50 Hz mains pickup at the ADC input.  To increase the pickup amplitude, connect a piece of wire to the ADC input (see Fig. 6).  The amplitude of the pickup depends on the distance between the wire and your hand. <br><br><img src="https://habrastorage.org/files/0dc/3fd/c36/0dc3fdc36a6643aea7ed9a40359e1501.PNG" alt="image"><br>  Fig.  14. Overlay 4 frames when scanning the frequency of 50 Hz at the input of the Arduino controller's ADC. <br><br><img src="https://habrastorage.org/files/ab6/f5d/642/ab6f5d64202e44bd808439b27f502053.PNG" alt="image"><br>  Fig.  15. Network frequency at the input of the ADC controller, 4 frame. <br><br>  <b>Task 2</b> .  The accumulation, transmission and display of 10-bit ADC data. <br>  1. For the Arduino UNO controller, write a program for cyclic reading of ADC readings, writing data to an array of 512 words, and byte-by-byte data transfer of the array to a serial channel.  The program must run at maximum speed. <br><br>  Sample program: <br><br>  const int adc_5 = A5;  // ADC port number <br>  unsigned long set_time;  // Time of next clock in ms <br>  word adc_int [512];  // Buffer for ADC data <br>  int val; <br>  byte val_Lo, val_Hi; <br><br>  void setup () { <br>  Serial.begin (115200);  // bit / s <br>  } <br><br>  void loop () { <br>  unsigned long time = millis (); <br><br>  // ADC data capturing <br>  for (int i = 0; i &lt;512; i ++) { <br>  adc_int [i] = analogRead (adc_5); <br>  } <br><br>  // send ADC data into serial port <br>  // first low bytes then high bytes <br>  Serial.print ("A");  // "A" is header <br>  for (int i = 0; i &lt;512; i ++) { <br>  val = adc_int [i]; <br>  val_Lo = (val &lt;&lt; 1) &amp; 0xFE; <br>  Serial.write (val_Lo);  // Lo byte <br>  } <br>  for (int i = 0; i &lt;512; i ++) { <br>  val = adc_int [i]; <br>  val_Hi = (val &gt;&gt; 6) &amp; 0xE; <br>  Serial.write (val_Hi);  // Hi byte <br>  } <br><br>  if (time&gt; set_time) { <br>  set_time = set_time + 160;  // RT clock is 160 ms <br>  } <br>  } <br><br>  2. Create a Simulink program to accept the recovery and display the controller's ADC data.  The speed, the packet size and the period of received data must match the corresponding parameters of the controller.  Scale the time of the displayed data. <br><br><img src="https://habrastorage.org/files/f5d/61b/bc0/f5d61bbc082443a3b94637e57d606c42.PNG" alt="image"><br>  Fig.  16. Simulink program for receiving, restoring and displaying the data array of the Arduino UNO controller ADC. <br>  3. Record network 50 Hz pickups. <br><br><img src="https://habrastorage.org/files/051/c04/5e3/051c045e319b4fe8b4773a4a53bfe607.PNG" alt="image"><br>  Fig.  17. The imposition of 15 frames when scanning a 50Hz network pickup at the input of the controller's ADC.  Program period: 160 ms.  Time to fill the array with ADC data: 58 ms.  The transmission time is 512x2 bytes at a frequency of 115200 baud: 89 ms. <br><br><img src="https://habrastorage.org/files/04b/963/ac0/04b963ac0015427a861d48fbf2ee9b5c.PNG" alt="image"><br>  Fig.  18. The last 15 frames.  Time 3.5 cycles 50 Hz signal: 70 ms. <br><br>  <b>Task 3</b> .  Signal processing by MatLAB m-program <br>  1. Save the real-time data in the MatLAB memory workspace, for example, using the simout block (see Fig. 13). <br>  2. Copy the saved data to the working directory, for example: <br>  save ('simout_50Hz', 'simout'); <br>  3. Develop the MatLAB m-program to display the archived ADC signal of the controller. <br><br>  Code example: <br><br>  clear all <br>  load ('simout_50Hz'); <br><br>  d_frame = simout.Time (2) -simout.Time (1); <br>  size_frame = size (simout.Data, 1); <br>  sampling = d_frame / (size_frame + 163 * 4);  % dt <br>  data_size = size (simout.Data, 1) * size (simout.Data, 2) * size (simout.Data, 3); <br><br>  % time = (0: data_size-1) * sampling; <br>  time = []; <br>  for i = 1: length (simout.Time) <br>  time = [time (0: 1023) * sampling + simout.Time (i)]; <br>  end <br><br>  adc = uint8 ([]); <br>  for i = 1: size (simout.Data, 3) <br>  adc = [adc simout.Data (:,:, i) ']; <br>  end <br><br>  % frame_num = length (simout.Time)% or size (adc, 3)% is 54 frame <br><br>  if 1% <br>  figure <br>  plot (time, adc, 'b') <br>  grid on <br>  xlabel ('Time, s'); <br>  ylabel ('ADC [0 ... 255], bit'); <br>  title ('8 bit ADC frame against Time'); <br>  end <br><br><img src="https://habrastorage.org/files/bab/2d9/36e/bab2d936eb6f42f6a7bda55ae614cf06.PNG" alt="image"><br>  Fig.  19. Frame-by-frame change of 50 Hz pickup at the input of the ADC controller Arduino UNO: 24 frames of 0.27 seconds. <br><br>  4. Develop an m-program for calculating the signal parameters, for example, the period in a given frame. <br><br>  Code example: <br><br>  clear all <br>  load ('simout_50Hz'); <br><br>  d_frame = simout.Time (2) -simout.Time (1); <br>  sampling = d_frame / ((256 + 176) * 4);  % dt <br>  data_size = size (simout.Data, 1) * size (simout.Data, 2) * size (simout.Data, 3);  % &lt;256 x 1 x 54&gt; <br><br>  % FRAME number <br>  i = 5; <br>  time = (0: 1023) * sampling + simout.Time (i); <br>  adc = simout.Data (:,:, i) '; <br>  if 1% <br>  figure <br>  plot (time, adc, 'b') <br>  grid on <br>  xlabel ('Time, s'); <br>  ylabel ('ADC [0 ... 255], bit'); <br>  title ('8 bit ADC frame against Time'); <br>  end <br>  % period <br>  comp_level = 60; <br>  j = 1; <br>  for i = 2: length (adc) <br>  if (adc (i)&gt; = comp_level) &amp;&amp; (adc (i-1) &lt;comp_level) <br>  cell_num (j) = i; <br>  j = j + 1; <br>  end <br>  end <br>  s_period = diff (time (cell_num)); <br><br><img src="http://habrastorage.org/files/b56/2e5/f8f/b562e5f8fd814c6197f6a0e62594efda.PNG" alt="image"><br>  Fig.  20. Continuous and pointwise change of the signal in the selected frame.  Time 5 frames: 1.08 ... 1.24 sec.  Vector size: 1024 bytes.  Therefore, the time of one readout and scaling of the signal of the ADC: 0.156 ms. <br><br><img src="https://habrastorage.org/files/84e/44b/88d/84e44b88de6846f1b0fbb2d66e45b8aa.PNG" alt="image"><br>  Fig.  21. Period of network pickup 5 frames: 19.2 ... 19.4 ms. <br><br>  <b>Task 4</b> .  The construction of the spectrum of the signal in real time. <br>  1. To observe the frequency spectrum of a signal, connect a fast Fourier transform unit (Spectrum Scope: FFT) from the Simulink&gt; DSP System Toolbox&gt; Sinks library section to the displayed signal. <br><br><img src="https://habrastorage.org/files/6ef/b35/9d7/6efb359d743244038fac88518a35481d.PNG" alt="image"><br>  Fig.  22. Model with a spectroscope. <br><br><img src="https://habrastorage.org/files/c88/97e/ace/c8897eace3324338b77fc08dab4143a3.PNG" alt="image"><br>  Fig.  23. Spectrum network jitters.  The frame signal includes 1024 amplitudes and 163x4 zero values. <br><br>  2. Highlight the main harmonic signal: 50 Hz. <br><img src="https://habrastorage.org/files/360/8b6/212/3608b621277645f4af94c99bd300767b.PNG" alt="image"><br>  Fig.  24. Harmonic signal at a frequency of 50 Hz. <br><br>  3. Connect the Spectrum Scope: FFT to an unscaled (in time) signal. <br><img src="https://habrastorage.org/files/07a/bfc/8c1/07abfc8c1c7a4cafbb0e3cb509a4579a.PNG" alt="image"><br>  Fig.  25. Transfer of the connection point of the spectrograph.  The input is an unscaled signal with a smaller zone of zero values ‚Äã‚Äãat the end of the array (vector). <br><br>  4. Configure the block.  Select the type of spectrum displayed: Spectrum Type. <br><img src="https://habrastorage.org/files/0af/278/df7/0af278df76a443b7bb9b2c17f9a8b46d.PNG" alt="image"><br>  Fig.  26. Parameters of the spectrometer unscaled signal of 1024 amplitudes. <br><br>  <b>Task 5</b> .  Build a channel of high-speed streaming and processing of 8p data in real time without skipping data. <br>  1. Write for the Arduino UNO controller a program for cyclic reading of ADC readings, scaling and transfer to the serial channel of 2048 bytes with a header.  The program should read the ADC at a constant frequency without interruption. <br><br>  Sample program: <br>  const int adc_5 = A5;  // ADC port number <br><br>  void setup () { <br>  Serial.begin (115200);  // bit / s <br>  } <br><br>  void loop () { <br>  for (int i = 0; i &lt;2048; i ++) { <br>  if (i == 0) Serial.print (‚ÄúA‚Äû);  // ‚ÄúA‚Äù is header <br>  int val = analogRead (adc_5); <br>  byte adc_byte = map (val, 0, 1023, 0, 255); <br>  Serial.write (adc_byte); <br>  } <br>  } <br><br>  2. Configure the Simulink model (MATLAB) to receive controller data. <br><img src="http://habrastorage.org/files/c47/265/9fd/c472659fdaba4a75be5c7455ee089b57.PNG" alt="image"><br>  Fig.  27. An example of a model for displaying a continuous stream of data.  The frame contains 2048 bytes. <br><br>  3. Set the model simulation time (Menu&gt; Simulation&gt; Configuration Parameters&gt; Solver&gt; Fixed-step size) and the cycle time of the Serial Receive&gt; Block Sample Time block (see Fig. 10) over the 50 Hz network period. <br>  Estimated frame time by data Table 1: 254 ms (for 1024 bytes) =&gt; 508 ms for 2048 bytes. In fact, the time frame of the program (in which ADC reading and transmission are performed alternately) is 375 ms. <br><br><img src="https://habrastorage.org/files/f8e/aaf/9f7/f8eaaf9f76f548329e5151c4aa3dc7cb.PNG" alt="image"><br>  Fig.  28. Vector Scope Plotter Frame.  In the frame 18.75 periods 50 Hz wave.  Therefore, the frame time should be 375 ms, and the ADC conversion, scaling, and data transfer period: 0.1831 ms. <br><br>  4. In the command window of the MatLAB, type the command to form a 5-frame signal. <br>  sgnl = [simout.Data (:, 1,1) 'simout.Data (:, 1,2)' simout.Data (:, 1,3) 'simout.Data (:, 1,4)' simout.Data (:, 1,5) ']; <br><br>  5. Build a graph of the first 5 frames of the signal. <br><img src="https://habrastorage.org/files/734/74d/075/73474d075ba54a29931e57a670431d8c.PNG" alt="image"><br>  Fig.  29. Five frames of the input signal of the model. <br><br>  6. Consider the quality of frame joints. <br><img src="https://habrastorage.org/files/94a/c3e/7cf/94ac3e7cfbd94e26b59e8fee78d3902a.PNG" alt="image"><br>  Fig.  30. Joints of five frames.  There are noticeable distortions in the first byte of each frame.  Replacing the first byte of the average values ‚Äã‚Äãbetween the nearest points can significantly reduce distortion. <br><br>  7. Connect a spectrum analyzer to the input of the model.  Watch the signal spectrum in real time. <br><img src="https://habrastorage.org/files/d5e/26d/029/d5e26d029cb74fde875279dd1f130f74.PNG" alt="image"><br>  Fig.  31. The model of the display spectrum of the input signal (ADC Arduino UNO) in real time. <br><br><img src="https://habrastorage.org/files/c0a/d90/b24/c0ad90b242f54615a8aee2faf6868d6d.PNG" alt="image"><br>  Fig.  32. The spectrum of network crosstalk at the input of the Arduino controller's ADC. <br><br>  8. Connect the Time Scope oscilloscope from the Simulink&gt; DSP System Toolbox&gt; Sinks library to the input signal. <br><img src="https://habrastorage.org/files/6e4/306/f62/6e4306f62cdf446ba14f58bf3b5a8ecd.PNG" alt="image"><br>  Fig.  33. Oscilloscope in the model to display the input signal of the Arduino controller. <br><br>  9. Adjust the oscilloscope to display the current frame content and signal frequency. <br><img src="https://habrastorage.org/files/328/74a/9b9/32874a9b9da54625988d21f68a27b5f9.PNG" alt="image"><br>  Fig.  34. Configure the oscilloscope Time Scope&gt; Menu&gt; View&gt; Properties. <br><br>  10. Run the model and observe the stability of the signal parameters. <br><img src="https://habrastorage.org/files/960/acf/d96/960acfd9606a4887a3f00fb2c694450c.PNG" alt="image"><br>  Fig.  35. Display the signal and its parameters in real time on a Simulink oscilloscope model. <br><br>  The latest version of the channel controller Arduino - MatLAB in comparison with previous versions has the following advantages. <br>  ‚Ä¢ the controller memory is not used to accumulate ADC data; <br>  ‚Ä¢ provides a small ADC conversion clock with scaling, which is slightly longer than the ADC conversion clock with scaling in the absence of transmission; <br>  ‚Ä¢ no time scaling is required in the Simulink model; <br>  ‚Ä¢ model contains fewer blocks; <br>  ‚Ä¢ The vector size and frame time are practically unlimited. <br><br>  <b>Task 6.</b> Increase the sampling frequency of the ADC signal. <br><br>  The sampling frequency of the Arduino controller's ADC can be increased to 15 kHz in 10-bit mode and to 77 kHz in 8-bit mode [3], replacing library functions with a faster version of using microcontroller registers. <br>  The user function can be created in the * .ino program or in the system file of the controller <br>  ... \ arduino-1.0.6 \ hardware \ arduino \ cores \ arduino \ wiring_analog.c, registering it with <br>  ... \ arduino-1.0.6 \ hardware \ arduino \ cores \ arduino \ Arduino.h <br><br>  To build an 8-bit high-speed channel Arduino - MatLAB, you must do the following. <br>  1. Write a program for determining the time of filling the ADC array with data with the result displayed in the ‚ÄúSerial Monitor‚Äù window.  The size of the array should be large enough, for example, in half of the SRAM memory.  To increase accuracy, measure the time of multiple filling of the array. <br>  Sample program: <br>  byte adc_bytes [1024];  // Backup array for ADC data <br>  void setup () { <br>  Serial.begin (57600);  // bit / s <br><br>  ADCSRA = (1 &lt;&lt; ADEN) // Enable ADC <br>  | (1 &lt;&lt; ADPS2);  // Set the converter's prescaler to 8 <br>  ADMUX = (1 &lt;&lt; ADLAR) |  (1 &lt;&lt; REFS0) // Connecting External ION <br>  | (1 &lt;&lt; MUX2) | (0 &lt;&lt; MUX1) | (1 &lt;&lt; MUX0);  // connect ADC A5 == 101 <br>  } <br><br>  void loop () { <br>  unsigned long time_start = millis (); <br>  for (int j = 0; j &lt;100; j ++) { <br>  for (int i = 0; i &lt;1024; i ++) { <br>  ADCSRA | = (1 &lt;&lt; ADSC);  // Start ADC conversion <br>  while ((ADCSRA &amp; (1 &lt;&lt; ADIF)) == 0); // Waiting for the conversion completion flag <br>  adc_bytes [i] = ADCH;  // Read the received value <br>  } <br>  } <br>  unsigned long time_end = millis (); <br>  unsigned int dt = time_end - time_start; <br>  Serial.println (dt); <br>  } <br><br>  <u>One hundred fillings in an array of 1024 bytes were completed in <b>1542 ms</b> .</u> <br><br>  2. Complete the one-time filling of the array with the ADC data by the subsequent transfer of the entire array to the serial port at maximum speed. <br>  Sample program: <br><br>  byte adc_bytes [1024];  // Backup array for ADC data <br><br>  void setup () { <br>  Serial.begin (115200);  // bit / s <br>  ADCSRA = (1 &lt;&lt; ADEN) // Enable ADC <br>  | (1 &lt;&lt; ADPS2);  // Set the converter's prescaler to 8 <br>  ADMUX = (1 &lt;&lt; ADLAR) |  (1 &lt;&lt; REFS0) // Connecting External ION <br>  | (1 &lt;&lt; MUX2) | (0 &lt;&lt; MUX1) | (1 &lt;&lt; MUX0);  // connect ADC A5 == 101 <br>  } <br><br>  void loop () { <br>  for (int i = 0; i &lt;1024; i ++) { <br>  ADCSRA | = (1 &lt;&lt; ADSC);  // Start ADC conversion <br>  while ((ADCSRA &amp; (1 &lt;&lt; ADIF)) == 0);  // Waiting for the conversion finish flag <br>  adc_bytes [i] = ADCH;  // Read the resulting value <br>  } <br>  // send ADC data into serial port <br>  Serial.print ("A");  // "A" is header <br>  for (int i = 0; i &lt;1024; i ++) { <br>  Serial.write (adc_bytes [i]); <br>  } <br>  } <br>  3. In the Simulink model (Fig. 36), in the format 0.01542, enter the experimental value of the recording time in the array, namely, in the ‚ÄúBlock sample time‚Äù line of the ‚ÄúSerial Receive‚Äù block and in the menu bar&gt; simulation&gt; Configuration Parameters&gt; Fixed-step size (fundamental sample time). <br><br>  &lt;img src = " <img src="//habrastorage.org/files/5ee/49e/cce/5ee49ecce89f4f7baf85ea5f8ecf1e5e.PNG" alt="image"><br>  Fig.  36. Simulink model for receiving and displaying data from the COM port. <br><br>  4. Connect a test signal to the ADC input.  Run the Arduino program and then the Simulink model (MatLAB).  Compare the known parameters of the signal with the parameters of the observed signal.  You can check the path operation by displaying alternately connected output voltages of the Arduino board: 0V;  3.3B and 5B. <br><br>  &lt;img src = "&lt;img src =" <img src="//habrastorage.org/files/267/146/74f/26714674ff574424b78ad574b88a2b3a.PNG" alt="image"><br>  Fig.  37. Real-time display of network 50 Hz pickups.  The frame includes 1024 points.  The frame time is 15.42 ms.  The sampling frequency is 66 kHz (as 1 / (0.01542_sec / 1024)).  The displayed signal has gaps: the recording process is interrupted by the transmission of a frame to the serial channel. <br><br>  &lt;img src = " <img src="//habrastorage.org/files/3f2/c14/a85/3f2c14a852274bde802bd2a55cb478db.PNG" alt="image"><br>  Fig. 38.        0‚Ä¶ 3.3 ,    Teensy 3.1  12        (A5)  Arduino. <br><br>  &lt;img src = " <img src="//habrastorage.org/files/ff4/8ac/b2d/ff48acb2d90944e081728d2be28381d7.PNG" alt="image"><br>  Fig. 39.  500   Teensy 3.1.   (15.42 ) Simulink      1% ( 100%*(504.72 ‚Äî 500)/500).     RT ,    .3  . <br><br><h4>   </h4><br> 1.        . <br> 2.           ? <br> 3.     1024    115200 /c    ? <br> ‚Ä¢ Data bits: 8 <br> ‚Ä¢ Parity: none <br> ‚Ä¢ Stop bits: 1 <br> ‚Ä¢ Flow control: none <br><br><h4>   </h4><br> 1. DSP System Toolbox. <a href="http://matlab.ru/datasheets/Dsp-system-toolbox-Ru.pdf">matlab.ru/datasheets/Dsp-system-toolbox-Ru.pdf</a> <br> 2. Dr. Bob Davidov.     USB  Lcard E14-440 (S-function) <a href="http://portalnp.ru/2013/09/1036">portalnp.ru/2013/09/1036</a> <br> 3. ATmega48A/PA/88A/PA/168A/PA/328/P. ATMEL 8-bit microcontroller with 4/8/16/32kbytes in-system programmable flash DATASHEET ( 237) <a href="http://www.atmel.com/images/Atmel-8271-8-bit-AVR-Microcontroller-ATmega48A-48PA-88A-88PA-168A-168PA-328-328P_datasheet_Complete.pdf">www.atmel.com/images/Atmel-8271-8-bit-AVR-Microcontroller-ATmega48A-48PA-88A-88PA-168A-168PA-328-328P_datasheet_Complete.pdf</a> <br> 4. Dr. Bob Davidov.       <a href="http://portalnp.ru/author/bobdavidov">portalnp.ru/author/bobdavidov</a> . </habracut></div><p>Source: <a href="https://habr.com/ru/post/257303/">https://habr.com/ru/post/257303/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257293/index.html">Attackers use Linux / Mumblehard to compromise servers, part 2</a></li>
<li><a href="../257295/index.html">Just about corporate IaaS: what it is, for whom, and how it is paid</a></li>
<li><a href="../257297/index.html">Centralized collection and processing of Windows print logs</a></li>
<li><a href="../257299/index.html">How clouds have changed the architecture of data centers</a></li>
<li><a href="../257301/index.html">2.5 million views - did you work well? Time to go on</a></li>
<li><a href="../257305/index.html">Implementing Private Fields with WeakMap in JavaScript</a></li>
<li><a href="../257307/index.html">A meeting on Atlassian products took place in Moscow</a></li>
<li><a href="../257317/index.html">Apple Watch Human Interface Guideline</a></li>
<li><a href="../257319/index.html">Arbelos</a></li>
<li><a href="../257321/index.html">Another way to connect WS2812B to a microcontroller</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>