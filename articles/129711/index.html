<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of transition to the DNS-server NSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Back in 2007, when Ukrnames was still small and took the first steps, most of the work was done by programmers. They developed the domain management s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of transition to the DNS-server NSD</h1><div class="post__text post__text-html js-mediator-article">  Back in 2007, when Ukrnames was still small and took the first steps, most of the work was done by programmers.  They developed the domain management system, tested it, and administered the servers where all this stuff worked. <br><br>  And where there are domains, there is DNS.  And what is the easiest way to make a DNS server?  Put the omnipresent BIND.  Yes, BIND is not easy, but with the DLZ patch so that it can be friends with MySQL. <br><br>  The years went by, the system worked, the server power grew.  And as usual, while working - do not touch.  So it would all continue if the load did not start to rest against the next 8th nuclear server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At that moment, I had to make a volitional decision and build a new system of DNS servers, instead of upgrading the hardware for the insatiable BIND + DLZ again. <br><br>  And here the fairy tale ended, and the harsh everyday life of the administrator began. <br><a name="habracut"></a><br><h4>  What we have? </h4><br>  It is necessary to maintain a service that Ukrnames for domains provides for free, namely ‚ÄúManaged DNS‚Äù. <br><br>  Currently this service is used for more than one hundred thousand domains.  Domains are diverse, with different attendance, respectively, the load does not depend on the number of domains. <br><br>  The service is served by 3 DNS servers, with Xeon X3430 configuration, 8Gb DDR3, 2x500Gb SATA RAID1.  Servers use BIND + DLZ patch in conjunction with MySQL.  The database works as a slave of the currently active domain zone storage servers. <br><br><h4>  We are looking for problems on our ... head </h4><br><ul><li>  High load, 100% server capacity is used.  Half falls on MySQL, the second half falls on BIND. </li><li>  DLZ patch is already obsolete and does not develop.  Infinitely redoing a patch for new versions of BIND is not the best approach. </li><li>  When using other solutions, the problem of the old database arises, which was initially filled without any special checks.  Lots of junk, lots of entries that don't comply with RFC.  Their sane will not accept any sane DNS. </li></ul><br><h4>  Uncover tambourine </h4><br>  From the existing variety, PowerDNS with MySQL and NSD (work on files) were chosen. <br>  It was decided to make a competition for the old BIND and these two impostors. <br><br><h4>  Watch PowerDNS </h4><br>  At first glance, the most logical choice is to take a DNS server that out of the box knows how to work with the MySQL database and bind it to the existing database. <br><br>  In practice, it turned out that with the existing database and with the one that requires PowerDNS, there were several rather unpleasant differences. <br><br>  As a result, for implementation, it was necessary to either change the database structure, and this will pull changes in the code of the entire system.  Either build crutches, namely procedures or view. <br><br>  For the competition was chosen the second option, because  The main system could not be touched. <br><br><h4>  Feel the NSD </h4><br>  Judging by <a href="http://ru.wikipedia.org/wiki/NSD">Wikipedia</a> , NSD successfully works on 3 root servers. <br><br>  A feature of NSD is that it compiles all zones into its internal database format, and then loads it entirely into RAM. <br><br>  On the developer's site there is a <a href="http://nlnetlabs.nl/projects/nsd/nsd-memsize.html">tool for calculating the consumption of RAM</a> .  In our case we got about 367 Mb, which was more than an acceptable result. <br><br><h4>  Charge the tambourine </h4><br>  A utility was written that sent requests to the DNS server in 50 threads.  The domains were chosen randomly from the existing database, the type of records also changed randomly. <br><br>  For PowerDNS, a view was written that gave the data in the correct format.  During testing, it was rewritten 3 times for optimization. <br><br>  For NSD, a utility converter was written on my favorite Google Go that sampled the entire database and compiled the database into the internal NSD format. <br><br>  In both cases, logical filters were used to convert all inconsistencies with the RFC into a digestible form. <br><br>  Also, the base was cleaned of perennial debris.  Without idiomatic expressions has not done.  I never would have thought that SUCH can be recorded in DNS.  There were both URLs in CNAME records, and emails with passwords in MX.  Apparently, programmers initially believed in users too, and did not make normal filters for recordings. <br><br><h4>  Dancing </h4><br>  In turn, a test was conducted for each participant.  Test duration 10 minutes.  Once a minute, the average response time for the last minute and the current processor load in percent are stored.  Testing was performed on a machine with the same configuration as the combat DNS servers. <br><br>  PowerDNS was configured to generate SOA on its own to reduce the number of queries to MySQL, the cache of records was also turned on for 1 minute. <br>  NSD worked in 4 threads, in a standard configuration. <br><br><h4>  results </h4><br>  BIND + DLZ showed itself as usual, a huge response time, space load. <br><br>  PowerDNS showed good performance, as well as BIND, giving approximately 50 to 50 loads for the main daemon and MySQL.  And he would be the leader if there was no NSD in the test ... <br><br>  Response time: <br><img src="https://habrastorage.org/storage1/9e2e7407/8f770bf8/ee8375ae/0fe163ac.png"><br><br><img src="https://habrastorage.org/storage1/ccf1ffbd/a671a791/9fa09601/e88bf955.png"><br><br>  CPU load: <br><img src="https://habrastorage.org/storage1/3687be3c/ed33cc93/f5c8caa3/7822b2a5.png"><br><br><img src="https://habrastorage.org/storage1/15e9492e/6bd3eafb/a4a9d6bc/0320ef42.png"><br><br>  The NSD test was repeated 3 times, because  there was a persistent feeling that something was wrong, and this could not be. <br><br><h4>  Total </h4><br>  Actually the result suggests itself. <br><br>  MySQL logic is a weak point.  It is better to process such data already on the recipient and make as few requests as possible. <br><br>  For DNS is quite normal if the data is updated no more than half an hour.  The converter utility runs in 7 seconds and allows for a minute update. <br><br>  NSD now works on our servers and we will not think about iron upgrade soon, except to replace the disks with more recent ones. </div><p>Source: <a href="https://habr.com/ru/post/129711/">https://habr.com/ru/post/129711/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129700/index.html">Lawsuits for ... patents on Wi-Fi</a></li>
<li><a href="../129701/index.html">Clipping algorithms</a></li>
<li><a href="../129706/index.html">Apple Developers Community # 9. Taste WP7</a></li>
<li><a href="../129707/index.html">YouTube is going to fill with professional video content</a></li>
<li><a href="../129708/index.html">Leadership Philosophy</a></li>
<li><a href="../129712/index.html">Oracle NoSQL database</a></li>
<li><a href="../129714/index.html">Installing DataStage Client</a></li>
<li><a href="../129715/index.html">Our projects: DNS hosting with blackjack and buns</a></li>
<li><a href="../129718/index.html">Payoneer: Your Affiliate Partner</a></li>
<li><a href="../129719/index.html">On the "Rambler-Maps" corrected errors and added new cities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>