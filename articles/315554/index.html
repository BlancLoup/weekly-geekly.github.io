<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring and Metrics for the Play Framework with Dropwizard Metrics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some point in the development of the application, each of us comes to the fact that we need more information about what is happening inside the app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring and Metrics for the Play Framework with Dropwizard Metrics</h1><div class="post__text post__text-html js-mediator-article"><p>  At some point in the development of the application, each of us comes to the fact that we need more information about what is happening inside the application or the ability to monitor the application.  In the case of the Play Framework, there is already a ready-made solution in the form of an excellent open source library <a href="http://kamon.io/">Kamon</a> paired with the <a href="http-toolkits/play/">kamon-play</a> module. </p><br><p> But today we are going to take a look at the alternative solution, integration and use of <a href="http://metrics.dropwizard.io/">Drowizard Metrics</a> formerly known as <code>Codahale Metrics</code> with the Play Framework. </p><br><a name="habracut"></a><br><h2 id="integraciya">  Integration </h2><br><p>  So I started looking for ready-made solutions that could help me in integrating these two tools. </p><br><p>  I found some incomplete solutions: </p><br><ul><li>  <a href="https://github.com/erikvanoosten/metrics-scala">metrics-scala</a> - Excellent library, elegant API with good support for Scala, but in the case of the Play Framework there is not enough support. </li><li>  <a href="https://github.com/kenshoo/metrics-play">metrics-play</a> - One of the first solutions that Google is trying to satisfy your request, but this library is no longer supported and not compatible with the latest versions of the Play Framework and Dropwizard Metrics.  But there is a <a href="https://github.com/breadfan/metrics-play">fork</a> that has been updated to the latest versions, so I decided to try it. </li></ul><br><p>  Unfortunately, the <a href="https://github.com/breadfan/metrics-play">metrics-play</a> module provides only basic functionality from all that is available in the Dropwizard Metrics environment.  This may be enough if you need simple metrics that are accessible through REST api, but I had higher requirements and I decided to add functionality to this module by writing the following modules: </p><br><ul><li>  <a href="https://github.com/htimur/metrics-reporter-play">metrics-reporter-play</a> - Metrics reporters support in the Play Framework. </li><li>  <a href="https://github.com/htimur/metrics-annotation-play">metrics-annotation-play</a> - Metrics annotation support for the Play Framework via Guice AOP. </li></ul><br><p>  Actually, we will discuss this further. </p><br><h4 id="podderzhka-metrics-reporterov-v-play-framework">  Metrics Reporters Support in the Play Framework </h4><br><p>  Metrics provides powerful tools for monitoring the behavior of critical components in a production environment.  It also provides a means of sending measured data through reporters.  Metrics Reporters is a great way to send data from the application itself to your preferred storage and visualization of metrics. </p><br><p>  At the time of this writing, the supported reporters are: </p><br><ul><li>  console - Periodically sends data to the standard application exit stream </li><li>  graphite - Periodically sends data to Graphite. </li></ul><br><p>  Dropwizard Metrics and the community are also provided by other reporters, for example <code>Ganglia Reporter</code> , <code>CSV Reporter</code> , <code>InfluxDB Reporter</code> , <code>ElasticSearch Reporter</code> and others. </p><br><p>  Adding factories to support reporters in the library is an easy task. </p><br><h4 id="podderzhka-annotaciy-metrics-dlya-play-framework-cherez-guice-aop">  Metrics annotation support for the Play Framework via the Guice AOP </h4><br><p>  By default, in order to use metrics, you need to call the Metric Registry to create metrics, create a context and manually manage it.  For example: </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doSomethingImportant</span></span></span></span>() = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> timer = registry.timer(name(classOf[<span class="hljs-type"><span class="hljs-type">WebProxy</span></span>], <span class="hljs-string"><span class="hljs-string">"get-requests"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = timer.time() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-comment"><span class="hljs-comment">// critical business logic finally context.stop() }</span></span></code> </pre> <br><p>  To keep all <code>DRY</code> annotations in place, the <a href="https://github.com/htimur/metrics-annotation-play">metrics-annotation-play</a> module will create and properly call Timer for <code>@Timed</code> , Meter for <code>@Metered</code> , Counter for <code>@Counted</code> and Gauge for <code>@Gauge</code> .  <code>@ExceptionMetered</code> also supported; it creates a Meter that measures the frequency of throwing exceptions. </p><br><p>  The previous example can be rewritten as follows: </p><br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@Timed</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doSomethingImportant</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-comment"><span class="hljs-comment">// critical business logic }</span></span></code> </pre> <br><p>  or you can depreciate the whole class, which will create metrics for all explicit methods: </p><br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@Timed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SuperCriticalFunctionality</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doSomethingImportant</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-comment"><span class="hljs-comment">// critical business logic } }</span></span></code> </pre> <br><p>  This functionality is only supported for classes created through Guice, there are also some AOP restrictions. </p><br><h2 id="primer-ispolzovaniya">  Usage example </h2><br><p>  Let's try to use the library in a real application and consider how everything works.  The source code of the application can be found <a href="https://github.com/htimur/play_metrics_example">here</a> . </p><br><p>  I use the <code>activator play-scala</code> template with <code>sbt plugin</code> .  We need to add <code>JCenter</code> to the <code>resolvers</code> and dependencies list: </p><br><pre> <code class="scala hljs">name := <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"play_metrics_example"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> version := <span class="hljs-string"><span class="hljs-string">"1.0-SNAPSHOT"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> root = (project in file(<span class="hljs-string"><span class="hljs-string">"."</span></span>)).enablePlugins(<span class="hljs-type"><span class="hljs-type">PlayScala</span></span>) scalaVersion := <span class="hljs-string"><span class="hljs-string">"2.11.8"</span></span> resolvers += <span class="hljs-type"><span class="hljs-type">Resolver</span></span>.jcenterRepo libraryDependencies ++= <span class="hljs-type"><span class="hljs-type">Seq</span></span>( <span class="hljs-string"><span class="hljs-string">"de.khamrakulov.metrics-reporter-play"</span></span> %% <span class="hljs-string"><span class="hljs-string">"reporter-core"</span></span> % <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"de.khamrakulov"</span></span> %% <span class="hljs-string"><span class="hljs-string">"metrics-annotation-play"</span></span> % <span class="hljs-string"><span class="hljs-string">"1.0.2"</span></span>, <span class="hljs-string"><span class="hljs-string">"org.scalatestplus.play"</span></span> %% <span class="hljs-string"><span class="hljs-string">"scalatestplus-play"</span></span> % <span class="hljs-string"><span class="hljs-string">"1.5.1"</span></span> % <span class="hljs-type"><span class="hljs-type">Test</span></span> )</code> </pre> <br><p>  For example, I'm using the <code>onsole</code> reporter, let's add the configuration to <code>application.conf</code> . </p><br><pre> <code class="hljs scala">metrics { jvm = <span class="hljs-literal"><span class="hljs-literal">false</span></span> logback = <span class="hljs-literal"><span class="hljs-literal">false</span></span> reporters = [ { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"console"</span></span> frequency: <span class="hljs-string"><span class="hljs-string">"10 seconds"</span></span> } ] }</code> </pre> <br><p>  As you can see, I deactivated the <code>jvm</code> and <code>logback</code> so as not to lose our metrics and added a reporter who will output the metrics to <code>stdout</code> with a periodicity of 10 seconds. </p><br><p>  Now we can start using annotations, I will decorate the <code>index</code> method of the <code>HomeController</code> controller: </p><br><pre> <code class="scala hljs"><span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@Inject</span></span></span><span class="hljs-class">(</span><span class="hljs-params"></span><span class="hljs-class"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Counted</span></span>(monotonic = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Timed</span></span> <span class="hljs-meta"><span class="hljs-meta">@Metered</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Action</span></span> { <span class="hljs-type"><span class="hljs-type">Ok</span></span>(views.html.index(<span class="hljs-string"><span class="hljs-string">"Your new application is ready."</span></span>)) } }</code> </pre> <br><p>  In fact, you should not use all the annotations at once, because  <code>@Timed</code> combines <code>Counter</code> and <code>Meter</code> , but I did it to demonstrate the possibilities. </p><br><p>  After starting the application and requesting the <code> </code> , the reporter should output the metrics to <code>stdout</code> : </p><br><pre> <code class="hljs vbscript">-- Counters -------------------------------------------------------------------- controllers.HomeController.index.current count = <span class="hljs-number"><span class="hljs-number">1</span></span> -- Meters ---------------------------------------------------------------------- controllers.HomeController.index.meter count = <span class="hljs-number"><span class="hljs-number">1</span></span> mean rate = <span class="hljs-number"><span class="hljs-number">0.25</span></span> events/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> events/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> events/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> events/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> -- Timers ---------------------------------------------------------------------- controllers.HomeController.index.<span class="hljs-built_in"><span class="hljs-built_in">timer</span></span> count = <span class="hljs-number"><span class="hljs-number">1</span></span> mean rate = <span class="hljs-number"><span class="hljs-number">0.25</span></span> calls/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> calls/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> calls/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">minute</span></span> rate = <span class="hljs-number"><span class="hljs-number">0.00</span></span> calls/<span class="hljs-built_in"><span class="hljs-built_in">second</span></span> min = <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds max = <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds mean = <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds stddev = <span class="hljs-number"><span class="hljs-number">0.00</span></span> milliseconds median = <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds <span class="hljs-number"><span class="hljs-number">75</span></span>% &lt;= <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds <span class="hljs-number"><span class="hljs-number">95</span></span>% &lt;= <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds <span class="hljs-number"><span class="hljs-number">98</span></span>% &lt;= <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds <span class="hljs-number"><span class="hljs-number">99</span></span>% &lt;= <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds <span class="hljs-number"><span class="hljs-number">99.9</span></span>% &lt;= <span class="hljs-number"><span class="hljs-number">14.59</span></span> milliseconds</code> </pre> <br><p>  Of course, you can still view the metrics via REST api, for this you need to add a configuration to the <code>routes</code> file: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>/metrics com.kenshoo.play.metrics.MetricsController.metrics</code> </pre> <br><h2 id="chto-dalshe">  What's next? </h2><br><h5 id="avtomaticheskaya-proverka-rabotosposobnosti-prilozheniya-health-checks">  Automatic health check of the application (Health Checks) </h5><br><p>  Metrics also supports the ability to use automatic health checks for the application (health checks).  More information can be found in the <a href="http://metrics.dropwizard.io/3.1.0/manual/healthchecks/">official documentation</a> . </p><br><h5 id="bolshe-reporterov">  More reporters </h5><br><p>  Creating a proper metric usage environment requires the support of more reporters.  This should be another direction in the development of the library. </p><br><h5 id="nadlezhaschaya-podderzhka-future">  Proper Future Support </h5><br><p>  At the moment, in order to measure the execution time of the <code>Future</code> you need to manually perform all actions.  Proper support for Future can help in an asynchronous Play Framework environment and can be a good addition. </p><br><h5 id="podderzhka-hdrhistogram">  HdrHistogram support </h5><br><p>  <a href="http://hdrhistogram.org/">Hdrhistogram</a> provides an alternative implementation of a high-quality reservoir (reservoir) that can be used for <code>Histogram</code> and <code>Timer</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315554/">https://habr.com/ru/post/315554/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315542/index.html">I loved the layout after this: Zeplin in battle</a></li>
<li><a href="../315544/index.html">Overview of the domestic digital gateway Eltex SMG-1016M (VoIP)</a></li>
<li><a href="../315546/index.html">Club of anonymous Santa Clauses 2016-2017 on Habrahabr</a></li>
<li><a href="../315548/index.html">Friday: all interface designers go to hell ...</a></li>
<li><a href="../315552/index.html">How to create a good quest - useful tips</a></li>
<li><a href="../315558/index.html">Introducing the right-angled, constructor of grids for angular2.</a></li>
<li><a href="../315562/index.html">A couple of common misconceptions about RFID and Wi-Fi radio channels (and RFID as Wi-Fi points)</a></li>
<li><a href="../315564/index.html">How IT professionals work. Oleg Bartunov, Postgres Professional</a></li>
<li><a href="../315566/index.html">Go panic (), runtime error and their implementation in your OS on Go + asm Part 0x000c03f. (Float32)</a></li>
<li><a href="../315570/index.html">What.cd is closed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>