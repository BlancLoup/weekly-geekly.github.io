<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to run the background process in Asp.net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I needed to run the background process in ASP.NET. The question arose: how best to do this? A little googling on the SCOTT HANSELMAN blog, I found the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to run the background process in Asp.net</h1><div class="post__text post__text-html js-mediator-article">  I needed to run the background process in ASP.NET.  The question arose: how best to do this?  A little googling on the <a href="http://www.hanselman.com/">SCOTT HANSELMAN</a> blog, I found the post ‚Äú <a href="http://www.hanselman.com/blog/HowToRunBackgroundTasksInASPNET.aspx">How to run Background Tasks in ASP.NET</a> ‚Äù.  The article is not very new - in 2014, but quite relevant, so I decided to translate it into Russian. <br><a name="habracut"></a><br>  A few years ago, Phil Haack wrote a <a href="http://haacked.com/archive/2011/10/16/the-dangers-of-implementing-recurring-background-tasks-in-asp-net.aspx">great article</a> about the dangers of performing background tasks in ASP.NET.  He identified three main risks associated with running the background process: <br><br><ol><li>  An unhandled exception in a stream unrelated to a request can take a process. </li><li>  If you run a website in a web farm, then there is a chance to accidentally complete several instances of an application that could have launched several instances of the same task at the same time. </li><li>  The application domain in which the site is running, for various reasons, can be unloaded and remove the background task running in it. </li></ol><br>  Of course, you can write your own manager to manage background tasks.  But, most likely, you will make it wrong.  No one is going to challenge your developer skills.  Just creating such a manager is a pretty subtle thing.  And why do you need it? <br><br>  There are many excellent options for running tasks in the background.  And not just abstract techniques, but ready-made libraries. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some ASP.NET applications can work on your own servers under IIS, some can be hosted in Azure. <br><br>  There are several options for running background tasks: <br><br><ul><li>  Primary: <a href="http://hangfire.io/">Hangfire</a> or a similar library that can be used to write background tasks on your own ASP.NET site. </li><li>  Cloud: <a href="https://docs.microsoft.com/ru-ru/azure/app-service-web/websites-webjobs-resources">Azure WebJobs Azure</a> web job.  Own service in Azure, which can be used to run background tasks outside of your web site with the ability to scale the load. </li><li>  Advanced: <a href="https://docs.microsoft.com/ru-ru/azure/cloud-services/cloud-services-choose-me">Azure web role in cloud services</a> .  A service that allows you to run background tasks regardless of your site, with the ability to scale the load and control execution. </li></ul><br>  You can find a large number of articles and videos online on how to use Azure tasks and how web roles work in Azure cloud services.  But not many articles on how to run background tasks on your own server. <br><br><h3>  <a href="https://github.com/NUGET/WEBBACKGROUNDER">WEBBACKGROUNDER</a> </h3><br>  As it is written on the site: "WebBackgrounder is a test of the concept of a web farm-compatible background task manager, which should work only with ASP.NET web applications."  Its code has not changed for many years, but the <a href="https://www.nuget.org/packages/webbackgrounder">NuGet package has</a> been downloaded more than half a million times. <br><br>  The project allows you to work with only one task, to manage repetitive tasks in the background while the web application is running. <br><br>  This library is clearly not for all occasions.  But if during the work of an ASP.NET application you need to run only one task, then WebBackgrounder is all you need. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> WebBackgrounder.DemoWeb { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleJob</span></span></span><span class="hljs-class"> :</span></span> Job { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SampleJob</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TimeSpan interval, TimeSpan timeout)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Sample Job"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, interval, timeout)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task(() =&gt; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>)); } } }</code> </pre> <br><h3>  Added to .NET 4.5.2 QUEUEBACKGROUNDWORKITEM </h3><br>  You can say that QueueBackgroundWorkItem was added in .NET 4.5.2 in response to the appearance of WebBackgrounder.  This is not just an implementation of Task.Run.  This is something more: <br><br>  QBWI manages scheduled tasks that must be run in the background, regardless of any request.  The difference with the usual ThreadPool element is that ASP.NET automatically keeps track of how many work items registered using the API are currently running, and if the application domain is turned off, the ASP.NET runtime tries to delay it, making it possible for the running background to finish. tasks. <br><br>  Be aware that the ASP.NET runtime environment may delay the application domain shutdown by as little as 90 seconds, giving you the opportunity to complete tasks.  Therefore, if you cannot complete the tasks in that time, then you need to use other, more reliable means. <br><br>  The API is very simple - it uses ‚ÄúFunc &lt;CancellationToken, Task&gt;‚Äù.  Next, a small example that runs the background process from the MVC controller: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([Bind(Include = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Name,Email"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)] User user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { HostingEnvironment.QueueBackgroundWorkItem(ct =&gt; SendMailAsync(user.Email)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, <span class="hljs-string"><span class="hljs-string">"Home"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> </pre> <br><h3>  <a href="https://github.com/jgeurts/FluentScheduler">FLUENTSCHEDULER</a> </h3><br>  FluentScheduler is a more advanced and complex task manager with a fluent interface.  With it, you can really manage the process of starting a task. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> FluentScheduler; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyRegistry</span></span></span><span class="hljs-class"> :</span></span> Registry { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyRegistry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ITask     Schedule&lt;MyTask&gt;().ToRunNow().AndEvery(2).Seconds(); //       Schedule(() =&gt; Console.WriteLine("Timed Task - Will run every day at 9:15pm: " + DateTime.Now)).ToRunEvery(1).Days().At(21, 15); //     ‚Äì        Schedule(() =&gt; { Console.WriteLine("Complex Action Task Starts: " + DateTime.Now); Thread.Sleep(1000); Console.WriteLine("Complex Action Task Ends: " + DateTime.Now); }).ToRunNow().AndEvery(1).Months().OnTheFirst(DayOfWeek.Monday).At(3, 0); } }</span></span></code> </pre><br>  FluentScheduler also supports IoC and can easily connect using your favorite Dependency Injection library, simply by implementing its ITaskFactory interface. <br><br>  It should be noted that FluentScheduler can work with .NET Core. <br><br>  You can use the JobException event of the JobManager object to handle exceptions that occur in background tasks.  The event allows you to get information about the exception that occurred in the task. <br><br><pre> <code class="cpp hljs">JobManager.JobException += (info) =&gt; Log.Fatal(<span class="hljs-string"><span class="hljs-string">"An error just happened with a scheduled job: "</span></span> + info.Exception);</code> </pre><br><h3>  <a href="https://www.quartz-scheduler.net/">QUARTZ.NET</a> </h3><br>  Quartz.NET is a version of the popular Java framework implemented in .NET.  The framework is actively developing.  To create a background task in Quartz, the IJob interface is used with a single Execute method, which must be implemented. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Quartz; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Quartz.Impl; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> ScheduledTaskExample.ScheduledTasks { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JobScheduler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IScheduler scheduler = StdSchedulerFactory.GetDefaultScheduler(); scheduler.Start(); IJobDetail job = JobBuilder.Create&lt;MyJob&gt;().Build(); ITrigger trigger = TriggerBuilder.Create() .WithDailyTimeIntervalSchedule (s =&gt; s.WithIntervalInHours(<span class="hljs-number"><span class="hljs-number">24</span></span>) .OnEveryDay() .StartingDailyAt(TimeOfDay.HourAndMinuteOfDay(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) ) .Build(); scheduler.ScheduleJob(job, trigger); } } }</code> </pre> <br>  To run the manager inside Application_Start, call JobScheduler.Start ().  To get started, you can read the <a href="http://metanit.com/sharp/mvc5/24.1.php">Schedule Actions and Quartz.NET</a> (translation <a href="https://www.mikesdotnetting.com/article/254/scheduled-tasks-in-asp-net-with-quartz-net">Scheduled Tasks In ASP.NET With Quartz.Net</a> ). <br><br>  The project has quite decent documentation which should be read before use (at least it is worth reviewing the <a href="https://www.quartz-scheduler.net/documentation/quartz-2.x/tutorial/index.html">Tutorials for Developing with Quartz</a> ). <br><br><h3>  <a href="http://hangfire.io/">HANGFIRE</a> </h3><br>  And the last one in the review, but certainly not the last in terms of functionality, the most advanced of all Hangfire.  This is really a very advanced framework for background tasks in ASP.NET.  Optionally, it can use Redis, SQL Server, SQL Azure, MSMQ or RabbitMQ to increase the reliability of task execution. <br><br>  <a href="http://docs.hangfire.io/en/latest/index.html">The Hangfire documentation is</a> really excellent.  I would like every open source project to have such documentation. <br><br>  One of the most impressive features of the Hangfire is a built-in dashboard that allows you to view schedules, tasks in progress, and successful and unsuccessfully completed tasks. <br><br>  Hangfire makes it easy to define tasks like "start and forget", information about which will be stored in the database: <br><br><pre> <code class="cpp hljs">BackgroundJob.Enqueue(() =&gt; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Fire-and-forget"</span></span>));</code> </pre> <br>  You can delay the execution of the task: <br><br><pre> <code class="cpp hljs">BackgroundJob.Schedule(() =&gt; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Delayed"</span></span>), TimeSpan.FromDays(<span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br>  Or run a task in CRON style <br><br><pre> <code class="hljs coffeescript">RecurringJob.AddOrUpdate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> Console.Write(<span class="hljs-string"><span class="hljs-string">"Recurring"</span></span>), Cron.Daily);</code> </pre> <br>  Working with Hangfire is very convenient.  Hangfire has good documentation and <a href="http://docs.hangfire.io/en/latest/tutorials/highlight.html">tutorials</a> based on real-world examples. <br><br>  Hangfire is a whole ecosystem for working with background tasks in ASP.NET applications. <br><br>  Libraries are available as open source or Nuget packages. <br><br><h3>  Results (personally) </h3><br>  Choosing a library for myself, on the one hand, I want to have decent functionality, and on the other hand, I don‚Äôt want to use, for example, a database to store information about running tasks.  Therefore, I did not even consider simple solutions like WebBackgrounder or QueueBackgroundWorkItem. <br><br>  I already know that I need to run more than one process, and the processes can work for a long time (90 seconds limit on completion in QueueBackgroundWorkItem).  FluentScheduler looks good, but I wanted more.  Hangfire is an excellent solution, but it seems that it immediately requires the use of a database to store the task queue.  Yes, and not quite there for free - there is a paid version. <br><br>  In the end, I chose Quartz.NET for now: quite decent documentation, enough examples to quickly start using, as well as extensible functionality that can be added as the needs increase. <br><br>  If you know other libraries to run background tasks or have experience solving similar problems - share in the comments. </div><p>Source: <a href="https://habr.com/ru/post/321502/">https://habr.com/ru/post/321502/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321490/index.html">Machine search for anomalies in the behavior of online stores and buyers</a></li>
<li><a href="../321492/index.html">New formula for role-playing games</a></li>
<li><a href="../321494/index.html">Cognitive Services & LUIS: An Introduction to Natural Language Recognition</a></li>
<li><a href="../321498/index.html">How to "pump" the designer: tips and useful links from Russian experts</a></li>
<li><a href="../321500/index.html">In preparation for an IPO, Snapchat protects its code and reputation from Facebook's ‚Äúharassment‚Äù</a></li>
<li><a href="../321504/index.html">Rare SQL</a></li>
<li><a href="../321506/index.html">Virtual reality in real estate: case</a></li>
<li><a href="../321508/index.html">Wit and courage: how we were wrong many times when creating iFunny</a></li>
<li><a href="../321510/index.html">Python: Working with a Database, Part 1/2: Using DB-API</a></li>
<li><a href="../321518/index.html">Mahou - Magic Layout Switch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>