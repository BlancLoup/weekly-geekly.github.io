<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony and command bus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For more than a year I have been using the Command Bus pattern in my symfony projects and finally decided to share my experience. In the ends, it‚Äôs a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony and command bus</h1><div class="post__text post__text-html js-mediator-article">  For more than a year I have been using the <em>Command Bus</em> pattern in my symfony projects and finally decided to share my experience.  In the ends, it‚Äôs a shame that in Laravel it is ‚Äúout of the box‚Äù, and in Symfony, from which Laravel has grown in many ways - no, although the very concept of <a href="http://martinfowler.com/bliki/CommandQuerySeparation.html">Command / Query Separation</a> has been at least 10 years old.  And if with the letter ‚ÄúQ‚Äù from the abbreviation ‚ÄúCQRS‚Äù it is still clear what to do (personally I am quite satisfied with custom repositories), then where to stick the letter ‚ÄúC‚Äù is unclear. <br><br>  In fact, even in banal CRUD applications, the Command Bus has obvious advantages: <br><br><ul><li>  controllers become "thin" (rare "action" takes more than 15 lines), </li><li>  business logic leaves controllers and becomes as independent as possible from the framework (as a result, it is easy to reuse in other projects, even if they are not written in symfony), </li><li>  simplified unit testing of business logic, </li><li>  code duplication is reduced (when, for example, you need to implement a feature through both the Web UI and the API). </li></ul><br><img src="https://habrastorage.org/files/a85/803/f0a/a85803f0aa724e9385e799f085634f02.png" alt="KDPV"><br><a name="habracut"></a><br><h1>  Scenery </h1><br>  Suppose we have an application in which you can register certain projects.  The project as an entity includes: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  mandatory name </li><li>  optional description. </li></ul><br>  Code implemented using native symfony documentation might look something like this: <br><br><div class="spoiler">  <b class="spoiler_title">Entity</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bridge</span></span>\<span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Constraints</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="projects") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Entity * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\UniqueEntity(fields={"name"}, message="     .") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Project</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_NAME = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_DESCRIPTION = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int ID. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string  . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="name", type="string", length=25) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string  . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="description", type="string", length=100, nullable=true) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $description; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">The form</b> <div class="spoiler_text">  namespace AppBundle \ Form; <br><br>  use AppBundle \ Entity \ Project; <br>  use Symfony \ Component \ Form \ AbstractType; <br>  use Symfony \ Component \ Form \ Extension \ Core \ Type \ TextType; <br>  use Symfony \ Component \ Form \ FormBuilderInterface; <br>  use Symfony \ Component \ Validator \ Constraints; <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectForm</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormBuilderInterface $builder, array $options)</span></span></span><span class="hljs-function"> </span></span>{ $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, TextType::class, [ <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'attr'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'maxlength'</span></span> =&gt; Project::MAX_NAME], <span class="hljs-string"><span class="hljs-string">'constraints'</span></span> =&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Constraints\NotBlank(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Constraints\Length([<span class="hljs-string"><span class="hljs-string">'max'</span></span> =&gt; Project::MAX_NAME]), ], ]); $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'description'</span></span>, TextType::class, [ <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'attr'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'maxlength'</span></span> =&gt; Project::MAX_DESCRIPTION], <span class="hljs-string"><span class="hljs-string">'constraints'</span></span> =&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Constraints\Length([<span class="hljs-string"><span class="hljs-string">'max'</span></span> =&gt; Project::MAX_DESCRIPTION]), ], ]); } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlockPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'project'</span></span>; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Controller (project creation)</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">ProjectForm</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sensio</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkExtraBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Configuration</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    ,     "". * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Route("/new") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Method({"GET", "POST"}) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $project = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Project(); $form = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createForm(ProjectForm::class, $project); $form-&gt;handleRequest($request); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($form-&gt;isValid()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getManager()-&gt;persist($project); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getManager()-&gt;flush(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redirectToRoute(<span class="hljs-string"><span class="hljs-string">'projects'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'project/form.html.twig'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'form'</span></span> =&gt; $form-&gt;createView(), ]); } }</code> </pre><br></div></div><br>  I brought this controller more for comparison - this is how it looks from the point of view of symfony documentation.  In fact, ‚Äúweb 2.0‚Äù won long ago, the teammate sculpts the ‚Äúfrontend‚Äù of the project on Angular, and the forms of course arrive in AJAX requests. <br><br><div class="spoiler">  <b class="spoiler_title">Therefore, the controller looks different.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">ProjectForm</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sensio</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkExtraBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Configuration</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">JsonResponse</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *  HTML- . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Route("/new", condition="request.isXmlHttpRequest()") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Method("GET") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showNewFormAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $form = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createForm(ProjectForm::class, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, [ <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;generateUrl(<span class="hljs-string"><span class="hljs-string">'new_project'</span></span>), ]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'project/form.html.twig'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'form'</span></span> =&gt; $form-&gt;createView(), ]); } <span class="hljs-comment"><span class="hljs-comment">/** *  "" . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Route("/new", name="new_project", condition="request.isXmlHttpRequest()") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Method("POST") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $project = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Project(); $form = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createForm(ProjectForm::class, $project); $form-&gt;handleRequest($request); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($form-&gt;isValid()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getManager()-&gt;persist($project); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getManager()-&gt;flush(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $error = $form-&gt;getErrors(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)-&gt;current(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($error-&gt;getMessage(), JsonResponse::HTTP_BAD_REQUEST); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">"View" form</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{ form_start(form) }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form_row(form.name) }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form_row(form.description) }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ form_end(form) }}</span></span><span class="xml"></span><span class="xml"></span></code> </pre></div></div><br><h1>  Simplebus </h1><br>  There are many implementations of the <em>Command Bus</em> for PHP ‚Äî from ‚Äúthephpleague‚Äù to straightforward NIH bikes.  Personally, I liked the version from Matthias Noback (he has a <a href="http://php-and-symfony.matthiasnoback.nl/tags/SimpleBus/">series of articles</a> on <em>Command Bus</em> on his blog) - <a href="https://packagist.org/packages/simple-bus/message-bus">SimpleBus</a> .  The library does not depend on a specific framework and can be used in any PHP project.  To facilitate the integration of the library with symfony there is a <a href="https://packagist.org/packages/simple-bus/symfony-bridge">ready bundle</a> from the same author, and we will install it: <br><br><pre> <code class="hljs perl">composer <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> simple-bus/symfony-bridge</code> </pre><br>  Any command is nothing more than the structure of input data, the processing of which is in a separate handler.  Bundle adds a new service <code>command_bus</code> , which calls the previously registered handlers. <br><br>  Let's try to "refactor" our "action" to create a new project.  The HTML form is not the only possible source of input data (the project can be created through the API, or the appropriate message in the SOA system, or ... but how else), so I deliberately move the data validation closer to the business logic itself (part of which is validation and is), i.e.  from form to command handler.  In general, for any number of entry points, we go to the same handler, which performs validation.  In case of validation errors (and any others), we will escalate the errors back as exceptions.  As a result, any ‚Äúaction‚Äù is a short try-catch, in which we convert the data from the request into a command, call the handler, and then return ‚Äú200 OK‚Äù;  The <code>catch</code> section returns the HTTP code "4xx" with a specific error message.  Let's see how it looks in business: <br><br><h4>  The form </h4><br>  Here we just throw away the validation, otherwise the form has not changed. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectForm</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormBuilderInterface $builder, array $options)</span></span></span><span class="hljs-function"> </span></span>{ $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, TextType::class, [ <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Project name'</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'attr'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'maxlength'</span></span> =&gt; Project::MAX_NAME], ]); $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'description'</span></span>, TextType::class, [ <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Project description'</span></span>, <span class="hljs-string"><span class="hljs-string">'required'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'attr'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'maxlength'</span></span> =&gt; Project::MAX_DESCRIPTION], ]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlockPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'project'</span></span>; } }</code> </pre><br><h4>  Team </h4><br>  And here the validation appears on the contrary. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">SimpleBus</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Constraints</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Create new project. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $name Project name. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $description Description. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateProjectCommand</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\NotBlank() * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\Length(max = "25") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\Length(max = "100") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $description; }</code> </pre><br><h4>  Command handler </h4><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">SimpleBus</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>\<span class="hljs-title"><span class="hljs-title">Handler</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">SimpleBus</span></span>\<span class="hljs-title"><span class="hljs-title">Project</span></span>\<span class="hljs-title"><span class="hljs-title">CreateProjectCommand</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bridge</span></span>\<span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">RegistryInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpKernel</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">BadRequestHttpException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">ValidatorInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateProjectCommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $validator; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $doctrine; <span class="hljs-comment"><span class="hljs-comment">/** * Dependency Injection constructor. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ValidatorInterface $validator * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> RegistryInterface $doctrine */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidatorInterface $validator, RegistryInterface $doctrine)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validator = $validator; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine = $doctrine; } <span class="hljs-comment"><span class="hljs-comment">/** * Creates new project. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> CreateProjectCommand $command * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> BadRequestHttpException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CreateProjectCommand $command)</span></span></span><span class="hljs-function"> </span></span>{ $violations = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validator-&gt;validate($command); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($violations) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { $error = $violations-&gt;get(<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;getMessage(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BadRequestHttpException($error); } $entity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Project(); $entity -&gt;setName($command-&gt;name) -&gt;setDescription($command-&gt;description); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine-&gt;getManager()-&gt;persist($entity); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine-&gt;getManager()-&gt;flush(); } }</code> </pre><br><h4>  Team Registration </h4><br>  In order for the <code>command_bus</code> found by our handler, it must be registered as a service, having marked with a special tag. <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">services:</span></span> command.project.<span class="hljs-symbol"><span class="hljs-symbol">create:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppBundle</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleBus</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Project</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateProjectCommandHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tags</span></span></span><span class="hljs-class">: [{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">command_handler</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handles</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppBundle</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleBus</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Projects</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateProjectCommand</span></span></span><span class="hljs-class"> }] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arguments</span></span></span><span class="hljs-class">: [ "@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validator</span></span></span><span class="hljs-class">", "@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">doctrine</span></span></span><span class="hljs-class">" ]</span></span></code> </pre><br><h4>  Controller </h4><br>  The <code>showNewFormAction</code> function <code>showNewFormAction</code> not changed at all ( <code>showNewFormAction</code> omit it for short), only <code>newAction</code> changed. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     "project".   "$request-&gt;request-&gt;all()". $data = $request-&gt;request-&gt;get('project'); $command = new CreateProjectCommand(); $command-&gt;name = $data['name']; $command-&gt;description = $data['description']; $this-&gt;container-&gt;get('command_bus')-&gt;handle($command); return new JsonResponse(); } catch (\Exception $e) { return new JsonResponse($e-&gt;getMessage(), $e-&gt;getStatusCode()); } } }</span></span></code> </pre><br>  If we calculate, we will see that the previous version of the ‚Äúaction‚Äù contained 12 lines of code, while the new version contains 11 lines.  But first, we just started (further it will be shorter and more elegant), and secondly, we have a spherical example in a vacuum.  In real life, the complication of business logic will ‚Äúinflate‚Äù the controller in the first case, and it will in no way affect it in the second. <br><br>  There is another interesting nuance.  Suppose a user has entered the name of an existing project.  In entity-class, we have a corresponding annotation, but the form still remains correct.  Because of this, in the first case, it is often necessary to fence additional error handling. <br><br>  In our command-version, when invoking <code>persist($entity)</code> , an exception will occur in the command handler - it will be created by the ORM itself, adding the message that we specified in the <code>Project</code> class annotation ( <em>‚ÄúA project with this name already exists‚Äù</em> ).  As a result, the action itself has not changed at all - we just catch any exception, no matter what level it occurs, and turn it into an ‚ÄúHTTP 400 ‚Ä≥. <br><br>  By the way, on Habr√© (and not only) a lot of copies on the subject of ‚Äúexception against errors‚Äù have already been broken.  For example, in <a href="https://habrahabr.ru/post/279501/">one of the last</a> similar articles, <a href="https://habrahabr.ru/users/alexleonov/" class="user_link">AlexLeonov</a> suggested something close to my approach (validation errors through exceptions), and judging by the comments on his article, I will also get it.  I urge this time not to holivarit, but to take for granted my weakness to the simplicity of the code, and forgive me if you can (there was a smiley face, but he was frightened by the moderators and disappeared). <br><br><h1>  Command autovalidation </h1><br>  If you look at the <code>handle</code> function in the command handler, you will notice that validation and processing of its result: <br><br><ul><li>  is about half the function code, </li><li>  obviously will be repeated from team to team, </li><li>  can easily be forgotten in the next handler. </li></ul><br>  Fortunately, <strong>SimpleBus</strong> supports ‚Äúmiddlewares‚Äù - intermediate functions that will be automatically called when processing any command.  There may be any number of middleware functions, you can force some of them to be called before commands, and others after, you can even assign priorities to them if the sequence of performing some middleware functions is important.  Obviously, it makes sense to wrap command validation into a middleware function and forget about it altogether. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">SimpleBus</span></span>\<span class="hljs-title"><span class="hljs-title">Middleware</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SimpleBus</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">Bus</span></span>\<span class="hljs-title"><span class="hljs-title">Middleware</span></span>\<span class="hljs-title"><span class="hljs-title">MessageBusMiddleware</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">ValidatorInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidationMiddleware</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageBusMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $logger; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $validator; <span class="hljs-comment"><span class="hljs-comment">/** * Dependency Injection constructor. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> LoggerInterface $logger * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ValidatorInterface $validator */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerInterface $logger, ValidatorInterface $validator)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validator = $validator; } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message, callable $next)</span></span></span><span class="hljs-function"> </span></span>{ $violations = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validator-&gt;validate($message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($violations) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { $error = $violations-&gt;get(<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;getMessage(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;error(<span class="hljs-string"><span class="hljs-string">'Validation exception'</span></span>, [$error]); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BadRequestHttpException($error); } $next($message); } }</code> </pre><br>  We register our middleware: <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">services:</span></span> middleware.<span class="hljs-symbol"><span class="hljs-symbol">validation:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppBundle</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleBus</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Middleware</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidationMiddleware</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tags</span></span></span><span class="hljs-class">: [{ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">command_bus_middleware</span></span></span><span class="hljs-class"> }] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arguments</span></span></span><span class="hljs-class">: [ "@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logger</span></span></span><span class="hljs-class">", "@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validator</span></span></span><span class="hljs-class">" ]</span></span></code> </pre><br>  Simplify the command handler (remember to remove the unnecessary dependency on the validator): <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateProjectCommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $doctrine; <span class="hljs-comment"><span class="hljs-comment">/** * Dependency Injection constructor. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> RegistryInterface $doctrine */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RegistryInterface $doctrine)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine = $doctrine; } <span class="hljs-comment"><span class="hljs-comment">/** * Creates new project. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> CreateProjectCommand $command */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CreateProjectCommand $command)</span></span></span><span class="hljs-function"> </span></span>{ $entity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Project(); $entity -&gt;setName($command-&gt;name) -&gt;setDescription($command-&gt;description); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine-&gt;getManager()-&gt;persist($entity); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;doctrine-&gt;getManager()-&gt;flush(); } }</code> </pre><br><h1>  Multiple validation errors </h1><br>  Many of you have probably wondered how to be if the result of validation is not one error, but a whole set.  Indeed, it is not the best idea to return them to the user one by one - I would like to mark all the incorrect form fields at once. <br><br>  This is probably the only ‚Äúnarrow‚Äù place of the approach.  I didn‚Äôt think of anything better than throwing a special exception with an array of errors.  My internal perfectionist suffers greatly from this, but maybe he is wrong, I will be glad to have soothing comments.  Also welcome if someone offers a better solution. <br><br>  For now, our own validation exception: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidationException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BadRequestHttpException</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $messages = []; <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $messages, $code = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, \Exception $previous = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;messages = $messages; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct(count($messages) ? reset(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;messages) : <span class="hljs-string"><span class="hljs-string">''</span></span>, $previous, $code); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;messages; } }</code> </pre><br>  Slightly fix our validating middleware: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidationMiddleware</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageBusMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message, callable $next)</span></span></span><span class="hljs-function"> </span></span>{ $violations = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validator-&gt;validate($message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($violations) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { $errors = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($violations <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $violation) { $errors[$violation-&gt;getPropertyPath()] = $violation-&gt;getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;error(<span class="hljs-string"><span class="hljs-string">'Validation exception'</span></span>, $errors); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException($errors); } $next($message); } }</code> </pre><br>  And of course, the controller itself (there is an additional <code>catch</code> section): <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $data = $request-&gt;request-&gt;get(<span class="hljs-string"><span class="hljs-string">'project'</span></span>); $command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateProjectCommand(); $command-&gt;name = $data[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]; $command-&gt;description = $data[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-string"><span class="hljs-string">'command_bus'</span></span>)-&gt;handle($command); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessages(), $e-&gt;getStatusCode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessage(), $e-&gt;getStatusCode()); } } }</code> </pre><br>  Now in case of a validation error, the action returns a JSON structure, where the keys are the names of the HTML elements, and the values ‚Äã‚Äãare the error messages for the corresponding fields.  For example, if you do not specify a project name and at the same time enter a too long description: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"    ."</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"    100 ."</span></span> }</code> </pre><br>  Actually, the keys will of course be the names of the properties in the command class, but we did not accidentally name them identically to the form fields.  However, the method of associating class properties with form fields can be completely arbitrary ‚Äî it's up to you how you will bind incoming messages to frontend elements.  For the ‚Äúseed‚Äù, here is an example of my error-handler for such an AJAX request: <br><br><pre> <code class="javascript hljs">$.ajax({ <span class="hljs-comment"><span class="hljs-comment">// ... error: function(xhr) { var response = xhr.responseJSON ? xhr.responseJSON : xhr.responseText; if (typeof response === 'object') { $.each(response, function(id, message) { var name = $('form').prop('name'); var $control = $('#' + name + '_' + id); if ($control.length === 0) { alert(message); } else { $control.after('&lt;p class="form-error"&gt;' + message + '&lt;/p&gt;'); } }); } else { alert(response); } }, beforeSend: function() { $('.form-error').remove(); } });</span></span></code> </pre><br><h1>  Autocomplete team </h1><br>  Each of our "action" begins with a request, from which we copy data to the team each time, in order to transfer it to processing.  After the first five actions, this copying starts to annoy and demand automation.  Let's write a trait that will add a constructor initializer to our commands: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> MessageTrait { <span class="hljs-comment"><span class="hljs-comment">/** *      . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $values     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $values = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($values <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $property =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, $property)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$property = $value; } } } }</code> </pre><br>  Is done.  The ‚Äúextra‚Äù values ‚Äã‚Äãwill be ignored, the missing ones will leave the corresponding properties of the object in the NULL state. <br><br>  Now the "action" may look like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $data = $request-&gt;request-&gt;get(<span class="hljs-string"><span class="hljs-string">'project'</span></span>); $command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateProjectCommand($data); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-string"><span class="hljs-string">'command_bus'</span></span>)-&gt;handle($command); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessages(), $e-&gt;getStatusCode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessage(), $e-&gt;getStatusCode()); } } }</code> </pre><br>  But what if we need to add some additional data besides the values ‚Äã‚Äãfrom the request object?  For example, in <code>editAction</code> will obviously be another parameter - the project ID.  And it is obvious that the corresponding command will be one more property: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Update specified project. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> int $id Project ID. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $name New name. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $description New description. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProjectCommand</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\NotBlank() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\NotBlank() * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\Length(max = "25") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Constraints</span></span></span><span class="hljs-comment">\Length(max = "100") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $description; }</code> </pre><br>  Let's add a second array with alternative values: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> MessageTrait { <span class="hljs-comment"><span class="hljs-comment">/** *      . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $values     . * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $extra     . *          . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $values = [], array $extra = [])</span></span></span><span class="hljs-function"> </span></span>{ $data = $extra + $values; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $property =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, $property)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$property = $value; } } } }</code> </pre><br>  Now our hypothetical <code>editAction</code> might look like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProjectController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *  HTML- . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Route("/edit/{id}", requirements={"id"="\d+"}, condition="request.isXmlHttpRequest()") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Method("GET") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showEditFormAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $project = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getRepository(Project::class)-&gt;find($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$project) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createNotFoundException(); } $form = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createForm(ProjectForm::class, $project, [ <span class="hljs-string"><span class="hljs-string">'action'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;generateUrl(<span class="hljs-string"><span class="hljs-string">'edit_project'</span></span>), ]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;render(<span class="hljs-string"><span class="hljs-string">'project/form.html.twig'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'form'</span></span> =&gt; $form-&gt;createView(), ]); } <span class="hljs-comment"><span class="hljs-comment">/** *  "" . * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Route("/edit/{id}", name="edit_project", requirements={"id"="\d+"}, condition="request.isXmlHttpRequest()") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Configuration</span></span></span><span class="hljs-comment">\Method("POST") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">editAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request, $id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $project = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getRepository(Project::class)-&gt;find($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$project) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createNotFoundException(); } $data = $request-&gt;request-&gt;get(<span class="hljs-string"><span class="hljs-string">'project'</span></span>); $command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UpdateProjectCommand($data, [<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $id]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-string"><span class="hljs-string">'command_bus'</span></span>)-&gt;handle($command); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessages(), $e-&gt;getStatusCode()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResponse($e-&gt;getMessage(), $e-&gt;getStatusCode()); } } }</code> </pre><br>  Almost everything is fine, but there is a nuance - if the user leaves the project description empty, an empty string will fly to us, which will eventually be saved to the database, although in such cases I would like to write to the <code>NULL</code> database.  Expand our trait a little more: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> MessageTrait { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $values = [], array $extra = [])</span></span></span><span class="hljs-function"> </span></span>{ $empty2null = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$empty2null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($value)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($value <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$v) { $v = $empty2null($v); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_string($value) &amp;&amp; strlen($value) === <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : $value; }; $data = $empty2null($extra + $values); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $property =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, $property)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$property = $value; } } } }</code> </pre><br>  Here we simply added an anonymous function (so as not to produce entities), which recursively (an array can be nested) passes through the original values ‚Äã‚Äãand changes empty lines to <code>NULL</code> . <br><br><h1>  Developments </h1><br>  In addition to <strong>SimpleBus</strong> commands, events are also able.  Strictly speaking, the difference between them is small.  They are implemented identically - you create the event class in the same way, but it can have many (or none at all) handlers (more precisely, subscribers).  Subscribers are registered in the same way as handlers (only with a slightly different tag), and they are managed by another special service implemented in <strong>SimpleBus</strong> - <code>event_bus</code> . <br><br>  Since both <code>simple_bus</code> and <code>event_bus</code> are normal symfony services, you can embed them as dependencies anywhere, including in your handlers.  For example, for a project creation team to send an event that a new project was created. <br><br><h1>  Instead of conclusion </h1><br>  In addition to the fact that we received ‚Äúskinny‚Äù controllers, we also simplified our unit-testing.  Indeed, it is much easier to test a single class handler, and you can ‚Äúlock‚Äù its dependencies, and you can implement real ones if your unit test inherits from <code>Symfony\Bundle\FrameworkBundle\Test\WebTestCase</code> .  At the same time, in any case, we no longer need to use a symfony crawler (which, by the way, slows down the tests noticeably) in order to trigger this or that action.  Honestly, now sometimes I don‚Äôt even cover ‚Äúactions‚Äù with tests, unless I check them for availability, as recommended by the Symfony documentation. <br><br>  Another indisputable advantage is that we essentially cut off our business logic from the framework (as far as possible, of course).  Necessary dependencies are implemented in handlers, and from which framework they come, it does not matter anymore.  One day, the <a href="http://www.php-fig.org/">FIG</a> will finish standardizing all the key interfaces, and we will be able to take our handlers and simply transfer them from under the hood of one framework under the hood of the other.  Even fragmentation of business logic by handlers will be a plus if one day the SOA bites you or your project. <br><br>  By the way, if you (like me) never wrote in Java, and a large number of short classes are not associated for you with the word ‚Äúharmony‚Äù, then you are not even obliged to keep each handler in a separate class (although I personally like it).  <strong>SimpleBus</strong> allows you to combine handlers into one class, so you can easily have class handlers for each entity whose functions will be handlers for specific operations. </div><p>Source: <a href="https://habr.com/ru/post/280512/">https://habr.com/ru/post/280512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280502/index.html">Using Open vSwitch with DPDK to transfer data between virtual machines with virtualization of network functions</a></li>
<li><a href="../280504/index.html">Hosting for a dollar</a></li>
<li><a href="../280506/index.html">Don't miss the online Build conference opening tonight (18:30 MCK)</a></li>
<li><a href="../280508/index.html">DevOps section at the DUMP-2016 conference</a></li>
<li><a href="../280510/index.html">What should be the email-list, and why users unsubscribe from them</a></li>
<li><a href="../280514/index.html">15 steps to improve usability</a></li>
<li><a href="../280516/index.html">Some immersion inside the hacked site</a></li>
<li><a href="../280518/index.html">Text translation of the Build 2016 conference</a></li>
<li><a href="../280520/index.html">The story of the creation of a classic RTS at home from scratch + analysis of the main stages of development (AI, network, etc.)</a></li>
<li><a href="../280524/index.html">QA: Conference. Many news, new reports, live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>