<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DDD-style Entities with Entity Framework Core</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about how to apply the principles of Domain-Driven Design (DDD) to the classes that the Entity Framework Core (EF Core) maps to a data...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DDD-style Entities with Entity Framework Core</h1><div class="post__text post__text-html js-mediator-article">  This article is about how to apply the principles of Domain-Driven Design (DDD) to the classes that the Entity Framework Core (EF Core) maps to a database, and why this might be useful. <br><br><h3>  Tldr </h3><br>  There are many advantages in the DDD approach, but the main thing is that DDD transfers the code of create / modify operations inside the entity class.  This significantly reduces the chances of the developer misinterpreting / interpreting the rules for creating, initializing, and using class instances. <br><a name="habracut"></a><br><ol><li>  In the book of Eric Evans and his speeches are not so much information on this subject: </li><li>  Provide the client with a simple model for obtaining permanent objects (classes) and managing their life cycle. </li><li>  Your entity classes must explicitly state whether they can be changed, exactly how, and by what rules. </li><li>  In DDD, there is the concept of aggregate.  An aggregate is a tree of related entities.  According to the DDD rules, work with aggregates should be carried out through the ‚Äúaggregation root‚Äù (the root essence of the tree). </li></ol><br>  Eric mentions repositories in his speeches.  I do not recommend implementing the repository with EF Core, because EF already implements the ‚Äúrepository‚Äù and ‚Äúunit of work‚Äù patterns by itself.  I describe this in more detail in the separate article ‚Äú <a href="https://www.thereformedprogrammer.net/is-the-repository-pattern-useful-with-entity-framework-core/">Should I use the repository together with EF Core</a> ‚Äù. <br><br><h3>  DDD style entities </h3><br>  I will start by showing the entity code in the DDD style and then comparing them with how they usually create entities with EF Core (the translator calls the ‚Äúusually‚Äù anemic model. ‚ÄùFor example, I will use the Internet database store selling books (a very simplified version of Amazon. "The structure of the database is shown in the image below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/7e3/03d/4be/7e303d4bea08c1f34afa0d9848a2ff72.png" alt="image"><br><br>  The first four tables represent everything about books: the books themselves, their authors, reviews.  The two tables at the bottom are used in the business logic code.  This topic is disclosed in detail in a separate article. <br><blockquote>  All code of this article is laid out in <a href="https://github.com/JonPSmith/EfCore.GenericBizRunner">GenericBizRunner</a> repository <a href="https://github.com/JonPSmith/EfCore.GenericBizRunner">on GitHub</a> .  In addition to the code of the GenericBizRunner library, there is another example of an ASP.NET Core application that uses GenericBizRunner to work with business logic.  More about this is written in the article "a <a href="https://www.thereformedprogrammer.net/a-library-to-run-your-business-logic-when-using-entity-framework-core/">library for working with business logic and the Entity Framework Core</a> ." </blockquote>  And here is the entity code corresponding to the database structure. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PromotionalTextLength = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BookId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ all other properties have a private set //These are the DDD aggregate propties: Reviews and AuthorLinks public IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); public IEnumerable&lt;BookAuthor&gt; AuthorsLink =&gt; _authorsLink?.ToList(); //private, parameterless constructor used by EF Core private Book() { } //public constructor available to developer to create a new book public Book(string title, string description, DateTime publishedOn, string publisher, decimal price, string imageUrl, ICollection&lt;Author&gt; authors) { //code left out } //now the methods to update the book's properties public void UpdatePublishedOn(DateTime newDate)‚Ä¶ public IGenericErrorHandler AddPromotion(decimal newPrice, string promotionalText)‚Ä¶ public void RemovePromotion()‚Ä¶ //now the methods to update the book's aggregates public void AddReview(int numStars, string comment, string voterName, DbContext context)‚Ä¶ public void RemoveReview(Review review)‚Ä¶ }</span></span></code> </pre> <br>  What to look for: <br><br><ol><li>  Line 5: set access to all properties of the entities is declared private.  This means that the data can be modified either by using the constructor, or by using the public methods described later in this article. </li><li>  Lines 9 and 10. Associated collections (the very aggregates from DDD) provide public access to IEnumerable &lt;T&gt;, not ICollection &lt;T&gt;.  This means that you cannot add or remove items from the collection directly.  You will have to use specialized methods from the Book class. </li><li>  Line 13. EF Core requires a non-parametric constructor, but it can have private access.  This means that another application code will not be able to bypass initialization and create instances of classes using a non-parametric constructor (note a translator. If you don‚Äôt of course create entities solely using reflection) </li><li>  Lines 16-20: The only way you can create an instance of the Book class is to use a public constructor.  This constructor contains all the necessary information to initialize the object.  Thus, the object is guaranteed to be in the allowed (valid) state. </li><li>  Lines 23-25: These lines are methods for changing the state of the book. </li><li>  Lines 28-29: These methods allow you to change related entities (aggregates) </li></ol><br>  The methods on lines 23-39 will be referred to as ‚Äúmethods providing access‚Äù.  These methods are the only way to change the properties and relationships within an entity.  In the bottom line, the Book class is ‚Äúclosed‚Äù.  It is created through a special constructor and can only be partially modified through special methods with suitable names.  This approach creates a sharp contrast with the standard approach to creating / modifying entities in EF Core, in which all entities contain an empty default constructor and all properties are declared public.  The next question is, why is the first approach better? <br><br><h3>  Comparing entity creation </h3><br>  Let's compare the code for obtaining data about several books from json and creating on their basis instances of the Book classes. <br><br><h3>  a.  Standard approach </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> price = (<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>) (bookInfoJson.saleInfoListPriceAmount ?? DefaultBookPrice) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book { Title = bookInfoJson.title, Description = bookInfoJson.description, PublishedOn = DecodePubishDate(bookInfoJson.publishedDate), Publisher = bookInfoJson.publisher, OrgPrice = price, ActualPrice = price, ImageUrl = bookInfoJson.imageLinksThumbnail }; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; book.AuthorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BookAuthor&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> author <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bookInfoJson.authors) { book.AuthorsLink.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor { Book = book, Author = authorDict[author], Order = i++ }); }</code> </pre><br><h3>  b.  DDD style </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authors = bookInfoJson.authors.Select(x =&gt; authorDict[x]).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book(bookInfoJson.title, bookInfoJson.description, DecodePubishDate(bookInfoJson.publishedDate), bookInfoJson.publisher, ((<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>?)bookInfoJson.saleInfoListPriceAmount) ?? DefaultBookPrice, bookInfoJson.imageLinksThumbnail, authors);</code> </pre><br>  Code constructor code Book <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Book</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, DateTime publishedOn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> publisher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> imageUrl, ICollection&lt;Author&gt; authors</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(title)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(title)); Title = title; Description = description; PublishedOn = publishedOn; Publisher = publisher; ActualPrice = price; OrgPrice = price; ImageUrl = imageUrl; _reviews = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Review&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authors == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !authors.Any()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( <span class="hljs-string"><span class="hljs-string">"You must have at least one Author for a book"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(authors)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> order = <span class="hljs-number"><span class="hljs-number">0</span></span>; _authorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;BookAuthor&gt;( authors.Select(a =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, a, order++))); }</code> </pre><br>  What to look for: <br><br><ol><li>  Lines 1-2: the constructor forces you to transfer all the data necessary for proper initialization. </li><li>  Lines 5, 6, and 17-9: the code contains several checks of business rules.  In this particular case, violation of the rules is considered as an error in the code, so in case of violation, an exception will be thrown.  If the user could correct these errors, perhaps I would use a static factory that returns Status &lt;T&gt; (comment of the translator. I would use Option &lt;T&gt; or Result &lt;T&gt; as the more widely used name).  Status is a type that returns a list of errors. </li><li>  Lines 21-23: The BookAuthor link is created in the constructor.  The BookAuthor constructor can be declared with the access level internal.  This way we can prevent the creation of links outside of DAL. </li></ol><br>  As you can see, the amount of code to create an entity is about the same in both cases.  So why is the DDD style better?  The DDD style is better because: <br><br><ol><li>  Controls access.  Random property change is excluded.  Any change occurs through the constructor or public method with the appropriate name.  It is quite obvious what is happening. </li><li>  Complies with DRY (don't repeat yourself).  You may need to create Book instances in several places.  The assignment code is in the constructor and you do not have to repeat it in several places. </li><li>  Hides complexity.  There are two properties in the Book class: ActualPrice and OrgPrice.  Both of these values ‚Äã‚Äãshould be equal when creating a new book.  In a standard approach, every developer should be aware of this.  In the DDD approach, it‚Äôs enough for the Book class developer to know about it.  The rest will know about this rule, because it is explicitly written in the constructor. </li><li>  Hides the creation of an aggregate.  In the standard approach, the developer must manually create an instance of BookAuthor.  In DDD style, this complexity is encapsulated for calling code. </li><li>  Allows properties to have private write access </li><li>  One of the reasons for using DDD is to lock an entity, i.e.  Do not give the ability to change properties directly.  Let's compare the change operation with and without DDD. </li></ol><br><h3>  Property change comparison </h3><br>  One of the main advantages of DDD-style entities is that Eric Evans calls the following: ‚ÄúThey clearly describe the rules for accessing an object‚Äù. <br><blockquote>  Note  translator.  The original phrase is difficult to translate into Russian.  In this case, design decisions are decisions made about how the software should work.  It is understood that the decisions were discussed and confirmed.  Code with constructors that correctly initialize entities and methods with correct names, reflecting the meaning of operations, explicitly informs the developer that assignments of certain values ‚Äã‚Äãare made intentionally, not by mistake, and are not a whim of another developer or implementation details. </blockquote>  I understand this phrase as follows. <br><br><ol><li>  Make it obvious how to change the data inside the entity and what data should change together. </li><li>  Make it obvious when you do not need to change certain data in essence. </li></ol>  Let's compare the two approaches.  The first example is simple, and the second is more complicated. <br><br><h3>  1. Change the publication date </h3><br>  Suppose we want to first work with a draft of a book and only then publish it.  At the time the draft is created, the estimated publication date is set, which is very likely to be changed during the editing process.  To store the publication date, we will use the PublishedOn property. <br><br><h3>  a.  Entity with public properties </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.PublishedOn = dto.PublishedOn; context.SaveChanges();</code> </pre><br><h3>  b.  Essence in DDD style </h3><br>  In the DDD style, the setter properties are declared private, so we will use a specialized access method. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.UpdatePublishedOn( dto.PublishedOn); context.SaveChanges();</code> </pre><br>  These two cases are almost the same.  The DDD option is even slightly longer.  But the difference is still there.  In the DDD style, you know for sure that the publication date can be changed, because there is a method with an obvious name.  You also know that you cannot change the publisher because there is no appropriate method for the Publisher property to change.  This information will be useful to any programmer working with a book class. <br><br><h3>  2. Manage a discount for a book </h3><br>  Another requirement is that we should be able to manage discounts.  The discount consists of a new price and a comment, for example, ‚Äú50% by the end of this week!‚Äù <br><br>  The implementation of this rule is simple, but not too obvious. <br><br><ol><li>  The OrgPrice property is the price without discount. </li><li>  ActualPrice - the current price at which the book is sold.  If the discount is valid, then the current price will differ from OrgPrice on the size of the discount.  If not, then the value of the properties will be equal. </li><li>  The PromotionText property must contain the text of the discount if the discount is applied or null if the discount is not currently applied. </li></ol><br>  The rules are pretty obvious to the one who implemented them.  However, for another developer, say, developing a UI to add a discount.  Adding the AddPromotion and RemovePromotion methods to an entity class hides implementation details.  Now another developer has public methods with corresponding names.  The semantics of using methods is obvious. <br><br>  Let's look at the implementation of the AddPromotion and RemovePromotion methods. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IGenericErrorHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newPrice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> promotionalText</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericErrorHandler(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(promotionalText)) { status.AddError( <span class="hljs-string"><span class="hljs-string">"You must provide some text to go with the promotion."</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(PromotionalText)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } ActualPrice = newPrice; PromotionalText = promotionalText; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; }</code> </pre><br>  What to look for: <br><br><ol><li>  Lines 4 -10: the addition of a PromotionalText comment is required.  The method checks that the text is not empty.  Since  This error can be corrected by the user. The method returns a list of errors to correct. </li><li>  Lines 12, 13: The method sets the property values ‚Äã‚Äãaccording to the implementation that the developer chose.  The user of the AddPromotion method does not need to know them.  To add a discount, simply write: </li></ol><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = book.AddPromotion(newPrice, promotionText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!status.HasErrors) context.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status;</code> </pre><br>  The RemovePromotion method is much simpler: it does not involve error handling.  Therefore, the return value is simply void. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemovePromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ActualPrice = OrgPrice; PromotionalText = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  These two examples are very different from each other.  In the first example, changing the PublishOn property is so simple that the standard implementation is quite appropriate.  In the second example, the implementation details are not obvious to someone who did not work with the Book class.  In the second case, the DDD-style with specialized access methods hides implementation details and makes the lives of other developers easier.  Also, in the second example, the code contains business logic.  As long as the amount of logic is small, we can store it directly in the access methods and return a list of errors if the method is not used correctly. <br><br><h3>  3. Work with the unit - property-collection Reviews </h3><br>  DDD offers to work with the unit only through the root.  In our case, the Reviews property creates problems.  Even if setter is declared private, the developer can still add or remove objects using the add and remove methods or even call the clear method to clear the entire collection.  This is where the new EF Core feature will help us - <a href="https://docs.microsoft.com/ru-ru/ef/core/modeling/backing-field">backing fields</a> . <br><br>  Backing field allows a developer to encapsulate a real collection and provide public access to the IEnumerable &lt;T&gt; interface reference.  IEnumerable &lt;T&gt; does not provide add, remove, or clear methods.  In the code below, an example of using backing fields. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashSet&lt;Review&gt; _reviews; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ rest of code not shown }</span></span></code> </pre><br>  For this to work, you need to tell EF Core that when reading from a database, you need to write to a private field, and not a public property.  The configuration code is shown below. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;Book&gt;() .FindNavigation(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Book.Reviews)) .SetPropertyAccessMode(PropertyAccessMode.Field); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ other non-review configurations left out }</span></span></code> </pre><br>  To work with reviews, I added two methods: AddReview and RemoveReview to the book class.  The AddReview method is more interesting.  Here is his code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddReview</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numStars, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> comment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> voterName, DbContext context = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_reviews != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _reviews.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context), <span class="hljs-string"><span class="hljs-string">"You must provide a context if the Reviews collection isn't valid."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Entry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).IsKeySet) { context.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName, BookId)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Could not add a new review."</span></span>); } }</code> </pre><br>  What to look for: <br><br><ol><li>  Lines 4-7: I intentionally do not initialize the _reviews field in a private non-parametric constructor that EF Core uses when loading entities from the database.  This allows my code to determine if the collection was loaded using the .Include (p =&gt; p.Reviews) method.  In a public constructor, I initialize the field, so that NRE does not happen when working with the created entity. </li><li>  Lines 8-12: If the Reviews collection was not loaded, the code should use DbContext for initialization. </li><li>  Lines 13-16: If the book was successfully created and contains an ID, then I use another technique for adding a review: I simply set the foreign key in the Review instance and write to the database.  More on this is written in section 3.4.5 of my book. </li><li>  Line 19: If we are here, then there is some problem with the logic of the code.  Therefore, I throw an exception. </li></ol><br>  I designed all my access methods for reversed the case when only the root entity is loaded.  How to update the unit is left to the discretion of the methods.  You may need to load additional entities. <br><br><h3>  Conclusion </h3><br>  To create DDD-style entities with EF Core, you must follow these rules: <br><br><ol><li>  Create public constructors to create correctly initialized instances of classes.  If during the creation process errors can occur that the user can correct, create an object not using a public constructor, but using a factory method that returns Status &lt;T&gt;, where T is the type of entity being created </li><li>  All properties setters are private.  Those.  all properties are read-only outside the class. </li><li>  For the navigation properties of collections, declare the backing fields, and the type of the public property declare IEnumerable &lt;T&gt;.  This will not allow other developers to uncontrollably modify collections. </li><li>  Instead of public setters, create public methods for all allowed object modification operations.  These methods should return void if the operation cannot complete with an error that the user can fix or Status &lt;T&gt; if they can. </li><li>  The scope of responsibility of the entity matters.  I think it's best to limit entities to changing the class itself and other classes inside the aggregate, but not outside.  Validation rules should be limited to validating the creation and change of state of entities.  Those.  I do not check business rules such as stock balance.  To do this, there is a special code of business logic. </li><li>  State-changing methods should assume that only the aggregation root is loaded.  If a method needs to load other data, it must take care of this itself. </li><li>  State-changing methods should assume that only the aggregation root is loaded.  If a method needs to load other data, it must take care of this itself.  This approach simplifies the use of entities by other developers. </li></ol><br><h3>  Pros and cons of DDD entities when working with EF Core </h3><br>  I like a critical approach to any pattern or architecture.  That's what I think about using DDD entities. <br><br><h3>  pros </h3><br><ol><li>  Using specialized methods for state change is a cleaner approach.  This is definitely a good solution, simply because the correctly named methods reveal the intent of the code much better and make it obvious what can be changed and what is not.  In addition, methods can return a list of errors if the user can correct them. </li><li>  Changing aggregates only through the root also works well. </li><li>  The details of the one-to-many communication between the Book and Review classes are now hidden to the user.  Encapsulation is the basic principle of OOP. </li><li>  Using specialized constructors allows you to make sure that the entities are created and guaranteed to be correctly initialized. </li><li>  Moving the initialization code to the constructor significantly reduces the likelihood that the developer does not correctly interpret how the class should be initialized. </li></ol><br><h3>  Minuses </h3><br><ol><li>  My approach contains dependencies on the implementation of EF Core. </li><li>  Some people even call it the anti-pattern.  The problem is that the entities of the subject model now depend on the database access code.  In DDD terms, this is bad.  I realized that if I had not done this, I would have to rely on the fact that the calling code knows what needs to be loaded.  This approach breaks the principle of separation of concerns. </li><li>  DDD makes writing more code. </li></ol><br>  Is it really worth it in simple cases, like updating a book's publication date? <br>  As you can see, I like the DDD approach.  However, it took me some time to structure it correctly, but at the moment the approach has already settled down and I apply it in the projects I work on.  I have already managed to try this style in small projects and am satisfied, but all the pros and cons are yet to be learned when I apply it in large projects. <br><br>  My decision to allow the use of EFCore-specific code in the arguments of the methods of the entities of the subject model was not easy.  I tried to prevent this from happening, but eventually I came to the conclusion that the calling code had to load a lot of navigation features.  And if this is not done, the change will simply not be applied without any errors (especially in a one-to-one relationship).  This was not acceptable to me, so I allowed the use of EF Core inside some methods (but not constructors). <br><br>  Another bad side is that DDD makes you write significantly more code for CRUD operations.  I'm still not sure whether to continue to eat cactus and write separate methods for all properties, or in some cases it is worth moving away from such a radical puritanism.  I know that there is just a car and a small truck of a boring CRUD, which is easier to write directly.  Only work on real projects will show what is best. <br><br><h3>  Other aspects of DDD not covered in this article. </h3><br>  The article was too long, so I'm going to finish here.  But, this means that there is still a lot of undisclosed material.  I already wrote about something, I will write about something in the near future.  Here is what is left behind: <br><br><ol><li>  <b>Business logic and DDD.</b>  I have been using DDD concepts in business logic code for several years now and using the new features of EF Core, I expect that I can transfer part of the logic to entity code.  Read the article "Again about the architecture of the business logic layer with the Entity Framework (Core and v6)" </li><li>  <b>DDD and repository pattern.</b>  Eric Evans recommends using a repository to abstract data access.    ,    ¬´¬ª   EF Core ‚Äì  .  Why?   -  . </li><li> <b> DBContext' /   (bounded contexts).</b>          DbContext'. ,   BookContext      Book        OrderContext,   . ,  ¬´ ¬ª  ,      .         ,         . </li></ol><br>       <a href="https://github.com/JonPSmith/EfCore.GenericBizRunner"> GenericBizRunner  GitHub</a> .      ASP.NET Core        Book.        .   in-memory Sqlite    ,       . <br><br>  ! </div><p>Source: <a href="https://habr.com/ru/post/432410/">https://habr.com/ru/post/432410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432400/index.html">CS: GO game became free</a></li>
<li><a href="../432402/index.html">Hey HR, where's my souvenir?</a></li>
<li><a href="../432404/index.html">Backup for Linux does not write letters</a></li>
<li><a href="../432406/index.html">DEV Labs 2018. Online MAP for C ++ developers. December 15</a></li>
<li><a href="../432408/index.html">Fintech-digest: preparation of switching off small banks from Visa and Mastercard, a pension calculator and not only</a></li>
<li><a href="../432412/index.html">Highload ++: How to help the ERP system cope with 500,000 requests per second</a></li>
<li><a href="../432414/index.html">Old secrets of quick debugging: source code animation</a></li>
<li><a href="../432416/index.html">Dependent Types - The Future of Programming Languages</a></li>
<li><a href="../432418/index.html">Parse lambda expressions in java</a></li>
<li><a href="../432420/index.html">Introducing Git Merge and Git Rebase: Why and When to Use Them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>