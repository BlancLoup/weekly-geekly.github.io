<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to run a Java application with multiple versions of the same library in 2017</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to run a Java application with multiple versions of the same library in 2017 





 I want to share solutions to one problem that I had to face, p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to run a Java application with multiple versions of the same library in 2017</h1><div class="post__text post__text-html js-mediator-article"><h1 id="kak-zapustit-java-prilozhenie-s-neskolkimi-versiyami-odnoy-biblioteki-v-2017-godu">  How to run a Java application with multiple versions of the same library in 2017 </h1><br><p><img src="https://habrastorage.org/webt/59/ce/1d/59ce1d1a8b4f3755482655.jpeg" alt="KDPV, nothing interesting"></p><br><p>  I want to share solutions to one problem that I had to face, plus researching this issue in the context of Java 9. </p><br><div class="spoiler">  <b class="spoiler_title">disclaimer</b> <div class="spoiler_text"><p>  The writer of me is still the one (I write for the first time), so throwing <del>  delicious </del>  tomatoes with reasons given is welcome. <br>  We will immediately agree that the article is not suitable as a guide for: </p><br><ul><li>  Java 9 </li><li>  Elasticsearch </li><li>  Maven </li></ul><br><p>  If the last names of the information in the network are complete, then the first one ... with time it will appear, at least <a href="http://openjdk.java.net/projects/jigsaw/spec/sotms/">there is the necessary information</a> . </p></div></div><br><p>  Imagine a simple situation: expand the Elasticsearch cluster and load data into it.  We are writing an application that searches in this cluster.  Since new versions of Elasticsearch are constantly being released, we bring new ones to the cluster. <del>  Problems </del>  features using rolling upgrade.  But here's a bad luck - at some point we changed the format of the stored data (for example, to make the most efficient use of some of the new features) and reindex it is not advisable to do so.  Such an option will suit us: we put a new cluster on the same machines - the first cluster with the old data scheme remains in place only for the search, and the incoming data is loaded into the second with the new scheme.  Then our search component will need to keep in touch 2 clusters. </p><a name="habracut"></a><br><p>  Our application uses the Java API to communicate with the cluster, which means that it draws Elasticsearch itself in dependencies.  It should be noted that the Rest Client was released along with the 5th version, which relieves us of such problems (as well as the convenient API of Elasticsearch itself), but we will move in time at the time of the 2nd version release. </p><br><p>  Let's look at possible solutions using a simple application as an example: searching for a document in 2 clusters of Elasticsearch 1.7 and 2.4.  The code is available on <a href="https://github.com/m31collision/elasticsearch-client-demo">github</a> , and repeats the structure of this article (only OSGi is missing). </p><br><p>  Let's get down to business.  Create a Maven project with the following structure: </p><br><pre><code class="hljs ruby">+---pom.xml +---core/ <span class="hljs-params"><span class="hljs-params">| +---pom.xml |</span></span> +---src/ <span class="hljs-params"><span class="hljs-params">| +---main/ |</span></span> <span class="hljs-params"><span class="hljs-params">| +---java/ |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> +---elasticsearch/ <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| +---client/ |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> +---SearchClient.java <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| +---Searcher.java |</span></span> <span class="hljs-params"><span class="hljs-params">| +---resources/ |</span></span> +---test/ <span class="hljs-params"><span class="hljs-params">| +---java/ +---es-v1/ |</span></span> +---pom.xml <span class="hljs-params"><span class="hljs-params">| +---src/ |</span></span> +---main/ <span class="hljs-params"><span class="hljs-params">| |</span></span> +---java/ <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| +---elasticsearch/ |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> +---client/ <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| +---v1/ |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> +---SearchClientImpl.java <span class="hljs-params"><span class="hljs-params">| |</span></span> +---resources/ <span class="hljs-params"><span class="hljs-params">| +---test/ |</span></span> +---java/ +---es-v2/ +---pom.xml +---src/ +---main/ <span class="hljs-params"><span class="hljs-params">| +---java/ |</span></span> <span class="hljs-params"><span class="hljs-params">| +---elasticsearch/ |</span></span> <span class="hljs-params"><span class="hljs-params">| +---client/ |</span></span> <span class="hljs-params"><span class="hljs-params">| +---v2/ |</span></span> <span class="hljs-params"><span class="hljs-params">| +---SearchClientImpl.java |</span></span> +---resources/ +---test/ +---java/</code> </pre> <br><p>  It is obvious that in one module it is impossible to connect several versions of one library, therefore the project should be multi-module: </p><br><ul><li>  <strong>core</strong> - here is all the application logic; </li><li>  it is possible (and necessary) to render interfaces for interaction with Elasticsearch into a separate module; </li><li>  <strong>es-v1</strong> - interface implementation for Elasticsearch 1.7.5; </li><li>  <strong>es-v2</strong> - interface implementation for Elasticsearch 2.4.5. </li></ul><br><p>  The <strong>core</strong> module contains the <code>Searcher</code> class, which is the "tester" of our <strong>es-v1</strong> and <strong>es-v2</strong> modules: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Searcher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ List&lt;SearchClient&gt; clients = Arrays.asList( getClient(<span class="hljs-string"><span class="hljs-string">"1"</span></span>), getClient(<span class="hljs-string"><span class="hljs-string">"2"</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SearchClient client : clients) { System.out.printf(<span class="hljs-string"><span class="hljs-string">"Client for version: %s%n"</span></span>, client.getVersion()); Map doc = client.search(<span class="hljs-string"><span class="hljs-string">"test"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"Found doc:"</span></span>); System.out.println(doc); System.out.println(); } clients.forEach(SearchClient::close); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SearchClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String desiredVersion)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// .  } }</span></span></code> </pre> <br><p>  Nothing supernatural: the version of Elasticsearch used by the module is displayed, and a test search is conducted through it - this will be enough for demonstration. </p><br><p>  Let's look at one of the implementations, the second one is almost identical: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchClientImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Settings settings = ImmutableSettings.builder() .put(<span class="hljs-string"><span class="hljs-string">"cluster.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"es1"</span></span>) .put(<span class="hljs-string"><span class="hljs-string">"node.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"es1"</span></span>) .build(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Client searchClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransportClient(settings) .addTransportAddress(getAddress()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> InetSocketTransportAddress </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InetSocketTransportAddress(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">9301</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getVersion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Version.CURRENT.number(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String term)</span></span></span><span class="hljs-function"> </span></span>{ SearchResponse response = searchClient.prepareSearch(<span class="hljs-string"><span class="hljs-string">"*"</span></span>) .setQuery(QueryBuilders.termQuery(<span class="hljs-string"><span class="hljs-string">"field"</span></span>, term)) .execute() .actionGet(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.getHits().getTotalHits() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.getHits().getAt(<span class="hljs-number"><span class="hljs-number">0</span></span>).getSource(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ searchClient.close(); } }</code> </pre> <br><p>  Everything is also simple: the current version is wired in Elasticsearch, and a search on the <code>field</code> in all indexes ( <code>*</code> ) returns the first found document, if any. </p><br><p>  The problem here lies in exactly how to call the <code>SearchClient</code> interface <code>SearchClient</code> in the <code>Searcher#getClient</code> and get the desired result. </p><br><h2 id="mozhet-byt-classforname">  Maybe Class.forName? </h2><br><p>  Even if you are not a Java expert, you have probably heard that <a href="https://docs.oracle.com/javase/9/docs/api/java/lang/ClassLoader.html">ClassLoader is dominant</a> .  It will not allow us to make our plans if left at the default, so this solution will not work in the least: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SearchClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String desiredVersion)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String className = String.format(<span class="hljs-string"><span class="hljs-string">"elasticsearch.client.v%s.SearchClientImpl"</span></span>, desiredVersion); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (SearchClient) Class.forName(className).newInstance(); }</code> </pre> <br><p>  We collect, run and see the result ... quite uncertain, for example, like this: </p><br><pre> <code class="hljs dos">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread "main" java.lang.IncompatibleClassChangeError: Implementing class <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.ClassLoader.defineClass1(Native Method) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.ClassLoader.defineClass(ClassLoader.java:<span class="hljs-number"><span class="hljs-number">763</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.security.SecureClassLoader.defineClass(SecureClassLoader.java:<span class="hljs-number"><span class="hljs-number">142</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.URLClassLoader.defineClass(URLClassLoader.java:<span class="hljs-number"><span class="hljs-number">467</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.URLClassLoader.access$<span class="hljs-number"><span class="hljs-number">100</span></span>(URLClassLoader.java:<span class="hljs-number"><span class="hljs-number">73</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.URLClassLoader$<span class="hljs-number"><span class="hljs-number">1</span></span>.run(URLClassLoader.java:<span class="hljs-number"><span class="hljs-number">368</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.URLClassLoader$<span class="hljs-number"><span class="hljs-number">1</span></span>.run(URLClassLoader.java:<span class="hljs-number"><span class="hljs-number">362</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.security.AccessController.doPrivileged(Native Method) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.URLClassLoader.findClass(URLClassLoader.java:<span class="hljs-number"><span class="hljs-number">361</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="hljs-number"><span class="hljs-number">424</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:<span class="hljs-number"><span class="hljs-number">331</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="hljs-number"><span class="hljs-number">357</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.Class.forName0(Native Method) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.Class.forName(Class.java:<span class="hljs-number"><span class="hljs-number">348</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> elasticsearch.client.Searcher.getClient(Searcher.java:<span class="hljs-number"><span class="hljs-number">28</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> elasticsearch.client.Searcher.main(Searcher.java:<span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre> <br><p>  Although I could throw a <code>ClassNotFoundException</code> ... or something else ... </p><br><p>  Since the <code>URLClassLoader</code> will find and load the first class with the specified name from the specified set of jar-files and directories, this will not necessarily be the required class.  In this case, this error occurs because the <code>elasticsearch-2.4.5.jar</code> library in the class-path <code>elasticsearch-2.4.5.jar</code> goes to <code>elasticsearch-1.7.5.jar</code> , so all classes (which match by name) will be loaded for 2.4.5 .  Since our Searcher first tries to load the module for Elasticsearch 1.7.5 ( <code>getClient("1")</code> ), the URLClassLoader will not load those classes at all ... </p><br><p>  When the class loader has classes intersecting by name (and therefore file names) classes, this state is called jar hell (or class-path hell). </p><br><h2 id="svoy-classloader">  Own ClassLoader </h2><br><p>  It becomes obvious that modules and their dependencies need to be spread across different class loaders.  Simply create a URLClassLoader for each <strong>es-v *</strong> module and specify each of its directory with jar-files: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SearchClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String desiredVersion)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String className = String.format(<span class="hljs-string"><span class="hljs-string">"elasticsearch.client.v%s.SearchClientImpl"</span></span>, desiredVersion); Path moduleDependencies = Paths.get(<span class="hljs-string"><span class="hljs-string">"modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"es-v"</span></span> + desiredVersion); URL[] jars = Files.list(moduleDependencies) .map(Path::toUri) .map(Searcher::toURL) .toArray(URL[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); ClassLoader classLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLClassLoader(jars); <span class="hljs-comment"><span class="hljs-comment">// parent = app's class loader return (SearchClient) classLoader.loadClass(className).newInstance(); }</span></span></code> </pre> <br><p>  We need to build and copy all the modules into the corresponding directories of the <code>modules/es-v*/</code> , for this we use the <code>maven-dependency-plugin</code> in the <strong>es-v1</strong> and <strong>es-v2</strong> modules. </p><br><p>  We will collect the project: </p><br><pre> <code class="hljs scala">mvn <span class="hljs-keyword"><span class="hljs-keyword">package</span></span></code> </pre> <br><p>  And run: </p><br><pre> <code class="hljs pgsql">. <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es1] loaded [], sites [] . <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es2] modules [], plugins [], sites [] Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">1</span></span>} Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">2.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Bingo! </p><br><div class="spoiler">  <b class="spoiler_title">(1.7 will not work under JRE 9)</b> <div class="spoiler_text"><p>  if you don't patch JvmInfo, which is mentioned later in the reassembly of Elasticsearch 1.7. </p></div></div><br><p>  A very hardcore case assumes that the <strong>core</strong> module also uses some utility methods from the Elasticsearch library.  Our current solution will no longer work because of the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html">class loading order</a> : </p><br><blockquote><ol><li>  Invoke findLoadedClass (String) to check if the class has already been loaded. </li><li>  Invoke the class loader.  If the parent is null, the class loader is built-in. </li><li>  Invoke the findClass (String) method to find the class. </li></ol><br></blockquote><p>  That is, in this case the Elasticsearch classes will be loaded from the <strong>core</strong> , and not <strong>es-v *</strong> .  Looking closely at the boot order, we see a workaround: write your own class loader that violates this order by reversing steps 2 and 3. Such a loader will not only be able to load its <strong>es-v *</strong> module separately, but also see classes from the <strong>core</strong> . </p><br><p>  Let's write your URLClassLoader, let's call it, for example, ParentLastURLClassLoader: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParentLastURLClassLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URLClassLoader</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  and override <code>loadClass(String,boolean)</code> by copying code from ClassLoader and removing all unnecessary: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Class&lt;?&gt; loadClass(String name, <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> resolve) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (getClassLoadingLock(name)) { Class&lt;?&gt; c = findLoadedClass(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getParent() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { c = getParent().loadClass(name); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException e) { } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { c = findClass(name); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resolve) { resolveClass(c); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; } }</code> </pre> <br><p>  Swapping calls to <code>getParent().loadClass(String)</code> and <code>findClass(String)</code> and we get: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Class&lt;?&gt; loadClass(String name, <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> resolve) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (getClassLoadingLock(name)) { Class&lt;?&gt; c = findLoadedClass(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { c = findClass(name); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException ignored) { } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { c = getParent().loadClass(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNotFoundException(name); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resolve) { resolveClass(c); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; } }</code> </pre> <br><p>  Since our application will manually load the module classes, the loader must throw a <code>ClassNotFoundException</code> if the class is not found anywhere. </p><br><p>  The loader is written, now we use it, replacing the <code>URLClassLoader</code> in the <code>getClient(String)</code> method: </p><br><pre> <code class="java hljs">ClassLoader classLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLClassLoader(jars);</code> </pre> <br><p>  on <code>ParentLastURLClassLoader</code> : </p><br><pre> <code class="java hljs">ClassLoader classLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParentLastClassLoader(jars);</code> </pre> <br><p>  and running the application again, we see the same result: </p><br><pre> <code class="hljs pgsql">. <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es1] loaded [], sites [] . <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es2] modules [], plugins [], sites [] Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">1</span></span>} Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">2.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><h2 id="serviceloader-api">  ServiceLoader API </h2><br><p>  In Java 6, the <a href="https://docs.oracle.com/javase/9/docs/api/java/util/ServiceLoader.html">java.util.ServiceLoader</a> class was added, which provides a mechanism for loading implementations on an interface / abstract class.  This class also solves our problem: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SearchClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String desiredVersion)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Path moduleDependencies = Paths.get(<span class="hljs-string"><span class="hljs-string">"modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"es-v"</span></span> + desiredVersion); URL[] jars = Files.list(moduleDependencies) .map(Path::toUri) .map(Searcher::toURL) .toArray(URL[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); ServiceLoader&lt;SearchClient&gt; serviceLoader = ServiceLoader.load(SearchClient.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URLClassLoader(jars)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serviceLoader.iterator().next(); }</code> </pre> <br><p>  Everything is very simple: </p><br><ul><li>  look for all jar files in the module directory, </li><li>  we put them in the loader, </li><li>  We are trying to load at least one implementation of our interface using the created loader. </li></ul><br><p>  In order for the ServiceLoader to see the interface implementations, you need to create files with the full interface name in the <code>META-INF/services</code> directory: </p><br><pre> <code class="hljs ruby">+---es-v1/ <span class="hljs-params"><span class="hljs-params">| +---src/ |</span></span> +---main/ <span class="hljs-params"><span class="hljs-params">| +---resources/ |</span></span> +---META-INF/ <span class="hljs-params"><span class="hljs-params">| +---services/ |</span></span> +---elasticsearch.client.spi.SearchClient +---es-v2/ +---src/ +---main/ +---resources/ +---META-INF/ +---services/ +---elasticsearch.client.spi.SearchClient</code> </pre> <br><p>  and write the full names of the classes that implement this interface on each line: in our case, one <code>SearchClientImpl</code> for each module. <br>  For <strong>es-v1</strong> , the file will have the line: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">elasticsearch</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.client</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SearchClientImpl</span></span></code> </pre> <br><p>  and for <strong>es-v2</strong> : </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">elasticsearch</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.client</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.v2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SearchClientImpl</span></span></code> </pre> <br><p>  We also use the <code>maven-dependency-plugin</code> to copy <strong>es-v *</strong> <code>modules/es-v*/</code> into <code>modules/es-v*/</code> .  Rebuild the project: </p><br><pre> <code class="hljs scala">mvn clean <span class="hljs-keyword"><span class="hljs-keyword">package</span></span></code> </pre> <br><p>  And run: </p><br><pre> <code class="hljs pgsql">. <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es1] loaded [], sites [] . <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es2] modules [], plugins [], sites [] Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">1</span></span>} Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">2.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  Great, the desired result is again obtained. </p><br><p>  For the mentioned hardcore case, you will have to bring the <code>SearchClient</code> interface into a separate <strong>spi</strong> module and use the following chain of loaders: </p><br><pre> <code class="hljs erlang-repl">core: bootstrap -&gt; system spi: bootstrap -&gt; spi es-v1: bootstrap -&gt; spi -&gt; es-v1 es-v2: bootstrap -&gt; spi -&gt; es-v2</code> </pre> <br><p>  those. </p><br><ol><li>  create a separate bootloader for <strong>spi</strong> (throw null in parent - the bootstrap bootloader will be used), </li><li>  we load im <strong>spi</strong> (interface <code>SearchClient</code> ), </li><li>  then create a loader for each <strong>es-v *</strong> module, which will have a <strong>spi</strong> loader for the parent, </li><li>  ... </li><li>  PROFIT! </li></ol><br><h2 id="moduli-osgi">  OSGi Modules </h2><br><p>  I‚Äôll confess immediately and honestly - I haven‚Äôt had to deal with OSGi frameworks (can it be for the better?).  Looking at the beginner mana from Apache Felix and Eclipse Equinox, they are more like containers into which (manually?) They load bundles.  Even if there are implementations for embedding, this is too cumbersome for our simple application.  <em>If I am wrong, state the opposite point of view in the comments (and in general you want to see what someone uses it and how)</em> . </p><br><p>  I did not go into this question, because  in Java 9, the modules are now out of the box, which we will now consider. </p><br><h2 id="nativnye-moduli-v-java">  Native modules in java? </h2><br><p>  Last week, the 9th version of the platform was released, in which the main innovation was the modularization of runtime and the source code of the platform itself.  Just what we need! </p><br><p>  <em>Hint: In order to use the modules, you must first <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk9-downloads-3848520.html">download and install JDK 9</a> , if you have not done so already.</em> </p><br><p>  Here, the problem is complicated only by the ability of the used libraries to run under the nine as modules (in fact, I just did not find a way in IntelliJ IDEA to specify the class-path along with the module-path, so then we do everything in context of module-path). </p><br><h3 id="kak-rabotaet-modulnaya-sistema">  How the modular system works </h3><br><p>  Before we proceed to modifying the code of our application under a modular system, we first find out how it works (I can be mistaken, since I myself just started to understand this question). </p><br><p>  In addition to the modules mentioned, there are still layers containing them.  When the application starts, a <code>boot</code> layer is created, into which all the modules specified in the <code>--module-path</code> that the application consists of and their dependencies are <code>java.base</code> (all modules automatically depend on the <code>java.base</code> module).  Other layers can be created programmatically. </p><br><p>  Each layer has its own class loader (or hierarchy).  Like loaders, modular layers can also be built hierarchically.  In such a hierarchy, the modules of one layer can see other modules that are in the parent layer. </p><br><p>  The modules themselves are isolated from each other and by default their packages and classes in them are not visible to other modules.  The module descriptor (it is <code>module-info.java</code> ) allows you to specify which packages each module can open and which modules and their packages they themselves depend on.  Additionally, modules can declare that they use some interfaces in their work, and can declare an accessible implementation of these interfaces.  This information is used by the ServiceLoader API to load implementations of the intefraces from the modules. </p><br><p>  Modules are explicit and automatic (there are more types, but we will limit ourselves to these): </p><br><ul><li>  Explicit modules are explicitly described by the <code>module-info.class</code> in the root of the jar-archive (module or modularized jar), </li><li>  Automatic modules are libraries without a descriptor placed in module-path;  As modules of this type, it is supposed to use the existing unmodularized libraries used in the good old <code>class-path</code> . </li></ul><br><p>  Now this information will be enough to apply it on our project: </p><br><ol><li>  In the boot layer, we will have only the <strong>core</strong> module.  If there are <strong>es-v *</strong> modules in it, the application will not start due to conflicting transitive <code>elasticsearch.shaded</code> modules. </li><li>  The <code>Searcher</code> class will manually load <strong>es-v *</strong> modules into separate child layers with its class loader using the ServiceLoader API. </li></ol><br><p>  Is everything so simple? ... </p><br><h3 id="package-hell">  Package hell </h3><br><p>  Modules are not allowed to have intersecting package names (in at least one layer). </p><br><p>  For example, there is some library that provides some kind of API in the public class <code>Functions</code> .  This library has a class <code>Helpers</code> with batch scopes.  Here they are: </p><br><pre> <code class="hljs pgsql">com.foo.bar <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Helpers</code> </pre> <br><p>  The second library comes onto the scene, which provides which complements the functionality of the first: </p><br><pre> <code class="hljs kotlin">com.foo.baz <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Additional</span></span></span></span></code> </pre> <br><p>  And she needs some functionality from the closed class <code>Helpers</code> .  We leave the situation by placing some class in the same package: </p><br><pre> <code class="hljs kotlin">com.foo.baz <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Additional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AccessorToHelpers</span></span></span></span></code> </pre> <br><p>  Let's congratulate ourselves - we have just created the problem of split packages for ourselves from the point of view of a modular system.  What can be done with such libraries?  We are <a href="http://openjdk.java.net/projects/jigsaw/spec/sotms/">offered to leave such libraries in the class-path</a> and reach them from the modules using automatic modules as a bridge.  But we are not looking for easy ways, so we use another option: we report all its dependencies to the library and get one single jar-archive (known as fat jar and uber jar), it can be used in the module-path as an automatic module, bypassing the class-path.  The problem may be the assembly of such an all-in-one jar. </p><br><div class="spoiler">  <b class="spoiler_title">Instructions for rebuilding Elasticsearch</b> <div class="spoiler_text"><p>  Elasticsearch actively uses access to package-private methods / fields to access some Lucene functionality.  To use it as an automatic module, we will make an uber jar out of it and install it in a local repository under the name <code>elasticsaerch-shaded</code> for further use in our project. </p><br><h3 id="sobiraem-elasticsearch-17">  We collect Elasticsearch 1.7 </h3><br><p>  In the first versions, the application project is a single Maven module, so there‚Äôs not much problem here: you need to fix <code>pom.xml</code> and some classes if you <code>pom.xml</code> 8th one. </p><br><p>  We clone the repository in any directory, check the v1.7.5 tag and start to edit: </p><br><ul><li>  The project is already using the <code>maven-shade-plugin</code> , so to build uberjar you will need to comment out the inclusion of some packages so that everything will be included: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;includes&gt; &lt;include&gt;com.google.guava:guava&lt;/include&gt; &lt;include&gt;com.carrotsearch:hppc&lt;/include&gt; &lt;include&gt;com.fasterxml.jackson.core:jackson-core&lt;/include&gt; ... &lt;/includes&gt; --&gt;</span></span></code> </pre> <br><p>  and preferably in the original, without moving: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;relocations&gt; &lt;relocation&gt; &lt;pattern&gt;com.google.common&lt;/pattern&gt; &lt;shadedPattern&gt;org.elasticsearch.common&lt;/shadedPattern&gt; &lt;/relocation&gt; &lt;relocation&gt; &lt;pattern&gt;com.carrotsearch.hppc&lt;/pattern&gt; &lt;shadedPattern&gt;org.elasticsearch.common.hppc&lt;/shadedPattern&gt; &lt;/relocation&gt; ... &lt;/relocations&gt; --&gt;</span></span></code> </pre> <br><ul><li>  We'll have to remove Groovy (breaks the load due to <a href="https://stackoverflow.com/questions/45969539/java-9-service-provider-and-groovy-extension-modules">such ambiguity</a> ), as well as loggers (there are no configs for them, JUL will work fine by default), adding <code>&lt;excludes&gt;</code> right behind the commented <code>&lt;includes&gt;</code> node: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">excludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span>org.codehaus.groovy:groovy-all<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j:*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span>log4j:*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">excludes</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><ul><li>  Turn off the cutting of unused classes - the plugin does not know about the ServiceLoader / Reflection API: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--&lt;minimizeJar&gt;true&lt;/minimizeJar&gt;--&gt;</span></span></code> </pre> <br><ul><li>  And add the gluing of the service files with the implementation classes for the ServiceLoader API to the plug-in <code>&lt;configuration&gt;</code> node: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">implementation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><ul><li>  With <code>pom.xml</code> finished, it remains to resolve <code>UnsupportedOperationException</code> , which throws <code>java.lang.management.RuntimeMXBean#getBootClassPath</code> .  To do this, find the following string in the <code>JvmInfo</code> class: </li></ul><br><pre> <code class="java hljs">info.bootClassPath = runtimeMXBean.getBootClassPath();</code> </pre> <br><p>  and wrap it in the "right": </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (runtimeMXBean.isBootClassPathSupported()) { info.bootClassPath = runtimeMXBean.getBootClassPath(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { info.bootClassPath = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br><p>  This information is used only for statistics. </p><br><p>  Done, now you can build the jar: </p><br><pre> <code class="hljs scala">$ mvn <span class="hljs-keyword"><span class="hljs-keyword">package</span></span></code> </pre> <br><p>  and after compiling and assembling we get the required <code>elasticsearch-1.7.5.jar</code> in the <code>target</code> directory.  Now it needs to be installed in a local repository, for example, under the name <code>elasticsearch-shaded</code> : </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ mvn install:install-file </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -Dfile=elasticsearch-1.7.5.jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -DgroupId=org.elasticsearch </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -DartifactId=elasticsearch-shaded </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -Dversion=1.7.5 </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -Dpackaging=jar </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">&gt; -DgeneratePom=true</span></span></code> </pre> <br><p>  Now this artifact can be used as an automatic module in our Maven-module <strong>es-v1</strong> : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>elasticsearch-shaded<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.7.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3 id="sobiraem-elasticsearch-24">  We collect Elasticsearch 2.4 </h3><br><p>  Roll back local changes and check out the v2.4.5 tag.  Starting with version 2, the project is divided into modules.  The module we need, issuing <code>elasticsearch-2.4.5.jar</code> is the <strong>core</strong> module. </p><br><ul><li>  First of all, remove snapshot, we need a release: </li></ul><br><pre> <code class="hljs swift">$ mvn versions:<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> -<span class="hljs-type"><span class="hljs-type">DnewVersion</span></span>=<span class="hljs-number"><span class="hljs-number">2.4</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><ul><li>  Now we will look for whether the shade plugin is configured where ... and stumble upon such a dock: </li></ul><br><blockquote><h4 id="shading-and-package-relocation-removed">  Shading and package relocation removed </h4><br><br>  Elasticsearch used to shade dependencies and to relocate packages.  We no longer use shading or relocation. <br>  Your package names: <br><ul><li>  <code>com.google.common</code> was <code>org.elasticsearch.common</code> </li><li>  <code>com.carrotsearch.hppc</code> was <code>org.elasticsearch.common.hppc</code> </li><li>  <code>jsr166e</code> was <code>org.elasticsearch.common.util.concurrent.jsr166e</code> <br>  ... </li></ul><br></blockquote><p>  We will have to add the shade plugin again to the <strong>core</strong> module, adding the transformer service files and excluding loggers in the settings: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.maven.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-shade-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span>package<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>shade<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">implementation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transformers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">excludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j:*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span>log4j:*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclude</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">excludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><ul><li>  Remove the <code>com.twitter:jsr166e</code> ( <code>com.twitter:jsr166e</code> is used <code>sun.misc.Unsafe</code> , which is not in 9-ke) for the <strong>core</strong> module: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;dependency&gt; &lt;groupId&gt;com.twitter&lt;/groupId&gt; &lt;artifactId&gt;jsr166e&lt;/artifactId&gt; &lt;version&gt;1.1.0&lt;/version&gt; &lt;/dependency&gt; --&gt;</span></span></code> </pre> <br><p>  and change the com.twitter.jsr166e <code>com.twitter.jsr166e</code> to <code>java.util.concurrent.atomic</code> . </p><br><ul><li>  The <code>animal-sniffer-maven-plugin</code> detect the change in the previous step (there is no jsr166e in 7-ke), we remove: </li></ul><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;animal-sniffer-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; --&gt;</span></span></code> </pre> <br><p>  Done, now we are doing the same assembly and installation steps as for <strong>es-v1</strong> , with some differences: </p><br><ul><li>  change version to 2.4.5, </li><li>  just collect the <strong>core</strong> module: </li></ul><br><pre> <code class="hljs scala">$ mvn clean <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> -pl org.elasticsearch:parent,org.elasticsearch:elasticsearch -<span class="hljs-type"><span class="hljs-type">DskipTests</span></span>=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> </div></div><br><h3 id="moduli-v-nashem-proekte">  Modules in our project </h3><br><p>  After we found out that the libraries we use are capable of working in a modular Java system, we will create explicit Java modules from our Maven modules.  To do this, we will need to create <code>module-info.java</code> files in each source directory ( <code>src/main/java</code> ) and describe the relationships between the modules in them. </p><br><p>  The <strong>core</strong> module does not depend on any other modules, but only contains the interface that other modules must implement, so the description will look like this: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   - elasticsearch.client.core module elasticsearch.client.core { // ,     , //       exports elasticsearch.client.spi; //    ,     SearchClient //    ServiceLoader' uses elasticsearch.client.spi.SearchClient; }</span></span></code> </pre> <br><p>  For modules <strong>es-v1</strong> and <strong>es-v2 there</strong> will be a similar description: </p><br><ul><li>  They use the <code>elasticsearch.client.core</code> module, since  there is an interface in it </li><li>  each one uses the automatic Elasticsearch module of the required version, </li><li>  and each module says that it provides an implementation for the <code>SearchClient</code> interface. </li></ul><br><p>  Total we have for <strong>es-v1</strong> : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   - elasticsearch.client.v1 module elasticsearch.client.v1 { //  core  SearchClient requires elasticsearch.client.core; //   requires elasticsearch.shaded; //   core,        provides elasticsearch.client.spi.SearchClient with elasticsearch.client.v1.SearchClientImpl; }</span></span></code> </pre> <br><p>  For <strong>es-v2,</strong> almost everything is the same, only version <code>v2</code> should appear in the names. </p><br><p>  Now how to load such modules?  The answer to this question is in the description of the <a href="http://download.java.net/java/jdk9/docs/api/java/lang/ModuleLayer.html">ModuleLayer</a> class, which contains a small example of loading a module from a file system.  Assuming that <strong>es-v *</strong> modules are each all in the same <code>modules/es-v*/</code> directories, you can write something like this: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SearchClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String desiredVersion)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Path modPath = Paths.get(<span class="hljs-string"><span class="hljs-string">"modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"es-v"</span></span> + desiredVersion); ModuleFinder moduleFinder = ModuleFinder.of(modPath); ModuleLayer parent = ModuleLayer.boot(); Configuration config = parent.configuration().resolve(moduleFinder, ModuleFinder.of(), Set.of(<span class="hljs-string"><span class="hljs-string">"elasticsearch.client.v"</span></span> + desiredVersion)); ModuleLayer moduleLayer = parent.defineModulesWithOneLoader(config, Thread.currentThread().getContextClassLoader()); ServiceLoader&lt;SearchClient&gt; serviceLoader = ServiceLoader.load(moduleLayer, SearchClient.class); Optional&lt;SearchClient&gt; searchClient = serviceLoader.findFirst(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchClient.isPresent()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> searchClient.get(); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Module 'elasticsearch.client.v"</span></span> + desiredVersion + <span class="hljs-string"><span class="hljs-string">"' not found on "</span></span> + modPath); }</code> </pre> <br><p> <a href="http://download.java.net/java/jdk9/docs/api/java/lang/ModuleLayer.html">ModuleLayer#defineModulesWithManyLoaders</a>    ,           <strong>es-v*</strong>     . </p><br><p> ,     .     <code>maven-compiler-plugin</code> ,      ‚Äî 3.7.0: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.maven.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-compiler-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>3.7.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Java 9  : </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maven.compiler.source</span></span></span><span class="hljs-tag">&gt;</span></span>1.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maven.compiler.source</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maven.compiler.target</span></span></span><span class="hljs-tag">&gt;</span></span>1.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maven.compiler.target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>     <code>maven-dependency-plugin</code> ,   : </p><br><pre> <code class="hljs scala">$ mvn clean <span class="hljs-keyword"><span class="hljs-keyword">package</span></span></code> </pre> <br><p>   ,     : </p><br><pre> <code class="hljs pgsql">. <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es1] loaded [], sites [] . <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>  org.elasticsearch.plugins.PluginsService &lt;init&gt; <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>: [es2] modules [], plugins [], sites [] Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">1</span></span>} Client <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">2.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> doc: {field=test <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>  ,      ‚Äî ,       ,        Java 8   . </p><br><h2 id="konec">  the end </h2><br><p>       ,    /.   : </p><br><ul><li>     ClassLoader ‚Äî   ,   <del>   </del>         (      ), </li><li>  ServiceLoader API ‚Äî    META-INF/services, </li><li>    ,     ( <a href="https://github.com/decebals/pf4j"></a> ) ‚Äî       <del>    </del></li><li>     Java 9 ‚Äî          . </li></ul><br><p> PS       Java 9! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339026/">https://habr.com/ru/post/339026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339016/index.html">Five things to know about the Spring Framework 5</a></li>
<li><a href="../339018/index.html">"Tulipmania": the stock bubble, which was not</a></li>
<li><a href="../339020/index.html">Security Week 39: An Evening of Delightful Stories on How Business Can't Care About Security</a></li>
<li><a href="../339022/index.html">Uneducated youth</a></li>
<li><a href="../339024/index.html">Zyxel Nebula: an overview of the key capabilities of the cloud network ecosystem</a></li>
<li><a href="../339028/index.html">As I wrote browser 3D football. Part 2</a></li>
<li><a href="../339030/index.html">Continued fasting from schoolchildren. How could Habrahabr change our destiny?</a></li>
<li><a href="../339034/index.html">DevOps coming to our home? Home Minecraft server in Azure using modern DevOps practices</a></li>
<li><a href="../339036/index.html">[CppCon 2017] Bjorn Stroustrup: Learning and teaching modern C ++</a></li>
<li><a href="../339038/index.html">How to debug small programs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>