<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SIP through WebRTC on production. How we went to this and what problems solved</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 

 I already wrote about my experience with WebRTC here , but considering that recently more and more articles on this topic appear o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SIP through WebRTC on production. How we went to this and what problems solved</h1><div class="post__text post__text-html js-mediator-article">  Good day to all! <br><br>  I already wrote about my experience with WebRTC <a href="http://habrahabr.ru/post/203568/">here</a> , but considering that recently more and more articles on this topic appear on Habr√© and what I have long wanted to write about how we achieved SIP telephony stable work on WebRTC on production I decided to write through what we went through. <br><br>  And we went through a lot: pain, panic, tantrums, a bunch of mats and wishes of good to the maintainers. <br>  Now it's all in the past.  We got rid of all the <a href="http://habrahabr.ru/post/203568/">crutches</a> that we did, and made it so that the operators called and everything worked stably. <br>  In the article, I described in as much detail as possible all the problems we encountered, using as little code and configs as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Who cares, I ask under the cat. <br><a name="habracut"></a><br><br><h4>  Background: </h4><br><br>  We wrote software for our call center and we had the opportunity to do it in such a way that we don‚Äôt bother about cross-browser compatibility. <br><br>  At the initial stage, we chose: <br><br><ul><li>  SIPml5 - as frontend lib </li><li>  Asterisk - as backend </li><li>  Google Chrome is like a browser.  where all this should work. </li></ul><br><br>  Over the whole way we used: <br><br><ul><li>  Asterisk and SIPml </li><li>  Asterisk + Webrtc2sip and SIPml </li><li>  Freeswitch + SIPml </li><li>  Freeswitch + JSSIP </li></ul><br><br><h4>  Not much about software: </h4><br><ul><li>  <a href="http://www.asterisk.org/">Asterisk</a> is a well-known soft-switch.  Made by Digium craftsmen </li><li>  <a href="http://freeswitch.org/">Freeswitch</a> - Soft-switch.  One of Asterisk's competitors </li><li>  <a href="http://www.sipml5.org/">SIPml5</a> - position themselves as the first HTML5 SIP client.  Javascript lib to work with SIP. </li><li>  <a href="http://jssip.net/">JSSIP</a> is lightweight JavaScript for working with SIP. </li><li>  <a href="http://webrtc2sip.org/">WebRTC2SIP</a> - SIP and Media Gateway </li></ul><br><br><h4>  asterisk + sipml </h4><br>  The beginning of the way.  We had to achieve a working scheme and call from the browser to our mobile. <br>  Asterisk patches and compiled on <a href="https://code.google.com/p/sipml5/wiki/Asterisk">this manual</a> <br>  After we achieved this, we started testing. <br><br>  During testing, we found: <br><br><ol><li>  "White noise" when calling </li><li>  Silence up to 10 seconds with an incoming call. </li><li>  An incoming call dropped an outgoing call. </li></ol><br><br>  1. "White noise" was corrected using <a href="">this</a> patch. <br>  2. The problem with dropping a call was solved by setting up a user on Asterisk.  A limit of 1 call per user has been set. <br>  3. We decided to fix the problem with a 10 second silence by updating Asterisk to version 1.6. <br><br>  And here we are at 1.6 asterisk.  After a quick test, it became clear: <br><br><ul><li>  "White noise" no </li><li>  Native support for web socket </li></ul><br><br>  But the following problems appeared: <br><br><ol><li>  Asterisk crashes on incoming call on RTP definition </li><li>  Silence up to 10 seconds left. </li></ol><br><br>  The problem with silence was solved by the fact that we abandoned STUN in SIPml5.  The situation has become better, but not completely disappeared. <br>  We decided to try WebRTC2SIP, as recommended by the SIPml5 maintainers. <br><br><h4>  asterisk + webrtc2sip + sipml </h4><br><br>  At this stage we have the following situation: <br><br><ul><li>  No old bugs </li><li>  Asterisk does not fall </li><li>  Silence disappeared. </li></ul><br><br>  BUT!  The problem is that WebRTC2SIP is not ready for production.  He constantly fell at different intervals. <br>  Judging by the <a href="https://code.google.com/p/webrtc2sip/issues/detail%3Fid%3D122">bug tracker</a> in the tracker, the problem has been known for half a year, when we began to use it.  Realizing that nothing could be achieved from the maintainers, they began to solve the problem themselves. <br><br>  // Meanwhile, the project is already in production. <br><br>  After spending a week without solving the problem, we restarted webrtc2sip and began to look towards Freeswitch. <br><br><h4>  freeswitch + sipml </h4><br><br>  I was looking in the direction of Freeswitch back when Beta version 1.4 was released with WebRTC support. <br><br>  At this stage, it became clear that neither from Asterisk, nor from Doubango Telecom should we expect any help, and we need to somehow solve the problem ourselves. <br><br>  At the initial stages of working with Freeswitch, the xml brain is very tolerated by configs, but when you get used to them, you cannot live without them. <br>  After we achieved work from him in conditions close to production, we tested it, and realizing that there were no bugs, we began to test further on production, while retaining the opportunity to switch back to Asterisk + WebRTC2SIP <br><br>  After migration, the problems with the softswitch have disappeared.  There were problems from SIPml: <br><br><ul><li>  If you call and hang up, then sipml will think that they also call it and will try to take a dead call. </li><li>  The call did not last more than 2 minutes. </li></ul><br><br>  We made a few crutches to prevent these problems from interfering with us and decided to switch to JSSIP.  About JSSIP known for about a month.  And there was a lot of hatred for Doubango and their products and a great desire to get rid of their products. <br><br>  After checking everything on tryit.jssip.net and realizing that there are no problems, three days later, after migrating to JSSIP, our SIP began to work stably and without bugs. <br><br><h4>  Summary </h4><br>  That's the story turned out.  And now my personal opinion on each software. <br><h6>  Sipml </h6><br><br>  Pros: <br><ul><li>  Supports transfer </li></ul><br><br>  Minuses: <br><ul><li>  Very awesome.  Minified js file weighs&gt; 1 Mb </li><li>  No full documentation.  A lot of things had to look for on the Internet. </li><li>  More sharpened by WebRTC2sip </li><li>  Lot of code </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">An example of connecting to the server</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    SIPml.init( function(e){ var stack = new SIPml.Stack({realm: 'example.org', impi: 'bob', impu: 'sip:bob@example.org', password: 'mysecret', events_listener: { events: 'started', listener: function(e){ var callSession = stack.newSession('call-audiovideo', { video_local: document.getElementById('video-local'), video_remote: document.getElementById('video-remote'), audio_remote: document.getElementById('audio-remote') }); callSession.call('alice'); } } }); stack.start(); } );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Call example</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    var callSession; var eventsListener = function(e){ console.info('session event = ' + e.type); } var makeCall = function(){ callSession = sipStack.newSession('call-audiovideo', { video_local: document.getElementById('video-local'), video_remote: document.getElementById('video-remote'), audio_remote: document.getElementById('audio-remote'), events_listener: { events: '*', listener: eventsListener } // optional: '*' means all events }); callSession.call('johndoe'); }</span></span></code> </pre><br></div></div><br><h6>  Jssip </h6><br><br>  Pros: <br><br><ul><li>  Lightweight (~ 130kb) </li><li>  Excellent documentation on the developer's site </li><li>  Works great with Freeswitch (in theory with Asterisk and others, but I haven‚Äôt checked it here) </li><li>  Great API </li></ul><br><br>  Minuses: <br><ul><li>  Do not know how to make a transfer call </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Example of connecting to the server:</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   var configuration = { 'ws_servers': 'ws://sip-ws.example.com', 'uri': 'sip:alice@example.com', 'password': 'superpassword' }; var coolPhone = new JsSIP.UA(configuration);</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Call example</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   var selfView = document.getElementById('my-video'); var remoteView = document.getElementById('peer-video'); // Register callbacks to desired call events var eventHandlers = { 'progress': function(e){ /* Your code here */ }, 'failed': function(e){ /* Your code here */ }, 'started': function(e){ var rtcSession = e.sender; // Attach local stream to selfView if (rtcSession.getLocalStreams().length &gt; 0) { selfView.src = window.URL.createObjectURL(rtcSession.getLocalStreams()[0]); } // Attach remote stream to remoteView if (rtcSession.getRemoteStreams().length &gt; 0) { remoteView.src = window.URL.createObjectURL(rtcSession.getRemoteStreams()[0]); } }, 'ended': function(e){ /* Your code here */ } }; var options = { 'eventHandlers': eventHandlers, 'extraHeaders': [ 'X-Foo: foo', 'X-Bar: bar' ], 'mediaConstraints': {'audio': true, 'video': true} }; coolPhone.call('sip:bob@example.com', options);</span></span></code> </pre><br></div></div><br><h6>  Webrtc2sip </h6><br><br>  Pros: <br><ul><li>  Helped solve a problem with Asterisk </li></ul><br>  Minuses: <br><ul><li>  Not stable </li><li>  Stability was adjusted a year later. </li></ul><br><br><h6>  Asterisk </h6><br><br>  As I understand it, the craftsmen are repairing one release, another break. <br>  On version 1.7, SIP through WebRTC stopped working for me. <br><br>  Habrayuzer <a href="https://habrahabr.ru/users/ovoshlook/" class="user_link">Ovoshlook</a> perfectly and in detail described the problem: <br><br><blockquote>  The craftsmen are already patching.  Now the universal and all-consuming problem is different - when an asterisk does bridging it sends an invite to the AVP transport, and if the called subscriber is sitting on the webphone, he accordingly expects AVPF transport and encryption.  As a result, when called, the callee will respond 603 with an error with the comment failed to get local sdp. <br>  In general - when outgoing, the asterisk does not monitor the device from which the client is sitting on it.  Alternatively, you can proxy and convert via openSIPS or Kamailio, but this is a completely different topic. </blockquote><br>  In the end, all this got tired and we chose Freeswitch as soft-switch <br><br><h6>  Freeswitch </h6><br><br>  Pros: <br><ul><li>  Works </li><li>  Actively developed </li><li>  Nothing breaks in new releases </li></ul><br>  Minuses: <br><ul><li>  There is no possibility to make a similar call center, as in asterisk with a robot robot by timeout </li></ul><br><br><h4>  Total </h4><br>  SIP began to work stably.  The operators are happy.  The current bundle of Freeswitch + JSSIP processes ~ 10k calls per day and up to 15k during peak hours. <br><br><h4>  PS </h4><br>  Anyone interested can write about how we set up Freeswitch with integration with MySQL, call center, call recording and made it fault tolerant. </div><p>Source: <a href="https://habr.com/ru/post/225239/">https://habr.com/ru/post/225239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225221/index.html">History of the RTB market: stages of development and the emergence of major players</a></li>
<li><a href="../225225/index.html">The Ministry of Communications proposes to close sites forever for posting two links to pirated content</a></li>
<li><a href="../225227/index.html">As I wrote skad. Part Six</a></li>
<li><a href="../225229/index.html">US Secret Service buys software that recognizes sarcasm in social networks</a></li>
<li><a href="../225235/index.html">Swift video course in Russian</a></li>
<li><a href="../225247/index.html">Art of IT-project management, 2nd ed</a></li>
<li><a href="../225249/index.html">How to gash your dashboard for all occasions?</a></li>
<li><a href="../225251/index.html">Git 2.0.0</a></li>
<li><a href="../225255/index.html">One combinatorial generation algorithm</a></li>
<li><a href="../225257/index.html">Chinese 3D printers: cheap and cheerful</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>