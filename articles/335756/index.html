<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Concurrency in Swift 3 and 4. Operation and OperationQueue</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you want to achieve the UI responsiveness of your iOS application by executing such time-consuming pieces of code as downloading data from the netw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Concurrency in Swift 3 and 4. Operation and OperationQueue</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/592/ed8/a45/592ed8a459394f11b7e26add358101b0.png"><br><img src="https://habrastorage.org/web/67d/c94/62c/67dc9462c57f489290054ec4013c3b1d.png"><br><br>  If you want to achieve the <code>UI</code> responsiveness of your <code>iOS</code> application by executing such time-consuming pieces of code as downloading data from the network or image processing, then you need to use advanced patterns related to multithreading ( <code>oncurrency</code> ), otherwise the work of your user interface ( <code>U</code> I) it starts to slow down a lot and can even lead to its complete ‚Äúfreezing‚Äù.  You need to remove resource-expensive tasks with <code>main thread</code> (main thread), which is responsible for executing code that displays your user interface ( <code>UI</code> ). <br><br>  In the current version of <code>Swift 3</code> and the nearest <code>Swift 4</code> (autumn 2017), this can be done in two ways that are not yet related to <code>Swift</code> built-in language constructs, which will only be implemented in <code><a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20170807/038645.html%3Futm_campaign%3DThis%252BWeek%252Bin%252BSwift%26utm_medium%3Dweb%26utm_source%3DThis_Week_in_Swift_141">Swift 5</a></code> (end of 2018). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of them uses the <code>GCD (Grand Central Dispatch)</code> and the <a href="https://habrahabr.ru/post/320152/">previous article is</a> devoted to it.  In this article, we will show how to achieve responsiveness to <code>UI</code> in <code>iOS</code> applications using such abstract concepts as Operation <code><font color="#0000FF">Operation</font></code> and the <code><font color="#0000FF">Operation</font></code> operation queue.  We will also show the difference between these two approaches and which of them is better to use in what situations. <br><br>  The code for this article can be viewed on <a href="https://github.com/BestKora/Operation_OperatioQueue">Github</a> . <br><a name="habracut"></a><br>  What is <code><font color="#0000FF">Operation</font></code> ?  A good definition of <code><font color="#0000FF">Operation</font></code> given in <a href="http://nshipster.com/nsoperation/">NSHipster:</a> <br><blockquote>  <code><font color="#0000FF">Operation</font></code> is a complete task and is an abstract class that provides you with a flow-safe structure to simulate the status of an operation, its priority, dependencies on other <code><font color="#0000FF">Operations</font></code> and control this operation. </blockquote><br><h3>  Basic concepts. <code><font color="#0000FF">Operation</font></code> </h3><br>  The simplest Operation <code><font color="#0000FF">Operation</font></code> can be represented by a normal closure, which can also be executed on a <code><font color="#0000FF">DispatchQueue</font></code> .  But this form of the operation can only be applied provided that you add it to the <code><font color="#0000FF">OperationQueue</font></code> using the <code><font color="#0000FF">addOperation</font></code> method: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/fe5/0a9/e81/fe50a9e8108344399f2aa6b7ac31c4c5.png" width="650" height="155"></div><br>  A full Operation <code><font color="#0000FF">Operation</font></code> can be constructed using a <code><font color="#0000FF">BlockOperation</font></code> initializer.  It is launched with its own <code><font color="#0000FF">start ()</font></code> method: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/478/d1c/20c/478d1c20c83443079315fb29dc73fe41.png" width="550" height="300"></div><br>  If you want to get something reusable like an asynchronous version of a synchronous function, you need to create a custom <code>subclass</code> class <code><font color="#0000FF">Operation</font></code> and get its instance: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/743/4a5/283/7434a5283f25487bbe08ba75242db15d.png" width="650" height="640"></div><br>  The <code><font color="#0000FF">FilterOperation</font></code> operation of obtaining a blurred image using the appropriate filter is defined as a user-defined <code>subclass</code> of the <code><font color="#0000FF">Operation</font></code> class.  You can see that a custom class can have both input and output properties, as well as other auxiliary functions.  To accommodate the functional part of the operation, we overridden ( <code>override</code> ) the <code><font color="#0000FF">main ()</font></code> method. <br><br>  The <code><font color="#0000FF">Operation</font></code> class allows you to create some task that you can run on the OperationQueue queue in the future, but for now it can wait for other <code><font color="#0000FF">Operations</font></code> . <br><br>  <code><font color="#0000FF">Operation</font></code> has a <code>state mashine</code> , which is the ‚Äúlife cycle‚Äù of Operation <code><font color="#0000FF">Operation</font></code> : <br><br><img src="https://habrastorage.org/web/973/1d4/64e/9731d464eb78446ba43ee02f818b3ef0.png"><br><br>  Possible states of <code><font color="#0000FF">Operation</font></code> : <code><font color="#4f4f4f"><b>pending</b></font></code> (pending), <code><font color="#66cd00"><b>ready</b></font></code> (ready to execute), <code><font color="#0000ff"><b>executing</b></font></code> (executed), <code><font color="#ff7f24"><b>finished</b></font></code> (finished), and <code><font color="#ff3030"><b>cancelled</b></font></code> (destroyed). <br><br>  When you create an <code><font color="#0000FF">Operation</font></code> and place it on an <code><font color="#0000FF">OperationQueue</font></code> , you set the operation to <code><font color="#4f4f4f"><b>pending</b></font></code> .  After some time, it takes a <code><font color="#66cd00"><b>ready</b></font></code> state (ready for execution), and at any time can be sent to <code><font color="#0000FF">OperationQueue</font></code> for execution, switching to the <code><font color="#0000ff"><b>executing</b></font></code> state, which can last from milliseconds to several minutes or longer.  After completion, Operation <code><font color="#0000FF">Operation</font></code> enters the final state of <code><font color="#ff7f24"><b>finished</b></font></code> .  At any point in this simple ‚Äúlife cycle‚Äù, Operation <code><font color="#0000FF">Operation</font></code> can be destroyed and will transition to the <code><font color="#ff3030"><b>cancelled</b></font></code> state. <br><br>  <code>API</code> <code><font color="#0000FF">Operation</font></code> class <code>API</code> reflects this ‚Äúlife cycle‚Äù of the operation and is presented below: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/936/437/080/9364370804ff4e3a9958705df35ad99f.png" width="500" height="274"></div><br>  We can start Operation <code><font color="#0000FF">Operation</font></code> for execution using the <code><font color="#0000FF">start()</font></code> method, but most often we will add an operation to the <code><font color="#0000FF">OperationQueue</font></code> operation queue, and this queue will automatically start the operation.  It should be remembered that a separate Operation <code><font color="#0000FF">Operation</font></code> , launched using <code><font color="#0000FF">start()</font></code> , is performed SYNCHRONOUSLY on the <b>current</b> thread.  In order to run it outside the <b>current</b> thread, you need to use either <code><font color="#0000FF">OperationQueue</font></code> or <code><font color="#0000FF">DispatchQueue</font></code> . <br><br>  The current state of Operation <code><font color="#0000FF">Operation</font></code> at any point of the application can be monitored using Boolean properties: <code><font color="#0000FF">isReady</font></code> , <code><font color="#0000FF">isExecuting</font></code> , <code><font color="#0000FF">isFinished</font></code> , <code><font color="#0000FF">isCancelled</font></code> using <b>KVO</b> ( <code>key-value observation</code> ) mechanisms, since the operation itself can be performed on any stream, and we may most likely need information on the main thread ( <code>main thread</code> ) or on any other thread other than the one on which the operation itself is performed. <br><br>  If we want to add functionality to <code><font color="#0000FF">Operation</font></code> , we need to create a <code>subclass</code> <code><font color="#0000FF">Operation</font></code> .  In the simplest case, in this <code>subclass</code> we need to override the <code><font color="#0000FF">main()</font></code> method of the <code><font color="#0000FF">Operation</font></code> class.  The <code><font color="#0000FF">Operation</font></code> class itself automatically manages the change in the status of the operation, but in more complex cases presented below, we will have to do it manually. <br><br>  We can provide the operation with a completion closure of the <code><font color="#0000FF">completionBlock</font></code> , which is performed after the operation is completed, as well as with the ‚Äúquality of service‚Äù <code><font color="#0000FF">qualityOfService</font></code> , which affects the priority of the operation to be performed on the <code><font color="#0000FF">OperationQueue</font></code> . <br><br>  As we can see, the <code><font color="#0000FF">Operation</font></code> class has a <code><font color="#0000FF">cancel()</font></code> method; however, using this method only sets the <code><font color="#0000FF">isCancelled</font></code> property to <code><font color="#0000FF">true</font></code> , and what semantically means ‚Äúdeleting‚Äù an operation can only be defined when creating a <code>subclass</code> <code><font color="#0000FF">Operation</font></code> .  For example, in the case of downloading data from a network, <code><font color="#0000FF">cancel()</font></code> can be defined as disabling an operation from a network interaction. <br><br><h3>  Basic concepts. <code><font color="#0000FF">OperationQueue</font></code> </h3><br>  Instead of starting operations ourselves, we will manage them using the <code><font color="#0000FF">OperationQueue</font></code> operation queue.  The queue of <code><font color="#0000FF">OperationQueue</font></code> operations can be viewed as a high-priority ‚Äúwrapper¬ª of <code><font color="#0000FF">DispatchQueue</font></code> , endowed with additional functionality: the ability to destroy operations performed, perform dependent operations, etc. <br><br>  Let's look at the <code>API</code> of the <code><font color="#0000FF">OperationQueue</font></code> class: <br><br><img src="https://habrastorage.org/web/ba1/09d/30d/ba109d30d13242a0957059f050b7e3d1.png"><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d40/0e5/f4b/d400e5f4bd54488d8a63baea435d4737.png" width="600" height="248"></div><br>  Here we see the simplest initializer of the <code><font color="#0000FF">OperationQueue ()</font></code> operation queue and two class properties: <code><font color="#0000FF">current</font></code> and <code><font color="#0000FF">main</font></code> , which specify the current <code><font color="#0000FF">OperationQueue.current</font></code> and <code>main queue</code> operations ‚Äî <code><font color="#0000FF">OperationQueue.main</font></code> , which is used to update the user interface ( <code>UI</code> ) similar to <code><font color="#0000FF">DispatchQueue.main</font></code> in <code>GCD</code> .  A very important property <code><font color="#0000FF">maxConcurrentOperationCount</font></code> sets the number of simultaneous operations on this queue and, setting it equal to <b>1</b> , we set the serial ( <code>serial</code> ) queue of operations. <br><img src="https://habrastorage.org/web/544/523/592/5445235926464976b7f985d81463e43a.png"><br><br>  By default, the value of the <code><font color="#0000FF">maxConcurrentOperationCount</font></code> property <code><font color="#0000FF">maxConcurrentOperationCount</font></code> set to <code><font color="#0000FF">Default</font></code> , which means the maximum possible number of simultaneous operations: <br><br><img src="https://habrastorage.org/web/a5a/a92/759/a5aa927597134be5bd4abe754d2a3486.png"><br><br>  You can directly add an <code><font color="#0000FF">OperationQueue</font></code> operation (or any of its <code>subclass</code> ), a closure, or a whole array of operations with the ability to block the current thread until the full array of operations is completed. <br><br>  The OperationQueue operation queue performs the operations placed on it according to their <code><font color="#0000FF">qualityOfService</font></code> priority, ‚Äúreadiness‚Äù (the <code><font color="#0000FF">isReady</font></code> property <code><font color="#0000FF">isReady</font></code> set to <code><font color="#0000FF">true</font></code> ) and dependencies ( <code><font color="#0000FF">dependencies</font></code> ) on other operations.  If all of these characteristics are equal, then the operations are sent to "execute" in the order in which they were queued.  If an operation is placed in a queue of operations, then it cannot be placed again in any of these queues.  If an operation has been performed, it cannot be re-executed on any of the operation queues, the operation is a one-time thing, so it makes sense to create <code>subclasses</code> of the <code><font color="#0000FF">Operation</font></code> class and use them, if necessary, to re-receive an instance of this operation. <br><br>  You can send a <code><font color="#0000FF">cancel()</font></code> message to all operations in the queue using the <code><font color="#0000FF">cancellAllOperations ()</font></code> method, for example, if the application ‚Äúgoes‚Äù to the background ( <code>background</code> ) mode.  Using the <code><font color="#0000FF">waitUntilAllOperationsAreFinished()</font></code> method, you can block the current thread until all operations on this operation queue have been completed.  But NEVER do this on the <code>main queue</code> .  If you really need to do something only after the completion of all operations, then create a <code><font color="#0000FF">private</font></code> <code>serial queue</code> and wait for the completion of your operations there. <br><br>  The OperationQueue operation queue behaves like a <code><font color="#0000FF">DispatchGroup</font></code> .  You can add operations with different <code><font color="#0000FF">qualityOfService</font></code> to the <code><font color="#0000FF">OperationQueue</font></code> , and they will be launched according to their priority.  You can also set <code><font color="#0000FF">qualityOfService</font></code> at a higher level ‚Äî for the operation queue as a whole, but this value will be overridden by the qualityOfService value for a particular operation. <br><br>  The default <code><font color="#0000FF">qualityOfService</font></code> for <code><font color="#0000FF">OperationQueue</font></code> is <code><font color="#0000FF">.background</font></code> . <br><br>  You can also stop the execution of operations on the <code><font color="#0000FF">OperationQueue</font></code> by setting the <code><font color="#0000FF">isSuspended</font></code> property to <code><font color="#0000FF">true</font></code> .  The operations performed on this queue will continue, but the newly added ones will not be sent for execution until you change the <code><font color="#0000FF">isSuspended</font></code> property to <code><font color="#0000FF">false</font></code> .  The default value for the <code><font color="#0000FF">isSuspended</font></code> property is <code><font color="#0000FF">false</font></code> . <br><br>  Let's do some experiments with the Operation operations and the <code><font color="#0000FF">Operation</font></code> operation queue on the <code>Playground</code> . <br><br><h3>  Experiment 1. Creating an <code><font color="#0000FF">OperationQueue</font></code> and Adding Closures </h3><br>  The code can be viewed on the <code>OperationQueue.playground</code> on <a href="https://github.com/BestKora/Operation_OperatioQueue">Github</a> . <br><br>  Create an empty <code><font color="#0000FF">printerQueue</font></code> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/86a/6da/44b/86a6da44b59f455bb8372993f8693906.png" width="700" height="402"></div><br>  Add operations in the form of closures to the <code><font color="#0000FF">printerQueue</font></code> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/387/b2d/1ca/387b2d1ca744416085e10562aa2477b6.png" width="700" height="531"></div><br>  Operations start asynchronously with respect to the current thread, as soon as we add them to <code><font color="#0000FF">printerQueue</font></code> , and they are in the <code><font color="#66cd00"><b>ready</b></font></code> state.  We estimate the execution time of all operations using the <code><font color="#0000FF">waitUntilAllOperationsAreFinished()</font></code> method, which, synchronously with respect to the current thread, waits for the end of operations.  On the <code>main queue</code> in the application it is better not to do this, but on our <code>Playground</code> nothing happens to <code>U</code> I and we can afford it.  The total execution time of all 7 operations is slightly more than 2 seconds and corresponds to the execution time of the <code><font color="#0000FF">sleep(2)</font></code> operator, therefore, <code><font color="#0000FF">printerQueue</font></code> runs all 7 operations simultaneously on many threads. <br><br>  Let's change the <code><font color="#0000FF">printerQueue</font></code> queue <code><font color="#0000FF">printerQueue</font></code> , and set the <code><font color="#0000FF">maxConcurrentOperationCount</font></code> property to <b>2</b> : <br><br><img src="https://habrastorage.org/web/09e/211/ad8/09e211ad8bf24156b5b9fece8d8b6167.png"><br><br>  We see that it takes a very short time to put all operations on the <code><font color="#0000FF">printerQueue</font></code> , and a little more than 8 seconds to perform all operations, since they start in pairs and the last 7th operation starts alone in the fourth ‚Äúpair‚Äù. <br><br>  Now add another <code><font color="#0000FF">concatenationOperation</font></code> operation with an increased <code><font color="#0000FF">qualityOfService</font></code> equal to <code><font color="#0000FF">.userInitiated</font></code> : <br><br><img src="https://habrastorage.org/web/1a3/880/115/1a38801155fd4e4ebdc55ea797420e67.png"><br><br>  We see that at the first opportunity an operation with a higher priority is performed before the others, while the total time for performing all operations practically does not change - just over 8 seconds. <br><br>  Let's turn the <code><font color="#0000FF">printerQueue</font></code> to serial ( <code>serial</code> ) by setting the <code><font color="#0000FF">maxConcurrentOperationCount</font></code> property to <b>1</b> : <br><br><img src="https://habrastorage.org/web/963/fda/1d3/963fda1d3be14603b1d57fbf2a389ee5.png" width="600" height="732"><br><br>  We see that in this case, operations are performed sequentially, one after another, priorities do not work and the total time for performing all operations increases to <b>16</b> seconds. <br><br>  Consider a more complicated case when, to obtain an array of filtered source images <br><br><img src="https://habrastorage.org/web/20f/c7d/61c/20fc7d61cdb547c997f8f1f47e55db62.png" width="700" height="247"><br><br>  A filtering operation <code><font color="#0000FF">FilterOperation</font></code> , familiar to us from the previous section, is applied: <br><br><img src="https://habrastorage.org/web/bd5/09c/0f7/bd509c0f721a41659266eb8d11a822a8.png" width="700" height="173"><br><br>  Create a <code><font color="#0000FF">filterQueue</font></code> for performing filtering operations and a serial ( <code>serial</code> ) <code><font color="#0000FF">appendQueue</font></code> for <code><font color="#0000FF">appendQueue</font></code> -safely adding the filtered image to the array.  The fact is that many filtering operations will simultaneously access a shared ( <code>shared</code> ) resource ‚Äî an <code><font color="#0000FF">filteredImages</font></code> array ‚Äî to add their own element.  Remember?  We used a serial ( <code>serial</code> ) <code><font color="#0000FF">DispatchQueue</font></code> queue to change <code>shared</code> resources?  Here is the same, but will be performed for <code><font color="#0000FF">Operation</font></code> .  Of course, the serial ( <code>serial</code> ) <code><font color="#0000FF">DispatchQueue</font></code> queue will be more efficient, but we will show the creation and use of the serial ( <code>serial</code> ) <code><font color="#0000FF">OperatioQueue</font></code> queue. <br><br>  <code>Swift</code> arrays are <code>value type</code> and are copied when writing ( <code>copy on write</code> ), so you do not have to worry about multi-threaded changes, but there are messages in the forums that there are problems with this, especially if the array is a property of an object of type class.  Therefore, we show a way to preserve the multithreaded security ( <code>thread safe</code> ) of an array when adding new elements to it in different threads. <br><br><img src="https://habrastorage.org/web/12f/4aa/97a/12f4aa97ab1146759d7c397700082b4f.png" width="650" height="512"><br><br>  Then we create a filtering operation for each image and add it to the <code><font color="#0000FF">filterQueue</font></code> for asynchronous execution.  After the filtering is done, we add the resulting image to the <code><font color="#0000FF">filteredImages</font></code> array and do this in the <code><font color="#0000FF">completionBlock</font></code> , where we use another queue of operations, <code><font color="#0000FF">appendQueue</font></code> .  The <code><font color="#0000FF">completionBlock</font></code> no input parameters and it returns nothing. <br><br>  We are waiting for all filtering operations and check the filtered image array: <br><br><img src="https://habrastorage.org/web/1f3/ebb/774/1f3ebb774b3d4dabad09babf63deb38a.png" width="700" height="482"><br><br>  The execution time of all operations of <b>1.19</b> seconds is comparable to the execution time of one operation (see previous section), that is, there is a multi-threaded execution of operations on the <code><font color="#0000FF">filterQueue</font></code> queue.  On the <code>Playground</code> we see an array of filtered images, but they are very small to see the filtering effect.  We can click on the quick view button and see the filtering effect: <br><br><img src="https://habrastorage.org/web/722/e9b/75a/722e9b75add4412583c046cd17bc3dcb.png"><br><br><h3>  Asynchronous operation </h3><br>  The code can be viewed on the <code>AsyncOperations.playground</code> on <a href="https://github.com/BestKora/Operation_OperatioQueue">Github</a> . <br><br>  So far, we have used operations for SYNCHRONIC tasks, that is, functions that use the current thread and do not return until they have completed their task entirely.  ASYNCHRONIC tasks (functions) behave quite differently: they immediately return control on the current thread, and perform their task on another thread, and let you know that the task is completed, causing the <code><font color="#0000FF">completionHandler</font></code> to close on another thread.  A classic example is <code><font color="#0000FF">URLSession</font></code> : <br><br><img src="https://habrastorage.org/web/fe2/92b/5d0/fe292b5d070f47199614e9b96fe54a04.png"><br><br>  We can ‚Äúwrap‚Äù the <code><font color="#0000FF">URLSession</font></code> functionality in Operation <code><font color="#0000FF">Operation</font></code> , but we will have to manually manage the operation states. <br><br>  To create custom operations for SYNCHRONOUS functions, we only needed to override the method of the <code><font color="#0000FF">main()</font></code> operation.  If we do the same with the ASYNCHRONIC function, then in <code><font color="#0000FF">main()</font></code> it will immediately return control to the current thread and ‚Äúleave‚Äù to work on another thread, and we will end up at the end of the <code><font color="#0000FF">main()</font></code> method and <code><font color="#0000FF">OperationQueue</font></code> immediately ‚Äúthrow‚Äù our operation out of the queue, without completing our ASYNCHRONOUS function.  This is the logic of <code><font color="#0000FF">OperationQueue</font></code> . <br><br>  ASYNCHRONOUS OPERATION has a completely different logic of operation. <br><br><img src="https://habrastorage.org/web/8e1/789/f34/8e1789f348734cbea2017d9b6bbdb160.png"><br><br>  If the operation is ‚Äúready‚Äù ( <code><font color="#0000FF">isReady = true</font></code> ), the OperationQueue operation queue calls the <code><font color="#0000FF">start()</font></code> method, in which we must set the operation to the ‚Äúrunning‚Äù state ( <code><font color="#0000FF">isExecuting = true</font></code> ) and call the <code><font color="#0000FF">main()</font></code> method, which in turn will call the ASYNCHRONOUS function .  The ASYNCHRONIC function performs something on an OTHER stream, but the <code><font color="#0000FF">isExecuting</font></code> property must remain <code><font color="#0000FF">true</font></code> , even if it does not perform anything on the CURRENT stream, but only represents a task that is running on another thread.  When the ASYNCHRONOUS function calls <code><font color="#0000FF">completionHandler</font></code> , which indicates the end of the ASYNCHRONOUS function, we must set the <code><font color="#0000FF">completionHandler</font></code> property to <code><font color="#0000FF">isFinished</font></code> , <code><font color="#0000FF">true</font></code> , and the <code><font color="#0000FF">isExecuting</font></code> property to <code><font color="#0000FF">false</font></code> . <br><br>  Therefore, for an ASYNCHRONOUS operation, we will have to override ( <code>override</code> ) more than just the <code><font color="#0000FF">main()</font></code> method.  We need to override the following methods and properties: <br><br><img src="https://habrastorage.org/web/c30/f14/745/c30f147454cc48e6bf7f8ca0a49209d2.png"><br><br>  Let's create an abstract custom class <code><font color="#0000FF">AsyncOperaton</font></code> , inherited from <code><font color="#0000FF">Operation</font></code> and suitable for performing any ASYNCHRONOUS operation.  Its abstract nature lies in the fact that it will not have a <code><font color="#0000FF">main()</font></code> method to perform an asynchronous operation.  Here is his diagram: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/3c0/9ef/1f7/3c09ef1f734c463db3a782ab21a568cd.png" width="650" height="365"></div><br><br>  If you use the ASYNCHRONOUS operation yourself, without an <code><font color="#0000FF">OperationQueue</font></code> , then you need to override the <code><font color="#0000FF">isAsynchronous</font></code> property and return <code><font color="#0000FF">true</font></code> .  We need to override the <code><font color="#0000FF">start()</font></code> method to actually start the ASYNCHRONOUS function and keep the <code><font color="#0000FF">isExecuting</font></code> property <code><font color="#0000FF">isExecuting</font></code> to <code><font color="#0000FF">true</font></code> .  We also need to learn how to manage the properties that determine the status of the operation: <code><font color="#0000FF">isReady</font></code> , <code><font color="#0000FF">isExecuting</font></code> , <code><font color="#0000FF">isFinished</font></code> .  These properties use the <code><font color="#0000FF">OperationQueue</font></code> operation queue to track the status of operations and organize the execution of dependent operations. <br><br>  When you define dependencies between operations, this means that one operation must end before another operation begins, so it is very important to know when the operation ends an OperationQueue when the operation ends.  For a SYNCHRONOUS operation, this is not a problem, because the SYNCHRONOUS operation ends when the SYNCHRONOUS function ends.  But the ASYNCHRONIC function ends outside the current thread, so we need some way to tell the <code><font color="#0000FF">OperationQueue</font></code> operation queue about the actual end of the ASYNCHRONOUS function.  If we recall <code>GCD</code> , then when adding an ASYNCHRONOUS function to a group, we clearly marked the beginning and end of the ASYNCHRONOUS function using the <code><font color="#0000FF">enter()</font></code> and <code><font color="#0000FF">leave()</font></code> methods.  But in the case of Operation <code><font color="#0000FF">Operation</font></code> situation is much more complicated, since the operation has states: <code><font color="#0000FF">isReady</font></code> , <code><font color="#0000FF">isExecuting</font></code> , <code><font color="#0000FF">isFinished</font></code> , <code><font color="#0000FF">isCancelled</font></code> , etc .. When adding an ASYNCHRONOUS function to <code><font color="#0000FF">Operation</font></code> , we must manage these states manually.  In order to facilitate this work, we have created a special abstract user <code>subclass</code> of the <code><font color="#0000FF">Operation</font></code> class with an <code><font color="#0000FF">AsyncOperaton</font></code> , whose main task is to control the change of the operation state.  For your own ASYNCHRONOUS function, you will create a <code>subclass</code> class, defining there only <code><font color="#0000FF">main ()</font></code> , from which you will call your ASYNCHRONOUS function.  And this new operation will be added to <code><font color="#0000FF">OperatonQueue</font></code> . <br><br>  But the problem is that I cannot write, for example, <code><font color="#0000FF">isExecuting = true</font></code> , because all the properties associated with the state of the operation: <code><font color="#0000FF">isReady</font></code> , <code><font color="#0000FF">isExecuting</font></code> , <code><font color="#0000FF">isFinished</font></code> , are <code>readonly</code> ( <code><font color="#0000FF">{get}</font></code> ), and we cannot set them directly .  We can only do something that will cause the <code><font color="#0000FF">isExecuting</font></code> property to return <code><font color="#0000FF">true</font></code> , while informing the system that the status of the <code><font color="#0000FF">AsyncOperaton</font></code> operation <code><font color="#0000FF">AsyncOperaton</font></code> changed. <br><br>  The <code><font color="#0000FF">Operation</font></code> class uses the <b>KVO</b> ( <code>key-value observation</code> ) mechanism and the <code><font color="#0000FF">willChangeValueForKe</font></code> and <code><font color="#0000FF">didChangeValueForKey</font></code> methods and notifications about changes in state properties like <code><font color="#0000FF">isReady</font></code> , <code><font color="#0000FF">isExecuting</font></code> , <code><font color="#0000FF">isFinished</font></code> . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, for the convenience of wealth management operations, we will create a new data type - proper enumeration </font></font><code><font color="#0000FF">enum State</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to represent the state of the asynchronous operation its own variants: </font></font><code><font color="#0000FF">ready</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">executing</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/853/c7c/21b/853c7c21b40949f6949b105b2ace6a82.png" width="650" height="172"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The enumeration </font></font><code><font color="#0000FF">State</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also contains a </font></font><code><font color="#0000FF">fileprivate</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property with a name </font></font><code><font color="#0000FF">keyPath</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which we will use as a switch for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> notifications. The property </font></font><code><font color="#0000FF">keyPath</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is computed and is made up of a string </font></font><code><font color="#ff3030">"is"</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connected to </font></font><code><font color="#0000FF">rawValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is the name of the enumeration element </font></font><code><font color="#0000FF">State</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a capital letter. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then we define a </font><font style="vertical-align: inherit;">type </font></font><code><font color="#0000FF">AsyncOperaton</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">variable </font><font style="vertical-align: inherit;">in the abstract class </font><font style="vertical-align: inherit;">to represent the current state of the operation; by default, this value is </font><font style="vertical-align: inherit;">. Every time we change a variable, </font><font style="vertical-align: inherit;">we need to switch </font><b><font style="vertical-align: inherit;">KVO</font></b><font style="vertical-align: inherit;"> notifications. We will do this with the help of Observers </font><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">properties </font><font style="vertical-align: inherit;">:</font></font><code><font color="#0000FF">var state</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">State</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">ready</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code><font color="#0000FF">willSet {}</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">didSet {}</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/f6f/7cd/a39/f6f7cda3966f430ea75131215c1478d7.png" width="650" height="340"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before switching the operation state </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for example, from </font></font><code><font color="#0000FF">executing</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we need to send </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> notifications </font></font><code><font color="#0000FF">willChangeValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">about the upcoming change of both operations: the new state </font></font><code><font color="#0000FF">newValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code><font color="#0000FF">finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and the current state </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code><font color="#0000FF">executing</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). After the state switch </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">happens, we send </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> notifications </font></font><code><font color="#0000FF">didChangeValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code><font color="#0000FF">keyPath</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">both states: </font></font><code><font color="#0000FF">oldValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code><font color="#0000FF">executing</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code><font color="#0000FF">finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This will cause the system to read the new values "native" state variables operation </font></font><code><font color="#0000FF">isReady</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">isExecuting</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Therefore, the asynchronous operation </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we need to redefine the "native" state variables operations </font></font><code><font color="#0000FF">isReady</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">isExecuting</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the new property </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as calculated variables that return the correct values. We will do this in a </font></font><code><font color="#0000FF">extension</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font><font style="vertical-align: inherit;">extension </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ad3/e7e/9a8/ad3e7e9a80674bddacdee0fbf8f7c0e1.png" width="650" height="524"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At some point in time, the property of an operation </font></font><code><font color="#0000FF">isReady</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">becomes equal </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and we must use the property </font></font><code><font color="#0000FF">isReady</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code>superclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which ‚Äúperceives‚Äù dependencies ( </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) on other operations. By combining our own logic with property </font></font><code><font color="#0000FF">isReady</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code>superclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we can be sure that the operation is really ‚Äúready.‚Äù Note that if a variable </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is equal </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the property </font></font><code>superclass</code> <code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is equal </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the property </font></font><code><font color="#0000FF">isExecuting</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font></font><code><font color="#0000FF">false</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We will also override the property </font></font><code><font color="#0000FF">isAsynchronous</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by returning </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and two methods: </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">cancell()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the method, </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we check whether the operation is destroyed, that is, the property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is equal </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If so, then we need to set a new value for the variable.</font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If the operation is not destroyed, we call </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Remember that there </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an ASYNCHRONOUS function, and it returns immediately, so we should manually set the operation state </font></font><code><font color="#0000FF">stat</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to be equal </font></font><code><font color="#0000FF">.executing</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. When the ASYNCHRONOUS function returns </font></font><code><font color="#0000FF">completionHanller</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in it we need to set the status of the operation </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is very important to remember that in the case of an ASYNCHRONOUS function, we cannot use in the method a </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call to a similar method for </font></font><code>superclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code><font color="#0000FF">super.start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since this would mean a synchronous start of the function </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but we need exactly the opposite. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the method, </font></font><code><font color="#0000FF">cancell()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we also need to set the status of the operation </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, we got an abstract class</font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and we can use it for our own ASYNCHRONIC operations. </font><font style="vertical-align: inherit;">To do this, you must perform the following procedure:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/5e4/a89/e28/5e4a89e2890d4092821994c5a4244eba.png" width="700" height="420"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As an example, take the function of asynchronous slow (inside is </font></font><code><font color="#0000FF">sleep (1)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) the addition of two numbers:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/91b/786/2c6/91b7862c69454271815d7f650db44b45.png" width="700" height="124"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as </font></font><code>superclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we have to redefine </font></font><code><font color="#0000FF">main ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and remember to set the operation state </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">callback</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/cb0/349/f04/cb0349f04025454faf22e1b78105cf75.png" width="700" height="450"></div><br> <code><font color="#0000FF">callback</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns the result </font></font><code><font color="#0000FF">result</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that we assign to the operation property </font></font><code><font color="#0000FF">self.result</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and set the operation state </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which informs the operation queue about the completion of asynchronous addition of numbers and that it is no longer necessary to work with this operation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's use our </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to get an array of the sum of pairs of numbers:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/f4b/59a/c67/f4b59ac67e744eea9b07f1778b2229ed.png" width="700" height="320"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For each pair of numbers, we create an operation </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and place it in the operation queue in the </font></font><code><font color="#0000FF">additionQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usual way. We see that the order of execution of asynchronous operations is slightly different from the order of the pairs of numbers in the array. It speaks about multi-threaded execution of our asynchronous operations. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second example is related to the asynchronous loading of an image as given </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by </font></font><code><font color="#0000FF">URLSession</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/c5f/99e/b6e/c5f99eb6e0614e1eb6993a22aba2519e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create an ASYNCHRONOUS operation </font></font><code><font color="#0000FF">ImageLoadOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which, like last time, is a subclass of a class </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. For the operation </font></font><code><font color="#0000FF">ImageLoadOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as well as last time, we redefine </font></font><code><font color="#0000FF">main ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and do not forget to set the status of the operation </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">completion</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/webt/rk/_k/fh/rk_kfhp8gx6rrztsxxzkurkle9s.png" width="650" height="388"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the operation </font></font><code><font color="#0000FF">operationLoad</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, get the image </font></font><code><font color="#0000FF">operationLoad.outputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and map to </font></font><code>view</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/web/706/5a1/6c7/7065a16c7cc540808b72b16e20523c67.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can look at the code </font></font><code>AsyncOperations.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependencies ( </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code can be viewed at LoadAndFilter.playground on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this section, we will consider how the result of one operation is transferred to another operation, while forcing the second operation to begin only when the first one ends. </font></font><br><br><img src="https://habrastorage.org/web/17b/3bd/2d6/17b3bd2d651d4597a58c26c7004606fc.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the picture you see two operations: the first one loads the image from the network, and the second ‚Äúmists‚Äù the upper and lower parts of the image - filtering. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both of these operations work very well with each other: the image ‚Äúdownloader‚Äù directly transfers its data to the ‚Äúfilter‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We could create one operation that includes both of these operations, but this is not a very flexible design.</font></font><br><br><img src="https://habrastorage.org/web/040/3d5/72c/0403d572c1524497afdd07aeda35a829.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is desirable to have some modularity of operations when working with images in order to use them in any order in different places of the application. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A more flexible solution is associated with performing a ‚Äúchain‚Äù of operations with transferring an image from the first operation to the second. We can determine that the ‚Äúfilter‚Äù depends on the ‚Äúloader‚Äù, and then the queue of operations </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will know that the ‚Äúfilter‚Äù is set to the state </font></font><code><font color="#0000FF">ready</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only after the ‚Äúloader‚Äù operation ends. This is a truly remarkable "ability" queue of operations </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can create a very complex graph of "dependencies" and thus force the </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementation to automatically launch operations as you need. </font></font><code>API</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that supports work with "dependencies" (</font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - very simple, but reveals a fantastic power when working. </font></font><br><br><img src="https://habrastorage.org/web/eeb/672/082/eeb6720824534ac2adc26dcb6e729b60.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can add and remove ‚Äúdependencies‚Äù ( </font></font><code><font color="#0000FF">dependency</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), as well as get a list of ‚Äúdependencies‚Äù </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">added for this operation. Below we will use the list </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to get the input image of the dependent filtering operation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When you create dependencies, there is a high probability of getting a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deadlock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><b><font style="vertical-align: inherit;">deadlock</font></b><font style="vertical-align: inherit;"> ): </font></font><br><br><img src="https://habrastorage.org/web/0bd/a01/ed6/0bda01ed6eb94f36995d5d54119ff57e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The appearance of closed cycles in the ‚Äúdependencies‚Äù column leads to the appearance of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deadlock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and there is no universal way to eliminate them, except by identifying them by visual analysis.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next problem with ‚Äúdependencies‚Äù of operations is how to transfer data along a ‚Äúchain of dependencies‚Äù? </font><font style="vertical-align: inherit;">For example, in the above example, when the ‚Äúloader‚Äù first works, and then the ‚Äúfilter‚Äù, for which the input image is the output image of the ‚Äúloader‚Äù:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d3b/1ff/32c/d3b1ff32c4bb4c8c90cd50696ea53aa2.png" width="700" height="608"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we achieve this? </font><font style="vertical-align: inherit;">We create a protocol </font></font><code><font color="#0000FF">ImagePass</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will supply us with the necessary data, in our case</font></font><code><font color="#0000FF">UIImage?</font></code>  : <br><br><img src="https://habrastorage.org/web/c3e/a82/a9d/c3ea82a9df4641418403d73255419fc1.png" width="650" height="181"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loader "is a class of </font></font><code><font color="#0000FF">ImageLoadOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image loading operation </font><font style="vertical-align: inherit;">already known to us </font><font style="vertical-align: inherit;">from the network. At the input, the </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image </font><font style="vertical-align: inherit;">is set </font><font style="vertical-align: inherit;">as a string </font></font><code><font color="#0000FF">urlString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the output is the image itself </font></font><code><font color="#0000FF">outputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/web/6ec/50e/c15/6ec50ec15ddf4394ae687c7b4a5bc10a.png" width="650" height="557"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The class </font></font><code><font color="#0000FF">ImageLoadOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" confirms "the protocol </font></font><code><font color="#0000FF">ImagePass</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returns the </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output loaded image </font><font style="vertical-align: inherit;">as a protocol property </font></font><code><font color="#0000FF">outputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In turn, the operation" filtering "- class </font></font><code><font color="#0000FF">FilterOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- in the absence of an input image, it </font></font><code><font color="#0000FF">_inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyzes its" dependencies " </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and is interested only in those that" confirmed "the protocol </font></font><code><font color="#0000FF">ImagePass</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. He chooses the first such dependent operation and extracts his own </font></font><code><font color="#0000FF">inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">From the </font></font><br><br><img src="https://habrastorage.org/web/0e0/0f9/64a/0e00f964a8004610b0ae8ec864b7fc25.png" width="650" height="484"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" filter "at the input - input image</font></font><code><font color="#0000FF">inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the output is the </font></font><code><font color="#0000FF">filterImage (image:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image </font><font style="vertical-align: inherit;">filtered by the function </font></font><code><font color="#0000FF">outputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is a normal synchronous operation, so we only need to redefine it </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We want to make these two operations work together, so that the ‚Äúfilter‚Äù uses the </font></font><code><font color="#0000FF">inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output image of the ‚Äúload‚Äù operation </font><font style="vertical-align: inherit;">as the input image </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To do this, we initialize the filtering operation </font></font><code><font color="#0000FF">filter</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the value </font></font><code><font color="#0000FF">nil</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/138/ff1/1b2/138ff11b278a44d29d4e13c5d1ba0bfe.png" width="650" height="376"><br><img src="https://habrastorage.org/web/248/72d/542/24872d5423254a17999f921f04f3b95d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is </font></font><code>LoadAndFilter.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Destruction of operations on </font></font><code><font color="#0000FF">OperationQueue</font></code> </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is </font></font><code>Cancellation.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will consider another great queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opportunity - the ability to destroy operations. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After you have placed your operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you have no way to influence its execution, since the operation queue has its own plan for launching operations and it completely controls your operation. But you have the ability to destroy </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/web/0e9/a42/fb3/0e9a42fb37c548c1a891d73e0d8d9cf7.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may think that calling a method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will instantly stop the operation, but it is not. The method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only sets the </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation </font><font style="vertical-align: inherit;">property </font><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If the operation has not yet started, then the default method</font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will not allow the operation to be performed and set its property </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If you override the ( </font></font><code>override</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) method </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then you must retain the ability of your to </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prevent the operation from starting if the property of the operation is </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. And if you look at the abstract class </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you will see that we did just that. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next in the </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">, especially before doing something slow or resource-consuming, you need to test the property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to determine whether the operation has already been destroyed. And if the operation is destroyed and it shows the value of the </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then you have to carry out the necessary actions to stop the operation. If operation</font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performed locally, for example, image conversion, then you can stop the operation. If the operation is related to accessing the network, such as downloading an image from a server, then you cannot stop such an operation until the server returns the result to you. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You need to add "logic" between the various "steps" of an operation to check whether it is worth continuing to perform this operation or to set the operation to the </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal </font><font style="vertical-align: inherit;">state </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>API</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, designed to remove the operation is very simple and consists of only two positions:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/31d/fec/c2b/31dfecc2bb234c15b1d65c8fa19c0c7b.png" width="650" height="132"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You call a method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äî it sets the property of the </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is important to note that when a method is called </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the properties </font></font><code><font color="#0000FF">isExecuting</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also change to </font></font><code><font color="#0000FF">false</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and, </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">respectively.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/fba/17b/475/fba17b47522d4caf8320397e135eae01.png" width="650" height="244"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For an operation it is perfectly normal to be destroyed ( </font></font><code><font color="#0000FF">isCancelled = true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and will not end ( </font></font><code><font color="#0000FF">isFinished = true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">The property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informs the operation that it should stop, and the property </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informs the system that the operation has already been stopped. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our abstract ASYNCHRONOUS operation </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redefines the method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in such a way that it sets the state of the operation </font></font><code><font color="#0000FF">state</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">.finished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and this change leads to a change in the properties of the operation </font></font><code><font color="#0000FF">isFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">isExecuting</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ee3/9cf/6a6/ee39cf6a6f4c415ab0b106025a98deaa.png" width="600" height="818"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can destroy all operations:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d91/d35/c46/d91d35c46cae4090859c4eaa7ec8b1df.png" width="650" height="149"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the example of some user operations, let's see how we can achieve the correct response of an operation to a method call </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is </font></font><code>Cancellation.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operation </font></font><code><font color="#0000FF">ArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has an input array of </font></font><code><font color="#0000FF">inputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tuples consisting of a pair of integers and forms an array of </font></font><code><font color="#0000FF">outputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">their output totals: </font></font><br><br><img src="https://habrastorage.org/web/4c3/c9f/7a9/4c3c9f7a98ba4fb09404a150fc7a6949.png" width="650" height="497"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For each pair of numbers we use the ‚Äúslow‚Äù addition function </font></font><code><font color="#0000FF">slowAdd</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presented in the folder </font></font><code>Source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cancellation.playground</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add to the output array </font></font><code><font color="#0000FF">outputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the input array of numbers, form the operation </font></font><code><font color="#0000FF">sumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, add it to the operation queue</font></font><code><font color="#0000FF">queue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and start the timer, which will allow us to further regulate the time after which we will be able to check the operation response </font></font><code><font color="#0000FF">sumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the method call </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In addition, the operation has </font></font><code><font color="#0000FF">completionBlock</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in which we stop the timer, show on </font></font><code>Playground</code> <code><font color="#0000FF">outputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and complete the work on </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/dc3/2c6/714/dc32c671421b41639edf881917c05623.png" width="650" height="511"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the operation </font></font><code><font color="#0000FF">sumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes a little more than 5 seconds. Now we will try to destroy this operation, 2 seconds after the start, calling the method </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/d38/ec4/ce8/d38ec4ce8957496eb8c6e6ca71f42f89.png" width="650" height="297"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We got an unexpected result - the operation was </font></font><code><font color="#0000FF">sumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completed, no operation was destroyed.</font></font> What is the matter?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the fact is that the method </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only sets the property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the actions necessary to delete the operation fall on the developer of the operation. We need to respond to the fact that the property is </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set to </font></font><code><font color="#0000FF">true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We will loop through each addition to the output array to check whether the operation is not destroyed. And if destroyed, then we interrupt the cycle: </font></font><br><br><img src="https://habrastorage.org/web/691/b80/f07/691b80f07ee2408e9603e0831fbf7299.png" width="650" height="283"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's re-launch </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/c38/bd7/552/c38bd75529e2458eb0e809a1138ccf18.png" width="650" height="295"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We stopped a little later than 2 seconds and managed to get 2 sums, and when we were going to get the third sum, we received a signal to destroy the operation and stopped receiving further sums. This example clearly shows how to get the reaction of a user operation to a command </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at another operation </font></font><code><font color="#0000FF">AnotherArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which differs in that another function is used </font></font><code><font color="#0000FF">slowAddArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to get the output array of a loop through the array of tuples: </font></font><br><br><img src="https://habrastorage.org/web/b3f/df1/c37/b3fdf1c37b7845f9bbd030bbd5ea828b.png" width="650" height="412"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The difference from the previous case is that the loop on the elements of the array of tuples is not in the </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">, but in another function and is difficult for us abort the loop if the operation is destroyed. But there is such a possibility, although it is very sophisticated: </font></font><br><br><img src="https://habrastorage.org/web/0f9/533/377/0f953337764c4433843002b9427a7e15.png" width="700" height="215"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the input of a function, an </font></font><code><font color="#0000FF">slowAddArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array of </font></font><code><font color="#0000FF">input</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pairs of integers, in addition, it has an argument </font></font><code><font color="#0000FF">progress</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is a </font></font><code><font color="#0000FF">Optional</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function that takes a variable depth of array processing </font></font><br><br> <code><font color="#0000FF">Double(results.count) / Double(input.count</font></code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returns it </font><font style="vertical-align: inherit;">as an argument </font></font><code><font color="#0000FF">Bool</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This </font></font><code><font color="#0000FF">Bool</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">defines the continuation of array processing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the method</font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operations </font></font><code><font color="#0000FF">AnotherArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(the previous figure), we passed an </font></font><code><font color="#0000FF">slowAddArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array </font><font style="vertical-align: inherit;">to the function </font></font><code><font color="#0000FF">inputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the argument was </font></font><code><font color="#0000FF">progress</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formatted as a ‚Äútail‚Äù closure, in which we used the property </font></font><code><font color="#0000FF">progress</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for printing. The property </font></font><code><font color="#0000FF">progress</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font></font><code><font color="#0000FF">Double</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so we multiplied it by 100 and got% of the end of array processing and completion of the operation. Then we return the response to the destruction of the operation, which is a signal to continue or interrupt array processing. A reaction is an inversion of a property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replace the previous operation </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a new operation </font></font><code><font color="#0000FF">AnotherArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/8cb/1e7/302/8cb1e730247348599b5c30810aaed10b.png" width="650" height="561"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interrupting the operation after </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seconds, we got the same result - we managed to process only </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array elements out of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ti, that is, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , before the operation was destroyed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the interrupt delay of the operation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seconds: </font><b><font style="vertical-align: inherit;">4</font></b><font style="vertical-align: inherit;"> elements of the array of </font><b><font style="vertical-align: inherit;">5 were</font></b></font><br><br><img src="https://habrastorage.org/web/70d/78f/944/70d78f944c51461ea7d25dca39e2f606.png" width="650" height="255"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processed </font><font style="vertical-align: inherit;">, that is, </font><b><font style="vertical-align: inherit;">80%</font></b><font style="vertical-align: inherit;"> , before the operation was destroyed. </font><font style="vertical-align: inherit;">It is very important to make sure that individual operations respond to the property </font><font style="vertical-align: inherit;">and, therefore, can be destroyed. </font><font style="vertical-align: inherit;">But in addition to the destruction of individual operations using the method </font><font style="vertical-align: inherit;">, you can destroy all started operations on the operation queue </font><font style="vertical-align: inherit;">using the method</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">OprationQueue</font></code><font style="vertical-align: inherit;"></font><code><font color="#0000FF">cancellAllOperations</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is especially useful if you have a set of operations that work for a single purpose. </font><font style="vertical-align: inherit;">This goal may be to run multiple independent operations in parallel or to represent a graph of dependent operations executed one after another. </font><font style="vertical-align: inherit;">Consider both of these cases.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 1. Working with a group of independent operations </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is </font></font><code>CancellationGroup.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We set the task to achieve the same result as the operation </font></font><code><font color="#0000FF">ArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presented in the previous section. This operation takes an array of tuples </font></font><code><font color="#0000FF">(Int, Int)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and, using the slow addition function </font></font><code><font color="#0000FF">slowAdd()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, creates an array of sums of the numbers that make up the tuple. The loop on the components of the input array is hidden inside </font></font><code><font color="#0000FF">ArraySumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Let's create a group of individual very simple type operations </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The operation </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adds two numbers from the input pair </font></font><code><font color="#0000FF">inputPair</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the slow addition function </font></font><code><font color="#0000FF">slowAdd()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returns the result </font></font><code><font color="#0000FF">output</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/619/c77/9e6/619c779e6118401aaff88a7b6e8b7b79.png" width="650" height="259"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create the most common class </font></font><code><font color="#0000FF">GroupAdd</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that manages the </font></font><code><font color="#0000FF">private</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue of operations </font></font><code><font color="#0000FF">queue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and a variety of operations</font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in order to calculate the sum of all pairs in the input array and place in the output array </font></font><code><font color="#0000FF">outputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tuples ( </font></font><code><font color="#0000FF">Int, Int, Int )</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consisting of input data and result: </font></font><br><br><img src="https://habrastorage.org/web/a59/7f2/c41/a597f2c414f34a969361b8342e5bc35f.png" width="650" height="639"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When initializing an instance of a class, an </font></font><code><font color="#0000FF">GroupAdd</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input array of </font></font><code><font color="#0000FF">input</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pairs of numbers is formed from which type operations are formed </font></font><code><font color="#0000FF">SumOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In </font></font><code><font color="#0000FF">completionBlock</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">each operation, the result is added to the output array </font></font><code><font color="#0000FF">outputArray</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is performed on a single </font></font><code><font color="#0000FF">private</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serial line operations </font></font><code><font color="#0000FF">appendOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to avoid </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B3%25D0%25BE%25D0%25BD%25D0%25BA%25D0%25B8"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">race condition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The class has all the typical operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">methods: </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">wait ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so we can consider it as a "complex operation". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create eq emplyar class</font></font><code><font color="#0000FF">GroupAdd</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, giving the input an array of pairs of numbers: </font></font><br><br><img src="https://habrastorage.org/web/aba/8a1/1b2/aba8a11b254b4d7a8aa6eff75aee0aba.png" width="650" height="227"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start </font></font><code><font color="#0000FF">groupAdd</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wait for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> second and use the method </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to remove all the summation operations from the operation queue. </font><font style="vertical-align: inherit;">As a result, after the completion of all operations (we use </font></font><code><font color="#0000FF">wait()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which can NOT be used on </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but can be on </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), we get a shortened output array: </font></font><br><br><img src="https://habrastorage.org/web/5a5/a71/c14/5a5a71c14b924d628fc74db778f60c76.png" width="650" height="532"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result can be viewed </font></font><code>Playground</code> <code>CancelletionGroup.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 2. We work with a group of dependent operations </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is </font></font><code>CancellationFourImages.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a group of dependent operations, we consider a group of interrelated operations already known to us for downloading an image from the network, filtering and modifying it </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Let's try to arrange this sequence into a separate class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will manage these operations on </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the methods </font></font><code><font color="#0000FF">start ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">wait ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will have two abstract operations (that is, those that have no implementation of the method </font></font><code><font color="#0000FF">main()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). One is the asynchronous operation already familiar to us </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the other is the operation of </font></font><code><font color="#0000FF">ImageTakeOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">extracting the input image </font></font><code><font color="#0000FF">inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the dependencies </font></font><code><font color="#0000FF">dependecies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Based</font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create an image download operation from the ‚Äúnetwork‚Äù at the specified </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> address: </font></font><br><br><img src="https://habrastorage.org/web/e32/bff/60e/e32bff60e2184403b3e0f24d10148678.png" width="700" height="537"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This operation confirms the protocol </font></font><code><font color="#0000FF">ImagePass</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for transmitting the resulting image outputImage further along the chain of operations. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An abstract operation </font></font><code><font color="#0000FF">ImageTakeOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">extracts the input image </font></font><code><font color="#0000FF">inputImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the dependencies </font></font><code><font color="#0000FF">dependecies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, if it is not specified when initializing this operation, and allows you to ‚Äúpick up‚Äù the output image using the already familiar protocol </font></font><code><font color="#0000FF">ImagePass</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used to transfer images in a chain of sequential operations: The </font></font><br><br><img src="https://habrastorage.org/web/696/ed5/0a6/696ed50a60334fd8971edc9eba5bd483.png" width="650" height="545"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abstract class is </font></font><code><font color="#0000FF">ImageTakeOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very convenient to use as an </font></font><code>superclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operation. participating in a chain of dependent operations. For example, for filtering operation </font></font><code><font color="#0000FF">Filter</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/web/2ae/955/3e5/2ae9553e59cd44c8848747c8c0074592.png" width="650" height="259"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Or for the operation of ‚Äúaging‚Äù images in the style of ‚Äúhipster‚Äù </font></font><code><font color="#0000FF">PostProcessImageOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/279/c7d/06e/279c7d06e89f48859863ecf97828c955.png" width="650" height="139"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Or for the operation of ‚Äúthrowing out‚Äù the input image into the external environment with the help of a closure </font></font><code><font color="#0000FF">ImageOutputOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/a40/c95/ff0/a40c95ff0cdc430d93d3f6be9d913e7e.png" width="650" height="274"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's take a class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Create the regular class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that controls the </font></font><code><font color="#0000FF">private</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue operations </font></font><code><font color="#0000FF">operationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the sequence of operations </font></font><code><font color="#0000FF">dataLoad</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">filter</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">output</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to load an image from a given </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the URL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , filter it and pass in the circuit </font></font><code><font color="#0000FF">completion</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/3aa/3db/332/3aa3db33233e4657ac84f9cc94ed6c7b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has all the typical operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">methods: </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">wait ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so we can consider it as a "complex operation ". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create 4 instances of the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/web/ed2/155/8e3/ed21558e3ed346539447447f342349be.png" width="650" height="480"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start loading images: </font></font><br><br><img src="https://habrastorage.org/web/661/3bb/75d/6613bb75d2d148bebd6fbc9b719cfc71.png" width="650" height="178"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are waiting for the completion of operations and we get 4 images: The </font></font><br><br><img src="https://habrastorage.org/web/433/2e7/139/4332e713991c451c843bdfdaecf4a135.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duration of all operations is a little more than 10 seconds. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start loading images, wait 6 seconds and use the method </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to delete all operations. </font><font style="vertical-align: inherit;">As a result, we get the download of only three images - 1st, 3rd and 4th: </font></font><br><br><img src="https://habrastorage.org/web/669/077/028/669077028c294c05b59dcda3d6c1470e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result can be viewed on the Playground </font></font><code>CancelletionFourImages.playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 3. We work with TableViewController and CollectionViewController </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The project code is in a folder </font></font><code>OperationTableViewController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very often, tables in iOS applications contain images that require access to the server, and sometimes additional actions with the resulting ‚Äúfiltering‚Äù image, which was mentioned in the previous section. All this takes considerable time and for smooth scrolling of the table, all manipulations with images must be performed asynchronously outside </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Let's consider the application of the class presented in the previous section </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which performs a group of interrelated operations already known to us for downloading an image from the network, filtering and modifying it </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider as an example a very simple application consisting of only one</font></font><code>Image Table View Controller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, whose table cells contain only images downloaded from the Internet and an activity indicator showing the loading process: </font></font><br><br><img src="https://habrastorage.org/web/1b5/f1e/c78/1b5f1ec78cb04ae49e51888ba60530b5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here‚Äôs what the class </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that serves the screen fragment </font><font style="vertical-align: inherit;">looks like </font></font><code>Image Table View Controller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The </font></font><br><br><img src="https://habrastorage.org/web/e59/318/7b7/e593187b71ed46088b824173175caef5.png" width="650" height="491"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model for the class </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an array of 8 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Eiffel Tower </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Venice - loaded and filtered much longer than the rest </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scottish castle </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arctic-02 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Eiffel Tower </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arctic -16 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arctic -15 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arctic -12 </font></font></li></ol><br><br><img src="https://habrastorage.org/web/3b0/65c/674/3b065c6741334ee5a88e15a52df3999d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The class </font></font><code><font color="#0000FF">ImageTableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the cell of the table into which the image is loaded has the form: </font></font><br><br><img src="https://habrastorage.org/web/bec/a71/97c/beca7197cfa548488b097f10f470fd23.png" width="650" height="566"><br><br> <code>Public API</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this class is a string </font></font><code><font color="#0000FF">imageURLString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">containing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> address of the image. </font><font style="vertical-align: inherit;">But if we set </font></font><code><font color="#0000FF">imageURLString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not equal </font></font><code><font color="#0000FF">nil</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the image will not be loaded, only the indicator in the form of a ‚Äúspinning wheel‚Äù will start working. </font><font style="vertical-align: inherit;">But if we already have a somehow loaded and processed image </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then calling the method </font></font><code><font color="#0000FF">updateImageViewWithImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we will show it in this cell on the screen with the help of a light animation. </font><font style="vertical-align: inherit;">In this class there is an activity indicator </font></font><code><font color="#0000FF">spinner</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that starts if you assign a </font></font><code><font color="#0000FF">imageURLString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value in the method </font></font><code><font color="#0000FF">tableView( _ : cellForRowAt:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The image will be loaded in the delegate methods </font></font><code><font color="#0000FF">UITableViewDelegate</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">responsible for the interaction of the cell </font></font><code><font color="#0000FF">UITableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the table.</font></font><code><font color="#0000FF">UITableView</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><ul><li>        ‚Äî <code><font color="#0000FF">tableView( _ : cellForRowAt:)</font></code> , </li><li>       ‚Äî <code><font color="#0000FF">tableView( _ : willDisplay:forRowAt:)</font></code> , </li><li>      ‚Äî <code><font color="#0000FF">tableView( _ : didEndDisplaying:forRowAt:)</font></code> , </li></ul><br><br><img src="https://habrastorage.org/web/583/c59/b2c/583c59b2c63d4829aacccdcb27c88516.png" width="650" height="549"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A request for asynchronous loading of an image using a class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be moved out of the method </font></font><code><font color="#0000FF">tableView( _ : cellForRowAt:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to make this method as easy as possible. It will be located in the </font></font><code><font color="#0000FF">tableView( _ : willDisplay:forRowAt:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delegate </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">that prepares the cell to become visible. Another </font></font><code><font color="#0000FF">tableView( _ : didEndDisplaying:forRowAt:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delegate </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">will be used to destroy any request to load an image, which it will not have completed by the time the cell leaves the screen. This is a fairly general approach and can be used in any application that works with </font></font><code>TableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This will improve the scrolling performance of the table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But first, back to the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will be used in this application. Unlike the class variant </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that was used in the previous section on</font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we will use its simplified form. Namely, we do not need to </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stop ( </font></font><code><font color="#0000FF">isSuspended = true</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) the operation queue </font><font style="vertical-align: inherit;">when initializing an instance of a class </font><font style="vertical-align: inherit;">, and then specifically start an instance of the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the method </font></font><code><font color="#0000FF">start()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- we immediately start the chain of dependent operations during initialization and set </font></font><code><font color="#0000FF">waitUntilFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal </font></font><code><font color="#0000FF">false</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since this is not the </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application, and we cannot use synchronous method </font></font><code><font color="#0000FF">wait()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/68a/6a0/c1b/68a6a0c1bb474b74a45e8ad8bee1367e.png" width="650" height="525"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, in the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we have an initializer, at the input of which we have to submit a string </font></font><code><font color="#0000FF">imageURLString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> address of the image and the closure </font></font><code><font color="#0000FF">completion</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which </font></font><code>generic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a way returns an image like the </font></font><code><font color="#0000FF">UIImage?</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one who created this instance of the class</font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, instead of using a computed property </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The input closure </font></font><code><font color="#0000FF">completion</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has a signature </font></font><code><font color="#0000FF">(UIImage?) -&gt; ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, takes an image </font></font><code><font color="#0000FF">UIImage?</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returns nothing. It can be used to return to </font></font><code><font color="#0000FF">UITableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, we must allow to destroy an instance of the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will lead to the destruction of all the started operations if the table cell leaves the screen before all operations are completed. Therefore, we have a method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provides asynchronous execution of a group of dependent operations for loading an image from a server, filtering it and delivering it to a method </font></font><code><font color="#0000FF">UITableViewDelegate</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If necessary, we can remove an instance of this class. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go back to </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of loading an image in a method </font></font><code><font color="#0000FF">tableView( _  tableView:, cellForRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we will do it in another delegate method - </font></font><code><font color="#0000FF">tableView( _  tableView: , willDisplay cell:, forRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and then we will delete the images in the method </font></font><code><font color="#0000FF">tableView( _  tableView: , didEndDisplaying cell:, forRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's create an extension </font></font><code><font color="#0000FF">extension</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for these two methods. Let's start with the method </font></font><code><font color="#0000FF">tableView( _  tableView: , willDisplay cell:, forRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/web/fc0/bdc/c07/fc0bdcc0710e406494cc59eebc44315f.png" width="650" height="259"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As in the method </font></font><code><font color="#0000FF">tableView( _  tableView:, cellForRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we will have a cell </font></font><code><font color="#0000FF">cell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">indexPath</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. First, we perform the standard procedure for verifying that the cell is of type </font></font><code><font color="#0000FF">ImageTableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then we create </font></font><code><font color="#0000FF">imageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a string </font></font><code><font color="#0000FF">imageURLs [ (indexPath as NSIndexPath).row ]</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL of the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> image address and a closure that is designed as a ‚Äútail‚Äù closure. In the closure, we get the image </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that needs to be shown in this cell of the table. This </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and we should use to update it.</font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, because if you try to do an update </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the background queue ( </font></font><code>background queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then this will not work, and you will wonder why this image does not appear. We have a </font></font><code><font color="#0000FF">main</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font><font style="vertical-align: inherit;">property </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and all we need to do is call a method </font></font><code><font color="#0000FF">updateImageViewWithImage( image )</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will update the cell we need </font></font><code><font color="#0000FF">UITableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we need to think about the possible removal of the operation. For this we need not to lose the link to the created one </font></font><code><font color="#0000FF">imageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, otherwise we will not be able to find it later and delete the operations associated with it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to the very beginning of the class </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and add a new property with the name </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/215/3a1/4d5/2153a14d5aa548fb8bea1aedb468cde2.png" width="650" height="256"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The property </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a set of objects of the type </font></font><code><font color="#0000FF">imageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is initially empty.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at the bottom of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageProvider.swift</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. You will see there an already existing extension of the </font></font><code><font color="#0000FF">extension</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which confirms the protocol </font></font><code><font color="#0000FF">Hashable</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">required for the sets </font></font><code><font color="#0000FF">Set</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/6b1/b48/959/6b1b48959d304240b48cbcf008095bae.png" width="650" height="180"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get the calculated property </font></font><code><font color="#0000FF">hashValue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the comparison operator for equality </font></font><code><font color="#0000FF">==</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. And now we can set and compare instances of objects </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Go back to </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Now we can track instances of objects </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and add them to the set </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that are currently involved: </font></font><br><br><img src="https://habrastorage.org/web/5b0/a38/9e4/5b0a389e448d4d6f811bc49bd32488d7.png" width="650" height="266"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's go through this code to see step by step what is happening. This is delegate method.</font></font><code>tableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is called just before the cell appears on the screen. At this point, we create </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that asynchronously loads, filters the image and returns the resulting image </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code><font color="#0000FF">completionHandler</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We use </font></font><code><font color="#0000FF">image</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to update </font></font><code><font color="#0000FF">UIImageView</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then we memorize </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the set </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that we can destroy it later. We will do this in the following delegate method </font></font><code>tableView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a name </font></font><code><font color="#0000FF">tableView( _  tableView:, didEndDisplaying cell:, forRowAt indexPath:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is called immediately after the cell leaves the screen. It is here that we need to destroy all the operations of this </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/81d/6b3/c41/81d6b3c419c743dc847bcc8ab852600f.png" width="650" height="218"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this we find </font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for this cell </font></font><code><font color="#0000FF">cell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and use the method of </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font><code><font color="#0000FF">ImageProvider</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which removes all operations of this provider, and then we delete the provider from my set </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. As always, we first perform the standard procedure for verifying that the cell has a type </font></font><code><font color="#0000FF">ImageTableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then we find all providers that have the same row </font></font><code><font color="#0000FF">ImageURLString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as for the given cell. We go through all these providers and remove them, and then remove them from the set </font></font><code><font color="#0000FF">imageProviders</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is all we need to do. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's run the application. </font></font><br><br><img src="https://habrastorage.org/web/d67/a2d/10c/d67a2d10cd3345b4807f53481a0ee9ee.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can see that the activity indicators are working while loading images and scrolling now works very quickly without any delay. Images are empty until they are loaded, and then they are animated. Perfectly. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The project code is in a folder </font></font><code>OperationTableViewController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><a href="https://github.com/BestKora/Operation_OperatioQueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>   <code><font color="#0000FF">Operation</font></code>    <code><font color="#0000FF">OperationQueue</font></code>  <code>GCD</code> </h3><br> <code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">Operations</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have a lot of similar features, but the table shows their differences. </font></font><br><br><img src="https://habrastorage.org/web/460/050/881/4600508815914378b92942a9881bbf74.png"><br><br> <code><font color="#0000FF">DispatchGroup</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can handle the event associated with the complete completion of all tasks, but you must be very careful when running the method </font></font><code><font color="#0000FF">waitUntilAllOperationsAreFinished</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which in no case MUST NOT be </font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As for dependencies ( </font></font><code><font color="#0000FF">dependecies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then all you can do </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is implement a chain of tasks for </font></font><code><font color="#0000FF">private</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sequential ( </font></font><code>serial</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><code><font color="#0000FF">DispatchQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But this is the strongest side </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dependencies ( </font></font><code><font color="#0000FF">dependecies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) on </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be more complex than just chains, and operations can be performed on different queues </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use barriers in</font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to solve the problem of "writers" and "readers", if the sequential ( </font></font><code>serial</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) line is </font></font><code><font color="#0000FF">DispatchQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not suitable. The appropriate solution to this problem is </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very confusing and requires </font></font><code><font color="#0000FF">flags</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very special dependencies. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can delete only </font></font><code><font color="#0000FF">DispatchWorkItems</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Operations </font></font><code><font color="#0000FF">Operations</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be deleted using their own method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or all operations immediately on </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can delete the circuit in </font></font><code><font color="#0000FF">BlockOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both </font><font style="vertical-align: inherit;">can </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">Operations</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perform a SYNCHRONOUS function ASYNCHRONIC. In doing so, the operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supplies us with an object-oriented model for encapsulating all the data for this reusable function, including the implementation</font></font><code>subclasses</code> <code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But often, for simpler tasks that are not burdened with complex dependencies, it is more convenient to use lighter methods </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">than to create an operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In addition, the </font></font><code><font color="#0000FF">Dispatch</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocks </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">take less time to complete: from nanoseconds to milliseconds, and the operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usually takes from a few milliseconds to minutes.</font></font><br><br><h3>  Conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article, we examined the following questions regarding the operation and the </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue of operations </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/web/3b4/99a/3e5/3b499a3e56a141f1ba059f9965e5ceb7.png" width="650" height="339"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. An operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can encapsulate a task and data in one object that has a ‚Äúlife cycle‚Äù and properties that reflect its states. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. </font></font><code><font color="#0000FF">BlockOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an object-oriented "wrapper" around </font></font><code><font color="#0000FF">DispatchQueue.global()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which allows you to track the execution of a closure group instead of losing control of this group on </font></font><code><font color="#0000FF">DispatchQueue.global()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code><font color="#0000FF">BlockOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is convenient to use for simple operations as an alternative </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if you are already using your application </font></font><code><font color="#0000FF">Operations</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and do not want to interfere with them </font></font><code><font color="#0000FF">DispatchQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Operations </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reveal </font><font style="vertical-align: inherit;">their main potential </font><font style="vertical-align: inherit;">if they are launched on</font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Once you have prepared an operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you transfer it to </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which controls the order of execution of all operations, essentially being a very simple model that hides the complexity of multi-threaded programming. </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">similar to </font></font><code><font color="#0000FF">DispatchGroup</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for which you can mix operations with different levels </font></font><code><font color="#0000FF">qualityOfService</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and wait until all operations end. But you must be very careful when you call this </font></font><code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. To include ASYNCHRONOUS functions in the operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we must do something special in order to accurately record its completion. We must manage the ASYNCHRONOUS operation </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manually using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Unsurpassed opportunity operations</font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is that you can combine them into chains of operations to produce a complex dependency graph ( </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). This means that you can very easily define an operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that cannot start until one or more other operations </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have completed. The article shows how a protocol can be used </font></font><code><font color="#0000FF">protocol</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to transfer data between operations </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a dependency graph ( </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). But you must examine your dependency graph in order to avoid cycles that can cause </font></font><code>deadLock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(intractable deadlock), especially if there are dependencies between operations on different ones </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Once you have transferred the transaction </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the queue</font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you have lost control over this operation, because now the queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itself is the schedule for launching operations for execution and manages their implementation. However, you can use the method </font></font><code><font color="#0000FF">cancel ()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in order to prevent the operation from starting. The article shows how to take property into account </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when constructing an operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and how you can delete absolutely all operations on the operation queue </font></font><code><font color="#0000FF">OperationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. The conclusion shows the development of an application that reflects the real scenario when you need to scroll through a table with images obtained from the Internet and requiring additional actions like ‚Äúfiltering‚Äù or ‚Äúaging‚Äù. All this takes considerable time and for smooth scrolling of the table, all manipulations with images must be performed asynchronously outside</font></font><code>main queue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In this application, we used a wide range of techniques for working with an operation </font></font><code><font color="#0000FF">Operation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in particular, with ASYNCHRONOUS OPERATION </font></font><code><font color="#0000FF">AsyncOperation</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and its dependencies ( </font></font><code><font color="#0000FF">dependencies</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which allowed us to achieve a significant improvement in our </font><font style="vertical-align: inherit;">own </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article, together with the </font></font><a href="https://habrahabr.ru/post/320152/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous one,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gives you a complete picture of the multithreaded processing in </font></font><code>Swift 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on iOS that currently exists. Now you can take a full part in the discussion of future multithreaded processing capabilities in </font></font><code>Swift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is being laid right now, when for the version, </font><font style="vertical-align: inherit;">multi-threading ( </font><font style="vertical-align: inherit;">) is </font><font style="vertical-align: inherit;">declared a </font></font><code><a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20170807/038645.html%3Futm_source%3DSubscribers%26utm_campaign%3D568975cd62-EMAIL_CAMPAIGN_2017_08_18%26utm_medium%3Demail%26utm_term%3D0_453402a2e6-568975cd62-261228929">Swift 5</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priority direction in addition to </font></font><code>ABI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stability </font></font><code>concurrency</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Version</font></font><code>Swift 5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It assumes only the beginning of work on a completely new multithreading model, the implementation of which will continue in subsequent versions. </font><font style="vertical-align: inherit;">There are already </font></font><a href="https://gist.github.com/lattner/31ed37682ef1576b16bca1432ea9f782"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proposals for a future multithreading model in Swift 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">So ‚Äúturn on the motors!‚Äù And forward. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The evolution of Swift can now be viewed </font></font><a href="https://apple.github.io/swift-evolution/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>  Links </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><a href="https://developer.apple.com/videos/play/wwdc2015/226/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWDC 2015.Advanced NSOperations (session 226). </font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí </font></font><a href="http://lorenzoboaro.io/2016/01/05/having-fun-with-operation-in-ios.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having fun with NSOperations in iOS</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Üí </font></font><a href="https://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSOperation and NSOperation Query Tutorial in Swift</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Üí </font></font><a href="https://videos.raywenderlich.com/courses/ios-concurrency-with-gcd-and-operations/lessons/11"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iOS Concurrency with GCD and Operations</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Üí </font></font><a href="https://blog.metova.com/concurrency-in-ios/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONCURRENCY IN IOS</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Üí </font></font><a href="https://gist.github.com/lattner/31ed37682ef1576b16bca1432ea9f782"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concurrency in Swift: One possible approach</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/335756/">https://habr.com/ru/post/335756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335742/index.html">How to legally "open" QIWI Wallet and pump it in full</a></li>
<li><a href="../335746/index.html">Forwarding a real video card in a VM with ReactOS</a></li>
<li><a href="../335748/index.html">As we increased the application load by 14% with the help of the new icon design</a></li>
<li><a href="../335750/index.html">Binary search in javascript. Practical example</a></li>
<li><a href="../335754/index.html">Design and Mathematics of Clicker Games</a></li>
<li><a href="../335758/index.html">Five JavaScript debugging tools that are useful to know</a></li>
<li><a href="../335760/index.html">Automate my testing completely, cheaply, forever: QA-mitap announcement in Avito on August 26</a></li>
<li><a href="../335762/index.html">Determining the blocking mode of a TCP socket under Windows</a></li>
<li><a href="../335768/index.html">As we struggle with dynamic libraries in Swift. Yandex experience</a></li>
<li><a href="../335770/index.html">Webcam, Node.js and OpenCV: make a face recognition system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>