<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of working with LongPoll server VKontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! Recently, I decided to get acquainted with the API of the largest social network in Europe - VKontakte. The ‚ÄúFor Developers‚Äù section contain...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of working with LongPoll server VKontakte</h1><div class="post__text post__text-html js-mediator-article">  Good day!  Recently, I decided to get acquainted with the API of the largest social network in Europe - VKontakte.  The ‚ÄúFor Developers‚Äù section contains fairly detailed documentation, and there are quite a few articles on the Internet that help you get started with the VK API, so I decided that there should not be any serious problems in learning.  However, when I got to the LongPoll server, it turned out that there were practically no articles on working with it, and the official documentation is not so complete to fully understand the material being studied.  I had to try by trial and error to understand how LongPoll works, which I managed to do after a while.  I decided to share the material I studied with other people in order to reduce their time learning new things.  Below you can see the sections about which I managed to write. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Basics of working with the API (those who are familiar with the basic methods and requests for them, can skip this paragraph)</b> <div class="spoiler_text">  What is the VKontakte API?  Here is how this official documentation treats: <blockquote>  Callback API is a tool for tracking user activity in your VKontakte community. </blockquote><br>  In other words, it is a way to send requests to VK servers in order to receive a response containing some information.  With the VK API, you can do almost everything: send a message to the user, change the account password, create an album with photos, and so on.  Personally, I use the vk_api library to work with the API, but you can also get away with the requests library.  Now we consider the basic principles of work.  If you decide to use the vk_api library, the sample query will look like this: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk_api session = vk_api.VkApi(token=<span class="hljs-string"><span class="hljs-string">'{ACCESS_TOKEN}'</span></span>) print(session.method(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, {<span class="hljs-string"><span class="hljs-string">'user_ids'</span></span>: <span class="hljs-number"><span class="hljs-number">210700286</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span>: <span class="hljs-string"><span class="hljs-string">'photo_50, city, verified'</span></span>}))</code> </pre> <br>  Let us examine the lines: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk_api</code> </pre>  Here we import the library we need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs">session = vk_api.VkApi(token=<span class="hljs-string"><span class="hljs-string">'{ACCESS_TOKEN}'</span></span>)</code> </pre>  With this line, we log in via access token (the ways to get it are available described in the documentation and on the Internet, I will not focus on them).  Note: not all methods need authorization.  About when it is required will be written in the documentation of the method on the site VKontakte. <br><br><pre> <code class="python hljs">print(session.method(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, {<span class="hljs-string"><span class="hljs-string">'user_ids'</span></span>: <span class="hljs-number"><span class="hljs-number">210700286</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span>: <span class="hljs-string"><span class="hljs-string">'photo_50, city'</span></span>}))</code> </pre>  This part of the code deserves special attention.  What is going on here?  We call the method method, passing it two arguments: the first is the name of the API method, the second is the dictionary of the parameters of this method.  A list of all methods and their parameters is in the API documentation.  In this case, we call the "users.get" method and pass the following parameters: "user_ids" - a list of user id for which we want to receive data, "fields": additional information about users: avatar and city of residence.  The output of the program will be the following output line: <code>[{'id': 210700286, 'first_name': 'Lindsey', 'last_name': 'Stirling', 'city': {'id': 5331, 'title': 'Los Angeles'}, 'photo_50': 'https://pp.userapi.com/c636821/v636821286/38a75/Ay-bEZoJZw8.jpg'}]</code> <br><br>  If you make any mistake, for example, specify the wrong name of the method being called, an exception will be raised: <code>vk_api.exceptions.ApiError: [5] User authorization failed: no access_token passed.</code>  . <br>  Note: if an error is made in the name of an optional parameter, an exception will not be generated, and an unknown parameter will be ignored. <br><br>  If you decide to use requests, you‚Äôll have to go into the API documentation a bit to learn the format of the request and response. <br>  The request should look like this: <code>https://api.vk.com/method/{METHOD_NAME}?{PARAMS}&amp;v={API_VERSION}</code> , where {METHOD_NAME} is the name of the method, {PARAMS} are the parameters of the called method, and {API_VERSION} - the API version that the server should use when generating the response. <br>  As a response, we will be returned a JSON object with information about the results of the method call.  Let's implement an API request using the requests library: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests data = requests.get(<span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/{METHOD_NAME}'</span></span>.format(METHOD_NAME=<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>), params={<span class="hljs-string"><span class="hljs-string">'user_ids'</span></span>: <span class="hljs-number"><span class="hljs-number">210700286</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span>: <span class="hljs-string"><span class="hljs-string">'photo_50, city'</span></span>}).json() print(data)</code> </pre> <br>  So, we analyze the written. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests</code> </pre>  Import library requests <br><br><pre> <code class="python hljs">data = requests.get(<span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/{METHOD_NAME}'</span></span>.format(METHOD_NAME=<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>), params={<span class="hljs-string"><span class="hljs-string">'user_ids'</span></span>: <span class="hljs-number"><span class="hljs-number">210700286</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span>: <span class="hljs-string"><span class="hljs-string">'photo_50, city'</span></span>}).json()</code> </pre>  This line writes the server's response to the data variable.  We give the function get two arguments: the address to which you want to make a request (in our case, a formatted string), and a dictionary of the parameters of this method.  If the method is not called without access token, you need to add it to the dictionary with the key 'access_token'.  The parameter ‚Äúv‚Äù (API version) is not mandatory, since the latest version will be used by default, but if you need to use a different version, you must also add it to the dictionary with the 'v' key.  The json () method that processes JSON objects is applied to the response sent from the server. <br><br>  The last line displays the result of the work, in our case - <code>{'response': [{'uid': 210700286, 'first_name': 'Lindsey', 'last_name': 'Stirling', 'city': 5331, 'photo_50': 'https://pp.userapi.com/c636821/v636821286/38a75/Ay-bEZoJZw8.jpg'}]}</code> . <br><br>  If you pass the wrong method name, the following will be displayed: <code>{'error': {'error_code': 5, 'error_msg': 'User authorization failed: no access_token passed.', 'request_params': [{'key': 'oauth', 'value': '1'}, {'key': 'method', 'value': 'user.get'}, {'key': 'user_ids', 'value': '210700286'}, {'key': 'fields', 'value': 'photo_50, city'}]}}</code> . <br></div></div><br><div class="spoiler">  <b class="spoiler_title">What is LongPoll?</b> <div class="spoiler_text">  For a start, let's ask for help in the documentation: <blockquote>  Long Polling is a technology that allows you to receive information about new events using the "long requests".  The server receives the request, but sends a response to it not immediately, but only when a certain event occurs (for example, a new incoming message arrives), or the specified timeout expires. </blockquote>  In other words, when receiving a request from you, the server waits for an event to occur, about which it should notify you, and when it occurs, Long Poll server sends a response to your request containing information about the incident event. <br>  We will write a program that will notify the user about some changes in his account, which we will receive from the Long Poll server.  To start receiving responses from the server, it is necessary to obtain three required parameters required for Long Poll-a to work: server, key, and ts. <br><blockquote>  key - the secret key of the session; <br>  server - server address; <br>  ts - the number of the last event from which you want to receive data. </blockquote><br>  They do not need to be received each time calling Long Poll, one call will be enough.  It follows from the documentation that these values ‚Äã‚Äãcan be obtained by calling the messages.getLongPollServer method.  We will write a program that will make a request with this method and we will use the data to get to Long Poll. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests token = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#      access_token data = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     print(data)</span></span></code> </pre><br>  If you did everything correctly, the program will display a dictionary with three keys: <code>{'key': '###############################', 'server': 'imv4.vk.com/im####', 'ts': 0000000000}</code> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Request to Long Poll server</b> <div class="spoiler_text">  Now, using the values ‚Äã‚Äãstored in the dictionary that was created in the previous part, we can make a request to the Long Poll server!  To do this, you need to make a request to the following address: <code>https://{$server}?act=a_check&amp;key={$key}&amp;ts={$ts}&amp;wait=25&amp;mode=2&amp;version=2</code> , where {$ server}, {$ key} and {$ ts} are values ‚Äã‚Äãfrom the dictionary with the keys 'server', 'key' and 'ts', respectively, wait is the time that the Long Poll server will wait for updates, and mode is the additional response options.  Let's write a program that will make one request to the Long Poll server <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests token = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#      access_token params = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     response = requests.get('https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=90&amp;mode=2&amp;version=2'.format(server=data['server'], key=data['key'], ts=data['ts'])).json() #    Long Poll     90     2 print(response)</span></span></code> </pre><br>  If an event has occurred in 90 seconds that falls into the list processed by Long Poll server, something similar will appear on the screen: <code>{'ts': 0000000000, 'updates': [[9, -999999999, 0, 1501588841]]}</code> .  What does the answer mean and how can we continue working with it? <br><br>  First, you may have noticed that the response contains the parameter 'ts', which we used when sending the request.  He is here for a reason.  All events that fall into the list of servers processed by Long Poll are numbered.  When you create a new account, the first such event is number 1, the second is 2, and so on.  When sending a request to Long Poll, you need to pass this parameter in order for the server to know from which number you need to send updates.  Each server response also includes this parameter, so that you use it when you next call the Long Poll server. <br><br>  Secondly, the dictionary contains the key 'updates' with a talking name.  It is not difficult to guess that the value of this key stores the updates that occurred after sending the request.  Update format is an array of arrays.  Each array in the array is an update that needs to be processed.  If there are more than one in the first array of arrays, it means that several events occurred simultaneously.  The 'ts' parameter contains the number of the last one.  If the array accessible by the 'updates' key is empty, no events occurred during the wait time.  You ask: "And what are these incomprehensible numbers in the arrays?".  The answer is quite simple - this is information about the event that happened, which can be transformed into a clearer view.  We will deal with their processing later, and in the next part we will write a program that will constantly access the Long Poll server. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Cyclic requests to Long Poll and event codes</b> <div class="spoiler_text">  In order to constantly send requests to Long Poll, I decided to use a loop in order not to overflow the stack with recursion.  Below is the implementation of a program that accesses Long Poll and displays updates on the screen. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests token = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#      access_token data = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     while True: response = requests.get('https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=20&amp;mode=2&amp;version=2'.format(server=data['server'], key=data['key'], ts=data['ts'])).json() #    Long Poll     20    2 updates = response['updates'] if updates: # ,    for element in updates: #       print(element) data['ts'] = response['ts'] #    </span></span></code> </pre> <br>  This program cyclically sends requests to Long Poll, checks if there have been updates, and displays the received updates on the screen.  But the output of this program in the form in which they are now, is no good.  Now the output of the program looks like this: <br> <code>[8, -999999999, 1, 1501592696] <br> [8, -999999999, 7, 1501592862] <br> [9, -999999999, 0, 1501592882] <br> [9, -999999999, 1, 1501592583] <br> [8, -999999999, 4, 1501592893] <br> [9, -999999999, 0, 1501592900]</code> <br>  The first digit in each array indicates the event code.  Using it, you can understand what event happened.  Here is a list of event codes with a brief description (from the official documentation): <br>  1 - Replacing <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D4.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D1%2581%25D0%25BE%25D0%25BE%25D0%25B1%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">message flags</a> (FLAGS: = $ flags); <br>  2 - Set <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D4.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D1%2581%25D0%25BE%25D0%25BE%25D0%25B1%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">message flags</a> (FLAGS | = $ mask); <br>  3 - Reset <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D4.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D1%2581%25D0%25BE%25D0%25BE%25D0%25B1%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">message flags</a> (FLAGS &amp; = ~ $ mask); <br>  4 - Adding a new message; <br>  6 - Read all incoming messages in $ peer_id that came before the message with $ local_id. <br>  7 - Read all outgoing messages in $ peer_id that came before the message with $ local_id. <br>  8 - The friend $ user_id has become online.  $ extra is not equal to 0, if the flag 64 was transmitted in mode. <br>  9 - The friend $ user_id became offline ($ flags is 0 if the user left the site (for example, clicked exit) and 1 if offline by timeout (for example, away status).  $ timestamp - time of the last action of the user $ user_id on the site; <br>  10 - Reset the $ peer_id <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D5.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D0%25B4%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2">dialog flags</a> .  Corresponds to the operation (PEER_FLAGS &amp; = ~ $ flags).  Only for community conversations; <br>  11 - Replacing the <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D5.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D0%25B4%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2">dialog flags</a> $ peer_id.  Corresponds to the operation (PEER_FLAGS: = $ flags).  Only for community conversations; <br>  12 - Setting the <a href="https://vk.com/dev/using_longpoll_2%3Ff%3D5.%2B%25D0%25A4%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%2B%25D0%25B4%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2">flags of the</a> $ peer_id dialog.  Corresponds to the operation (PEER_FLAGS | = $ flags).  Only for community conversations; <br>  13 - Delete all messages in the $ peer_id dialog with identifiers up to $ local_id; <br>  14 - Recently restored (less than 20 days ago) deleted messages in the $ peer_id dialog with identifiers up to $ local_id; <br>  51 - One of the parameters (composition, subject) of the chat $ chat_id conversation has been changed.  $ self - 1 or 0 (whether the changes are caused by the user); <br>  61 - User $ user_id types the text in the dialog.  The event comes once in ~ 5 seconds with constant typing.  $ flags = 1; <br>  62 - User $ user_id dials text in the conversation $ chat_id; <br>  70 - User $ user_id made a call with the identifier $ call_id; <br>  80 - The unread counter in the left menu has become $ count; <br>  112 - Alert settings have changed.  $ peer_id - ID of the chat / interlocutor. <br><br>  Thus, if the first number in the array is 8, then one of your friends has become online, if 9 is offline and so on.  The remaining numbers in the array also have a value, but we will pick them up later, since their value depends on the event code. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Handling incoming events</b> <div class="spoiler_text">  In this part, we implement the handling of events that come to us as an answer.  Let me remind you that these events are presented in the form of arrays with information that needs to be processed.  I suggest starting with code 80 - updating the counter of unread messages, since in my opinion this event is the least complicated.  Here is an example of events with code 80: <br> <code>[80, 0, 0] <br> [80, 1, 0]</code> <br>  The first parameter, as you already know, is the event code.  There remain 2 elements: 0 and 0 in the first case and 1 0 in the second.  The last parameter in code 80 should always be zero, so it can be ignored;  only the second is important to us.  The second parameter indicates how many unread messages the user currently has.  The minimum value is 0 (no new messages), the maximum is unlimited.  This is enough to handle all events with code 80. We implement this into code: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#         ,       while True: response = requests.get('https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=20&amp;mode=2&amp;version=2'.format(server=data['server'], key=data['key'], ts=data['ts'])).json() #    Long Poll     20    2 updates = response['updates'] if updates: # ,    for element in updates: #       action_code = element[0] #      if action_code == 80: #    print('    ', element[1]) #  data['ts'] = response['ts'] #    </span></span></code> </pre> <br>  If you run this program, it will display messages about the change in the number of unread messages.  The following relatively simple updates have codes 8 and 9 - a friend has become online and offline, respectively.  Let's complete our program so that it can process them as well.  Let's start with code 9. Let's write a line that will check the event code: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action_code == <span class="hljs-number"><span class="hljs-number">9</span></span>:</code> </pre> <br>  Next, consider the format of incoming updates with code 9: <br> <code>[9, -000000000, 1, 1501744865]</code> <br>  With the index 0, as you already know, the update code is stored - 9. Next comes the negative id of the user who has become offline (to get the real id, you need to multiply by -1 in order to get rid of the minus).  An element with index 3 can take only 2 values: 0 or 1. 1 means that the ‚Äúoffline‚Äù mark is set after the inactivity timeout expires, and 0 means that the user explicitly left the site, for example, by clicking the ‚Äúexit‚Äù button.  The last value in the response is the time of the last user action on the site at Unix time.  Let's write down all received data in variables: <br><br><pre> <code class="python hljs">user_id = element[<span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-comment"><span class="hljs-comment"># id ,   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] # ,      id = user_id timeout = bool(element[2]) #        - last_visit = element[3] #        Unix time</span></span></code> </pre> <br>  As you can see, in addition to the user's first and last name, we also get his gender.  It is necessary that the program correctly uses the message in the sentences and does not write something like ‚ÄúIvan Ivanov went out from VKontakte‚Äù.  The timeout variable stores False if the user has explicitly left the site, and True if the timeout has expired.  Now you can display the received data: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     "import time",     if user['sex'] == 1: verb = ['', ''] else: verb = ['', ''] if timeout: print(user['first_name'], user['last_name'], verb[0], '   -.     :', time.ctime(last_visit).split()[3]) else: print(user['first_name'], user['last_name'], verb[1], ' .     :', time.ctime(last_visit).split()[3])</span></span></code> </pre> <br>  The only thing that I see unobvious in this code is the time output: <br><br> <code>time.ctime(last_visit).split()[3]</code> <br>  Let's deal with this part of the code.  The ctime function of the time library takes as an argument a number - time in Unix time and returns a string like <code>'Thu Jan 1 03:00:00 1970' <br></code> <code>'Thu Jan 1 03:00:00 1970' <br></code>  .  Since we only need the time of the last action on the site, we split this line using the split method and space the array, where index 0 stores the day of the week, index 1 - month, 2 - number, 3 - time, and 4 - year.  We retrieve the element with the index 3, that is, time. <br><br>  Now we will write the implementation of processing updates with code 8. Their format looks like this: <code>[8, -6892937, 4, 1501750273]</code> .  The second element in the array is the negative id of the user who has become online, the third is the platform from which the user logged in, and the fourth is the time of the last user action on the site at Unix time.  We realize the received data in the code: <br><br><pre> <code class="python hljs">user_id = element[<span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-comment"><span class="hljs-comment"># id ,   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] # ,      id = user_id platform = element[2] #    last_visit = element[3] #     Unix time if user['sex'] == 1: verb = '' else: verb = ''</span></span></code> </pre> <br>  Here we have recorded the data from the answer in variables, and also put the verb in the right gender.  The platform parameter now contains a number in the range from 1 to 7 inclusive.  Each number represents the platform from which the user performed the action.  We translate this number into the text: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      if platform == 1: platform = '   web- VK' elif platform == 2: platform = '  VK  iPhone' elif platform == 3: platform = '  VK  iPad' elif platform == 4: platform = '  VK  Android' elif platform == 5: platform = '  VK  Windows Phone' elif platform == 6: platform = '  VK  Windows' elif platform == 7: platform = ' web- VK'</span></span></code> </pre> <br>  Now you can display information on the screen: <br><br><pre> <code class="python hljs">print(user[<span class="hljs-string"><span class="hljs-string">'first_name'</span></span>], user[<span class="hljs-string"><span class="hljs-string">'last_name'</span></span>], verb, <span class="hljs-string"><span class="hljs-string">' '</span></span>, platform, <span class="hljs-string"><span class="hljs-string">''</span></span>, time.ctime(last_visit).split()[<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br>  Next we look at codes 61 and 62. They report that someone is typing a message.  The difference is that updates with code 61 notify typing in personal messages, and 62 - in conversations.  Updates with code 62 look like this: <code>[62, 000000000, 000]</code> .  The second element of the array is the id of the user who is typing the messages, and the third is the ID of the conversation.  Updates with code 61 are as follows: <code>[61, 000000000, 1]</code> .  Here the value has only the second element - the id of the user typing the message.  Write the event handler: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action_code == <span class="hljs-number"><span class="hljs-number">61</span></span>: user = requests.get(<span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/users.get'</span></span>, params={<span class="hljs-string"><span class="hljs-string">'user_ids'</span></span>: element[<span class="hljs-number"><span class="hljs-number">1</span></span>]}).json()[<span class="hljs-string"><span class="hljs-string">'response'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-comment"><span class="hljs-comment">#      print(user['first_name'], user['last_name'], ' ') elif action_code == 62: user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': element[1]}).json()['response'][0] #     ,   chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': element[2], 'access_token': token}).json()['response']['title'] #    print(user['first_name'], user['last_name'], '    "{}"'.format(chat))</span></span></code> </pre><br>  In the next topic, we will write an inbound message handler and look at the message flags. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Message handling and flags</b> <div class="spoiler_text">  The most interesting update, I think, is the addition of messages.  These updates are code 4 and return information about incoming and outgoing messages.  Here is an example of an update with code 4: <code>[4, $ts, $flag, $id, $unixtime, $text, {'title': ' ... '}]</code> .  Here $ ts is the number of the incoming event, $ flag is the message flags, $ id is the interlocutor's id or 2000000000 + conversation id (in the case of collective dialogs), $ unixtime is the time the message was added in Unix time, and the last element is the dictionary containing information about attachments, sender and changes in the settings of the conversation.  For a start, let's look at where the message was added: in personal correspondence or conversation.  If the message was sent in a conversation, then, as I have already written, in the $ id field there will be indicated a number resulting from the addition of 2,000,000,000 and chat_id (conversation identifier).  If the message was added in personal correspondence, in the $ id field there will be the interlocutor's id, which is always less than 2,000,000,000 + chat_id of any conversation.     , ,  $id ‚Äî 2000000000 &gt; 0,      ,  ,    .      ,  id ,  ,       'from'.   : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action_code == <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> element[<span class="hljs-number"><span class="hljs-number">3</span></span>] - <span class="hljs-number"><span class="hljs-number">2000000000</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment"># ,       user_id = element[6]['from'] # id  chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   if text: # ,     print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'], '  "{}"'.format(chat) + ':', text) else: user_id = element[3] # id  user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   if text: # ,     print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'] + ':', text)</span></span></code> </pre><br> ,      .  Here are some of them: <br><ul><li>      ; </li><li>  -; </li><li>  ,     ; </li><li>       </li></ul><br>      ,   ,        2.    ‚Äî ,      ,   (  ): <br><blockquote> +1:    <br> +2:   <br> +4:      <br> +8:   <br> +16:     <br> +32:   .        <br> +64:    ¬´¬ª <br> +128:   ( ) <br> +256:      <br> +512:    <br> +65536:    .          (      ).     &lt;2. <br></blockquote><br>         .  ,         ,     .  ,      : <br><br><pre> <code class="python hljs">summands = [] <span class="hljs-comment"><span class="hljs-comment"># ,      flag = element[2] #   for number in [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 65536]: #      if flag &amp; number: # ,         summands.append(number) #  ,    </span></span></code> </pre> <br>       ,   , ,     <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> summands:</code> </pre> <br>   ,   ,  : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action_code == <span class="hljs-number"><span class="hljs-number">4</span></span>: summands = [] <span class="hljs-comment"><span class="hljs-comment"># ,      flag = element[2] #   for number in [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 65536]: #      if flag &amp; number: # ,         summands.append(number) #  ,     if 2 not in summands: if element[3] - 2000000000 &gt; 0: # ,       user_id = element[6]['from'] # id  chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   if text: # ,     print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'], '  "{}"'.format(chat) + ':', text) else: user_id = element[3] # id  user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   if text: # ,     print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'] + ':', text)</span></span></code> </pre><br>     -.   ,   ,      , , ,   -: <code>[[4, $ts, $flag, $id, $unixtime, $text, {'attach1_type': 'photo', 'attach1': '$photoId', 'attach2_type': 'video', 'attach2': '$videoId', 'attach3_type': 'audio', 'attach3': '$audioId', 'attach4_type': 'doc', 'attach4': '$docId', 'geo': '2_SVK-le', 'geo_provider': '4', 'title': ' ... '}]</code> .      ,     API     .      (photos.getById  docs.getById)       (   ,       ).          -  ,       .       ,     (    )     . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-number"><span class="hljs-number">512</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> summands: <span class="hljs-comment"><span class="hljs-comment"># ,   - index = 1 photos = [] #    id  docs = [] #    id  media_type = 'attach1_type' while media_type in element[6].keys(): # ,   -    media_type = element[6]['attach{}_type'.format(index)] #  ,    if media_type == 'photo': #     photos.append(element[6]['attach{}'.format(index)]) #  id    elif media_type == 'doc': #     docs.append(element[6]['attach{}'.format(index)]) #  id    index += 1 #   media_type = 'attach{}_type'.format(index) change = lambda ids, type_: requests.get('https://api.vk.com/method/{}.getById'.format(type_), params={type_: ids, 'access_token': token}).json() # ,     if photos: # ,      photos = change(', '.join(photos), 'photos') #  ,    photos   if 'response' in photos.keys(): photos = [attachment['src_xbig'] for attachment in photos['response']] #    print('   :', ', '.join(photos)) else: pass #  ,    if docs: # ,      docs = change(', '.join(docs), 'docs') #  ,    docs   if 'response' in docs.keys(): docs = [attachment['url'] for attachment in docs['response']] #    print('   :', ', '.join(docs)) else: pass #  ,   </span></span></code> </pre><br>   <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> text:</code> </pre> ,      ,  -    . <br><br>         :   ,  ,  ,    .       ,    6     4.    : <br><br><ul><li>   : <code>[4, $ts, $flag, $chat_id, $unixtime, '', {'source_act': 'chat_title_update', 'source_text': ' ', 'source_old_text': ' ', 'from': '$id'}]</code> </li><li>   : <code>[4, $ts, $flag, $chat_id, $unixtime, '', {'attach1_type': 'photo', 'attach1': '247178624_456242629', 'source_act': 'chat_photo_update', 'from': '247178624'}]</code> </li><li>    : <code>[4, $ts, $flag, $chat_id, $unixtime, '', {'source_act': 'chat_invite_user', 'source_mid': '$added_user_id', 'from': '$adder_id'}]</code> </li><li>     (   ): <code>[4, $ts, $flag, $chat_id, $unixtime, '', {'source_act': 'chat_kick_user', 'source_mid': '&amp;removed_user_id', 'from': '&amp;remover_id'}]</code> </li><li>   : <code>[4, $ts, $flag, $chat_id, $unixtime, '', {'source_act': 'chat_create', 'source_text': '', 'from': '$creator_id'}]</code> </li></ul><br>  ,     : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action_code == <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'source_act'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> element[<span class="hljs-number"><span class="hljs-number">6</span></span>].keys(): <span class="hljs-comment"><span class="hljs-comment"># &lt;,  &gt; else: source_act = element[6] if source_act['source_act'] == 'chat_title_update': #        changer_id = source_act['from'] # id ,   source_text = source_act['source_text'] #    source_old_text = source_act['source_old_text'] #    changer = requests.get('https://api.vk.com/method/users.get', params={'user_ids': changer_id, 'fields': 'sex'}).json()['response'][0] #     ,   if changer['sex']: verb = '' else: verb = '' print(changer['first_name'], changer['last_name'], verb, '   "{}"  "{}"'.format(source_old_text, source_text)) elif source_act['source_act'] == 'chat_photo_update': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    user_id = source_act['from'] # id ,   photo_id = source_act['attach1'] # id  photo = requests.get('https://api.vk.com/method/photos.getById', params={'photos': photo_id, 'access_token': token}).json() #    user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] #    ,   if 'error' not in photo.keys(): #        if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}" '.format(chat), photo['response'][0]['src_xbig']) else: pass #  ,      elif source_act['source_act'] == 'chat_invite_user': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    invited_id = source_act['source_mid'] # id  inviter_id = source_act['from'] # id  if invited_id == inviter_id: #         -   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': inviter_id, 'fields': 'sex'}).json()['response'][0] #     if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}"'.format(chat)) else: inviter_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': inviter_id, 'fields': 'sex'}).json()['response'][0] #     invited_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': invited_id, 'name_case': 'acc'}).json()['response'][0] #     if inviter_user['sex']: verb = '' else: verb = '' print(inviter_user['first_name'], inviter_user['last_name'], verb, '  "{}"'.format(chat), invited_user['first_name'], invited_user['last_name']) elif source_act['source_act'] == 'chat_kick_user': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    removed_id = source_act['source_mid'] # id  remover_id = source_act['from'] # id  if removed_id == remover_id: #        user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': remover_id, 'fields': 'sex'}).json()['response'][0] #     if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}"'.format(chat)) else: remover_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': remover_id, 'fields': 'sex'}).json()['response'][0] #     removed_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': removed_id, 'name_case': 'acc'}).json()['response'][0] #     if remover_user['sex']: verb = '' else: verb = '' print(remover_user['first_name'], remover_user['last_name'], verb, '  "{}"'.format(chat), removed_user['first_name'], removed_user['last_name']) elif source_act['source_act'] == 'chat_create': chat = source_act['source_text'] #   creator_id = source_act['from'] # id  creator = requests.get('https://api.vk.com/method/users.get', params={'user_ids': creator_id, 'fields': 'sex'}).json()['response'][0] # ,     if creator['sex']: verb = '' else: verb = '' print(creator['first_name'], creator['last_name'], verb, ' "{}"'.format(chat))</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> .  </b> <div class="spoiler_text">        :     Long Poll    .   . <br><br>  :      ,     ,      KeyError   8: <code>response = requests.get('https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=20&amp;mode=2&amp;version=2'.format(server=data['server'], key=data['key'], ts=data['ts'])).json()['response'] #    Long Poll     20    2</code> .   ,        ¬´error 2¬ª,  ,    &amp;key     .        : <br><br><pre> <code class="python hljs">response = requests.get(<span class="hljs-string"><span class="hljs-string">'https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=20&amp;mode=2&amp;version=2'</span></span>.format(server=data[<span class="hljs-string"><span class="hljs-string">'server'</span></span>], key=data[<span class="hljs-string"><span class="hljs-string">'key'</span></span>], ts=data[<span class="hljs-string"><span class="hljs-string">'ts'</span></span>])).json() <span class="hljs-comment"><span class="hljs-comment">#    Long Poll     20    2 try: updates = response['updates'] except KeyError: #       KeyError,   key ,     data = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     continue #     ,    </span></span></code> </pre><br>   !  : .   .   ,           . , ,     ,     <code>&amp;_amp</code> (  ,        ).         .          ,            sub  re (   !). <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-comment"><span class="hljs-comment"># &lt;...&gt; symbols = {'&lt;br&gt;': '\n', '&amp;_amp;': '&amp;', '&amp;_quot;': '"', '&amp;_lt;': '&lt;', '&amp;_gt;': '&gt;', '&amp;_tilde;': '~', '&amp;_circ;': 'ÀÜ', '&amp;_ndash;': '‚Äì', '&amp;_mdash;': '‚Äî', '&amp;_euro;': '‚Ç¨', '&amp;_permil;': '‚Ä∞'} #       for code, value in symbols.items(): text = re.sub(code, value, text)</span></span></code> </pre><br><br> ,    ,     ,      ,  ,     .      ,     : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests token = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#      access_token data = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     while True: response = requests.get('https://{server}?act=a_check&amp;key={key}&amp;ts={ts}&amp;wait=20&amp;mode=2&amp;version=2'.format(server=data['server'], key=data['key'], ts=data['ts'])).json() #    Long Poll     20    2 try: updates = response['updates'] except KeyError: #       KeyError,   key ,     data = requests.get('https://api.vk.com/method/messages.getLongPollServer', params={'access_token': token}).json()['response'] #     continue #     ,     if updates: # ,    for element in updates: #       action_code = element[0] if action_code == 80: #    print('    ', element[1]) #  elif action_code == 9: user_id = element[1] * -1 # id ,   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] #      id = user_id timeout = bool(element[2]) #        - last_visit = element[3] #       if user['sex'] == 1: verb = ['', ''] else: verb = ['', ''] if timeout: print(user['first_name'], user['last_name'], verb[0], '   -.     :', time.ctime(last_visit).split()[3]) else: print(user['first_name'], user['last_name'], verb[1], ' .     :', time.ctime(last_visit).split()[3]) elif action_code == 8: user_id = element[1] * -1 # id ,   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] #      id = user_id platform = element[2] #    last_visit = element[3] #     Unix time if user['sex'] == 1: verb = '' else: verb = '' #      if platform == 1: platform = '   web- VK' elif platform == 2: platform = '  VK  iPhone' elif platform == 3: platform = '  VK  iPad' elif platform == 4: platform = '  VK  Android' elif platform == 5: platform = '  VK  Windows Phone' elif platform == 6: platform = '  VK  Windows' elif platform == 7: platform = ' web- VK' print(user['first_name'], user['last_name'], verb, ' ', platform, '', time.ctime(last_visit).split()[3]) elif action_code == 61: user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': element[1]}).json()['response'][0] #      print(user['first_name'], user['last_name'], ' ') elif action_code == 62: user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': element[1]}).json()['response'][0] #     ,   chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': element[2], 'access_token': token}).json()['response']['title'] #    print(user['first_name'], user['last_name'], '    "{}"'.format(chat)) elif action_code == 4: if 'source_act' not in element[6].keys(): summands = [] # ,      flag = element[2] #   for number in [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 65536]: #      if flag &amp; number: # ,         summands.append(number) #  ,     if 2 not in summands: if element[3] - 2000000000 &gt; 0: # ,       user_id = element[6]['from'] # id  chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   symbols = {'&lt;br&gt;': '\n', '&amp;_amp;': '&amp;', '&amp;_quot;': '"', '&amp;_lt;': '&lt;', '&amp;_gt;': '&gt;', '&amp;_tilde;': '~', '&amp;_circ;': 'ÀÜ', '&amp;_ndash;': '‚Äì', '&amp;_mdash;': '‚Äî', '&amp;_euro;': '‚Ç¨', '&amp;_permil;': '‚Ä∞'} #       for code, value in symbols.items(): text = re.sub(code, value, text) print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'], '  "{}"'.format(chat) + ':', text) else: user_id = element[3] # id  user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'name_case': 'gen'}).json()['response'][0] #     ,   time_ = element[4] #    text = element[5] #   symbols = {'&lt;br&gt;': '\n', '&amp;_amp;': '&amp;', '&amp;_quot;': '"', '&amp;_lt;': '&lt;', '&amp;_gt;': '&gt;', '&amp;_tilde;': '~', '&amp;_circ;': 'ÀÜ', '&amp;_ndash;': '‚Äì', '&amp;_mdash;': '‚Äî', '&amp;_euro;': '‚Ç¨', '&amp;_permil;': '‚Ä∞'} #       for code, value in symbols.items(): text = re.sub(code, value, text) print(time.ctime(time_).split()[3] + ':', ' ', user['first_name'], user['last_name'] + ':', text) if 512 in summands: # ,   - index = 1 photos = [] #    id  docs = [] #    id  media_type = 'attach1_type' while media_type in element[6].keys(): # ,   -    media_type = element[6]['attach{}_type'.format(index)] #  ,    if media_type == 'photo': #     photos.append(element[6]['attach{}'.format(index)]) #  id    elif media_type == 'doc': #     docs.append(element[6]['attach{}'.format(index)]) #  id    index += 1 #   media_type = 'attach{}_type'.format(index) change = lambda ids, type_: requests.get('https://api.vk.com/method/{}.getById'.format(type_), params={type_: ids, 'access_token': token}).json() # ,     if photos: # ,      photos = change(', '.join(photos), 'photos') #  ,    photos   if 'response' in photos.keys(): photos = [attachment['src_xbig'] for attachment in photos['response']] #    print('   :', ', '.join(photos)) else: pass #  ,    if docs: # ,      docs = change(', '.join(docs), 'docs') #  ,    docs   if 'response' in docs.keys(): docs = [attachment['url'] for attachment in docs['response']] #    print('   :', ', '.join(docs)) else: pass #  ,    else: source_act = element[6] if source_act['source_act'] == 'chat_title_update': #        changer_id = source_act['from'] # id ,   source_text = source_act['source_text'] #    source_old_text = source_act['source_old_text'] #    changer = requests.get('https://api.vk.com/method/users.get', params={'user_ids': changer_id, 'fields': 'sex'}).json()['response'][0] #     ,   if changer['sex']: verb = '' else: verb = '' print(changer['first_name'], changer['last_name'], verb, '   "{}"  "{}"'.format(source_old_text, source_text)) elif source_act['source_act'] == 'chat_photo_update': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    user_id = source_act['from'] # id ,   photo_id = source_act['attach1'] # id  photo = requests.get('https://api.vk.com/method/photos.getById', params={'photos': photo_id, 'access_token': token}).json() #    user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': user_id, 'fields': 'sex'}).json()['response'][0] #    ,   if 'error' not in photo.keys(): #        if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}" '.format(chat), photo['response'][0]['src_xbig']) else: pass #  ,      elif source_act['source_act'] == 'chat_invite_user': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    invited_id = source_act['source_mid'] # id  inviter_id = source_act['from'] # id  if invited_id == inviter_id: #         -   user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': inviter_id, 'fields': 'sex'}).json()['response'][0] #     if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}"'.format(chat)) else: inviter_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': inviter_id, 'fields': 'sex'}).json()['response'][0] #     invited_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': invited_id, 'name_case': 'acc'}).json()['response'][0] #     if inviter_user['sex']: verb = '' else: verb = '' print(inviter_user['first_name'], inviter_user['last_name'], verb, '  "{}"'.format(chat), invited_user['first_name'], invited_user['last_name']) elif source_act['source_act'] == 'chat_kick_user': chat_id = element[3] - 2000000000 # id  chat = requests.get('https://api.vk.com/method/messages.getChat', params={'chat_id': chat_id, 'access_token': token}).json()['response']['title'] #    removed_id = source_act['source_mid'] # id  remover_id = source_act['from'] # id  if removed_id == remover_id: #        user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': remover_id, 'fields': 'sex'}).json()['response'][0] #     if user['sex']: verb = '' else: verb = '' print(user['first_name'], user['last_name'], verb, '  "{}"'.format(chat)) else: remover_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': remover_id, 'fields': 'sex'}).json()['response'][0] #     removed_user = requests.get('https://api.vk.com/method/users.get', params={'user_ids': removed_id, 'name_case': 'acc'}).json()['response'][0] #     if remover_user['sex']: verb = '' else: verb = '' print(remover_user['first_name'], remover_user['last_name'], verb, '  "{}"'.format(chat), removed_user['first_name'], removed_user['last_name']) elif source_act['source_act'] == 'chat_create': chat = source_act['source_text'] #   creator_id = source_act['from'] # id  creator = requests.get('https://api.vk.com/method/users.get', params={'user_ids': creator_id, 'fields': 'sex'}).json()['response'][0] # ,     if creator['sex']: verb = '' else: verb = '' print(creator['first_name'], creator['last_name'], verb, ' "{}"'.format(chat)) data['ts'] = response['ts'] #    </span></span></code> </pre><br>         Long Poll-a,   ,       ¬´¬ª  ¬´¬ª  ,      . <br>     , ,     - .  See you soon! <br><br> : <br><ul><li> <a href="https://vk.com/dev">vk.com/dev</a> </li><li> <a href="https://stackoverflow.com/">stackoverflow.com</a> </li><li> <a href="http://www.htmlhelp.com/">www.htmlhelp.com</a> </li></ul><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/335106/">https://habr.com/ru/post/335106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335094/index.html">Ruby on Rails for marketplace development</a></li>
<li><a href="../335096/index.html">These toxic, toxic job interviews</a></li>
<li><a href="../335098/index.html">Galaxy generation and astronomy basic knowledge training</a></li>
<li><a href="../335102/index.html">Breakthrough in the business process automation market</a></li>
<li><a href="../335104/index.html">Solving a closed transport problem with additional conditions using Python tools</a></li>
<li><a href="../335110/index.html">How the KOMPAS-3D math library turned into a C3D Toolkit for CAD developers ‚Üí part 2</a></li>
<li><a href="../335112/index.html">Model-View-Intent and Load / Update Indicator</a></li>
<li><a href="../335114/index.html">Interactive recommenders: how to create, how to work</a></li>
<li><a href="../335120/index.html">RailsClub 2017: we are waiting for all rubists on September 23 in Moscow</a></li>
<li><a href="../335122/index.html">Speed ‚Äã‚Äãup your website using machine learning.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>