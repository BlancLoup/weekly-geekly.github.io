<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate the selection of arbitrary MySQL records</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the public has revived with the question of a random sample from the table. There are plenty of optimization solutions, and I‚Äôm probably not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate the selection of arbitrary MySQL records</h1><div class="post__text post__text-html js-mediator-article">  Recently, the public has revived with the question of a random sample from the table.  There are plenty of optimization solutions, and I‚Äôm probably not going to show you anything new now, just to remind you about the basic optimization methods ‚Äî simplifying the query and indexing.  Without prefaces about freelancers, immediately to the point;) <br><br><a name="habracut"></a>  Create a table: <blockquote><code>CREATE TABLE `a` ( <br> `id` int(8) unsigned NOT NULL AUTO_INCREMENT, <br> `md5` char(32) NOT NULL <br> PRIMARY KEY (`id`) <br> ) <br> INSERT INTO `a` (`id`) VALUES (null),(null),(null),(null)...   163712  ;) <br> UPDATE `a` SET md5 = MD5(`id`);</code> </blockquote> <br>  Such a table on my antediluvian computer is enough to check the effectiveness. <br>  Here is a simple ORDER BY RAND sample: <blockquote> <code>SELECT * FROM `a` ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.3345 sec) <br> SELECT * FROM `a` ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.2538 sec) <br> SELECT * FROM `a` ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.2299 sec)</code> </blockquote> <br>  I create an indexed field in order not to do a full-scan of the entire table: <blockquote> <code>ALTER TABLE `a` ADD `f` SMALLINT(3) UNSIGNED NOT NULL, ADD INDEX (`f`); <br> UPDATE `a` SET `f` = RAND()*1000;</code> </blockquote>  The number 1000 is the main accelerating factor.  To them, I reduce the table in which an ordinary ORDER BY RAND will pass 1000 times.  With a table of 163712 rows, you should get about 164 rows per f.  Checking: <blockquote> <code>SELECT COUNT(1) FROM `a` WHERE `f` = 123; -&gt; 169</code> </blockquote> <br>  Random is random, a uniform distribution would be good, but this is fantastic (although you know, you can use the first MD5 signs (`id`) and translate it into INT, there is nowhere more uniform).  So, now for me one f came across both 200 rows and 100. If this indicator becomes ineffective with time, then you can always increase the factor and get, say, 25-75 rows per index.  The main thing that there was at least as many rows as we need to pull randomly.  Column f can be regenerated periodically, or after 1000 calls to the table.  When inserting new rows get the value f = 0, which will not affect the quality of the samples, or set random values ‚Äã‚Äãfor inserts too. <br><br>  I do a test sample of 10 rows using what I have indexed: <blockquote> <code>SELECT * FROM `a` WHERE `f` = 231 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0801 sec) <br> SELECT * FROM `a` WHERE `f` = 231 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0017 sec)</code> </blockquote>  Aha, the second time turned out a re-sorted sample from the mysql cache.  If the repetition of the results is not very scary, then such a more nimble result will fit, but it is better to change the number f with each query. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I repeat the test by changing f: <blockquote> <code>SELECT * FROM `a` WHERE `f` = 396 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0147 sec) <br> SELECT * FROM `a` WHERE `f` = 753 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0020 sec) <br> SELECT * FROM `a` WHERE `f` = 189 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0019 sec) <br> SELECT * FROM `a` WHERE `f` = 945 ORDER BY RAND() LIMIT 10; -&gt; (10 rows, Query took 0.0235 sec)</code> </blockquote> <br>  In general, the sampling performance has risen 120 times and this is without any kind of complication.  I see in this solution a lot of amenities: <ul><li>  no need to climb far into the wilds and wrestle with "a pancake like this one I had ... oh yeah the procedure." </li><li>  simple integration;) the request code was complicated by just one condition. </li><li>  Well, the third is called extensibility: add your conditions and you will further reduce the size of the scan, thereby increasing the sampling rate. </li></ul>  If one gap of 160 rows is not enough for us, then you can include as many intervals as you want: <blockquote> <code>SELECT * FROM `a` WHERE `f` IN (100,500) ORDER BY RAND() LIMIT 10;</code> </blockquote> <br><h2>  More life example </h2><br>  For this example, take the top <a href="http://habrahabr.ru/blogs/mysql/54176/">comment from the next post</a> , which is solved as follows.  We emit the RSS feeds table by adding the feed field containing the feed number: <blockquote> <code>ALTER TABLE `a` ADD `feed` TINYINT(1) UNSIGNED NOT NULL, ADD INDEX (`feed`); <br> UPDATE `a` SET feed = RAND()*9;</code> </blockquote>  And now, actually, feint ears: <blockquote> <code>(SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 0 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 1 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 2 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 3 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 4 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 5 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 6 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 7 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 8 ORDER BY RAND() LIMIT 10) <br> UNION (SELECT * FROM `a` WHERE `f` = 283 AND `feed` = 9 ORDER BY RAND() LIMIT 10) <br> ORDER BY feed; -&gt; (97 rows, Query took 0.7973 sec) <br>   f -&gt; (99 rows, Query took 0.0093 sec) <br>   f -&gt; (98 rows, Query took 0.0197 sec)</code> </blockquote>  Here it is desirable to choose more than 10 rows for fidelity;) and filter the extra for PHP. <br><br>  In PHP, it is also advisable to set the number f, so as not to make two requests to the MySQL server.  Although it is not critical.  This will also work very quickly: <blockquote> <code>SET @rnd = RAND(); SELECT * FROM `a` WHERE `f` = @rnd ORDER BY RAND() LIMIT 10;</code> </blockquote> <br>  As you can see, not only by complication can optimization be achieved (in this article I optimized speed).  Now you have a question to think about, and I will state in a future article.  How can you optimize the <u>quality of</u> random samples, first of all get rid of repetitions?  ;) <br><br>  Respectfully, <br>  Mayam </div><p>Source: <a href="https://habr.com/ru/post/55864/">https://habr.com/ru/post/55864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../55842/index.html">How I saved the document in Bitrix</a></li>
<li><a href="../55843/index.html">Regular expressions - character classes, construction of choice, metasequence</a></li>
<li><a href="../55845/index.html">Mobify - Mobile Publishing Service</a></li>
<li><a href="../55850/index.html">IE vs all or Hide and seek</a></li>
<li><a href="../55859/index.html">Michael Haene - Business Card Dentist</a></li>
<li><a href="../55865/index.html">Alexa recorded Habr's takeoff - what was it?</a></li>
<li><a href="../55870/index.html">Questions for interviews with Program Manager in the division of Connected Systems Yevgeny Osovetsky</a></li>
<li><a href="../55873/index.html">You can add the latest blog topics to the right column.</a></li>
<li><a href="../55874/index.html">Rise of alternative energy sources</a></li>
<li><a href="../55875/index.html">MountainWest RubyConf 2009</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>