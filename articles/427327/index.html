<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MVVM architecture in mobile applications on Flutter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I started learning Flutter and recently spent the whole day trying to integrate the Model-View-ViewModel architecture into my application on Flutter. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MVVM architecture in mobile applications on Flutter</h1><div class="post__text post__text-html js-mediator-article"><p>  I started learning Flutter and recently spent the whole day trying to integrate the Model-View-ViewModel architecture into my application on Flutter.  I usually write for Android in Java, I implement MVVM using AndroidViewModel and LiveData / MutableLiveData.  That is, the experience of programming and applying a pattern is, the application is a simple timer.  So nothing foreshadowed so much time-consuming for a simple task. </p><br><p>  The search for articles and instructions on MVVM in Flutter (without using RxDart) gave <a href="https://quickbirdstudios.com/blog/mvvm-in-flutter/">one example</a> without reference to the full source, so I want to make it a little easier for those interested in learning this pattern in Flutter. </p><a name="habracut"></a><br><h3>  Project </h3><br><p>  <a href="https://github.com/Yahhi/pomodoro_on_flutter/tree/2c3c123cec67b3ac4445740fafcedac2ebe49f1e">A project without MVVM</a> is a single screen with a countdown timer.  By pressing the button, the timer starts or pauses depending on the state.  When time runs out, a notification is issued or a sound is played. </p><br><h3>  Model Description </h3><br><p>  Let's start the implementation of MVVM, first I described the interface that I would need for the interaction between the widget and the model (the file timer_view_model.dart was created): <br><br></p><pre><code class="plaintext hljs">abstract class TimerViewModel { Stream&lt;bool&gt; get timerIsActive; Stream&lt;String&gt; get timeTillEndReadable; Stream&lt;bool&gt; get timeIsOver; void changeTimerState(); }</code> </pre> <br>  That is, I want to receive button state change events (stop the timer - continue), to know when the timer is over, to get the time that needs to be displayed on the screen.  I also want to stop / start the timer.  Strictly speaking, the description of this interface is optional, here I just want to show what is required of the model. <br><h3>  ViewModel implementation </h3><br><p>  Further implementation of the model is the file timer_view_model_impl.dart </p><br><p>  The timer works in fact as a StreamController with one subscriber.  The basis for the code is taken from <a href="https://www.dartlang.org/articles/libraries/creating-streams">this article</a> .  There is just a description of the controller, which runs on a timer and can be paused and started again.  In general, almost a perfect match.  Code changed for my task: <br><br></p><pre> <code class="plaintext hljs">static Stream&lt;DateTime&gt; timedCounter(Duration interval, Duration maxCount) { StreamController&lt;DateTime&gt; controller; Timer timer; DateTime counter = new DateTime.fromMicrosecondsSinceEpoch(maxCount.inMicroseconds); void tick(_) { counter = counter.subtract(oneSec); controller.add(counter); // Ask stream to send counter values as event. if (counter.millisecondsSinceEpoch == 0) { timer.cancel(); controller.close(); // Ask stream to shut down and tell listeners. } } void startTimer() { timer = Timer.periodic(interval, tick); } void stopTimer() { if (timer != null) { timer.cancel(); timer = null; } } controller = StreamController&lt;DateTime&gt;( onListen: startTimer, onPause: stopTimer, onResume: startTimer, onCancel: stopTimer); return controller.stream; }</code> </pre> <br><p>  Now, how does the start and stop of the timer work through the model: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><pre> <code class="plaintext hljs">@override void changeTimerState() { if (_timeSubscription == null) { print("subscribe"); _timer = timedCounter(oneSec, pomodoroSize); _timerIsEnded.add(false); _timerStateActive.add(true); _timeSubscription = _timer.listen(_onTimeChange); _timeSubscription.onDone(_handleTimerEnd); } else { if (_timeSubscription.isPaused) { _timeSubscription.resume(); _timerStateActive.add(true); } else { _timeSubscription.pause(); _timerStateActive.add(false); } } }</code> </pre> <br>  To start the timer, you need to subscribe to it <code>_timeSubscription = _timer.listen(_onTimeChange);</code>  .  Stop / continue implemented through pause / resume subscriptions ( <code>_timeSubscription.pause();</code> / <code>_timeSubscription.resume();</code> ).  It also records the _timerStateActive timer activity status stream and the flow of information about whether or not the _timerIsEnded timer has been turned on. <br><br><p>  All thread controllers require initialization.  Also add initial values. <br><br></p><pre> <code class="plaintext hljs">TimerViewModelImpl() { _timerStateActive = new StreamController(); _timerStateActive.add(false); _timerIsEnded = new StreamController(); _timeFormatted = new StreamController(); DateTime pomodoroTime = new DateTime.fromMicrosecondsSinceEpoch(pomodoroSize.inMicroseconds); _timeFormatted.add(DateFormat.ms().format(pomodoroTime)); }</code> </pre> <br><p>  Getting streams, as described in the interface: <br><br></p><pre> <code class="plaintext hljs">@override Stream&lt;bool&gt; get timeIsOver =&gt; _timerIsEnded.stream; @override Stream&lt;bool&gt; get timerIsActive { return _timerStateActive.stream; } @override Stream&lt;String&gt; get timeTillEndReadable =&gt; _timeFormatted.stream;</code> </pre> <br><p>  That is, to write something to the stream, you need a controller.  Just so take and put something there can not (exception - when the stream is generated in one function).  And already the widget takes ready-made threads, which are controlled by the model controllers. </p><br><h3>  Widget and state </h3><br><p>  Now to the widget.  ViewModel is initialized in the state constructor <br><br></p><pre> <code class="plaintext hljs">_MyHomePageState() { viewModel = new TimerViewModelImpl(); }</code> </pre> <br><p>  Then, in the initialization, listeners are added for the streams: <br><br></p><pre> <code class="plaintext hljs"> viewModel.timerIsActive.listen(_setIconForButton); viewModel.timeIsOver.listen(informTimerFinished); viewModel.timeTillEndReadable.listen(secondChanger);</code> </pre> <br>  Listeners are almost the same functions that were before, only a check for null was added and _setIconForButton changed a bit: <br><br><pre> <code class="plaintext hljs">Icon iconTimerStart = new Icon(iconStart); Icon iconTimerPause = new Icon(iconCancel); void _setIconForButton(bool started) { if (started != null) { setState(() { if (started) { iconTimer = iconTimerPause; } else { iconTimer = iconTimerStart; } }); } }</code> </pre> <br>  The remaining changes in main.dart are the removal of all timer logic - now it lives in the ViewModel. <br><h3>  Conclusion </h3><br><p>  My version of the MVVM implementation does not use additional widgets (such as StreamBuilder), the composition of the widgets remains the same.  The situation is similar to how ViewModel and LiveData are used in Android.  That is, the model is initialized, then listeners are added that are already responding to changes in the model. </p><br><p>  <a href="https://github.com/Yahhi/pomodoro_on_flutter/tree/eaca1c9bad21f1e674584a8df57d21f89777eb06">Project repository with all changes</a> </p></div><p>Source: <a href="https://habr.com/ru/post/427327/">https://habr.com/ru/post/427327/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427317/index.html">To be successful in IT or what kills IT's?</a></li>
<li><a href="../427319/index.html">Gentlemen‚Äôs UE4 Programmer Kit, Part 1</a></li>
<li><a href="../427321/index.html">Neuro-headset for every day - how it is done, why it is needed and what it will turn us into</a></li>
<li><a href="../427323/index.html">Infrastructure for microservices. K8s and all</a></li>
<li><a href="../427325/index.html">Quick start with WPF. Part 1. Binding, INotifyPropertyChanged and MVVM</a></li>
<li><a href="../427329/index.html">IBM overcomes the 7 nm barrier using graphene to place nanomaterials on substrates</a></li>
<li><a href="../427331/index.html">Review of the international version of the smartphone Xiaomi Mi Max 3 - my razmerchik</a></li>
<li><a href="../427333/index.html">Color Temperature Conversion (K) to RGB: Algorithm and Sample Code</a></li>
<li><a href="../427335/index.html">Read data from an old MiniScribe hard drive.</a></li>
<li><a href="../427337/index.html">Parsing Joker 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>