<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comet ‚Äì application for Mochiweb with a load of 1 000 000 users. Part 2/3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1 
 Part 3 

 In Part 1, we created a (slightly useless) mochiweb application that sends a message to clients every 10 seconds. We configured the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comet ‚Äì application for Mochiweb with a load of 1 000 000 users. Part 2/3</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/erlang/111252/"><i>Part 1</i></a> <br>  <a href="http://habrahabr.ru/blogs/erlang/111600/"><i>Part 3</i></a> <br><br>  In <a href="http://habrahabr.ru/blogs/erlang/111252/">Part 1,</a> we created a (slightly useless) mochiweb application that sends a message to clients every 10 seconds.  We configured the Linux kernel, and created a tool to establish many connections to test memory usage.  We found that it takes approximately 45 KB for each connection. <br><br>  In Part 2, we will turn our application into something useful, and reduce the memory consumption: <br>  ‚Ä¢ Implementing a message router with login / logout / send API; <br>  ‚Ä¢ Update mochiweb applications to work with the router; <br>  ‚Ä¢ Installing a distributed erlang system, so we can run the router on different nodes; <br>  ‚Ä¢ Creating a router testing tool with a large number of messages; <br>  ‚Ä¢ Schedule memory usage for 24 hours, optimization of mochiweb application to save memory. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This means that we will separate the message delivery logic and the mochiweb application.  In tandem with the floodtest utility from part 1, we can test the application in conditions close to industrial. <br>  Implementing a Message Router <br><a name="habracut"></a><br>  The router API contains only 3 functions: <br>  ‚Ä¢ login (Id, Pid) registers the process for receiving messages; <br>  ‚Ä¢ logout (Pid) stops receiving messages; <br>  ‚Ä¢ send (Id, Msg) sends messages to the client. <br>  Note that for one process it is possible to log in with different Id. <br><br>  This router module uses 2 ets tables as an example to store bidirectional maps between Pids and Ids.  (pid2id and id2pid in the #state record): <br><pre><code class="hljs pgsql">-module(router). -behaviour(gen_server). -export([start_link/<span class="hljs-number"><span class="hljs-number">0</span></span>]). -export([init/<span class="hljs-number"><span class="hljs-number">1</span></span>, handle_call/<span class="hljs-number"><span class="hljs-number">3</span></span>, handle_cast/<span class="hljs-number"><span class="hljs-number">2</span></span>, handle_info/<span class="hljs-number"><span class="hljs-number">2</span></span>, terminate/<span class="hljs-number"><span class="hljs-number">2</span></span>, code_change/<span class="hljs-number"><span class="hljs-number">3</span></span>]). -export([send/<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">login</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span>, logout/<span class="hljs-number"><span class="hljs-number">1</span></span>]). -define(<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">global</span></span>:whereis_name(?MODULE)). % will hold bidirectional <span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span> <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> id &lt;‚Äì&gt; pid -<span class="hljs-type"><span class="hljs-type">record</span></span>(state, {pid2id, id2pid}). start_link() -&gt; gen_server:start_link({<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>, ?MODULE}, ?MODULE, [], []). % sends Msg <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> anyone <span class="hljs-keyword"><span class="hljs-keyword">logged</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Id send(Id, Msg) -&gt; gen_server:<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(?<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>, {send, Id, Msg}). <span class="hljs-keyword"><span class="hljs-keyword">login</span></span>(Id, Pid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_pid(Pid) -&gt; gen_server:<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(?<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>, {<span class="hljs-keyword"><span class="hljs-keyword">login</span></span>, Id, Pid}). logout(Pid) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_pid(Pid) -&gt; gen_server:<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(?<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>, {logout, Pid}). init([]) -&gt; % <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> this so we can catch death <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">logged</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pids: process_flag(trap_exit, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>), % use ets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> routing <span class="hljs-keyword"><span class="hljs-keyword">tables</span></span> {ok, #state{ pid2id = ets:<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(?MODULE, [bag]), id2pid = ets:<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(?MODULE, [bag]) } }. handle_call({<span class="hljs-keyword"><span class="hljs-keyword">login</span></span>, Id, Pid}, _From, State) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_pid(Pid) -&gt; ets:<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(State#state.pid2id, {Pid, Id}), ets:<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(State#state.id2pid, {Id, Pid}), link(Pid), % tell us <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> they <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>, so we can <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> them <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> io:format("~w logged in as ~w\n",[Pid, Id]), {reply, ok, State}; handle_call({logout, Pid}, _From, State) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_pid(Pid) -&gt; unlink(Pid), PidRows = ets:lookup(State#state.pid2id, Pid), <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PidRows <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> [] -&gt; ok; _ -&gt; IdRows = [ {I,P} || {P,I} &lt;- PidRows ], % invert tuples % <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> pid-&gt;id entries ets:<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(State#state.pid2id, Pid), % <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> id-&gt;pid [ ets:delete_object(State#state.id2pid, Obj) || Obj &lt;- IdRows ] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, io:format("pid ~w logged out\n",[Pid]), {reply, ok, State}; handle_call({send, Id, Msg}, _From, State) -&gt; % <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> pids who are <span class="hljs-keyword"><span class="hljs-keyword">logged</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> this Id Pids = [ P || { _Id, P } &lt;- ets:lookup(State#state.id2pid, Id) ], % send Msg <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> them <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> M = {router_msg, Msg}, [ Pid ! M || Pid &lt;- Pids ], {reply, ok, State}. % handle death <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cleanup <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">logged</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> processes handle_info(<span class="hljs-keyword"><span class="hljs-keyword">Info</span></span>, State) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> {<span class="hljs-string"><span class="hljs-string">'EXIT'</span></span>, Pid, _Why} -&gt; % force logout: handle_call({logout, Pid}, blah, State); Wtf -&gt; io:format("Caught unhandled message: ~w\n", [Wtf]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, {noreply, State}. handle_cast(_Msg, State) -&gt; {noreply, State}. terminate(_Reason, _State) -&gt; ok. code_change(_OldVsn, State, _Extra) -&gt; {ok, State}.</code> </pre> <br><br><h4>  Update mochiweb applications </h4><br>  Let's assume that the user is represented by an integer Id based on the URL by which it is connected to mochiweb, and uses this identifier to register with the message router.  Instead of blocking every 10 seconds, mochiweb is blocked when receiving messages from the router, and sends an HTTP message to the client for each request that the router sends to it: <br><br>  ‚Ä¢ Client connects to mochiweb via <a href="http://localhost:8000/test/123">http: // localhost: 8000 / test / 123</a> ; <br>  ‚Ä¢ the Mochiweb application registers a Pid for this connection with the identifier '123' in the message router; <br>  ‚Ä¢ If you send a message to the router to the address '123', it will be transmitted to the correct mochiweb process, and will appear in the browser for this user. <br><br>  Here is the updated version of mochiconntest_web.erl: <br><pre> <code class="hljs rust">-module(mochiconntest_web). -export([start/<span class="hljs-number"><span class="hljs-number">1</span></span>, stop/<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span>]). %% External API start(Options) -&gt; {DocRoot, Options1} = get_option(docroot, Options), Loop = fun (Req) -&gt; ?MODULE:<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>(Req, DocRoot) end, % we<span class="hljs-symbol"><span class="hljs-symbol">'ll</span></span> set our maximum to <span class="hljs-number"><span class="hljs-number">1</span></span> million connections. (<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-number"><span class="hljs-number">2048</span></span>) mochiweb_http:start([{max, <span class="hljs-number"><span class="hljs-number">1000000</span></span>}, {name, ?MODULE}, {<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>, Loop} | Options1]). stop() -&gt; mochiweb_http:stop(?MODULE). <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>(Req, DocRoot) -&gt; <span class="hljs-string"><span class="hljs-string">"/"</span></span> ++ Path = Req:get(path), case Req:get(method) of Method when Method =:= <span class="hljs-symbol"><span class="hljs-symbol">'GET</span></span>'; Method =:= <span class="hljs-symbol"><span class="hljs-symbol">'HEAD</span></span>' -&gt; case Path of <span class="hljs-string"><span class="hljs-string">"test/"</span></span> ++ Id -&gt; Response = Req:ok({<span class="hljs-string"><span class="hljs-string">"text/html; charset=utf-8"</span></span>, [{<span class="hljs-string"><span class="hljs-string">"Server"</span></span>,<span class="hljs-string"><span class="hljs-string">"Mochiweb-Test"</span></span>}], chunked}), % login using an integer rather than a string {IdInt, _} = string:to_integer(Id), router:login(IdInt, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>()), feed(Response, IdInt, <span class="hljs-number"><span class="hljs-number">1</span></span>); _ -&gt; Req:not_found() end; <span class="hljs-symbol"><span class="hljs-symbol">'POST</span></span>' -&gt; case Path of _ -&gt; Req:not_found() end; _ -&gt; Req:respond({<span class="hljs-number"><span class="hljs-number">501</span></span>, [], []}) end. feed(Response, Id, N) -&gt; receive {router_msg, Msg} -&gt; Html = io_lib:format(<span class="hljs-string"><span class="hljs-string">"Recvd msg #~w: '~s'"</span></span>, [N, Msg]), Response:write_chunk(Html) end, feed(Response, Id, N+<span class="hljs-number"><span class="hljs-number">1</span></span>). %% Internal API get_option(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options) -&gt; {proplists:get_value(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options), proplists:delete(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options)}.</code> </pre><br><br><h4>  It is working! </h4><br>  Now let's get everything in order - we will use 2 erlang shells, one for mochiweb and one for the router.  Modify start-dev.sh, used to start mochiweb, and add the following additional parameters to erl: <br>  ‚Ä¢ -sname n1 to name the erlang node 'n1' <br>  ‚Ä¢ + K true to enable kernel-poll. <br>  ‚Ä¢ + P 134217727 - the maximum number of processes you can generate is 32768. We need one process for each connection, but I don‚Äôt know how much we need specifically.  134 217 727 - the maximum value according to ‚Äúman erl‚Äù. <br><br>  Now run make &amp;&amp; ./start-dev.sh, and you should see the greeting: (n1 @ localhost) 1&gt; - Your mochiweb application is now running, and the host erlang has a name. <br><br>  Now run another erlang shell: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">erl</span></span> -sname n2</code> </pre><br>  At the moment, those two erlang nodes do not know about each other, fix this: <br><pre> <code class="hljs scala">(n2<span class="hljs-meta"><span class="hljs-meta">@localhost</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span>&gt; nodes(). [] (n2<span class="hljs-meta"><span class="hljs-meta">@localhost</span></span>)<span class="hljs-number"><span class="hljs-number">2</span></span>&gt; net_adm:ping(n1<span class="hljs-meta"><span class="hljs-meta">@localhost</span></span>). pong (n2<span class="hljs-meta"><span class="hljs-meta">@localhost</span></span>)<span class="hljs-number"><span class="hljs-number">3</span></span>&gt; nodes(). [n1<span class="hljs-meta"><span class="hljs-meta">@localhost</span></span>]</code> </pre><br>  Now compile and run the router: <br><pre> <code class="hljs css">(<span class="hljs-selector-tag"><span class="hljs-selector-tag">n2</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">localhost</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">4</span></span>&gt; c(router). {<span class="hljs-selector-tag"><span class="hljs-selector-tag">ok</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span>} (<span class="hljs-selector-tag"><span class="hljs-selector-tag">n2</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">localhost</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">5</span></span>&gt; router:start_link(). {<span class="hljs-selector-tag"><span class="hljs-selector-tag">ok</span></span>,&lt;0<span class="hljs-selector-class"><span class="hljs-selector-class">.38</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>&gt;}</code> </pre><br><br>  Now for interest, open <a href="http://localhost:8000/test/123">http: // localhost: 8000 / test / 123</a> in your browser (or use the lynx --source " <a href="http://localhost:8000/test/123">http: // localhost: 8000 / test / 123</a> " from the console).  Check the shell in which you started the router, you should see that one user is logged in. <br><br>  You can now send messages to the router and watch them appear in your browser.  For now, use only strings, because we use the ~ s parameter for output, and the atom will result in an error: <br><pre> <code class="hljs perl">(n2@localhost)<span class="hljs-number"><span class="hljs-number">6</span></span>&gt; router:<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>). (n2@localhost)<span class="hljs-number"><span class="hljs-number">7</span></span>&gt; router:<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>(<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">"Why not open another browser window too?"</span></span>). (n2@localhost)<span class="hljs-number"><span class="hljs-number">8</span></span>&gt; router:<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>(<span class="hljs-number"><span class="hljs-number">456</span></span>, <span class="hljs-string"><span class="hljs-string">"This message will go into the void unless you are connected as /test/456 too"</span></span>).</code> </pre><br>  Check your browser, you received a message :) <br><br><h4>  Running a distributed erlang system </h4><br>  It makes sense to run the router and mochiweb on different machines.  Suppose you have several spare machines for testing, you must run the erlang shells as distributed nodes, that is, use -name n1@host1.example.com instead of -sname n1 (and the same for n2).  Make sure they can see each other using net_adm: ping (...) as in the example above. <br><br>  I note that on line 16 in router.erl, the process name of the router ('router') is registered globally, which is why we use the following macro to identify the location of the router in the gen_server calls, even in a distributed system: <br><pre> <code class="hljs pgsql">-define(<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">global</span></span>:whereis_name(?MODULE)).</code> </pre><br>  The global naming convention for processes in a distributed system is just one of the many things you get for free with Erlang. <br><br><h4>  Generating a large number of messages </h4><br>  In a real environment, we could see a pattern like a ‚Äúlong-tail‚Äù with some very active users and many passive users.  However, for this test we will send indiscriminate fake messages indiscriminately to random users. <br><pre> <code class="hljs sql">-module(msggen). -export([<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span>]). <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, _, _) -&gt; ok; <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Num</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Interval</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Max</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> = random:<span class="hljs-keyword"><span class="hljs-keyword">uniform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Max</span></span>), router:send(<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>, <span class="hljs-string"><span class="hljs-string">"Fake message Num = "</span></span> ++ <span class="hljs-keyword"><span class="hljs-keyword">Num</span></span>), receive <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Interval</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Num</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Interval</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Max</span></span>) end.</code> </pre><br><br>  This code will send Num messages to random user IDs between 1 and Max every Interval ms. <br><br>  You can see this in action if you run the router and the mochiweb application, go to <a href="http://localhost:8000/test/3">http: // localhost: 8000 / test / 3</a> and run: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">erl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-sname</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">localhost</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">1</span></span>&gt; net_adm:ping(n1@localhost). pong (test@localhost)<span class="hljs-number"><span class="hljs-number">2</span></span>&gt; c(msggen). {<span class="hljs-selector-tag"><span class="hljs-selector-tag">ok</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">msggen</span></span>} (<span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">localhost</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">3</span></span>&gt; msggen:start(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>). ok</code> </pre><br>  20 messages will be sent to random Identifiers between 1 and 5, every 10 ms, one message.  You may be lucky and you will receive several messages. <br><br>  We can even run several of them in parallel to model multiple sources for messages.  Here is an example of 10 processes, each sending 20 messages to identifiers 1-5 with a delay of 100 ms between each message: <br><pre> <code class="hljs django"><span class="xml"><span class="xml">[ spawn(fun() -&gt; msggen:start(20, 100, 5), io:format("~w finished.\n", [self()]) end) || _ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lists:seq</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">) ]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag"> [&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.97.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.98.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.99.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.100.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.101.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.102.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.103.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.104.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.105.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.106.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">] </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.101.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.105.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.106.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.104.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.102.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.98.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.99.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.100.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.103.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished. </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.97.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> finished.</span></span></code> </pre><br><br><h4>  C10K </h4><br>  We have all the parts for a wider scale test;  Clients connect to our mochiweb app, which registers them with a message router.  We can generate a large volume of fake messages to send to the router, which will send them to any registered clients.  Let's check 10,000 parallel connected again from Part 1, but this time we will leave all the clients connected while we run a lot of messages through the system. <br><br>  Suppose you followed the instructions in part 1 to configure your kernel, etc.  You already have a mochiweb application and router running, so let's get more traffic on them. <br>  Without connected clients, mochiweb uses approximately 40 MB of memory: <br><pre> <code class="hljs ruby">$ ps -o rss= -p <span class="hljs-string"><span class="hljs-string">`pgrep -f 'sname n1'`</span></span> <span class="hljs-number"><span class="hljs-number">40156</span></span></code> </pre><br>  I came up with this disgusting command to display the time, the current memory usage of the mochiweb application, and the number of connections established every 60 seconds: <br><pre> <code class="hljs perl">$ MOCHIPID=<span class="hljs-string"><span class="hljs-string">`pgrep -f 'name n1'`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ <span class="hljs-number"><span class="hljs-number">1</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> NUMCON=<span class="hljs-string"><span class="hljs-string">`netstat -n | awk '/ESTABLISHED/ &amp;&amp; $4=="127.0.0.1:8000"' | wc -l`</span></span>; MEM=<span class="hljs-string"><span class="hljs-string">`ps -o rss= -p $MOCHIPID`</span></span>; echo -e <span class="hljs-string"><span class="hljs-string">"`date`\t`date +%s`\t$MEM\t$NUMCON"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>; done | tee -a mochimem.log</code> </pre><br>  If someone knows the best way to graphically depict memory usage for a single process, over time, please leave a comment. <br><br>  Now start the floodtest from Part 1 in the new erl shell: <br><pre> <code class="hljs 1c">erl&gt; floodtest:start(<span class="hljs-string"><span class="hljs-string">"/tmp/mochi-urls.txt"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>).   <span class="hljs-number"><span class="hljs-number">100</span></span>    , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span>  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  . Stats: {<span class="hljs-number"><span class="hljs-number">825</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">1629</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">2397</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">3218</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">4057</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">4837</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">5565</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">6295</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">7022</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">7727</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">8415</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">9116</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">9792</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} ...</code> </pre><br>  Check memory usage: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:24</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518244 40388 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:58</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:25</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518305 41120 263 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:27</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518367 65252 5267 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518432 89008 9836 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:37</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518497 90748 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:41</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518561 90964 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:03</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:46</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518626 90964 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:04</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518691 90964 10001</code> </pre><br>  Achieved 10,000 concurrent connections (plus one that I opened in firefox), and a mochiweb memory consumption of approximately 90 MB (90964 KB). <br><br>  Now let's send some messages: <br><pre> <code class="hljs django"><span class="xml"><span class="xml">erl&gt; [ spawn(fun() -&gt; msggen:start(1000000, 100, 10000) end) || _ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lists:seq</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">100</span></span></span></span><span class="xml"><span class="hljs-tag">) ]</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag"> [&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.65.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.66.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.67.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.68.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.69.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.70.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.71.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.72.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.73.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.74.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.75.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.76.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.77.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.78.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.79.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.80.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.81.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.82.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.83.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.84.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.85.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.86.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.87.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.88.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">, </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.89.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.90.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.91.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.92.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">,</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">0.93.0</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">|...]</span></span></code> </pre><br>  100 processes send a million messages at 10 messages per second to a random Id from 1 to 10,000. This means that the router processes 1000 messages per second, and on average each of our 10k clients will receive one message every 10 seconds. <br><br>  Check the floodtest output and you will see that clients receive http messages (remember that this is {NumConnected, NumClosed, NumChunksRecvd}): <br><pre> <code class="hljs erlang">... Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">5912</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">15496</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">25145</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">34755</span></span>} Stats: {<span class="hljs-number"><span class="hljs-number">10000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">44342</span></span>} ...</code> </pre><br>  A million messages of 10 per second for each process will take 27 hours to work.  Below is the memory usage in the first 10 minutes: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:24</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518244 40388 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:58</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:25</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518305 41120 263 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:27</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518367 65252 5267 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518432 89008 9836 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:37</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518497 90748 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:41</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518561 90964 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:03</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:46</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518626 90964 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:04</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518691 90964 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:05</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:55</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518755 90980 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:07</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518820 91120 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:08</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:05</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518885 98664 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:09</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224518950 106752 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224519015 114044 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:11</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224519080 119468 10001 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 20 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:25</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BST</span></span> 2008 1224519145 125360 10001</code> </pre><br>  You can see that the size has already grown from 40 MB to 90 MB when all 10 k clients were connected, and up to 125 MB after a while. <br><br>  It is worth pointing out that floodtest uses almost no CPU, msggen uses 2% of the CPU, and the router and mochiweb less than 1%. <br><br><h4>  Results after running within 24 hours </h4><br>  The application worked for 24 hours while monitoring the mochiweb process memory usage.  10,000 connected clients, 1000 messages per second sent to random clients. <br>  The following trick was used to force gnuplot to draw a graph: <br><pre> <code class="hljs tex">(echo -e "set terminal png size 500,300<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nset</span></span></span></span> xlabel <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>Minutes Elapsed<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nset</span></span></span></span> ylabel <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>Mem (KB)<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nset</span></span></span></span> title <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>Mem usage with 10k active connections, 1000 msg/sec<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nplot</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>-<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span> using 1:2 with lines notitle" ; awk 'BEGIN{FS="<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>";} NR<span class="hljs-comment"><span class="hljs-comment">%10==0 {if(!t){t=$2} mins=($2-t)/60; printf("%d %d\n",mins,$3)}' mochimem.log ; echo -e "end" ) | gnuplot &gt; mochimem.png</span></span></code> </pre><br><img src="https://habrastorage.org/storage/habraeffect/56/5e/565e818668f609642fc949c00038241e.png"><br><br>  This graph shows that memory usage (with 10k active connections and 1000 msg / sec) is aligned to 250 MB in a 24-hour period.  The two lower extremums appeared due to the fact that I performed for interest: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">erl</span></span>&gt; <span class="hljs-selector-attr"><span class="hljs-selector-attr">[erlang:garbage_collect(P) || P &lt;- erlang:processes()]</span></span>.</code> </pre><br>  This forces all processes to collect garbage, and to release approximately 100 MB of memory.  We are now exploring ways to preserve memory without resorting to manually forcing the garbage collection. <br><br><h4>  Reduce mochiweb memory usage </h4><br>  Notice, the mochiweb application only sends messages and then immediately forgets them, memory usage should not increase with the number of messages sent. <br><br>  I am a newbie when it comes to Erlang memory management, but I‚Äôm going to assume that if I can force him to collect garbage more often, it will allow us to redirect much of that memory, and ultimately allow us to serve more users with unfilled system by memory. <br><br>  The study of documentation gave some result: <br><br>  <a href="http://www.erlang.org/doc/man/erlang.html">erlang: system_flag (fullsweep_after, Number)</a> <br>  Intriguing, but this applies only to new processes and affects all processes in the VM, not just our mochiweb processes. <br><br>  Further: <br>  <a href="http://www.erlang.org/doc/man/erlang.html">erlang: system_flag (min_heap_size, MinHeapSize)</a> <br>  It might be useful, but I'm pretty sure our mochiweb processes need a bigger ‚Äúheap‚Äù than the default anyway.  I would like to avoid the need to change the source code of mochiweb. <br><br>  Next I noticed: <br>  <a href="http://www.erlang.org/doc/man/erlang.html">erlang: hibernate (Module, Function, Args)</a> <br>  It sounds reasonable - let's try to go into sleep mode after each message and see what happens. <br><br>  Edit mochiconntest_web.erl and change the following: <br>  ‚Ä¢ Change the last line of the feed (Response, Id, N) function to go to sleep mode instead of calling itself; <br>  ‚Ä¢ Call hibernate () immediately by sending a message to the router instead of blocking by receive; <br>  ‚Ä¢ Do not forget to export feed / 3. <br><br>  Updated mochiconntest_web.erl with sleep mode between messages: <br><pre> <code class="hljs rust">-module(mochiconntest_web). -export([start/<span class="hljs-number"><span class="hljs-number">1</span></span>, stop/<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span>, feed/<span class="hljs-number"><span class="hljs-number">3</span></span>]). %% External API start(Options) -&gt; {DocRoot, Options1} = get_option(docroot, Options), Loop = fun (Req) -&gt; ?MODULE:<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>(Req, DocRoot) end, % we<span class="hljs-symbol"><span class="hljs-symbol">'ll</span></span> set our maximum to <span class="hljs-number"><span class="hljs-number">1</span></span> million connections. (<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-number"><span class="hljs-number">2048</span></span>) mochiweb_http:start([{max, <span class="hljs-number"><span class="hljs-number">1000000</span></span>}, {name, ?MODULE}, {<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>, Loop} | Options1]). stop() -&gt; mochiweb_http:stop(?MODULE). <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>(Req, DocRoot) -&gt; <span class="hljs-string"><span class="hljs-string">"/"</span></span> ++ Path = Req:get(path), case Req:get(method) of Method when Method =:= <span class="hljs-symbol"><span class="hljs-symbol">'GET</span></span>'; Method =:= <span class="hljs-symbol"><span class="hljs-symbol">'HEAD</span></span>' -&gt; case Path of <span class="hljs-string"><span class="hljs-string">"test/"</span></span> ++ IdStr -&gt; Response = Req:ok({<span class="hljs-string"><span class="hljs-string">"text/html; charset=utf-8"</span></span>, [{<span class="hljs-string"><span class="hljs-string">"Server"</span></span>,<span class="hljs-string"><span class="hljs-string">"Mochiweb-Test"</span></span>}], chunked}), {Id, _} = string:to_integer(IdStr), router:login(Id, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>()), % Hibernate this process until it receives a message: proc_lib:hibernate(?MODULE, feed, [Response, Id, <span class="hljs-number"><span class="hljs-number">1</span></span>]); _ -&gt; Req:not_found() end; <span class="hljs-symbol"><span class="hljs-symbol">'POST</span></span>' -&gt; case Path of _ -&gt; Req:not_found() end; _ -&gt; Req:respond({<span class="hljs-number"><span class="hljs-number">501</span></span>, [], []}) end. feed(Response, Id, N) -&gt; receive {router_msg, Msg} -&gt; Html = io_lib:format(<span class="hljs-string"><span class="hljs-string">"Recvd msg #~w: '~w' "</span></span>, [N, Msg]), Response:write_chunk(Html) end, % Hibernate this process until it receives a message: proc_lib:hibernate(?MODULE, feed, [Response, Id, N+<span class="hljs-number"><span class="hljs-number">1</span></span>]). %% Internal API get_option(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options) -&gt; {proplists:get_value(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options), proplists:delete(<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>, Options)}.</code> </pre><br><br>  I made these changes, rebuilt mochiweb, then redid the same test. <br><br><h4>  Results after running for 24 hours with proc_lib: hibernate () </h4><br><img src="http://habrastorage.org/storage/habraeffect/86/2d/862db0f921039a0413e07e85e0108748.png"><br><br>  Using hibernate () means that the mochiweb application memory is aligned to 78 MB with 10 k connections, much better than the 450 MB we saw in part 1. There was no significant increase in CPU usage. <br><br><h4>  So... </h4><br>  We created a Comet application for Mochiweb that allows us to send arbitrary messages to users identified by an integer ID.  <b>After driving 1000 messages per second for 24 hours, with 10,000 connected users, we observed the use of 80 MB of memory, or 8 KB per user.</b>  We even made nice graphics. <br><br>  This is really progress. <br><br><h4>  Next steps </h4><br>  In part 3, I will increase the number of users to 1 million.  I will conduct tests on a multiprocessor machine with enough memory.  I will also show some additional tricks and tweaks to simulate 1 million connections. <br><br>  The application will develop into a kind of ‚Äúpub-sub‚Äù system, where subscriptions are associated with user Id and saved by the application.  We will use a typical set of social network data: friends.  This will allow the user to log in with their user ID and automatically receive any event generated by one of their friends. </div><p>Source: <a href="https://habr.com/ru/post/111350/">https://habr.com/ru/post/111350/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111341/index.html">Review of Huawei E960 3G router</a></li>
<li><a href="../111343/index.html">Mac App Store - First Impressions</a></li>
<li><a href="../111345/index.html">Native interfaces in Qt</a></li>
<li><a href="../111346/index.html">Apple launches Mac App Store</a></li>
<li><a href="../111347/index.html">Processors Sandy bridge</a></li>
<li><a href="../111351/index.html">Free digital signature for open drivers</a></li>
<li><a href="../111354/index.html">Experience the first application for Windows Phone 7 Series using Silverlight</a></li>
<li><a href="../111356/index.html">Some subtleties of IT outsourcing</a></li>
<li><a href="../111357/index.html">Multiplexed I / O</a></li>
<li><a href="../111358/index.html">Designing power subsystem electronic meter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>