<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Yandex.DZen, the caching plugin for WordPress and hosting have increased my pressure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article, rather, from the series "hostess note." Well, a little more about personal experiences and razdolbaystve. 

 If you have to deal with si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Yandex.DZen, the caching plugin for WordPress and hosting have increased my pressure</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/12/3o/cf/123ocfvpows898t7vrwuhhveguo.jpeg" alt="image" width="100%"><br><br>  This article, rather, from the series "hostess note."  Well, a little more about personal experiences and razdolbaystve. <br><br>  If you have to deal with sites on WordPress, on which the WP Super Cache caching plugin is installed, then the article may be useful for you.  Otherwise, it's just a little story. <br><a name="habracut"></a><br>  In short, the beginning of the story is this: the site lived.  Thematic information and news.  Made by an unknown master on CMS WordPress.  And done exactly as the funds of its owner allowed at that moment.  Over time, the site gained popularity, the number of visitors grew.  The site itself "earned" by advertising.  Those.  the more visitors, the better.  At some point, with peak loads, the site began to fail: pages were loading slowly and all that.  But, of course, until the rooster pecked, no one really moved.  The rooster appeared at the moment when the site was supposed to cover some event that attracted the attention of the public.  The visitors came running, the site went to bed, and all the expected income was melting before our eyes.  Due to circumstances, I had to act as a resuscitator.  About this I wrote <a href="https://habr.com/post/347134/">an article</a> then.  My decision was horrible (do not repeat), but the main goal was fulfilled - dreams were saved.  Basically. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, no one was interested in repeating this situation and worked on the site.  First of all, we found out the reasons for the fall and high load on the server.  They were commonplace: the lack of caching on the site as such and a poorly implemented mechanism for accounting and displaying the number of views of articles.  The latter in itself created a decent load: with each request for the article page, he took from the database the number of views of this article, output it, and then add one and write back to the database.  At the same time, the <b>wp_postmeta</b> table with metadata was used for storage (as it seems to be called in WP).  In which the mass was kept completely unrelated to the accounting of information views and which was very large. <br><br>  The problem of caching was solved simply: in a calm atmosphere, the WP Super Cache plugin was installed normally.  What, many, if I remember correctly, advised me to make instead of the eerie crutch that I built in the comments to my article.  Honestly, even then I was poorly oriented in the WordPress ecosystem, and therefore that crutch appeared.  The caching plug-in was set up and set up by knowledgeable people already, and it well stood right out of the box.  Thus, the caching problem was solved.  Why this particular plugin was chosen - I do not know for sure.  As far as I understand, this is one of the most popular plugins of this type for WP. <br><br>  In view of the views received a little differently.  It is clear that the original mechanism had to be abandoned.  I didn‚Äôt want to refuse to take into account viewing itself: at least, it was shown that it was showing blocks like ‚Äúthe most popular articles of the week.  All plug-ins to record views, even if they were ‚Äúfriends‚Äù with the cache plug-in, turned out to be very voracious and, most often, implemented the same mechanism with recording and extracting data from wp_postmeta.  For a small site, this is quite suitable.  For a site with fairly solid peak attendance rates, it is no longer there: too gluttonous for such a small function.  Here it turned out that unused hosting paid for the years ahead turned up.  The easiest and cheapest.  The duties of storing, recording and returning data about views were piled on him.  Everything is asynchronous, i.e.  even if it falls, the main site will continue to calmly display articles, advertisements and everything that should show.  The online storage of the browsing data was assigned to Redis, and the long-term storage was assigned to MySQL.  So it turns, there is not particularly requests and eats out 1-2% of the maximum allowed load on that hosting. <br><br>  And now, it takes quite a long time.  Again the night and again the old story.  The site is quite powerful traffic and the site begins to fall.  And again, I am the only awake conditional specialist in the district.  I am, of course, surprised by the repetition of events.  First thought - someone accidentally turned off caching.  But no, in the source code of the site page, which gives me a falling server, I see signs of a caching plug-in.  Everything should be ok.  But in the server control panel, I see that there is no RAM left, the number of queries to the database is incredible and everything is bad.  First of all, I open a page with a description of the plug-in, quickly run through her eyes, find nothing and leave this occupation.  The next step is to look at the statistics.  I see that the main stream of traffic flows to the site with Yandex.DZen.  And the query that leads the user to the site looks like this: <br><br><blockquote>  https://example.com <b>? utm_referrer = https:% 2F% 2Fzen.yandex.com</b> </blockquote><br>  Those.  Yandex.DZen adds its utm-tag to the address.  Since the server is already completely lying and gives me only 500, then I can‚Äôt really check the theory that pages with such a ‚Äúappendix‚Äù are not cached for some reason.  Therefore, the next ‚Äúcrutch‚Äù is born (it was later replaced): a redirect is added to .htaccess, which converts the request with utm-tags into a request without them before WordPress and all its powerful plug-ins come into play.  The machine restarts and, voila, everything works: the site loads quickly, the server rustles quietly at low revs.  Like nothing was. <br><br>  Then I relaxed and climbed calmly to see the settings for the caching plug-in.  First of all - a tick "Do not cache pages with GET parameters", which is there.  Everything is fine, it is not worth it.  Plus, as the experiment showed, the plugin does an excellent job of caching requests with any set of arbitrary parameters.  If these are not utm-tags (in fact, I cut with a redirect only requests of a certain kind, but not all where there are utm-tags). <br><br>  This is where I took a closer look (using CTRL + F) to the page of the plugin.  And I found there in the FAQ the glorious item ‚ÄúHow should I use the utm_source tracking tools in Google Analytics with this plugin?‚Äù.  It is clear that at the first cursory inspection I safely ignored him: it seemed to be nothing in common with the problem.  At the same time, by the way, it is not that very informative and does not offer any specific solution. <br><br>  <b>The only possible useful conclusion in the article is:</b> if you have a WP site with the WP Super Cache plugin, then check what it does (or does not do), if you request it with the parameters ‚Äú? Utm_referrer = https:% 2F% 2Fzen‚Äù. yandex.com "etc.  I'm not sure that when installing this plugin, everyone reads its FAQ so carefully.  The concrete implementation, apparently, remains with the site owners: when I last looked at updating this plugin, I did not see any changes regarding its strange reaction to the utm-tags. <br><br>  But the story would be incomplete (and I would not tell it), if it had not happened yet another confirmation of Murphy‚Äôs law.  While we peacefully corresponded with the site owner and watched the site work quietly for about an hour ... the site crashed.  Unexpectedly and finally.  No access to the server control panel, does not work FTP, SSH and everything else.  Nothing works.  If before that my pressure was only slightly raised by solving the task that Ya. Zen threw and caching plug-in (after all, this is a separate pleasure - to quickly understand and repair something in light-hearted hassle), then the whole mini-panic attack happened to me.  And only a vague feeling that with a couple of lines in .htaccess it is impossible to kill everything in an hour after inserting these lines, did not allow the ‚Äúmini‚Äù to grow into something more complete.  In general, after a couple of minutes of exchange of surprised messages, we got into the personal account of the hosting provider with whom the server lives.  And there in the tickets we found a warning about the "technical work from X to Y to MSK".  The most interesting thing is that in the mail, no matter how we looked for, we did not find any messages from the host about these works.  The ticket was at least a day old.  Prior to this, such messages came to the post office, and no one usually doesn‚Äôt look at all at all for helpdesk tickets (and the host‚Äôs office itself) without special need.  Therefore, what happened was a big surprise.  After that we scolded the hoster‚Äôs eyes, laughed, waited until everything worked and went to sleep. <br><br>  Here is a story. </div><p>Source: <a href="https://habr.com/ru/post/423005/">https://habr.com/ru/post/423005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422993/index.html">Burnout OLED TVs in real tests</a></li>
<li><a href="../422995/index.html">QA mitap in Redmadrobot</a></li>
<li><a href="../422997/index.html">The book "Modern PHP"</a></li>
<li><a href="../422999/index.html">Create your own dataset with aliens</a></li>
<li><a href="../423003/index.html">Peskov: Roscomnadzor requirements for Facebook are not super complex</a></li>
<li><a href="../423007/index.html">‚ÄúFaint, but good‚Äù: how we took the students to practice</a></li>
<li><a href="../423009/index.html">SENS-Diagnosis. Protein glycation biomarkers</a></li>
<li><a href="../423011/index.html">Managing Microservices with Kubernetes and Istio</a></li>
<li><a href="../423013/index.html">How to organize your dependencies in a Vue application</a></li>
<li><a href="../423015/index.html">Git: Common Errors and Corrections</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>