<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lightning-fast JSON in Ruby on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Outputting the result in JSON is fairly simple in Rails: 



render json: @statuses  
 This works fine if you need to display a small number of record...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lightning-fast JSON in Ruby on Rails</h1><div class="post__text post__text-html js-mediator-article">  Outputting the result in JSON is fairly simple in Rails: <br><br><pre><code class="ruby hljs">render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @statuses</code> </pre> <br>  This works fine if you need to display a small number of records.  But what happens if we need to print 10,000 entries at once?  Productivity will earn seriously, and the most time consuming will be JSON serialization and database operations. <br><br><img src="https://habrastorage.org/storage2/818/b9f/047/818b9f04766632a87ea6f0755faeeec1.jpg"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Include only necessary attributes. </h4><br>  The first obvious solution is to generate JSON with only the attributes we need, that is: <br><br><pre> <code class="ruby hljs">render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @statuses, <span class="hljs-symbol"><span class="hljs-symbol">methods:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:latitude</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:longitude</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:timestamp</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:virtual_odometer</span></span>]</code> </pre><br>  Filtered JSON will give us more than a 20% performance boost: <br><br><pre> <code class="bash hljs">default 5.940000 0.080000 6.020000 ( 6.094221) attrs 4.820000 0.010000 4.830000 ( 4.932337)</code> </pre><br><br><h4>  Only select the required fields. </h4><br>  The second solution is to take away from the base not all, but only the fields we need. <br><br><pre> <code class="ruby hljs">render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @statuses.select([<span class="hljs-symbol"><span class="hljs-symbol">:latitude</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:longitude</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:timestamp</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:virtual_odometer</span></span>])</code> </pre><br>  This will help us to avoid transferring a huge amount of unnecessary data from the database to the application and will give us a 2x speed boost: <br><br><pre> <code class="bash hljs">default 5.940000 0.080000 6.020000 ( 6.094221) attrs 4.820000 0.010000 4.830000 ( 4.932337) select 2.170000 0.020000 2.190000 ( 2.222277)</code> </pre><br><br><h4>  Do not initialize ActiveRecord objects if possible. </h4><br>  Let's implement a method that will return a ‚Äúlightning-fast‚Äù array of hashes instead of ActiveRecord objects: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lightning</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select_all</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(select([</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:latitude</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:longitude</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:timestamp</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:virtual_odometer</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span>.arel).each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|attrs|</span></span> attrs.each_key <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|attr|</span></span> attrs[attr] = type_cast_attribute(attr, attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This also works like a <a href="">pluck</a> method, but returns an array of hashes, rather than an array of values ‚Äã‚Äãfor one field.  Call our new method in the controller: <br><br><pre> <code class="ruby hljs">render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> @statuses.lightning</code> </pre><br>  The use of lightweight hashes speeds up the creation of JSON by a factor of 2: <br><br><pre> <code class="bash hljs">default 5.940000 0.080000 6.020000 ( 6.094221) attrs 4.820000 0.010000 4.830000 ( 4.932337) select 2.170000 0.020000 2.190000 ( 2.222277) lightning 1.120000 0.010000 1.130000 ( 1.148763)</code> </pre><br><br><h4>  Use the fastest JSON dumper </h4><br>  Currently there are several JSON libraries available: <br><ul><li>  <a href="https://github.com/flori/json">JSON</a> - <a href="https://github.com/flori/json">JSON</a> gem by default (+ C extensions, shipped with Ruby 1.9) </li><li>  <a href="https://github.com/brianmario/yajl-ruby">Yajl</a> - Yet Another JSON Library (by Brian Lopez) </li><li>  <a href="https://github.com/ohler55/oj">Oj</a> - Optimized JSON (by Peter Ohler) </li></ul><br>  A good idea to use the fastest one: <br><br><pre> <code class="bash hljs">json 0.810000 0.020000 0.830000 ( 0.841307) yajl 0.760000 0.020000 0.780000 ( 0.809903) oj 0.640000 0.010000 0.650000 ( 0.666230)</code> </pre><br>  So we choose Oj dumper: <br><br><pre> <code class="ruby hljs">render <span class="hljs-symbol"><span class="hljs-symbol">json:</span></span> Oj.dump(@statuses.lightning, <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:compat</span></span>)</code> </pre><br>  Generalized <a href="https://gist.github.com/a012d50e817373c08f79">test</a> results: <br><br><pre> <code class="bash hljs"> user system total real default 5.940000 0.080000 6.020000 ( 6.094221) attrs 4.820000 0.010000 4.830000 ( 4.932337) select 2.170000 0.020000 2.190000 ( 2.222277) lightning 1.120000 0.010000 1.130000 ( 1.148763) json 0.810000 0.020000 0.830000 ( 0.841307) yajl 0.760000 0.020000 0.780000 ( 0.809903) oj 0.640000 0.010000 0.650000 ( 0.666230)</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/152719/">https://habr.com/ru/post/152719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152699/index.html">Mozilla has announced an updated OpenID equivalent</a></li>
<li><a href="../152703/index.html">Site owners can help in the search for missing people.</a></li>
<li><a href="../152707/index.html">New Brief: Samsung Launches Third-Generation Mobile DRAM Memory LPDDR3</a></li>
<li><a href="../152709/index.html">Stay a week before the Pattern & Practice Summit Russla conference</a></li>
<li><a href="../152713/index.html">PCS, 3G and mobile security. Terra Incognita?</a></li>
<li><a href="../152721/index.html">In Lviv, they are asked to provide Java with the status of a regional language *</a></li>
<li><a href="../152723/index.html">Why iron is not the main thing</a></li>
<li><a href="../152725/index.html">Paul Graham. Why "hairdresser" can not be a startup. Part 1</a></li>
<li><a href="../152729/index.html">ICS released for Sony Xperia Go, U and Sola</a></li>
<li><a href="../152731/index.html">Writing image map editor (html image map) on javascript / html5 / inline SVG</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>