<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unsuccessful notes on ASP.NET MVC. Part 1 (and only)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently on Habr√© often began to appear articles on ASP.NET MVC. However, in this article I would like to make a few notes about building applications...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unsuccessful notes on ASP.NET MVC. Part 1 (and only)</h1><div class="post__text post__text-html js-mediator-article">  Recently on Habr√© often began to appear articles on ASP.NET MVC.  However, in this article I would like to make a few notes about building applications on the above framework: the minimum set of NuGet-packages (without which it is a sin to start work), logging, pitfalls when using standard membership-, profile-providers.  And finally, why the Web API from MVC 4 is what we have all been waiting for. <br><a name="habracut"></a><br><h3>  NuGet-packages </h3><br>  So, let's decide without which packages you cannot start developing a web application on ASP.NET MVC.  In the list below, although there are those [packages] that are set by default when creating a solution, but I will still include them. <br><ul><li>  Entity Framework 4.1 (along with Code First) - data access </li><li>  jQuery (UI, Validation) - [no comments] </li><li>  Microsoft Web Helpers </li><li>  MvcScaffolding - code generation </li><li>  Ninject (MVC3) - dependency injection </li><li>  NLog (Config, Extended, Schema) - logging </li><li>  PagedList (MVC3) is a very convenient package for ‚Äúpage turning‚Äù. </li><li>  Lucene (SimpleLucene) - search </li><li>  Reactive Extensions for JS - client </li></ul><br>  <strong><a href="http://nuget.org/packages/entityframework">Entity Framework 4.1</a></strong> - the question arises, why is it?  Well, I will explain with an example.  There is a sufficient number of other similar, superior, and so on. ORM frameworks (one NHibernate is worth something).  A couple of years ago, I would recommend to start using lightweight (relatively, judging by synthetic tests) LINQ to SQL.  BUT!  The release of Entity Framework 4.1 together with Code First outweighed all the disadvantages: prototyping a layer of application data was one pleasure.  If for the first you need to work in a designer, deal with DBML files, then here we are only working with POCO.  For example, the data model for the store: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Product</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ProductId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CategoryId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Category Category { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime CreationDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Description { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Category</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CategoryId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;Product&gt; Products { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductsContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Category&gt; Categories { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  <strong><a href="http://nuget.org/packages/MvcScaffolding">MvcScaffolding</a></strong> - need to quickly jot down a CRUD panel?  Already have a model EF, or LINQ to SQL?  Then enter this command in the NuGet window and rejoice in code generation: <br> <code>Scaffold Controller [ ] ‚ÄìRepository</code> <br>  The ‚ÄìRepository flag allows you to create a repository for working with the data layer at the same time. <br>  For example, use the above model. <br>  After entering <br> <code>Scaffold Controller Product ‚ÄìRepository</code> <br>  the following CRUD pages and abstract repository will be generated: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IProductRepository</span></span> { IQueryable&lt;Product&gt; All { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">IQueryable&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllIncluding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Expression&lt;Func&lt;Product, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt;[] includeProperties</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  And also its implementation: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductRepository</span></span> : <span class="hljs-title"><span class="hljs-title">IProductRepository</span></span> { ProductsContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductsContext(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;Product&gt; All { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Products; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IQueryable&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllIncluding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Expression&lt;Func&lt;Product, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt;[] includeProperties</span></span></span><span class="hljs-function">)</span></span> { IQueryable&lt;Product&gt; query = context.Products; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> includeProperty <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> includeProperties) { query = query.Include(includeProperty); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Find</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Products.Find(id); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.ProductId == <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// New entity context.Products.Add(product); } else { // Existing entity context.Entry(product).State = EntityState.Modified; } } public void Delete(int id) { var product = context.Products.Find(id); context.Products.Remove(product); } public void Save() { context.SaveChanges(); } }</span></span></code> </pre><br><br>  For more detailed information I advise you to read a <a href="http://blog.stevensanderson.com/2011/01/13/scaffold-your-aspnet-mvc-3-project-with-the-mvcscaffolding-package/">series of articles</a> from the creators themselves. <br><br>  <strong><a href="http://nuget.org/packages/Ninject">Ninject</a></strong> - I personally do not have the opportunity to work without abstractions.  ASP.NET MVC has many features to control / expand the functionality of its factories.  Therefore, setting the functional on specific class implementations is a bad form.  Why Ninject?  The answer is simple - it is lightweight, has many extensions, is actively developing. <br>  Install it, as well as the <a href="">MVC3</a> addition to it: <br>  After this, the folder App_Start will appear, where the file NinjectMVC3.cs will be located. <br>  To implement DI, create a module: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RepoModule</span></span> : <span class="hljs-title"><span class="hljs-title">NinjectModule</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Bind&lt;ICategoryRepository&gt;().To&lt;CategoryRepository&gt;(); Bind&lt;IProductRepository&gt;().To&lt;ProductRepository&gt;(); } }</code> </pre><br><br>  In the NinjectMVC3.cs file in the CreateKernel method, we write: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> INinjectModule[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepoModule() }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> kernel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardKernel(modules); RegisterServices(kernel); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> kernel;</code> </pre><br><br>  Now we will write our controller: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductsController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProductRepository productRepository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; } }</code> </pre><br>  <strong><a href="http://nuget.org/packages/NLog">NLog</a></strong> - how to find out how an application works, success / failure when performing operations?  The simplest solution is to use logging.  It makes no sense to write your bikes.  From all, I think, it is possible to select NLog and log4net.  The latter is a direct port with Java (log4j).  But its development is not very active, if not abandoned at all.  NLog, on the contrary, is actively developing, has a rich functionality and a simple API. <br>  How to quickly add a logger: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LogManager.GetCurrentClassLogger(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoStuff</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//very important stuff log.Info("Everything is OK!"); return View(); } }</span></span></code> </pre><br>  <strong><a href="http://nuget.org/packages/PagedList">PagedList</a></strong> - need a page <strong><a href="http://nuget.org/packages/PagedList">turning</a></strong> algorithm?  Yes, you can sit and think for yourself.  But why?  <a href="http://habrahabr.ru/company/microsoft/blog/133845/">This</a> article has a detailed description of working with him. <br><br>  <strong><a href="">Lucene.NET</a></strong> - Are you still <s>erasing</s> using the search for the database itself?  Forget it!  A couple of minutes and you will have an ultra-fast search. <br>  Install it, as well as the addition to it, <a href="http://nuget.org/packages/SimpleLucene">SimpleLucene</a> : <br>  First of all, we automate the work with the creation of the index: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductIndexDefinition</span></span> : <span class="hljs-title"><span class="hljs-title">IIndexDefinition</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Product</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Document </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Convert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product entity</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Document(); document.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Field(<span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>, entity.ProductId.ToString(), Field.Store.YES, Field.Index.NOT_ANALYZED)); document.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Field(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>, entity.Name, Field.Store.YES, Field.Index.ANALYZED)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(entity.Description)) { document.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Field(<span class="hljs-string"><span class="hljs-string">"Description"</span></span>, entity.Description, Field.Store.YES, Field.Index.ANALYZED)); } document.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Field(<span class="hljs-string"><span class="hljs-string">"CreationDate"</span></span>, DateTools.DateToString(entity.CreationDate, DateTools.Resolution.DAY), Field.Store.YES, Field.Index.NOT_ANALYZED)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity.Price != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> priceField = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NumericField(<span class="hljs-string"><span class="hljs-string">"Price"</span></span>, Field.Store.YES, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); priceField.SetIntValue(entity.Price); document.Add(priceField); } document.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Field(<span class="hljs-string"><span class="hljs-string">"CategoryId"</span></span>, entity.CategoryId.ToString(), Field.Store.YES, Field.Index.NOT_ANALYZED)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> document; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Term </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIndex</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product entity</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Term(<span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>, entity.ProductId.ToString()); } }</code> </pre><br><br>  As seen in the Convert method, we serialize the POCO into a Lucene Document. <br>  Controller code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { product.CreationDate = DateTime.Now; productRepository.InsertOrUpdate(product); productRepository.Save(); <span class="hljs-comment"><span class="hljs-comment">// index location var indexLocation = new FileSystemIndexLocation(new DirectoryInfo(Server.MapPath("~/Index"))); var definition = new ProductIndexDefinition(); var task = new EntityUpdateTask&lt;Product&gt;(product, definition, indexLocation); task.IndexOptions.RecreateIndex = false; task.IndexOptions.OptimizeIndex = true; //IndexQueue.Instance.Queue(task); var indexWriter = new DirectoryIndexWriter(new DirectoryInfo(Server.MapPath("~/Index")), false); using (var indexService = new IndexService(indexWriter)) { task.Execute(indexService); } return RedirectToAction("Index"); } else { ViewBag.PossibleCategories = categoryRepository.All; return View(); } }</span></span></code> </pre><br><br>  To display the results, create a ResultDefinition: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductResultDefinition</span></span> : <span class="hljs-title"><span class="hljs-title">IResultDefinition</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Product</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Convert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document document</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(); product.ProductId = document.GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>); product.Name = document.GetValue(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>); product.Price = document.GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"Price"</span></span>); product.CategoryId = document.GetValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"CategoryId"</span></span>); product.CreationDate = DateTools.StringToDate(document.GetValue(<span class="hljs-string"><span class="hljs-string">"CreationDate"</span></span>)); product.Description = document.GetValue(<span class="hljs-string"><span class="hljs-string">"Description"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> product; } }</code> </pre><br><br>  This is where POCO deserializes. <br>  And finally, we automate the work with queries: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductQuery</span></span> : <span class="hljs-title"><span class="hljs-title">QueryBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Query query</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">query</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductQuery </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WithKeywords</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> keywords</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(keywords)) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] fields = { <span class="hljs-string"><span class="hljs-string">"Name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MultiFieldQueryParser(Lucene.Net.Util.Version.LUCENE_29, fields, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29)); Query multiQuery = parser.Parse(keywords); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.AddQuery(multiQuery); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre><br><br>  We now turn to the controller: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Search</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> searchText, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">? orderByDate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> IndexPath = Server.MapPath(<span class="hljs-string"><span class="hljs-string">"~/Index"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> indexSearcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryIndexSearcher(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(IndexPath), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> searchService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchService(indexSearcher)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductQuery().WithKeywords(searchText); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = searchService.SearchIndex&lt;Product&gt;(query.Query, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductResultDefinition()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orderByDate.HasValue) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(result.Results.OrderBy(x =&gt; x.CreationDate).ToList()) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(result.Results.ToList()); } }</code> </pre><br><br>  <strong><a href="">Reactive Extensions for JS</a></strong> - should be the foundation of the client.  No, honestly, a smoother creation of an application framework on a client with the possibility of unit testing should still be looked <a href="">for</a> .  I advise you to read <a href="http://habrahabr.ru/post/132463/">my post</a> on the development of Rx. <br><br><h3>  Authentication and Authorization </h3><br>  Immediately I warn you - never use the standard AspNetMembershipProvider!  If you look at his monstrous stored procedures out of the box, then you just want to throw it out. <br>  In the folder C: \ Windows \ Microsoft .NET \ Framework \ v4.0.30319 \ open the InstallMembership.sql and InstallProfile.SQL files. <br>  For example, the SQL code for FindUsersByName from InstallMembership.sql looks like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.aspnet_Membership_FindUsersByName @ApplicationName <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), @UserNameToMatch <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), @PageIndex <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @PageSize <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ApplicationId uniqueidentifier <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @ApplicationId = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @ApplicationId = ApplicationId <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.aspnet_Applications <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(@ApplicationName) = LoweredApplicationName <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@ApplicationId <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- Set the page bounds DECLARE @PageLowerBound int DECLARE @PageUpperBound int DECLARE @TotalRecords int SET @PageLowerBound = @PageSize * @PageIndex SET @PageUpperBound = @PageSize - 1 + @PageLowerBound -- Create a temp table TO store the select results CREATE TABLE #PageIndexForUsers ( IndexId int IDENTITY (0, 1) NOT NULL, UserId uniqueidentifier ) -- Insert into our temp table INSERT INTO #PageIndexForUsers (UserId) SELECT u.UserId FROM dbo.aspnet_Users u, dbo.aspnet_Membership m WHERE u.ApplicationId = @ApplicationId AND m.UserId = u.UserId AND u.LoweredUserName LIKE LOWER(@UserNameToMatch) ORDER BY u.UserName SELECT u.UserName, m.Email, m.PasswordQuestion, m.Comment, m.IsApproved, m.CreateDate, m.LastLoginDate, u.LastActivityDate, m.LastPasswordChangedDate, u.UserId, m.IsLockedOut, m.LastLockoutDate FROM dbo.aspnet_Membership m, dbo.aspnet_Users u, #PageIndexForUsers p WHERE u.UserId = p.UserId AND u.UserId = m.UserId AND p.IndexId &gt;= @PageLowerBound AND p.IndexId &lt;= @PageUpperBound ORDER BY u.UserName SELECT @TotalRecords = COUNT(*) FROM #PageIndexForUsers RETURN @TotalRecords END</span></span></code> </pre><br><br>  And here is the Profile_GetProfiles from InstallProfile.SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.aspnet_Profile_GetProfiles @ApplicationName <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), @ProfileAuthOptions <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @PageIndex <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @PageSize <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @UserNameToMatch <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @InactiveSinceDate datetime = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ApplicationId uniqueidentifier <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @ApplicationId = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @ApplicationId = ApplicationId <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> aspnet_Applications <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(@ApplicationName) = LoweredApplicationName <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@ApplicationId <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-comment"><span class="hljs-comment">-- Set the page bounds DECLARE @PageLowerBound int DECLARE @PageUpperBound int DECLARE @TotalRecords int SET @PageLowerBound = @PageSize * @PageIndex SET @PageUpperBound = @PageSize - 1 + @PageLowerBound -- Create a temp table TO store the select results CREATE TABLE #PageIndexForUsers ( IndexId int IDENTITY (0, 1) NOT NULL, UserId uniqueidentifier ) -- Insert into our temp table INSERT INTO #PageIndexForUsers (UserId) SELECT u.UserId FROM dbo.aspnet_Users u, dbo.aspnet_Profile p WHERE ApplicationId = @ApplicationId AND u.UserId = p.UserId AND (@InactiveSinceDate IS NULL OR LastActivityDate &lt;= @InactiveSinceDate) AND ( (@ProfileAuthOptions = 2) OR (@ProfileAuthOptions = 0 AND IsAnonymous = 1) OR (@ProfileAuthOptions = 1 AND IsAnonymous = 0) ) AND (@UserNameToMatch IS NULL OR LoweredUserName LIKE LOWER(@UserNameToMatch)) ORDER BY UserName SELECT u.UserName, u.IsAnonymous, u.LastActivityDate, p.LastUpdatedDate, DATALENGTH(p.PropertyNames) + DATALENGTH(p.PropertyValuesString) + DATALENGTH(p.PropertyValuesBinary) FROM dbo.aspnet_Users u, dbo.aspnet_Profile p, #PageIndexForUsers i WHERE u.UserId = p.UserId AND p.UserId = i.UserId AND i.IndexId &gt;= @PageLowerBound AND i.IndexId &lt;= @PageUpperBound SELECT COUNT(*) FROM #PageIndexForUsers DROP TABLE #PageIndexForUsers END</span></span></code> </pre><br><br>  As you can see, temporary tables are constantly being created, which simply negates any iron.  Imagine if there are 100 such calls per second. <br>  Therefore, always create your own providers. <br><br><h3>  ASP.NET MVC4 Web API </h3><br>  ASP.NET MVC is a great framework for building RESTful applications.  To provide an API, we could, for example, write such code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AjaxProductsController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AjaxProductsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProductRepository productRepository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Details</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(productRepository.Find(id)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> category</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> products = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> productRepository.All <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.CategoryId == category <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(products.ToList()); } }</code> </pre><br><br>  Yes, one of the outputs was to write a separate controller for servicing AJAX requests. <br>  Another is spaghetti code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductsController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProductRepository productRepository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> category</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> products = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> productRepository.All <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.CategoryId == category <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Request.IsAjaxRequest()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(products.ToList()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(products.ToList()); } }</code> </pre><br><br>  And if you also need to add CRUD operations, then: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpPost</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { productRepository.InsertOrUpdate(product); productRepository.Save(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); }</code> </pre><br>  As you can see the attributes, detecting AJAX in code is not the cleanest code.  We write API, right? <br>  Exit MVC4 marked the new Web API functionality.  At first glance, this is a mixture of MVC controllers and WCF Data Services. <br>  I will not provide a tutorial on the Web API, there are many of them on the <a href="http://www.asp.net/web-api/overview">ASP.NET MVC</a> site itself. <br>  I will give only an example of the above code rewritten. <br>  First, let's change the InsertOrUpdate method from the ProductRepository: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.ProductId == <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// New entity return context.Products.Add(product); } // Existing entity context.Entry(product).State = EntityState.Modified; return context.Entry(product).Entity; }</span></span></code> </pre><br><br>  And we will write the controller itself: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductsController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* *  */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllProducts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> category</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> products = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> productRepository.All <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.CategoryId == category <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> products.ToList(); } <span class="hljs-comment"><span class="hljs-comment">// Not the final implementation! public Product PostProduct(Product product) { var entity = productRepository.InsertOrUpdate(product); return entity; } }</span></span></code> </pre><br><br>  So, a couple of moments, what has changed and how it works: <br><ul><li>  Now controllers are inherited from ApiController </li><li>  No more ActionResult, etc.  - only clean code </li><li>  No more HttpPost etc.  attributes </li><li>  The name of the method should begin with Get for get requests, POST for post requests. </li><li>  Analogue of Index method in Web API - GetAll {0} - controller name </li></ul><br>  Just above, I indicated that the Web API is a mixture of MVC and WCF Data Services.  But where is it expressed?  It's simple - the new API supports OData!  And works on a similar principle. <br>  For example, to indicate sorting, it was necessary to specify a parameter in the method itself: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sortOrder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> category</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> products = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> productRepository.All <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.CategoryId == category <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (sortOrder.ToLower()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span>: products = products.OrderBy(x =&gt; x.Name); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"desc"</span></span>: products = products.OrderBy(x =&gt; x.Description); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(products.ToList()); }</code> </pre><br><br>  Now you just need to change the method GetAllProducts: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IQueryable&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllProducts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> category</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> products = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> productRepository.All <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.CategoryId == category <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> products; }</code> </pre><br><br>  And in the browser, for example, type the following: <br> <code>http://localhost/api/products?category=1&amp;$orderby=Name</code> <br> <br>  Thus, we got rid of distractions and can now concentrate on creating the API itself. <br><br>  Thanks for attention! <br></div><p>Source: <a href="https://habr.com/ru/post/143024/">https://habr.com/ru/post/143024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143019/index.html">Every MobileMe user has a Snow Leopard license.</a></li>
<li><a href="../143020/index.html">Evernote is preparing an application for business</a></li>
<li><a href="../143021/index.html">Steve Wozniak greatly praises Windows Phone 7.5 Mango</a></li>
<li><a href="../143022/index.html">Google chrome hacker is not an assistant</a></li>
<li><a href="../143023/index.html">Sony Xperia P with aluminum case goes on sale</a></li>
<li><a href="../143025/index.html">Cyclic slideshow on pure CSS3</a></li>
<li><a href="../143026/index.html">Imperative RegExp. Notation</a></li>
<li><a href="../143027/index.html">Nokia's indoor location</a></li>
<li><a href="../143029/index.html">As one man, I wanted to buy the MES system</a></li>
<li><a href="../143030/index.html">Unity lens for video search VKontakte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>