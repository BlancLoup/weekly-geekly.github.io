<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vulnerability VKontakte: send a message with the page recovery code to someone else's number</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On a typical spring day, doing ‚Äúpreparation‚Äù for the Unified State Exam on computer science, I came across an article about the vulnerability of Faceb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vulnerability VKontakte: send a message with the page recovery code to someone else's number</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/ce1/f8f/c02/ce1f8fc0222f4b3db640ccbb3838d858.png"><br><br>  On a typical spring day, doing ‚Äúpreparation‚Äù for the Unified State Exam on computer science, I came across an <a href="http://www.anandpraka.sh/2016/03/how-i-could-have-hacked-your-facebook.html">article about the vulnerability of Facebook</a> , which allowed hacking all accounts on a social network, for which they paid $ 15,000.  The essence of the vulnerability was to search for recovery codes on the company's test domain.  I thought, why is VKontakte worse?  And I decided to try to do a similar trick with them.  Knowing that the web version is already quite well researched, the victim should have become an Android client, and what came of it can be read under the cut. <a name="habracut"></a><br><br><h3>  Look traffic </h3><br>  First of all, I wanted to find out what information the application transmits to the network during the page recovery process.  Fiddler acted as an assistant in this matter, I configured it and the Android device as written in the <a href="http://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/ConfigureForAndroid">official documentation</a> .  Thus, all HTTP / HTTPS requests from the device become available in Fiddler.  Now, in the app, feel free to exit from your VKontakte account and click on the ‚ÄúForgot your password?‚Äù Button.  After entering the phone number, the application sends 2 HTTPS requests.  Of particular value is the second, because it is he who is responsible for sending SMS with a recovery code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/70c/8c4/886/70c8c488624049e296401558a18657bc.png"><br><br>  Special attention should be paid to some query parameters: <br><blockquote>  phone - the number to which the SMS is sent <br>  session_id - randomly generated session of the restore operation </blockquote>  Attempting to send a request by changing it did not succeed.  The ‚Äúsignature‚Äù parameter, which acts as a ‚Äúsignature‚Äù, interferes, as it is generated we will understand a little later. <br><br>  For the subsequent analysis, in the application, we will enter a random recovery code and continue to monitor network activity.  We see the following request, it checks the correctness of the entered code.  Since the code was random, the check failed. <br><br><img src="https://habrastorage.org/web/164/304/0cc/1643040cc91a4b979abbb69ce4fae1a7.png"><br><br>  Honestly at this point, I wanted to start sorting through recovery codes, changing the value of the ‚Äúcode‚Äù parameter.  Unfortunately, this request is also protected from being modified using "signature".  We'll have to figure out how this signature is generated. <br><br><h3>  Reverse engineering: decompilation </h3><br>  For the initial analysis, you can try to decompile the VKontakte application.  So you can get some parts of the source code in Java. <br><br><div class="spoiler">  <b class="spoiler_title">How to do it</b> <div class="spoiler_text">  1. Download and unzip <a href="https://github.com/pxb1988/dex2jar/releases">dex2jar</a> and <a href="https://github.com/java-decompiler/jd-gui/releases">jd-gui</a> <br>  2. Open apk applications as a regular archive and drag and drop .dex files to d2j-dex2jar.bat <br></div></div><br>  We open in jd-gui all received .jar files.  And without hesitation, we do a search for the string "signature". <br><br><img src="https://habrastorage.org/web/120/cf7/ab1/120cf7ab1f144403a58dd53d9b0c0bdb.png"><br><br>  The libverify library under the authorship of Mail.Ru clearly falls out of the general list of those found.  We look and we are not mistaken, the generated string is very similar to the url from previous requests. <br><br><pre><code class="java hljs">localObject3 = String.format(Locale.US, <span class="hljs-string"><span class="hljs-string">"%s%s?%s&amp;signature=%s"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[] { d(), e(), localObject3, URLEncoder.encode(ru.mail.libverify.utils.mb(f() + (String)localObject4 + ru.mail.libverify.utils.mc(ab())), <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) });</code> </pre> <br>  This library is made in the best traditions of security through obscurity, all code is securely obfuscated.  Therefore, through jd-gui, I managed to find out only that the ‚Äúsignature‚Äù hides the MD5-hash from the unknown line. <br><br><img src="https://habrastorage.org/web/09a/1b0/65a/09a1b065a5454bd494b19b8236fcab48.png"><br><br><h3>  Reverse Engineering: Disassembling </h3><br>  I needed to find out what line goes to ru.mail.libverify.utils.mb ().  The easiest way to do this is to change the application code slightly.  Well, let's try.  First we use <a href="https://ibotpeaches.github.io/Apktool/">apktool</a> , with the command: <br><br><pre> <code class="bash hljs">apktool.jar d vk.apk -r ( -r   )</code> </pre> <br>  Now, in the folders with the smali-code, we find the file in which the MD5 is generated.  In my case, the path was as follows: smali_classes3 \ ru \ mail \ libverify \ utils \ m.smali.  Go to the desired method: <br><br><pre> <code class="hljs rust">... .method public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> b(Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;)Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>; .locals <span class="hljs-number"><span class="hljs-number">8</span></span> .param p0 # Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>; .annotation build Landroid/support/annotation/NonNull; .end annotation .end param :try_start_0 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-string/jumbo v0, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span> invoke-<span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> {p0, v0}, Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;-&gt;getBytes(Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;)[B :try_end_0 .catch Ljava/io/UnsupportedEncodingException; {:try_start_0 .. :try_end_0} :catch_2 <span class="hljs-keyword"><span class="hljs-keyword">move</span></span>-result-object v0 :try_start_1 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-string/jumbo v1, <span class="hljs-string"><span class="hljs-string">"MD5"</span></span> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {v1}, Ljava/security/MessageDigest;-&gt;getInstance(Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;)Ljava/security/MessageDigest; <span class="hljs-keyword"><span class="hljs-keyword">move</span></span>-result-object v1 invoke-<span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> {v1}, Ljava/security/MessageDigest;-&gt;reset()V invoke-<span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> {v1, v0}, Ljava/security/MessageDigest;-&gt;update([B)V invoke-<span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> {v1}, Ljava/security/MessageDigest;-&gt;digest()[B <span class="hljs-keyword"><span class="hljs-keyword">move</span></span>-result-object v0 ...</code> </pre> <br>  The string you wanted to know was passed to the function in the first register parameter (p0).  Therefore, to get it, you should output the parameter somewhere, for example, in Logcat.  Add a few lines to the code: <br><br><pre> <code class="hljs vbscript">... .method <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static b(Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;)Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>; .locals <span class="hljs-number"><span class="hljs-number">8</span></span> .param p0 # Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>; .annotation build Landroid/support/annotation/NonNull; .<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> annotation .<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> param # PATCH # <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> v0 = <span class="hljs-string"><span class="hljs-string">"vk-research"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>/jumbo v0, <span class="hljs-string"><span class="hljs-string">"vk-research"</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>.d(v0, p0),  p0   invoke-static {v0, p0}, Landroid/util/<span class="hljs-built_in"><span class="hljs-built_in">Log</span></span>;-&gt;d(Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;Ljava/lang/<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>;)I :try_start_0 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>/jumbo v0, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span> ...</code> </pre> <br>  After saving the changes, build the application using apktool: <br><br><pre> <code class="bash hljs">apktool.jar b vk -o newvk.apk</code> </pre> <br>  Now you need to sign apk, I used <a href="https://shatter-box.com/knowledgebase/android-apk-signing-tool-apk-signer/">APK Signer</a> . <br><br>  After that, after removing the original application, you can install and run our modified client VKontakte.  To get the logcat from the device, we will use the <a href="https://developer.android.com/studio/command-line/adb.html">Android Debug Bridge</a> .  We connect the Android device via USB and execute the following commands in sequence: <br><br><pre> <code class="bash hljs">adb devices adb logcat</code> </pre> <br>  As soon as they joined the device and got the opportunity to watch the logs, click again on "Forgot your password?" And enter the phone number.  The following entry appears in the adb window: <br><br><img src="https://habrastorage.org/web/e23/705/eb7/e23705eb793a466492db75014d0277ab.png"><br><br>  It becomes clear that the hash string consists of successively glued: part of the url, query parameters and another hash string (506e786f377863526a7558536c644968).  And now, knowing the generation algorithm ‚Äúsignature‚Äù, we can start sending our ‚Äúsigned‚Äù requests. <br><br><h3>  Study </h3><br>  For research, I wrote a simple C # program that sent a request to send an SMS and tried to enter a code.  Using it, I entered random recovery codes.  But expectedly rested on the limit attempts: <br><br><img src="https://habrastorage.org/web/2ff/6e0/161/2ff6e0161bad417ca3229fc3dd66f442.png"><br><br>  I tried to resend SMS, in the hope that the limit would disappear after that.  To my regret, the message arrived, but I still could not enter the code: <br><br><img src="https://habrastorage.org/web/a25/570/ba9/a25570ba957d41b2b735129b00772e38.png"><br><br>  I decided to send requests with different session_id, sms came with other recovery codes, but I still rested against the limit, now not in ‚ÄúATTEMPTLIMIT‚Äù, but in ‚ÄúRATELIMIT‚Äù. <br><br><img src="https://habrastorage.org/web/d70/47b/01c/d7047b01c76e44eeb52b1d3771c0ec75.png"><br><br><div class="spoiler">  <b class="spoiler_title">About bruteforce</b> <div class="spoiler_text">  Watching incoming SMS, I noticed some common feature codes.  The recovery code consisted of 4 digits (at the time of writing, they increased yes to 6) and the same numbers were not next to each other.  That is only ~ 6500 possible codes.  I thought it was quite possible in 5 attempts to guess the code, for example, <a href="https://hackernoon.com/how-i-could-have-hacked-multiple-facebook-accounts-d9d335188d9b">they did it on Facebook</a> .  But then still postponed this venture. <br></div></div><br>  I tried to bypass the limits in all possible ways.  I changed the IP addresses, request parameters, phone numbers, but I could not make more than 5 attempts to enter the code. <br><br>  And here, almost by accident, I decided to send the recovery code to two different numbers, but using the same session_id.  To my surprise, there was no chapel when I saw the same SMS on both phones.  Here's how it worked: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/UYA5LvEfNak" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <s>Because of the proxy, additional verification is required.</s> <br><br>  Thus, the attack was obtained: <br><br><ol><li>  We send a request to send SMS to subscriber A with session_id C, he receives the code 1234 </li><li>  We send a request to send SMS to subscriber B with session_id C, he receives the code 1234 </li><li>  Now, if subscriber A knows the telephone number of subscriber B, he can restore his page.  It was possible to restore only that page, to the number of which the last SMS came with a similar session_id. </li></ol><br><h3>  Conclusion </h3><br>  Immediately after the discovery of the vulnerability, I wrote a report on HackerOne.  After 17 hours, the vulnerability was eliminated.  A few days later I was paid $ 2000.  This vulnerability allowed hacking most of the accounts in the social network, only accounts with two-factor authentication were safe (they cannot be restored by phone number).  <a href="https://hackerone.com/reports/219171">Report</a> <br><br>  PS Unified State Exam in computer science passed by 97 points.  Unfortunately, the remaining items are not so successful. <br><br>  <b>UPD:</b> The libverify library was also used in ICQ, hence the vulnerability existed there.  In the bug-bounty ICQ program, I was paid an extra $ 1000.  <a href="https://hackerone.com/reports/222252">Report</a> </div><p>Source: <a href="https://habr.com/ru/post/332684/">https://habr.com/ru/post/332684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332672/index.html">Google will soon cease to trust all certificates WoSign and StartCom</a></li>
<li><a href="../332674/index.html">Why I switched from React to Cycle.js</a></li>
<li><a href="../332676/index.html">3D mouse integration in Renga</a></li>
<li><a href="../332678/index.html">Understanding oracles in the blockchain</a></li>
<li><a href="../332682/index.html">Oracle Data Integrator. SubstitutionAPI: The order of the substitutions. Part 1</a></li>
<li><a href="../332686/index.html">Meet Apache BookKeeper - a replicable log service</a></li>
<li><a href="../332688/index.html">Lecture about two libraries of Yandex for working with big data</a></li>
<li><a href="../332690/index.html">Automation IP-network. Part 2 - Monitoring the speed of opening Web pages</a></li>
<li><a href="../332692/index.html">Binary image segmentation using the level set method</a></li>
<li><a href="../332694/index.html">Configuring BGP Looking glass based on OpenBSD 6.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>