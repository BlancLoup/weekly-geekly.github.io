<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cache static</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is an opinion that nginx is a great tool for returning statics. 
 There are articles that describe the sendfile or aio settings for "improving" ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cache static</h1><div class="post__text post__text-html js-mediator-article">  There is an opinion that nginx is a great tool for returning statics. <br>  There are articles that describe the sendfile or <a href="http://habrahabr.ru/post/68480/">aio</a> settings for "improving" performance. <br>  On Habr√© there is something to read about setting up proxy_store with proxy_cache to minimize problems with the brains of the site. <br>  Even in QA, sometimes there are questions about <a href="http://habrahabr.ru/qa/32141/">caching pictures</a> , for example. <br><blockquote>  Why engage in this nonsense!  - Experienced users say - OS knows you better how to cache files!  With a cache and a prefetch in modern OS, more precisely FS, there are no problems!  Why produce your caches and lists of popular materials and all that? ... </blockquote><br>  There is only one harmful <i>"but"</i> - in the nginx runtime environment (generally Linux), the concept of " <b>file</b> " and in general "file system" is <b>just a concept</b> . <br>  <i>And once, when I, having mounted the server via sshfs, updated one script, the magic happened:</i> <i><br></i>  <i>1. On each page there were 4 more pictures.</i> <i><br></i>  <i>2. Servers are dead.</i> <br>  What to do - the pictures were stored on glusterFS.  Come full fuse. <br><a name="habracut"></a><br>  GlusterFS, like the FUSE interface, greatly eats up performance, but <u>it's worth it</u> . <br>  <em>Initially we had one server.</em>  <em>Then two, the second of which mounted the www from the first to nfs.</em>  <em>Then three, four.</em> <em><br></em>  <em>Not very reliable, but <i>historically</i> so.</em>  <em>To save the situation, we needed some kind of completely transparent system, in-place replacement of nfs.</em>  <em>Cluster FS.</em> <em><br></em>  <em>Now there is a raid 10 on all servers, and after a year and a half of operation, it fell a couple of times.</em>  <em>Including absolutely.</em>  <em>Gluster silently picked up a copy of the FS on a new piece of iron and everything continued to work.</em>  <em>Glaster knows his job.</em> <br><h5>  But in fact, the story began a little wrong. </h5><br>  The reason was different, but the problem solving would be the same. <br>  There is nothing worse than the fact that " <i>historically</i> ." <br>  And in one of my projects, "historically," the situation when the image gives php. <br>  <em>At one time, it was necessary to make a file downloader with various ACLs, resizes, and watermarks.</em>  <em>That was almost 10 years ago.</em>  <em>The mechanism took root and has not changed since.</em> <br>  Now there are many specialized solutions for solving such problems ( <a href="http://habrahabr.ru/company/yandex/blog/200080/">elliptics</a> , <a href="http://habrahabr.ru/post/184652/">backpack,</a> and others; even better, CDN).  But I do not want to spend man-months on the transition.  I want to sleep, not work. <br>  Yes, and php chtuka, in principle, not bad.  But it has its limits. <br><h5>  But the problem of brake backends solved </h5><br>  Habr, once again prompted a solution - <u>proxy_store</u> and <u>proxy_cache</u> . <br>  But I can't use proxy_store - I have nowhere to save, and there are also problems with proxy_cache. <br>  There is one big such ‚Äúbut‚Äù - many years ago I was already confronted with the performance of uploading files and decided ‚Äúlet better nginx give the final files for me‚Äù. <br>  <b>X-Accel-Redirect.</b> <br>  Problem - nginx cannot cache a response from a proxy if this is not an answer, but a command.  <u>X-Accel-Redirect - not cached</u> . <br>  No exit? <br><br><h5>  The original problem was fixed </h5><br>  Now back to the top of the topic. <br>  <em>We need to give statics, this time without the intervention of "smart" backends.</em>  <em>Just static, but with glusterfs.</em> <em><br></em>  <em>There are simply no guidelines for caching statics.</em>  <em>It is believed that the OS itself is not a fool.</em>  <em>For static, there is only open_file_cache and setting up the file transfer itself (sendfile / aio and company).</em> <br>  What to do? <br>  Let's complicate the problem, and try to solve the problem exclusively with nginx, without making any changes to other codes. <br><br><h6>  normal config </h6><br><pre><code class="hljs pgsql"># Static files <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ { root /var/www/kashey; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Patched config </h6><br>  Nginx makes proxy_pass on itself, caching the result.  Perhaps here you can use fcgi, but so - more clearly. <br><pre> <code class="hljs kotlin"># Static files location location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> $dopass <span class="hljs-number"><span class="hljs-number">1</span></span>; proxy_set_header Host $host; #    <span class="hljs-string"><span class="hljs-string">""</span></span> -      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($http_fiberpass) { root /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/kashey; # proxy_pass   <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> $dopass <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; #  <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>   } # ,    proxy_cache_valid proxy_cache static_cache; #  <span class="hljs-string"><span class="hljs-string">""</span></span> proxy_set_header fiberpass <span class="hljs-string"><span class="hljs-string">"nginx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($dopass) { #    . proxy_pass http:<span class="hljs-comment"><span class="hljs-comment">//127.0.0.1:80; } }</span></span></code> </pre> <br>  And no magic. <br>  In the case of X-Accel-Redirect, the scheme is as follows: <br><blockquote>  1. nginx get request <br>  2. sends itself, unfortunately the request is complete and real. <br>  3. forwards to proxy <br>  4. receives the answer and gives the file <br>  5. The answer is cached. <br>  6. ??? <br>  7. PROFIT </blockquote><br>  In the case of regular statics, it is more difficult - root does not finish execution, break and return also do not work.  Proxy settings cannot be inside a conditional block. <br><h5>  What does this give? </h5><br>  In sense with X-Accel-Redirect with apache the shaft of requests is removed.  On a loaded system, the difference can be 50 times. <br>  But this is understandable - php itself, and through Apache, all the more, not the most reactive solution. <br>  The request latency is less than 40ms, I personally did not get it (total php + gluster time). <br>  In the case of using the variant with proxy_cache, the speed of return is equivalent to the rate of return of static. <br><br><h5>  And what about the statics? </h5><br>  Return with gluster - 13ms is the normal time for a system without a cache. <br><img src="https://habrastorage.org/getpro/habr/post_images/574/103/6f0/5741036f02e78eea51f87bdc5f5c2b78.png"><br><br>  Return from the cache - 1ms - this is wonderful. <br><img src="https://habrastorage.org/getpro/habr/post_images/1fd/ba7/2ed/1fdba72ed5fa3dfe02b0f8c9146d316f.png"><br><br>  It is important to note that the servers are located in Germany, and the customers in Russia. <br>  Normal pings to the site 60-100ms. <br>  So for the client, the acceleration is almost negligible. <br><br>  But it is noticeable for the server. <br>  1. The load on the servers has decreased, including in parrots Load average and soft-irq. <br>  2. The traffic between the servers has decreased (it can be solved by turning on WORM (Write Once Read Many Volume), but this is no longer ‚Äútransparent‚Äù). <br><img src="https://habrastorage.org/getpro/habr/post_images/b09/1fd/585/b091fd58577a79d50b2688ffce8b273a.png"><br>  3. Everything began to work a little faster. <br><br>  As a result, the work that reduced the reaction rate at the client by 10% resulted in a 10-fold acceleration of static recoil.  That reduced the total load on the server about 20 times. <br>  The reverse statement, unfortunately, will also be true - no matter how hard you try, the client may not notice. <br><br>  <em>PS: Many familiar system administrators did not even allow the thought of the possibility of such a scheme.</em>  <em>Does not allow to cache / proxy - it means it is impossible.</em> <br><br>  Good programmers are not always good system administrators, and system administrators are usually not programmers at all. <br>  These heroes always go around, ford, and on bicycles. <br><br>  <i>PPS: by the way, I am not a sysadmin.</i>  <i>And, perhaps, did everything wrong.</i> </div><p>Source: <a href="https://habr.com/ru/post/202290/">https://habr.com/ru/post/202290/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202278/index.html">Video surveillance in the countryside via 3G Internet</a></li>
<li><a href="../202280/index.html">Clustering web applications hosted by Amazon Web Services</a></li>
<li><a href="../202282/index.html">Generate P / Invoke signatures in C #. Misuse of Interface Definition Language and OLE Automation Type Libraries</a></li>
<li><a href="../202284/index.html">A brief overview of the console market</a></li>
<li><a href="../202288/index.html">Enyo 2. Introduction</a></li>
<li><a href="../202292/index.html">The first hackathon in Alpha Bank. From the scene</a></li>
<li><a href="../202300/index.html">ABBYY Lingvo.Pro: manage terminology in the clouds</a></li>
<li><a href="../202302/index.html">Development of cross-platform mobile applications in Delphi # 4</a></li>
<li><a href="../202304/index.html">Tiny Excel in pure javascript (30 lines of code)</a></li>
<li><a href="../202306/index.html">ScienceHub # 06: Computational Linguistics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>