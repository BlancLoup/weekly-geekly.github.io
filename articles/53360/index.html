<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Handling thousands of requests per second using the XBT Tracker example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently we conducted a test, the results of which showed that one application processes 2000 requests per second on a modest server, where it was not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Handling thousands of requests per second using the XBT Tracker example</h1><div class="post__text post__text-html js-mediator-article">  Recently we conducted a test, the results of which showed that one application processes 2000 requests per second on a modest server, where it was not the only load.  In this case, the result of each query is recorded in 3-5 tables in MySQL.  Honestly, I was surprised by this result, so I decided to share with the community about the description of the architecture of this application.  This approach is applicable from banner shows to chat rooms and microblogging, I hope someone will find it interesting. <br><br>  First, this application is single threaded.  Everything is done by a single process, working with sockets - non-blocking epoll / select, no threads waiting for I / O.  With the development of HTTP, first the appearance of Keep-Alive, then AJAX and the increasing popularity of COMET, the number of persistent connections to the web server grows, on loaded projects it is measured by thousands and even tens of thousands, and if everyone creates their own thread with their own stack and constantly switching between them - the server resources very quickly will not be enough. <br><br>  The second key point is that one SELECT ... WHERE pk in (k1, k2, ..., kN) is faster than several SELECT ... WHERE pk = ... While working with the database in large batches, you can reduce not only the number of queries per second, but and total load. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Subject area </h4><br>  <a href="http://xbtt.sourceforge.net/tracker/">XBT Tracker (XBTT)</a> - Bittorrent tracker.  Please refrain from the topic of copyright, for the torrent is officially used, for example, to distribute Linux distributions and patches to World of Warcraft.  Unlike ed2k and DC ++, it is possible to put several files into one torrent, without packing them into the archive, and at any time check the integrity of the file, and, if necessary, restore it by downloading broken pieces. <br><br>  When downloading, the client periodically calls the tracker, reporting traffic statistics and getting the addresses of other distributors and downloads.  The more often such calls, the more accurate the traffic accounting (if it is a closed tracker) and the sooner the new distribution participants learn about each other. <br><br>  XBT Tracker, about which this post, is written in C ++ and is used on many foreign trackers, both open and closed, and even on a couple of Russian ones.  Another high-performance tracker, <a href="http://erdgeist.org/arts/software/opentracker/">OpenTracker</a> , does not support closed trackers with regard to traffic, so it does not need to write the results of queries to the database, therefore in this context it is less interesting. <br><br><h4>  Non-blocking I / O </h4><br>  In the 90s, blocking I / O was used when working with sockets, when the current thread ‚Äúhung‚Äù when calling recv and send methods before waiting for results.  For each accepted connection, a separate process was created (fork) in which its request was processed.  But each process requires memory for the stack and processor time for context switching between processes.  On small loads, this is not terrible, and the web was not interactive at that time, it was not enough in the request-response mode, there was little dynamic context (CGI), mostly - counters of page visits and primitive non-forums.  Apache still works this way.  In apache2 it is possible to use lighter threads (threads) instead of processes, but the essence remains the same. <br><br>  As an alternative to this, non-blocking I / O appeared, when one process could open multiple sockets, periodically poll their state, and if there were any events, for example, a new connection arrived or data was received for reading, to serve them.  This is exactly how <a href="http://sysoev.ru/nginx/">nginx</a> works.  In Java version 1.4 and higher, there is NIO for this. <br><br>  Later, there were improvements, for example, TCP_DEFER_ACCEPT, which allows you to "postpone" the reception of the connection until the data came over it, SO_ACCEPTFILTER, postponing the connection until a full HTTP request arrived.  Now it is possible to increase the queue length of unaccepted connections (by default, there are only 128) using sysctl kern.ipc.somaxconn in BSD and sysctl net.core.somaxconn in Linux, which is especially important if there are pauses in processing sockets. <br><br><h4>  Service requests </h4><br>  Requests in XBTT are very simple, their processing does not require special computational resources, it keeps all the necessary data in memory, so there are no problems to execute them in the same process as working with sockets.  In the case of more serious tasks, it is still necessary to create separate threads for their maintenance. <br><br>  One of the outputs is the creation of a thread pool (thread pool) to which the request is sent for processing, after which the thread is returned to the pool.  If there are no free threads, the request waits in the queue.  This approach allows you to reduce the total number of threads used, and each time you don‚Äôt have to create a new one and kill it after the request has been processed. <br><br>  An even better mechanism called ‚Äúactors‚Äù (actors) is in Erlang (erlang) and Scala (scala) languages, perhaps - in the form of libraries - for other languages ‚Äã‚Äãas well.  Processing is performed by asynchronous message transfer between actors, which can be imagined as sending emails with an incoming mailbox for everyone, but this topic is beyond the scope of this post (for example, <a href="http://robey.lag.net/2009/03/02/actors-mina-and-naggati.html">here is a</a> fresh post about it). <br><br><h4>  Batch database operation </h4><br>  The result of each appeal to the XBTT tracker is recorded in several tables.  The user increases his downloaded and flooded traffic.  Increases statistics from the torrent.  The table of the current distribution participants is filled.  Plus a couple of utility tables with download history. <br><br>  With the traditional method of processing for each request to the tracker, at least 3 separate INSERT or UPDATE would be executed, the client would wait for their execution, thus the database server would have to execute 3 requests for each call to the tracker. <br><br>  XBTT does not execute them immediately, but accumulates a large bundle of INSERT ... VALUES (...), (...).  ..., (...) ON DUPLICATE KEY UPDATE f1 = VALUES (f1), ..., fN = VALUES (fN), and executes every few seconds.  Due to this, the number of requests to the database is reduced from several per tracker request to several per minute.  Also, he periodically re-reads the necessary data, which may have changed from the outside (the web interface is independent of the tracker). <br><br><h4>  Posting severity </h4><br>  In this application, the loss of data is not critical at all.  If no torrent traffic statistics are recorded in the database within a few seconds, nothing terrible will happen.  Although at abnormal termination, it writes the accumulated buffers to the database, the server may have a UPS in case of a power outage, etc.  - guarantees that all the data transmitted by the client is not recorded on the disk.  For a banner network, this is also not scary, but there are tasks where saving all data is critical. <br><br>  Similarly, not all applications have the ability to store all data in memory.  To process a client request, it may be necessary to retrieve data from the database. <br><br>  But in this case, block data processing is possible.  A pipeline is organized (pipeline; actors are perfectly suited for its implementation) from several stages, each group is assembled for the request as soon as a sufficient amount (of course, adjustable) has accumulated or some time has passed (for example, 10-100 milliseconds), during which the required number was not accumulated, - a group query is made to the database, where instead of ‚Äúkey = value‚Äù the condition ‚Äúkey IN (accumulated list)‚Äù is set. <br><br>  If you need to lock (lock) these records, then you can add FOR UPDATE SKIP LOCKED to the query (of course, you will need to record the results in the same connection to the database, the same transaction).  You can use the Prepared Statement in those databases that support it, to perform a query analysis (parse) once, select the optimal execution plan, and then only insert data into it every time.  To reduce the number of such requests prepared, the number of parameters to it can be taken only by powers of two: 1, 2, 4, 8, 16, 32 ... It is also possible to group (batch) requests without first performing each, but only adding to the packet, and then do it all at once. </div><p>Source: <a href="https://habr.com/ru/post/53360/">https://habr.com/ru/post/53360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../53352/index.html">Microsoft Office Labs vision 2019 (montage + video)</a></li>
<li><a href="../53354/index.html">Dual Authentication</a></li>
<li><a href="../53355/index.html">Future eyes of Microsoft</a></li>
<li><a href="../53358/index.html">W3Schools browser statistics in January 2009: FF> IE</a></li>
<li><a href="../53359/index.html">Bubble UGC slowly blown away</a></li>
<li><a href="../53361/index.html">Pirate Bay closed?</a></li>
<li><a href="../53364/index.html">Twitter: ‚ÄúWe don't have a business model ?! Haha (3 times) ... "</a></li>
<li><a href="../53367/index.html">Overview of the development of the Ruby on Rails framework over the past 14 months</a></li>
<li><a href="../53368/index.html">Microsoft is testing a new search</a></li>
<li><a href="../53371/index.html">WebMoney Keeper Mini has appeared in the WebMoney Transfer system.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>