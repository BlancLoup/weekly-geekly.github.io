<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino in a snack machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a continuation of the story about filling vending machines with simple and affordable electronics based on Arduino. And really - the poss...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino in a snack machine</h1><div class="post__text post__text-html js-mediator-article">  This post is a continuation of the story about filling vending machines with simple and affordable electronics based on Arduino.  And really - the possibilities of the platform are endless!  And so, the second machine is a snack machine selling chips / water / chocolates / etc. <br><br><a name="habracut"></a><br><br><img src="https://habrastorage.org/storage2/3e2/56d/390/3e256d3905c1c1616f59a4c616bec690.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main thing is to start!  The desire to buy a machine appeared after bringing to mind the first machine with coffee.  Many visitors wanted to chew something along with delicious coffee. <br><br>  In the open spaces of the network and thematic forums spent all his free time.  Based on the ads for the sale of used snack machines, I was already preparing to save a considerable amount (about 100 thousand rubles for a simple device). <br>  And here it is happiness - there was an advertisement for the sale of a machine with a simple filling (previously sold magazines and newspapers) for 20 thousand rubles!  Word for word, caused private traders to deliver around the city.  250 kilograms of iron were loaded in three. <br><br>  So.  The first month of owning the device - its filling is recognized thoroughly, it is included in the network and is being tested.  It turns out earlier it was quite a normal snack machine, only under the order his brains were turned over for the sale of 2 items per shelf (and 2 motors per item).  Just taking and connecting additional gearboxes - the situation has not changed - the brains were completely reflashed, and he could not sell more goods.  Having phoned a company that made an ‚Äúupgrade,‚Äù I learned the amount of putting in order - about 10 thousand rubles only for updating the controller software.  By the way, the Atmel Mega-168 chip was on the board, which is a bit like a good Arduino.  But alas, in order to solve it independently, and even more so to understand the work with the periphery, you would have to kill a lot more time. <br><br><h4>  Making brains machine yourself </h4><br>  After removing all the electronics from the machine, he dragged her home.  Having called and checked the work of the gearboxes, he began to draw a scheme for connecting the Arduino and the entire periphery. <br>  The first test assembly worked on the Arduino Nano (freeduino), and was quite able to turn on the motor of the issuance according to any algorithm. <br><br>  In parallel, the layout of the goods on the shelves was drawn.  I rummaged through the entire Internet in search of examples, searched for snack machines in the city shopping center (I took pictures of the location and quantity of goods on the shelves), and drew a diagram for my machine.  It turned out the standard 4 products on the first two shelves (wide packs of chips / crackers).  One shelf for 8 products (candy bars, cookies).  And a shelf for water bottles (7 products). <br><br><h4>  The first task is to learn how to turn on / off the engines for the issuance of goods </h4><br>  The engine, or rather the motor with the gearbox, is activated by the usual power supply of 12V.  On the shaft of the gearbox is a mikrik, which responds to a full turn.  A steel spring is also connected to the shaft, in the turns of which the product is folded.  With full circulation, the product moves to the edge and the very first "snickers" falls into the issuing box. <br><br>  With the layout of the goods, it was possible to understand how many motors will produce goods.  23 engine.  A scheme was implemented with three shift registers 74HC595 connected in series.  But in the first test, or rather when the machine was turned on, the registers danced as they wanted and as a result, all the engines spun randomly for a second.  Now, looking at the implementation scheme, I see that I missed the valve control pin - when, without this pin, the outputs did not react to the transmitted data.  But that was it ... I just had to take the Arduino Mega, plus bipolar transistors to control the motors.  It turns out that there are 23 Arduino outputs for the issuance of goods.  On the one hand, this seems to be overkill, but on the other - a necessity.  Perhaps in the next version I will try the shift registers again. <br><br><img src="https://habrastorage.org/storage2/11f/bdc/9f8/11fbdc9f8f94c269c3de3ec741937679.jpg"><br><br>  In the photo from top to bottom: Arduino Mega in a plastic case, a prototype board with transistors and connectors for connecting, a prototype board with connectors for a keyboard, product selection and a display. <br><br><h4>  The second task is to connect the keyboard </h4><br><br><img src="https://habrastorage.org/storage2/b22/4d3/ce9/b224d3ce9a0f4616209dd53e78377fcd.jpg"><br><br>  At first this task seemed to me the most difficult.  But having disassembled the keyboard, I saw that there is no controller there and the usual matrix scheme is used - columns and lines.  I entered it in a simple way - different power is supplied to 6 lines (from 5V to 0.5, through resistors).  And with 3 speakers, the voltage is read through the analog inputs.  Total, having involved only 3 entrances, we can read buttons of the keyboard 6x3. <br><br><h4>  The third task is to connect the display. </h4><br><br><img src="https://habrastorage.org/storage2/ade/081/2d1/ade0812d1892601481b9867a1ba32729.jpg"><br><br>  The board has four 8-segment LED displays, a LED driver that works just like a shift register.  Using the example of working with a regular register and datasheet driver, I successfully wrote a function that clocked the driver, gave out bits in order.  Plus two additional LEDs, which are also included through the same register. <br><br>  What was my surprise when this display has earned!  This is not just copying the finished function and launching it on the controller - it is something else.  And the LED display in reality looks cooler than the LCD display.  During the tests I ran a second counter on it at night, I just ran a running point.  Moreover, the symbols are not generated by the shift register, but by their program ‚Äî the register simply transfers the bits that need to be lit.  An array of all numbers, some letters (for the word Err), plus a cash deposit symbol (equal sign) was added to the program. <br><br><h4>  The fourth task is receiving cash </h4><br><br><img src="https://habrastorage.org/storage2/13d/30b/82d/13d30b82da391068121e8b085771ef16.jpg"><br><br>  This photo shows: a bill acceptor, a payment module, a coin acceptor with tubes for coins, a cash drawer and a bunch of wires - this is a geek machine, as it should be :) <br><br>  The machine already had a bill acceptor and coin acceptor with the function of issuing change.  They work on the MDB protocol, which is quite difficult to implement, although the protocol is also in 1993.  In fact, this is a normal Serial-protocol, but with some qualification - 8 data bits + parity bit, which indicates the direction of transmission, and not parity.  In the SoftwareSerial library in Arduino, you could do the logic for yourself, but another factor surfaced - the delay between the command and the response should not exceed 5ms, otherwise it is regarded as timeout.  It was necessary to communicate with payments in real time, and most likely to use for this interruption. <br>  Nights on the passage with the debugger com-ports to nothing lead. <br>  But the solution was found - a third-party C-MDB module from our compatriots from Ukraine.  The module is simply excellent - it works with payments under this protocol and in the usual com-port gives the necessary data (from the characteristics of the payments, to the type of the received coin / bill and the status of the boxes with money). <br><br><h4>  The last task is to put it all together. </h4><br>  After analyzing everything, it was decided to add a regular system unit to this automaton based on Linux CentOS.  Fortunately, there is a lot of space inside the machine under the shelves, both for storing goods and for the system unit.  What functions are assigned to this computer: <br><br><ul><li>  Web interface logs, goods, money and purchases; </li><li>  communication with the payment module (PHP daemon); </li><li>  Internet access (on the installation site there is a wired Internet with a dedicated IP, port forwarding - the web interface and ssh are available even from a mobile phone); </li><li>  webcam gut vending machine; </li><li>  audio accompaniment and tips (for now how exactly). </li></ul><br><br><h4>  How is all this connected </h4><br>  Arduino via USB via a standard output connected to the system unit.  In normal mode, a com-port appears, in which Arduino writes logs and receives responses from the daemon (price request). <br><br>  The C-MDB module via the standard com-port of the system manager sends information about the money to the daemon, which already transfers only the information about the deposited money to the Arduino. <br><br>  The engines, keyboard, and display are connected to the Arduino and are controlled only by it.  By the way, now a kind of master-device is exactly Arduino.  She decides on the issuance of goods, requests a price from the computer, controls the display on the display and turns the engines.  In the next version, I want to transfer all the logic to the system unit (to the daemon), while the Arduino leaves only executive functions, because sometimes I had to go with a laptop to fix the buggy of the machine.  And for SSH to fix the demon in PHP is much easier. <br><br>  And the web interface is just fire!  Real-time sales are shown, the balance of money in boxes, information on the balance of goods after purchase, logs of operations and messages.  I wanted to see a webcam in the same place, but it won't start with me.  Suddenly, who can help with the solution: ID 0c45: 608f Microdia PC Camera (SN9C103 + OV7630), when trying to take a picture (cat / dev / video) - kernel: usb 3-2: Initialization failed again.  I will retry on next open () <br><br>  The daemon is written in pure PHP, which monitors the com-port of the payment module and communicates with it, recording all the information in the log.  And the USB-COM port listens to the Arduino - it writes logs and responds to the price request.  Along the way, he keeps a record of goods sold in MySQL, and after a successful sale, he also sends an E-mail to a personal box (it's nice to see dozens of sales per day). <br><br>  The output of the audio card included speakers.  I wanted to record sound zamanuhi and pristavalki to people (quiet and communicating place in the organization).  Plus connected the motion sensor to the Arduino, which responds to the passage of a person nearby.  I thought about turning on the set-top box on the motion sensor, but I haven‚Äôt written down the phrases yet.  Although the effect seems amazing! <br><br><h4>  One year of operation of the machine - the results </h4><br>  What I want to say - Arduino is not only a simpler and cheaper way to make brains with an iron box, but also a great opportunity to do it yourself!  Yes, there were childish mistakes when inattention did not allow the machine to start (for example, the power went down and the engine did not have enough strength to tighten the Coca-Cola), but in order to be given the opportunity to pass all these tests. <br><br>  Having opened the web interface now, I can say that during this time there were 1355 sales.  Yes, I confess - and I myself often buy Coca-Cola from myself - even if it is more expensive, but it is more pleasant :) In terms of amounts - the machine has fully paid for itself and all the time invested.  And brings only profit and joy! <br><br><h5>  And now about the plans! </h5><br>  After 2 days, the installation will come for the sale of carbonated drinks (exactly the same as in bars, only without taps).  Installing it on top of the coffee machine, connecting the controls to the brains of this machine - you get two paired machines with a single payment system, a single management and unlimited possibilities!  And also the very ideas when the price of coffee can be reduced on a schedule (for example, from 09 to 11 am), issue bar codes (collect 5 bar codes and get any coffee for free), a convenient way to pour coffee with "your own" (for example on ibutton tablets or smart cards), payment by SMS and much more! <br><br>  And finally, I would like to say that automatic machines are cool!  Cool not only from the developer, but also the user - convenient and fast!  Let him can deceive, but he will not do it on purpose (the light blinked and that's it, your credit disappeared on the screen).  The automatic machine is a round-the-clock sales and complete trust in him of his money and goods.  He will not steal, will not shortcut his owner, will send E-mail about the successful sale or error day and night, and can treat him with a free drink. <br><br>  In the comments I would be glad to hear what other functions you can add to such machines. </div><p>Source: <a href="https://habr.com/ru/post/143756/">https://habr.com/ru/post/143756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143747/index.html">Cacti Weathermap: network visualization + interactive</a></li>
<li><a href="../143748/index.html">New chkdsk utility in Windows 8</a></li>
<li><a href="../143753/index.html">VMware PowerCLI: We manage the clouds and everything from the command line:</a></li>
<li><a href="../143754/index.html">Comparative table of SaaS CRM-systems</a></li>
<li><a href="../143755/index.html">Which way of registering / entering the site is preferable for you?</a></li>
<li><a href="../143758/index.html">144 million dollars button</a></li>
<li><a href="../143759/index.html">Competition for display design of the news feed Habr</a></li>
<li><a href="../143760/index.html">All blogger.com blocked by Beeline by court order?</a></li>
<li><a href="../143761/index.html">Working with multiple databases in Ruby on Rails 3</a></li>
<li><a href="../143762/index.html">Details of the kitchen development Diablo II (from 2000)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>