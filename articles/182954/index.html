<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SMB Hijacking. Kerberos is not a hindrance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About SMBRelay (or to be exact NTLM-Relay) quite a lot has been written and said. Absolutely no desire 
 recall the details of this attack. I recall o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SMB Hijacking. Kerberos is not a hindrance</h1><div class="post__text post__text-html js-mediator-article">  About SMBRelay (or to be exact NTLM-Relay) quite a lot has been written and said.  Absolutely no desire <br>  recall the details of this attack.  I recall only that the essence of the attack comes down to manipulations with the user's authentication data, which can then be redirected to another resource. <br>  Such redirection allows you to authenticate and access the third resource, which usually translates into downloading a file and then launching it. <br><a name="habracut"></a><br><br>  The process of development of relaying has long been in place.  And rightly so, what would seem to be improved there, everything is clear and understandable. <br>  Just over a year ago, Intercepter had the opportunity to redirect NTLMv2.  After 3 months, a similar functionality appeared in Metasploit, and then separately taken enthusiasts began to cover up their work.  Here it is, the logical limit.  SMBRelay itself is almost never used, it is much more convenient in this regard to implement NTLM-Relay via other protocols, in particular HTTP.  In addition, the life of SMBRelay in domain networks is complicated by the ‚Äúinvincible‚Äù Kerberos, often called the SMBRelay cure.  With my research, I would like to destroy this myth and present a completely new approach to conducting an attack on the SMB protocol. <br>  It is worth noting that this will not be quite SMBRelay, let's call this technique SMB Hijacking. <br><br>  Let's start from afar ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the new version of the interceptor appeared NTLM-Response grabber, built-in WPAD MiTM. <br>  For ease of use, it was decided to make it possible to call John the Ripper with an intercepted hash in order to quickly check whether an empty or easy password is set.  After that, all the hashes that are intercepted by the sniffer and which can be bruteforced via JTR were brought into the appropriate format. <br><br>  In the archive of the Wireshark samples, a log was found with Kerberos authorization, from which Cain was able to pull out the hash and use a brute force to find the password. <br>  Bruteforce is possible due to the fact that, in an AS-REQ request, a timestamp encrypted with a user password, part of which is known in advance, is transmitted to the authentication server.  The Kerberos authentication handler was added and tested on a live domain controller (Windows 2008 R2).  Surprisingly, the hash is not intercepted.  The fact is that in Windows 2008, new encryption algorithms have been added, and instead of the previously used rc4-hmac, aes256-cts-hmac-sha1-96 is now used by default.  This hash is pulled out of the package in the same way as rc4-hmac, only another problem has appeared. <br>  At the moment there are no pereborchikov able to recover the password from the timestamp'a encrypted aes'om.  In john's mailing list, one comrade wrote a patch for JTR, but judging by the reviews, he is still damp and the most important process of iteration is hundreds of times slower than brute force rc4. <br><br>  Thus, the option of a downgrade encryption algorithm appeared in the interceptor, from aes to rc4.  Unfortunately, since Vista des, encryption has been disabled and rc4 is the minimum possible, so there was no sense in downgrading even lower. <br><br><img src="https://habrastorage.org/storage2/63d/4dc/574/63d4dc574475432b08dfc5181f0eba8b.jpg"><br>  Downgrade is a simple replacement of possible methods in the outgoing package of the victim. <br><br>  It was here that an interest in kerberos arose.  The study of the material showed that there is a theoretical possibility of replaying attacks of the Kerberos tickets, but no real examples and implementations were found. <br><br>  While thinking and analyzing the traffic, a completely strange question arose: why do we need to re (p) lay something at all ?!  Why not! <br><br>  What is an SMB session? <br><br>  1. Host_A connects to Host_B <br>  2. Session protocol is selected. <br>  3. Select the authorization method <br>  4. A set of commands ... <br><br>  WHY DO WE RELEASE THE AUTHORIZATION OF THE VICTIM IF SHE IS PERFECTLY AUTHORIZED AT THE RIGHT RESOURCE? <br><br>  We just need to get up in the middle and proxy the connection, wait for Host_A to log in to Host_B, and then take control of the session into our own hands! <br>  We are already logged in and can embed our code in the SMB session.  We are not at all interested in how the client is logged in, be it NTLM or Kerberos! <br>  The session itself is not encrypted in any way, and in 99% of cases SMB Signing on ordinary clients is not used. <br>  In addition to the greater features, this technique is much more elegant than SMBRelay, we are no longer required to implement our own tricky SMB authorization process. <br>  It is enough to implement the minimum set of commands that allow you to download the file and execute its launch. <br><br>  All this functionality appeared in the new version of Intercepter-NG and was tested under real conditions with the latest versions of Windows 2008 and Windows 7/8. <br><br>  What are the difficulties and features in the implementation of this attack. <br>  Starting with Vista, the new SMB2 protocol was used.  The main difference from the old version is a simplified set of commands and an increase in performance. <br>  For us it is important to follow two rules.  First, each SMB session has its own Session ID, and secondly, in the SMB2 header there is a Command Sequence Number field, <br>  those.  command sequence number.  To implement commands, you must specify a session identifier and increment the command counter. <br><br>  Since  in Intercepter the existing SMBRelay is based on someone else's code using the old SMB format, it was decided not to sculpt crutches and implement the basic SMB2 command set from scratch. <br><br>  The logic of implementation in the session is as follows: <br><br>  1. Stand in the middle between the attacked and the third host <br>  2. Wait for the SessionSetup Response command with a positive response. <br>  3. Get Session ID and current team number <br>  4. Copy file to admin ball (admin $) <br>  5. Create a service that will run our file. <br>  6. Start the service <br>  7. cmd.exe <br><br>  The fifth and sixth points are possible only because Microsoft allows you to send RPC requests over SMB. <br><br><img src="https://habrastorage.org/storage2/c8d/8a0/0ed/c8d8a00eda7555acb1311b8991a99d16.jpg"><br><br>  That's all.  Technique works great in the average domain.  Often there is some software that automatically performs some operations on client computers via SMB under an account that has administrative access.  Or directly the administrator can be the target of the attack. <br><br>  Kerberos is not an obstacle for us.  By the way, Kerberos in SMB is used only if the computer is accessed by name, and if you access the balloon via IP, only NTLM is used.  When attacking domain clients, an attacker does not necessarily have to be a member of the domain himself. <br>  You can also use SMB Hijacking in a regular workgroup, subject to the following requirements: availability of administrative access to the person being attacked and available administrative resources IPC $ \ ADMIN $. <br>  In addition to the passive interception of SMB sessions, Intercepter also injects a link to the SMB resource into the attacker's web traffic, which significantly speeds up the process of gaining access. <br><br>  In the case of a successful file download or in the absence of access, the connection must be terminated  the session for the attacker is already broken (command counter was hit).  In order not to loop the interception process. <br>  and still allowing access to the requested resource, Intercepter marks the victim and no longer interferes with the stream until the attack is restarted.  This removes any suspicion and eliminates disruption. <br><br>  Demo video on the SMB Hijacking below. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/flgsD6zdAU0%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700190,15700253&amp;usg=ALkJrhhs5PJ1-T01lHEnw7d-JWw8x7HhjQ" frameborder="0" allowfullscreen=""></iframe><br><br>  In addition to Kerberos Downgrade and SMB Hijacking, the following changes occurred in the new version of Intercepter. <br><br>  Integrated proxy server WPAD MiTM'a integrated NTLM-Response grabber.  The resulting hashes can be searched. <br>  Now, for a number of intercepted hashes, launching a brute force is available directly from the program, for this you need to first download the JTR (with the jumbo patch) and put it in the folder with Intercepter. <br>  A new method of OS fingerprinting has been added to Smart Scan, which gives a more accurate result. <br>  Appeared SYN port scanner, whitelist poppy addresses for DHCP MiTM, support for IDN (national domain names) and many more improvements and fixes. <br><br>  SMB Hijacking is used by default, if you need to run the old SMBRelay, then you need to switch the corresponding checkbox in expert mode. <br><br>  Ask questions on the forum or by mail. <br><br>  The information is presented for informational purposes only.  The author is not responsible for any possible harm caused by the materials of this article. </div><p>Source: <a href="https://habr.com/ru/post/182954/">https://habr.com/ru/post/182954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182944/index.html">Browser game "Cyberset" - a socio-economic strategy</a></li>
<li><a href="../182946/index.html">Sony has finally shown a PlayStation 4</a></li>
<li><a href="../182948/index.html">Dell Alienware M18X laptop video review</a></li>
<li><a href="../182950/index.html">Computex 2013. Girls from the show</a></li>
<li><a href="../182952/index.html">On the sale of Waze and the disposal of content</a></li>
<li><a href="../182958/index.html">‚ÄúDid the texture kill the texture?‚Äù - thoughts about the role of textures, textures and materials in games</a></li>
<li><a href="../182964/index.html">5 rules for the layout of email-letters from Pechkin</a></li>
<li><a href="../182966/index.html">Facebook - from the server to the network of data centers for 8 years</a></li>
<li><a href="../182968/index.html">The third issue of the magazine TsODy.RF</a></li>
<li><a href="../182970/index.html">How to ensure proper intersection of dynamic library boundaries using custom smart pointer removal tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>