<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About Publish, Connect, RefCount and Share in RxSwift</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. I present to your attention the translation of the article Understanding Publish, Connect, RefCount and RxSwift . 

 The original article us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About Publish, Connect, RefCount and Share in RxSwift</h1><div class="post__text post__text-html js-mediator-article"> <i>Hi, Habr.</i>  <i>I present to your attention the translation of the article <a href="http://www.tailec.com/blog/understanding-publish-connect-refcount-share">Understanding Publish, Connect, RefCount and RxSwift</a> .</i> <i><br><br></i>  <i>The original article uses Swift second version and the corresponding version of RxSwift.</i>  <i>I had the courage to rewrite the pieces of code below under Swift 3.</i> <i><br></i>  <i>Just want to note that concepts such as Observable and Sequence, can be considered one and the same.</i>  <i>The same goes for Observer and Subscriber.</i> <i><br><br></i>  <i>I also recommend reading about <a href="https://habrahabr.ru/post/336970/">share (), share Replay (), shareReplayLatestWhileConnected () in RxSwift</a> .</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will try to explain such operators for working with Connectable Observable in RxSwift as <code>publish, connect, refCount</code> and <code>share</code> .  They are used together in various combinations.  It is very important to understand the difference between: <br><br><ul><li> <b><code>publish().connect()</code></b> </li> <li>  and <b><code>publish().refcount()</code></b> (or just <b><code>share()</code></b> ) </li></ul><br><h3>  Active and Passive Observables </h3><br>  Before getting to the point, I would like to say a few words about hot and cold Observables.  As for me, the concepts of hot and cold Observables are a bit blurred. <br><br>  Let's hot Observable we will call Active Sequence, and cold Passive Sequence. <br><br><ul><li>  Active Sequence will emit elements <b>continuously</b> , regardless of whether someone subscribes to it or not. </li><li>  Passive Sequence starts to emit items <b>on request.</b> </li></ul><br>  An example of the Passive Sequence is a request to the network, which begins only when we subscribe to the sequence.  Examples of Active Sequence are a web-socket connection, timer events, or text produced by <code>UITextField</code> . <br><br>  And it's all.  Think of active and passive sequences.  The concepts of hot / cold / warm / cool Observables are too messy and can be confusing. <br><a name="habracut"></a><br><h3>  Multiple subscriptions to one Observable </h3><br>  If you have ever subscribed twice (or more) to the same Observable, you might be surprised at the results. <br><br>  Take a look at the following piece of code: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">let</span></span> url = <span class="hljs-type"><span class="hljs-type">URL</span></span>(string: <span class="hljs-string"><span class="hljs-string">"https://habrahabr.ru/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> requestObservable = <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared .rx.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">URLRequest</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">)) requestObservable.subscribe(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onNext</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class">($0) }) requestObservable.subscribe(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onNext</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class">($0) })</span></span></code> </pre><br>  Looking at the console, we will see two HTTP responsions.  Observable executed the request twice, although this is contrary to our expectations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/545/c83/961/545c839613e947f5ae51ab135b4d4cb8.png"></div><br><br><h3>  <code>share()</code> as salvation </h3><br>  Obviously, this is not what we want from a regular HTTP request.  But we can change this behavior and execute just one request.  You just need to apply the <code>share()</code> operator to our Observable. <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">let</span></span> url = <span class="hljs-type"><span class="hljs-type">URL</span></span>(string: <span class="hljs-string"><span class="hljs-string">"https://habrahabr.ru/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> requestObservable = <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared .rx.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">URLRequest</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">)) .share() requestObservable.subscribe(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onNext</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class">($0) }) requestObservable.subscribe(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onNext</span></span></span><span class="hljs-class">: { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class">($0) })</span></span></code> </pre><br>  As expected, only one HTTP request was executed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ea2/f10/fe7/ea2f10fe73754acd9e358d0381b7c476.png"></div><br>  In essence, the operator <code>share()</code> is just a wrapper over <code>publish().refcount()</code> . <br>  Stop stop stop!  What <code>publish()</code> , what <code>refcount()</code> ? <br><br><h3>  <code>publish()</code> and his friend <code>connect()</code> </h3><br>  When the publish () operator is applied, the Observable is transformed into a Connectable Observable.  The <a href="http://reactivex.io/documentation/operators/connect.html">ReactiveX documentation</a> states: <br><blockquote>  Connectable Observable is similar to regular Observable, except for one thing.  It begins to produce elements not when it is subscribed, <b>but only when the <code>connect()</code> operator is called on it</b> . </blockquote><pre> <code class="hljs perl">let myObservable = Observable.just(<span class="hljs-number"><span class="hljs-number">1</span></span>).publish() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscribing"</span></span>) myObservable.subscribe(onNext: { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">"first = \($0)"</span></span>) }) myObservable.subscribe(onNext: { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">"second = \($0)"</span></span>) }) DispatchQueue.main.asyncAfter(deadline: .now() + <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Calling connect after 3 seconds"</span></span>) myObservable.connect() } /* Output: Subscribing Calling <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> after <span class="hljs-number"><span class="hljs-number">3</span></span> seconds first = <span class="hljs-number"><span class="hljs-number">1</span></span> second = <span class="hljs-number"><span class="hljs-number">1</span></span> *<span class="hljs-regexp"><span class="hljs-regexp">/</span></span></code> </pre><br>  In the example above, Observers subscribe to <code>myObservable</code> immediately after it has been created.  But they only work after 3 seconds, when the <code>connect()</code> operator was called.  Simply put, <code>connect()</code> activates the Connectable Observable and includes subscribers. <br><br>  The interesting thing is how resources are cleaned up.  Look at this code. <br><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">let</span></span> myObservable = Observable&lt;Int&gt; .interval(1, scheduler: MainScheduler.instance) .publish() myObservable.connect() <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Starting at 0 seconds"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mySubscription = myObservable.subscribe(onNext: { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Next: \(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$0</span></span></span><span class="hljs-string">)"</span></span>) }) DispatchQueue.main.asyncAfter(deadline: .now() + 3) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Disposing at 3 seconds"</span></span>) mySubscription.dispose() } DispatchQueue.main.asyncAfter(deadline: .now() + 6) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscribing again at 6 seconds"</span></span>) myObservable.subscribe(onNext: { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Next: \(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$0</span></span></span><span class="hljs-string">)"</span></span>) }) } // Output: /* Starting at 0 seconds Next: 0 Next: 1 Next: 2 Disposing at 3 seconds Subscribing again at 6 seconds Next: 6 Next: 7 Next: 8 Next: 9 ... */</code> </pre><br>  Even if all subscribers have unsubscribed from our Observable, the latter still lives and continues to produce events under the hood. <br><br><div class="spoiler">  <b class="spoiler_title">Translator's Note</b> <div class="spoiler_text">  <i>The <code>connect()</code> method returns <code>Disposable</code> .</i>  <i>Thus, you can stop the production of elements by calling the <code>dispose()</code> method of this <code>Disposable</code> , or you can provide this <code>DisposeBag</code> ' <code>DisposeBag</code> .</i> </div></div><br>  Now let's compare this to <code>publish().refcount()</code> . <br><br><h3>  The difference between <code>publish().connect()</code> and <code>publish().refcount()</code> </h3><br>  You can perceive the <code>refcount()</code> statement as magic, which is processed for you by unsubscribing the Observers.  <code>refcount()</code> calls <code>connect()</code> automatically when the first Observer is signed, so there is no need to do it yourself. <br><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">let</span></span> myObservable = Observable&lt;Int&gt; .interval(1, scheduler: MainScheduler.instance) .publish() .refCount() <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Starting at 0 seconds"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mySubscription = myObservable.subscribe(onNext: { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Next: \(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$0</span></span></span><span class="hljs-string">)"</span></span>) }) DispatchQueue.main.asyncAfter(deadline: .now() + 3) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Disposing at 3 seconds"</span></span>) mySubscription.dispose() } DispatchQueue.main.asyncAfter(deadline: .now() + 6) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscribing again at 6 seconds"</span></span>) myObservable.subscribe(onNext: { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Next: \(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$0</span></span></span><span class="hljs-string">)"</span></span>) }) } // Output: /* Starting at 0 seconds Next: 0 Next: 1 Next: 2 Disposing at 3 seconds Subscribing again at 6 seconds Next: 0 Next: 1 Next: 2 Next: 3 ... */</code> </pre><br>  <b>Pay attention to that.</b>  <b>When we signed again, Observable began to emit items from the beginning.</b> <br><br><h3>  Conclusion </h3><br>  Feel the difference now?  <code>publish().connect()</code> and <code>publish().refcount()</code> (or <code>share()</code> ) control the unsubscribe mechanism from Obervables differently. <br><br>  When you use <code>publish().connect()</code> , you need to manually control the resource cleanup mechanism of your Observable <i>(described in the note under the spoiler)</i> .  Your sequence behaves as active and produces items all the time, regardless of subscriptions. <br><br>  On the other hand, <code>publish().refcount()/share()</code> keeps track of how many Observers subscribe to the Observable and do not disable the former from the latter as long as at least one subscriber exists.  In other words, when the subscriber count drops to zero, the Observable ‚Äúdies‚Äù and stops producing any items. <br><br>  If something is not completely clear, please let us know in the comments.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/336662/">https://habr.com/ru/post/336662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336648/index.html">Applications for Tarantool. Part 2. OAuth2 authentication</a></li>
<li><a href="../336650/index.html">In a section: the news aggregator on Android with backend. Monitoring and data visualization system (InfluxDB, Grafana)</a></li>
<li><a href="../336654/index.html">Cheat Sheet with Docker Teams</a></li>
<li><a href="../336656/index.html">Double bra * eyes programmer</a></li>
<li><a href="../336660/index.html">How to write when you do not know how lazy</a></li>
<li><a href="../336666/index.html">AngularJS Drag and Drop module. No jQueryUI</a></li>
<li><a href="../336668/index.html">Create Telegram bot on API.AI</a></li>
<li><a href="../336670/index.html">Corporate information: reality and fantasy</a></li>
<li><a href="../336672/index.html">How to read scientific articles: advice from scientists</a></li>
<li><a href="../336674/index.html">Why blockchain is not such a bad technology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>