<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use "Yandeks.Chisty Web" to protect against spam</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For quite a long time, Yandex has been providing a free service for detecting spam in messages called ‚Äú Yandex.Chisty Web ‚Äù, however, it still remains...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use "Yandeks.Chisty Web" to protect against spam</h1><div class="post__text post__text-html js-mediator-article">  For quite a long time, Yandex has been providing a free service for detecting spam in messages called ‚Äú <a href="http://api.yandex.ru/cleanweb/">Yandex.Chisty Web</a> ‚Äù, however, it still remains unpopular. <br><br>  In this post, I will demonstrate the basic methods of working with the Yandex.Clean Web API using the example of a simple PHP class. <br><a name="habracut"></a><br>  So, the service supports four methods - spam detection, receiving a CAPTCHA, checking a entered CAPTCHA and appealing a spam detector solution.  We will consider working with the first three methods. <br><br>  For convenience, we arrange all this in the form of a simple static class. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YandexCW</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $api_key = <span class="hljs-string"><span class="hljs-string">'12345'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* URL- */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> check_data_url = <span class="hljs-string"><span class="hljs-string">'http://cleanweb-api.yandex.ru/1.0/check-spam'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> get_captcha_url = <span class="hljs-string"><span class="hljs-string">'http://cleanweb-api.yandex.ru/1.0/get-captcha'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> check_captcha_url = <span class="hljs-string"><span class="hljs-string">'http://cleanweb-api.yandex.ru/1.0/check-captcha'</span></span>; }</code> </pre> <br><br>  We proceed to the implementation of the class methods.  The Clean Web API accepts GET and POST requests depending on the required method, and gives the result in XML format.  Therefore, we first write an uncomplicated private method in our class for sending requests and reading responses.  We will use SimpleXML to read responses, but we won‚Äôt use CURL - good, the standard <b>file_get_contents</b> function allows you to make both GET and POST requests using <a href="http://php.net/manual/ru/function.stream-context-create.php">contexts</a> . <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xml_query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url, $parameters = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $post = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($parameters[<span class="hljs-string"><span class="hljs-string">'key'</span></span>])) $parameters[<span class="hljs-string"><span class="hljs-string">'key'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$api_key; $parameters_query = http_build_query($parameters); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($post) { $http_options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'http'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'method'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; $parameters_query ) ); $context = stream_context_create($http_options); $contents = file_get_contents($url, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, $context); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $contents = file_get_contents($url.<span class="hljs-string"><span class="hljs-string">'?'</span></span>.$parameters_query); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$contents) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $xml_data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleXMLElement($contents); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $xml_data; }</code> </pre><br><br>  This method will significantly simplify our work with the API - it automatically inserts the key, forms the context for file_get_contents if we need to make a POST request, and also returns the answer already in the form of a SimpleXML object.  I think the code does not need more detailed commenting.  So let's go directly to the methods for working with the API. <br><br><h2>  Check for spam messages </h2><br>  First of all, we will implement a method for sending the message content to Yandex and then checking it for spam.  However, before you simply bring the code, you need to clarify something.  According to the <a href="">description of the <b>check-spam</b> method</a> , it can take the following parameters regarding the content of the message: <br><br><ul><li>  <b>ip</b> is the IP address of the sender. </li><li>  <b>email</b> - The email address of the sender. </li><li>  <b>name</b> - The name of the sender displayed in the message signatures. </li><li>  <b>login</b> - The name of the user account on the resource. </li><li>  <b>realname</b> - user name taken, for example, from his registration data. </li><li>  <b>subject-plain</b> - The subject of the post in text / plain format. </li><li>  <b>subject-html</b> - The topic of the post in text / html format. </li><li>  <b>subject-bbcode</b> - BBCode post subject. </li><li>  <b>body-plain</b> - The content (body) of the comment or post in text / plain format. </li><li>  <b>body-html</b> - The content (body) of the comment or post in text / html format. </li><li>  <b>body-bbcode</b> - The content (body) of the comment or post in BBCode format. </li></ul><br><br>  The set of data sent for verification can be arbitrary, except that from the <b>body</b> and <b>subject</b> parameter family only one type can be specified - either <i>plain</i> , or <i>html</i> , or <i>bbcode</i> .  There are also no required parameters.  Therefore, we will transfer all this data to our method not by parameters that go sequentially, but by one array with an arbitrary data set. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_spam</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message_data, $return_full_data = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($message_data[<span class="hljs-string"><span class="hljs-string">'ip'</span></span>])) $ip = $_SERVER[<span class="hljs-string"><span class="hljs-string">'REMOTE_ADDR'</span></span>]; $response = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::xml_query(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::check_data_url, $message_data, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $spam_detected = (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($response-&gt;text[<span class="hljs-string"><span class="hljs-string">'spam-flag'</span></span>]) &amp;&amp; $response-&gt;text[<span class="hljs-string"><span class="hljs-string">'spam-flag'</span></span>] == <span class="hljs-string"><span class="hljs-string">'yes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$return_full_data) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $spam_detected; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'detected'</span></span> =&gt; $spam_detected, <span class="hljs-string"><span class="hljs-string">'request_id'</span></span> =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($response-&gt;id)) ? $response-&gt;id : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">'spam_links'</span></span> =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($response-&gt;links)) ? $response-&gt;links : <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>() ); }</code> </pre><br><br>  This method will allow us to send data for verification with automatic substitution of the user's IP address.  Depending on the second parameter, the function may return either just <b>true</b> or <b>false</b> , or an array with detailed information containing a list of links suspected to be spamming, as well as a request <b>id</b> generated by Yandex.  He is, by the way, further useful. <br><br><h3>  Getting captcha </h3><br>  Yandex offers us to take advantage of its own ‚Äúcaptcha‚Äù and I must say that this solution has obvious advantages - firstly, the load on our server is reduced, and secondly, the concern about ‚Äúbreaking resistance‚Äù of CAPTCHA falls on Yandex‚Äôs shoulders.  The method will be extremely simple: <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/*  CAPTCHA */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_captcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id = null)</span></span></span><span class="hljs-function"> </span></span>{ $response = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::xml_query(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::get_captcha_url, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $id)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$response || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($response-&gt;captcha)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'captcha_id'</span></span> =&gt; $response-&gt;captcha, <span class="hljs-string"><span class="hljs-string">'captcha_url'</span></span> =&gt; $response-&gt;url); }</code> </pre> <br><br>  As can be seen from the last but one line, the method returns the captcha ID and a link to the image itself. <br>  The link usually has the following form: <br>  <i>u.captcha.yandex.net/image?key= <b>CAPTCHA ID</b></i> <br><br>  It is better to use both output parameters so that the protection does not break if Yandex changes something in the link format. <br><br><h3>  CAPTCHA Check </h3><br>  Finally, the third class method will be used to validate the CAPTCHA value entered by the user. <br>  In order to use it, we will have to give it the ‚Äúcaptcha‚Äù id, issued by the previous method, as well as what the user entered.  It would also be helpful to send the id of the request that we received when we sent the message for verification, but this is not necessary. <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/*  CAPTCHA */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_captcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($captcha_id, $captcha_value, $id = null)</span></span></span><span class="hljs-function"> </span></span>{ $parameters = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'captcha'</span></span> =&gt; $captcha_id, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; $captcha_value, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $id ); $response = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::xml_query(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::check_captcha_url, $parameters); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($response-&gt;ok); }</code> </pre> <br><br><h3>  Examples of using </h3><br>  For a complete check of the ‚ÄúClean Web‚Äù system, you can <a href="">download a</a> simple demo script.  Before checking do not forget <a href="">to get your</a> API <a href="">key</a> "Clean Web" and specify it in the script! <br>  You can also <a href="">download the</a> class separately or see its <a href="">full code</a> in the browser. <br><br>  Verifying Form Content: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       API require('YandexCW.class.php'); YandexCW::$api_key = '12345'; //      $allowed_keys = array('email', 'name', 'login', 'realname', 'subject-plain', 'body-plain'); $post_data = array_intersect_key($_POST, array_fill_keys($allowed_keys, null)); $is_spam = YandexCW::is_spam($post_data, true); //    var_dump($is_spam);</span></span></code> </pre><br><br><h3>  Special features </h3><br>  Most parameters when calling API methods are optional. <br>  For example, you can not use the spam check, but simply connect your Yandex CAPTCHA, in the same way that ReCAPTCHA is connected. <br>  Read more at <a href="http://api.yandex.ru/cleanweb/">api.yandex.ru</a> . </div><p>Source: <a href="https://habr.com/ru/post/163623/">https://habr.com/ru/post/163623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163605/index.html">Logic - weekly selection of gaming and IT-industry news ‚Ññ6</a></li>
<li><a href="../163607/index.html">FREE OFFICIAL outage on Kindle Paperwhite with Special Offers</a></li>
<li><a href="../163611/index.html">Domain Kremlin.ru</a></li>
<li><a href="../163615/index.html">Universal Soldier: Groovy Transformer in DataStage</a></li>
<li><a href="../163621/index.html">What the mess looks like or whether the fascists have homing missiles</a></li>
<li><a href="../163627/index.html">Orion 128: amateur radio computer</a></li>
<li><a href="../163631/index.html">Nanotechnology against fakes</a></li>
<li><a href="../163633/index.html">Windows Phone 8 Keyboard Secrets</a></li>
<li><a href="../163635/index.html">Brushing teeth with a gyroscope - Omron HT-B551 toothbrush</a></li>
<li><a href="../163637/index.html">K√§rcher RC 3000 Robot Vacuum Cleaner: Operational Experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>