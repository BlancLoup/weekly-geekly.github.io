<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WCF + Cross Domain Ajax Calls (CORS) + Authorization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 I would like to demonstrate one of the possible approaches to solving the problem of working with WCF services from different domains. The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WCF + Cross Domain Ajax Calls (CORS) + Authorization</h1><div class="post__text post__text-html js-mediator-article"> Good day! <br>  I would like to demonstrate one of the possible approaches to solving the problem of working with WCF services from different domains.  The information I found on this topic was either incomplete or contained an excessive amount of information that made it difficult to understand.  I want to talk about several ways to interact WCF and AJAX POST requests, including information about cookies and authorization. <br><a name="habracut"></a><br>  As you know, just because AJAX call to another domain does not work, due to security reasons.  To solve this problem, the CORS ( <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">wiki</a> , <a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS">mozilla</a> ) standard was invented and released.  This standard implies the use of specific HTTP headers to allow and restrict access.  A simplified communication process using this protocol implies the following: <br><br>  The client (browser) initiates a connection with the HTTP <code>Origin</code> header, the server must respond using the <code>Access-Control-Allow-Origin</code> header.  Example of request / response pair from address <code><a href="http://foo.example/"></a> foo.example</code>  <code><a href="http://foo.example/"></a> foo.example</code> on service <code><a href="http://bar.other/resources/public-data/"></a> bar.other/resources/public-data</code>  <code><a href="http://bar.other/resources/public-data/"></a> bar.other/resources/public-data</code> : <br><blockquote>  Request: <br>  GET / resources / public-data / HTTP / 1.1 <br>  Host: bar.other <br>  Origin: <code><a href="http://foo.example/"></a> foo.example</code> <br>  [Other headers] <br><br>  Answer: <br>  HTTP / 1.1 200 OK <br>  Date: Mon, 01 Dec 2008 00:23:53 GMT <br>  Access-Control-Allow-Origin: * <br>  Content-Type: application / xml 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      [XML Data] <br></blockquote><br><br><h5>  Headlines </h5><br><ul><li>  <code>Access-Control-Allow-Origin</code> - this header defines the resources from which requests may come.  Can be used <code>*</code> or a specific domain, for example <code><a href="http://foo.example/"></a> foo.example</code>  <code><a href="http://foo.example/"></a> foo.example</code> .  This header can be only one, and can contain only one value, i.e.  domain list can not be set. </li><li>  <code>Access-Control-Allow-Methods</code> - this header defines which methods can be used to communicate with the server.  We confine ourselves to the following: <code>POST,GET,OPTIONS</code> , but you can also use <code>PUT</code> , and <code>DELETE</code> , and others. </li><li>  <code>Access-Control-Allow-Headers</code> ‚Äî This header defines the list of available headers.  For example, <code>Content-Type</code> , which allows you to specify the type of <code>application/json</code> response. </li><li>  <code>Access-Control-Allow-Credentials</code> ‚Äî This header determines whether the transfer of cookies and authorization is allowed.  Possible values ‚Äã‚Äãare <code>true</code> and <code>false</code> .  <b>Important: the</b> data will be transmitted only if a specific domain is explicitly set up in the <code>Access-Control-Allow-Origin</code> header, if you use <code>*</code> , the header will be ignored and the data will not be transmitted. </li></ul><br>  In general, restrictions are imposed by the browser.  If he doesn‚Äôt like something in the headers, he will not give this data to the user (unless the required <code>Access-Control-Allow-Headers</code> returns, or to the server, unless <code>Access-Control-Allow-Credentials</code> and the correct <code>Access-Control-Allow-Origin</code> . Before a <code>POST</code> request to another domain, the browser will first make an <code>OPTIONS</code> request ( <i>preflight request</i> ) for information on the allowed methods of working with the service. <br><br><h5>  WCF </h5><br>  On this topic there is a certain amount of information of various quality.  Unfortunately, WCF does not allow standard headers to use these headers, however there are several options for solving this problem.  I bring to your attention some of them. <br><br><h6>  Solution using web.config. </h6><br>  This solution involves adding the necessary headers directly to the web.config. <br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.webServer&gt; &lt;httpProtocol&gt; &lt;customHeaders&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Access-Control-Allow-Origin" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="http://foo.example" /&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Access-Control-Allow-Headers" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="Content-Type" /&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Access-Control-Allow-Methods" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="POST, GET, OPTIONS" /&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Access-Control-Allow-Credentials" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="true" /&gt; &lt;/customHeaders&gt; &lt;/httpProtocol&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.webServer&gt;</code> </pre> <br>  Differs in its simplicity and inflexibility.  In particular, this particular example cannot be used if there are more than one possible domain, besides it allows CORS to the entire site (in a particular case). <br><br><h6>  Solution using Global.asax </h6><br>  This solution involves writing code in Global.asax.cs that adds the necessary headers to each request. <br><pre> <code class="hljs vbscript">protected void Application_BeginRequest(object sender, EventArgs e) { var allowedOrigins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { <span class="hljs-string"><span class="hljs-string">"http://foo.example"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://bar.example"</span></span> }; var <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = HttpContext.Current.<span class="hljs-built_in"><span class="hljs-built_in">Request</span></span>; var <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> = HttpContext.Current.<span class="hljs-built_in"><span class="hljs-built_in">Response</span></span>; var origin = <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.Headers[<span class="hljs-string"><span class="hljs-string">"Origin"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (origin != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; allowedOrigins.Any(x =&gt; x == origin)) { <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, origin); <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Methods"</span></span>, <span class="hljs-string"><span class="hljs-string">"GET, POST, OPTIONS"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Headers"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type, X-Requested-With"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Credentials"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.HttpMethod == <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">End</span></span>(); } } }</code> </pre><br>  This solution supports multiple domains, but extends to the entire site.  Of course, all the conditions for specific services can be prescribed immediately, but in my opinion this is associated with the inconvenience of supporting the list of allowed services. <br><br><h6>  Solution with adding headers in WCF service code </h6><br>  This solution differs from the previous one only in that headers are added for a specific service or method.  In general, the solution looks like this: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">ServiceContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyService</span></span> { [OperationContract] [WebInvoke(Method = <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, ...)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoStuff</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AddCorsHeaders(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;Data&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddCorsHeaders</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allowedOrigins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { <span class="hljs-string"><span class="hljs-string">"http://foo.example"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://bar.example"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = WebOperationContext.Current.IncomingRequest; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = WebOperationContext.Current.OutgoingResponse; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> origin = request.Headers[<span class="hljs-string"><span class="hljs-string">"Origin"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (origin != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; allowedOrigins.Any(x =&gt; x == origin)) { response.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, origin); response.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Methods"</span></span>, <span class="hljs-string"><span class="hljs-string">"GET, POST, OPTIONS"</span></span>); response.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Headers"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type, X-Requested-With"</span></span>); response.AddHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Credentials"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.HttpMethod == <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>) { response.End(); } } } }</code> </pre><br>  This approach allows you to limit the use of CORS within a service or even a method.  The main disadvantage is that the <code>AddCorsHeaders</code> call <code>AddCorsHeaders</code> required in each service method.  Plus - ease of use. <br><br><h6>  Solution using native EndPointBehavior and DispatchMessageInspector </h6><br>  This approach takes advantage of WCF functionality. <br>  2 classes of <code>EnableCorsBehavior</code> are created: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Channels; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Description; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">My.Web.Cors</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EnableCorsBehavior</span></span> : <span class="hljs-title"><span class="hljs-title">BehaviorExtensionElement</span></span>, <span class="hljs-title"><span class="hljs-title">IEndpointBehavior</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBindingParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, BindingParameterCollection bindingParameters</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyClientBehavior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, ClientRuntime clientRuntime</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyDispatchBehavior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, EndpointDispatcher endpointDispatcher</span></span></span><span class="hljs-function">)</span></span> { endpointDispatcher.DispatchRuntime.MessageInspectors.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnableCorsMessageInspector()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> Type BehaviorType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EnableCorsBehavior); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateBehavior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnableCorsBehavior(); } } }</code> </pre> <br>  and <code>EnableCorsMessageInspector</code> : <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.ServiceModel.Channels; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.ServiceModel.Dispatcher; namespace My.Web.Cors { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> EnableCorsMessageInspector : IDispatchMessageInspector { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> AfterReceiveRequest(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Message request, IClientChannel channel, InstanceContext instanceContext) { var allowedOrigins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> [] { "http://foo.example", "http://bar.example" }; var httpProp = (HttpRequestMessageProperty)request.Properties[HttpRequestMessageProperty.Name]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (httpProp != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { string origin = httpProp.Headers["Origin"]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (origin != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; allowedOrigins.<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>(x =&gt; x == origin)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> origin; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> BeforeSendReply(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Message reply, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> correlationState) { string origin = correlationState <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (origin != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { HttpResponseMessageProperty httpProp = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reply.Properties.ContainsKey(HttpResponseMessageProperty.Name)) { httpProp = (HttpResponseMessageProperty)reply.Properties[HttpResponseMessageProperty.Name]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { httpProp = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HttpResponseMessageProperty(); reply.Properties.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(HttpResponseMessageProperty.Name, httpProp); } httpProp.Headers.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>("Access-Control-Allow-Origin", origin); httpProp.Headers.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>("Access-Control-Allow-Credentials", "true"); httpProp.Headers.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>("Access-Control-Request-Method", "POST,GET,OPTIONS"); httpProp.Headers.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>("Access-Control-Allow-Headers", "X-Requested-With,Content-Type"); } } } }</code> </pre><br>  Add to the <code>web.config</code> created by <code>EnableCorsBehavior</code> : <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"crossOriginResourceSharingBehavior"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My.Web.Cors.EnableCorsBehavior, My.Web, Version=1.0.0.0, Culture=neutral"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We find and add the extension created for <code>EnableCorsBehavior</code> to the <code>Behavior</code> configuration of our <code>Endpoint</code> 'a <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My.Web.Services.MyService"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behaviorConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My.Web.Services.MyService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webHttpBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My.Web.Services.MyService"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"My.Web.Services.MyService"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">webHttp</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">crossOriginResourceSharingBehavior</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  It remains for us to only process the preliminary request with the <code>OPTIONS</code> method.  In my case, I used the simplest option: the <code>OPTIONS</code> request handler method is added to the service body. <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">OperationContract</span></span>] [WebInvoke(Method = <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>, UriTemplate = <span class="hljs-string"><span class="hljs-string">"*"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOptions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    EnableCorsMessageInspector }</span></span></code> </pre><br>  Of course, there is a similar WCF extension for working with preflight requests, one of which can be read from the reference list at the end of the article.  The main disadvantage is the need to add the <code>GetOptions</code> method to the service body and a considerable amount of additional code.  On the other hand, this approach allows almost completely separating the logic of the service and the logic of communication. <br><br><h5>  A few words about Javascript and browsers </h5><br>  To support sending authorization and cookie data, it is necessary that the <code>withCredentials</code> flag is set to <code>true</code> <code>withCredentials</code> flag.  I think that many people use jQuery to work with AJAX, so I‚Äôll give an example for it: <br><pre> <code class="hljs scala"> $.ajax({ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: <span class="hljs-symbol"><span class="hljs-symbol">'POS</span></span>T', cache: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, dataType: <span class="hljs-symbol"><span class="hljs-symbol">'jso</span></span>n', xhrFields: { withCredentials: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, contentType: <span class="hljs-symbol"><span class="hljs-symbol">'application</span></span>/json; charset=utf<span class="hljs-number"><span class="hljs-number">-8</span></span>', url: options.serviceUrl + '/<span class="hljs-type"><span class="hljs-type">DoStuff</span></span>' });</code> </pre><br><br>  Unfortunately, the functionality associated with sending authorization data has become available for IE only from version 10, IE8 / 9 browsers do not support sending this information, and are able to work only with GET and POST. <br><br><h6>  Authorization </h6><br>  All approaches above implicitly use authentication data from the main site.  Having authorization on the main site <code><a href="http://bar.other/"></a> bar.other</code>  <code><a href="http://bar.other/"></a> bar.other</code> , we have the ability to return user data for an Ajax request from the site <code><a href="http://foo.example/"></a> foo.example</code>  <code><a href="http://foo.example/"></a> foo.example</code> .  In my case, this was used to enable the user to receive notifications and respond to events, being on one of the sites living within the same business project, but located on different domains and platforms.  As mentioned above, the key points here are the header <code>Access-Control-Allow-Credentials</code> and setting the flag for <code>XmlHttpRequest</code> <code>withCredentials=true</code> . <br><br><h6>  List of sources </h6><br><ul><li>  <a href="http://code.msdn.microsoft.com/windowsdesktop/Implementing-CORS-support-c1f9cd4b">code.msdn.microsoft.com/windowsdesktop/Implementing-CORS-support-c1f9cd4b</a> - an example of the full implementation of MessageInspector for all requests and <a href="http://blogs.msdn.com/b/carlosfigueira/archive/2012/05/15/implementing-cors-support-in-wcf.aspx%3FRedirected%3Dtrue">an article</a> to it </li><li>  <a href="http://enable-cors.org/server_wcf.html">enable-cors.org/server_wcf.html</a> is a rather short manual on writing your own Behavior and MessageInspector, does not take into account the peculiarities of OPTIONS requests, and does not allow you to use Origin checking / selection </li><li>  <a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS">developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS#Access-Control-Allow-Headers</a> is one of the most comprehensive sources for CORS information. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/219895/">https://habr.com/ru/post/219895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219879/index.html">Startup step by step: team and mentors</a></li>
<li><a href="../219881/index.html">Tizen Developer Lab in St. Petersburg</a></li>
<li><a href="../219889/index.html">Dripstat again</a></li>
<li><a href="../219891/index.html">Continuous integration. The way to ensure reliability and trust in the system</a></li>
<li><a href="../219893/index.html">Removing Whitelist in bios laptops on the example of Lenovo X230</a></li>
<li><a href="../219899/index.html">Site on c ++ (CppCMS). Part 1</a></li>
<li><a href="../219901/index.html">The beauty of the universe in NASA tweets</a></li>
<li><a href="../219903/index.html">Habrahabru - 8 years</a></li>
<li><a href="../219905/index.html">Data encryption in a public cloud - control and quiet sleep of the customer</a></li>
<li><a href="../219907/index.html">PHP extension dom_varimport: fast conversion of nested arrays to DOMDocument</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>