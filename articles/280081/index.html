<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sorting tables in Cach√© DBMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="But what sorting! 
 (A. S. Pushkin) 

 If it were a Twitter post, it would be: ‚Äú Cach√© ObjectScript programmers! Use Cyrillic4 instead of Cyrillic3! "...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sorting tables in Cach√© DBMS</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/280081/"><img src="https://habrastorage.org/files/58c/e9a/b36/58ce9ab3607b4a54bb030a005201f9d9.jpg" align="left" title="Piet Mondrian - Composition A"></a>  <em>But what sorting!</em> <em><br></em>  <em>(A. S. Pushkin)</em> <br><br>  If it were a Twitter post, it would be: ‚Äú <i>Cach√© ObjectScript programmers!</i>  <i>Use Cyrillic4 instead of Cyrillic3!</i>  ".  But here Habr, therefore it is necessary to develop a thought - welcome under cat. <a name="habracut"></a><br><br>  Everything in Cach√© is stored in globals.  Data, metadata, classes, programs.  Global nodes are sorted by index values ‚Äã‚Äã(subscript) and stored on the disk not in the order in which they were inserted, but in the sorted one - for a quick search: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^a(<span class="hljs-number"><span class="hljs-number">10</span></span>)="" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^a("")="" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^a("")="" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^a(<span class="hljs-number"><span class="hljs-number">2</span></span>)="" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;zwrite ^a ^a(<span class="hljs-number"><span class="hljs-number">2</span></span>)="" ^a(<span class="hljs-number"><span class="hljs-number">10</span></span>)="" ^a("")="" ^a("")=""</code> </pre> <br>  When sorting, Cach√© distinguishes between numbers and strings - 2 is treated as a number and sorted before 10. The <i>zwrite</i> command and the <i>$ Order</i> and <i>$ Query</i> functions output global indexes in the order in which they are stored on disk: first, an empty string, then negative numbers, zero, positive numbers, then strings in the order specified by the collation table. <br><br>  In the simplest case, the sorting table matches each character with a certain sequence number.  Further, the sorting table I will call sorting. <br><br>  Standard sorting in Cach√© is called Cach√© standard.  It matches each character with its Unicode code. <br><br>  The sorting with which local arrays are created in the current process is determined by the locale (Management Portal&gt; System Administration&gt; Configuration&gt; Configuring National Language Support).  For <i>rusw</i> - the Russian locale of Unicode installations Cach√© - the default sorting table is Cyrillic3.  Other possible sorts in <i>rusw</i> are Cach√© standard, Cyrillic1, Cyrillic3, Cyrillic4, Ukrainian1. <br><br>  The <i><a href="">## class (% Collate) .SetLocalName () method</a></i> changes the sorting for the local arrays of the current process: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).GetLocalName() Cyrillic3 <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).SetLocalName("Cache standard") <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).GetLocalName() <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span> standard USER&gt;write ##class(%Collate).SetLocalName("Cyrillic3") <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).GetLocalName() Cyrillic3</code> </pre> <br>  Each sort has a steam room in which the numbers are sorted as strings.  The name of such a pair sort is obtained by appending "string" to the name of the original sort: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).SetLocalName("Cache standard string") <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;kill test <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> test(<span class="hljs-number"><span class="hljs-number">10</span></span>) = "", test(<span class="hljs-number"><span class="hljs-number">2</span></span>) = "", test("") = "", test("") = "" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;zwrite test test(<span class="hljs-number"><span class="hljs-number">10</span></span>)="" test(<span class="hljs-number"><span class="hljs-number">2</span></span>)="" test("")="" test("")="" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).SetLocalName("Cache standard") <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;kill test <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> test(<span class="hljs-number"><span class="hljs-number">10</span></span>) = "", test(<span class="hljs-number"><span class="hljs-number">2</span></span>) = "", test("") = "", test("") = "" <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;zwrite test test(<span class="hljs-number"><span class="hljs-number">2</span></span>)="" test(<span class="hljs-number"><span class="hljs-number">10</span></span>)="" test("")="" test("")=""</code> </pre> <br><h2>  Cach√© standard and Cyrillic3 </h2><br>  In Cach√© standard, characters are sorted in the order of their Unicode codes: <br><br><pre> <code class="hljs smalltalk"> write #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(%<span class="hljs-type"><span class="hljs-type">Library</span></span>.<span class="hljs-type"><span class="hljs-type">Collate</span></span>).<span class="hljs-type"><span class="hljs-type">SetLocalName</span></span>(<span class="hljs-comment"><span class="hljs-comment">"Cache standard"</span></span>),! write #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(%<span class="hljs-type"><span class="hljs-type">Library</span></span>.<span class="hljs-type"><span class="hljs-type">Collate</span></span>).<span class="hljs-type"><span class="hljs-type">GetLocalName</span></span>(),! set letters = <span class="hljs-comment"><span class="hljs-comment">""</span></span> set letters = letters _ <span class="hljs-string"><span class="hljs-string">$z</span></span>convert(letters,<span class="hljs-comment"><span class="hljs-comment">"U"</span></span>) kill test // test  for i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-string"><span class="hljs-string">$L</span></span>ength(letters) { set test(<span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(letters,i)) = <span class="hljs-comment"><span class="hljs-comment">""</span></span> } //   test    set l = <span class="hljs-comment"><span class="hljs-comment">""</span></span>, cnt = <span class="hljs-number"><span class="hljs-number">0</span></span> for { set l = <span class="hljs-string"><span class="hljs-string">$O</span></span>rder(test(l)) quit:l=<span class="hljs-comment"><span class="hljs-comment">""</span></span> write l, <span class="hljs-comment"><span class="hljs-comment">" "</span></span>, <span class="hljs-string"><span class="hljs-string">$A</span></span>scii(l),<span class="hljs-comment"><span class="hljs-comment">","</span></span> set cnt = cnt + <span class="hljs-number"><span class="hljs-number">1</span></span> write:cnt#<span class="hljs-number"><span class="hljs-number">8</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> ! }</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ^testcol <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span> standard  <span class="hljs-number"><span class="hljs-number">1025</span></span>, <span class="hljs-number"><span class="hljs-number">1040</span></span>, <span class="hljs-number"><span class="hljs-number">1041</span></span>, <span class="hljs-number"><span class="hljs-number">1042</span></span>, <span class="hljs-number"><span class="hljs-number">1043</span></span>, <span class="hljs-number"><span class="hljs-number">1044</span></span>, <span class="hljs-number"><span class="hljs-number">1045</span></span>, <span class="hljs-number"><span class="hljs-number">1046</span></span>,  <span class="hljs-number"><span class="hljs-number">1047</span></span>, <span class="hljs-number"><span class="hljs-number">1048</span></span>, <span class="hljs-number"><span class="hljs-number">1049</span></span>, <span class="hljs-number"><span class="hljs-number">1050</span></span>, <span class="hljs-number"><span class="hljs-number">1051</span></span>, <span class="hljs-number"><span class="hljs-number">1052</span></span>, <span class="hljs-number"><span class="hljs-number">1053</span></span>, <span class="hljs-number"><span class="hljs-number">1054</span></span>,  <span class="hljs-number"><span class="hljs-number">1055</span></span>, <span class="hljs-number"><span class="hljs-number">1056</span></span>, <span class="hljs-number"><span class="hljs-number">1057</span></span>, <span class="hljs-number"><span class="hljs-number">1058</span></span>, <span class="hljs-number"><span class="hljs-number">1059</span></span>, <span class="hljs-number"><span class="hljs-number">1060</span></span>, <span class="hljs-number"><span class="hljs-number">1061</span></span>, <span class="hljs-number"><span class="hljs-number">1062</span></span>,  <span class="hljs-number"><span class="hljs-number">1063</span></span>, <span class="hljs-number"><span class="hljs-number">1065</span></span>, <span class="hljs-number"><span class="hljs-number">1066</span></span>, <span class="hljs-number"><span class="hljs-number">1067</span></span>, <span class="hljs-number"><span class="hljs-number">1068</span></span>, <span class="hljs-number"><span class="hljs-number">1069</span></span>, <span class="hljs-number"><span class="hljs-number">1070</span></span>, <span class="hljs-number"><span class="hljs-number">1071</span></span>,  <span class="hljs-number"><span class="hljs-number">1072</span></span>, <span class="hljs-number"><span class="hljs-number">1073</span></span>, <span class="hljs-number"><span class="hljs-number">1074</span></span>, <span class="hljs-number"><span class="hljs-number">1075</span></span>, <span class="hljs-number"><span class="hljs-number">1076</span></span>, <span class="hljs-number"><span class="hljs-number">1077</span></span>, <span class="hljs-number"><span class="hljs-number">1078</span></span>, <span class="hljs-number"><span class="hljs-number">1079</span></span>,  <span class="hljs-number"><span class="hljs-number">1080</span></span>, <span class="hljs-number"><span class="hljs-number">1081</span></span>, <span class="hljs-number"><span class="hljs-number">1082</span></span>, <span class="hljs-number"><span class="hljs-number">1083</span></span>, <span class="hljs-number"><span class="hljs-number">1084</span></span>, <span class="hljs-number"><span class="hljs-number">1085</span></span>, <span class="hljs-number"><span class="hljs-number">1086</span></span>, <span class="hljs-number"><span class="hljs-number">1087</span></span>,  <span class="hljs-number"><span class="hljs-number">1088</span></span>, <span class="hljs-number"><span class="hljs-number">1089</span></span>, <span class="hljs-number"><span class="hljs-number">1090</span></span>, <span class="hljs-number"><span class="hljs-number">1091</span></span>, <span class="hljs-number"><span class="hljs-number">1092</span></span>, <span class="hljs-number"><span class="hljs-number">1093</span></span>, <span class="hljs-number"><span class="hljs-number">1094</span></span>, <span class="hljs-number"><span class="hljs-number">1095</span></span>,  <span class="hljs-number"><span class="hljs-number">1097</span></span>, <span class="hljs-number"><span class="hljs-number">1098</span></span>, <span class="hljs-number"><span class="hljs-number">1099</span></span>, <span class="hljs-number"><span class="hljs-number">1100</span></span>, <span class="hljs-number"><span class="hljs-number">1101</span></span>, <span class="hljs-number"><span class="hljs-number">1102</span></span>, <span class="hljs-number"><span class="hljs-number">1103</span></span>, <span class="hljs-number"><span class="hljs-number">1105</span></span>,</code> </pre> <br>  All the letters in its place, except for the letters "e" and "E".  Their Unicode codes are knocked out of general order.  Therefore, the Russian locale needed its own sorting table - Cyrillic3, in which the letters go in the same order as in the Russian alphabet: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ^testcol <span class="hljs-number"><span class="hljs-number">1</span></span> Cyrillic3  <span class="hljs-number"><span class="hljs-number">1040</span></span>, <span class="hljs-number"><span class="hljs-number">1041</span></span>, <span class="hljs-number"><span class="hljs-number">1042</span></span>, <span class="hljs-number"><span class="hljs-number">1043</span></span>, <span class="hljs-number"><span class="hljs-number">1044</span></span>, <span class="hljs-number"><span class="hljs-number">1045</span></span>, <span class="hljs-number"><span class="hljs-number">1025</span></span>, <span class="hljs-number"><span class="hljs-number">1046</span></span>,  <span class="hljs-number"><span class="hljs-number">1047</span></span>, <span class="hljs-number"><span class="hljs-number">1048</span></span>, <span class="hljs-number"><span class="hljs-number">1049</span></span>, <span class="hljs-number"><span class="hljs-number">1050</span></span>, <span class="hljs-number"><span class="hljs-number">1051</span></span>, <span class="hljs-number"><span class="hljs-number">1052</span></span>, <span class="hljs-number"><span class="hljs-number">1053</span></span>, <span class="hljs-number"><span class="hljs-number">1054</span></span>,  <span class="hljs-number"><span class="hljs-number">1055</span></span>, <span class="hljs-number"><span class="hljs-number">1056</span></span>, <span class="hljs-number"><span class="hljs-number">1057</span></span>, <span class="hljs-number"><span class="hljs-number">1058</span></span>, <span class="hljs-number"><span class="hljs-number">1059</span></span>, <span class="hljs-number"><span class="hljs-number">1060</span></span>, <span class="hljs-number"><span class="hljs-number">1061</span></span>, <span class="hljs-number"><span class="hljs-number">1062</span></span>,  <span class="hljs-number"><span class="hljs-number">1063</span></span>, <span class="hljs-number"><span class="hljs-number">1065</span></span>, <span class="hljs-number"><span class="hljs-number">1066</span></span>, <span class="hljs-number"><span class="hljs-number">1067</span></span>, <span class="hljs-number"><span class="hljs-number">1068</span></span>, <span class="hljs-number"><span class="hljs-number">1069</span></span>, <span class="hljs-number"><span class="hljs-number">1070</span></span>, <span class="hljs-number"><span class="hljs-number">1071</span></span>,  <span class="hljs-number"><span class="hljs-number">1072</span></span>, <span class="hljs-number"><span class="hljs-number">1073</span></span>, <span class="hljs-number"><span class="hljs-number">1074</span></span>, <span class="hljs-number"><span class="hljs-number">1075</span></span>, <span class="hljs-number"><span class="hljs-number">1076</span></span>, <span class="hljs-number"><span class="hljs-number">1077</span></span>, <span class="hljs-number"><span class="hljs-number">1105</span></span>, <span class="hljs-number"><span class="hljs-number">1078</span></span>,  <span class="hljs-number"><span class="hljs-number">1079</span></span>, <span class="hljs-number"><span class="hljs-number">1080</span></span>, <span class="hljs-number"><span class="hljs-number">1081</span></span>, <span class="hljs-number"><span class="hljs-number">1082</span></span>, <span class="hljs-number"><span class="hljs-number">1083</span></span>, <span class="hljs-number"><span class="hljs-number">1084</span></span>, <span class="hljs-number"><span class="hljs-number">1085</span></span>, <span class="hljs-number"><span class="hljs-number">1086</span></span>,  <span class="hljs-number"><span class="hljs-number">1087</span></span>, <span class="hljs-number"><span class="hljs-number">1088</span></span>, <span class="hljs-number"><span class="hljs-number">1089</span></span>, <span class="hljs-number"><span class="hljs-number">1090</span></span>, <span class="hljs-number"><span class="hljs-number">1091</span></span>, <span class="hljs-number"><span class="hljs-number">1092</span></span>, <span class="hljs-number"><span class="hljs-number">1093</span></span>, <span class="hljs-number"><span class="hljs-number">1094</span></span>,  <span class="hljs-number"><span class="hljs-number">1095</span></span>, <span class="hljs-number"><span class="hljs-number">1097</span></span>, <span class="hljs-number"><span class="hljs-number">1098</span></span>, <span class="hljs-number"><span class="hljs-number">1099</span></span>, <span class="hljs-number"><span class="hljs-number">1100</span></span>, <span class="hljs-number"><span class="hljs-number">1101</span></span>, <span class="hljs-number"><span class="hljs-number">1102</span></span>, <span class="hljs-number"><span class="hljs-number">1103</span></span>,</code> </pre> <br>  Cach√© ObjectScript has a special binary operator]] - ‚Äúsorted after‚Äù.  It returns 1 if the left argument in the array index is placed after the right argument, otherwise 0: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Library.<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).SetLocalName("Cache standard"),! <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> "" ]] "" <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Library.<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).SetLocalName("Cyrillic3"),! <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> "" ]] "" <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><h2>  Globals and sorting tables </h2><br>  Different globals in the same database may have different sorting.  Each database has a setting - sorting for new globals.  Immediately after installation, all bases except <i>USER</i> have the default sorting for new globals - Cach√© standard.  For <i>USER</i> , depending on the installation locale.  For <i>rusw</i> - Cyrillic3. <br><br>  Creating a global with sorting other than the default sorting for this database: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;kill ^a <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%GlobalEdit).<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(,"a",##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).DisplayToLogical("Cache standard"))</code> </pre> <br>  In the list of globals in the Management Portal (System Browser&gt; Globals) for each global, its sorting is shown (fourth column). <br><br>  You cannot change the sorting of an existing global.  You need to create a global with a new sort and copy the data from the old global with the merge command.  Mass conversion of globals from one sort to another can be done using the <i><a href="">## class (SYS.Database) .Copy ()</a></i> method <br><br><h2>  Cyrillic4, Cyrillic3 and umlauts </h2><br>  During the operation of Cyrillic3, it turned out that the conversion of the text index to the internal format takes longer than in the Cach√© standard sorting, so inserting and navigating the global (or local array) with Cyrillic3 sorting is slower.  A new Cyrillic4 sorting has been created, available from version 2014.1.  The order of Cyrillic letters in it is the same as in Cyrillic3, but Cyrillic4 is much faster. <br><br><pre> <code class="hljs lua"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> collation=<span class="hljs-string"><span class="hljs-string">"Cyrillic3"</span></span>,<span class="hljs-string"><span class="hljs-string">"Cyrillic4"</span></span>,<span class="hljs-string"><span class="hljs-string">"Cache standard"</span></span>,<span class="hljs-string"><span class="hljs-string">"Cyrillic1"</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> ##class(%Library.Collate).SetLocalName(collation),! <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> ##class(%Library.Collate).GetLocalName(),! <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> test(<span class="hljs-number"><span class="hljs-number">100000</span></span>) } quit test(C) set letters = <span class="hljs-string"><span class="hljs-string">""</span></span> set letters = letters _ $zconvert(letters,<span class="hljs-string"><span class="hljs-string">"U"</span></span>) kill test <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> <span class="hljs-string"><span class="hljs-string">"test insert: "</span></span> //  test  set z1=$zh <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:C { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:$Length(letters) { set test($Extract(letters,i)_<span class="hljs-string"><span class="hljs-string">"   "</span></span> _ $Extract(letters,i)) = <span class="hljs-string"><span class="hljs-string">""</span></span> } } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> $zh-z1,! //   test <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> <span class="hljs-string"><span class="hljs-string">"test $Order: "</span></span> set z1=$zh <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:C { set l = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { set l = $Order(test(l)) quit:l=<span class="hljs-string"><span class="hljs-string">""</span></span> } } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> $zh-z1,!</code> </pre> <br><pre> <code class="hljs bash">USER&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ^testcol 1 Cache standard <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> insert: 1.520673 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-variable"><span class="hljs-variable">$Order</span></span>: 2.062228 1 Cyrillic3 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> insert: 3.541697 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-variable"><span class="hljs-variable">$Order</span></span>: 5.938042 1 Cyrillic4 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> insert: 1.925205 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-variable"><span class="hljs-variable">$Order</span></span>: 2.834399</code> </pre> <br>  Cyrillic4 is not yet the default sorting in the rusw locale, but by creating your own locus based on rusw, you can specify Cyrillic4 as the default sorting for local arrays.  Or specify Cyrillic4 as the default sorting for new globals in the database settings. <br><br>  Cyrillic3 is slower than Cach√© standard and Cyrillic4, because it is based on a more general algorithm than sorting two lines depending on the codes of the corresponding characters of these lines. <br><br>  In German, when sorting, the <a href="https://en.wikipedia.org/wiki/German_orthography">letter √ü should be interpreted as ss</a> .  This is how Cach√© works: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%<span class="hljs-keyword"><span class="hljs-keyword">Collate</span></span>).GetLocalName() German3 <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> test("Stra√üer")=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> test("Strasser")=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> test("Straster")=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;zwrite test test("Strasser")=<span class="hljs-number"><span class="hljs-number">1</span></span> test("Stra√üer")=<span class="hljs-number"><span class="hljs-number">1</span></span> test("Straster")=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Pay attention to the order of the lines.  Namely, that the first four letters of the first line are ‚ÄúStras‚Äù, then ‚ÄúStra√ü‚Äù, then again ‚ÄúStras‚Äù.  This order can not be achieved if each letter compare some code. <br><br>  You and I were lucky with the Russian language - there are no umlauts or letters that can be sorted in the same way, like, for example, <a href="https://en.wikipedia.org/wiki/Finnish_orthography">v and w in Finnish</a> .  In Russian, it is enough to give each letter a number, and compare the lines by the number of letters in the corresponding positions.  Due to this, it turned out to win in speed in Cyrillic4. <br><br><h2>  Sort and SQL tables </h2><br><blockquote>  Do not confuse the sorting table in globals and sorting (also collation) for a column in SQL.  The second sort is the transformation applied to the value before putting it into the index global or comparing it with another value.  In Cach√© SQL, the default sorting for strings is <i>SQLUPPER</i> .  This conversion converts all letters to upper case, removes whitespace at the end and adds one space to the beginning of the line.  Three other SQL collations ( <i>EXACT</i> , <i>SQLSTRING</i> , <i>TRUNCATE</i> ) are described in the <a href="">documentation</a> . </blockquote><br>  With some skill it is not difficult to create confusion, when different globals in the database have different sorting, and local arrays are third.  SQL for internal use uses the <i>CACHETEMP</i> database, the global sorting of which may also differ from the default sorting of the current locale. <br><br>  The basic rule is that for ORDER BY in SQL queries to return rows in the expected order, the sorting of globals that store data and indexes of tables participating in the query must be the same as the default sorting for the <i>CACHETEMP</i> database and the sorting of local arrays.  For details, see the paragraph in the <a href="">SQL and NLS Collations</a> documentation. <br><br>  Create a test class: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> Habr.test Extends %Persistent { Property <span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; Property Surname <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> SurInd <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> Surname; ClassMethod populate() { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..%KillExtent() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t = ..%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t.Name = "", t.Surname = "" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> t.%Save() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t = ..%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t.Name = "", t.Surname = "" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> t.%Save() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t = ..%<span class="hljs-built_in"><span class="hljs-built_in">New</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> t.Name = "", t.Surname = "" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> t.%Save() } }</code> </pre> <br>  Fill in the data (you can then change the names on the lines from the German example): <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(Habr.test).populate()</code> </pre> <br>  Run the query: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/21e/6e7/002/21e6e7002dc8c04d139f7a9624e5637a.png"></div><br>  The result is unexpected.  The main question is why not the alphabetical order of names (Pavel, Peter, Prokhor)?  We look at the request plan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f0b/85a/828/f0b85a828b62d7ce9933741241f2630c.png"></div><br>  Key words in this plan are ‚Äúpopulates temp-file‚Äù.  To execute the query, the SQL optimizer decided to use a temporary structure ‚Äî temp-file ‚Äî global (in some cases, a local array) visible only to the current process (process-private global).  In the indexes of the global values ‚Äã‚Äãare placed and then displayed in sorted order.  Temporary globals are stored in the <i>CACHETEMP</i> database, the sorting for the new globals in which is the Cach√© standard.  But why "e" at the beginning and not at the end?  In the indexes of the temporary global, the value of the name field is reduced to <i>uppercase</i> ( <i>SQLUPPER</i> is the <a href="">default for strings</a> ), respectively, the letter E will be at the very beginning. <br><br>  By canceling the automatic conversion ( <a href=""><i>% Exact</i></a> function), we still get the wrong, but at least the expected order - ‚Äú‚Äù is sorted after all the letters <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/502/8f3/cd3/5028f3cd3e78f5ccbe0e29aba175de8a.png"></div><br>  We will not fix the sorting table in <i>CACHETEMP</i> for the <i>time being</i> - check queries with surname.  After all, this column has an index in the global <i>^ Habr.TestI</i> .  Sorting this global is Cyrillic3, so the order of the rows should be alphabetic: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd3/83b/9c9/fd383b9c9c8cff8aee5cd80af52a9ba8.png"></div><br>  Again, not that.  See the plan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0bb/dce/fbb/0bbdcefbbe20e8de917683aabff74ca5.png"></div><br>  To display the last names in their original form (before the <i>SQLUPPER</i> conversion, which is applied by default to the SurInd index elements), only the index data is small and you need to refer to the table, so the SQL optimizer decided to take the data directly from the table and sort them in a temporary variable - as in the case of name. <br><br>  If you specify in the request that the upper case suits us, then the order will be correct - the data will be taken directly from the index global <i>^ Habr.testI</i> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/765/6fd/8ac/7656fd8ac18fe7aba9e74e44d067825e.png"></div><br>  Request Plan Expected: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/c6e/cc5/efec6ecc54a183aced92a6a3d9ceacd9.png"></div><br>  Now let's do what had to be done long ago - change the default sorting for new globals in the <i>CACHETEMP</i> database to Cyrillic3 (or Cyrillic4). <br><br>  Requests that used temporary structures now output the lines in the correct order: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3bb/528/b3a/3bb528b3a68960304c6beb6f95c8d8f4.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a1e/2c0/a2a/a1e2c0a2ab0fb576bad96937ad6abe43.png"></div><br><br><h2>  findings </h2><br><ul><li>  If you do not care about the order in which the data is displayed with the letter E, use the Cach√© standard sorting table. </li><li>  If you are using Cyrillic3, test your application with the Cyrillic4 sorting table.  The app will get faster. </li><li>  Check that the same sorting table is in the <i>CACHETEMP</i> database, working database and locale settings. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/280081/">https://habr.com/ru/post/280081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280071/index.html">Introduction to PHP 7: What's added, what's removed</a></li>
<li><a href="../280073/index.html">Damn! Cloud computers! Choosing a thin client for Parallels VDI</a></li>
<li><a href="../280075/index.html">Java "var" keyword: please, not this</a></li>
<li><a href="../280077/index.html">Oracle SPARC T7 and M7 Servers - A New Platform for Secure Computing</a></li>
<li><a href="../280079/index.html">Time to learn: Digest of free educational materials from Mail.Ru Group</a></li>
<li><a href="../280083/index.html">Microservices. How to do and when to apply?</a></li>
<li><a href="../280085/index.html">Windows Trojan specializes in stealing data from isolated air-gapped computers</a></li>
<li><a href="../280087/index.html">Superscalar stack processor: details</a></li>
<li><a href="../280089/index.html">Conference DUMP-2016: Review of the Web-design section</a></li>
<li><a href="../280091/index.html">Who are the most famous hackers in history?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>