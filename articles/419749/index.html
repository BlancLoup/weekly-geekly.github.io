<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Functions for documenting PostgreSQL databases. Ending</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the fourth and last part of the article, which describes user functions for working with system directories: pg_class, pg_attribute, pg_constr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Functions for documenting PostgreSQL databases. Ending</h1><div class="post__text post__text-html js-mediator-article">  This is the fourth and last part of the article, which describes user functions for working with system directories: pg_class, pg_attribute, pg_constraints, etc.  <a href="https://habr.com/post/415575/">The first</a> , <a href="https://habr.com/post/415897/">second</a> and <a href="https://habr.com/post/418597/">third</a> parts of the article are published earlier. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/rx/ta/zcrxta08dnfat5cqpgid4lyq7by.png"></div><br><p>  I anticipate that I must apologize in advance to those readers who are interested only in the device configuration of the PostgrSQL system directories, as well as in the techniques for extracting data from them.  The functions that are described in this part of the article do not apply to the system directories that have not yet been reviewed, and the methods for extracting data are no different from those described in the previous parts.  Such readers can finish viewing the article right here. </p><br><a name="habracut"></a><br><p>  To all those who decide to continue reading, I inform you that this part of the article discusses functions that return the extended characteristics of <b>primary</b> and <b>foreign keys</b> , as well as indexes of tables.  And of course, there is a brief description and code for the function <b>admtf_Table_ComplexFeatures</b> , <a href="https://habr.com/post/415575/">which was stated as the purpose of the publication in the first part of the article</a> . </p><br><p>  The first half of the article contains comments on the implementation of functions.  In the second, the source code of the functions.  For those readers who are interested only in the source code, we suggest that you go straight to the <a href="https://habr.com/ru/post/419749/">Appendix</a> . <br><a name="tfPKCF_def"></a><br></p><h3>  The structure of the function that returns the list of characteristics of the primary key of the table </h3><br><img src="https://habrastorage.org/webt/mz/oy/gj/mzoygj-qqx8sqyug_-hesgcypsu.png"><br>  <i>Fig.</i>  <i>4. Functions that admtf_PrimaryKey_ComplexFeatures calls.</i> <br>  <strong>Table 20. Assignment of functions.</strong> <br><br><img src="https://habrastorage.org/webt/4s/si/fi/4ssifibkguxld-bpg7ovcac-yua.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_PrimaryKey_Features</a> </td><td width="40">  The function returns the characteristics of the primary key (PRIMARY KEY) table </td></tr><tr><td width="5">  2 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_PrimaryKey_Attributes</a> </td><td width="40">  The function returns a list of primary key attributes (PRIMARY KEY) and their characteristics. </td></tr><tr><td width="5">  3 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_PrimaryKey_ComplexFeatures</a> </td><td width="40">  The function returns the characteristics of the primary key (PRIMARY KEY) of the table, as well as a list of the key attributes that make up the key. </td></tr></tbody></table><br></div></div><br><br><h3>  The function admtf_PrimaryKey_ComplexFeatures - a comprehensive list of the characteristics of the primary key of the table </h3><br>  <strong>Table 21. Result of execution of the function admtf_PrimaryKey_ComplexFeatures ('public', 'xpkstreet').</strong> <br><br><img src="https://habrastorage.org/webt/2m/jm/or/2mjmorpx-mzqp2qh__mc9qtnw0u.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  Category </th><th width="5">  No </th><th width="15">  Title </th><th width="20">  Comment </th><th width="20">  type of </th><th width="20">  Base type </th><th width="5">  ?  not NULL </th></tr><tr><td width="5">  pkl </td><td width="5">  0 </td><td width="15">  xpkstreet </td><td width="20">  Primary key table street </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  pkatt </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  pkatt </td><td width="5">  2 </td><td width="15">  localityid </td><td width="20">  ID of the settlement </td><td width="20">  localityid </td><td width="20">  integer </td><td width="5">  t </td></tr><tr><td width="5">  pkatt </td><td width="5">  3 </td><td width="15">  streetid </td><td width="20">  ID street of the village </td><td width="20">  streetid </td><td width="20">  smallint </td><td width="5">  t </td></tr></tbody></table><br></div></div><br><p>  As the required parameters, the function takes the name of the primary key ( <b>a_PrimaryKeyName</b> ) and the name of the schema within which the table is created ( <b>a_SchemaName</b> ).  The function code is a sequential invocation of two table functions. </p><br><p>  <a href="https://habr.com/ru/post/419749/">Source code can be viewed and downloaded here.</a> </p><br><a name="tfPKF_def"></a><br><p>  The first function ( <b>admtf_PrimaryKey_Features</b> ) prepares and executes a SELECT that returns the characteristics of the primary key. </p><br><br><img src="https://habrastorage.org/webt/_r/y2/fc/_ry2fce5e7ni0adm4jwaj5_561w.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> con.conname, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">'   '</span></span>|| tbl.relname) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint con <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.connamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.conrelid=tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> con.contype =<span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.conname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_PrimaryKeyName);</code> </pre> <br></div></div><br><a name="tfPKA_def"></a><br><p>  The second function ( <b>admtf_PrimaryKey_Attributes</b> ) returns the characteristics of the attributes that make up the primary key. </p><br><br><img src="https://habrastorage.org/webt/ls/3n/wi/ls3nwivnnefslizh2xbtj5azlv0.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.conrelid <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No)) ::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>, attr.attnum,attr.attname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> typ.typname::<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, FORMAT_TYPE(<span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>),typ.oid), <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typtypmod,<span class="hljs-number"><span class="hljs-number">-1</span></span>),attr.atttypmod))::<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>), attr.attnotnull <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.oid, c.conrelid,c.connamespace,c.confrelid,c.conname, c.contype, c.conkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],generate_subscripts(c.conkey, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c) con <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.connamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.attrelid=con.conrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=con.conkey[con.No] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type typ <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.atttypid=typ.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type btyp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> typ.typbasetype=btyp.oid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> con.contype =<span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.conname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_PrimaryKeyName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No;</code> </pre><br></div></div><br><p>  Here you should pay attention to the order of displaying records about the attributes of the primary key.  They are displayed in the order of description in the primary key ( <b>con.No</b> ), and not in the order of their description in the table ( <b>attr.attnum</b> ). </p><br>  Features of the connection records used by system directories are discussed in detail in the section <a href="https://habr.com/post/415897/">‚ÄúThe function <b>admtf_Table_Constraintes</b> list of database table constraints and their characteristics‚Äù</a> . <br><br><a name="tfFKCF_def"></a><br><h3>  The structure of the function that returns the list of foreign key characteristics of the table </h3><br><img src="https://habrastorage.org/webt/ez/to/eh/eztoehtxaxbepcsebh2th1pk8a8.png"><br>  <i>Fig.</i>  <i>5. Functions that admtf_ForeignKey_ComplexFeatures calls.</i> <br><br>  <strong>Table 22. Assignment of functions.</strong> <br><br><img src="https://habrastorage.org/webt/sg/uk/lx/sguklx7u5ijwcccv0rnvpemw-k8.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ ForeignKey _Features</a> </td><td width="40">  The function returns the foreign key characteristics (FOREIGN KEY) of the table. </td></tr><tr><td width="5">  2 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ ForeignKey_Attributes</a> </td><td width="40">  The function returns a list of attributes of the foreign key of the table and their characteristics. </td></tr><tr><td width="5">  3 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ForeignKey_ReferenceTableFeatures</a> </td><td width="40">  The function returns a list of characteristics of the database table referenced by the foreign key. </td></tr><tr><td width="5">  four </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ForeignKey_ReferenceTableAttributes</a> </td><td width="40">  The function returns a list of attributes of the database table referenced by the foreign key and their characteristics. </td></tr><tr><td width="5">  five </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ForeignKey_ReferenceTableComplexFeatures</a> </td><td width="40">  The function returns a complete (extended) list of characteristics of the database table referenced by the foreign key. </td></tr><tr><td width="5">  6 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_ForeignKey_ComplexFeatures</a> </td><td width="40">  The function returns the foreign key characteristics (FOREIGN KEY) of the table, as well as a list of attributes included in the index. </td></tr></tbody></table><br></div></div><br><h3>  The function admtf_ForeignKey_ComplexFeatures is a comprehensive list of foreign key characteristics of a table. </h3><br><p>  The <b>admtf_ForeignKey_ComplexFeatures</b> function returns a list of the following foreign key characteristics of a table. </p><br>  &lt;strongTable 23. The result of the function admtf_ForeignKey_ComplexFeatures ('public', 'fk_street_locality', 3). <br><br><img src="https://habrastorage.org/webt/bx/2y/4o/bx2y4o-d1_5or8ckuybb5ubgzn0.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  Category </th><th width="5">  No </th><th width="15">  Title </th><th width="20">  Comment </th><th width="20">  type of </th><th width="20">  Base type </th><th width="5">  ?  not NULL </th></tr><tr><td width="5">  fk03 </td><td width="5">  3 </td><td width="15">  fk_street_locality </td><td width="20">  Foreign key table street </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  fk03att </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  fk03att </td><td width="5">  2 </td><td width="15">  localityid </td><td width="20">  ID of the settlement </td><td width="20">  localityid </td><td width="20">  integer </td><td width="5">  t </td></tr><tr><td width="5">  fk03rtbl </td><td width="5">  0 </td><td width="15">  locality </td><td width="20">  List of locations </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  fk03ratt </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  fk03ratt </td><td width="5">  2 </td><td width="15">  localityid </td><td width="20">  ID of the settlement </td><td width="20">  localityid </td><td width="20">  integer </td><td width="5">  t </td></tr></tbody></table><br></div></div><br><p>  As parameters, the function takes the name of the foreign key ( <b>a_ ForeignKey</b> ) and the name of the scheme within which the foreign key ( <b>a_SchemaName</b> ) is created. </p><br><p>  <a href="https://habr.com/ru/post/419749/">Source code can be viewed and downloaded here.</a> </p><br><p>  The function has one more optional parameter ‚Äî the index number of the table ( <b>a_ForeignKeyNo</b> ).  This parameter is needed to add the sequence number of the foreign key of the table to the category values.  In particular, in the above example, the function was executed with the value of this parameter equal to <b>3</b> .  Therefore, an entry with foreign key characteristics is marked with the value ‚Äú <b>fk03</b> ‚Äù, entries with attribute characteristics are ‚Äú <b>fk03att</b> ‚Äù, an entry about the external table is ‚Äú <b>fk03rtbl</b> ‚Äù, and an entry about the attributes of the external table is ‚Äú <b>fk03ratt</b> ‚Äù.  If this parameter were omitted when calling the function, the category values ‚Äã‚Äãin the entries would be ‚Äú <b>fk</b> ‚Äù, ‚Äú <b>fkatt</b> ‚Äù, ‚Äú <b>fkrtbl</b> ‚Äù and ‚Äú <b>fkratt</b> ‚Äù, respectively.  For the same reason, the category value is formed inside the function <b>admtf_ForeignKey_ComplexFeatures</b> , and not in the code of the function calling it. </p><br><p>  For details, see <a href="https://habr.com/post/415575/">‚ÄúWhat are the advanced features in question?‚Äù</a> </p>  . <br><p>  Function code is a sequential call of three table functions. </p><br><a name="tfFKF_def"></a><br><p>  The first function ( <b>admtf_ForeignKey_Features</b> ) prepares and executes a SELECT that returns the characteristics of the foreign key. </p><br><br><img src="https://habrastorage.org/webt/sf/0h/7w/sf0h7wiaijixf7bc9tmgnr3ovww.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> con.conname, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">'   '</span></span>|| tbl.relname) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint con <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.connamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.conrelid=tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.contype=<span class="hljs-string"><span class="hljs-string">'f'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.conname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_ForeignKeyName);</code> </pre><br></div></div><br><a name="tfFKA_def"></a><br><p>  The second function ( <b>admtf_ForeignKey_Attributes</b> ) returns the characteristics of foreign key attributes. </p><br><p>  Here you should pay attention to the order of displaying records about foreign key attributes.  They are displayed in the order of description in the foreign key ( <b>con.No</b> ), and not in the order of their description in the table ( <b>attr.attnum</b> ). </p><br>  Features of the connection records used by the system catalogs are discussed in detail in the section <a href="https://habr.com/post/415897/">‚ÄúThe function <b>admtf_Table_Constraintes</b> - a list of limitations of the database table and their characteristics‚Äù</a> . <br><br><img src="https://habrastorage.org/webt/dt/aw/wx/dtawwxavur2bvqazvo-cvfvaqrw.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.conrelid <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No))::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_ForeingKeyNo, attr.attnum <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_AttributeNumber,attr.attname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_AttributeName, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> typ.typname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_UserTypeName, FORMAT_TYPE(<span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>),typ.oid), <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typtypmod,<span class="hljs-number"><span class="hljs-number">-1</span></span>),attr.atttypmod))::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_TypeName, attr.attnotnull <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_isNotNULL,<span class="hljs-keyword"><span class="hljs-keyword">TRIM</span></span>(dsc.description) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_Description <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.oid, c.conrelid,c.confrelid,c.conname,c.connamespace,c.contype,c.conkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],c.consrc, c.confkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],generate_subscripts(c.conkey, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c) con <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.connamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.attrelid=con.conrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=con.conkey[con.No] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type typ <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.atttypid=typ.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type btyp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> typ.typbasetype=btyp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dsc.objoid=attr.attrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=attr.attnum <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.contype =<span class="hljs-string"><span class="hljs-string">'f'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.conname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_ForeignKeyName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No;</code> </pre><br></div></div><br><p>  The third function ( <b>admtf_ForeignKey_ReferenceTableComplexFeatures</b> ) returns the characteristics of the table referenced by the foreign key.  To solve its problem, it sequentially calls two additional functions. </p><br><br><a name="tfFKRCF_def"></a><h4>  The function admtf_ForeignKey_ReferenceTableComplexFeatures is a comprehensive list of table characteristics referenced by a foreign key. </h4><br><p>  As parameters, the function takes the name of the foreign key ( <b>a_ForeignKey</b> ) and the name of the scheme within which the foreign key is created ( <b>a_SchemaName</b> ). </p><br><p>  The function has one more optional parameter ‚Äî the index number of the table ( <b>a_ForeignKeyNo</b> ).  This parameter is needed in order to replace the category number with the sequence number character <b>'%'</b> in " <b>fk% rtbl</b> " and " <b>fk% ratt</b> ", respectively. </p><br><p>  The function sequentially calls two additional functions. </p><br><a name="tfFKRF_def"></a><br><p>  The first <b>admtf_ForeignKey_ReferenceTableFeatures</b> returns directly the characteristics of the table referenced by the foreign key, and is a simplified version of the function <b>admtf_Table_Features</b> . </p><br><a name="tfFKRA_def"></a><br><p>  The second <b>admtf_ForeignKey_ReferenceTableAttributes</b> is the characteristics of the attributes of the external table that correspond to the attributes of the foreign key.  It almost completely repeats the function code <b>admtf_ForeignKey_Attributes</b> .  Only in some places, <b>con.confrelid is</b> used instead of the identifier <b>con.conrelid</b> , and <b>con.confkey is</b> used instead of the <b>con.conkey</b> <b>array</b> . </p><br><br><img src="https://habrastorage.org/webt/q3/65/pt/q365pt2qimldwrtvm2tc4hp3id8.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.confrelid <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No))::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>, attr.attnum <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_AttributeNumber,attr.attname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_AttributeName, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> typ.typname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, FORMAT_TYPE(<span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>),typ.oid), <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typtypmod,<span class="hljs-number"><span class="hljs-number">-1</span></span>),attr.atttypmod))::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, attr.attnotnull <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_isNotNULL,<span class="hljs-keyword"><span class="hljs-keyword">TRIM</span></span>(dsc.description) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r_Description <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.oid, c.conrelid,c.confrelid,c.conname,c.connamespace,c.contype, c.conkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],c.consrc,c.confkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[], generate_subscripts(c.conkey, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c) con <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> con.connamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.attrelid=con.confrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=con.confkey[con.No] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type typ <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.atttypid=typ.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type btyp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> typ.typbasetype=btyp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dsc.objoid=attr.attrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=attr.attnum <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.contype =<span class="hljs-string"><span class="hljs-string">'f'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> con.conname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_ForeignKeyName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> con.No;</code> </pre><br></div></div><br><a name="tfIndexCF_def"></a><br><h3>  The structure of the function that returns a list of table index characteristics </h3><br><img src="https://habrastorage.org/webt/qf/zc/c5/qfzcc57anv1ee-e9emxfpk3t3fq.png"><br>  <i>Fig.</i>  <i>6. Functions that admtf_Index_ComplexFeatures calls.</i> <br><br>  <strong>Table 24. Assignment of functions.</strong> <br><br><img src="https://habrastorage.org/webt/sx/xr/p_/sxxrp_sis7kad6bkaymy0sz6e6e.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_Index_Features</a> </td><td width="40">  The function returns the characteristics of the index table. </td></tr><tr><td width="5">  2 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_Index_Attributes</a> </td><td width="40">  The function returns a list of attributes of the table included in the index, and their characteristics. </td></tr><tr><td width="5">  3 </td><td width="10">  <a href="https://habr.com/ru/post/419749/">admtf_Index_ComplexFeatures</a> </td><td width="40">  The function returns the index characteristics of the table, as well as a list of attributes included in the index. </td></tr></tbody></table><br></div></div><br><h3>  The function admtf_Index_ComplexFeatures - a comprehensive list of table index characteristics </h3><br><p>  The admtf_Index_ComplexFeatures function returns a list of the following table index characteristics. </p><br><br>  <strong>Table 25. Result of execution of the function admtf_Index_ComplexFeatures ('public', 'xie9street', 7).</strong> <br><br><img src="https://habrastorage.org/webt/2m/jm/or/2mjmorpx-mzqp2qh__mc9qtnw0u.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  Category </th><th width="5">  No </th><th width="15">  Title </th><th width="5">  Order </th><th width="20">  Comment </th><th width="20">  type of </th><th width="20">  Base type </th><th width="5">  ?  not NULL </th></tr><tr><td width="5">  idx07 </td><td width="5">  7 </td><td width="15">  xie9street </td><td width="5"></td><td width="20">  Index by street name of a settlement in descending order </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  idx07att </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="5">  ASC </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  idx07att </td><td width="5">  2 </td><td width="15">  localityid </td><td width="5">  ASC </td><td width="20">  ID of the settlement </td><td width="20">  localityid </td><td width="20">  integer </td><td width="5">  t </td></tr><tr><td width="5">  idx07att </td><td width="5">  3 </td><td width="15">  streetname </td><td width="5">  Desc </td><td width="20">  Street name of the settlement </td><td width="20"></td><td width="20">  VARCHAR (150) </td><td width="5">  t </td></tr></tbody></table><br></div></div><br><p>  As parameters, the function takes the name of the index ( <b>a_ Index</b> ) and the name of the scheme within which the index is created ( <b>a_SchemaName</b> ). </p><br><p>  <a href="https://habr.com/ru/post/419749/">Source code can be viewed and downloaded here.</a> </p><br><p>  The function has one more optional parameter - the index index index number ( <b>a_IndexNo</b> ).  This parameter is needed in order to add the index number of the table to the category values.  In particular, in the above example, the function was executed with the value of this parameter equal to <b>7</b> .  Therefore, an entry with index characteristics is marked with the value ‚Äú <b>idx07</b> ‚Äù, and an entry with attribute characteristics is ‚Äú <b>idx07att</b> ‚Äù.  If this parameter were omitted when calling the function, the category values ‚Äã‚Äãin the entries would be ‚Äú <b>idx</b> ‚Äù and ‚Äú <b>idxatt</b> ‚Äù, respectively. </p><br><p>  For details, see the section <a href="https://habr.com/post/415575/">‚ÄúWhat advanced features are we talking about?‚Äù</a> .  For the same reason, the category value is formed inside the function <b>admtf_Index_ComplexFeatures</b> , and not in the code of the function calling it. </p><br><p>  The function code is a sequential invocation of two table functions. </p><br><a name="tfIndexF_def"></a><br><p>  The first function ( <b>admtf_Index_Features</b> ) prepares and executes a SELECT that returns the characteristics of the index. </p><br><br><img src="https://habrastorage.org/webt/9k/vw/jw/9kvwjwe7fitrehc4l5vbszpxjos.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> inxcls.relname, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">TRIM</span></span>(dsc.description),<span class="hljs-string"><span class="hljs-string">''</span></span>)=<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> inx.indisunique <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> inx.indisprimary <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'( )'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ||<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> inxam.amname=<span class="hljs-string"><span class="hljs-string">'gist'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ||<span class="hljs-string"><span class="hljs-string">'  '</span></span> ||tbl.relname <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> dsc.description <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_index inx <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class inxcls <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inx.indexrelid=inxcls.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inxcls.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inxcls.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_am inxam <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inxcls.relam=inxam.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inx.indrelid=tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> inxcls.relkind=<span class="hljs-string"><span class="hljs-string">'i'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nsp.nspname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> inxcls.relname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_IndexName);</code> </pre><br></div></div><br><a name="tfIndexA_def"></a><br><p>  The second function ( <b>admtf_ Index_Attributes</b> ) returns the characteristics of the attributes included in the index.  Please note that the order of the attribute records is determined by the order of their description in the index ( <b>inx.No</b> ), and not by the order of physical following in the table ( <b>attr.attnum</b> ). </p><br><br><img src="https://habrastorage.org/webt/tr/uz/7g/truz7g_xcuskbjpvogxmvto-uca.png"><br><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (inx.No+<span class="hljs-number"><span class="hljs-number">1</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,attr.attnum::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>, attr.attname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> inxam.amcanorder <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> inx.indoption[inx.No] &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'DESC'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'ASC'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> typ.typname::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, FORMAT_TYPE(<span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typbasetype,<span class="hljs-number"><span class="hljs-number">0</span></span>),typ.oid), <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(typ.typtypmod,-),attr.atttypmod))::<span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, attr.attnotnull,dsc.description <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> i.indrelid, i.indexrelid,i.indkey::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[], i.indoption::<span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[], generate_subscripts(i.indkey, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_index i) inx <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class inxcls <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inx.indexrelid=inxcls.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inxcls.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_am inxam <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inxcls.relam=inxam.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> inx.indrelid=tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.attrelid=tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=inx.indkey[inx.No] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type typ <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> attr.atttypid=typ.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_type btyp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> typ.typbasetype=btyp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dsc.objoid=attr.attrelid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=attr.attnum <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nsp.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> inxcls.relkind=<span class="hljs-string"><span class="hljs-string">'i'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> inxcls.relname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_IndexName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> nsp.nspname,inxcls.relname,inx.No;</code> </pre><br></div></div><br><p>  Features of the connection records used by system directories are discussed in detail in the section <a href="https://habr.com/post/415897/">‚ÄúThe function <b>admtf_Table_Indexes</b> list of database table indexes and their characteristics.</a> </p><br><a name="tfTableCF_def"></a><h3>  Create function admtf_Table_ComplexFeatures </h3><br><p>  The <b>admtf_Table_ComplexFeatures</b> function returns a comprehensive list of database table characteristics, which includes the characteristics returned by the functions described in the article.  As parameters, the function takes the name of the source table ( <b>a_TableName</b> ) and the name of the schema within which the table is created ( <b>a_SchemaName</b> ). </p><br><p>  <a href="https://habr.com/ru/post/419749/">Source code can be viewed and downloaded here.</a> </p><br><br>  <strong>Table 26. Result of execution of the function admtf_Table_ComplexFeatures ('public', 'street').</strong> <br><br><img src="https://habrastorage.org/webt/zj/5x/jn/zj5xjnygaeedplccbe_itjr7fpu.png"><br><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  Category </th><th width="5">  No </th><th width="15">  Title </th><th width="20">  Comment </th><th width="20">  type of </th><th width="20">  Base type </th><th width="5">  ?  not NULL </th></tr><tr><td width="5">  tbl </td><td width="5">  0 </td><td width="15">  street </td><td width="20">  List of streets in settlements </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  att </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  att </td><td width="5">  2 </td><td width="15">  localityid </td><td width="20">  ID of the settlement </td><td width="20">  localityid </td><td width="20">  integer </td><td width="5">  t </td></tr><tr><td width="5">  att </td><td width="5">  3 </td><td width="15">  streetid </td><td width="20">  ID street of the village </td><td width="20">  streetid </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  att </td><td width="5">  four </td><td width="15">  streettypeacrm </td><td width="20">  Street type acronym </td><td width="20">  streettypeacrm </td><td width="20">  character (8) </td><td width="5">  f </td></tr><tr><td width="5">  att </td><td width="5">  five </td><td width="15">  streetname </td><td width="20">  Street name </td><td width="20">  streettypeacrm </td><td width="20">  varchar (150) </td><td width="5">  t </td></tr><tr><td width="5">  pk </td><td width="5">  0 </td><td width="15">  xpkstreet </td><td width="20">  Primary key table street </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  pkatt </td><td width="5">  one </td><td width="15">  wcrccode </td><td width="20">  Country code </td><td width="20">  wcrccode </td><td width="20">  smallint </td><td width="5">  t </td></tr><tr><td width="5">  fk01 </td><td width="5">  one </td><td width="15">  fk_street_locality </td><td width="20">  Foreign key table </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  fk02 </td><td width="5">  2 </td><td width="15">  fk_street_streettype </td><td width="20">  Foreign key table </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  idx01 </td><td width="5">  one </td><td width="15">  xie1street </td><td width="20">  Index on the type and name of the street settlements </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  idx02 </td><td width="5">  2 </td><td width="15">  xie2street </td><td width="20">  Index on the name of the street settlements </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  idx03 </td><td width="5">  3 </td><td width="15">  xie3street </td><td width="20">  Index of street names of all settlements </td><td width="20"></td><td width="20"></td><td width="5"></td></tr><tr><td width="5">  idx04 </td><td width="5">  four </td><td width="15">  xpkstreet </td><td width="20">  Index unique (primary key) of the street table </td><td width="20"></td><td width="20"></td><td width="5"></td></tr></tbody></table><br></div></div><br><p>  In the course of its execution, the function sequentially calls 9 additional functions, a list of which is given in the section <a href="https://habr.com/post/415575/">‚ÄúStructure of the head function‚Äù</a> . </p><br><p>  The joint implementation of the head and additional functions results in the creation of a <a href="https://habr.com/post/415575/">table with advanced characteristics of the table</a> . </p><br><br><h3>  Where are the functions used? </h3><br><p><img src="https://habrastorage.org/webt/k_/m-/8-/k_m-8-txvg5otvfioygbkoxqiim.png" alt="left" width="200" height="100">  The functions described in the article were created in the process of preparing an application for state registration of the database.  The application procedure and the requirements for its execution are set forth in the document ‚ÄúRules for filing an application for state registration of a program for electronic computers or a database‚Äù, approved by Order No. 211 of the Ministry of Economic Development of Russia dated April 5, 2016 (hereinafter referred to as the Rules). </p><br><p>  The mandatory part of the application is the document "Materials identifying the database."  The rules interpret the contents of this document as follows. </p><blockquote>  ‚ÄúMaterials identifying the database should reflect the objective form of representing the totality of the independent materials contained in it as examples of real content and the principles of their systematization (database structure), which allow finding and processing these materials using a computer.‚Äù </blockquote><br><p>  In other words, the document should contain a description of the database structure and examples of its actual content. </p><br><br><img src="https://habrastorage.org/webt/jv/zx/7k/jvzx7kx5y_qe6rc4lzbtomutqwa.png"><br><br><p>  As can be seen from the figure, when preparing an application for database registration, it was not only the functions described in this article that were used.  Additionally, 3-4 functions were created to convert the descriptions of database tables into the <b>PlantUML</b> format. <b>More</b> precisely, these functions create code in the format of a <a href="https://trac-hacks.org/wiki/PlantUmlMacro">plug-</a> in <a href="https://habr.com/post/20309/">for the TRAC project management system</a> , so if you want <a href="https://www.planttext.com/">to check the</a> code created by these functions, do not forget to remove two lines from the top before <b>@startuml</b> and all lines below after <b>@enduml</b> . </p><br><br><div class="spoiler">  <b class="spoiler_title">PlantUML script generated by functions</b> <div class="spoiler_text"><pre> <code class="sql hljs">{{{ <span class="hljs-comment"><span class="hljs-comment">#!plantuml @startuml object public.ID_DISTRICTS{ id_np : integer NOT NULL (PK1)(FK1 id_nps(id_np)) id_district : integer NOT NULL (PK2) name_district : character varying(25) NULL type_district : character varying(25) NULL okato : character varying(11) NULL oktmo : character varying(11) NULL } object public.ID_NPS{ id_region : integer NOT NULL (FK1 id_regions(id_region)) id_atu : integer NULL (FK1 id_rayons(id_atu)) id_selsov : integer NULL (FK1 id_selsovs(id_selsov)) id_np : integer NOT NULL (PK1) name_np : character varying(25) NULL type_np : character varying(25) NULL (FK1 type_np(scname)) okato : character varying(11) NULL oktmo : character varying(11) NULL } public.ID_DISTRICTS *-- public.ID_NPS legend center &lt;b&gt;&lt;i&gt;&lt;u&gt;&lt;/u&gt;&lt;/i&gt;&lt;/b&gt; &lt;b&gt;ID_DISTRICTS&lt;/b&gt;-  -    &lt;b&gt;ID_NPS&lt;/b&gt;-  -    endlegend @enduml }}} ----</span></span></code> </pre><br></div></div><br><p>  <b>PS</b> Why aren't additional functions listed here for converting the description of database tables to the PlantUML plugin format for the TRAC project management system?  First, they did not fit into the stated topic.  Secondly, it seems, I tired the readers with the texts of functions.  But if someone is interested in these functions, then write to me and I will send their texts. </p><br><p>  <b>see also</b> <br>  <b><a href="https://habr.com/post/415575/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/415575/">Part One</a> ;</b> <br>  <b><a href="https://habr.com/post/415897/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/415897/">Part Two</a> ;</b> <br>  <b><a href="https://habr.com/post/418597/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/418597/">Part Three</a></b> <br><br><a name="Script2"></a></p><h2>  APPENDIX 1. Scripts </h2><br><a name="tfPKCF"></a><h3>  Create function admtf_PrimaryKey_ComplexFeatures </h3><br>  <a href="https://habr.com/ru/post/419749/">Comments on the source code of the function can be found here.</a> <br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><a name="tfPKF"></a><h4>  Create function admtf_PrimaryKey_Features </h4><br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_PrimaryKey_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       ,  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_PrimaryKey_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_PrimaryKeyDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_PrimaryKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'p'</span></span>; v_PrimaryKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_MasterTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************************* BEGIN SELECT INTO rs_PrimaryKeyName,rs_PrimaryKeyDescription con.conname,COALESCE(dsc.description,'   '|| tbl.relname) FROM pg_constraint con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_class tbl ON con.conrelid=tbl.oid LEFT OUTER JOIN pg_Description dsc ON con.oid=dsc.objoid AND dsc.objsubid=0 WHERE nspc.nspname=LOWER(a_SchemaName) AND con.contype =c_PrimaryKeyKind AND con.conname =LOWER(a_PrimaryKeyName); RETURN QUERY SELECT rs_PrimaryKeyName,rs_PrimaryKeyDescription; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_Features(a_SchemaName NAME,a_PrimaryKeyName NAME) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_PrimaryKey_Features (a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)); /******************************************************************************/ /*       ,  */ /*  */ /******************************************************************************/ CREATE OR REPLACE FUNCTION admtf_PrimaryKey_Features (a_SchemaName VARCHAR(256) default 'public', /*     */ a_PrimaryKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (rs_PrimaryKeyName VARCHAR(256),rs_PrimaryKeyDescription TEXT) AS $BODY$ DECLARE c_PrimaryKeyKind CONSTANT CHAR:='p'; --****************************************************************** BEGIN RETURN QUERY SELECT pkf.rs_PrimaryKeyName::VARCHAR(256), pkf.rs_PrimaryKeyDescription::TEXT FROM admtf_PrimaryKey_Features(a_SchemaName::NAME,a_PrimaryKeyName::NAME) pkf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_Features(a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_PrimaryKey_Features('public'::NAME,'xpkstreet'::NAME); SELECt * FROM admtf_PrimaryKey_Features('public'::VARCHAR(256),'xpkstreet'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><h4>  Create function admtf_PrimaryKey_Attributes </h4><br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_PrimaryKey_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*          */</span></span> <span class="hljs-comment"><span class="hljs-comment">/********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_PrimaryKey_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_PrimaryKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>, r_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,r_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_PrimaryKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'p'</span></span>; v_PrimaryKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_MasterTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_PrimaryKeyArray SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_MasterTableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_AttributeNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PKAttributeCount SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AttNo SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************** BEGIN RETURN QUERY SELECT (rank() OVER (PARTITION BY con.conrelid ORDER BY attr.attnum))::SMALLINT AS r_PrimaryKeyNo, attr.attnum AS r_AttributeNumber,attr.attname::NAME AS r_AttributeName, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::NAME ELSE ''::NAME END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1),attr.atttypmod))::NAME AS r_TypeName, attr.attnotnull AS r_isNotNULL, TRIM(dsc.description) AS r_Description FROM (SELECT c.oid, c.conrelid,c.connamespace,c.confrelid,c.conname, c.contype,c.conkey::SMALLINT[], consrc, c.confkey::SMALLINT[],generate_subscripts(c.conkey, 1) as No FROM pg_constraint c) con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_attribute attr ON attr.attrelid=con.conrelid AND attr.attnum=con.conkey[con.No] LEFT OUTER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE con.contype=c_PrimaryKeyKind AND LOWER(nspc.nspname)=LOWER(a_SchemaName) AND LOWER(con.conname)=LOWER(a_PrimaryKeyName) ORDER BY attr.attnum; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_Attributes(a_SchemaName NAME,a_PrimaryKeyName NAME) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_PrimaryKey_Attributes (a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)); /********************************************************************/ /*          */ /********************************************************************/ CREATE OR REPLACE FUNCTION admtf_PrimaryKey_Attributes (a_SchemaName VARCHAR(256) default 'public', /*     */ a_PrimaryKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (r_PrimaryKeyNo SMALLINT,r_AttributeNumber SMALLINT,r_AttributeName VARCHAR(256),r_UserTypeName VARCHAR(256),r_TypeName VARCHAR(256),r_isNotNULL BOOLEAN,r_Description TEXT) AS $BODY$ DECLARE c_PrimaryKeyKind CONSTANT CHAR:='p'; --******************************************************************* BEGIN RETURN QUERY SELECT pka.r_PrimaryKeyNo::SMALLINT,pka.r_AttributeNumber::SMALLINT, pka.r_AttributeName::VARCHAR(256),pka.r_UserTypeName::VARCHAR(256), pka.r_TypeName::VARCHAR(256),pka.r_isNotNULL::BOOLEAN, pka.r_Description::TEXT FROM admtf_PrimaryKey_Attributes(a_SchemaName::NAME,a_PrimaryKeyName::NAME) pka; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_Attributes(a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)) IS '        '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_PrimaryKey_Attributes('public'::NAME,'xpkstreet'::NAME); SELECt * FROM admtf_PrimaryKey_Attributes('public'::VARCHAR(256),'xpkstreet'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_PrimaryKey_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       ,  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ,       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_PrimaryKey_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_PrimaryKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rpk_FeatureCategory <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rpk_FeatureNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rpk_FeatureName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rpk_FeatureDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, rpk_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rpk_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rpk_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_PrimaryKeyCategory <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'pk'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_AttributeCategory CONSTANT VARCHAR(10):='pkatt'; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_PrimaryKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FeatureCategory VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*********************************************************************** BEGIN v_FeatureCategory:=c_PrimaryKeyCategory; v_FeatureNumber:=0; SELECT INTO v_PrimaryKeyName,v_PrimaryKeyDescription rs_PrimaryKeyName,rs_PrimaryKeyDescription FROM admtf_PrimaryKey_Features(a_SchemaName,a_PrimaryKeyName); IF FOUND AND v_PrimaryKeyName IS NOT NULL THEN RETURN QUERY SELECT v_FeatureCategory,v_FeatureNumber,v_PrimaryKeyName, v_PrimaryKeyDescription, NULL::NAME AS rpk_UserTypeName, NULL::NAME AS rpk_TypeName, NULL::BOOLEAN AS rpk_isNotNULL; v_FeatureCategory:=c_AttributeCategory; v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,r_PrimaryKeyNo,r_AttributeName,r_Description, r_UserTypeName,r_TypeName,r_isNotNULL FROM admtf_PrimaryKey_Attributes(a_SchemaName,a_PrimaryKeyName); END IF; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_ComplexFeatures(a_SchemaName NAME,a_PrimaryKeyName NAME) IS '     ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_PrimaryKey_ComplexFeatures (a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)); /******************************************************************************/ /*       ,  */ /* ,       */ /******************************************************************************/ CREATE OR REPLACE FUNCTION admtf_PrimaryKey_ComplexFeatures (a_SchemaName VARCHAR(256) default 'public', /*     */ a_PrimaryKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (rpk_FeatureCategory VARCHAR(10),rpk_FeatureNumber SMALLINT,rpk_FeatureName VARCHAR(256),rpk_FeatureDescription TEXT, rpk_UserTypeName VARCHAR(256),rpk_TypeName VARCHAR(256),rpk_isNotNULL BOOLEAN) AS $BODY$ DECLARE c_PrimaryKeyCategory CONSTANT VARCHAR(10):='pk'; /*   */ /*    */ --************************************************************************* BEGIN RETURN QUERY SELECT pk.rpk_FeatureCategory::VARCHAR(10), pk.rpk_FeatureNumber::SMALLINT, pk.rpk_FeatureName::VARCHAR(256),pk.rpk_FeatureDescription::TEXT, pk.rpk_UserTypeName::VARCHAR(256),pk.rpk_TypeName::VARCHAR(256), pk.rpk_isNotNULL::BOOLEAN FROM admtf_PrimaryKey_ComplexFeatures(a_SchemaName::NAME, a_PrimaryKeyName::NAME) pk; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_PrimaryKey_ComplexFeatures(a_SchemaName VARCHAR(256),a_PrimaryKeyName VARCHAR(256)) IS '     ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_PrimaryKey_ComplexFeatures('public'::NAME,'xpkstreet'::NAME); SELECt * FROM admtf_PrimaryKey_ComplexFeatures('public'::VARCHAR(256),'xpkstreet'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><a name="tfFKCF"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creating the function admtf_ForeignKey_ComplexFeatures </font></font></h3><br> <a href="https://habr.com/ru/post/419749/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comments on the source code of the function can be found here.</font></font></a> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function code</font></font></b> <div class="spoiler_text"><h4>   admtf_ForeignKey_Features </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_ForeignKeyDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_ForeignKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'f'</span></span>; v_ForeignKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_MasterTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************ BEGIN SELECT INTO rs_ForeignKeyName,rs_ForeignKeyDescription con.conname,COALESCE(dsc.description,'   '|| tbl.relname) FROM pg_constraint con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_class tbl ON con.conrelid=tbl.oid LEFT OUTER JOIN pg_Description dsc ON con.oid=dsc.objoid AND dsc.objsubid=0 WHERE nspc.nspname=LOWER(a_SchemaName) AND con.contype =c_ForeignKeyKind AND con.conname =LOWER(a_ForeignKeyName); RETURN QUERY SELECT rs_ForeignKeyName,rs_ForeignKeyDescription; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_Features(a_SchemaName NAME,a_ForeignKeyName NAME) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_Features (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)); /********************************************************************************************************/ /*       ,   */ /********************************************************************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_Features (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (rs_ForeignKeyName VARCHAR(256),rs_ForeignKeyDescription TEXT) AS $BODY$ DECLARE c_ForeignKeyKind CONSTANT CHAR:='f'; --******************************************************************* BEGIN RETURN QUERY SELECT fkf.rs_ForeignKeyName::VARCHAR(256), fkf.rs_ForeignKeyDescription::TEXT FROM admtf_ForeignKey_Features (a_SchemaName::NAME,a_ForeignKeyName::NAME) fkf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_Features(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_Features('public'::VARCHAR(256),'fk_street_locality'::VARCHAR(256)); SELECt * FROM admtf_ForeignKey_Features('public'::NAME,'fk_street_locality'::NAME);</span></span></code> </pre><br></div></div><br><h4>   admtf_ForeignKey_Attributes </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_ForeignKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,r_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_ForeignKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'f'</span></span>; <span class="hljs-comment"><span class="hljs-comment">--**************************************************************** BEGIN RETURN QUERY SELECT (rank() OVER (PARTITION BY con.conrelid ORDER BY con.No))::SMALLINT AS r_ForeingKeyNo, attr.attnum AS r_AttributeNumber,attr.attname::NAME AS r_AttributeName, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::NAME ELSE ''END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1),attr.atttypmod))::NAME AS r_TypeName, attr.attnotnull AS r_isNotNULL,TRIM(dsc.description) AS r_Description FROM (SELECT c.oid, c.conrelid,c.confrelid,c.conname,c.connamespace, c.contype,c.conkey::SMALLINT[],c.consrc, c.confkey::SMALLINT[], generate_subscripts(c.conkey, 1) as No FROM pg_constraint c) con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_attribute attr ON attr.attrelid=con.conrelid AND attr.attnum=con.conkey[con.No] INNER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE nspc.nspname=LOWER(a_SchemaName) AND con.contype =c_ForeignKeyKind AND con.conname =LOWER(a_ForeignKeyName) ORDER BY con.No; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_Attributes(a_SchemaName NAME,a_ForeignKeyName NAME) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_Attributes (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)); /**************************************************************/ /*       , */ /*   */ /**************************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_Attributes (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (r_ForeignKeyNo SMALLINT,r_AttributeNumber SMALLINT,r_AttributeName VARCHAR(256),r_UserTypeName VARCHAR(256),r_TypeName VARCHAR(256),r_isNotNULL BOOLEAN,r_Description Text) AS $BODY$ DECLARE c_ForeignKeyKind CONSTANT CHAR:='f'; --***************************************************************** BEGIN RETURN QUERY SELECT fka.r_ForeignKeyNo::SMALLINT,fka.r_AttributeNumber::SMALLINT, fka.r_AttributeName::VARCHAR(256), fka.r_UserTypeName::VARCHAR(256),fka.r_TypeName::VARCHAR(256), fka.r_isNotNULL::BOOLEAN,fka.r_Description::TEXT FROM admtf_ForeignKey_Attributes(a_SchemaName::NAME,a_ForeignKeyName::NAME) fka; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_Attributes(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_Attributes('public'::NAME,'fk_mapHouse_MapStreet'::NAME); SELECt * FROM admtf_ForeignKey_Attributes('public'::NAME,'fk_street_locality'::NAME); SELECt * FROM admtf_ForeignKey_Attributes('public'::NAME,'fk_street_streettype'::NAME); SELECt * FROM admtf_ForeignKey_Attributes('public'::VARCHAR(256),'fk_street_locality'::VARCHAR(256)); SELECt * FROM admtf_ForeignKey_Attributes('public'::VARCHAR(256),'fk_street_streettype'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><h3>   admtf_ForeignKey_ReferenceTableComplexFeatures </h3><br> <a href="https://habr.com/ru/post/419749/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><h4>   admtf_ForeignKey_ReferenceTableFeatures </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_ReferenceTableFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*******************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_ReferenceTableFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rfkrt_ReferenceTableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rfkrt_ReferenceTableDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_ForeignKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'f'</span></span>; v_ReferenceTableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> v_ReferenceTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_ReferenceTableDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/* ,      */</span></span> v_MasterTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************************* BEGIN SELECT INTO v_ReferenceTableName rtbl.relname FROM pg_constraint con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_class rtbl ON con.confrelid=rtbl.oid WHERE nspc.nspname=LOWER(a_SchemaName) AND con.contype =c_ForeignKeyKind AND con.conname =LOWER(a_ForeignKeyName); IF FOUND THEN RETURN QUERY SELECT rs_TableName,rs_TableDescription FROM admtf_Table_Features(a_SchemaName,v_ReferenceTableName); END IF; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableFeatures(a_SchemaName NAME,a_ForeignKeyName NAME) IS '   ,     '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_ReferenceTableFeatures (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)); /*******************************************************************/ /*     ,    */ /*   */ /******************************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_ReferenceTableFeatures (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (rfkrt_ReferenceTableName VARCHAR(256),rfkrt_ReferenceTableDescription TEXT) AS $BODY$ DECLARE c_ForeignKeyKind CONSTANT CHAR:='f'; --********************************************************************* BEGIN RETURN QUERY SELECT fkrt.rfkrt_ReferenceTableName::VARCHAR(256), fkrt.rfkrt_ReferenceTableDescription::TEXT FROM admtf_ForeignKey_ReferenceTableFeatures(a_SchemaName::NAME, a_ForeignKeyName::NAME) fkrt; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableFeatures(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)) IS '   ,     '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_ReferenceTableFeatures('public'::VARCHAR(256),'fk_street_locality'::VARCHAR(256)); SELECt * FROM admtf_ForeignKey_ReferenceTableFeatures('public'::NAME,'fk_street_locality'::NAME);</span></span></code> </pre><br></div></div><br><h4>   admtf_ForeignKey_ReferenceTableAttributes </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_ReferenceTableAttributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_ReferenceTableAttributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(r_ReferenceTableKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,r_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_ForeignKeyKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'f'</span></span>; v_ForeignKeyName NAME;<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyDescription TEXT;<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ReferenceTableKeyArray SMALLINT[];<span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_ReferenceTableName NAME;<span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> v_ReferenceTableDescription TEXT;<span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> v_ReferenceTableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_AttributeNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeCount INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AttNo SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--****************************************************************************************************** BEGIN RETURN QUERY SELECT (rank() OVER (PARTITION BY con.confrelid ORDER BY con.No))::SMALLINT AS r_ReferenceTableKeyNo, attr.attnum AS r_AttributeNumber,attr.attname::NAME AS r_AttributeName, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::NAME ELSE ''END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1), attr.atttypmod))::NAME AS r_TypeName, attr.attnotnull AS r_isNotNULL,TRIM(dsc.description) AS r_Description FROM (SELECT c.oid, c.conrelid,c.confrelid,c.conname,c.connamespace,c.contype, c.conkey::SMALLINT[],c.consrc, c.confkey::SMALLINT[], generate_subscripts(c.conkey, 1) as No FROM pg_constraint c) con INNER JOIN pg_namespace nspc ON con.connamespace = nspc.oid INNER JOIN pg_attribute attr ON attr.attrelid=con.confrelid AND attr.attnum=con.confkey[con.No] INNER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE nspc.nspname=LOWER(a_SchemaName) AND con.contype =c_ForeignKeyKind AND con.conname =LOWER(a_ForeignKeyName) ORDER BY con.No; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableAttributes(a_SchemaName NAME,a_ForeignKeyName NAME) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_ReferenceTableAttributes (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)); /*********************************************************/ /*      , */ /*      */ /********************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_ReferenceTableAttributes (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL /*     */ ) RETURNS TABLE (r_ReferenceTableKeyNo SMALLINT,r_AttributeNumber SMALLINT,r_AttributeName VARCHAR(256),r_UserTypeName VARCHAR(256),r_TypeName VARCHAR(256),r_isNotNULL BOOLEAN,r_Description TEXT) AS $BODY$ DECLARE c_ForeignKeyKind CONSTANT CHAR:='f'; --**************************************************************** BEGIN RETURN QUERY SELECT fkra.r_ReferenceTableKeyNo::SMALLINT, fkra.r_AttributeNumber::SMALLINT,fkra.r_AttributeName::VARCHAR(256), fkra.r_UserTypeName::VARCHAR(256),fkra.r_TypeName::VARCHAR(256), fkra.r_isNotNULL::BOOLEAN,fkra.r_Description::TEXT FROM admtf_ForeignKey_ReferenceTableAttributes(a_SchemaName::NAME, a_ForeignKeyName::NAME) fkra; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableAttributes(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256)) IS '     ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_ReferenceTableAttributes('public'::VARCHAR(256),'fk_street_locality'::VARCHAR(256)); SELECt * FROM admtf_ForeignKey_ReferenceTableAttributes('public'::NAME,'fk_street_locality'::NAME);</span></span></code> </pre><br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_ReferenceTableComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_ReferenceTableComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (fkrt_FeatureCategory <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),fkrt_FeatureNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,fkrt_FeatureName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,fkrt_FeatureDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>,fkrt_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,fkrt_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,fkrt_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>):=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_ForeignKeyCategory CONSTANT VARCHAR(10):='fk'||c_WildChar||'rtbl'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> c_AttributeCategory CONSTANT VARCHAR(10):='fk'||c_WildChar||'ratt'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,      */</span></span> v_ForeignKeyCharNo VARCHAR(2); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FeatureCategory VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************* BEGIN v_ForeignKeyCharNo:=COALESCE(TRIM(TO_CHAR(a_ForeignKeyNo,'09')),''); v_FeatureCategory:=REPLACE(c_ForeignKeyCategory,c_WildChar, v_ForeignKeyCharNo); v_FeatureNumber:=0; SELECT INTO v_ForeignKeyName,v_ForeignKeyDescription rfkrt_ReferenceTableName,rfkrt_ReferenceTableDescription FROM admtf_ForeignKey_ReferenceTableFeatures(a_SchemaName,a_ForeignKeyName); IF FOUND AND v_ForeignKeyName IS NOT NULL THEN RETURN QUERY SELECT v_FeatureCategory,v_FeatureNumber,v_ForeignKeyName, v_ForeignKeyDescription,NULL::NAME AS fkrt_UserTypeName, NULL::NAME AS fkrt_TypeName, NULL::BOOLEAN AS fkrt_isNotNULL ; END IF; v_FeatureCategory:=REPLACE(c_AttributeCategory,c_WildChar, v_ForeignKeyCharNo); v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,r_ReferenceTableKeyNo,r_AttributeName, r_Description,r_UserTypeName,r_TypeName,r_isNotNULL FROM admtf_ForeignKey_ReferenceTableAttributes(a_SchemaName,a_ForeignKeyName); END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableComplexFeatures(a_SchemaName NAME,a_ForeignKeyName NAME,a_ForeignKeyNo SMALLINT) IS '   ,    ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_ReferenceTableComplexFeatures (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256),a_ForeignKeyNo SMALLINT); /*************************************************************/ /*     ,  */ /*   ,       */ /*************************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_ReferenceTableComplexFeatures (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL,/*     */ a_ForeignKeyNo SMALLINT default NULL /*     */ ) RETURNS TABLE (fkrt_FeatureCategory VARCHAR(10),fkrt_FeatureNumber SMALLINT,fkrt_FeatureName VARCHAR(256),fkrt_FeatureDescription TEXT, fkrt_UserTypeName VARCHAR(256),fkrt_TypeName VARCHAR(256),fkrt_isNotNULL BOOLEAN) AS $BODY$ DECLARE c_WildChar CONSTANT VARCHAR(1):='%';/*   */ /*    */ --****************************************************************** BEGIN RETURN QUERY SELECT fkrt.fkrt_FeatureCategory::VARCHAR(10), fkrt.fkrt_FeatureNumber::SMALLINT, fkrt.fkrt_FeatureName::VARCHAR(256),fkrt.fkrt_FeatureDescription::TEXT, fkrt.fkrt_UserTypeName::VARCHAR(256), fkrt.fkrt_TypeName::VARCHAR(256),fkrt.fkrt_isNotNULL::BOOLEAN FROM admtf_ForeignKey_ReferenceTableComplexFeatures(a_SchemaName::NAME, a_ForeignKeyName::NAME,a_ForeignKeyNo::SMALLINT ) fkrt; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ReferenceTableComplexFeatures(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256),a_ForeignKeyNo SMALLINT) IS '   ,    ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_ReferenceTableComplexFeatures('public'::NAME,'fk_street_locality'::NAME); SELECt * FROM admtf_ForeignKey_ReferenceTableComplexFeatures('public'::NAME,'fk_street_locality'::NAME,10::SMALLINT); SELECt * FROM admtf_ForeignKey_ReferenceTableComplexFeatures('public'::VARCHAR(256),'fk_street_locality'::VARCHAR(256),10::SMALLINT);</span></span></code> </pre><br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_ForeignKey_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_ForeignKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/**************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_ForeignKey_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ForeignKeyNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rfk_FeatureCategory <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rfk_FeatureNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rfk_FeatureName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rfk_FeatureDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, rfk_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rfk_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rfk_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>):=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_ForeignKeyCategory CONSTANT VARCHAR(10):='fk'||c_WildChar; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_AttributeCategory CONSTANT VARCHAR(10):='fk'||c_WildChar||'att'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyOID OID; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyCharNo VARCHAR(2); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FeatureCategory VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************ BEGIN v_ForeignKeyCharNo:=COALESCE(TRIM(TO_CHAR(a_ForeignKeyNo,'09')),''); v_FeatureCategory:=REPLACE(c_ForeignKeyCategory,c_WildChar, v_ForeignKeyCharNo); v_FeatureNumber:=0; SELECT INTO v_ForeignKeyName,v_ForeignKeyDescription rs_ForeignKeyName,rs_ForeignKeyDescription FROM admtf_ForeignKey_Features(a_SchemaName,a_ForeignKeyName); IF FOUND AND v_ForeignKeyName IS NOT NULL THEN RETURN QUERY SELECT v_FeatureCategory,COALESCE(a_ForeignKeyNo,v_FeatureNumber), v_ForeignKeyName,v_ForeignKeyDescription, NULL::NAME AS rfk_UserTypeName, NULL::NAME AS rfk_TypeName, NULL::BOOLEAN AS rfk_isNotNULL; END IF; v_FeatureCategory:=REPLACE(c_AttributeCategory,c_WildChar, v_ForeignKeyCharNo); v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,r_ForeignKeyNo,r_AttributeName,r_Description, r_UserTypeName,r_TypeName,r_isNotNULL FROM admtf_ForeignKey_Attributes(a_SchemaName,a_ForeignKeyName); RETURN QUERY SELECT fkrt_FeatureCategory,fkrt_FeatureNumber,fkrt_FeatureName, fkrt_FeatureDescription,fkrt_UserTypeName,fkrt_TypeName, fkrt_isNotNULL AS rfk_isNotNULL FROM admtf_ForeignKey_ReferenceTableComplexFeatures(a_SchemaName, a_ForeignKeyName,a_ForeignKeyNo); END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ComplexFeatures(a_SchemaName NAME,a_ForeignKeyName NAME,a_ForeignKeyNo SMALLINT) IS '     ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_ForeignKey_ComplexFeatures (a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256),a_ForeignKeyNo SMALLINT); /**************************************************************/ /*       , */ /*  ,       */ /**************************************************************/ CREATE OR REPLACE FUNCTION admtf_ForeignKey_ComplexFeatures (a_SchemaName VARCHAR(256) default 'public', /*     */ a_ForeignKeyName VARCHAR(256) default NULL, /*     */ a_ForeignKeyNo SMALLINT default NULL /*     */ ) RETURNS TABLE (rfk_FeatureCategory VARCHAR(10),rfk_FeatureNumber SMALLINT,rfk_FeatureName VARCHAR(256),rfk_FeatureDescription TEXT, rfk_UserTypeName VARCHAR(256),rfk_TypeName VARCHAR(256),rfk_isNotNULL BOOLEAN) AS $BODY$ DECLARE c_WildChar CONSTANT VARCHAR(1):='%'; --******************************************************************** BEGIN RETURN QUERY SELECT fkcf.rfk_FeatureCategory::VARCHAR(10), fkcf.rfk_FeatureNumber::SMALLINT, fkcf.rfk_FeatureName::VARCHAR(256),fkcf.rfk_FeatureDescription::TEXT, fkcf.rfk_UserTypeName::VARCHAR(256),fkcf.rfk_TypeName::VARCHAR(256), fkcf.rfk_isNotNULL::BOOLEAN FROM admtf_ForeignKey_ComplexFeatures(a_SchemaName::NAME, a_ForeignKeyName::NAME,a_ForeignKeyNo::SMALLINT) fkcf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_ForeignKey_ComplexFeatures(a_SchemaName VARCHAR(256),a_ForeignKeyName VARCHAR(256),a_ForeignKeyNo SMALLINT) IS '     ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_ForeignKey_ComplexFeatures('public'::NAME,'fk_street_locality'::NAME); SELECt * FROM admtf_ForeignKey_ComplexFeatures('public'::NAME,'fk_street_locality'::NAME,1::SMALLINT); SELECt * FROM admtf_ForeignKey_ComplexFeatures('public'::VARCHAR,'fk_street_locality'::VARCHAR,3::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfIndexCF"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creating function admtf_Index_ComplexFeatures </font></font></h3><br> <a href="https://habr.com/ru/post/419749/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comments on the source code of the function can be found here.</font></font></a> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function code</font></font></b> <div class="spoiler_text"><h4>   admtf_Index_Features </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Index_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*******************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*******************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Index_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_IndexDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_IndexKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'i'</span></span>; v_IndexOID OID; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*************************************************** BEGIN SELECT INTO rs_IndexName,rs_IndexDescription inxcls.relname, CASE WHEN COALESCE(TRIM(dsc.description),'')='' THEN '' || CASE WHEN inx.indisunique THEN ' ' || CASE WHEN inx.indisprimary THEN '( )' ELSE '' END ELSE '' END || CASE WHEN inxam.amname='gist' THEN ' ' ELSE '' END || '  '||tbl.relname ELSE dsc.description END FROM pg_index inx INNER JOIN pg_class inxcls ON inx.indexrelid=inxcls.oid INNER JOIN pg_namespace nsp ON inxcls.relnamespace=nsp.oid LEFT OUTER JOIN pg_Description dsc ON inxcls.oid=dsc.objoid AND dsc.objsubid=0 LEFT OUTER JOIN pg_am inxam ON inxcls.relam=inxam.oid LEFT OUTER JOIN pg_class tbl ON inx.indrelid=tbl.oid WHERE nsp.nspname=LOWER(a_SchemaName) AND inxcls.relkind=c_IndexKind AND inxcls.relname =LOWER(a_IndexName); RETURN QUERY SELECT rs_IndexName,rs_IndexDescription; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_Features(a_SchemaName NAME,a_IndexName NAME) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Index_Features (a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256)); /*******************************************************/ /*      , */ /*   */ /*******************************************************/ CREATE OR REPLACE FUNCTION admtf_Index_Features (a_SchemaName VARCHAR(256) default 'public', /*     */ a_IndexName VARCHAR(256) default NULL /*    */ ) RETURNS TABLE (rs_IndexName VARCHAR(256),rs_IndexDescription TEXT) AS $BODY$ DECLARE c_IndexKind CONSTANT CHAR:='i'; --*********************************************************** BEGIN RETURN QUERY SELECT ixf.rs_IndexName::VARCHAR(256), ixf.rs_IndexDescription::TEXT FROM admtf_Index_Features(a_SchemaName::NAME,a_IndexName::NAME) ixf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_Features(a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256)) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_Index_Features('public'::NAME,'xie1street'::NAME); SELECt * FROM admtf_Index_Features('public'::VARCHAR(256),'xie1street'::VARCHAR(256)); SELECt * FROM admtf_Index_Features('public'::VARCHAR(256),'xie9street'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><h4>   admtf_Index_Attributes </h4><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Index_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*******************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*******************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Index_Attributes (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_IndexNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_OrderDirect <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>), r_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,r_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cursor_IndexNoOfAttribute refcursor; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_IndexKind CONSTANT CHAR:='i'; v_IndexOID OID; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_MasterTableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  ,    */</span></span> v_IndexArray SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_IndexKeyOps SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AmCanOrder BOOLEAN; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ?*/</span></span> v_MasterTableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*  ,    */</span></span> v_AttributeNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_AttributeOrderCode INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_IndexAttributeCount INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_AttNo SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************* BEGIN RETURN QUERY SELECT (inx.No+1)::SMALLINT AS r_IndexNo, attr.attnum::SMALLINT AS r_AttributeNumber, attr.attname::NAME AS r_AttributeName, CASE WHEN NOT inxam.amcanorder THEN NULL ELSE CASE WHEN inx.indoption[inx.No] &amp; 1=1 THEN 'DESC' ELSE 'ASC' END END::VARCHAR(10) AS r_OrderDirect, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::NAME ELSE ''END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1), attr.atttypmod))::NAME AS r_TypeName, attr.attnotnull AS r_isNotNULL, dsc.description AS r_Description FROM (SELECT i.indrelid, i.indexrelid,i.indkey::SMALLINT[], i.indoption::SMALLINT[], generate_subscripts(i.indkey, 1) as No FROM pg_index i) inx INNER JOIN pg_class inxcls ON inx.indexrelid=inxcls.oid INNER JOIN pg_namespace nsp ON inxcls.relnamespace=nsp.oid LEFT OUTER JOIN pg_am inxam ON inxcls.relam=inxam.oid LEFT OUTER JOIN pg_class tbl ON inx.indrelid=tbl.oid INNER JOIN pg_attribute attr ON attr.attrelid=tbl.oid AND attr.attnum=inx.indkey[inx.No] LEFT OUTER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE nsp.nspname=LOWER(a_SchemaName) AND inxcls.relkind=c_IndexKind AND inxcls.relname =LOWER(a_IndexName) ORDER BY nsp.nspname,inxcls.relname,inx.No; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_Attributes(a_SchemaName NAME,a_IndexName NAME) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Index_Attributes (a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256)); /*******************************************************/ /*      , */ /*   */ /******************************************************/ CREATE OR REPLACE FUNCTION admtf_Index_Attributes (a_SchemaName VARCHAR(256) default 'public', /*     */ a_IndexName VARCHAR(256) default NULL /*    */ ) RETURNS TABLE (r_IndexNo SMALLINT,r_AttributeNumber SMALLINT,r_AttributeName VARCHAR(256),r_OrderDirect VARCHAR(10),r_UserTypeName VARCHAR(256),r_TypeName VARCHAR(256),r_isNotNULL BOOLEAN,r_Description Text) AS $BODY$ DECLARE c_IndexKind CONSTANT CHAR:='i'; --******************************************************************* BEGIN RETURN QUERY SELECT ia.r_IndexNo::SMALLINT, ia.r_AttributeNumber::SMALLINT, ia.r_AttributeName::VARCHAR(256), ia.r_OrderDirect::VARCHAR(10), ia.r_UserTypeName::VARCHAR(256), ia.r_TypeName::VARCHAR(256), ia.r_isNotNULL::BOOLEAN, ia.r_Description::TEXT FROM admtf_Index_Attributes(a_SchemaName::NAME,a_IndexName::NAME) ia; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_Attributes(a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256)) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt * FROM admtf_Index_Attributes('public'::NAME,'xie1street'::NAME); SELECt * FROM admtf_Index_Attributes('public'::VARCHAR(256),'xie1street'::VARCHAR(256)); SELECt * FROM admtf_Index_Attributes('public'::VARCHAR(256),'xie9street'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Index_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_IndexNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Index_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_IndexName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> a_IndexNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rix_FeatureCategory <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rix_FeatureNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rix_FeatureName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rix_OrderDirect <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>), rix_FeatureDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, rix_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rix_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rix_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>):=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_IndexCategory CONSTANT VARCHAR(10):='idx'||c_WildChar;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_AttributeCategory CONSTANT VARCHAR(10):='idx'||c_WildChar||'att';<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_IndexOID OID; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexCharNo VARCHAR(2); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureCategory VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*************************************************************************** BEGIN v_IndexCharNo:=COALESCE(TRIM(TO_CHAR(a_IndexNo,'09')),''); v_FeatureCategory:=REPLACE(c_IndexCategory,c_WildChar, v_IndexCharNo); v_FeatureNumber:=0; SELECT INTO v_IndexName,v_IndexDescription rs_IndexName,rs_IndexDescription FROM admtf_Index_Features(a_SchemaName,a_IndexName); IF FOUND AND v_IndexName IS NOT NULL THEN RETURN QUERY SELECT v_FeatureCategory, COALESCE(a_IndexNo,v_FeatureNumber), v_IndexName,NULL::VARCHAR(10), v_IndexDescription, NULL::NAME AS rix_UserTypeName, NULL::NAME AS rix_TypeName, NULL::BOOLEAN AS rix_isNotNULL; END IF; v_FeatureCategory:=REPLACE(c_AttributeCategory,c_WildChar, v_IndexCharNo); v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,r_IndexNo, r_AttributeName,r_OrderDirect,r_Description, r_UserTypeName,r_TypeName,r_isNotNULL FROM admtf_Index_Attributes(a_SchemaName,a_IndexName); RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_ComplexFeatures(a_SchemaName NAME,a_IndexName NAME,a_IndexNo SMALLINT) IS '    ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Index_ComplexFeatures (a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256),a_IndexNo SMALLINT); /************************************************************/ /*      , */ /*  ,       */ /************************************************************************************************************************/ CREATE OR REPLACE FUNCTION admtf_Index_ComplexFeatures (a_SchemaName VARCHAR(256) default 'public', /*     */ a_IndexName VARCHAR(256) default NULL, /*    */ a_IndexNo SMALLINT default NULL /*    */ ) RETURNS TABLE (rix_FeatureCategory VARCHAR(10),rix_FeatureNumber SMALLINT, rix_FeatureName VARCHAR(256),rix_OrderDirect VARCHAR(10),rix_FeatureDescription TEXT, rix_UserTypeName VARCHAR(256),rix_TypeName VARCHAR(256),rix_isNotNULL BOOLEAN) AS $BODY$ DECLARE c_WildChar CONSTANT VARCHAR(1):='%'; --******************************************************************** BEGIN RETURN QUERY SELECT icf.rix_FeatureCategory::VARCHAR(10), icf.rix_FeatureNumber::SMALLINT, icf.rix_FeatureName::VARCHAR(256), icf.rix_OrderDirect::VARCHAR(10), icf.rix_FeatureDescription::TEXT, icf.rix_UserTypeName::VARCHAR(256), icf.rix_TypeName::VARCHAR(256), icf.rix_isNotNULL::BOOLEAN FROM admtf_Index_ComplexFeatures(a_SchemaName::NAME, a_IndexName::NAME,a_IndexNo::SMALLINT) icf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Index_ComplexFeatures(a_SchemaName VARCHAR(256),a_IndexName VARCHAR(256),a_IndexNo SMALLINT) IS '    ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Index_ComplexFeatures('public'::NAME,'xie1street'::NAME,7::SMALLINT); SELECT * FROM admtf_Index_ComplexFeatures('public'::VARCHAR(256),'xie1street'::VARCHAR(256),7::SMALLINT); SELECT * FROM admtf_Index_ComplexFeatures('public'::VARCHAR(256),'xie9street'::VARCHAR(256),7::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfTableCF"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create function admtf_Table_ComplexFeatures </font></font></h3><br> <a href="https://habr.com/ru/post/419749/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comments on the source code of the function can be found here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as well as in the first part of the article in the sections </font></font><a href="https://habr.com/post/415575/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Structure of the head function"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://habr.com/post/415575/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"What advanced characteristics are we talking about?"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function code</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_ComplexFeatures (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rr_FeatureCategory <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>),rr_FeatureNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rr_FeatureName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rr_FeatureDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>,rr_UserTypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rr_TypeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rr_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cursor_ForeignKeys refcursor; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> cursor_Indexes refcursor; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_WildChar CONSTANT VARCHAR(1):='%'; c_TableCategory CONSTANT VARCHAR(10):='tbl'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_SequenceCategory CONSTANT VARCHAR(10):='seq'||c_WildChar; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_InheritanceTableCategory CONSTANT VARCHAR(10):='inhtbl'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_AttributeCategory CONSTANT VARCHAR(10):='att'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_PrimaryKeyCategory CONSTANT VARCHAR(10):='pk'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_ForeignKeyCategory CONSTANT VARCHAR(10):='fk'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_IndexCategory CONSTANT VARCHAR(10):='idx'; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_PrimaryKeyKind CONSTANT CHAR:='p'; c_ForeignKeyKind CONSTANT CHAR:='f'; v_TableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_FeatureCategory VARCHAR(12); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_FeatureNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PrimaryKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ForeignKeyName NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKeyCount INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_IndexCount INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************************* BEGIN v_FeatureCategory:=c_TableCategory; v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,v_FeatureNumber,rs_TableName, rs_TableDescription,NULL::NAME AS rr_UserTypeName, NULL::NAME AS rr_TypeName,NULL::BOOLEAN AS rr_isNotNULL FROM admtf_Table_Features(a_SchemaName,a_TableName); v_FeatureCategory:=c_AttributeCategory; v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,r_AttributeNumber,r_AttributeName,r_Description, r_UserTypeName,r_TypeName,r_isNotNULL FROM admtf_Table_Attributes(a_SchemaName,a_TableName); v_FeatureCategory:=c_SequenceCategory; v_FeatureNumber:=0; RETURN QUERY SELECT REPLACE(c_SequenceCategory,c_WildChar, COALESCE(TRIM(TO_CHAR(r_SequenceNumber,'09')),'')):: VARCHAR(12) AS rr_FeatureCategory, r_SequenceNumber,r_SequenceName,r_SequenceDescription, NULL::NAME AS rr_UserTypeName, NULL::NAME AS rr_TypeName, NULL::BOOLEAN AS rr_isNotNULL FROM admtf_Table_Sequences(a_SchemaName,a_TableName); v_FeatureCategory:=c_PrimaryKeyCategory; v_FeatureNumber:=0; SELECT INTO v_PrimaryKeyName r_ConstraintName FROM admtf_Table_Constraintes(a_SchemaName,a_TableName) WHERE r_ConstraintType=c_PrimaryKeyKind; IF FOUND THEN RETURN QUERY SELECT rpk_FeatureCategory ,rpk_FeatureNumber, rpk_FeatureName,rpk_FeatureDescription,rpk_UserTypeName, rpk_TypeName, rpk_isNotNULL FROM admtf_PrimaryKey_ComplexFeatures(a_SchemaName,v_PrimaryKeyName); END IF; OPEN cursor_ForeignKeys FOR SELECT r_ConstraintName FROM admtf_Table_Constraintes(a_SchemaName,a_TableName) WHERE r_ConstraintType=c_ForeignKeyKind ORDER BY r_ConstraintName; v_FeatureCategory:=c_ForeignKeyCategory; v_FKeyCount:=0; FETCH FIRST FROM cursor_ForeignKeys INTO v_ForeignKeyName; WHILE FOUND LOOP v_FKeyCount:=v_FKeyCount+1; RETURN QUERY SELECT rfk_FeatureCategory , CASE WHEN rfk_FeatureCategory = c_ForeignKeyCategory THEN v_FKeyCount::SMALLINT ELSE rfk_FeatureNumber END, rfk_FeatureName,rfk_FeatureDescription, rfk_UserTypeName,rfk_TypeName, rfk_isNotNULL FROM admtf_ForeignKey_ComplexFeatures(a_SchemaName, v_ForeignKeyName,v_FKeyCount::SMALLINT); FETCH NEXT FROM cursor_ForeignKeys INTO v_ForeignKeyName; END LOOP; CLOSE cursor_ForeignKeys ; OPEN cursor_Indexes FOR SELECT r_IndexName FROM admtf_Table_Indexes(a_SchemaName,a_TableName) ORDER BY r_IndexName ; v_FeatureCategory:=c_IndexCategory; v_IndexCount:=0; FETCH FIRST FROM cursor_Indexes INTO v_IndexName; WHILE FOUND LOOP v_IndexCount:=v_IndexCount+1; RETURN QUERY SELECT rix_FeatureCategory , CASE WHEN rix_FeatureCategory = c_IndexCategory THEN v_IndexCount::SMALLINT ELSE rix_FeatureNumber END, rix_FeatureName,rix_FeatureDescription, rix_UserTypeName,rix_TypeName, rix_isNotNULL FROM admtf_Index_ComplexFeatures(a_SchemaName,v_IndexName, v_IndexCount::SMALLINT); FETCH NEXT FROM cursor_Indexes INTO v_IndexName; END LOOP; CLOSE cursor_Indexes ; v_FeatureCategory:=c_InheritanceTableCategory; v_FeatureNumber:=0; RETURN QUERY SELECT v_FeatureCategory,RANK() OVER(PARTITION BY v_FeatureCategory ORDER BY rs_TableName )::SMALLINT, rs_TableName,rs_TableDescription, NULL::NAME AS rr_UserTypeName, NULL::NAME AS rr_TypeName, NULL::BOOLEAN rr_isNotNULL FROM admtf_Table_InheritanceChildrens(a_SchemaName,a_TableName); END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_ComplexFeatures(a_SchemaName NAME,a_TableName NAME) IS '   ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_ComplexFeatures (a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)); /********************************************************************/ /*     ,  , */ /*       */ /*******************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_ComplexFeatures (a_SchemaName VARCHAR(256) default 'public',/*    */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (rr_FeatureCategory VARCHAR(12),rr_FeatureNumber SMALLINT,rr_FeatureName VARCHAR(256),rr_FeatureDescription TEXT, rr_UserTypeName VARCHAR(256),rr_TypeName VARCHAR(256),rr_isNotNULL BOOLEAN) AS $BODY$ DECLARE c_TableCategory CONSTANT VARCHAR(10):='tbl'; /*  */ /*   */ --*********************************************************** BEGIN RETURN QUERY SELECT tcf.rr_FeatureCategory::VARCHAR(12), tcf.rr_FeatureNumber::SMALLINT, tcf.rr_FeatureName::VARCHAR(256), tcf.rr_FeatureDescription::TEXT, tcf.rr_UserTypeName::VARCHAR(256), tcf.rr_TypeName::VARCHAR(256), tcf.rr_isNotNULL::BOOLEAN FROM admtf_Table_ComplexFeatures(a_SchemaName::NAME,a_TableName::NAME) tcf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_ComplexFeatures(a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)) IS '   ,  ,      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_ComplexFeatures('public'::NAME,'Street'::NAME);</span></span></code> </pre><br></div></div><br><p>  <b>see also</b> <br> <b><a href="https://habr.com/post/415575/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Functions for documenting PostgreSQL databases. </font><font style="vertical-align: inherit;">Part One</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font></font></b> <br> <b><a href="https://habr.com/post/415897/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Functions for documenting PostgreSQL databases. </font><font style="vertical-align: inherit;">Part Two</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font></font></b> <br> <b><a href="https://habr.com/post/418597/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Functions for documenting PostgreSQL databases. </font><font style="vertical-align: inherit;">Part Three</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></b> </p></div><p>Source: <a href="https://habr.com/ru/post/419749/">https://habr.com/ru/post/419749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419733/index.html">Git happens! 6 typical git errors and how to fix them</a></li>
<li><a href="../419735/index.html">I / Q Signal Study with SDR using Adobe Audition</a></li>
<li><a href="../419743/index.html">What's wrong with popular articles telling that foo is faster than bar?</a></li>
<li><a href="../419745/index.html">ClassicAI genre: ML is looking for himself in poetry</a></li>
<li><a href="../419747/index.html">DJI Ronin S - the first start and the main functions</a></li>
<li><a href="../419751/index.html">Design trends in 2018: forecast and reality</a></li>
<li><a href="../419753/index.html">10 fastest supercomputers in the world 2018</a></li>
<li><a href="../419757/index.html">Translation of Andrew Un‚Äôs Passion for Machine Learning, Chapter 1-14</a></li>
<li><a href="../419759/index.html">Internal DSL & Expression Trees - dynamic creation of serialize, copy, clone, equals functions (Part I)</a></li>
<li><a href="../419761/index.html">Create a 2D game in Python with the library Arcade</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>