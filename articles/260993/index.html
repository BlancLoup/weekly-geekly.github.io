<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving sparse SLAEs of large dimensions using ManagedCuda in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, in applied mathematical and computer models there is a need to solve systems of linear algebraic equations ( SLAE ). As a rule, in practice, th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving sparse SLAEs of large dimensions using ManagedCuda in .NET</h1><div class="post__text post__text-html js-mediator-article">  Often, in applied mathematical and computer models there is a need to solve systems of linear algebraic equations ( <b>SLAE</b> ).  As a rule, in practice, the matrix in such SLAEs is sparse.  For example, sparse matrices are found in models with finite difference or finite element methods for solving differential equations.  Highly sparse matrices of large dimension arise in the simulation of material and information flows in large technological networks (gas supply and gas distribution systems, sewer and heat supply systems, power grids and computer networks, etc.).  Common to technological networks is the representation of their models in the form of a graph, in which the incidence matrix is ‚Äã‚Äãalmost always highly sparse. <br><br>  The article will describe how your humble servant significantly increased the efficiency of the computer model for calculating unsteady gas flows in large gas supply systems of arbitrary configuration, thanks to the use of the ManagedCuda library and nVidia CUDA 7.0.  However, the presentation will be conducted without reference to a specific subject area. <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  The classical problem of solving SLAEs is considered: <br>  <b>Ax = b</b> <br>  Here the matrix <b>A of</b> size <b><i>n</i></b> x <b><i>n</i></b> , <b>x</b> is the vector of unknowns of size <b><i>n</i></b> , <b>b</b> is the vector of known free members of size <b><i>n</i></b> . <br><br>  The author of the article is engaged in the development of a specialized software and computing complex ( <b>PVK</b> ) for modeling and optimization of non-stationary gas flows in gas supply systems.  In the problems I solve, <b>A</b> is a positive definite Jacobian with a diagonal predominance of a certain system of nonlinear equations.  <b>A is</b> obtained as a result of matrix transformations of the matrix of incidents of the graph of the gas supply system and other matrices.  In my practical calculations, <b>A is</b> usually filled by 6-10%, the rest is zero.  The size of it depends on the size of a particular gas supply system and varies from 10 to 1000. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our PVC is developed for .NET 4.0 in C #.  The computational module and all mathematics are also being developed in C #.  Initially, to solve the SLAU, I wrote my own, homegrown, library that does not use the technology of sparse matrices.  To solve SLAE applied the <b>LU</b> decomposition method.  And for the time being, everything suited me, until I began to work on the task of optimizing non-stationary gas flow regimes, where it is necessary to perform a large number of searches of the control parameter values ‚Äã‚Äãusing dynamic programming and, accordingly, solve SLAEs many times.  The standard Visual Studio profiler showed that during the program execution, about 40% of the costs are due to the SLAE solution. <br><br>  It was at that moment that I realized that it was time to change something. <br><br><h4>  Mathematical Library Math.Net Numerics </h4><br>  After analyzing the existing mathematical libraries under .Net, I decided to dwell on the Math.Net Numerics library.  You can familiarize yourself with it <a href="https://mathnetnumerics.codeplex.com/">here</a> . <br><br>  I was interested in its key features: <br><ul><li>  Implemented sparse matrices and vectors technology; </li><li>  There are built-in all the necessary vector-matrix operations; </li><li>  There are embedded solvers; </li><li>  Intuitive API. </li></ul><br>  Let me give you a listing with an example of the solution of SLAH using Math.Net Numerics: <br><br><pre><code class="hljs cs">SparseMatrix matrix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SparseMatrix(n); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[] rightSide = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[n]; <span class="hljs-comment"><span class="hljs-comment">//      //... var x = matrix.Solve(DenseVector.Build.DenseOfArray(rightSide)).ToArray();</span></span></code> </pre> <br>  As you can see, everything looks very elegant, but almost immediately I was disappointed - the built-in solver Math.Net Numerics worked much slower than mine.  This did not suit me at all, however, the claims to vector-matrix operations implemented in the library are not so significant.  Therefore, I did not completely abandon Math.Net Numerics, leaving the code where we work with vectors and matrices. <br><br>  But here I remembered the very successful experience of my postgraduate colleagues, who used graphic processors to solve problems of underground hydrodynamics.  I have a laptop with a nVidia GeeForce GT 540M graphics card with 2 GB of memory and support for CUDA technology.  It was decided to try this technology in practice, which I no longer regret. <br><br><h4>  ManagedCuda Library </h4><br>  There is a large amount of material on CUDA technology on this site, so a curious reader will easily find it.  I will dwell on how I solved the task. <br><br>  I was interested in the <a href="http://docs.nvidia.com/cuda/cusparse/">cuSPARSE</a> library.  When I first met her, I came across problems: <br><ul><li>  Direct work with the library is possible only through C / C ++.  Of course, the problem will be solved if you use a quality wrapper, who really did not want to write.  According to the search results, a CUDA wrapper for .Net called <a href="https://cudafy.codeplex.com/">Cudafy was found</a> . </li><li>  cuSPARCE allows you to solve SLAEs with triangular matrices, and in my case the matrices are not.  However, cuSPARSE contains matrix factorization methods that bring them to a triangular form ( <b>LU</b> factorization method, Cholesky decomposition).  However, there were no corresponding methods in the Cudafy API, so Cudafy had to be abandoned. </li></ul><br>  After continuing the search, I discovered the <a href="https://managedcuda.codeplex.com/">ManagedCuda</a> library, which is a high-level wrapper for the CUDA API.  I will not list all its capabilities - they can be found on the official website, but I‚Äôll dwell on how you can, using Math.Net Numerics and ManagedCuda, elegantly and effectively solve SLAE. <br><br>  The idea is to use SparseMatrix from Math.Net Numerics to form and store a sparse matrix in <a href="http://web.eecs.utk.edu/~dongarra/etemplates/node373.html">CSR</a> format, which is taken as input to cuSPARSE and ManagedCuda.  The following is a listing of the relevant program: <br><br><pre> <code class="hljs ruby">SparseMatrix matrix = new SparseMatrix(n); double[] rightSide = new double[n]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      /<span class="hljs-regexp"><span class="hljs-regexp">/... var storage = matrix.Storage as SparseCompressedRowMatrixStorage&lt;double&gt;; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     CSR  var nonZeroValues = storage.EnumerateNonZero().ToArray(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    double[] x = new double[matrix.RowCount]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     CudaSolveSparse sp = new CudaSolveSparse(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ManagedCuda CudaSparseMatrixDescriptor matrixDescriptor = new CudaSparseMatrixDescriptor(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    double tolerance = 0.00001; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ .     sp.CsrlsvluHost(matrix.RowCount, nonZeroValues.Length, matrixDescriptor, nonZeroValues, storage.RowPointers, storage.ColumnIndices, rightSide, tolerance, 0, x); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   LU </span></span></code> </pre><br><h4>  Computational experiment: analysis of time spent on the solution of SLAE by various technologies </h4><br>  In order not to bore the reader with dry text and program listings, consider the results of calculations of SLAEs of dimensions from 50 to 500 using various technologies: <br><ul><li>  Homegrown solver, written by the author.  Let's call it Mani.Net. </li><li>  Standard solver library Math.Net Numerics. </li><li>  LU decomposition method of the ManagedCuda library. </li></ul><br>  Matrix <b>A is</b> filled at 10% randomly. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f6/928/249/7f6928249a0207d2c0a38d4af93d56d0.png" alt="image"><br><br>  The figure clearly demonstrates why I had to abandon Math.Net Numerics to solve SLAE. <br>  Note, with the dimension of the matrix equal to 500, my own solver (Mani.Net) took 1170 ms, Math.Net Numerics ‚Äî 12968 ms, ManagedCuda ‚Äî 70 ms. <br><br><h4>  Conclusion </h4><br>  We should expect comments in the comments, saying that not all machines have nVidia GPUs with CUDA support.  Indeed it is.  Therefore, our application is configured in two compilation configurations: with our own SLAE solution library and with ManagedCuda. <br><br>  As for Mani.Net, I note that this is not an advertisement for my own library.  It is impossible to find it anywhere and I will not pass it on to anyone.  No, I'm not greedy.  I am ashamed of the code. <br><br>  Thanks for reading the article!  I will be glad to know about your opinions and comments in the comments. </div><p>Source: <a href="https://habr.com/ru/post/260993/">https://habr.com/ru/post/260993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260983/index.html">PHP extension. Writing a simple array with Traversable and ArrayAccess</a></li>
<li><a href="../260985/index.html">RAD using multidimensional table processor</a></li>
<li><a href="../260987/index.html">Go away HTML, go away</a></li>
<li><a href="../260989/index.html">Messenger spam: is the law broken?</a></li>
<li><a href="../260991/index.html">Getting rid of "historical causes" in cmd.exe</a></li>
<li><a href="../260995/index.html">The general concept of the direction SafeCityNET</a></li>
<li><a href="../260999/index.html">Functional DDS generator on the FPGA</a></li>
<li><a href="../261001/index.html">Product or service</a></li>
<li><a href="../261003/index.html">Linux Profiling Mechanisms</a></li>
<li><a href="../261005/index.html">TKGate - an open-source digital circuit simulator: the project is alive again</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>