<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux still not cake</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began about a month ago, when Cyril Thay added support for nested namespaces in CRIU, after which our CI system ordered to live long. At th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux still not cake</h1><div class="post__text post__text-html js-mediator-article"> This story began about a month ago, when Cyril Thay added support for nested namespaces in CRIU, after which our CI system ordered to live long.  At that moment nothing foreshadowed those fascinating adventures in which we were involved. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a3/2d1/e64/0a32d1e646a6424c17be75ca5c3e7b48.png" alt="image"><br><a name="habracut"></a><br>  On closer examination, it turned out that the core is only flowing: <br><br> <code>$ slabtop <br> OBJS ACTIVE USE OBJ SIZE SLABS OBJ/SLAB CACHE SIZE NAME <br> 441920 441450 99% 1.00K 13810 32 441920K kmalloc-1024 <br> 224070 222908 99% 0.19K 5335 42 42680K kmalloc-192 <br> 38304 21198 55% 0.19K 912 42 7296K dentry <br> 25602 25133 98% 0.12K 753 34 3012K kernfs_node_cache <br> 19380 19380 100% 0.04K 190 102 760K Acpi-Namespace <br> <br> $ uname -a <br> Linux zdtm.openvz.org 4.10.17-200.fc25.x86_64 #1 SMP Mon May 22 18:12:57 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</code> <br> <br>  ‚ÄúIt flows and flows with whom it does not happen‚Äù, we thought, and were updated to 4.11.  In that part of CI, we have Fedora, and then it was its newest core.  We downloaded, and after a couple of minutes, CI sent us hello again through a broken netfilter ‚Äî when trying to remove an added rule, a vague error was issued: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>[root@zdtm ~]# iptables -w -t filter --protocol tcp -A INPUT --dport 12345 -j DROP <br> [root@zdtm ~]# iptables -w -t filter --protocol tcp -D INPUT --dport 12345 -j DROP <br> iptables: Bad rule (does a matching rule exist in that chain?).</code> <br> <br>  Using iptables, CRIU blocks the network to fix the state of TCP sockets.  It is clear that our CI could not work with such a <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D1459676">bug</a> either.  Without thinking twice, we collected and loaded the kernel directly from the Linus tree, but it did not last long ‚Äî the memory flowed again: <br><br> <code>[root@zdtm criu]# cat /proc/slabinfo | grep mnt <br> mnt_cache 36456 36456 384 42 4 : tunables 0 0 0 : slabdata 868 868 0 <br> <br> [root@zdtm criu]# python test/zdtm.py run -t zdtm/static/env00 --iter 10 -f ns <br> ========================= Run zdtm/static/env00 in ns ========================== <br> Start test <br> ./env00 --pidfile=env00.pid --outfile=env00.out --envname=ENV_00_TEST <br> Run criu dump <br> Run criu restore <br> Run criu dump <br> .... <br> Run criu restore <br> Send the 15 signal to 339 <br> Wait for zdtm/static/env00(339) to die for 0.100000 <br> Removing dump/zdtm/static/env00/31 <br> ========================= Test zdtm/static/env00 PASS ========================== <br> <br> [root@zdtm criu]# cat /proc/slabinfo | grep mnt <br> mnt_cache 36834 36834 384 42 4 : tunables 0 0 0 : slabdata 877 877 0</code> <br> <br>  About the problem reported in <a href="https://lkml.org/lkml/2017/6/8/999">lkml</a> and went on to go about their business.  Soon our compatriot Alexander Viro replied that Andrei Vagin was not a good person and did not properly explain the causes of the problem.  And Alexander, for a moment, is the most important person in the subsystem responsible for everything related to files, file systems.  It is not very responsive to the changes sent, but if you sent a certain r ... but, then the answer will overtake you immediately and inevitably.  And if you are stupid, then he will even explain everything in his own words in simple words. <br><br>  Sometimes it's easier to fix a bug than to explain what happened, what Andrei did.  After some time, the <a href="https://patchwork.kernel.org/patch/9776857/">patch was ready</a> , it was sent to the mailing list and attached to the kernel, which, in turn, was uploaded to the CI.  With a sense of accomplishment, Andrew went to do his own thing.  Viro was silent, which meant no obvious problems in the patch.  Another sign of getting rid of the old problem was the message about the new problem. <br><br> <code>[ 699.207570] BUG: Bad page state in process ip6tables-save pfn:1499f4</code> <br> <br>  We no longer had time and desire to understand, limited to <a href="https://patchwork.kernel.org/patch/9812791/">writing in lkml</a> , and in CI we downloaded the kernel 4.10, which had a significant advantage - it worked and did not fall.  Yes, it flowed a little, and we decided to reboot the car once a day.  Someone remembered the good old days, when everyone overloaded the Windows, if it began to slow down. <br><br>  Fresh bug world efforts pretty quickly repaired.  CI installed the Newest and Best Core, but it was not there.  There were errors in the tests, about every second. <br><br>  In this direction Kirill Gorkunov kept the defense (partly due to the fact that Andrew went to sleep).  By morning, a <a href="https://lkml.org/lkml/2017/6/20/153">big discussion was</a> unfolding in lkml.  It turned out that our nuclear colleagues repaired the Terrible Vulnerability CVE-2017-1000364 and broke the backward compatibility of the user API.  This breakdown was almost intentional: without this, the code became much more complicated, and the community, reluctantly, decided on extreme measures.  And due to the fact that it was a terrible vulnerability (we need a picture of the windows security model with a gate without a fence), the changes were not discussed publicly and were quickly merged into the core.  Immediately after that, it turned out that the changes brought another bug to the core, which also turned out to be a Terrible Vulnerability, and a few more days were spent on the already open debate on a new issue. <br><br>  The confusion has affected distributions.  When the RedHat and <a href="https://bugs.launchpad.net/ubuntu/%2Bsource/linux/%2Bbug/1698919">Ubuntu</a> engineers transferred these changes to their kernels, something went wrong, and both distributions were broken in two different ways.  For us, this was also critical, as part of our CI revolves in Travis, and there only Ubuntu is offered to choose from.  Another part of the CI is spinning on Fedora, you can replace it with Ubuntu for the sake of homogeneity, but certainly not in a hurry.  So Fedora just downloaded the non-native kernel, it should have been fixed already!  After installation, out of habit, immediately saw whether it flows. <br><br> <code>unreferenced object 0xffff88006342fa38 (size 1024): <br> comm "ip", pid 15477, jiffies 4295982857 (age 957.836s) <br> hex dump (first 32 bytes): <br> b8 b0 4d a0 ff ff ff ff c0 34 c3 59 00 88 ff ff ..M......4.Y.... <br> 04 00 00 00 a4 01 00 00 00 00 00 00 00 00 00 00 ................ <br> backtrace: <br> [ffffffff8190510a] kmemleak_alloc+0x4a/0xa0 <br> [ffffffff81284130] __kmalloc_track_caller+0x150/0x300 <br> [ffffffff812302d0] kmemdup+0x20/0x50 <br> [ffffffffa04d598a] dccp_init_net+0x8a/0x160 [nf_conntrack] <br> [ffffffffa04cf9f5] nf_ct_l4proto_pernet_register_one+0x25/0x90</code> <br> <br>  It flows.  The necessary <a href="https://patchwork.ozlabs.org/patch/770887/">changes</a> were found quickly, for some reason the maintainer DCCP did not send them to Linus, and they were lost in his tree.  We take the patch (there is no longer a mood report), reboot into a new kernel. <br><br>  In one of his works, Mark Twain describes a man named Oliver who went to the silver deposits.  The journey took place in very difficult conditions, but Oliver silently endured all the burdens that fell to his lot.  One day, during a long stay (perhaps it was already the end of their trip) a mule fell into his house, smashing the roof.  The next day, the situation repeated itself, and Oliver moved his house to the side where the mules did not walk, but this did not save him - the house again broke the roof, the cow fell.  At that moment, Oliver for the first time expressed his displeasure with the phrase: ‚ÄúIt is already becoming monotonous,‚Äù after which he resigned and left. <br><br>  ‚ÄúThis is already becoming monotonous,‚Äù thought Andrei, looking at the loaded core. <br><br> <code>unreferenced object 0xffff9f79442cd980 (size 112): <br> comm "kworker/1:4", pid 15416, jiffies 4307432421 (age 28687.562s) <br> hex dump (first 32 bytes): <br> 00 00 00 00 ad 4e ad de ff ff ff ff 00 00 00 00 .....N.......... <br> ff ff ff ff ff ff ff ff b8 39 1b 97 ff ff ff ff .........9...... <br> backtrace: <br> [ffffffff9591d28a] kmemleak_alloc+0x4a/0xa0 <br> [ffffffff95276198] kmem_cache_alloc_node+0x168/0x2a0 <br> [ffffffff95279f28] __kmem_cache_create+0x2b8/0x5c0 <br> [ffffffff9522ff57] create_cache+0xb7/0x1e0 <br> [ffffffff952305f8] memcg_create_kmem_cache+0x118/0x160 <br> [ffffffff9528eaf0] memcg_kmem_cache_create_func+0x20/0x110 <br> [ffffffff950cd6c5] process_one_work+0x205/0x5d0 <br> [ffffffff950cdade] worker_thread+0x4e/0x3a0 <br> [ffffffff950d5169] kthread+0x109/0x140 <br> [ffffffff9592b8fa] ret_from_fork+0x2a/0x40 <br> [ffffffffffffffff] 0xffffffffffffffff <br> unreferenced object 0xffff9f798a79f540 (size 32)</code> <br> <br>  To the credit of Andrei, he did not resign, but reported on the problem in lkml, set up a preventive reboot, launched CI and went about his business.  After half a day, a letter came in about new problems. <br><br> <code>&gt; [22458.504137] BUG: Dentry ffff9f795a08fe60{i=af565f,n=lo} still in <br> &gt; use (1) [unmount of proc proc] <br> &gt; [22458.505117] ------------[ cut here ]------------ <br> &gt; [22458.505299] WARNING: CPU: 0 PID: 15036 at fs/dcache.c:1445 <br> ‚Ä¶ <br> &gt; [22458.515141] ---[ end trace b37db95b00f941ab ]--- <br> &gt; [22458.519368] VFS: Busy inodes after unmount of proc. Self-destruct <br> &gt; in 5 seconds. Have a nice day... <br> &gt; [22458.813846] BUG: unable to handle kernel NULL pointer dereference <br> &gt; at 0000000000000018 <br> ‚Ä¶ <br></code> <br><br>  The kernel did not just flow, it hung up tests, it hung itself in an incomprehensible state, but it gave signs of life.  The problem seemed familiar.  It <a href="https://lkml.org/lkml/2017/3/10/1422">turned</a> out that Andrei <a href="https://lkml.org/lkml/2017/3/10/1422">had already written</a> about this problem <a href="https://lkml.org/lkml/2017/3/10/1422">in lkml</a> several months ago, but then no one had dealt with it before.  <a href="https://lkml.org/lkml/2017/6/29/710">This time it was</a> decided to inform many more people, and the reaction finally arose.  Eric Biederman almost immediately found a problem patch, but the essence of the problem a week later was still covered with darkness. <br><br>  <b>Now, on the CI machines, we have a patched-up core loaded, it is not falling yet, but it is still leaking.</b>  <b>In the main branch of Linus, all these problems bloom and smell a little, but this did not prevent the release of 4.12 kernel.</b> <br><br>  People, <s>keep money in savings banks</s> work only on stable cores, unless of course you have them.  A typical Linux kernel lacks testing. <br><br>  In conclusion, I would like to quote Alexander Viro, who said at a nuclear summit about ten years ago: ‚ÄúWe‚Äôre  READ this damned thing. " <br><br>  Authors: Pavel Emelyanov, Kirill Gorkunov and Andrey Vagin. </div><p>Source: <a href="https://habr.com/ru/post/332740/">https://habr.com/ru/post/332740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332730/index.html">Certificate revocation does not work</a></li>
<li><a href="../332732/index.html">The Machine and Exaflops for the Big Data era</a></li>
<li><a href="../332734/index.html">Is robots revolt canceled?</a></li>
<li><a href="../332736/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ270 (July 3 - 9, 2017)</a></li>
<li><a href="../332738/index.html">Oracle Data Integrator. SubstitutionAPI: The order of the substitutions. Part 2</a></li>
<li><a href="../332742/index.html">STM32 + PPP (GSM) + LwIP</a></li>
<li><a href="../332744/index.html">Why is there no Russian Amazon, or where is @ buried? Myths to close</a></li>
<li><a href="../332746/index.html">Hunting a red demon or satellite navigation direction finder</a></li>
<li><a href="../332748/index.html">Trading ASCII: Traditional Roguelike Early Access Sales Results</a></li>
<li><a href="../332750/index.html">Canvas & SVG: working with graphics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>