<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We lock Tor on the corporate firewall</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Due to the fact that many users saw the advantages of the ‚Äúportable Tor Browser‚Äù, which does not require admin rights, it was decided to suppress the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We lock Tor on the corporate firewall</h1><div class="post__text post__text-html js-mediator-article">  Due to the fact that many users saw the advantages of the ‚Äúportable Tor Browser‚Äù, which does not require admin rights, it was decided to suppress the possibility of using Tor in all possible ways. <br>  Immediately, I‚Äôll make a reservation that we‚Äôll talk about FreeBSD + pf. <br><br><a name="habracut"></a><br>  The initialization scheme of the Tor service is simple to ugliness. <br>  There are several root servers on which clients are registered.  The same clients download a list of the same clients as them from the same servers, and according to this list they receive information through which client you can or cannot walk, as well as other proprietary information. <br><br>  The usual URL for the client list request to the root server looks like this: <br><blockquote>  <a href="http://128.31.0.34:9031/tor/status/all">http://128.31.0.34:9031/tor/status/all</a> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The contents of the file issued by the server are approximately as follows: <br><blockquote><code>network-status-version 2 <br> dir-source 128.31.0.34 128.31.0.34 9031 <br> fingerprint FFCB46DB1339DA84674C70D7CB586434C4370441 <br> contact 1024D/28988BF5 arma mit edu <br> published 2009-09-07 18:24:08 <br> dir-options Names BadExits Versions <br> client-versions 0.2.0.34,0.2.0.35,0.2.1.19,0.2.2.1-alpha <br> server-versions 0.2.0.34,0.2.0.35,0.2.1.19,0.2.2.1-alpha <br> dir-signing-key <br> -----BEGIN RSA PUBLIC KEY----- <br> MIGJAoGBAMHa0ZC/jo2Q2DrwKYF/6ZbmZ27PFYG91u4gUzzmZ/VXLpZ8wNzEV3oW <br> nt+I61048fBiC1frT1/DZ351n2bLSk9zJbB6jyGZJn0380FPRX3+cXyXS0Gq8Ril <br> xkhMQf5XuNFUb8UmYPSOH4WErjvYjKvU+gfjbK/82Jo9SuHpYz+BAgMBAAE= <br> -----END RSA PUBLIC KEY----- <br> r Unnamed AFFku1nT3UiV4dsIC0ze+1KD738 YSYH74y8ohTu5Uhvk3Yl0WU8DqI 2009-09-07 11:44:12 94.50.173.6 443 9030 <br> s Exit V2Dir Valid <br> opt v Tor 0.2.0.35 <br> r tbreg AHKeOQzTsS4dKu6jY5dGrCtY3aE h+oWM86K3Z6yb2z4ZpPd++i7yZo 2009-09-07 02:10:50 202.109.188.97 9001 0 <br> s Exit Valid <br> opt v Tor 0.2.1.2-alpha (r15383) <br> r abcdefg ALW6RdYFJ9/JA7MuCkcEUbE+L1I xkVjcAgH+zVB/dcg7NYBDXGWA1g 2009-09-07 17:19:54 84.179.91.68 443 0 <br> s Exit Named Valid <br> opt v Tor 0.2.0.35 <br></code> <br></blockquote><br><br>  The initial part of the page contains service information about the server and the time the list was generated.  Below are the lines identifying customers, as well as their characteristics. <br><br>  We will be interested in lines starting with the letter ‚Äúr‚Äù, and of course the client‚Äôs IP address.  Everything else is not particularly important. <br><br>  Take wget + awk + grep + sort + uniq and get the list of ip addresses we need. <br><blockquote> <code><a href="http://128.31.0.34/"></a> wget 128.31.0.34:9031/tor/status/all -q -O - | grep -E '^r' | awk '{print $7}' | sort | uniq &gt; /etc/pf/tor.list <br></code> <br></blockquote><br><br>  it remains to add a few lines to pf.conf <br><br><blockquote> <code>int_if="em0" <br> ext_if="em1" <br> <br> table persist file "/etc/pf/tor.list" <br> <br> block in log quick on { $int_if $ext_if } from any to &lt;tor&gt; label TOR_IN <br> block out log quick on { $int_if $ext_if } from &lt;tor&gt; to any label TOR_OUT <br> <br></code> <br><br>  And feed the modified config pf. <br><br>  now, using tcpdump on the pflog interface, you can calculate the person who tried to use Tor and say ‚Äúah yay yay‚Äù.  The script for updating the list of Tor clients can be run as often as you like (depending on the traffic prepaid by your company).  The usual client file size is about 1.5 megabytes.  Therefore, how often to update it is up to you and only you.  I pull the file every 10 minutes (unlimited traffic). <br><br>  For lovers of perl solutions there is a module <br>  <a href="">search.cpan.org/~ajdixon/Net-Tor-Servers-0.02/lib/Net/Tor/Servers.pm</a> <br>  which, in conjunction with the pftable perl client, will allow you to change the pf table on the fly without invoking the synchronization script and rereading the clients' Tor tables. <br><br>  Those interested can bind the Tor client table to other firewalls. <br><br> <code><font>(C) Aborche 2009</font> <br> <img src="http://aborche.com/pics/aborchelogo.jpg"></code> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/68971/">https://habr.com/ru/post/68971/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68963/index.html">What format do you prefer to store music in?</a></li>
<li><a href="../68965/index.html">Do you pay taxes on the income of individuals received on the Internet?</a></li>
<li><a href="../68966/index.html">Web analytics: analyze it! Part 4. From statistics to analytics</a></li>
<li><a href="../68967/index.html">Warm up for the mind. Rate the creativity of your thinking!</a></li>
<li><a href="../68968/index.html">Dwarf fortress</a></li>
<li><a href="../68973/index.html">Hash letter</a></li>
<li><a href="../68974/index.html">And why are you still not sleeping?</a></li>
<li><a href="../68975/index.html">Windows Phone</a></li>
<li><a href="../68976/index.html">HackDay St. Petersburg - event report</a></li>
<li><a href="../68977/index.html">Another Playstation 4 concept</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>