<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Transparent" Squid with access control</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to cook a squid, I think that I‚Äôm not the only one who was faced with the task of setting up Squid for access control for employees, but at the sa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Transparent" Squid with access control</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/537/f79/b40/537f79b404eb41848d5fbe925336ce78.jpg"><br><br>  How to cook a squid, I think that I‚Äôm not the only one who was faced with the task of setting up Squid for access control for employees, but at the same time it should be ‚Äútransparent.  In other words, the configuration shown below satisfies three conditions: <br><br><ul><li>  There is a list of prohibited Internet resources, access to which is denied to all users (Example: social networks); 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  There is a list of allowed Internet resources, access to which is open to all users (Example: government services portal); <br><br></li><li>  There is a list of ip-addresses of users who should have access to all Internet resources except those included in the list of banned. </li></ul><br><a name="habracut"></a><br>  I would like to clarify the last point, since the gateway is ‚Äútransparent‚Äù, we cannot use domain authorization of users, for this reason, the distinction is chosen precisely by ip-addresses. <br><br>  As a basic configuration, materials from the article <a href="https://habrahabr.ru/post/267851/">‚ÄúTransparent‚Äù Squid with HTTPS filtering resources without certificate substitution (x86) were used</a> .  Since the installation and configuration of components in this article are described in sufficient detail, I will skip this information. <br><br>  The software I used to test the configuration: <br><br><ul><li>  Gentoo Linux version Base System release 2.2; </li><li>  Squid 3.5.22; </li><li>  OpenSSL 1.0.2j </li></ul><br>  So, the <b>/etc/squid/squid.conf</b> file <b>:</b> <br><br><pre><code class="bash hljs">acl localnet src 192.168.0.0/16 <span class="hljs-comment"><span class="hljs-comment"># RFC1918 possible internal network acl SSL_ports port 443 acl Safe_ports port 80 # http acl Safe_ports port 21 # ftp acl Safe_ports port 443 # https acl Safe_ports port 70 # gopher acl Safe_ports port 210 # wais acl Safe_ports port 1025-65535 # unregistered ports acl Safe_ports port 280 # http-mgmt acl Safe_ports port 488 # gss-http acl Safe_ports port 591 # filemaker acl Safe_ports port 777 # multiling http acl Safe_ports port 901 # SWAT acl CONNECT method CONNECT #  acl  : ,      acl denied_urls url_regex "/etc/squid/denied_urls" acl allowed_urls url_regex "/etc/squid/allowed_urls" acl extended_access_group src "/etc/squid/extended_access_group" http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow localhost manager http_access deny manager #  -    ,         #  https  . #    ,  https http_access allow localnet CONNECT #      http_access deny denied_urls #             #  http_access deny !extended_access_group !allowed_urls http_access allow localnet http_access allow localhost http_access deny all #            http_port 3130 http_port 3128 intercept https_port 3129 intercept ssl-bump options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off cert=/etc/squid/squidCA.pem always_direct allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER #   ssl acl allowed_urls_ssl ssl::server_name_regex "/etc/squid/allowed_urls" acl denied_urls_ssl ssl::server_name_regex "/etc/squid/denied_urls" acl step1 at_step SslBump1 ssl_bump peek step1 ssl_bump terminate denied_urls_ssl ssl_bump splice extended_access_group ssl_bump terminate !allowed_urls_ssl ssl_bump splice all sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB #cache_dir ufs /var/cache/squid 100 16 256 coredump_dir /var/cache/squid refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\?) 0 0% 0 refresh_pattern . 0 20% 4320</span></span></code> </pre> <br>  Before running Squid, do not forget to create three files in <i>/ etc / squid /</i> .  <i>denied_urls</i> and <i>allowed_urls of the</i> form: <br><br><pre> <code class="bash hljs">geektimes.ru habrahabr.ru toster.ru windowsupdate.microsoft.com</code> </pre><br>  And <i>extended_access_group of the</i> form: <br><br><pre> <code class="bash hljs">192.168.1.5 <span class="hljs-comment"><span class="hljs-comment"># .. 192.168.1.87 # .. 192.168.1.108 # ..</span></span></code> </pre><br>  When accessing http on a banned site, it will issue a standard Squid stub, and via https - ‚ÄúERR_SSL_PROTOCOL_ERROR‚Äù. <br><br>  Thank you for reading the article. </div><p>Source: <a href="https://habr.com/ru/post/314718/">https://habr.com/ru/post/314718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314706/index.html">7 useful plugins for Sketch</a></li>
<li><a href="../314708/index.html">We are waiting for everyone at GeekWeek 2016: learn and have fun</a></li>
<li><a href="../314710/index.html">Odin a year later: Oleg Melnikov - about what happened after the purchase of Parallels cloud division</a></li>
<li><a href="../314712/index.html">Recall everything: how to quickly recover data that was mistakenly changed by the user.</a></li>
<li><a href="../314716/index.html">Now ONLYOFFICE can do everything: add plugins to document editors</a></li>
<li><a href="../314720/index.html">The release of mobile games in China is more complicated than ever.</a></li>
<li><a href="../314722/index.html">Google and Samsung fixed Dirty COW vulnerability in Android firmware</a></li>
<li><a href="../314724/index.html">One scientifically based way to rationally manage your busy and busy schedule</a></li>
<li><a href="../314726/index.html">JRuby + Ratpack = ‚ù§Ô∏è</a></li>
<li><a href="../314730/index.html">How the cooling system of the NORD-4 data center was created</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>