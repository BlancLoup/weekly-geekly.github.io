<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the protocols of counters Mercury 230 and Mercury 200 for OpenSCADA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For whom 
 - For those who use OpenSCADA, but cannot implement more than out-of-box solutions 
 - For those who are looking for SCAD for themselves, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the protocols of counters Mercury 230 and Mercury 200 for OpenSCADA</h1><div class="post__text post__text-html js-mediator-article">  <b>For whom</b> <br>  - For those who use OpenSCADA, but cannot implement more than out-of-box solutions <br>  - For those who are looking for SCAD for themselves, but cannot be determined <br>  - For those who abandoned this project, without understanding how it works <br><br>  <b>What for</b> <br>  - This solution allows you to read the meter readings of Mercury 230 and Mercury 200 without any limits <br>  - It's free <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a4/e49/280/0a4e49280b46438e8d59e48697dec11f.jpg"></div><br>  The openscada project (oscada.org) is paid little attention to, just one article on Habr√© is written about it.  Most engineers are afraid to touch this product with a three-meter stick, God knows what this Linux is for you.  Developing it for more than a decade is actually one person, Roman Savochenko. <br><a name="habracut"></a><br>  Not having previously experience with SCADA in general (and was a little friendly with Linux), I chose him to implement the monitoring of objects in the enterprise.  Since I had nothing to compare with, I took the interface and all the data connections with each other for granted.  The ‚Äúquick start‚Äù video tutorial helped a lot. I personally think that such lessons could have been done more.  The documentation also had to be re-read more than once, but it was worth it.  Having connected the first data acquisition module Neod + for a long time could not understand why it is not working.  After all, as compatible with the DCON protocol, it was listed as a project (more precisely, its equivalent).  I got into the source of the protocol and ... it turned out that it was completely incompatible with it, like many other collection modules from the list.  The first appeal to the forum corrected my problem and a few more errors quite quickly.  I will not talk about all the intricacies of the system, it is better to read the above article in Habr√© or see the ‚Äúquick start‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After some time, it took me to take readings from the electricity meters Mercury 230. There is no support for these meters in openscada.  I tried the taskgroup utility from the creator of the well-known konfigurator, it turned out to be a dead number to poll counters for CSD.  But everything is not as bad as it could be, the openscada system is extremely modular and you can even write your own module in C ++, even in a high-level language right in it.  The description of the exchange protocol for Mercury 230 can be found on the network without any problems, the manufacturer of Incotex can of course provide you with a description on request, but I did not want to get involved with this red tape. <br><br>  So, we connect the bus with meters, for clarity and better orientation in the protocol we put konfigurator and sniffer sequentially of the port, open the documentation.  We are trying to read the data from the counter with the address 75. <br><br>  all screenshots are clickable <br><br> <a href=""><img src="https://habrastorage.org/files/8ab/975/a8f/8ab975a8f92a436e8d99f1837f57c7cc.png"></a> <br><br>  We see how our data ran. <br><br> <a href=""><img src="https://habrastorage.org/files/4d3/597/a53/4d3597a530634827a6765502f6c5a2b8.png"></a> <br><br>  The exchange protocol for Mercury 230 is very similar to the modbus protocol. <br><br>  A request to open a communication channel is intended to allow access to data with an indication of the level of access.  Two-level data access is implemented in the meter: the first (lowest) is the consumer level, and the second (highest) is the host level <br><br><img src="https://habrastorage.org/files/bae/987/d0d/bae987d0de854a0c825dc3a4ef9bf9e9.png"><br><br>  We will try using the configurator to interrogate our counter and see that the first request is the password, and the counter response is 4 bytes.  inclusive <br><br><img src="https://habrastorage.org/files/c62/7f9/6de/c627f96de10a4c559df886c2ee38a4a9.png"><br><br>  Now we will try to implement it on openscada.  In C ++, I am not strong, so I decided to implement it in the language embedded in SCAD itself, which is called JavaLikeCalc.Javascript.  The poll code itself is implemented in two modules UserProtocol and DevLib.  Create a device in the device library and call it m230.  Add the attributes netaddr (network address), password (password), transport (serial port) and answer (response to a password request).  And write a request. <br><br> <a href=""><img src="https://habrastorage.org/files/88b/04a/243/88b04a243aa044c5ac439044d2639b69.png"></a> <br><br>  We now turn to the protocol part and create our user protocol in the UserProtocol and call it m230 as well.  Let's start with the network address translation.  The code for calculating the modbus CRC16 checksum has already been written a long time ago, I just have to insert it into my code. <br><br> <a href=""><img src="https://habrastorage.org/files/8c0/514/46d/8c051446daf64502aec07d7c0539b27d.png"></a> <br><br>  Let's create and transport, having registered in it the necessary port, speed and timings. <br><br> <a href=""><img src="https://habrastorage.org/files/cb7/177/76c/cb717776c18d490795eb860acf475974.png"></a> <br><br>  Now we will create devices in LogivLev, in it we will create a controller as well as parameters (they are also counters).  Choose our template, in the configuration we prescribe the network address, password and transport. <br><br> <a href=""><img src="https://habrastorage.org/files/cc1/d95/96f/cc1d9596f51949779fc4c32525a94d48.png"></a> <br><br>  It will not be superfluous to enable archiving in the corresponding tab. <br><br> <a href=""><img src="https://habrastorage.org/files/1b8/6cc/e59/1b86cce594ab4ea0b1028f01bce2e95c.png"></a> <br><br>  Go to the Attributes tab and see our 4 bytes of response from the counter.  Password accepted, great !!! <br><br> <a href=""><img src="https://habrastorage.org/files/426/d9f/ec8/426d9fec888541828aa1b86a6813ccda.png"></a> <br><br>  What we try to read the testimony of electricity.  Add in the attributes of the template a few entries a few more lines of code for each tariff and for their amount. <br><br> <a href=""><img src="https://habrastorage.org/files/bdd/044/aa0/bdd044aa04ca4a0cbcd0c13746e47a48.png"></a> <br><br>  Next, add more lines to our protocol.  It would not be superfluous to check the answer to whether the request came and check the packet length.  Each 4 bytes of useful response information is interpreted by its sequence of bytes, it is visible in the screenshot for reading energy.  At the end of the 16ric system we translate the data into decimal, besides, this number should be divided by 1000. <br><br> <a href=""><img src="https://habrastorage.org/files/1f8/540/a00/1f8540a00fc84242a755559046be95d3.png"></a> <br><br>  We go back into the configuration of the template, set the checkbox ‚ÄúRead energy from reset‚Äù and in the attributes we already see data on tariffs. <br><br> <a href=""><img src="https://habrastorage.org/files/95e/dd7/826/95edd7826de44760a9362a327c6d62b9.png"></a> <br><br>  We are not going to stop at this and try to add instant data - voltage, current and power.  Everything is the same here, we only change the second, third and fourth bytes, which are responsible for what information we want from the counter. <br><br> <a href=""><img src="https://habrastorage.org/files/6f1/ec6/343/6f1ec63439584908bddce83fa4db7071.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/4fd/ac5/d7a/4fdac5d7ad14497fb69c932ec5554a9b.png"></a> <br><br>  We add a few changes on the protocol side. We check the answer to the bytes from which we build an assumption about its length and check it, add our own byte sequence, translate into the decimal system and divide by 100 to answer the voltage and power and 1000 to answer the current. <br><br> <a href=""><img src="https://habrastorage.org/files/883/fdb/d76/883fdbd760ac47f58426948f9c5e05e2.png"></a> <br><br>  Now, in the attributes of our counter, we see all its basic data, which of course is many times larger and, if desired, you can add more, for example, the frequency in Hertz and much more. <br><br> <a href=""><img src="https://habrastorage.org/files/c8a/55a/197/c8a55a1971354542ba211341096248df.png"></a> <br><br>  Add for clarity a few more counters.  But this is not all, the data must not only be read but also presented in a convenient form.  To do this, in openscada there is a Vision (working user interface) in which the data can be presented in any form convenient for you, even in the form of a mnemonic scheme, in the form of graphs, in the form of documents, etc.  Take the standard document from the template and edit it to make it so. <br><br> <a href=""><img src="https://habrastorage.org/files/940/1fc/018/9401fc018d3b49b790c6af9d54d2bb18.png"></a> <br><br>  And in the processing of the document we add a line so that you can easily read the data archives by day. <br><br> <a href=""><img src="https://habrastorage.org/files/8c5/2f1/a54/8c52f1a545cc41859968871a2cee186f.png"></a> <br><br>  As a result, we launch the project and open our document. <br><br> <a href=""><img src="https://habrastorage.org/files/6b1/5a1/e35/6b15a1e35fca4290b3ffa70c65f27588.png"></a> <br><br>  If you need to provide instant values ‚Äã‚Äãor from the archive, create a graph by adding our values ‚Äã‚Äãthere.  Here is an example of the values ‚Äã‚Äãfor a voltage meter. <br><br> <a href=""><img src="https://habrastorage.org/files/f17/d46/d2b/f17d46d2bfc949b4a896db911715164f.png"></a> <br><br>  But some time later, the idea of ‚Äã‚Äãwriting a protocol for single-phase meters Mercury 200 did not let go. I did not find the protocol description, but the world is not without good people. <br><br>  The network address here is the counter password.  By default, it is equal to the last 6 digits of the serial number.  Let's try to write a template. <br><br>  Here is the request and response packet <br><br><img src="https://habrastorage.org/files/345/d35/370/345d3537037745c39680a9ff6ead9399.png"><br><br>  The serial number of the counter is too long to fit it into a 32-bit integer, so we divide it into two parts. <br><br>  Tariff request code 0x27, write the request structure and allocate which bytes for which tariff we are responsible for.  And we divide this value by 100. And we check our answer for the volume of characters. <br><br>  To read the instantaneous values, use the request code 0x63.  Also check our answer for the number of bytes.  The nuances for each of these values ‚Äã‚Äãare also taken into account. <br><br>  But what to do if the counter is encoded by the program adjuster +?  Fortunately, the encoder + has been encoded by everyone for a long time, so we add a line to the beginning of our code. <br><br> <a href=""><img src="https://habrastorage.org/files/7cf/9bb/67d/7cf9bb67daa748cc9c635d0ba1fc0945.png"></a> <br><br>  We turn to the protocol side.  We convert our address into hexadecimal system.  Calculation of the checksum and request as in the previous protocol. <br><br> <a href=""><img src="https://habrastorage.org/files/264/f4f/043/264f4f043502434299886befebeb17d7.png"></a> <br><br>  Add a few counters and in the configuration of the template write our settings. <br><br> <a href=""><img src="https://habrastorage.org/files/a5f/9b2/a0a/a5f9b2a0a8374654bfc13ff37e10c8d1.png"></a> <br><br>  And in the Attributes tab, we see how the counter gives the values ‚Äã‚Äãwe need. <br><br> <a href=""><img src="https://habrastorage.org/files/faf/6df/8f0/faf6df8f05ee4771b7f5c797a270f8c5.png"></a> <br><br>  Create a document to view these values ‚Äã‚Äãin a more convenient way.  Edit our document template.  Run our project. <br><br> <a href=""><img src="https://habrastorage.org/files/140/4bb/f5f/1404bbf5fd57479f9d2e7b1881a76713.png"></a> <br><br>  Everything turned out to be quite simple.  This protocol can be downloaded on the <a href="http://oscada.org/ru/forum/">oscada.org/ru/forum</a> forum in the "Development of OpenSCADA" section.  And at the moment, as far as I know, this is the only free solution for mercury for an unlimited number of counters. <br><br>  <b>PS</b> I wrote this case 3 years ago, I just recently decided to share it. <br>  <b>PPS</b> The article most likely has inaccuracies with which Roman would obviously be unhappy. </div><p>Source: <a href="https://habr.com/ru/post/315430/">https://habr.com/ru/post/315430/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315418/index.html">Polish clouds. Price notes (not only for Ukrainians)</a></li>
<li><a href="../315420/index.html">How to create elusive goals in the game 2016 Hitman</a></li>
<li><a href="../315422/index.html">We control the quality of the code using the SonarQube platform</a></li>
<li><a href="../315424/index.html">Creation of the world Experience of creating intelligent life with their own hands</a></li>
<li><a href="../315428/index.html">The first private city in Russia, to be or not to be? Part 1</a></li>
<li><a href="../315432/index.html">Veeam Availability Suite 9.5 released - what's new?</a></li>
<li><a href="../315434/index.html">Connect (); // 2016: Text Translation</a></li>
<li><a href="../315436/index.html">The history of communication towers 2: forms and types</a></li>
<li><a href="../315440/index.html">Verification of a mobile application for compliance with European data protection legislation</a></li>
<li><a href="../315442/index.html">Visual Regular Expression Generator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>