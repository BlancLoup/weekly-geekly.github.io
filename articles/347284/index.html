<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About errors and exceptions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time I examined two examples ( one , two ), how to move from imperative validation of input values ‚Äã‚Äãto declarative. The second example really ‚Äúk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About errors and exceptions</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/7-/md/p6/7-mdp6qmdxejlo8zmeplrjc7zzo.jpeg"><br><br>  Last time I examined two examples ( <a href="https://habrahabr.ru/post/346308/">one</a> , <a href="https://habrahabr.ru/post/346850/">two</a> ), how to move from imperative validation of input values ‚Äã‚Äãto declarative.  The second example really ‚Äúknows too much‚Äù about the aspects of storage and has pitfalls ( <a href="https://habrahabr.ru/post/346850/">one</a> , <a href="https://habrahabr.ru/post/346850/">two</a> ).  The alternative is to break the validation into 3 parts: <br><br><ol><li> Model banding: expecting <code>int</code> , came in <code>string</code> - return 400 </li><li>  Validation of values: the email field should be in the format of <code>your@mail.com</code> , and <code>123Petya</code> - return 422 </li><li>  Validation of business rules: expect that the user's basket is active, and it is in the archive.  Return 422 </li></ol><br><blockquote>  Unfortunately, the standard ASP.NET MVC binding mechanism does not distinguish between type mismatch errors (got <code>string</code> instead of <code>int</code> ) and validation, so if you want to distinguish between 400 and 422 response codes, you will have to do it yourself.  But it's not about that. </blockquote><br><h2>  How can a business logic layer return an error message to the controller? </h2><br>  The most common (according to Habr) method ( <a href="https://habrahabr.ru/post/339606/">one</a> , <a href="https://habrahabr.ru/post/346850/">two</a> , <a href="https://habrahabr.ru/post/346308/">three</a> ) is to throw an exception.  Thus, between the concept of "error" and "exception" is put an equal sign.  Moreover, the ‚Äúerror‚Äù is interpreted in the broad sense of the word: it is not only validation, but also verification of access rights and business rules.  Is it so?  Is any error an ‚Äúexceptional situation‚Äù?  If you have ever come across accounting or tax accounting, you probably know that there is a special term ‚Äúadjustment‚Äù.  It means that incorrect information was submitted in the last reporting period and must be corrected.  That is, in the field of accounting, without which a business cannot exist in principle, errors are first-class objects.  Special terms have been introduced for them.  Can we call them exceptional situations?  Not.  This is normal behavior.  People are wrong.  Programmers are simply overly optimistic people.  We just never take off the rose-colored glasses. <br><a name="habracut"></a><br><h2>  Exception = error? </h2><br>  Well, maybe ‚Äúexceptions‚Äù is just a bad name, but in fact they are great for working with ‚Äúbugs‚Äù.  Even MSDN defines ‚Äúexceptions‚Äù as ‚Äúrun-time errors‚Äù.  Let's check.  What happens to a program if an unhandled exception occurs in it?  Emergency shutdown.  Web applications do not terminate just because, in fact, all unhandled exceptions are handled globally.  All server platforms provide the ability to subscribe to "raw" errors.  Should the program terminate if there is an error in the business logic?  In some cases, yes, for example, if you are developing software for high-frequency trading and something went wrong in the trading algorithm.  It doesn't matter how quickly you make decisions if they are wrong.  And in case of an error in user input?  No, we need to display a meaningful message to the user.  Thus, mistakes are fatal or "not so."  To use one type to designate both is fraught. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Imagine that you have two projects in support.  Both log all unhandled exceptions in the database.  In the first case, exceptions are extremely rare: 1-2 times a month, and in the second hundreds per day.  In the first case, you will very carefully study the logs.  If something has appeared in the log, then there is some fundamental problem and in certain cases the system can go into an indefinite state.  In the second, the signal-to-noise ratio is ‚Äúbroken.‚Äù  How to know the system is working normally or entered into the zone of turbulence, if the logs are always full of errors? <br><br>  We can create a type <code>BusinessLogicException</code> and log them separately (or not log).  Then make a similar <code>HttpException</code> for <code>HttpException</code> , <code>DbValidationException</code> and others.  Hmm, you need to remember which exceptions you need to catch and which not.  Similarly, in Java, there are checked exceptions, let's bring in .NET!  It is only necessary to take into account that not all exceptions <a href="https://www.youtube.com/watch%3Fv%3DU92Ts53win4">can be caught and processed</a> and not to forget about the peculiarities of working with <a href="https://habrahabr.ru/post/337880/">exceptions in the TPL</a> .  And how is it, well, this <a href="http://mattwarren.org/2016/12/20/Why-Exceptions-should-be-Exceptional">performance</a> . <br><br><h2>  Exception = goto? </h2><br>  Another argument against the widespread use of exceptions is the <a href="http://www.artima.com/intv/handcuffs.html">similarity with goto.</a>  There is no way to find out where in the call chain it will be caught, because the method signature does not reveal which exceptions can be thrown inside.  Moreover, method signatures in languages ‚Äã‚Äãwith exceptions <a href="https://habrahabr.ru/post/263685/">do not agree</a> .  It would be more correct to write not <code>RequestDto -&gt; IActionResult</code> , but <code>RequestDto -&gt; IActionResult | Exception</code>  <code>RequestDto -&gt; IActionResult | Exception</code> : the method may succeed or something may go wrong. <br><br><h2>  Exception handling in a three-tier architecture </h2><br>  Since we do not know exactly where exactly the error occurred, we cannot process it well, form a meaningful message to the user or use a compensating action. <br><br>  Thus, if in the business logic layer, exceptions are used for all types of ‚Äúerrors‚Äù, we must either wrap each controller method in a <code>try / catch</code> block, or override the processing method at the application level.  The first option is bad because you have to duplicate <code>try / catch</code> everywhere and keep track of the types of errors being caught.  The second is that we lose the execution context. <br><br>  Scott Vlashin proposed an alternative approach to working with errors in his report, <a href="http://fsharpforfunandprofit.com/rop/">Railway Oriented Programming</a> ( <a href="https://habrahabr.ru/post/339606/">translated to Habr√©</a> ), and <a href="https://habr.com/users/vkhorikov/" class="user_link">vkhorikov</a> <a href="https://habrahabr.ru/post/267231/">adapted it for C #</a> .  I took the liberty to slightly modify this version. <br><a name="result"></a><br><h2>  We finish <a href="https://gist.github.com/vkhorikov/7852c7606f27c52bc288">Result</a> </h2><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Result</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Success { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Error { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Failure { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !Success; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Result</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> success, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> error</span></span></span><span class="hljs-function">)</span></span> { Contracts.Require(success || !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(error)); Contracts.Require(!success || <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(error)); Success = success; Error = error; } <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br>  The <code>string</code> type is not quite convenient for working with errors.  Replace the string with the type <code>Failure</code> .  Unlike the Scott variant, <code>Failure</code> is not a union-type, but an ordinary class.  Pattern matching to work with errors is replaceable with polymorphism.  In order to save additional error information we will use the <code>Data</code> property.  Often this data needs to be simply serialized, so a specific type is not so important. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Failure</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Failure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Failure[] failures</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!failures.Any()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(failures)); } Message = failures.Select(x =&gt; x.Message).Join(Environment.NewLine); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dict = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; failures.Length; i++) { dict[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString()] = failures[i]; } Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReadOnlyDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(dict); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Failure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { Message = message; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Failure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; data</span></span></span><span class="hljs-function">)</span></span> { Message = message; Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReadOnlyDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(data); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReadOnlyDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  We will declare the heir-specific classes for validation errors and access rights. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValidationFailure</span></span>: <span class="hljs-title"><span class="hljs-title">Failure</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ValidationResult[] ValidationResults { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidationFailure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;ValidationResult&gt; validationResults</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ValidationResultsToStrings(validationResults</span></span></span><span class="hljs-function">))</span></span> { ValidationResults = validationResults?.ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ValidationResults == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !ValidationResults.Any()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(validationResults)); } Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReadOnlyDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;( ValidationResults.ToDictionary( x =&gt; x.MemberNames.Join(<span class="hljs-string"><span class="hljs-string">","</span></span>), x =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)x.ErrorMessage)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidationResultsToStrings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IEnumerable&lt;ValidationResult&gt; validationResults</span></span></span><span class="hljs-function">)</span></span> =&gt; validationResults .Select(x =&gt; x.ErrorMessage) .Join(Environment.NewLine); }</code> </pre><br><h1>  Overloading operators and hiding <code>Value</code> </h1><br>  Add to the <code>Result</code> operator overload <code>&amp;, |  true  false</code>  <code>&amp;, |  true  false</code> so that <code>&amp;&amp;</code> and <code>||</code>  .  Close the value and instead provide the function <code>Return</code> .  Now it is impossible to make a mistake and not to check the <code>IsFaulted</code> property: the method requires <code>TDestination</code> both parameter <code>T</code> and <code>Failure</code> lead to type <code>TDestination</code> .  This fixes a problem with return codes that you can forget to check.  The result simply cannot be obtained without processing the variant with an error. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Result</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">implicit</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Result</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Failure failure</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result(failure); <span class="hljs-comment"><span class="hljs-comment">// https://stackoverflow.com/questions/5203093/how-does-operator-overloading-of-true-and-false-work public static bool operator false(Result result) =&gt; result.IsFaulted; public static bool operator true(Result result) =&gt; !result.IsFaulted; public static Result operator &amp;(Result result1, Result result2) =&gt; Result.Combine(result1, result2); public static Result operator |(Result result1, Result result2) =&gt; result1.IsFaulted ? result2 : result1; public Failure Failure { get; private set; } public bool IsFaulted =&gt; Failure != null; }</span></span></code> </pre><br>  In the context of a web operation, the implementation of a transformation method may look like this: <br><br><pre> <code class="cs hljs">result.Return&lt;IActionResult&gt;(Ok, x =&gt; BadRequest(x.Message));</code> </pre> <br>  Or for the case of <a href="https://habrahabr.ru/post/339606/">Scott's example</a> : get a request, perform validation, update the information in the database and, if successful, send an email with confirmation like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ChangeUserNameCommand command</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = command.Validate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.IsFaulted) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ChangeUserName(command) .OnSuccess(SendEmail) .Return&lt;IActionResult&gt;(Ok, x =&gt; BadRequest(x.Message)); }</code> </pre> <br><a name="linq"></a><h2>  Support LINQ syntax (per fan) </h2><br>  If there are more steps, then the <code>if(res.IsFaulted) return res;</code>  will have to be repeated after each step.  I would like to avoid this.  This is <code>SelectMany</code> cycle of <a href="https://ericlippert.com/2013/04/02/monads-part-twelve/">Eric Lippert</a> ‚Äôs articles about the nature of <code>SelectMany</code> and the letter with the letter M can be by the way. In general, LINQ syntax supports not only <code>IEnumerable</code> , but also any other types.  The main <code>SelectMany</code> implement <code>SelectMany</code> aka <code>Bind</code> .  Add some scary code with templates.  <i>Here I will not go into details on how <code>bind</code> works.</i>  <i>If interested, read through Lippert or Vlashin</i> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ResultExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Result&lt;TDestination&gt; Select&lt;TSource, TDestination&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Result&lt;TSource&gt; source, Func&lt;TSource, TDestination&gt; selector) =&gt; source.IsFaulted ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result&lt;TDestination&gt;(source.Failure) : selector(source.Value); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Result&lt;TDestination&gt; SelectMany&lt;TSource, TDestination&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Result&lt;TSource&gt; source, Func&lt;TSource, Result&lt;TDestination&gt;&gt; selector) =&gt; source.IsFaulted ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Result&lt;TDestination&gt;(source.Failure) : selector(source.Value); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Result&lt;TDestination&gt; SelectMany&lt;TSource, TIntermediate, TDestination&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Result&lt;TSource&gt; result, Func&lt;TSource, Result&lt;TIntermediate&gt;&gt; inermidiateSelector, Func&lt;TSource, TIntermediate, TDestination&gt; resultSelector) =&gt; result.SelectMany&lt;TSource, TDestination&gt;(s =&gt; inermidiateSelector(s) .SelectMany&lt;TIntermediate, TDestination&gt;(m =&gt; resultSelector(s, m))); }</code> </pre> <br>  It looks a bit unusual, but you can build chains of calls and combine them into one pipe.  All <code>if(result.IsFaulted)</code> are performed ‚Äúunder the hood‚Äù using the LINQ syntax. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Result&lt;UserNameChangedEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Declarative</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ChangeUserNameCommand command</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> validatedCommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> command.Validate() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> domainEvent </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeUserName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">validatedCommand</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSuccess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SendEmail</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> domainEvent</span></span>;</code> </pre> <br><h2>  Conclusion </h2><br>  I do not urge to refuse exceptions.  This is a very good tool for, surprise, ‚Äúexceptional situations‚Äù - mistakes that we didn‚Äôt expect at all.  They prevent the system from going into an undefined state and can serve as an excellent indicator of the normal / emergency operation of the application.  However, using exceptions everywhere, we deprive ourselves of this tool.  Regular situation by definition can not be considered exceptional. <br><br>  In the C # version, there is currently no mechanism in the language for working with ‚Äúnon-exceptional‚Äù situations, i.e.  errors that will probably occur and which we must handle.  Perhaps in future versions we will get these features.  It is up to you to reserve special types of exceptions as ‚Äúnot exceptional situations‚Äù or introduce other specialized types, for example, as in this article. </div><p>Source: <a href="https://habr.com/ru/post/347284/">https://habr.com/ru/post/347284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347274/index.html">Own DBMS for 3 weeks. You just need a little time every day ...</a></li>
<li><a href="../347276/index.html">Smart search: how artificial intelligence hh.ru selects jobs to resume</a></li>
<li><a href="../347278/index.html">Learning online programming - is everything as simple as it seems?</a></li>
<li><a href="../347280/index.html">[DotNetBook] Stack stream. Its editing and stream cloning</a></li>
<li><a href="../347282/index.html">How to write a diploma using three open projects</a></li>
<li><a href="../347286/index.html">Making games in Python 3 and Pygame: Part 5</a></li>
<li><a href="../347288/index.html">Universal data converter on the .Net Framework</a></li>
<li><a href="../347294/index.html">Type system in mathematics</a></li>
<li><a href="../347296/index.html">Backup with Software-defined Storage and Erasure Coding - is the game worth the candle?</a></li>
<li><a href="../347298/index.html">The school of interface developers of Yandex again opens the set</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>