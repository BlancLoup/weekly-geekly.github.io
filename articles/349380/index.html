<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Angular 5: Unit tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the unit tests, we can make sure that the individual parts of the application work exactly as we expect from them. 

 This, to some extent, saves...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Angular 5: Unit tests</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/7n/o1/ta/7no1tawbncipmx2gljfebg9l6oe.png" align="right">  With the unit tests, we can make sure that the individual parts of the application work exactly as we expect from them. <br><br>  This, to some extent, saves the existing code from breakdowns, helps to clarify how it will work in certain cases.  And, finally, it allows you to look at the code, so to speak, from the side, in order to see its weak points. <br><br>  There is even an opinion that the code being difficult to test is a contender for rewriting. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The purpose of this article is to help in writing unit tests for Angular 5+ applications.  Let it be a fascinating process, not a headache. <br><a name="habracut"></a><br><h2>  Isolated or Angular Test Bed? </h2><br>  As for the unit testing Angular applications, we can distinguish two types of tests: <br><br><ul><li>  <a href="https://angular.io/guide/testing">Isolated</a> - those that do not depend on Angular.  They are easier to write, easier to read and maintain, since they eliminate all dependencies.  This approach is good for services and paypov. </li><li>  <a href="https://angular.io/api/core/testing/TestBed">Angular Test Bed</a> - tests, in which the TestBed test utility is used to set up and initialize the environment for testing.  The utility contains methods that facilitate the testing process.  For example, we can check whether a component has been created, how it interacts with the template, with other components and with dependencies. </li></ul><br><h3>  Isolated </h3><br>  With an isolated approach, we test the service as an ordinary class with methods. <br><br>  First we create an instance of the class, and then we check how it works in various situations. <br><br>  Before proceeding to the examples, it is necessary to indicate that I am writing and running tests with <a href="https://facebook.github.io/jest/">jest</a> , because I liked its speed.  If you prefer <a href="https://karma-runner.github.io/2.0/index.html">karma</a> + <a href="https://jasmine.github.io/">jasmine</a> , then the examples for you will also be relevant, since there are very few differences in syntax. <br><br><div class="spoiler">  <b class="spoiler_title">Jasmine / jest differences</b> <div class="spoiler_text">  jasmine.createSpy ('name') -&gt; jest.fn () <br>  and.returnValue () -&gt; mockReturnValue () <br>  spyOn (...). and.callFake (() =&gt; {}) -&gt; jest.spyOn (...). mockImplementation (() =&gt; {}) <br></div></div><br>  Consider an example of a service for a modal window.  It has only two methods that should send a specific value to the popupDialog variable.  And absolutely no dependencies. <br><br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ReplaySubject } from <span class="hljs-string"><span class="hljs-string">'rxjs/ReplaySubject'</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PopupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> popupDialog = new ReplaySubject&lt;{popupEvent: string, component?, options?: {}}&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> popupDialog$ = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.popupDialog.asObservable(); <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(component, options?: {}) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.popupDialog.next({popupEvent: <span class="hljs-string"><span class="hljs-string">'open'</span></span>, component: component, options: options}); } close() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.popupDialog.next({popupEvent: <span class="hljs-string"><span class="hljs-string">'close'</span></span>}); } }</code> </pre> <br>  When writing tests, do not forget about the order of execution of the code.  For example, the actions that must be performed before each test, we put in beforeEach. <br>  So, we will need an instance of the service created in the code below for each check. <br><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PopupService } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./popup.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { SignInComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../components/signin/signin.component'</span></span>; describe(<span class="hljs-string"><span class="hljs-string">'PopupService'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { let service: PopupService; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   PopupService beforeEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PopupService(); }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> done ,        it(<span class="hljs-string"><span class="hljs-string">'subscribe for opening works'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   open service.open(SignInComponent, [{title: <span class="hljs-string"><span class="hljs-string">' '</span></span>, message: <span class="hljs-string"><span class="hljs-string">''</span></span>}]); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    popupDialog$   subscribe service.popupDialog$.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(data.popupEvent).toBe(<span class="hljs-string"><span class="hljs-string">'open'</span></span>); done(); }); }); it(<span class="hljs-string"><span class="hljs-string">'subscribe for closing works'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span></span></span><span class="hljs-function"> =&gt;</span></span> { service.close(); service.popupDialog$.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(data.popupEvent).toBe(<span class="hljs-string"><span class="hljs-string">'close'</span></span>); done(); }); }); });</code> </pre> <br><h3>  Angular Test Bed tests </h3><br><h4>  Simple component </h4><br>  And now let's take a look at the full power of the TestBed utility.  As an example, let's start with the simplest component: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Component } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-root'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.css'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span></span>{ title = <span class="hljs-string"><span class="hljs-string">'app'</span></span>; }</code> </pre> <br>  Template file: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The test file will be disassembled in pieces.  To begin with, set the TestBed configuration: <br><br><pre> <code class="hljs lisp"> beforeEach(<span class="hljs-name"><span class="hljs-name">async</span></span>(() =&gt; { TestBed.configureTestingModule({ declarations: [ AppComponent ], }).compileComponents()<span class="hljs-comment"><span class="hljs-comment">; }));</span></span></code> </pre><br>  compileComponents is a method that makes styles and template rendered in separate files embedded. <br><br>  This process is asynchronous, because the Angular compiler must retrieve data from the file system. <br><br><div class="spoiler">  <b class="spoiler_title">Sometimes compileComponents are not needed.</b> <div class="spoiler_text">  If you use WebPack, then you do not need this call and the async method. <br>  The fact is that WebPack automatically embeds external styles and a template before running tests. <br><br>  Accordingly, when writing styles and templates inside a component file, you do not need to compile yourself. <br></div></div><br>  For tests, it is necessary for the components to be compiled before their instances are created through the createComponent () method. <br><br>  Therefore, we placed the body of the first BeforeEach in asyn method, so that its contents are executed in a special asynchronous environment.  And until the compileComponents () method is executed, the following BeforeEach will not start: <br><br><pre> <code class="hljs lisp">beforeEach(() =&gt; { fixture = TestBed.createComponent(<span class="hljs-name"><span class="hljs-name">AppComponent</span></span>)<span class="hljs-comment"><span class="hljs-comment">; comp = fixture.componentInstance; });</span></span></code> </pre><br>  Due to the removal of all common data in beforeEach, the further code is much cleaner. <br><br>  First, let's check the creation of the component instance and its property: <br><br><pre> <code class="hljs coffeescript">it(<span class="hljs-string"><span class="hljs-string">'should create the comp'</span></span>, <span class="hljs-function"><span class="hljs-function">=&gt;</span></span> { expect(comp).toBeTruthy(); }); it(`<span class="javascript"><span class="javascript">should have </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">as</span></span></span><span class="javascript"> title </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'app'</span></span></span></span>`, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(comp.title).toEqual(<span class="hljs-string"><span class="hljs-string">'app'</span></span>); });</code> </pre><br>  Next, we want to check that the variable of the title component is inserted into the DOM.  At the same time, we expect that it is assigned the value of 'app'.  And this assignment occurs when the component is initialized. <br><br>  By running the loop with the detectChanges CD, we initialize the component. <br>  Prior to this call, the connection of DOM and component data will not occur, and therefore tests will not pass. <br><br><pre> <code class="hljs coffeescript"> it(<span class="hljs-string"><span class="hljs-string">'should render title in a h1 tag'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { fixture.detectChanges(); const compiled = fixture.debugElement.nativeElement; expect(compiled.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>).textContent) .toContain(<span class="hljs-string"><span class="hljs-string">'Welcome to app!'</span></span>); });</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Full component test code</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { TestBed, async, ComponentFixture } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core/testing'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { AppComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./app.component'</span></span>; describe(<span class="hljs-string"><span class="hljs-string">'AppComponent'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { let comp: AppComponent; let fixture: ComponentFixture&lt;AppComponent&gt;; beforeEach(async(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { TestBed.configureTestingModule({ declarations: [ AppComponent ], }).compileComponents(); })); beforeEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { fixture = TestBed.createComponent(AppComponent); comp = fixture.componentInstance; }); it(<span class="hljs-string"><span class="hljs-string">'should create the comp'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(comp).toBeTruthy(); }); it(`<span class="javascript"><span class="javascript">should have </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">as</span></span></span><span class="javascript"> title </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'app'</span></span></span></span>`, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(comp.title).toEqual(<span class="hljs-string"><span class="hljs-string">'app'</span></span>); }); it(<span class="hljs-string"><span class="hljs-string">'should render title in a h1 tag'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { fixture.detectChanges(); const compiled = fixture.debugElement.nativeElement; expect(compiled.querySelector(<span class="hljs-string"><span class="hljs-string">'h1'</span></span>).textContent) .toContain(<span class="hljs-string"><span class="hljs-string">'Welcome to app!'</span></span>); }); });</code> </pre> <br></div></div><br><h4>  Component with dependencies </h4><br>  Let's complicate our component by incorporating a service into it: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(private popup: PopupService) { } title = <span class="hljs-string"><span class="hljs-string">'app'</span></span>; }</code> </pre> <br>  It seems to be not particularly complicated, but the tests will not pass.  Even if you didn‚Äôt forget to add the service to the AppModule providers. <br><br>  Because these changes should also be reflected in TestBed: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">TestBed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.configureTestingModule</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">declarations</span></span>: [ AppComponent ], providers: [PopupService] });</code> </pre> <br>  We can specify the service itself, but it is usually better to replace it with a class or an object that describes exactly what we need for the tests. <br><br>  <i>Why?</i> <br><br>  And you imagine a service with a bunch of dependencies and you have to prescribe everything during testing.  Not to mention the fact that we are testing the component in this case.  In general, testing one thing is just about unit tests. <br><br>  So, we write stub as follows: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> popupServiceStub = { <span class="hljs-attr"><span class="hljs-attr">open</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {} };</code> </pre> <br>  Methods we set only those which we test. <br><br><div class="spoiler">  <b class="spoiler_title">If we want to describe stub as a class</b> <div class="spoiler_text"><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">popupServiceStub</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>() {} }</code> </pre><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">providers</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[{provide: PopupService, useClass: popupServiceStub } ]</span></span></code> </pre> <br></div></div><br>  We add providers to TestBed configuration: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">providers</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[{provide: PopupService, useValue: popupServiceStub } ]</span></span></code> </pre> <br>  Do not confuse PopupService and PopupServiceStab.  These are different objects: the first is a clone of the second. <br><br>  Great, but we introduced the service not just like that, but for use: <br><br><pre> <code class="hljs kotlin">ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.popup.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(SignInComponent); }</code> </pre><br>  Now you have to make sure that the method is actually called.  To do this, first get a copy of the service. <br><br>  Since in this case the service is defined in the root module providers, we can do this: <br><br><pre> <code class="hljs swift">popup = <span class="hljs-type"><span class="hljs-type">TestBed</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-type"><span class="hljs-type">PopupService</span></span>);</code> </pre><br><div class="spoiler">  <b class="spoiler_title">How else?</b> <div class="spoiler_text">  If it were a question of a service that is registered in the component providers, you would have to receive it like this: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">popup</span></span> = fixture.<span class="hljs-literal"><span class="hljs-literal">debug</span></span>Element.injector.get(PopupService);</code> </pre> <br></div></div><br>  Finally, the test itself: <br><br><pre> <code class="hljs lisp">it('should called open', () =&gt; { const openSpy = jest.spyOn(<span class="hljs-name"><span class="hljs-name">popup</span></span>, 'open')<span class="hljs-comment"><span class="hljs-comment">; fixture.detectChanges(); expect(openSpy).toHaveBeenCalled(); });</span></span></code> </pre> <br>  Our actions: <br><br><ol><li>  Install the spy on the open method of the popup object. </li><li>  Run the CD loop, during which ngOnInit is executed with the method being tested. </li><li>  Make sure he was called. </li></ol><br>  Notice that we are checking exactly the call to the service method, and not what it returns or other things related to the service itself.  They <s>, in order to preserve sanity,</s> should be tested in service. <br><br><h4>  Service with http </h4><br>  More recently (in Angular 4), the service test file with queries could look truly intimidating. <br><br><div class="spoiler">  <b class="spoiler_title">Remember how it was</b> <div class="spoiler_text"><pre> <code class="hljs lisp">beforeEach(() =&gt; TestBed.configureTestingModule({ imports: [HttpModule], providers: [ MockBackend, BaseRequestOptions, { provide: Http, useFactory: (<span class="hljs-name"><span class="hljs-name">backend</span></span>, defaultOptions) =&gt; new Http(<span class="hljs-name"><span class="hljs-name">backend</span></span>, defaultOptions), deps: [MockBackend, BaseRequestOptions] }, UserService ] }))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br></div></div><br>  However, even now the Internet is full of articles with these examples. <br><br>  Meanwhile, the Angular developers were not idle, and we can now write tests much easier.  Just using <a href="http/testing/HttpClientTestingModule">HttpClientTestingModule</a> and <a href="http/testing/HttpTestingController">HttpTestingController</a> . <br><br>  Consider the service: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HttpClient } from <span class="hljs-string"><span class="hljs-string">'@angular/common/http'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Observable } from <span class="hljs-string"><span class="hljs-string">'rxjs/Observable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ReplaySubject } from <span class="hljs-string"><span class="hljs-string">'rxjs/ReplaySubject'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Game } from <span class="hljs-string"><span class="hljs-string">'../models/gameModel'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { StatisticsService } from <span class="hljs-string"><span class="hljs-string">'./statistics.service'</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameService</span></span></span><span class="hljs-class"> </span></span>{ gameData: Array&lt;Game&gt;; dataChange: ReplaySubject&lt;any&gt;; gamesUrl = <span class="hljs-string"><span class="hljs-string">'https://any.com/games'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> http: HttpClient, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> statisticsService: StatisticsService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataChange = new ReplaySubject(); } getGames() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.makeResponse() .subscribe((games: Array&lt;Game&gt;) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleGameData(games); }); } makeResponse(): Observable&lt;any&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.http.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.gamesUrl); } handleGameData(games) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.gameData = games; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doNext(games); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.statisticsService.send(); } doNext(value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataChange.next(value); } }</code> </pre> <br>  To begin with, we describe all of our global heroes: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> http: HttpTestingController; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> service: GameService; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> statisticsService: StatisticsService; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> statisticsServiceStub = { <span class="hljs-attr"><span class="hljs-attr">send</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {} };</code> </pre><br>  Here from interesting - stab statisticsService.  We, by analogy with the component, will stabilize dependencies, as we are testing only specific services now. <br><br>  As you can see, I just prescribed exactly what is needed in this test.  Just imagine that StatisticsService is actually a huge number of methods and dependencies, and we use only one method in this service. <br><br>  Next, we will announce the data that we will throw in response to the request: <br><br><pre> <code class="hljs pgsql"> const expectedData = [ {id: <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'FirstGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span>}, {id: <span class="hljs-string"><span class="hljs-string">'2'</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'SecondGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span>}, {id: <span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'LastGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'1'</span></span>}, ];</code> </pre><br>  In TestBed, you must import the HttpClientTestingModule and register all services: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">TestBed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.configureTestingModule</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">imports</span></span>: [ HttpClientTestingModule, ], providers: [GameService, { provide: StatisticsService, useValue: statisticsServiceStub }] });</code> </pre> <br>  The next step is to get instances of all the services we need: <br><br><pre> <code class="hljs swift"> service = <span class="hljs-type"><span class="hljs-type">TestBed</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-type"><span class="hljs-type">GameService</span></span>); statisticsService = <span class="hljs-type"><span class="hljs-type">TestBed</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-type"><span class="hljs-type">StatisticsService</span></span>); http = <span class="hljs-type"><span class="hljs-type">TestBed</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-type"><span class="hljs-type">HttpTestingController</span></span>);</code> </pre> <br>  It doesn‚Äôt hurt to immediately check in afterEach that there are no pending requests: <br><br><pre> <code class="hljs coffeescript">afterEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { http.verify(); });</code> </pre> <br>  And go to the tests themselves.  The simplest thing we can check is whether the service has been created.  If you forget to specify any dependency in TestBed, then this test will not pass: <br><br><pre> <code class="hljs lisp"> it('should be created', () =&gt; { expect(<span class="hljs-name"><span class="hljs-name">service</span></span>).toBeTruthy()<span class="hljs-comment"><span class="hljs-comment">; });</span></span></code> </pre> <br>  Then it is more interesting - we check that, with the expected request, we will receive certain data, which we also throw in: <br><br><pre> <code class="hljs lisp">it('should have made one request to GET data from expected URL', () =&gt; { service.makeResponse().subscribe((<span class="hljs-name"><span class="hljs-name">data</span></span>) =&gt; { expect(<span class="hljs-name"><span class="hljs-name">data</span></span>).toEqual(<span class="hljs-name"><span class="hljs-name">expectedData</span></span>)<span class="hljs-comment"><span class="hljs-comment">; }); const req = http.expectOne(service.gamesUrl); expect(req.request.method).toEqual('GET'); req.flush(expectedData); });</span></span></code> </pre> <br>  It doesn‚Äôt hurt to check the ReplaySubject how it works, that is, whether the received games will be tracked by subscribers: <br><br><pre> <code class="hljs coffeescript">it(<span class="hljs-string"><span class="hljs-string">'getGames should emits gameData'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { service.getGames(); service.dataChange.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(data).toEqual(expectedData); }); const req = http.expectOne(service.gamesUrl); req.flush(expectedData); });</code> </pre> <br>  Finally, the last example is checking that the statisticsService send method will be called: <br><br><pre> <code class="hljs lisp"> it('statistics should be sent', () =&gt; { const statisticsSpy = jest.spyOn(<span class="hljs-name"><span class="hljs-name">statisticsService</span></span>, 'send')<span class="hljs-comment"><span class="hljs-comment">; service.handleGameData(expectedData); expect(statisticsSpy).toHaveBeenCalled(); });</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Full test code</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { TestBed } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core/testing'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { GameService } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./game.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HttpClientTestingModule, HttpTestingController } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/common/http/testing'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { StatisticsService } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statistics.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'rxjs/add/observable/of'</span></span>; describe(<span class="hljs-string"><span class="hljs-string">'GameService'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { let http: HttpTestingController; let service: GameService; let statisticsService: StatisticsService; const statisticsServiceStub = { send: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {} }; const expectedData = [ {id: <span class="hljs-string"><span class="hljs-string">'1'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'FirstGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, type: <span class="hljs-string"><span class="hljs-string">'2'</span></span>}, {id: <span class="hljs-string"><span class="hljs-string">'2'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'SecondGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, type: <span class="hljs-string"><span class="hljs-string">'3'</span></span>}, {id: <span class="hljs-string"><span class="hljs-string">'3'</span></span>, name: <span class="hljs-string"><span class="hljs-string">'LastGame'</span></span>, locale: <span class="hljs-string"><span class="hljs-string">'en'</span></span>, type: <span class="hljs-string"><span class="hljs-string">'1'</span></span>}, ]; beforeEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { TestBed.configureTestingModule({ imports: [ HttpClientTestingModule, ], providers: [GameService, { provide: StatisticsService, useValue: statisticsServiceStub }] }); service = TestBed.get(GameService); statisticsService = TestBed.get(StatisticsService); http = TestBed.get(HttpTestingController); }); afterEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { http.verify(); }); it(<span class="hljs-string"><span class="hljs-string">'should be created'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(service).toBeTruthy(); }); it(<span class="hljs-string"><span class="hljs-string">'should have made one request to GET data from expected URL'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { service.makeResponse().subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(data).toEqual(expectedData); }); const req = http.expectOne(service.gamesUrl); expect(req.request.method).toEqual(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>); req.flush(expectedData); }); it(<span class="hljs-string"><span class="hljs-string">'getGames should emits gameData'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { service.getGames(); service.dataChange.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { expect(data).toEqual(expectedData); }); const req = http.expectOne(service.gamesUrl); req.flush(expectedData); }); it(<span class="hljs-string"><span class="hljs-string">'statistics should be sent'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { const statisticsSpy = jest.spyOn(statisticsService, <span class="hljs-string"><span class="hljs-string">'send'</span></span>); service.handleGameData(expectedData); expect(statisticsSpy).toHaveBeenCalled(); }); });</code> </pre> <br></div></div><br><h2>  How to facilitate testing? </h2><br><ol><li>  Choose the type of tests that is appropriate in this situation and do not forget about the essence of the unit tests. </li><li>  Make sure you know all the capabilities of your IDE in testing assistance. </li><li>  When generating entities using Angular-cli, the test file is automatically generated </li><li>  If a component has many dependencies such as directives and child components, then you can disable checking their definitions.  To do this, we set up the NO_ERRORS_SCHEMA in the TestBed configuration: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">TestBed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.configureTestingModule</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">declarations</span></span>: [ AppComponent ], schemas: [ NO_ERRORS_SCHEMA ] })</code> </pre> </li></ol><br><h2>  Without epilogue can not do </h2><br>  To cover all the points in one article, so that it does not become frightening (a la <a href="https://angular.io/guide/testing">documentation</a> ), it is quite difficult.  But it seems to me that the main thing is to understand what tools you have and what to do with them, and then you will fearlessly come across in practice both banal and non-trivial cases. <br><br>  If after reading the article you have become something a little clearer - hurray! <br>  Do you have anything to add?  Do you disagree with something? <br><br>  Well, maybe, for the sake of your valuable comments, this article was started. <br><br>  PS Oh yes, here is a link to all the <a href="https://stackblitz.com/github/Sluchaika/angular-testing-examples">examples</a> . <br><br>  Also for all those interested in Angular, the Russian Angular <a href="http://t.me/angular_ru">community in a telegram</a> can be useful. </div><p>Source: <a href="https://habr.com/ru/post/349380/">https://habr.com/ru/post/349380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349370/index.html">How I adjusted Telegram notifications for Mi Band 2</a></li>
<li><a href="../349372/index.html">How is Alice. Yandex lecture</a></li>
<li><a href="../349374/index.html">Script Editor Age of Empires 2 can be turned into a Turing machine</a></li>
<li><a href="../349376/index.html">Game development for NES in C. Chapters 11-13. We write and debug a simple platformer</a></li>
<li><a href="../349378/index.html">Security Operations: protection against cyber threats in ServiceNow</a></li>
<li><a href="../349382/index.html">DigiCert bought Symantec Website Security: implications for users of SSL / TLS certificates</a></li>
<li><a href="../349384/index.html">The slowest way to speed up a program on Go</a></li>
<li><a href="../349386/index.html">Team Leader. To be or not to be, that is the question</a></li>
<li><a href="../349388/index.html">We forward Steam API calls from Wine to GNU / Linux and back with Nim</a></li>
<li><a href="../349392/index.html">Sublime Text 3 is alive. (Setup and operation)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>