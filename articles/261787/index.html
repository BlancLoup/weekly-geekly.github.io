<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote injection of Wi-Fi frames</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The standard WiFi 802.11n uses a frame aggregation mechanism to reduce the overhead of data transfer. 
 To do this, several frames are combined into o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote injection of Wi-Fi frames</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/69a/7d5/574/69a7d5574321f3d1af4016ac2bdafeef.gif" alt="image"><br><br>  The standard WiFi 802.11n uses a frame aggregation mechanism to reduce the overhead of data transfer. <br>  To do this, several frames are combined into one.  In this case, the frame separator marker is transmitted along with the data. <br>  This allows you to generate data that, when passing through a WiFi device, will be interpreted by it as separate frames. <br><br>  That is, having control over the flow of data transmitted from the server to the client (for example, when downloading a file from the attacker's server) or from client to server, you can generate arbitrary packets at all OSI levels: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Package with any RadioTap headers: <b>Beacon, Probe Request / Respone, Deauthentication</b> </li><li>  L2 level: specify <b>any MAC address</b> in the packet headers, ARP spoofing can be performed </li><li>  L3 / L4 level: make <b>any TCP / UDP / ICMP packet with any IP headers</b> </li><li>  and so on </li></ul><br><br>  <b>Only open 802.11n networks</b> are vulnerable. <br><a name="habracut"></a><br><br>  <i>Scheme PHY frame with injection</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/127/fa0/aa5/127fa0aa575159167e5662cbcc53049c.png" alt="image"><br><br>  As you can see, the frame delimiter (A-MPDY delimiter) is placed directly into the payload with user data, so when the receiving party receives such a frame, it will be de-aggregated and our sequence will be perceived by the operating system as a separate packet. <br><br>  More details about the vulnerability can be found in the report <a href="https://github.com/rpp0/aggr-inject/raw/master/paper/ampdu_inj_wisec2015.pdf">Injection Attacks on 802.11n MAC Frame Aggregation</a> <br><br>  Code to exploit the <a href="https://github.com/rpp0/aggr-inject">github.com/rpp0/aggr-inject</a> vulnerability <br><br>  The payload-generating script is aggr-inject.py. <br>  For the injection of frames from the access point to the client, it is proposed to generate a jpg file that will download the victim (as in the picture in the post header).  In the opposite direction, from the client to the point, it is proposed to send a special generated POST request to the attacker's web server. <br>  The type of data being transferred does not matter, it is enough to be able to create an attack-driven data stream.  In this case, HTTP is taken as the simplest example.  At the same time, it is important that the data be transmitted unchanged to the wifi chip itself, therefore the data must be transmitted over an open channel (HTTPS is not suitable), not subjected to processing, compression. <br><br>  The simplest example of demonstrating a vulnerability is the sending of broadcast beacon frames.  The beacons that the access point sends, indicating its network name (SSID). <br><br>  File that injects beacons with the network name ‚Äúinjected SSID‚Äù <a href="">aggr_beacon.jpg</a> <b>250MB</b> <br><br>  Most likely, you will not see the new network in the list of available Wi-Fi networks, since most operating systems use active scanning, and show only the networks that answered them at the probe request.  Therefore, passive scanning is necessary to see the packet injection. <br><br>  By the way, for those who use Mac OS, you can dump WiFi traffic with your own airport.  I recommend my <a href="https://github.com/zhovner/airport-sniffer">airport-sniffer tool</a> for this.  The dump will be found in /tmp/airportXXXX.cap <br><br>  My test bench is identical to the image in the post title.  The malicious file is downloaded by the tablet, the dumper is launched on a laptop connected to the same TL-MR3020 access point with openwrt 12.09 firmware.  Also, the injection is successfully reproduced using the tl-wn821n USB adapter. <br><br>  Here are the packages caught by the laptop: <br><br><div class="spoiler">  <b class="spoiler_title">tcpdump -e -r /tmp/airport.pcap type mgt subtype beacon</b> <div class="spoiler_text"><pre><code class="bash hljs">13:33:11.317916 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317916 4269971522us tsft bad-fcs -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [1.0* 35.0 23.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317917 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317918 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317919 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317921 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317922 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:11.317923 4269971522us tsft -84dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:00:00:00:00:00:00 (oui Ethernet) DA:Broadcast SA:00:00:00:00:00:00 (oui Ethernet) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1 13:33:12.876472 4271529509us tsft bad-fcs -85dB noise antenna 0 2462 MHz 11g ht/20 72.2 Mb/s MCS 7 20 MHz short GI greenfield BCC FEC BSSID:18:00:00:00:00:00 (oui Unknown) DA:Broadcast SA:1c:e9:87:8a:54:36 (oui Unknown) Beacon (injected SSID) [6.0 9.0 12.0 18.0 24.0 36.0 48.0 54.0 Mbit] ESS CH: 1</code> </pre> <br></div></div><br>  By timing, it can be seen that the injections occur very cheerfully. <br><br>  In order to conduct a real attack, you need to climb the L2 and L3 levels, that is, you need to know the MAC address of the access point, in some cases the MAC address of the client, the IP address of clients for NAT.  Therefore, to exploit the vulnerability in real conditions is extremely difficult.  The maximum is to send a deauth packet and disconnect all clients from the network. <br><br>  I managed to successfully inject TCP packets and I tried to crawl onto the TCP port of the client behind the NAT, trying to create a broadcast in nf_conntrack that passed my packets to the client.  But I did not succeed.  If you send a SYN client on behalf of a remote host, its SYN-ACK response does not create a broadcast and cannot be answered from the world.  If you send a SYN client to the world and respond to it, even if you create a broadcast on a router in the ESTABLISHED state, the new SYN from the world sent to the client will be discarded.  Even fantasies on this topic have broken about the problem of guessing the seqence number.  Although, maybe I‚Äôm just loshara and you will succeed. <br><br>  This can be successfully rotated with UDP.  Also in the examples there is a way to scan hosts for NAT by sending icmp. </div><p>Source: <a href="https://habr.com/ru/post/261787/">https://habr.com/ru/post/261787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261777/index.html">Batcher's even-odd merge sort</a></li>
<li><a href="../261779/index.html">Express analysis of suspicious activity in the web server log</a></li>
<li><a href="../261781/index.html">About the intricacies of privacy in the Telegram Bots API: ‚Äúthis is not a bug, this is a feature‚Äù</a></li>
<li><a href="../261783/index.html">Vim in full: Working with Git</a></li>
<li><a href="../261785/index.html">Seven amazing "features" Javascript</a></li>
<li><a href="../261789/index.html">And do not you go to the clouds?</a></li>
<li><a href="../261799/index.html">Receive notifications from external services, or why Hooksler was made</a></li>
<li><a href="../261801/index.html">Introducing Nim: writing a console 2048</a></li>
<li><a href="../261803/index.html">Magic of tensor algebra: Part 4 - Dynamics of a point in a tensor statement</a></li>
<li><a href="../261807/index.html">STM32, C ++ and FreeRTOS. Development from scratch. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>