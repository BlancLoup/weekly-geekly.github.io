<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bur. Module for mass registration of users</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. In working on one project, it took about 50,000 users to register from a CSV file, with user names, passwords, and other information. Exist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bur. Module for mass registration of users</h1><div class="post__text post__text-html js-mediator-article">  Greetings.  In working on one project, it took about 50,000 users to register from a CSV file, with user names, passwords, and other information.  <a href="https://drupal.org/project/user_import">Existing solutions</a> did not fit due to too little customization.  I had to write my ‚Äúbicycle‚Äù.  Then came the idea to share with the community.  The publication on Drupal.org is a rather complicated procedure, so I decided to write on Habr.  As it turned out, my "bicycle" is suitable for a specific task, but not universal.  I had to "pokumekat" a little how and what to do.  So, I present the module BUR (Bulk user registration) <a name="habracut"></a><br><br>  Module features: <br><br>  1. Setting the file format: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e80/18d/1c6/e8018d1c652aca91066254f0b390cf12.gif" alt="image"><br><br>  2. Sort fields for the imported file: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c1e/ea7/72d/c1eea772d675e4417e693d78bae10567.gif"><br><br>  3. Actually import itself: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2db/c2f/cfa/2dbc2fcfaf79f3d236709f015030d356.gif"><br><br><h5>  How does the module work? </h5><br>  There is a table with the following structure: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`drupal7_bur_fields_table`</span></span> ( <span class="hljs-string"><span class="hljs-string">`bur_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Field ID'</span></span>, <span class="hljs-string"><span class="hljs-string">`bur_title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Human-friendly title'</span></span>, <span class="hljs-string"><span class="hljs-string">`bur_user_field`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'The field of conformance to the field in the user table'</span></span>, <span class="hljs-string"><span class="hljs-string">`bur_weight`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'The serial number of the field'</span></span>, <span class="hljs-string"><span class="hljs-string">`bur_is_data`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Whether the field will be used in array '</span></span><span class="hljs-keyword"><span class="hljs-keyword">data</span></span><span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`bur_dateizm`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Date of change'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`bur_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`bur_weight`</span></span> (<span class="hljs-string"><span class="hljs-string">`bur_weight`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`bur_is_data`</span></span> (<span class="hljs-string"><span class="hljs-string">`bur_is_data`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br><br>  This table contains information about the structure of the imported file.  Namely: <br><ol><li>  Correspondence of the fields in the file to the corresponding field from the user table; </li><li>  The order of these fields in the file; </li></ol><br><br>  Also, any field of the file can be placed in the $ edit ['data'] array.  To do this, when creating the field, select ‚Äúdata‚Äù and indicate the key / name under which information will be added: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/02b/407/582/02b40758218cbf1c0cb85af533df0a23.gif"><br><br>  When you first import a file, a temporary table is created corresponding to the structure of this file. <br>  Then through the <a href="https://api.drupal.org/api/drupal/modules%2521user%2521user.module/function/user_save/7">user_save</a> function using the Batch API, users are registered in the system.  If the file is not specified, then previously added records from the temporary table will be added. <br><br>  When importing it is possible to specify additional parameters used when creating new users: <br><img src="https://habrastorage.org/getpro/habr/post_images/093/6d1/19a/0936d119aef082962419bad7ef0cca17.gif"><br><br>  Oh yes!  The encoding of the source file should be, for now, only in UTF-8.  Passwords must <b>not</b> be <b>hashed</b> .  If you want to use hashed passwords with salt, you can take the code of the user_save function and ‚Äúthrow out‚Äù the code from there, which hashes and adds ‚Äúsalt‚Äù to the password. <br><br>  The module can be downloaded <a href="https://github.com/servekon/drupal7-bur">here</a> .  Especially for this created an account on Git Hub.  The truth has not yet figured out how to download the module files separately so that you can view the source code.  Let's leave it for tomorrow. <br><br>  If you think so, then this module with small changes can be used to ‚Äúfill‚Äù data in other tables. <br><div class="spoiler">  <b class="spoiler_title">Module source code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// $Id: bur.module,v 1.0 2013/05/01 00:30:25 servekon Exp $ /** * Implementation of hook_permission * */ function bur_permission(){ return array( 'access bur' =&gt; array( 'title' =&gt; t('Access to Bulk user registration module'), 'restrict access' =&gt; TRUE, ), 'administer bur' =&gt; array( 'title' =&gt; t('Administer of the Bulk user registration module'), 'restrict access' =&gt; TRUE, ), ); } /** * Implementation of hook_menu * */ function bur_menu() { /* * Administration interface * */ $menu['admin/bur'] = array( 'title' =&gt; 'Bulk user registration', 'page callback' =&gt; 'drupal_get_form', 'page arguments' =&gt; array('bur_import_form'), 'access arguments' =&gt; array('administer bur'), ); $menu['admin/bur/import'] = array( 'title' =&gt; 'Import', 'type' =&gt; MENU_DEFAULT_LOCAL_TASK, 'weight' =&gt; -1, ); $menu['admin/bur/fields'] = array( 'title' =&gt; 'Customize Fields', 'page callback' =&gt; 'drupal_get_form', 'page arguments' =&gt; array('bur_sort_form'), 'access arguments' =&gt; array('administer bur'), 'type' =&gt; MENU_LOCAL_TASK, 'weight' =&gt; 1, ); $menu['admin/bur/fields/add'] = array( 'title' =&gt; 'Add field', 'page callback' =&gt; 'drupal_get_form', 'page arguments' =&gt; array('bur_add_field_form'), 'access arguments' =&gt; array('administer bur'), 'type' =&gt; MENU_LOCAL_ACTION, 'weight' =&gt; 1, ); $menu['admin/bur/fields/del/%'] = array( 'title' =&gt; 'Delete field', 'page callback' =&gt; 'bur_del_field', 'page arguments' =&gt; array(4), 'access arguments' =&gt; array('administer bur'), 'type' =&gt; MENU_CALLBACK, 'weight' =&gt; 2, ); $menu['admin/bur/file_format'] = array( 'title' =&gt; 'The setting for the file format', 'page callback' =&gt; 'drupal_get_form', 'page arguments' =&gt; array('bur_file_format_form'), 'access arguments' =&gt; array('administer bur'), 'type' =&gt; MENU_LOCAL_TASK, 'weight' =&gt; 2, ); return $menu; } /** * Implements hook_theme(). */ function bur_theme() { return array( // Theme function for the 'simple' example. 'bur_sort_form' =&gt; array( 'render element' =&gt; 'form', ), ); } /** * Import form * */ function bur_import_form($form=array(), &amp;$form_state){ $count = 0; //~ Get all language $lanArr = array(); $langList = language_list(); $langArr = array(t('No')); foreach($langList as $lang){ $langArr[$lang-&gt;language] = $lang-&gt;native; } //~ Get timezones $timeZoneList = system_time_zones(); array_unshift($timeZoneList, t('No')); //~ Get user roles $userRoleList = $tblUser = array(); $userRoleList = user_roles(); array_unshift($userRoleList, t('No')); if(db_table_exists('bur_bulk_user_reg_tmp')){ $tblUser = db_select('bur_bulk_user_reg_tmp', 't') -&gt;fields('t') -&gt;range(0, 10) -&gt;orderRandom() -&gt;execute(); foreach($tblUser as $item){ unset($item-&gt;random_field); $rangeTmp[] = (array)$item; } $count = db_select('bur_bulk_user_reg_tmp') -&gt;countQuery() -&gt;execute() -&gt;fetchField(); } if($count &gt; 0){ drupal_set_message(t('%time left', array('%time'=&gt;$count)).'.', 'warning', false); } $form['bur_bulk_user_reg_file'] = array( '#type' =&gt; 'file', '#title' =&gt; t('Choose a file'), '#size' =&gt; 40, '#weight' =&gt; 1, ); $form['bur_bulk_user_reg_rebuild'] = array( '#type' =&gt; 'checkbox', '#title' =&gt; t('Re-create a temporary table'), '#return_value' =&gt; 1, '#weight' =&gt; 2, ); $form['bur_bulk_user_reg_count'] = array( '#type' =&gt; 'select', '#title' =&gt; t('Number of entries to be processed per pass'), '#options' =&gt; array( 0 =&gt; t('No'), 10 =&gt; '10', 100 =&gt; '100', 750 =&gt; '750', 1500 =&gt; '1500', 2000 =&gt; '2000', 2500 =&gt; '2500', 3000 =&gt; '3000', 3500 =&gt; '3500', 4000 =&gt; '4000', 4500 =&gt; '4500', 5000 =&gt; '5000', 7500 =&gt; '7500', 10000 =&gt; '10000', 15000 =&gt; '15000', 20000 =&gt; '20000', ), '#default_value' =&gt; (int)(isset($_COOKIE['bur_quantity']) ? $_COOKIE['bur_quantity'] : '10000'), '#description' =&gt; t('Select "No", if you just need to create a temporary table and fill it with data.'), '#weight' =&gt; 3, ); $form['bur_extra'] = array( '#type' =&gt; 'fieldset', '#title' =&gt; t('Additional settings for all users'), '#weight' =&gt; 5, '#collapsible' =&gt; TRUE, '#collapsed' =&gt;FALSE, ); $form['bur_extra']['bur_extra_set_all_active'] = array( '#type' =&gt; 'checkbox', '#title' =&gt; t('Account activation'), '#return_value' =&gt; 1, '#default_value' =&gt; (int)(isset($_COOKIE['bur_isactive']) ? $_COOKIE['bur_isactive'] : 0), '#weight' =&gt; 2, ); $form['bur_extra']['bur_extra_user_role'] = array( '#type' =&gt; 'select', '#title' =&gt; t('User roles and permissions'), '#options' =&gt; $userRoleList, '#default_value' =&gt; (int)(isset($_COOKIE['bur_user_role']) ? $_COOKIE['bur_user_role'] : 0), '#weight' =&gt; 3, ); $form['bur_extra']['bur_extra_lang'] = array( '#type' =&gt; 'select', '#title' =&gt; t('Default language'), '#options' =&gt; $langArr, '#default_value' =&gt; check_plain((isset($_COOKIE['bur_lang']) ? $_COOKIE['bur_lang'] : 0)), '#weight' =&gt; 4, ); $form['bur_extra']['bur_extra_timezone'] = array( '#type' =&gt; 'select', '#title' =&gt; t('Timezone'), '#options' =&gt; $timeZoneList, '#default_value' =&gt; check_plain((isset($_COOKIE['bur_timezone']) ? $_COOKIE['bur_timezone'] : 'Europe/Moscow')), '#weight' =&gt; 5, ); if($count &gt; 0){ $form['bur_ten_random'] = array( '#type' =&gt; 'fieldset', '#title' =&gt; t('Ten random records'), '#weight' =&gt; 7, '#collapsible' =&gt; TRUE, '#collapsed' =&gt;TRUE, ); $form['bur_ten_random']['bur_ten_random_table'] = array( '#type' =&gt; 'item', '#title' =&gt; '', '#prefix' =&gt; '&lt;div&gt;'.theme('table', array('header'=&gt;array_keys($rangeTmp[0]),'rows'=&gt;$rangeTmp)).'&lt;/div&gt;', ); } $form['submit'] = array( '#type' =&gt; 'submit', '#value' =&gt; t('Save and continue'), '#weight' =&gt; 10, ); $form['bur_cancel'] = array( '#type' =&gt; 'link', '#title' =&gt; t('Cancel'), '#href' =&gt; 'admin/bur', '#weight' =&gt; 11, ); return $form; } function bur_import_form_submit($form, &amp;$form_state){ module_load_install('user'); $usFieldStuct = user_schema(); $usFieldStuct = $usFieldStuct['users']; $tblBulk = 'bur_bulk_user_reg_tmp'; $file = $_FILES['files']['tmp_name']['bur_bulk_user_reg_file']; $tblUser = array(); $quantity = (int)$form_state['values']['bur_bulk_user_reg_count']; setcookie('bur_quantity', $quantity); $recreate = (int)$form_state['values']['bur_bulk_user_reg_rebuild']; $isActive = (int)$form_state['values']['bur_extra_set_all_active']; setcookie('bur_isactive', $isActive); $userRole = (int)$form_state['values']['bur_extra_user_role']; setcookie('bur_user_role', $userRole); $lang = $form_state['values']['bur_extra_lang']; setcookie('bur_lang', $lang); $timezone = $form_state['values']['bur_extra_timezone']; setcookie('bur_timezone', $timezone); $pref = ''; $termArr = array( 0 =&gt; '\\t', 1 =&gt; ';', 2 =&gt; ',', 3 =&gt; '|', 4 =&gt; '^', ); $enclArr = array( 0 =&gt; '\\\'', 1 =&gt; '\\\'\\\'', 2 =&gt; '"', 3 =&gt; '%%', ); $lineTerArr = array( 0 =&gt; '\\r\\n', 1 =&gt; '\\n', 2 =&gt; '\\r', ); $escdArr = array('\\\\'); $schema['fields']['id'] = array('type' =&gt; 'serial', 'size' =&gt; 'big', 'not null' =&gt; TRUE, 'description'=&gt; "Bur fields ID"); $burquery = db_query('SELECT `bur_user_field`, `bur_is_data` FROM {bur_fields_table} ORDER BY `bur_weight` ASC'); foreach($burquery as $field){ if($field-&gt;bur_is_data &gt; 0){ $pref = 'is_data_'; } else{ $pref = ''; } $burFields[$field-&gt;bur_user_field] = $pref.$field-&gt;bur_user_field; $burArrField[] = '`'.$field-&gt;bur_user_field.'`'; if($field-&gt;bur_is_data == 0){ $schema['fields'][$field-&gt;bur_user_field] = $usFieldStuct['fields'][$field-&gt;bur_user_field]; if(isset($usFieldStuct['indexes'][$field-&gt;bur_user_field])){ $schema['indexes'][$field-&gt;bur_user_field] = $usFieldStuct['indexes'][$field-&gt;bur_user_field]; } } else{ $schema['fields'][$field-&gt;bur_user_field] = array('type' =&gt; 'varchar', 'size' =&gt; 'normal', 'not null' =&gt; TRUE, 'length' =&gt; 255); } } $schema['unique keys']['name'] = array ('name'); $schema['primary key'] = array('id'); //Create table from fields config if(!db_table_exists($tblBulk) or ($recreate &gt;0 and db_table_exists($tblBulk))){ try{ db_drop_table($tblBulk); db_create_table($tblBulk, $schema); } catch(Exception $e){ watchdog_exception('error', $e); drupal_set_message(t('Error'), 'warning'); return false; } } elseif(!empty($file)){ db_truncate($tblBulk)-&gt;execute(); } //Import data from CSV file if(!empty($file)){ try{ $terminated = (int)variable_get('bur_fields_terminated', '\t'); $enclosed = (int)variable_get('bur_fields_enclosed', '"'); $escaped = (int)variable_get('bur_fields_escaped', '\\'); $line_term = (int)variable_get('bur_lines_terminated', '\r\n'); $q = 'LOAD DATA LOCAL INFILE :file INTO TABLE {'.check_plain($tblBulk).'} CHARACTER SET utf8 FIELDS TERMINATED BY \''.$termArr[$terminated].'\' ENCLOSED BY \''.$enclArr[$enclosed].'\' ESCAPED BY \''.$escdArr[$escaped].'\' LINES TERMINATED BY \''.$lineTerArr[$line_term].'\' ('.implode(',', $burArrField).')'; db_query($q, array(':file'=&gt;$file), array(PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; 1)); } catch(Exception $e){ watchdog_exception('error', $e); drupal_set_message('When importing file the error occurred. More information in '.l('syslog','admin/reports/dblog').'.'.'&lt;br /&gt;'.$e-&gt;getMessage(), 'error', FALSE); return false; } } //~ debug($q); //Clear importing data db_query('DELETE a.* FROM {'.$tblBulk.'} as a INNER JOIN {users} as u on a.name=u.name'); $tblUser = db_select($tblBulk, 't') -&gt;fields('t') -&gt;range(0, $quantity) -&gt;execute(); $count = $tblUser-&gt;rowCount(); $newAcc = (object)array('is_new'=&gt;true); if($quantity == 0){ drupal_set_message(t('Registration of new users is missed.'), 'warning', FALSE); return false; } if($count &gt; 0){ foreach($tblUser as $val){ $newUser = array(); foreach($burFields as $bKey=&gt;$bval){ if(substr($bval, 0, 7) == 'is_data'){ $newUser['data'][$bKey] = $val-&gt;$bKey; } else{ $newUser[$bKey] = $val-&gt;$bKey; } } unset($bKey,$bVal); if(!empty($isActive)){ $newUser['status'] = $isActive; } if(!empty($lang)){ $newUser['language'] = check_plain($lang); } if(!empty($timezone)){ $newUser['timezone'] = check_plain($timezone); } if(!empty($userRole)){ $newUser['roles'] = array($userRole =&gt; $userRole); } $operations[] = array('user_save', array($newAcc, $newUser)); } unset($val,$newUser,$tblUser); $batch = array( 'operations' =&gt; $operations, ); batch_set($batch); } else{ drupal_set_message(t('Table is empty.'), 'error', FALSE); return false; } } /** * Manage fields form * */ function bur_sort_form($form_state){ $form['bur_fields']['#tree'] = true; $yesno = array(0=&gt;t('No'), 1=&gt;t('Yes')); $result = db_query('SELECT bur_id, bur_title, bur_user_field, bur_is_data,bur_weight FROM {bur_fields_table} ORDER BY bur_weight ASC'); foreach($result as $field){ $form['bur_fields'][$field-&gt;bur_id]=array( 'user_field' =&gt; array( '#markup' =&gt; check_plain($field-&gt;bur_user_field) ), 'title' =&gt; array( '#type' =&gt; 'textfield', '#default_value' =&gt; check_plain($field-&gt;bur_title), '#size' =&gt; 20, '#maxlength' =&gt; 255, ), 'is_data' =&gt;array( '#markup' =&gt; $yesno[$field-&gt;bur_is_data] ), 'actions' =&gt;array( '#markup' =&gt; l(t('Delete'), 'admin/bur/fields/del/'.$field-&gt;bur_id) ), 'weight' =&gt; array( '#type' =&gt; 'weight', '#title' =&gt; t('Weight'), '#default_value' =&gt; $field-&gt;bur_weight, '#delta' =&gt; 10, '#title-display' =&gt; 'invisible', ), ); } $form['actions'] = array('#type' =&gt; 'actions'); $form['actions']['submit'] = array('#type' =&gt; 'submit', '#value' =&gt; t('Save settings')); return $form; } function theme_bur_sort_form($variables) { $form = $variables['form']; // Initialize the variable which will store our table rows. $rows = array(); // Iterate over each element in our $form['example_items'] array. foreach (element_children($form['bur_fields']) as $id) { $form['bur_fields'][$id]['weight']['#attributes']['class'] = array('bur-field-weight'); $rows[] = array( 'data' =&gt; array( // Add our 'user_field' column. drupal_render($form['bur_fields'][$id]['user_field']), // Add our 'title' column. drupal_render($form['bur_fields'][$id]['title']), drupal_render($form['bur_fields'][$id]['is_data']), drupal_render($form['bur_fields'][$id]['actions']), // Add our 'weight' column. drupal_render($form['bur_fields'][$id]['weight']), ), 'class' =&gt; array('draggable'), ); } $header = array(t('Field of user table'), t('Title'), t('Is optional field'), t('Actions'), t('Weight')); $table_id = 'bur-fields-table'; // We can render our tabledrag table for output. $output = theme('table', array( 'header' =&gt; $header, 'rows' =&gt; $rows, 'attributes' =&gt; array('id' =&gt; $table_id), )); // And then render any remaining form elements (such as our submit button). $output .= drupal_render_children($form); drupal_add_tabledrag($table_id, 'order', 'sibling', 'bur-field-weight'); return $output; } /** * Bulk user registration sort form submit * */ function bur_sort_form_submit($form, &amp;$form_state){ foreach ($form_state['values']['bur_fields'] as $id =&gt; $field) { db_update('bur_fields_table') -&gt;fields(array( 'bur_title' =&gt; check_plain($field['title']), 'bur_weight'=&gt; $field['weight'] )) -&gt;condition('bur_id', (int)$id) -&gt;execute(); } } /** * Form for add new field * */ function bur_add_field_form($form=array(), &amp;$form_state){ $fields = $weightArr = array(); for($i=0; $i&lt;20; $i++){ $weightArr[$i] = $i; } try{ $getFields = db_query('SHOW COLUMNS FROM {users}'); $extFields = db_query('SELECT `bur_user_field` as field FROM {bur_fields_table}'); $maxWeight = db_query('SELECT MAX(`bur_weight`) as m FROM {bur_fields_table}')-&gt;fetchObject(); foreach ($getFields as $field){ $fields[$field-&gt;Field] = $field-&gt;Field; } foreach($extFields as $extField){ $noFields[$extField-&gt;field] = $extField-&gt;field; } //Allow add only previously unmounted fields $diffFields = array_diff($fields, $noFields); } catch(Exception $e){ watchdog_exception('error', $e); drupal_set_message(t('Error'), 'warning'); return false; } $form['user_field']=array( '#type' =&gt; 'select', '#title' =&gt; t('Field of user table'), '#required' =&gt; TRUE, '#options' =&gt; $diffFields, '#ajax' =&gt; array( 'callback' =&gt; 'bur_is_data_callback', 'wrapper' =&gt; 'user-data-wrapper', 'event' =&gt; 'change', 'method' =&gt; 'replace', ), ); $form['data_field']=array( '#prefix' =&gt; '&lt;div id="user-data-wrapper"&gt;', '#suffix' =&gt; '&lt;/div&gt;', ); if(isset($form_state['input']['user_field']) and $form_state['input']['user_field'] == 'data'){ $form['data_field'] = array( '#type' =&gt; 'textfield', '#title' =&gt; t('Name of user variable'), '#required' =&gt; TRUE, '#size' =&gt; 50, '#prefix' =&gt; '&lt;div id="user-data-wrapper"&gt;', '#suffix' =&gt; '&lt;/div&gt;', ); } $form['title']=array( '#type' =&gt; 'textfield', '#title' =&gt; t('Title'), '#required' =&gt; TRUE, '#size' =&gt; 50, ); $form['weight']=array( '#type' =&gt; 'select', '#title' =&gt; t('Weight'), '#required' =&gt; TRUE, '#default_value' =&gt; ($maxWeight-&gt;m+1), '#options' =&gt; $weightArr, ); $form['submit']=array( '#type' =&gt; 'submit', '#value' =&gt; t('Add field'), ); $form['bur_cancel'] = array( '#type' =&gt; 'link', '#title' =&gt; t('Cancel'), '#href' =&gt; 'admin/bur', ); return $form; } /** * Ajax function for choose type field * */ function bur_is_data_callback($form, $form_state){ return $form['data_field']; } function bur_add_field_form_submit($form, &amp;$form_state){ form_state_values_clean($form_state); $q = $form_state['values']; $isData = 0; $field = check_plain($q['user_field']); if(!empty($q['data_field'])){ $isData = 1; $field = check_plain($q['data_field']); } try{ $ins = db_insert('bur_fields_table')-&gt;fields(array( 'bur_title' =&gt; $q['title'], 'bur_user_field' =&gt; $field, 'bur_weight' =&gt; (int)$q['weight'], 'bur_is_data' =&gt; $isData, ))-&gt;execute(); drupal_set_message(t('Field added.'), 'status'); return true; } catch(Exception $e){ watchdog_exception('error', $e); drupal_set_message(t('Error'), 'warning'); return false; } } /** * Delete field * */ function bur_del_field($id){ return drupal_render(drupal_get_form('bur_del_field_form', $id)); } /** * Delete field form * */ function bur_del_field_form($form=array(), &amp;$form_state, $id){ $field = db_query('SELECT `bur_title` FROM {bur_fields_table} WHERE bur_id = :id LIMIT 0,1', array(':id'=&gt;$id))-&gt;fetchObject(); $form['del_id']=array( '#type' =&gt; 'hidden', '#value' =&gt; (int)$id, ); $form['confirm']=array( '#type' =&gt; 'item', '#markup' =&gt; t('Do you want to remove a field "%field"?', array('%field'=&gt;(isset($field-&gt;bur_title) ? $field-&gt;bur_title : ''))), ); $form['submit'] = array( '#type' =&gt; 'submit', '#value' =&gt; t('Yes'), ); $form['bur_cancel'] = array( '#type' =&gt; 'link', '#title' =&gt; t('Cancel'), '#href' =&gt; 'admin/bur', ); return $form; } /** * Delete field form submit * */ function bur_del_field_form_submit($form, &amp;$form_state){ $id = $form_state['values']['del_id']; try{ db_delete('bur_fields_table')-&gt;condition('bur_id', $id)-&gt;execute(); drupal_set_message(t('Field deleted.')); } catch(Exception $e){ watchdog_exception('error', $e); drupal_set_message(t('Error'), 'warning'); return false; } drupal_goto('admin/bur/fields'); } /** * Seettings of file format * */ function bur_file_format_form($form=array()){ $form['bur_fields_terminated']=array( '#type' =&gt; 'select', '#title' =&gt; t('The field separator'), '#default_value' =&gt; (int)variable_get('bur_fields_terminated', 0), '#size' =&gt; 1, '#options' =&gt; array( 0 =&gt; 'TAB', 1 =&gt; ';', 2 =&gt; ',', 3 =&gt; '|', 4 =&gt; '^', ), //'#description' =&gt; t('Possible values: ').l('[TAB]', '#', array('attributes'=&gt;array('onclick'=&gt;'javascript:jQuery("#edit-bur-fields-terminated").val("\\\\t"); return false;'))), '#required' =&gt; TRUE, ); //ESCAPED $form['bur_fields_enclosed']=array( '#type' =&gt; 'select', '#title' =&gt; t('The fields are enclosed in'), '#default_value' =&gt; (int)variable_get('bur_fields_enclosed', 0), '#size' =&gt; 1, '#options' =&gt; array( 0 =&gt; '\' ('.t('Single quote').')', 1 =&gt; '\'\' ('.t('Two single quotes').')', 2 =&gt; '" ('.t('Double quote').')', 3 =&gt; '%%', ), //'#description' =&gt; t('Set zero if empty'), '#required' =&gt; TRUE, ); $form['bur_fields_escaped']=array( '#type' =&gt; 'select', '#title' =&gt; t('The escape character'), '#default_value' =&gt; (int)variable_get('bur_fields_escaped', 0), '#size' =&gt; 1, '#options' =&gt; array( 0 =&gt; '\\', ), '#required' =&gt; TRUE, ); $form['bur_lines_terminated']=array( '#type' =&gt; 'select', '#title' =&gt; t('Line separator'), '#default_value' =&gt; (int)variable_get('bur_lines_terminated', 0), '#size' =&gt; 1, '#options' =&gt; array( 0 =&gt; '\\r\\n', 1 =&gt; '\\n', 2 =&gt; '\\r', ), '#required' =&gt; TRUE, ); return system_settings_form($form); }</span></span></code> </pre><br></div></div><br>  The following materials were used to create the module: <br><ul><li>  <a href="https://api.drupal.org/">Drupal api</a> </li><li>  <a href="https://drupal.org/project/examples">Examples for almost all occasions</a> </li><li>  Translator from Google.  With foreign languages, I also strained, so if you offer more correct source code in English, I will be very happy. </li></ul><br>  The module is distributed under the BSD license. <br><br>  PS I do not consider myself a programmer (I already realized this), I‚Äôm still far away from this, so all comments on the code, implementations are welcome. <br>  PPS I adore Drupal. <br><br>  UPD 1: Added source code. <br><br>  <b>UPD 2 dated 03/20/2015</b> <br>  Updated to version 1.0.1 </div><p>Source: <a href="https://habr.com/ru/post/191848/">https://habr.com/ru/post/191848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191834/index.html">Release Asterisk 12 will be released in 2013</a></li>
<li><a href="../191836/index.html">Office Entertainment: Pros and Cons</a></li>
<li><a href="../191840/index.html">Laugh after the word "shovel!". Highscreen Alpha GTX Review</a></li>
<li><a href="../191842/index.html">Custom layouts. Part 2. CellLayout</a></li>
<li><a href="../191844/index.html">Panorama of the solar halo</a></li>
<li><a href="../191850/index.html">Make a "mindmap" on Javascript with local storage in the browser database</a></li>
<li><a href="../191852/index.html">Using the Aastra 6725ip and Aastra 6721ip IP terminals in the MS Lync 2013 Server infrastructure</a></li>
<li><a href="../191854/index.html">Raspberry Pi in the hands of an amateur or home rocking torrent</a></li>
<li><a href="../191856/index.html">Is cloudy IP PBX suitable for small companies?</a></li>
<li><a href="../191858/index.html">Another JavaScript preprocessor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>