<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What is hidden inside the online cash registers: the development of a fiscal registrar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Few people think when shopping in a store, how a cashier‚Äôs equipment works. In fact, this is a well-established mechanism, not only from a technical p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What is hidden inside the online cash registers: the development of a fiscal registrar</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ib/z0/89/ibz089de12xtcw1smenriw0zp84.jpeg"><br><br>  Few people think when shopping in a store, how a cashier‚Äôs equipment works.  In fact, this is a well-established mechanism, not only from a technical point of view, but also from the point of view of legislation.  Everyone knows that the main thing is to get a check, but why a check is a fiscal document confirming the purchase - mostly only the entrepreneurs themselves know. <br><br>  In this article we will share the experience of developing a cash register and tell you how everything is arranged from the inside. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/c_/7d/mq/c_7dmqqtd6oxtrorlsxwpk0zvcq.jpeg"><br>  <i>Antique Cash Register</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. System: iron + software at the cashier </h2><br>  The entire hardware and software system that is installed at the cashier‚Äôs workplace can be called a POS system or a POS terminal, from English Point of sale is a place of sale. <br><br>  Consider how the POS system works.  Since the fundamental difference between the system and the terminal is the location of the fiscal memory (FP) or the fiscal drive (FN): in the POS system it is built into the printing device, and in the POS terminal it is located in the computer unit. <br><br><img src="https://habrastorage.org/webt/9m/yz/bk/9myzbk6cfljn4dun9rlscp1mb00.jpeg"><br>  <i>Typical cash register.</i>  <i>POS-system of the Russian company "SHTRIH-M"</i> <br><br>  <b><i>POS-system</i></b> is a software and hardware complex that operates on the basis of a fiscal registrar.  It usually consists of a POS computer, a monitor and keyboard, a receipt printer, a fiscal recorder, a customer display, a cash drawer and a bank card reader.  A typical set of cash functions: accounting and holiday goods, receiving and issuing money, cancellation of the purchase. <br><br>  The most interesting part of the POS system - the <b><i>fiscal registrar</i></b> is the heart of the system and one of the classes of cash registers (CCM). <br><br>  In the role of the fiscal registrar serves receipt printer with built-in fiscal memory.  It receives information via a communication channel, processes it and prints it.  Data on cash transactions can be stored in fiscal memory indefinitely until you need to reset them. <br><br>  For the direct transfer of the fiscal registrar data to the tax service, the server of <i><b>the fiscal data operator is used - the CRF</b></i> , a special legal entity that is responsible for receiving, processing, storing and transmitting the fiscal data to the tax service. <br><br>  Last year, Russian entrepreneurs actively discussed the transition to online cash registers and sending checks to the tax office through the CRF in connection with the adoption of Law 54-FZ ‚ÄúOn the use of cash registers‚Äù. <br><br><img src="https://habrastorage.org/webt/yk/qq/lb/ykqqlb7vocepcwkjs2kd6731cgu.png"><br>  <i>The role of OFD.</i>  <i>Scheme <a href="https://vc.ru/21624-new-trade-law">from the article about 54- and transition to online cash registers</a></i> <br><br>  The FTS is the Federal Tax Service of the Russian Federation.  In Kazakhstan, this function is performed by the State Revenue Committee of the Ministry of Finance.  And in Belarus - the Ministry of Taxes and Duties. <br><br>  There are several CRFs in the Russian Federation, and only one in Kazakhstan, Kazakhtelecom JSC. <br><br><h2>  2. Legislation: global online cash register control </h2><br>  Online control of retail operations is already in place in many countries: South Korea (2005), Sweden (2008), Canada (2010), Poland (2011), Croatia (2013).  In 2015, this approach began to be introduced in Kazakhstan.  And in Belarus, the deadline for connecting cash registers to the remote control system of revenue was postponed to July 1, 2018 (the same period is scheduled in Russia). <br><br>  The use of online cash desks in Kazakhstan is governed by <a href="https://online.zakon.kz/Document/%3Fdoc_id%3D30366217%26doc_id2%3D30366217">Chapter 90 of the Tax Code</a> .  Since 2015, the transfer of checks to the tax on the Internet began sellers of fuel and alcohol.  At the second stage - from 2016 - those who are engaged in the wholesale trade in various materials and equipment were connected to the system;  retail of furniture, software and electronics;  owners of hotels, restaurants, hairdressers and cinemas.  Provided the third phase of the project. <br><br>  We refer to laws for a reason, they describe the mandatory technical requirements for software and hardware systems for collecting and sending data to the tax system, which form the basis of those.  tasks for development engineers.  For example, <a href="http://adilet.zan.kz/rus/docs/V14E0009878">the order of the Minister of Finance of the Republic of Kazakhstan</a> published a list of requirements for a cash register for transferring information about cash payments, which was very useful to us for developing a fiscal registrar. <br><br><h2>  3. Device and business logic of the fiscal registrar </h2><br>  Our development base device is a thermal receipt printer.  Buildroot assembly system.  Programming is on Qt. <br><br>  The project required to develop: <br><br>  1) technical task; <br>  2) an exchange protocol with a POS computer, let's call it the POS-C protocol; <br>  3) daemon application that controls the device: <br><br><ul><li>  data exchange module with the CRF server using the CCP protocol (cash register equipment); </li><li>  data exchange module with a POS computer using the POS-C protocol; </li><li>  print management module; </li><li>  communication interface control module; </li><li>  module of interaction with the database; </li><li>  web server. </li></ul><br><h3>  1) Module data exchange with the server OFD </h3><br>  The device is exchanged with the server using the TCP / IP protocol.  In this interaction, the device is the client, and the CRF is the server.  Protocol Buffers is used as the basis for encoding and decoding information transmitted via the CCT protocol. <br><br>  <a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a> (Protobuf) is a protocol for the serialization (transmission) of structured data proposed by Google as an effective binary alternative to the XML text format.  Developers report that their Protocol Buffers is simpler, more compact and faster than XML, because it transmits binary data that is optimized for the minimum message size. <br><br>  The format of messages in Protobuf is described in a special declarative language, which somewhat resembles the declaration of structures in the C ++ language.  These declarations are saved to a file with the .proto extension and are compiled into source codes in the selected language using the protoc compiler. <br><br>  The CCP protocol allows you to: <br><br><ul><li>  receive service information, information about the cashier, nomenclature data; </li><li>  send the data of the fiscal receipt and cancel it; </li><li>  receive reports on the operations performed; </li><li>  control cash on hand (withdraw or deposit cash) and the status of the shift (open or close the shift); </li><li>  authorize the operator cashier. </li></ul><br><h3>  2) Data exchange module with a POS computer </h3><br>  Communication with a POS computer is implemented using TCP / IP or HTTP protocols, depending on the settings in the web interface, via the USB Type-B port using USB over Ethernet technology.  In this interaction, the device is the server, and the POS computer is the client.  When using a TCP connection, the data is in XML format.  And in the case of an HTTP connection, a POST request is used, the body of which is the same data as a TCP connection. <br><br>  POS-C protocol allows: <br><br><ul><li>  configure and test the connection with the OFD server; </li><li>  get information about the state of the device; </li><li>  control the peripheral of the device (print text, beep, open or close the cash drawer); </li><li>  print a fiscal receipt; </li><li>  print reports on the operations performed; </li><li>  control cash on hand (withdraw or deposit cash) and the status of the shift (open or close the shift). </li></ul><br><h3>  3) Print Management Module </h3><br>  Interaction with the printing mechanism, sound emitter and the port of control of the cash drawer is carried out through <a href="https://github.com/python-escpos/python-escpos">the Python-ESCPOS library</a> , which implements the ESC / POS protocol. <br><br>  ESC / P (Epson Standard Code for Printers) is a command language developed by Epson to control printers.  ESC / POS is one of the ESC / P variants designed for use in POS equipment. <br><br>  Types of printed documents: <br><br><ul><li>  test print; </li><li>  test fiscal receipt; </li><li>  fiscal receipt; </li><li>  canceled fiscal receipt; </li><li>  reports (X-report, Z-report, full control tape, abbreviated control tape, cashier report, section report); </li><li>  depositing or withdrawing cash; </li><li>  opening shift; </li><li>  information about the state of the device; </li><li>  device test result; </li><li>  device registration receipt. </li></ul><br><img src="https://habrastorage.org/webt/sm/or/kd/smorkdnxq_rjact7os-cptfj83e.png"><br>  <i>Testing the printer.</i>  <i>Examples of checks</i> <br><br><h3>  4) Communication Interface Management Module </h3><br>  On board the device there is a DHCP server for the USB interface to communicate with the POS computer.  And to connect to the OFD server, LAN, WiFi and GPRS interfaces can be used, switching between which is implemented by the ConnMan network connections management daemon.  It allows you to configure connections for each interface so that in case of a connection failure on the active interface, quickly switch to another connection with a lower priority.  Such a solution stabilizes the connection with the OFD server at points of sale with poor internet connection. <br><br><h3>  5) Database interaction module </h3><br>  Data storage is implemented using a compact <a href="http://sqlite.org/">embedded SQLite DBMS</a> and organized in the form of the following tables: <br><br><ul><li>  data on the operations performed; </li><li>  authorization data; </li><li>  section settings; </li><li>  tax settings; </li><li>  clich√© and basement check settings; </li><li>  informational messages from the OFD server. </li></ul><br><h3>  6) Web server </h3><br>  To implement the web server <a href="https://www.webtoolkit.eu/wt">, the Wt, C ++ WebToolkit library</a> was chosen due to the following advantages: <br><br><ol><li>  this is a cross-platform free library with C ++ support; </li><li>  small size of a web server in C ++ and low resource consumption; </li><li>  ease of integration with existing desktop applications and C ++ libraries; </li><li>  No need to use HTML, CSS, JavaScript and other technologies, because  can be programmed using widgets like Qt; </li><li>  security and cross-browser web applications. </li></ol><br>  <a href="https://github.com/juangburgos/WtDesigner">WtDesigner</a> turned out to be very useful for a quick start. <br><br>  The purpose of the web interface: <br><br><ol><li>  settings; </li><li>  view device status; </li><li>  Software Update. </li></ol><br><img src="https://habrastorage.org/webt/5z/st/ra/5zstraukp4qveych5iswqsogt_i.png"><br>  <i>Web interface</i> <br><br><h2>  4. Conclusion </h2><br>  Based on these technologies, we developed a device with a wealth of functions and settings via a web interface, support for various communication protocols with a POS computer, and the ability to update software. <br><br>  And now it seems that the Promwad engineering team will never be able to just come to the store and buy something, without thinking about all these insides of the online cash registers, protocols for transmitting data, the requirements of the legislation, and printing the whole kitchen: <br>  - Take the check, please! <br>  - No, thanks!  :-) <br><br>  PS And finally, a minute of humor: British ufologists from the ArtAlienTV team found in the pictures of the Curiosity rover a thing resembling an old cash register. <br><br><img src="https://habrastorage.org/webt/9w/tz/r3/9wtzr3p8fog-fsg2xxynen3ywxa.jpeg"></div><p>Source: <a href="https://habr.com/ru/post/354442/">https://habr.com/ru/post/354442/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354430/index.html">Creating a signature on the template in Outlook for the organization, on computers outside the domain</a></li>
<li><a href="../354432/index.html">These incredibly valuable skills will help you become more successful.</a></li>
<li><a href="../354434/index.html">Pandora's White Box</a></li>
<li><a href="../354438/index.html">How JS Works: Animation with CSS and JavaScript</a></li>
<li><a href="../354440/index.html">Black Friday 2017 through the eyes of IT and developers. As we stood black Friday with a 10 times increase in traffic</a></li>
<li><a href="../354444/index.html">Revelations emergency engineer</a></li>
<li><a href="../354448/index.html">More than a state: US foreign debt</a></li>
<li><a href="../354450/index.html">CocoaHeads April 13, 2018 from Tutu.ru office: video speeches</a></li>
<li><a href="../354452/index.html">Symbolic vulnerability: how a simple message leads to errors in the phone</a></li>
<li><a href="../354456/index.html">SmartMailHack. Winners history in the task Name Entity Recognition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>