<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Express analysis of malicious files for educational purposes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Express analysis of malicious files, first of all, obfuscated malicious scripts (fresh, hot from the heat) - an example of how to interest students wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Express analysis of malicious files for educational purposes</h1><div class="post__text post__text-html js-mediator-article">  Express analysis of malicious files, first of all, obfuscated malicious scripts (fresh, hot from the heat) - an example of how to interest students with the question of [de] code obfuscation. <br>  A deep and painstaking analysis with building block diagrams of algorithms and execution routes (a la <a href="http://fstec.ru/component/attachments/download/294"><abbr title="Guidance document ... Classification by the level of control over the absence of undeclared capabilities ... Approved by the decision of the Chairman of the State Technical Commission ...">RD control NDV SCC</abbr></a> ) is not here. <br><a name="habracut"></a><br><h2>  Instead of introducing </h2><br>  Artificial examples characteristic of many textbooks, often, unfortunately, discourage the desire to understand the question.  It is also bad when the very first training task on the issue being studied is so complex that it is possible to lose the thread of reasoning (in the absence of experience, but it is not clear yet) and with it the interest. <br>  Building on the above and remembering that the presentation of the material is the task and responsibility of the teacher - there was a desire to demonstrate a rapid analysis of obfuscated malicious scripts.  Fortunately, getting this "good" is not such a big problem: the whole industry is regularly working on the creation and distribution. <br>  It was received: an impressive selection from quarantine for the previous week and a modest selection of scripts from infected sites (for 2015). <br>  Where to begin?  With the preliminary preparation of the received "good". <br><br><h2>  Step One (preparatory) </h2><br>  We unpack all archives, more precisely, we try archiver (in this case 7zip was used) to recognize and unpack archives.  Other try?  Because in the resulting collection, files with a wide variety of extensions (zip, rar, arj, lzh, ace, exe, uue, etc.) can be an archive. <br><div class="spoiler">  <b class="spoiler_title">* .zip file is not always a zip file</b> <div class="spoiler_text">  The existing collection clearly showed the situation when inside a file with an extension characteristic of one archiver, the data is packed with an algorithm from another archiver.  Approximately 50% of the files, the extensions of which are characteristic of various archives, contained a rar archive inside. <br>  The calculation is clear: on a typical user workplace (if it is considered as the target of an attack), an archiver is usually installed, which analyzes not only the extension, but also the file header, which means unpack the contents, on the other hand, this can make it difficult for simple protection systems that handle files based only on the extension. <br>  The effectiveness of such a technique for hiding code from antiviruses at intermediate nodes is probably about zero. <br></div></div><br>  Delete all duplicates, because  we are not interested in a quantitative indicator.  Let us remember the list received at this stage, more precisely - the names of the files, we still need it. <br><br><h2>  Step two (sorting) or in the footsteps of Mendeleev </h2><br>  Got a list of files, what's next?  We divide the files by type: <br><ul><li>  all identified archives (now they are just shipping containers) separately; </li><li>  all compiled executable files (their analysis is usually more complicated, requires more time and debugger) separately.  Only exe and scr were included here (there was one exe file with the com extension); </li><li>  all scripts, each type separately.  There were not so many types in the collection, only 4: js, php, vbs, wsf; </li><li>  The last group got a single html file.  The file did not contain scripts, therefore it was not included in the previous groups. </li></ul><br>  Again, quantitative indicators - what types of files anymore - do not interest us.  To imagine from which end to take, you must somehow streamline what you received.  Remembering Mendeleev, we sort by "mass": <br><ul><li>  each group of files is sorted by size; </li><li>  sort the file names by length, discarding the extensions (this is where the general list of files comes in handy). </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Step three (analysis) or "peering method" </h2><br>  Applying the "peering method" to a list of files sorted by length: <br><ul><li>  immediately striking leaders, whose length is more than 100 characters.  Thus, the malware hides the file extension, since  to see him, if not specifically set such a goal, is practically impossible; <br><div class="spoiler">  <b class="spoiler_title">Example of very long names</b> <div class="spoiler_text">  The act of reconciliation with the attached register of primary documentation on 14.03.2016.  Unloaded from 1C Accounting _xlsx <br>  new document from 03/16/2016, the current version for checking and printing on the date checked by antivirus software ok <br></div></div><br></li><li>  attracts the attention of a significant number of files with the same length, if you look closely - you can see the structure of the construction of the name.  Perhaps these files are united by something else; <br><div class="spoiler">  <b class="spoiler_title">3 letters and 10 numbers</b> <div class="spoiler_text">  GUA1343958710 <br>  RQQ7223899805 <br>  VII964085171413 <br>  YAF3892579406 <br></div></div><br></li><li>  Among the names with a length of 8 and 10 characters there are a lot of dates in various formats, but this information does not give us much. </li></ul><br><br>  Without using debuggers from compiled executable files, the following was obtained: <br><ul><li>  in most cases, icons are replaced by document icons (from doc (x), xls (x), pdf, icons characteristic of Libre / OpenOffice have never met) or multimedia (from jpeg, mp3, etc.); </li><li>  Some files contained an electronic signature (allegedly even from Microsoft), but invalid. </li></ul><br><br>  Before moving to a large group of scripts, consider a single html file.  He was not pleased with anything really interesting: deleted line feeds and many comments.  It is easily cleaned and immediately visible is the technique that the attackers wanted to use. <br><div class="spoiler">  <b class="spoiler_title">html</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'refresh'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0; url=http://bad.url/'</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Reception is simple, clear and long known. <br></div></div><br><br>  In the wsf scripts nothing interesting was found.  After the elementary deletion of multi-line comments, the same code remained (requiring decryption, but it was not dealt with). <br><div class="spoiler">  <b class="spoiler_title">wsf</b> <div class="spoiler_text"><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">job</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"JScript.Encode"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> #@~^+goAAA==&amp;JNi ... DAA==^#~@ </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">job</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br>  JS deobfuscation - the topic has been repeatedly disclosed on Habr√© and there‚Äôs no particular point in repeating.  In the collection there were different techniques. <br><br>  Interesting and illustrative was closer attention to the group of files "3 letters and 10 numbers."  The file structure was similar if the variables were given the same name and still performed some ‚Äúcosmetic‚Äù transformations (align indents, perform arithmetic operations on numbers [so that 1 + 4 + 1 = 2 + 2 + 2 = 3 + 2 + 1 = 6]) , the similarity of the files became apparent.  Files were obviously processed by one obfuscator.  This demonstrated the ability to identify groups of similar from the file stream and, after performing a thorough analysis of individual files, to draw conclusions about the groups. <br><br><h2>  Separate malware tricks with archives </h2><br>  The change in the archive extension is already noted above. <br>  There are archives nested in each other with correct extensions or not.  Nesting depends on the author's imagination and has two possible goals: <br><ul><li>  hide from anti-virus scanning (to save resources, antiviruses, as a rule, limit the nesting depth of the archives being scanned); </li><li>  to provoke the user [even cautious] to launch a malicious workload.  The user several times clicks the mouse (or presses Enter in the shell) on the nested archive so that it opens, and, with a high probability, on the machine will perform the same action on the malicious load. </li></ul><br>  Reception of simple obfuscation using the archiving function was revealed in a php file.  In addition to obfuscation and playing hide and seek with antivirus in this case, compression also gave significant savings on file size. <br><div class="spoiler">  <b class="spoiler_title">php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(gzinflate(...));</code> </pre><br>  A small modification of the code that does not execute, but saves the result, allows you to get to the content in several iterations.  The task is not difficult and every student will be able to solve it.  As a result, from the initial 10k, a php script at 30k is obtained.  The script contains an authorization block with password hash checking, but another small modification disables the check (or replaces the hash) and you can see the ‚Äúreal live hacker shellcode‚Äù in action: a mini file manager with a convenient interface and the ability to execute input commands. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/279717/">https://habr.com/ru/post/279717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279705/index.html">Is there a visible border on the web?</a></li>
<li><a href="../279709/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ203 (March 14 - 20, 2016)</a></li>
<li><a href="../279711/index.html">Access problem and interesting Windows registry key</a></li>
<li><a href="../279713/index.html">Professionalism and TDD</a></li>
<li><a href="../279715/index.html">Joining Reactive Programming that you missed</a></li>
<li><a href="../279721/index.html">Setting up email notification templates in 3CX Phone System</a></li>
<li><a href="../279723/index.html">"Favorite smartphone chemist technologist" or the unification of the desktop of your gadget</a></li>
<li><a href="../279725/index.html">The evolution of SDN: the way to a great programmable future</a></li>
<li><a href="../279727/index.html">ActiveResource, prefix and nested resources</a></li>
<li><a href="../279729/index.html">Deep Reinforcement Learning (or what you bought DeepMind for)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>