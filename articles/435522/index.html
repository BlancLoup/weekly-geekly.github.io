<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Snapshots of events in Axonframework 3, improving performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Axonframework Framework Review 
 Axonframework is a framework that implements several principles and design patterns such as: 

 CQRS - separates the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Snapshots of events in Axonframework 3, improving performance</h1><div class="post__text post__text-html js-mediator-article"><h3>  Axonframework Framework Review </h3><br>  Axonframework is a framework that implements several principles and design patterns such as: <br><br>  <b>CQRS</b> - separates the processing of requests for reading and writing data <br>  <b>Event Sourcing</b> is when the application state is stored as a chain of events. <br>  <b>DDD Aggregate</b> - domain object (domain object) which stores the state <br><br>  One of the disadvantages of storing the final state of an application in the form of a chain of events is the number of events stored and processed.  Fortunately, Axonframework allows you to create a snapshot of events (snapshot event), which contains the result of several events (domain event). <br><a name="habracut"></a><br><h3>  Snapshots of events </h3><br>  Snapshot event (snapshot event) - these are the resulting values ‚Äã‚Äãof several events (domain event).  This allows you to quickly recreate the state of the unit (Aggregate).  It is important to understand that the snapshot is created from the events that were used for a specific Unit with a unique identifier. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example ( <i>Fig. 1</i> ), let's set up in the configuration a snapshot for every two events (threshold = 2 - for illustrative purposes of the example).  In this case, when two events change the state of the Unit, one snapshot will be created with the resulting values ‚Äã‚Äãof the previous two events. <br><br><img src="https://habrastorage.org/webt/_r/zu/9a/_rzu9apczumi6zijbcafynqajwy.png"><br>  <i>Figure 1. A snapshot of two events.</i>  <i>(threshold = 2)</i> <br><br>  Consider an example more complicated ( <i>Fig. 2</i> ), the configuration also indicates a threshold of 2, so that a snapshot is created every two events.  When 2 events change the state of the unit, one shot will be created.  Further, the other 2 events change the state of the Unit and a new snapshot is not created, but an existing one is updated. <br><br><img src="https://habrastorage.org/webt/pt/27/ot/pt27ot4awkpcgksfxfv7lxo7idg.png"><br>  <i>Fig.2 The result of a chain of events in one picture (threshold = 2)</i> <br><br><h3>  Performance </h3><br>  On the one hand, when the application accumulates a long chain of events, it takes time to read and process a large number of events to recreate the state of the Unit.  On the other hand, if you take a snapshot, the state of the unit will be recreated quickly, but it will take time to create the snapshot.  It is necessary to find a balance between these two situations. <br><br><img src="https://habrastorage.org/webt/8z/he/hb/8zhehbkall5aane2widtwjath-k.png"><br>  <i>Fig.3 Performance without taking a snapshot</i> <br><br><img src="https://habrastorage.org/webt/ct/ag/4-/ctag4-2ofkhzu5_osyqvav8uuki.png"><br>  <i>Fig.4 Performance with the creation of a snapshot (threshold = 3)</i> <br><br>  By default, a snapshot is created in the stream that called the scheduleSnapshot () method.  This setting is not recommended for combat environments (see Fig.4 / entry). <br><br>  Below is an example of code using ThreadPoolExecutor (...) which will provide a separate thread for creating a snapshot.  In this case, our client will not notice the slowdown in the application and the allotted time to create a snapshot. <br><br><h3>  Code </h3><br>  To activate snapshot creation, you need to make small changes to the application code.  The aggregate annotation indicates the name of the repository used in the code of the configuration class.  In the configuration class, a threshold is specified for creating snapshots, a method for creating snapshots, a repository, etc. <br><br>  AxonConfig.java <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventStore eventStore; <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringAggregateSnapshotterFactoryBean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">springAggregateSnapshotterFactoryBean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringAggregateSnapshotterFactoryBean(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringAggregateSnapshotter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snapshotter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ParameterResolverFactory parameterResolverFactory, EventStore eventStore, TransactionManager transactionManager)</span></span></span><span class="hljs-function"> </span></span>{ Executor executor = Executors.newFixedThreadPool(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringAggregateSnapshotter(eventStore, parameterResolverFactory, executor, transactionManager); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"reservationRepository"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EventSourcingRepository&lt;Reservation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservationRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Snapshotter snapshotter, ParameterResolverFactory parameterResolverFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventSourcingRepository&lt;Reservation&gt;(reservationAggregateFactory(), eventStore, parameterResolverFactory, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventCountSnapshotTriggerDefinition(snapshotter, <span class="hljs-number"><span class="hljs-number">50</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(name = <span class="hljs-string"><span class="hljs-string">"reservationAggregateFactory"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AggregateFactory&lt;Reservation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservationAggregateFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SpringPrototypeAggregateFactory&lt;Reservation&gt; aggregateFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringPrototypeAggregateFactory&lt;&gt;(); aggregateFactory.setPrototypeBeanName(<span class="hljs-string"><span class="hljs-string">"reservation"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aggregateFactory; }</code> </pre> <br>  Reservation.java <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aggregate</span></span>(repository = <span class="hljs-string"><span class="hljs-string">"reservationRepository"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reservation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ }</span></span></code> </pre><br>  It is worth noting that the Google Groups discussion <a href="https://groups.google.com/forum/">thread</a> contains useful code examples and discussions. <br><br><h3>  Selecting a threshold for taking snapshots </h3><br><br>  <b>5.1.</b>  <b>Theoretical path</b> <br><br>  Calculate the number of events that can be applied to the Aggregate in the EventListener class.  Then, theoretically, we estimate the average number of events applied to the Unit in a typical situation, and we set the value somewhat less than this as the threshold for creating snapshots.  This can be done if the application is only created and there is no real data for analysis. <br><br>  <b>5.2.</b>  <b>Practical way</b> <br><br>  We will analyze the data from the database, while we will assume that the database is used by MongoDB and it works inside the docker container. <br><br><pre> <code class="bash hljs">&gt; docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it &lt;container-id&gt; mongo &gt; show dbs admin 0.000GB axonframework 0.000GB <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 0.000GB &gt; use axonframework switched to db axonframework &gt; show collections domainevents sagas snapshotevents &gt; db.domainevents.<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span></span>() { ‚Äú_id‚Äù : ObjectId(‚Äú5bb1dc8d4446d63bcc765feb‚Äù), ‚ÄúaggregateIdentifier‚Äù : ‚Äúb1e320d5‚Äì58aa-4b9b-a667-aa724900592f‚Äù, ‚Äú<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>‚Äù : ‚ÄúReservation‚Äù, ‚ÄúsequenceNumber‚Äù : NumberLong(0), ‚ÄúserializedPayload‚Äù : ‚Äú&lt;com.example.ReservationStarted&gt;&lt;reservationIdentifier&gt;b1e320d5‚Äì58aa-4b9b-a667-aa724900592f&lt;/reservationIdentifier&gt;&lt;duration resolves-to=\‚Äùjava.time.Ser\‚Äù&gt;&lt;byte&gt;1&lt;/byte&gt;&lt;long&gt;2400&lt;/long&gt;&lt;int&gt;0&lt;/int&gt;&lt;/duration&gt;&lt;/com.example.ReservationStarted&gt;‚Äù, ‚Äútimestamp‚Äù : ‚Äú2018‚Äì10‚Äì01T08:36:29.434Z‚Äù, ‚ÄúpayloadType‚Äù : ‚Äúcom.example.ReservationStarted‚Äù, ‚ÄúpayloadRevision‚Äù : null, ‚ÄúserializedMetaData‚Äù : ‚Äú&lt;meta-data&gt;&lt;entry&gt;&lt;string&gt;traceId&lt;/string&gt;&lt;string&gt;b090b86a-ec89‚Äì484b-ae9f-e4fa0f9bcd39&lt;/string&gt;&lt;/entry&gt;&lt;entry&gt;&lt;string&gt;correlationId&lt;/string&gt;&lt;string&gt;b090b86a-ec89‚Äì484b-ae9f-e4fa0f9bcd39&lt;/string&gt;&lt;/entry&gt;&lt;/meta-data&gt;‚Äù, ‚ÄúeventIdentifier‚Äù : ‚Äúf324f021‚Äì50b4‚Äì4e91‚Äì84d0-f8c4425f3eb9‚Äù }</code> </pre><br>  Each stored event contains an aggregateIdentifier field, by which we count the number of events applied to each Aggregate by a simple query: <br><br><pre> <code class="bash hljs">db.domainevents.aggregate([ {<span class="hljs-variable"><span class="hljs-variable">$group</span></span>: {_id: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$aggregateIdentifier</span></span></span><span class="hljs-string">"</span></span>, count: {<span class="hljs-variable"><span class="hljs-variable">$sum</span></span>: 1} } }, {<span class="hljs-variable"><span class="hljs-variable">$sort</span></span> : {count : -1} } ]); { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"0d84afd1-f199-45c8-b50e-7d9ebfa4c8fb"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"49de7c32-38ea-435a-b837-ccdb61ec0baa"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"12957b0b-af05-47c4-a3d8-968b75cf9ffb"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"97a24559-ee3a-43e7-a6be-1eb6840b662a"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"b6aeb1af-0620-4b02-8de3-c2446c2f7d83"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"b385aaf4-3338-489f-8d1b-4600d5e088b9"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"5970327f-9551-4945-94e9-3844c0cd3543"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } ... { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"0182239h-3948-3334-98t5-9643j4ld8346"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 1 }</code> </pre><br>  The threshold for creating snapshots can be selected below the average so that snapshots are created effectively.  In this case, the value of 50 is fine. <br><br><h3>  Verification of snapshot activation </h3><br><pre> <code class="bash hljs">&gt; mongo &gt; show dbs admin 0.000GB axonframework 0.000GB <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 0.000GB &gt; use axonframework &gt; show collections domainevents sagas snapshotevents &gt; db.domainevents.count() 515 &gt; db.snapshotevents.count() 7</code> </pre><br>  If the snapshotevents collection is not empty and contains snapshots, then snapshot creation is activated successfully. <br><br><h3>  Other snapshot capabilities </h3><br>  The <a href="https://docs.axoniq.io/reference-guide/1.4-advanced-tuning/performance-tuning">documentation also</a> mentions other variations on the activation of snapshot creation, for example: <br><br><ul><li>  the number of events created since the last snapshot exceeded the threshold </li><li>  time to initialize the unit has expired </li><li>  time delay, etc.  etc. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/435522/">https://habr.com/ru/post/435522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435510/index.html">Microelectronics, neurophysiology and machine learning, shake up, but do not mix</a></li>
<li><a href="../435512/index.html">Developers from Royole showed a folding flexible smartphone</a></li>
<li><a href="../435514/index.html">Russia is developing a processor to accelerate neural networks</a></li>
<li><a href="../435518/index.html">Paying customs duty for online purchase will be much easier.</a></li>
<li><a href="../435520/index.html">We write our programming language, part 3: Translator Architecture. Parsing language structures and mathematical expressions</a></li>
<li><a href="../435526/index.html">Adventures with a home Kubernetes cluster</a></li>
<li><a href="../435528/index.html">5 reasons for success: why Amazon has become the most expensive company in the world</a></li>
<li><a href="../435530/index.html">Paid Subscriptions - Dependency of Auto Connection on Mobile</a></li>
<li><a href="../435532/index.html">Tornado vs Aiohttp: a journey into the wilds of asynchronous frameworks</a></li>
<li><a href="../435534/index.html">Data Science: entry level books</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>