<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backing up web projects on Yandex.Disk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my early years I did not understand the importance of data backup. But as they say, understanding comes with experience. Often the experience is ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backing up web projects on Yandex.Disk</h1><div class="post__text post__text-html js-mediator-article">  In my early years I did not understand the importance of data backup.  But as they say, understanding comes with experience.  Often the experience is very bitter.  In my case, hosting twice killed the base site <a href="http://mathinfinity.net.ru/">MathInfinity</a> , created back in his student years. <br><br>  Large projects can afford to allocate entire servers for backup.  However, there is a huge number of small projects that work only on your enthusiasm.  These projects also need backup. <br><br>  The idea of ‚Äã‚Äãcreating archives on services like Dropbox, Ubuntu One, Yandex Drive, Google Drive, etc. has long attracted my attention.  Tens of gigabytes of free space, which theoretically can be used to back up data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now this idea got my first incarnation.  Yandex Disk was selected as a service for creating archives. <br><a name="habracut"></a><br>  I do not pretend to the genius of the idea.  And, of course, the invention of the bicycle began with the search for ready-made solutions on the Internet.  All found code either did not work anymore, or had a completely unreadable view.  I prefer to understand how my applications work. <br><br>  Not to say that the Yandex API services have excellent documentation.  However, there are examples and references to specific standards.  That was enough. <br><br>  After studying the problem, the task of backing up data fell into the following points: <br><br><ol><li>  <a href="https://habr.com/ru/post/206752/">Application registration</a> </li><li>  <a href="https://habr.com/ru/post/206752/">Authorization in Yandex using OAuth</a> </li><li>  <a href="https://habr.com/ru/post/206752/">Operations with Yandex.Disk</a> </li><li>  <a href="https://habr.com/ru/post/206752/">Creating and sending a backup to Yandex disk</a> </li><li>  <a href="https://habr.com/ru/post/206752/">Perform crown copying</a> </li></ol><br><br>  The last two points are a matter of technology, but still I decided to include them in the description. <br><br>  I have been using the Limb framework for a long time.  And in order not to reinvent the wheels to your bike, class codes will be given below. <br>  using this framework.  All classes and functions prefixed with lmb are standard classes and Limb functions. <br><a name="ank1"></a><br><h4>  Application registration </h4><br>  First you need to register your application.  The application registration process is very simple.  This procedure is described in the <a href="">Yandex Documentation</a> . <br>  You are required to fill out a simple form in which, among other things, you must give permission to use your Yandex disk by the application.  As a result of filling in the form fields, you will be given an application id and application password.  They must be used to obtain a token.  This process took me 3 minutes. <br><a name="ank2"></a><br><h4>  Authorization in Yandex using OAuth </h4><br>  To perform disk operations, you must specify an OAuth token.  The OAuth standard describes several options for obtaining a token.  Tu decided to go the easiest way.  In accordance with the OAuth standard of clause 4.3.2, the token can be obtained by a direct request to the service using a Yandex username and password (the account can be any). <br>  A small search through the documentation allowed me to write the following class: <br><br><div class="spoiler">  <b class="spoiler_title">Token receipt class code</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YaAuth</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $token; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $error; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $create_time; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $ttl; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $app_id; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $conf; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($conf,$logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app_id = $conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_app_id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clear(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf = $conf; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkToken()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token; $url = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_token_url'</span></span>); $curl = lmbToolkit::instance()-&gt;getCurlRequest(); $curl-&gt;setOpt(CURLOPT_HEADER,<span class="hljs-number"><span class="hljs-number">0</span></span>); $curl-&gt;setOpt(CURLOPT_REFERER,<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_referer_url'</span></span>)); $curl-&gt;setOpt(CURLOPT_URL,$url); $curl-&gt;setOpt(CURLOPT_CONNECTTIMEOUT,<span class="hljs-number"><span class="hljs-number">1</span></span>); $curl-&gt;setOpt(CURLOPT_FRESH_CONNECT,<span class="hljs-number"><span class="hljs-number">1</span></span>); $curl-&gt;setOpt(CURLOPT_RETURNTRANSFER,<span class="hljs-number"><span class="hljs-number">1</span></span>); $curl-&gt;setOpt(CURLOPT_FORBID_REUSE,<span class="hljs-number"><span class="hljs-number">1</span></span>); $curl-&gt;setOpt(CURLOPT_TIMEOUT,<span class="hljs-number"><span class="hljs-number">4</span></span>); $curl-&gt;setOpt(CURLOPT_SSL_VERIFYPEER,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $post = <span class="hljs-string"><span class="hljs-string">'grant_type=password&amp;client_id='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_app_id'</span></span>). <span class="hljs-string"><span class="hljs-string">'&amp;client_secret='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_app_secret'</span></span>). <span class="hljs-string"><span class="hljs-string">'&amp;username='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_login'</span></span>). <span class="hljs-string"><span class="hljs-string">'&amp;password='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf-&gt;get(<span class="hljs-string"><span class="hljs-string">'oauth_password'</span></span>); $header = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-comment"><span class="hljs-comment">/*'Host: oauth.yandex.ru',*/</span></span> <span class="hljs-string"><span class="hljs-string">'Content-type: application/x-www-form-urlencoded'</span></span>, <span class="hljs-string"><span class="hljs-string">'Content-Length: '</span></span>.strlen($post) ); $curl-&gt;setOpt(CURLOPT_HTTPHEADER,$header); $json = $curl-&gt;open($post); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$json) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = $curl-&gt;getError(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $http_code = $curl-&gt;getRequestStatus(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(($http_code!=<span class="hljs-string"><span class="hljs-string">'200'</span></span>) &amp;&amp; ($http_code!=<span class="hljs-string"><span class="hljs-string">'400'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = <span class="hljs-string"><span class="hljs-string">"Request Status is "</span></span>.$http_code; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $result = json_decode($json, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($result[<span class="hljs-string"><span class="hljs-string">'error'</span></span>]) &amp;&amp; ($result[<span class="hljs-string"><span class="hljs-string">'error'</span></span>] != <span class="hljs-string"><span class="hljs-string">''</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = $result[<span class="hljs-string"><span class="hljs-string">'error'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = $result[<span class="hljs-string"><span class="hljs-string">'access_token'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl = (int)$result[<span class="hljs-string"><span class="hljs-string">'expires_in'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;create_time = (int)time(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;counter_id = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;create_time = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (time()&gt;(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl+<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;create_time)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = <span class="hljs-string"><span class="hljs-string">'token_outdated'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error; } }</code> </pre> <br></div></div><br><br>  We put all parameters required for authorization to the config.  Any object that supports get and set methods can act as a config. <br>  To enable logging of actions performed, an object is transferred to the class constructor for logging work.  His code can be found in the archive with an example. <br>  The class itself has two main methods getToken and checkToken.  The first executes cUrl request for receiving a token, and the second checks whether the token is outdated. <br><a name="ank3"></a><br><h4>  Operations with Yandex.Disk </h4><br>  After receiving the token, you can perform operations with the Yandex disk. <br>  Yandex disk allows you to perform many different requests.  The following operations are necessary for my purposes: <br><ul><li>  Creating a folder </li><li>  Download file to Yandex disk </li><li>  Deleting a file from Yandex Disk </li><li>  Downloading a file from Yandex disk </li><li>  Getting a list of objects contained in the folder </li><li>  Determining the existence of an object on the disk and its type </li></ul><br>  All operations are performed using cUrl.  Of course, all this can be done using sockets, but for me the simplicity of the code is important.  All operations with Yandex disk correspond to the WebDav protocol.  The Yandex Disk API documentation details the examples for executing requests and responses to these requests.  The class code for working with the disk is shown below: <br><div class="spoiler">  <b class="spoiler_title">The disk operation class code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YaDisk</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $auth; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $config; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $error; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $token; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $logger; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $url; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($token,$config,$logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;auth = $auth; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config = $config; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = $token; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server_dst)</span></span></span><span class="hljs-function"> </span></span>{ $curl = lmbToolkit::instance()-&gt;getCurlRequest(); $curl-&gt;setOpt(CURLOPT_SSL_VERIFYPEER,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $curl-&gt;setOpt(CURLOPT_PORT,<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config-&gt;get(<span class="hljs-string"><span class="hljs-string">'disk_port'</span></span>)); $curl-&gt;setOpt(CURLOPT_CONNECTTIMEOUT,<span class="hljs-number"><span class="hljs-number">2</span></span>); $curl-&gt;setOpt(CURLOPT_RETURNTRANSFER,<span class="hljs-number"><span class="hljs-number">1</span></span>); $curl-&gt;setOpt(CURLOPT_HEADER, <span class="hljs-number"><span class="hljs-number">0</span></span>); $curl-&gt;setOpt(CURLOPT_HTTP_VERSION,CURL_HTTP_VERSION_1_1); $uri = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> lmbUri(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config-&gt;get(<span class="hljs-string"><span class="hljs-string">'disk_server_url'</span></span>)); $uri = $uri-&gt;setPath($server_dst)-&gt;toString(); $curl-&gt;setOpt(CURLOPT_URL,$uri); $header = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'Accept: */*'</span></span>, <span class="hljs-string"><span class="hljs-string">"Authorization: OAuth {$this-&gt;token}"</span></span> ); $curl-&gt;setOpt(CURLOPT_HTTPHEADER,$header); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $curl; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($curl, $codes = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($curl-&gt;getError()) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = $curl-&gt;getError(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($curl-&gt;getRequestStatus(),$codes)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error = <span class="hljs-string"><span class="hljs-string">'Response http error:'</span></span>.$curl-&gt;getRequestStatus(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkdir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server_dst)</span></span></span><span class="hljs-function"> </span></span>{ $curl = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCurl($server_dst); $curl-&gt;setOpt(CURLOPT_CUSTOMREQUEST,<span class="hljs-string"><span class="hljs-string">"MKCOL"</span></span>); $response = $curl-&gt;open(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getResult($curl, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">201</span></span>,<span class="hljs-number"><span class="hljs-number">405</span></span>));<span class="hljs-comment"><span class="hljs-comment">//405 —î—ï“ë —î—ï‚Ä¢–Ü–Ç¬∞‚Ä∞¬∞¬µ‚Äö–É–è ¬µ–É¬ª —ó¬∞—ó—î¬∞ —ì¬∂¬µ ¬µ–É‚Äö–ä –Ö¬∞ –É¬µ–Ç–Ü¬µ–Ç¬µ } function upload($local_src,$server_dst) { $local_file = fopen($local_src,"r"); $curl = $this-&gt;getCurl($server_dst); //$curl-&gt;setOpt(CURLOPT_CUSTOMREQUEST,"PUT"); $curl-&gt;setOpt(CURLOPT_PUT, 1); $curl-&gt;setOpt(CURLOPT_INFILE,$local_file); $curl-&gt;setOpt(CURLOPT_INFILESIZE, filesize($local_src)); $header = array('Accept: */*', "Authorization: OAuth {$this-&gt;token}", 'Expect: ' ); $curl-&gt;setOpt(CURLOPT_HTTPHEADER,$header); $response = $curl-&gt;open(); fclose($local_file); return $this-&gt;getResult($curl, array(200,201,204)); } function download($server_src,$local_dst) { $local_file = fopen($local_dst,"w"); $curl = $this-&gt;getCurl($server_src); $curl-&gt;setOpt(CURLOPT_HTTPGET, 1); $curl-&gt;setOpt(CURLOPT_HEADER, 0); $curl-&gt;setOpt(CURLOPT_FILE,$local_file); $response = $curl-&gt;open(); fclose($local_file); return $this-&gt;getResult($curl, array(200)); } function rm($server_src) { $curl = $this-&gt;getCurl($server_src); $curl-&gt;setOpt(CURLOPT_CUSTOMREQUEST,"DELETE"); $response = $curl-&gt;open(); return $this-&gt;getResult($curl, array(200)); } function ls($server_src) { $curl = $this-&gt;getCurl($server_src); $curl-&gt;setOpt(CURLOPT_CUSTOMREQUEST,"PROPFIND"); $header = array('Accept: */*', "Authorization: OAuth {$this-&gt;token}", 'Depth: 1', ); $curl-&gt;setOpt(CURLOPT_HTTPHEADER,$header); $response = $curl-&gt;open(); if($this-&gt;getResult($curl, array(207))) { $xml = simplexml_load_string($response,"SimpleXMLElement" ,0,"d",true); $list = array(); foreach($xml as $item) { if(isset($item-&gt;propstat-&gt;prop-&gt;resourcetype-&gt;collection)) $type = 'd'; else $type = 'f'; $list[]=array('href'=&gt;(string)$item-&gt;href,'type'=&gt;$type); } return $list; } return false; } //Ugly. function exists($server_src) { $path = dirname($server_src); $list = $this-&gt;ls($path); if($list === false) { $this-&gt;error = '    '; $this-&gt;logger-&gt;log('','ERROR', $this-&gt;error); return false; } foreach($list as $item) if(rtrim($item['href'],'/')==rtrim($server_src,'/')) return true; return false; } //Ugly. function is_file($server_src) { $path = dirname($server_src); $list = $this-&gt;ls($path); if($list === false) { $this-&gt;error = '    '; $this-&gt;logger-&gt;log('','ERROR', $this-&gt;error); return false; } foreach($list as $item) if( (rtrim($item['href'],'/')==rtrim($server_src,'/') ) &amp;&amp; ($item['type']=='f') ) return true; return false; } //Ugly. function is_dir($server_src) { $path = dirname($server_src); $list = $this-&gt;ls($path); if($list === false) { $this-&gt;error = '    '; $this-&gt;logger-&gt;log('','ERROR', $this-&gt;error); return false; } foreach($list as $item) if( (rtrim($item['href'],'/')==rtrim($server_src,'/') ) &amp;&amp; ($item['type']=='d') ) return true; return false; } }</span></span></code> </pre><br></div></div><br>  All class methods have speaking names mkdir, upload, download, ls, rm, so we will not dwell on them in detail.  Everything comes down to building and executing a query using cUrl.  To each request, you must add the token received above. <br>  To make a complete analysis of the answer, to be honest, it was too lazy to do.  Therefore, the response simply checks the status of the request, if it matches the expected one, then we consider the operation completed successfully.  Otherwise, write the error in the log. <br>  The implementation of the is_dir, is_file, exists methods is awful, but I'm not going to work with folders in which there are more than 10 files.  That is why they are implemented using the ls method. <br>  Now I have a tool for disk management.  Let it be a little flawed, but still - it is a tool. <br><a name="ank4"></a><br><h4>  Creating and sending a backup to Yandex disk </h4><br>  We will create a backup copy according to the following algorithm: <br><ol><li>  Remove from Yandex disk extra backups.  If more than n backups have accumulated on the disk, then the old ones are deleted. We take the number n from the config. </li><li>  In some temporary folder we create a dump of the Mysql database.  In my code, this is done by invoking the mysqldump command. </li><li>  In the same folder, copy the files you need to save. </li><li>  Archive the folder with the created files. </li><li>  The resulting archive is copied to Yandex Disk </li><li>  Delete temporary files </li></ol><br>  Possible variations of the last set of actions.  Here the flight of fantasy is not limited.  For me, this set is enough. <br>  These actions can be performed using the following class. <br><br><div class="spoiler">  <b class="spoiler_title">Creating an archive and sending it to disk</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YaBackup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $disk; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $db; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $logger; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $backup_number; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($backupconfig)</span></span></span><span class="hljs-function"> </span></span>{ $config = lmbToolkit::instance()-&gt;getConf(<span class="hljs-string"><span class="hljs-string">'yandex'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = YaLogger::instance(); $auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YaAuth($config,<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger); $token = $auth-&gt;getToken(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($token == <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'   '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;disk = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YaDisk($token,$config,<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'db'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;folders = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'folders'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tmp_dir = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'tmp_dir'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;project = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'project'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;backup_number = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'stored_backups_number'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server_dir = $backupconfig-&gt;get(<span class="hljs-string"><span class="hljs-string">'dir'</span></span>); $time = time(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;archive = date(<span class="hljs-string"><span class="hljs-string">"Ymd"</span></span>,$time).<span class="hljs-string"><span class="hljs-string">'-'</span></span>.$time; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"   "</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;project,<span class="hljs-string"><span class="hljs-string">"START_PROJECT"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_clean(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_deleteOld(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_makeDump(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_copyFolders(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_createArchive(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  ."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_upload(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_clean(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;log(<span class="hljs-string"><span class="hljs-string">"  "</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;project.<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"END_PROJECT"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_clean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ lmbFs::rm(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getProjectDir()); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_deleteOld</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $list = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;disk-&gt;ls(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;server_dir.<span class="hljs-string"><span class="hljs-string">'/'</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;project); $paths=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $n=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($list <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $item) { <span class="hljs-comment"><span class="hljs-comment">//    Ymd-timestamp.tar.gz.      timestamp. $parts = explode('-',basename(rtrim($item['href'],'/'))); if(isset($parts[3]) &amp;&amp; ($item['type']=='f')) { $tm = explode('.',$parts[3]); $paths[(integer)$tm[0]] = $item['href']; $n++; } } ksort($paths);//        for($i=$n;$i&gt;$this-&gt;backup_number-1;$i--) { $item = array_shift($paths); $this-&gt;logger-&gt;log(" ".$item); $this-&gt;disk-&gt;rm($item); } } protected function _upload() { $archive = $this-&gt;archive.'.tar.gz'; //     $this-&gt;logger-&gt;log("   ."); $this-&gt;disk-&gt;mkdir($this-&gt;server_dir); $res = $this-&gt;disk-&gt;mkdir($this-&gt;server_dir.'/'.$this-&gt;project); //  $this-&gt;logger-&gt;log("   ."); $this-&gt;disk-&gt;upload($this-&gt;getProjectDir().'/'.$archive,$this-&gt;server_dir.'/'.$this-&gt;project.'/'.$archive); if($res) $this-&gt;logger-&gt;log("  .  "); else $this-&gt;logger-&gt;log("  .    "); } protected function getProjectDir() { return $this-&gt;tmp_dir.'/'.$this-&gt;project; } protected function _copyFolders() { lmbFs:: mkdir($this-&gt;getProjectDir() . '/folders'); $folders = $this-&gt;folders; foreach($folders as $key =&gt; $value) { lmbFs:: mkdir($this-&gt;getProjectDir() . '/folders/' . $key); lmbFs:: cp($value, $this-&gt;getProjectDir() . '/folders/' . $key); } } protected function _createArchive() { $archive = $this-&gt;archive; $dir = $this-&gt;getProjectDir(); //  system `cd $dir &amp;&amp; find . -type f -exec tar rvf "$archive.tar" '{}' \;`; `cd $dir &amp;&amp; gzip $archive.tar`; } protected function _makeDump() { $host = $this-&gt;db['host']; $user = $this-&gt;db['user']; $password = $this-&gt;db['password']; $database = $this-&gt;db['database']; $charset = $this-&gt;db['charset']; lmbFs:: mkdir($this-&gt;getProjectDir() . '/base'); $sql_schema = $this-&gt;getProjectDir() . '/base/schema.mysql'; $sql_data = $this-&gt;getProjectDir() . '/base/data.mysql'; //  $this-&gt;mysql_dump_schema($host, $user, $password, $database, $charset, $sql_schema); $this-&gt;mysql_dump_data($host, $user, $password, $database, $charset, $sql_data); } //       protected function mysql_dump_schema($host, $user, $password, $database, $charset, $file, $tables = array()) { $password = ($password)? '-p' . $password : ''; $cmd = "mysqldump -u$user $password -h$host " . "-d --default-character-set=$charset " . "--quote-names --allow-keywords --add-drop-table " . "--set-charset --result-file=$file " . "$database " . implode('', $tables); $this-&gt;logger-&gt;log("     '$file' file..."); system($cmd, $ret); if(!$ret) $this-&gt;logger-&gt;log("   (" . filesize($file) . " bytes)"); else $this-&gt;logger-&gt;log("   ");; } protected function mysql_dump_data($host, $user, $password, $database, $charset, $file, $tables = array()) { $password = ($password)? '-p' . $password : ''; $cmd = "mysqldump -u$user $password -h$host " . "-t --default-character-set=$charset " . "--add-drop-table --create-options --quick " . "--allow-keywords --max_allowed_packet=16M --quote-names " . "--complete-insert --set-charset --result-file=$file " . "$database " . implode('', $tables); $this-&gt;logger-&gt;log("     '$file' file..."); system($cmd, $ret); if(!$ret) $this-&gt;logger-&gt;log("  ! (" . filesize($file) . " bytes)"); else $this-&gt;logger-&gt;log("   ");; } }</span></span></code> </pre><br></div></div><br><br>  To brush the code of the last class did not.  I think an interested reader himself will be able to add, remove or change methods to fit his needs.  Working with comes down to loading the config into the class through the constructor and executing the execute method <br><a name="ank5"></a><br><h4>  Perform crown copying </h4><br>  It so happened that I implement all the tasks of the crown in the form of class heirs: <br><br><div class="spoiler">  <b class="spoiler_title">Cronjob</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CronJob</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br></div></div><br>  No comments here. <br>  For each project I create a class of approximately the following content: <br><div class="spoiler">  <b class="spoiler_title">Scheduled task launch class</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YaBackupJob</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CronJob</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $conf; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $conf_name = <span class="hljs-string"><span class="hljs-string">'adevelop'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf = lmbToolkit::instance()-&gt;getConf(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf_name); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YaBackup(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;conf); $backup-&gt;execute(); } }</code> </pre><br></div></div><br><br>  Here, as elsewhere, the standard Limb configuration file mechanism is used.  In principle, a class can be made abstract, but it is as convenient to whom. <br>  There was a question of launch.  The task itself is launched using the cron_runner.php script.  Which connects the file with the task class, creates an object of this class and ensures that the same task is not simultaneously performed by two processes (the latter is implemented on the basis of file locks). <br><div class="spoiler">  <b class="spoiler_title">cron_runner.php</b> <div class="spoiler_text"><pre> <code class="php hljs">set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/../setup.php'</span></span>); lmb_require(<span class="hljs-string"><span class="hljs-string">'limb/core/src/lmbBacktrace.class.php'</span></span>); lmb_require(<span class="hljs-string"><span class="hljs-string">'limb/fs/src/lmbFs.class.php'</span></span>); lmb_require(<span class="hljs-string"><span class="hljs-string">'ya/src/YaLogger.class.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> lmbBacktrace; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_error_in_log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($errno, $errstr, $errfile, $errline)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $logger; $back_trace = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> lmbBacktrace(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $error_str = <span class="hljs-string"><span class="hljs-string">" error: $errstr\nfile: $errfile\nline: $errline\nbacktrace:"</span></span>.$back_trace-&gt;toString(); $logger-&gt;log($error_str,<span class="hljs-string"><span class="hljs-string">"ERROR"</span></span>,$errno); } set_error_handler(<span class="hljs-string"><span class="hljs-string">'write_error_in_log'</span></span>); error_reporting(E_ALL); ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($argc &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Usage: php cron_runner.php cron_job_file_path(starting from include_file_path)'</span></span> . PHP_EOL); $cron_job_file_path = $argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $logger = YaLogger::instance(); $lock_dir = LIMB_VAR_DIR . <span class="hljs-string"><span class="hljs-string">'/cron_job_lock/'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!file_exists($lock_dir)) lmbFs :: mkdir($lock_dir, <span class="hljs-number"><span class="hljs-number">0777</span></span>); $name = array_shift(explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, basename($cron_job_file_path))); $lock_file = $lock_dir . $name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!file_exists($lock_file)) { file_put_contents($lock_file, <span class="hljs-string"><span class="hljs-string">''</span></span>); chmod($lock_file, <span class="hljs-number"><span class="hljs-number">0777</span></span>); } $fp = fopen($lock_file, <span class="hljs-string"><span class="hljs-string">'w'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!flock($fp, LOCK_EX + LOCK_NB)) { $logger-&gt;logConflict(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } flock($fp, LOCK_EX + LOCK_NB); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { lmb_require($cron_job_file_path); $job = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!in_array(<span class="hljs-string"><span class="hljs-string">'-ld'</span></span>, $argv)) $logger-&gt;log(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">"START"</span></span>); ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $name . <span class="hljs-string"><span class="hljs-string">' started'</span></span> . PHP_EOL; $result = $job-&gt;run(); $output = ob_get_contents(); ob_end_clean(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!in_array(<span class="hljs-string"><span class="hljs-string">'-ld'</span></span>, $argv)) $logger-&gt;log($output,<span class="hljs-string"><span class="hljs-string">"END"</span></span>,$result); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (lmbException $e) { $logger-&gt;logException($e-&gt;getNiceTraceAsString()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> $e; } flock($fp, LOCK_UN); fclose($fp); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(in_array(<span class="hljs-string"><span class="hljs-string">'-v'</span></span>, $argv)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $output; var_dump($logger-&gt;getRecords()); }</code> </pre><br></div></div><br><br>  The command is written to the crontab: <br><pre> <code class="bash hljs"> php /path/to/cron_runner.php ya/src/YaBackupJob.class.php</code> </pre><br>  As an argument to the script, pass the path relative to the include_path to the file with the class.  The name of the class itself with the task script determines by file name. <br><br><h4>  Conclusion </h4><br>  I would be glad if anyone could use this code.  Links to a full working example are given below. <br>  Constructive criticism is welcome.  Waiting for your comments and feedback. <br><br><h4>  Links and sources </h4><br><ul><li>  The latest version of the archive with an example can be found <a href="http://yadi.sk/d/SI7JZJ4YEcbZN">here</a> or <a href="http://a-develop.ru/catalog/product/3">here.</a> </li><li>  Repository on github <a href="https://github.com/vasiatka/YaBackup">YaBackup</a> </li><li>  Yandex <a href="">OAuth</a> Documentation and <a href="">Disk</a> <br>  <a href="http://tools.ietf.org/html/rfc6749">OAuth Standard</a> <br>  <a href="http://www.webdav.org/specs/rfc4918.html">WebDav Standard</a> <br>  <a href="https://github.com/limb-php-framework/limb">Limb framework</a> <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/206752/">https://habr.com/ru/post/206752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206740/index.html">Registration for the DevCon 2014 conference is open</a></li>
<li><a href="../206742/index.html">A gift from Skype for the new year</a></li>
<li><a href="../206744/index.html">Working with Group Policy Preferences: How to Stop Using Specific Devices</a></li>
<li><a href="../206746/index.html">Is there life without marketing or PR of a social project?</a></li>
<li><a href="../206748/index.html">Android widget development</a></li>
<li><a href="../206754/index.html">Delphi XE5 + Android: First Impressions</a></li>
<li><a href="../206758/index.html">What to write in the subject of the letter: choose words wisely</a></li>
<li><a href="../206762/index.html">A beta version of the product for the visual creation of Windows 8.1 applications Microsoft Project Siena</a></li>
<li><a href="../206768/index.html">About Vagrant, its plugins, and other life stories of vagrants</a></li>
<li><a href="../206770/index.html">Technical Details on BitTorrent Secure P2P Chat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>