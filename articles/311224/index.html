<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of one study in log4net and its acceleration more than 10 times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To begin with, this optimization will only work if you use values ‚Äã‚Äãtaken from Properties (for example: NDC, MDC) and do not use UserName. 
 Introduct...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of one study in log4net and its acceleration more than 10 times</h1><div class="post__text post__text-html js-mediator-article"><p>  To begin with, this optimization will only work if you use values ‚Äã‚Äãtaken from Properties (for example: NDC, MDC) and do not use UserName. </p><a name="habracut"></a><br><h1>  Introduction </h1><br><p>  I work for a grocery company, where there are many small services related to each other.  Since companies are over 10 years old, services have had a history.  Log4net is used for logging data.  Previously, all services wrote their logs to the database, using buffering and a separate dispatcher for writing, in order not to bother the workflow with logging.  Over time, a bunch of nxlog + elasticsearch + kibana appeared, which made service support much more pleasant.  A gradual migration of services to a new stack has begun.  From this point on, we already had two configurations for log4net: </p><br><ul><li>  write to the database </li><li>  write in nxlog </li></ul><br><h1>  Task </h1><br><p>  Sometimes we have a situation when a service writes an error message and we need to figure out what caused this.  To get the full picture and make the right conclusions, we need all the logs associated with this order from all services.  But here‚Äôs the problem: we don‚Äôt have any tags to link them.  Therefore, we began to generate a unique value and transfer it between our services along with the order.  Before you start processing an order, we call the following code in a simplified form so that it can get into the logs. </p><br><pre><code class="hljs objectivec">LogicalThreadContext.Properties[<span class="hljs-string"><span class="hljs-string">"CorrelationId"</span></span>] = Guid.NewGuid();</code> </pre> <br><p>  An example of our log4net configuration in web.config: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4net</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nxlog"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Appender.RemoteSyslogAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">threshold</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DEBUG"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Layout.SerializedLayout, log4net.Ext.Json"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">decorator</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Layout.Decorators.StandardTypesDecorator, log4net.Ext.Json"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">default</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'nxlog'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">member</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CorrelationId|%property{CorrelationId}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nxlog"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4net</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h1>  Problem </h1><br><p>  But when we started adding this functionality to the old services, replacing the record in the database with the record in nxlog.  Our changes did not go through to code review due to the fact that this configuration on 100,000 entries in the log took 15 seconds of computer time, while the configuration with writing to the database is only 1.2 seconds.  Then we tried to save the CorrelationId to the database and were defeated.  When buffering, Properties were not remembered where our value was stored, but only Message and Exception. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Buffering"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Appender.BufferingForwardingAppender"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bufferSize</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"512"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Message | Exception"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Database"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  And as soon as we added the Properties to the Fix property, then a little more than 12 seconds of computer time per 100,000 records went to the log.  And this is only for buffering, not to mention saving to the database in the background.  To be honest, we were greatly surprised by this and even more we were surprised by the results of the profiler: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">log4net.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoggingEvent</span></span> : <span class="hljs-title"><span class="hljs-title">ISerializable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateCompositeProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_compositeProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompositeProperties(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_compositeProperties.Add(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_eventProperties); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_compositeProperties.Add(LogicalThreadContext.Properties.GetProperties(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.m_compositeProperties.Add(ThreadContext.Properties.GetProperties(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)); PropertiesDictionary propertiesDictionary = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertiesDictionary(); propertiesDictionary[<span class="hljs-string"><span class="hljs-string">"log4net:UserName"</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.UserName; <span class="hljs-comment"><span class="hljs-comment">// &lt;-  70%       propertiesDictionary["log4net:Identity"] = (object) this.Identity; this.m_compositeProperties.Add(propertiesDictionary); this.m_compositeProperties.Add(GlobalContext.Properties.GetReadOnlyProperties()); } } }</span></span></code> </pre><br><p>  For some reason that is not clear to us, the LoggingEvent class, which stores all the information about the record in itself, tries to remember the name of the user in Properties, although we didn‚Äôt ask for it exactly, because for this, there is a corresponding property in the same class . </p><br><h1>  Short term solution </h1><br><p>  As a result, Accelerate ForwardingAppender was born, in which UserName and Identity values ‚Äã‚Äãare remembered during creation and copied to all LoggingEvent objects, without wasting time on the calculation each time.  I want to warn you that our service is running under IIS_IUSRS and it does not change with us, so it works for us.  But it may not work for you if you have Windows authentication, for example. </p><br><div class="spoiler">  <b class="spoiler_title">AccelerateForwardingAppender.cs</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq.Expressions; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.CompilerServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Principal; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> log4net.Appender; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> log4net.Core; namespace log4net.ext.boost { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AccelerateForwardingAppender : ForwardingAppender { private static readonly FieldAccessor&lt;LoggingEvent, LoggingEventData&gt; LoggingEventDataAccessor; static AccelerateForwardingAppender() { LoggingEventDataAccessor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FieldAccessor&lt;LoggingEvent, LoggingEventData&gt;(@"m_data"); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> AccelerateForwardingAppender() { CacheUsername = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; CacheIdentity = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; Username = WindowsIdentity.GetCurrent().Name ?? string.Empty; <span class="hljs-keyword"><span class="hljs-keyword">Identity</span></span> = Thread.CurrentPrincipal.<span class="hljs-keyword"><span class="hljs-keyword">Identity</span></span>?.Name ?? string.Empty; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> CacheUsername { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> CacheIdentity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Username { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Identity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } protected override <span class="hljs-type"><span class="hljs-type">void</span></span> Append(LoggingEvent loggingEvent) { Accelerate(loggingEvent); base.Append(loggingEvent); } protected override <span class="hljs-type"><span class="hljs-type">void</span></span> Append(LoggingEvent[] loggingEvents) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; loggingEvents.Length; i++) { Accelerate(loggingEvents[i]); } base.Append(loggingEvents); } [MethodImpl(MethodImplOptions.AggressiveInlining)] private <span class="hljs-type"><span class="hljs-type">void</span></span> Accelerate(LoggingEvent loggingEvent) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CacheUsername || CacheIdentity) { var loggingEventData = LoggingEventDataAccessor.<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(loggingEvent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CacheUsername) { loggingEventData.UserName = Username; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CacheIdentity) { loggingEventData.<span class="hljs-keyword"><span class="hljs-keyword">Identity</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Identity</span></span>; } LoggingEventDataAccessor.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(loggingEvent, loggingEventData); } } private sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> FieldAccessor&lt;TSubject, TField&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> readonly Func&lt;TSubject, TField&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> readonly Action&lt;TSubject, TField&gt; <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> FieldAccessor(string fieldName) { <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> = FieldReflection.CreateGetDelegate&lt;TSubject, TField&gt;(fieldName); <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> = FieldReflection.CreateSetDelegate&lt;TSubject, TField&gt;(fieldName); } } private static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> FieldReflection { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Func&lt;TSubject, TField&gt; CreateGetDelegate&lt;TSubject, TField&gt;(string fieldName) { var owner = Expression.Parameter(typeof(TSubject), @"owner"); var field = Expression.Field(<span class="hljs-keyword"><span class="hljs-keyword">owner</span></span>, fieldName); var lambda = Expression.Lambda&lt;Func&lt;TSubject, TField&gt;&gt;(field, <span class="hljs-keyword"><span class="hljs-keyword">owner</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lambda.Compile(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Action&lt;TS, TF&gt; CreateSetDelegate&lt;TS, TF&gt;(string fieldName) { var owner = Expression.Parameter(typeof(TS), @"owner"); var <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = Expression.Parameter(typeof(TF), @"value"); var field = Expression.Field(<span class="hljs-keyword"><span class="hljs-keyword">owner</span></span>, fieldName); var assign = Expression.Assign(field, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); var lambda = Expression.Lambda&lt;Action&lt;TS, TF&gt;&gt;(assign, <span class="hljs-keyword"><span class="hljs-keyword">owner</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lambda.Compile(); } } } }</code> </pre> </div></div><br><p>  I uploaded the source code with tests on <a href="https://github.com/kolbasik/log4net.ext.boost">github</a> , I also used the <a href="http://www.nuget.org/packages/BenchmarkDotNet">BenchmarkDotNet</a> library to compare performance. </p><br><div class="spoiler">  <b class="spoiler_title">Benchmark.cs</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Diagnostics</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BenchmarkDotNet.Attributes; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BenchmarkDotNet.<span class="hljs-keyword"><span class="hljs-keyword">Columns</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BenchmarkDotNet.Configs; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BenchmarkDotNet.Jobs; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> BenchmarkDotNet.Running; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> log4net.Appender; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> log4net.Core; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> log4net.Layout; namespace log4net.ext.boost.benchmark { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { private static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { var config = ManualConfig.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(DefaultConfig.Instance) .<span class="hljs-keyword"><span class="hljs-keyword">With</span></span>(PlaceColumn.ArabicNumber) .<span class="hljs-keyword"><span class="hljs-keyword">With</span></span>(StatisticColumn.AllStatistics) .<span class="hljs-keyword"><span class="hljs-keyword">With</span></span>(Job.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>); BenchmarkRunner.Run&lt;BoostBenchmark&gt;(config); Console.WriteLine("Press any key to exit..."); Console.ReadKey(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BoostBenchmark { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> BoostBenchmark() { Trace.AutoFlush = Trace.UseGlobalLock = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Trace.Listeners.Clear(); TraceAppender = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TraceAppender { Layout = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PatternLayout("%timestamp [%thread] %ndc - %message%newline") }; AccelerateForwardingAppender = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AccelerateForwardingAppender(); AccelerateForwardingAppender.AddAppender(TraceAppender); } private TraceAppender TraceAppender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } private AccelerateForwardingAppender AccelerateForwardingAppender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } [Benchmark] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> TraceAppenderBenchmark() { <span class="hljs-keyword"><span class="hljs-keyword">Perform</span></span>(TraceAppender); } [Benchmark] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> AcceleratedTraceAppenderBenchmark() { <span class="hljs-keyword"><span class="hljs-keyword">Perform</span></span>(AccelerateForwardingAppender); } private static <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Perform</span></span>(IAppender appender) { appender.DoAppend(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LoggingEvent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LoggingEventData { <span class="hljs-type"><span class="hljs-type">TimeStamp</span></span> = DateTime.UtcNow, Message = "TEST" })); } } } }</code> </pre> </div></div><br><pre> Host Process Environment Information:
 BenchmarkDotNet.Core = v0.9.9.0
 OS = Microsoft Windows NT 6.2.9200.0
 Processor = Intel (R) Core (TM) i7-6700HQ CPU 2.60GHz, ProcessorCount = 8
 Frequency = 2531255 ticks, Resolution = 395.0609 ns, Timer = TSC
 CLR = MS.NET 4.0.30319.42000, Arch = 32-bit RELEASE
 GC = Concurrent Workstation
 JitModules = clrjit-v4.6.1586.0

 Type = BoostBenchmark Mode = Throughput  
</pre><br><table><thead><tr><th>  Method </th><th>  Median </th><th>  Stddev </th><th>  Mean </th><th>  Stderror </th><th>  Stddev </th><th>  Op / s </th><th>  Min </th><th>  Q1 </th><th>  Median </th><th>  Q3 </th><th>  Max </th><th>  Place </th></tr></thead><tbody><tr><td>  TraceAppenderBenchmark </td><td>  104.5323 us </td><td>  4.5553 us </td><td>  105.4234 us </td><td>  0.8934 us </td><td>  4.5553 us </td><td>  9485.56 </td><td>  98.7720 us </td><td>  102.2095 us </td><td>  104.5323 us </td><td>  107.0166 us </td><td>  116.3275 us </td><td>  2 </td></tr><tr><td>  AcceleratedTraceAppenderBenchmark </td><td>  2.6890 us </td><td>  0.1433 us </td><td>  2.7820 us </td><td>  0.0236 us </td><td>  0.1433 us </td><td>  359456.73 </td><td>  2.6134 us </td><td>  2.6629 us </td><td>  2.6890 us </td><td>  2.9425 us </td><td>  3.0275 us </td><td>  one </td></tr></tbody></table><br><p>  According to the results, it is clear that the increase is quite solid, 359456.73 / 9485.56 = 37.9 times.  Such great importance is due to the fact that in the test logs are not saved anywhere.  On our services, logs are sent to nxlog and therefore for us the real increase was 10 times, 15 seconds of computer time turned into 1.5 seconds. </p><br><h1>  Long term solution </h1><br><p>  Encouraged by this result, I made a <a href="https://github.com/apache/log4net/pull/28">pull request</a> for log4net, where I offered to remove duplicate code, and received the expected answer: </p><br><pre> bodewig:
</pre><br><p>  On the one hand, the author is right: any change can be critical for someone, but on the other hand, it‚Äôs a shame that so much time is being wasted.  I would like to know your opinion. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311224/">https://habr.com/ru/post/311224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311210/index.html">Complex Data Visualization Algorithm</a></li>
<li><a href="../311212/index.html">Installation and optimal configuration of Nginx + LAMP (CentOS 7)</a></li>
<li><a href="../311214/index.html">When exceptions are needed</a></li>
<li><a href="../311218/index.html">How do we test the server code without mobile clients?</a></li>
<li><a href="../311220/index.html">Programming & Music: we understand and write VSTi synthesizer on C # WPF. Part 1</a></li>
<li><a href="../311226/index.html">JSX: antipattern or not?</a></li>
<li><a href="../311230/index.html">Alexey Igoshin (HomeApp) changes the rules of the game on the Russian real estate market using information technology</a></li>
<li><a href="../311232/index.html">Using autoencoders to build a recommendation system</a></li>
<li><a href="../311234/index.html">learnopengl. Lesson 1.3 - Hello Window</a></li>
<li><a href="../311236/index.html">New NetApp Storage Systems Running ONTAP 9.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>