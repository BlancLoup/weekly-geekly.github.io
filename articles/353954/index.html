<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience using Megaplan API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before that, I had never come across a CRM Megaplan and did not know that it exists. A good friend of mine offered me a side job, said that one of his...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience using Megaplan API</h1><div class="post__text post__text-html js-mediator-article"><p>  Before that, I had never come across a CRM Megaplan and did not know that it exists.  A good friend of mine offered me a side job, said that one of his acquaintances was looking for a programmer to write a small program or script to automate work. <br>  It was said that it is necessary to get data from an API from some system, process it and display it in XLS.  I found the proposal interesting, I phoned the customer and made an appointment. </p><br><p>  Just want to say that I am in no way affiliated with the Megaplan itself and I am not going to advertise it. </p><br><h2 id="postanovka-zadachi">  Formulation of the problem </h2><br><p>  The customer is an enterprise with approximately 50 employees. </p><br><p>  Employees, projects and tasks are instituted in CRM. </p><br><p>  Employees perform assigned tasks.  At the same time in the comments to the task, they indicate the number of hours worked.  In addition, the core clock is spent on performing the task (computer time clock). </p><br><p>  They are also listed in each task in a separate field. </p><br><p>  The customer needs to generate a report in XLS according to data from Megaplan for the specified time period. </p><br><p>  For each project, for each task, you need to know how many working hours and ‚Äúcore-hours‚Äù were spent. </p><br><p>  Those.  Costs are grouped first by project, then by task, then by each employee. </p><br><p>  A sample report is shown in the figure below. </p><br><p><img src="https://habrastorage.org/webt/w6/g5/kx/w6g5kxci53g6sm-ys-khwqu7e0o.png" alt="image"></p><br><p>  The customer could not receive such a report using Megaplan.  Therefore, it was decided to invite a third-party developer to develop a program / script that will solve the problem. </p><br><p>  Deadline: 1 week. <br>  Price: 20 thousand rubles. </p><br><p>  The budget is small, the information on the Internet about the experience of using the Megaplan API is even less.  I found this <a href="https://habrahabr.ru/sandbox/82791/">article</a> here on Habr√©, and it was not at all encouraging.  It smelled of problems, the money was not much needed, but it was interesting and wanted to help people in their routine.  I agreed. </p><a name="habracut"></a><br><h2 id="vybor-skriptovogo-yazyka-i-biblioteki-dlya-raboty-s-megaplan-api">  Choosing a scripting language and library for working with Megaplan API </h2><br><p>  Initially, there was a desire to take Python, read the API documentation and write a script, <br>  which requests all the necessary data from Megaplan by API, processes it and outputs it to XLSX. </p><br><p>  However, problems with the API started from the very beginning.  It turned out that for each request you need <br>  calculate the value of <strong>X-Authorization</strong> header by some algorithm. </p><br><p>  Those.  just learning the API using curl or httpie will fail. </p><br><p>  Accordingly, I realized that I need to "cut off the corner" and look for some ready-made library to work with the Megaplan API.  I was interested mainly in libraries for Python and Javascript.  On github I found the <a href="https://github.com/search%3Fq%3Dmegaplan%26amp%3Btype%3DRepositories">following libraries</a> .  Most of them are dead projects, there are still a lot of PHP hacks. </p><br><p>  I did not have to choose for a long time, I stopped at the library for the javascript language <br>  <a href="https://github.com/zxqfox/megaplanjs">megaplanjs</a> . </p><br><p>  First, I use javascript every day for the frontend. </p><br><p>  Secondly, it was interesting to develop something for the command line on javascript. <br>  Third, I was able to quickly install the library (thanks to npm), copy an example from <br>  documentation and ... my application can already be authenticated in Megaplan and <br>  get a list of projects.  Hooray! </p><br><h2 id="obnaruzhennye-problemy-s-megaplan-api">  Detected problems with Megaplan API </h2><br><ul><li>  The problem with the study / study API.  For each request, you need to calculate the value of the <strong>X-Authorization</strong> header by some algorithm.  I already wrote about this above. </li><li>  API Restriction: API request rate is limited to (50 * N) requests per minute, where N is the number of licenses. </li><li>  Paginated data reading.  Projects, comments to projects, tasks, comments to tasks need to be received page by page.  At the same time, the megaplanjs library was not ready for this and silently returned only the first 50 pieces to me.  I had to finish the library myself. </li><li>  Extended (custom) task fields.  The core clock, which I mentioned above, was the user-defined (custom) field of the task.  I could not get them through the API.  I had to contact support.  There I was suggested an undocumented way to get them.  At the same time, I had to make an additional request for each task in order to get the value of this field. </li><li>  Error with Task.TimeUpdated.  The API has the ability to get a list of tasks that have been updated (updated) <u>after a</u> certain point in time.  By the way, there is no way to get updated / changed tasks <u>up to a</u> certain point.  So, it turns out that getting the list of tasks updated after the specified time does not work correctly.  For example, if a comment was added to the task, which indicates that the employee spent X hours on the task, this does not change the task update time.  Therefore, I had to select all tasks through the API and filter them independently by the <strong>activity</strong> field of the <strong>activity</strong> - the last activity time by task. </li></ul><br><h2 id="chem-delo-zakonchilos-i-vyvody">  How it ended and the conclusions </h2><br><p>  I was able to solve the task, but I spent much more time on it than I planned. </p><br><p>  This time was not paid, the customer just needed a result.  How he is reached, he is not interested. </p><br><p>  3 times I turned to the support service.  Not immediately, but helped.  Thank. </p><br><p>  To those developers who are just thinking of doing subj-I, I recommend better assess their risks and allow more time to develop. </p><br><p>  Now Megaplan has a new version of API - version 3 (I used version 1, version 2 was not?).  I looked at version 3, did not find what I needed (projects, tasks, employees).  Version 3 may be just an addition to version 1, not a replacement.  I also read that they promised to simplify the work with the API - I will not need to form the <strong>X-Authorization</strong> header for each request. </p><br><p>  I uploaded the source code for my script on <a href="https://github.com/azakharo/megaplan_reports">github</a> . <br>  If necessary, it can be used as an example to quickly start your application. </p><br><p>  All successful development, happy coding! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/353954/">https://habr.com/ru/post/353954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353944/index.html">Open lesson "iSCSI in Linux"</a></li>
<li><a href="../353946/index.html">Character kotlin</a></li>
<li><a href="../353948/index.html">Hijacking Telegram on Panic Waves</a></li>
<li><a href="../353950/index.html">Experiments on cats: how to increase the number of purchases in the application</a></li>
<li><a href="../353952/index.html">Issue # 19: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../353956/index.html">Learn OpenGL. Lesson 5.3 - Shadow Maps</a></li>
<li><a href="../353958/index.html">Compare Draft, Gitkube, Helm, Ksonnet, Metaparticle and Skaffold</a></li>
<li><a href="../353960/index.html">Money & Design. How to earn more than 200.000 ‚ÇΩ if you work alone</a></li>
<li><a href="../353962/index.html">Automate UI testing on PhoneGap. Payment application case</a></li>
<li><a href="../353966/index.html">New standards for passwordless authentication: how they work</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>