<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XEN: A simple script to quickly open VNC consoles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 
 Description of the problem 
 Xen with HVM virtualization is actively used in the work. It often happens that you need to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XEN: A simple script to quickly open VNC consoles</h1><div class="post__text post__text-html js-mediator-article"><h2>  Formulation of the problem </h2><br><h4>  Description of the problem </h4><br>  Xen with HVM virtualization is actively used in the work.  It often happens that you need to get access to the console of virtual machines, including those who do not have access to the north with Xen.  For this, Xen has the ability to create a VNC console for each virtual machine, but each time it is inconvenient to manually connect via VNC. <br><br><h4>  Task </h4><br>  Create a web page with a list of running virtual machines and a VNC applet embedded in it, which can be opened by clicking the link.  On the way, work out how to work with Xen from Python. <br><br><h2>  What happened </h2><br><h4>  List of running domU </h4><br><img src="https://habrastorage.org/storage2/7a9/b60/713/7a9b60713a211acb8151b4a6270c7bb1.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  VNC console itself </h4><br><img src="https://habrastorage.org/storage2/668/8fe/c30/6688fec309a113fe39e83a6d24aeb624.png"><br><br><a name="habracut"></a><br><br><h2>  How come </h2><br>  I used Python and a lightweight web framework, CherrouPy. <br><br><h4>  What it consists of </h4><br><pre><code class="bash hljs">vm_console.py <span class="hljs-comment"><span class="hljs-comment">#   static #     static/table.htm #    domU,          static/vnc.js # javascript      VNC-       static/vnc.htm #      VNC-,         static/tightvnc-jviewer.jar # java-    VNC,   http://www.tightvnc.com/ static/styles.css #      domU,   http://veerle-v2.duoh.com/blog/comments/a_css_styled_table/ static/images #     static/images/bg_header.jpg static/images/bullet1.gif</span></span></code> </pre> <br><br><h4>  Self skrpit </h4><br>  The logic of the script is as follows: <br><pre> <code class="hljs 1c"><span class="hljs-keyword"><span class="hljs-keyword"></span></span>  -    domU    VNC-    <span class="hljs-keyword"><span class="hljs-keyword"></span></span>            java VNC-       </code> </pre><br>  We import the necessary modules: cherrypy itself, a module for interacting with a XEN server, and a module for regular expressions to patch the address and port of a VNC server: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cherrypy <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xen.util.xmlrpcclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerProxy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re</code> </pre> <br>  The class for getting a list of running domU and forming a table <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xen</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Communicates with xen via rpc"""</span></span> @staticmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_domains</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Gets a dictionary with 'Domain Name':'VNC host:port' structure"""</span></span> server = ServerProxy(<span class="hljs-string"><span class="hljs-string">'httpu:///var/run/xend/xmlrpc.sock'</span></span>) domains = server.xend.domains_with_state(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) domain_list = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> first_level <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> domains: <span class="hljs-comment"><span class="hljs-comment"># iterate through first level parameters for second_level in first_level: # iterate through second level parameters if second_level[0] == "name" and second_level[1] != "Domain-0": domain_list_current = second_level[1] if second_level[0] == "device": for third_level in second_level[1]: # iterate through third level subparameters if third_level[0] == "location" and re.match("\d+\.\d+\.\d+\.\d+\:\d\d\d\d", third_level[1]): domain_list[domain_list_current] = str(third_level[1]) return domain_list @staticmethod def create_domain_table(): """Creates table from domain list""" table = """&lt;table id='mytable' cellspacing='0'&gt;&lt;caption&gt;List of active domUs&lt;/caption&gt; &lt;th scope="col" class="nobg"&gt;domU&lt;/th&gt; &lt;th scope="col"&gt;VNC host:port&lt;/th&gt; """ domain_list = xen.get_domains() for k, v in domain_list.iteritems(): link = v.split(':', 1)[1] table += """ &lt;tr&gt; &lt;th class="spec" scope="row"&gt;%s&lt;/th&gt; &lt;td&gt;&lt;a href="javascript:vnc_console('/vnc/%s')" target='_blank'&gt;%s&lt;/a&gt;&lt;/td&gt; &lt;/tr&gt; """ % (k, link, v) table += "&lt;/table&gt;" return table</span></span></code> </pre><br>  It connects to the XEN server through a socket, and pulls out a list of running domUs with a variety of attributes.  Then the necessary attributes are pulled out of these attributes: the domU name and the address: the port of the VNC server.  After that, a table with a list of running domU is formed. <br><br>  I looked at the connection method in the xm utility that comes with the xen, I have it in <pre> <code class="python hljs">/usr/lib64/python2<span class="hljs-number"><span class="hljs-number">.7</span></span>/site-packages/xen/util/xmlrpcclient.py</code> </pre>  Perhaps in the future, if there is time, I will redo the connection to the XEN server in a more correct way via XenApi. <br><br>  Class for displaying a webpage: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">listvm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, port=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Just a stub"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"""&lt;h1&gt;&lt;a href="/vnc/"&gt;vnc&lt;/a&gt;&lt;/h1&gt;"""</span></span> index.exposed = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vnc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, port=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Show running vm's or open vnc applet"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> port: template = open(<span class="hljs-string"><span class="hljs-string">"static/vnc.htm"</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>).read() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template % port <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: template = open(<span class="hljs-string"><span class="hljs-string">"static/table.htm"</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>).read() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template % xen.create_domain_table() vnc.exposed = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br>  We are interested in the vnc function.  If go to <pre> <code class="python hljs">&lt; &gt;/vnc</code> </pre>  it will display a list of running domUs, if you pass it the necessary port through a slash, for example <pre> <code class="python hljs">&lt; &gt;/vnc/<span class="hljs-number"><span class="hljs-number">5900</span></span></code> </pre>  it will launch the desired console.  Consoles are started using javascript function torn from Proxmox VE.  After opening the applet, another function from Proxmox VE adjusts the size of the new window to the required one. <br><br>  Config webpy server cherrypy, here everything is trivial: <br><pre> <code class="python hljs">server_config = { <span class="hljs-string"><span class="hljs-string">'server.socket_host'</span></span>: <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'server.socket_port'</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-string"><span class="hljs-string">'tools.staticdir.root'</span></span>: <span class="hljs-string"><span class="hljs-string">"/usr/local/vm_console"</span></span>, <span class="hljs-string"><span class="hljs-string">'tools.staticdir.debug'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, } cherrypy.config.update(server_config) listvm_config = { <span class="hljs-string"><span class="hljs-string">'/static'</span></span>: {<span class="hljs-string"><span class="hljs-string">'tools.staticdir.on'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'tools.staticdir.dir'</span></span>: <span class="hljs-string"><span class="hljs-string">"static"</span></span>, } } cherrypy.tree.mount(listvm(), <span class="hljs-string"><span class="hljs-string">'/'</span></span>, config=listvm_config) cherrypy.engine.start() cherrypy.engine.block()</code> </pre><br><br><h2>  I want to poke </h2><br>  I posted everything on github, you can take it here: <a href="https://github.com/sistemshik/vm_console">github.com/sistemshik/vm_console</a> </div><p>Source: <a href="https://habr.com/ru/post/143694/">https://habr.com/ru/post/143694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143687/index.html">User experience design: how to build a website for customers, not for yourself</a></li>
<li><a href="../143688/index.html">Indicate a mobile phone or tablet in the Firefox User-Agent header</a></li>
<li><a href="../143690/index.html">F # Tail recursion. Underwater rake. Part 1</a></li>
<li><a href="../143691/index.html">Hard links for repository cloning in mercurial</a></li>
<li><a href="../143692/index.html">Facebook smartphone will be on Windows Phone?</a></li>
<li><a href="../143695/index.html">Domen.RF: just statistics and a little bit of freebies in the bargain</a></li>
<li><a href="../143698/index.html">Mobiscroll - custom select for mobile sites and not only</a></li>
<li><a href="../143699/index.html">Bomberman Online - HTML5 multiplayer online game from habrauser. We are testing the load!</a></li>
<li><a href="../143700/index.html">SELinux in practice: DVWA test</a></li>
<li><a href="../143701/index.html">How to read to the end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>