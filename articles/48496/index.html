<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Treatment of dead files, download and resume</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic you will learn how: 


- recover damaged downloads, even if the file is not in torrents and other sources that contain the hash of its f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Treatment of dead files, download and resume</h1><div class="post__text post__text-html js-mediator-article">  In this topic you will learn how: <br><ul><li>  recover damaged downloads, even if the file is not in torrents and other sources that contain the hash of its fragments; </li><li>  download file with resume, even if it is not supported by the server; </li><li>  download, if the server does not provide direct links, giving the file from different addresses (but gives Partial Content). </li></ul><br>  Today stumbled upon the topic " <a href="http://habrahabr.ru/blogs/p2p/53110/">Torrent vs.</a>  <a href="http://habrahabr.ru/blogs/p2p/53110/">64 kbps</a> ‚Äùand I saw a problem that I ran into a week ago. <br><br>  For quite a long time, 10 days (with interruptions), I downloaded a 3.5 GB ISO image at my 100 Kbps.  And this very image was damaged when downloading.  I tried to search for this case in torrents and use the method described in the above topic - I used to restore files like this before.  But the file was not there (and the resource from where I downloaded it only got a couple of weeks ago).  In order not to start kicking me for piracy, I will immediately say that I downloaded <a href="https://www.dreamspark.com/Products/product.aspx%3Fproductid%3D1">Visual Studio 2008 Professional SP1 RUS</a> from <a href="http://www.dreamspark.com/">Dreamspark</a> . <br><br>  So, I didn‚Äôt want to wait another 10 days, just like producing a lot of manual work, as a result of which a script was born, which fulfilled the whole dirty process ... <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Idea </h4><br>  It was necessary to minimize the amount of information that will have to be pumped, and actually somehow identify these damaged pieces.  From here, the plan of action obviously follows: <br><ul><li>  we cut the downloaded file into rather small pieces; </li><li>  we consider hash; </li><li>  compare with some reference, identifying the "bad"; </li><li>  Download the necessary pieces and glue. </li></ul><br>  And where to get this ‚Äúcorrect‚Äù hash?  In order not to download everything entirely to yourself, you need some third-party place where you can download a file at a much higher speed.  I just had access to the site of virtual hosting, including SSH - just what we need.  But ... the space there was not at all 3.5 GB, but only 1.5 GB.  As a result, the thought came not to pull the entire file at once, but in pieces. <br><br><h4>  Code </h4><br>  As a result of all these fabrications, the following code was born (let's call the file <a href="http://narod.ru/disk/6210521000/verify_md5.php.html">md5_verify.php</a> ). <br><br> <code><font color="#000000"><font color="#0000BB">&lt;?php <br> $md5sum</font> <font color="#007700">=</font> <font color="#DD0000">'md5sum.txt'</font> <font color="#007700">;</font> <font color="#008000">//    </font> <br> <font color="#0000BB">$tmp</font> <font color="#007700">=</font> <font color="#DD0000">'chunk.tmp'</font> <font color="#007700">;</font> <font color="#008000">//      </font> <br> <font color="#0000BB">$out</font> <font color="#007700">=</font> <font color="#DD0000">'out/'</font> <font color="#007700">;</font> <font color="#008000">//        </font> <br> <br> <font color="#0000BB">$offset</font> <font color="#007700">=</font> 0 <font color="#007700">;</font> <font color="#008000">//     ( )</font> <br> <font color="#0000BB">$chunk</font> <font color="#007700">=</font> <font color="#0000BB">1048576</font> <font color="#007700">;</font> <font color="#008000">//  </font> <br> <font color="#0000BB">$size</font> <font color="#007700">=</font> <font color="#0000BB">3760066560</font> <font color="#007700">;</font> <font color="#008000">//  </font> <br> <br> <font color="#0000BB">$host</font> <font color="#007700">=</font> <font color="#DD0000">'http://all.files.dreamspark.com'</font> <font color="#007700">;</font> <br> <br> <font color="#0000BB">$path</font> <font color="#007700">=</font> <font color="#DD0000">'/dl/studentdownload/7/6/3/76329869-10C4-4360-9B09-98C813F8EAFA/ru_visual_studio_2008_professional_edition_dvd_x86_x15-25526.iso'</font> <font color="#007700">;</font> <br> <font color="#0000BB">$param</font> <font color="#007700">=</font> <font color="#DD0000">'?LCID=1033&amp;__gda__={timestamp}_{hash}'</font> <font color="#007700">;</font> <br> <font color="#0000BB">$cookie</font> <font color="#007700">=</font> <font color="#DD0000">'__sdt__={another-hash-or-guid}'</font> <font color="#007700">;</font> <br> <font color="#0000BB">$url</font> <font color="#007700">=</font> <font color="#0000BB">$host</font> <font color="#007700">.</font> <font color="#0000BB">$path</font> <font color="#007700">.</font> <font color="#0000BB">$param</font> <font color="#007700">;</font> <br> <br> <font color="#008000">//       </font> <br> <font color="#0000BB">$sums</font> <font color="#007700">=</font> <font color="#0000BB">file</font> <font color="#007700">(</font> <font color="#0000BB">$md5sum</font> <font color="#007700">); <br> <br> for (</font> <font color="#0000BB">$i</font> <font color="#007700">=</font> 0 <font color="#007700">,</font> <font color="#0000BB">$l</font> <font color="#007700">=</font> <font color="#0000BB">sizeof</font> <font color="#007700">(</font> <font color="#0000BB">$sums</font> <font color="#007700">);</font> <font color="#0000BB">$i</font> <font color="#007700">&lt;</font> <font color="#0000BB">$l</font> <font color="#007700">&amp;&amp;</font> <font color="#0000BB">$offset</font> <font color="#007700">+</font> <font color="#0000BB">$i</font> <font color="#007700">*</font> <font color="#0000BB">$chunk</font> <font color="#007700">&lt;</font> <font color="#0000BB">$size</font> <font color="#007700">;</font> <font color="#0000BB">$i</font> <font color="#007700">++) <br> { <br></font> <font color="#008000">//      <br></font> <font color="#0000BB">$start</font> <font color="#007700">=</font> <font color="#0000BB">$offset</font> <font color="#007700">+</font> <font color="#0000BB">$i</font> <font color="#007700">*</font> <font color="#0000BB">$chunk</font> <font color="#007700">; <br></font> <font color="#0000BB">$end</font> <font color="#007700">=</font> <font color="#0000BB">min</font> <font color="#007700">(</font> <font color="#0000BB">$size</font> <font color="#007700">,</font> <font color="#0000BB">$offset</font> <font color="#007700">+ (</font> <font color="#0000BB">$i</font> <font color="#007700">+</font> <font color="#0000BB">1</font> <font color="#007700">) *</font> <font color="#0000BB">$chunk</font> <font color="#007700">)</font> <font color="#007700">-</font> <font color="#0000BB">1</font> <font color="#007700">; <br> <br></font> <font color="#008000">//          <br></font> <font color="#007700">list(</font> <font color="#0000BB">$hash</font> <font color="#007700">,</font> <font color="#0000BB">$file</font> <font color="#007700">) =</font> <font color="#0000BB">explode</font> <font color="#007700">(</font> <font color="#DD0000">' '</font> <font color="#007700">,</font> <font color="#0000BB">$sums</font> <font color="#007700">[</font> <font color="#0000BB">$i</font> <font color="#007700">+</font> <font color="#0000BB">intval</font> <font color="#007700">(</font> <font color="#0000BB">$offset</font> <font color="#007700">/</font> <font color="#0000BB">$chunk</font> <font color="#007700">)]); <br> <br></font> <font color="#0000BB">$file</font> <font color="#007700">=</font> <font color="#0000BB">trim</font> <font color="#007700">(</font> <font color="#0000BB">$file</font> <font color="#007700">,</font> <font color="#DD0000">"*\r\n "</font> <font color="#007700">); <br> <br></font> <font color="#008000">//    <br></font> <font color="#0000BB">$fp</font> <font color="#007700">=</font> <font color="#0000BB">fopen</font> <font color="#007700">(</font> <font color="#0000BB">$tmp</font> <font color="#007700">,</font> <font color="#DD0000">"w+"</font> <font color="#007700">); <br> <br></font> <font color="#008000">//   CURL <br></font> <font color="#0000BB">$options</font> <font color="#007700">= array <br> ( <br></font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$url</font> <font color="#007700">, <br></font> <font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">false</font> <font color="#007700">, <br></font> <font color="#0000BB">CURLOPT_COOKIE</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$cookie</font> <font color="#007700">, <br></font> <font color="#0000BB">CURLOPT_RANGE</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$start</font> <font color="#007700">.</font> <font color="#DD0000">'-'</font> <font color="#007700">.</font> <font color="#0000BB">$end</font> <font color="#007700">,</font> <font color="#008000">//        <br></font> <font color="#0000BB">CURLOPT_FILE</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$fp <br></font> <font color="#007700">); <br> <br></font> <font color="#0000BB">$ch</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">();</font> <font color="#008000">//  CURL <br></font> <font color="#0000BB">curl_setopt_array</font> <font color="#007700">(</font> <font color="#0000BB">$ch</font> <font color="#007700">,</font> <font color="#0000BB">$options</font> <font color="#007700">);</font> <font color="#008000">//   <br></font> <font color="#0000BB">curl_exec</font> <font color="#007700">(</font> <font color="#0000BB">$ch</font> <font color="#007700">);</font> <font color="#008000">//  <br></font> <font color="#0000BB">curl_close</font> <font color="#007700">(</font> <font color="#0000BB">$ch</font> <font color="#007700">);</font> <font color="#008000">//   <br></font> <font color="#0000BB">fclose</font> <font color="#007700">(</font> <font color="#0000BB">$fp</font> <font color="#007700">);</font> <font color="#008000">//   <br> <br> //                <br></font> <font color="#0000BB">$broken</font> <font color="#007700">= (</font> <font color="#0000BB">$hash</font> <font color="#007700">!=</font> <font color="#0000BB">md5_file</font> <font color="#007700">(</font> <font color="#0000BB">$tmp</font> <font color="#007700">)); <br> <br></font> <font color="#008000">//   ,       <br></font> <font color="#007700">print</font> <font color="#0000BB">$file</font> <font color="#007700">.</font> <font color="#DD0000">' ['</font> <font color="#007700">.</font> <font color="#0000BB">$start</font> <font color="#007700">.</font> <font color="#DD0000">'-'</font> <font color="#007700">.</font> <font color="#0000BB">$end</font> <font color="#007700">.</font> <font color="#DD0000">']: '</font> <font color="#007700">. (</font> <font color="#0000BB">$broken</font> <font color="#007700">?</font> <font color="#DD0000">'BROKEN'</font> <font color="#007700">:</font> <font color="#DD0000">'OK'</font> <font color="#007700">) .</font> <font color="#DD0000">"\n"</font> <font color="#007700">; <br> <br></font> <font color="#008000">//    ,     (   ) <br></font> <font color="#007700">if (</font> <font color="#0000BB">$broken</font> <font color="#007700">) <br></font> <font color="#0000BB">copy</font> <font color="#007700">(</font> <font color="#0000BB">$tmp</font> <font color="#007700">,</font> <font color="#0000BB">$out</font> <font color="#007700">.</font> <font color="#0000BB">$file</font> <font color="#007700">); <br> <br></font> <font color="#008000">//    <br></font> <font color="#0000BB">unlink</font> <font color="#007700">(</font> <font color="#0000BB">$tmp</font> <font color="#007700">); <br> <br> }</font> <br></font> <br></code> <br><br>  In short, the script downloads the file in parts, comparing the hash of each successive piece, with what we found on our machine.  If it does not match - our piece is broken, and the one on the server is good, we postpone it for later download. <br><br><h4>  Acting </h4><br>  To begin with, what we downloaded must be cut into pieces: <br> <code>C:\ISO&gt;mkdir out &amp;&amp; cd out &amp;&amp; split -a 3 -b 1048576 ..\ru_visual_studio_2008_professional_edition_dvd_x86_x15-25526.iso</code> <br> <br>  The <b>-a</b> parameter indicates the length of the suffix, since it is alphabetic (26 lowercase characters), then 3 will be quite enough for us: 26¬≥ = 17,576, which is clearly more than the number of pieces of 3.5 Gb / 1 Mb ‚âà 3584. <br><br>  When the whole thing is cut, we get files with the names xaaa, xaab, xaac, etc. <br><br>  Now consider the hash: <br> <code>C:\ISO\out&gt;md5sum x* &gt; ..\md5sum.txt</code> <br> <br>  This process is also quite long, in the end a file with the contents of the form will be received: <br> <code>26c379b3718d8a22466aeadd02d734ec *xaaa <br> 2671dc8915abd026010f3d02a5655163 *xaab <br> 6f539fcb0d5336dfd28df48bbe14dd20 *xaac <br> 69f670a2d9f8cf843cdc023b746c3b8c *xaad <br> ‚Ä¶ <br></code> <br><br>  Then we load md5_verify.php and md5sum.txt on the server, and in the same place we create a daddy out, where the pieces that we need to transfer will be added.  We are connecting via SSH and typing the php interpreter into our script.  Now you can go to sleep, walk or watch House MD <br><br>  After a few hours, depending on the width of the channel that is provided to you on the site, the script will end, and in the out folder will be all the pieces that you need to download. <br><br>  Hide them in the archive: <br> <code>tar - jcvf "chunks.tar.bz2" ./out/x*</code> <br> <br>  And finally, you just need to transfer the received archive to the daddy from where you can download it, and set your favorite wget, curl or whatever you like there. <br><br>  Replacing the damaged pieces with what we extracted from the downloaded archive, we can glue the patient back: <br> <code>cat out\x* &gt; fixed.iso</code> <br> <br>  You can cut, glue and hash anything you want, but all who inevitably have to use Windows have long gotten all these little wonderful utilities like cat, split and md5sum, standard for Linux, ported to Windows (the <a href="http://gnuwin32.sourceforge.net/">GnuWin32</a> project). <br><br><h4>  About resume </h4><br>  Yes, by the way, at the same time I found a great way to download with a resume, even if the server is not able to give Partial Content: just simply pull the file to your hosting site through the shell, and then download from there like decent people. <br><br>  Many services, of course, want Referer and / or Cookie, not agreeing to just give up the file.  You can get them: you need Firefox and its extension is <a href="https://addons.mozilla.org/en-US/firefox/addon/3829">Live HTTP Headers</a> . <br><br>  Open the add-on window, click on the site on the link / button "Download", pops up an offer to save the file.  We refuse to download the file by clicking "Cancel", and then copy the data we need from the header. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b5a/d97/d95/b5ad97d95d64369047f62306a1f20064.png" alt="Live HTTP Headers"><br><br>  Well, then we shove this data into your favorite rocking chair (on screenshots, this is all done locally, but you obviously need to do this via SSH on a remote server): <br> <code>wget --header "Referer: http://csna01.libredigital.com/" -O "output.pdf" http://csna02.libredigital.com/cgi-bin/pdf_loader.pl?v=5 <br></code> <br><img src="https://habrastorage.org/getpro/geektimes/post_images/b49/9ea/e6a/b499eae6a9ed658361bdd0ad4a265f96.png" alt="wget"><br> <code>curl -v -e "http://csna01.libredigital.com/" -o "output.pdf" http://csna02.libredigital.com/cgi-bin/pdf_loader.pl?v=5 <br></code> <br><img src="https://habrastorage.org/getpro/geektimes/post_images/426/e15/570/426e15570fe323702e91c5e76c8e006e.png" alt="curl"><br><br>  On the screen you can see the use of the <strong>-c</strong> switch for wget (for curl it is used by <strong>-C</strong> ), it allows you to download, however, it is given here only for demonstration, because the server from the example just does not allow to download. <br><br><h5>  At last </h5><br>  However, it makes sense to use wget and curl with resuming directly on your machine: if you leave the same output file name (the <strong>-O</strong> key), you can download one file in parts at any time and use a new link each time (and with the changed cookie). <br><br>  This is the third "learn how" of the promises at the beginning of the topic. <br><br>  PS The whole story ended with the fact that the patient had ‚âà 500 damaged parts.  It took a couple of hours to write, debug, cut and calculate the hash, several hours to run the script on the server, and about 12 hours to download these parts, which in total took about a day.  Nevertheless, it is much less than again to pump parts in a dozen days (and be sure to damage something again). </div><p>Source: <a href="https://habr.com/ru/post/48496/">https://habr.com/ru/post/48496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../48489/index.html">Quake Live BETA</a></li>
<li><a href="../48491/index.html">When a programmer has nothing to do ...</a></li>
<li><a href="../48492/index.html">Our home-made all-terrain vehicle</a></li>
<li><a href="../48494/index.html">Re: Primitive phishing protection</a></li>
<li><a href="../48495/index.html">Grossing ...</a></li>
<li><a href="../48498/index.html">How to quickly start and effectively continue to write the extension for the fox</a></li>
<li><a href="../48499/index.html">Question: What should be the translation of technical documentation and terms in it?</a></li>
<li><a href="../48502/index.html">Keynote speaker</a></li>
<li><a href="../48504/index.html">Design Review vs Design by Committee</a></li>
<li><a href="../48505/index.html">Who needs a new Mac mini? No one!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>