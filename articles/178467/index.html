<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calls within the organization from the Corporate Portal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many organizations use a wealth of diverse information systems and technical solutions to secure and facilitate their work. Sooner or later the questi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calls within the organization from the Corporate Portal</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/e1a/a7e/1ba/e1aa7e1ba8639655595b2457c1071278.png" align="left"><br>  Many organizations use a wealth of diverse information systems and technical solutions to secure and facilitate their work.  Sooner or later the question of the integration of these systems and solutions arises, and often the choice of a ‚Äúlink‚Äù is adopted in favor of web technologies.  At such a moment, before the web programmer there is a need to master all these hitherto unfamiliar products and solutions. <br><br><br clear="all">  In this article I will describe the integration process: <br><ul><li>  <a href="http://ru.wikipedia.org/wiki/Active_Directory">ActiveDirectory</a> (information about employees and their phone numbers) </li><li>  1C-Bitrix: <a href="http://www.1c-bitrix.ru/products/intranet/">Corporate portal</a> (engine, presentation of information) </li><li>  <a href="http://ru.wikipedia.org/wiki/Asterisk">Asterisk</a> (telephony management system) </li></ul><br>  on the example of creating a call system from the point of view of a web programmer. <br><br><a name="habracut"></a><br>  First of all, of course, you should have: <br><ol><li>  Customized phone system inside the organization </li><li>  Available to connect Asterisk and its web server </li><li>  Phone number information </li><li>  Corporate portal (however, only in this example. The solution can be used on any engine of similar functionality) </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Basically, the solution of these issues goes beyond the competence of a specialist in web technologies, so suppose that we have everything we need and proceed directly to the server and client parts. <br><br>  We will use the following elements: <br><ol><li>  Separate MySQL table with logins and employee numbers.  Data will be downloaded from AD and imported with minimal effort.  In principle, it is possible to refer to the Portal users table, but firstly, it is not welcomed by the Beatrix developers, and secondly - in ours - as I think, in many others - an organization, a phone number can be not only personal, therefore the binding only to one user is irrational.  In addition, we separately made a gadget for the Portal‚Äôs desktop, which allows you to instantly change your internal number in the call system, which allows the Coordination Center's specialists to easily make calls from their profile from any physical workplace. <br>  An example of an entry in the `phones` table: <br><table><tbody><tr><th>  id </th><th>  user </th><th>  number </th></tr><tr><td>  238 </td><td>  LutovVO </td><td>  50512 </td></tr></tbody></table><br></li><li>  PHP file directly passing parameters to an Asterisk server using the <a href="http://www.php.net/curl/">CURL</a> library and processing return values <br><div class="spoiler">  <b class="spoiler_title">call.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-comment"><span class="hljs-comment">//       require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php"); $USER = new CUser; $userlogin = $USER-&gt;GetLogin(); //       $results = $DB-&gt;Query("SELECT `number` FROM `phones` WHERE `user`='".$userlogin."' LIMIT 1"); $userphone = $results-&gt;Fetch(); if (!empty($_POST['call'])) { //      $recipient = str_replace(' ', '', $_POST['recipient']); $recipient = str_replace('+', '', $recipient); $recipient = str_replace('-', '', $recipient); $recipient = str_replace('(', '', $recipient); $recipient = str_replace(')', '', $recipient); $answer = ''; // C   Asterisk $command = array(); $command[1] = 'action=login&amp;username=PORTAL&amp;secret=PASSWORD&amp;events=off'; $command[2] = 'action=originate&amp;channel=local/'.$userphone['number'].'@PORTAL&amp;context=redirportal&amp;exten='.$recipient.'&amp;priority=1&amp;CallerID=PORTAL'; $command[3] = 'action=logoff'; //      CURL $curl = curl_init(); foreach($command as $key =&gt; $data) { //    ,       $mansession = $_COOKIE['mansession_id']; $cookie = 'mansession_id="'.$mansession.'"'; //   - Asterisk curl_setopt($curl, CURLOPT_URL, 'http://127.0.0.1:8088/rawman'); //    curl_setopt($curl, CURLOPT_HEADER, 1); //    POST curl_setopt($curl, CURLOPT_POST, 1); //   cookie curl_setopt($curl, CURLOPT_COOKIE, $cookie); // CURL  ,      (    ) curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); //   curl_setopt($curl, CURLOPT_POSTFIELDS, $data); $res = curl_exec($curl); //   ,       if(!$res) { $error = curl_error($curl).'('.curl_errno($curl).')'; echo $error; } //    ,   else { //          preg_match('/mansession_id="(.*)";/', $res, $cut); $_COOKIE['mansession_id'] = $cut[1]; //     $tech_answer .= '&lt;h2&gt; '.$key.': '.$data.'&lt;/h2&gt;'.'&lt;p&gt;&lt;b&gt;:&lt;/b&gt;&lt;/p&gt;'.nl2br($res).'&lt;br/&gt;&lt;hr&gt;&lt;br/&gt;'; $answer = '&lt;p style="color:green;"&gt; &lt;/p&gt;'; } } curl_close($curl); die('ok'); } else { die('not_ok'); } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br></div></div><br></li><li>  A JavaScript file that allows you to call using <a href="http://ru.wikipedia.org/wiki/AJAX">AJAX technology</a> without reloading the page.  90% of it consists of creating the well-known <a href="httprequest.ru/">XMLHTTPRequest</a> object and its wrappers, so if you already use the implementation of this object from some js-library, everything may even be more compact <br><div class="spoiler">  <b class="spoiler_title">script.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRequestObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> XMLHttpRequest === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { XMLHttpRequest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Msxml2.XMLHTTP.6.0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {} <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Msxml2.XMLHTTP.3.0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {} <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Msxml2.XMLHTTP"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {} <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Microsoft.XMLHTTP"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) {} <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"This browser does not support XMLHttpRequest."</span></span>); }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_submit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">params, path</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req; req = createRequestObject(); req.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, path, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.timeout=<span class="hljs-number"><span class="hljs-number">5000</span></span>; req.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>); req.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(req.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// alert(" : "+req.responseText); if (req.responseText=='ok') { // alert('!'); } else { // alert(' !'); } } else { // alert(' '); } } } req.send(params); } function call_to (number) { var params = 'call=1&amp;recipient='+number; var path = '/services/telephony/call/'; ajax_submit(params, path) }</span></span></code> </pre><br></div></div><br></li><li>  Calling a function in the required templates or on the pages of Bitrix <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"link"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"call_to('50512')"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> </code> </pre><br></li></ol><br><br>  In general, this is all that is needed. <br>  The algorithm of actions of an employee who wants to call is as follows: <br><ol><li>  Check on the Desktop of the Portal whether its number is registered in the network (for most, the number is already recorded, only new or relocating employees have to re-register, so this action needs to be performed, usually no more than once) </li><li>  Find a target number through a search, company structure or telephone directory </li><li>  Click on the number </li></ol><br>  After that, the phone on his desk starts to ring.  It is necessary to pick up the phone, as will the connection to the target number. </div><p>Source: <a href="https://habr.com/ru/post/178467/">https://habr.com/ru/post/178467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178455/index.html">A new set has been opened for the Yandex Data Analysis School</a></li>
<li><a href="../178457/index.html">What questions can be answered by analyzing 1,500,000 unique case histories?</a></li>
<li><a href="../178459/index.html">Report from InterSystems Global Summit 2013</a></li>
<li><a href="../178461/index.html">REG.RU presents ‚Äúflexible‚Äù hosting from Jelastic to Russian users</a></li>
<li><a href="../178463/index.html">Starter "from scratch", my experience, success stories</a></li>
<li><a href="../178469/index.html">Sending letters in HTML format with pictures</a></li>
<li><a href="../178473/index.html">edn: extensible data notation</a></li>
<li><a href="../178475/index.html">Becoming an analyst</a></li>
<li><a href="../178477/index.html">Overview of the restrictions imposed on exceptions, for example, inheritance and interface implementation</a></li>
<li><a href="../178481/index.html">A quick way to create an installer for a Java program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>