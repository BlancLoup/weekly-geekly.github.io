<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Like this - to be a software developer for cars. Part 2/2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the series, we started developing a servo-driven system, at least mentally. I showed a model of the system on which all the eleme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Like this - to be a software developer for cars. Part 2/2</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/277141/">In the first part of the series,</a> we started developing a servo-driven system, at least mentally.  I showed a model of the system on which all the elements and the connections between them are clearly visible. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c68/78f/eb1/c6878feb1b0b0d19662284ef510031c9.png" alt="image"><br><br>  So how do parts of our system connect?  Thanks to the FlexRay protocol with an electronic control unit (ECU), the steering wheel is connected to the position sensor.  Unlike a conventional sensor that regulates voltage according to temperature, the smart sensor communicates perfectly with FlexRay. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In modern cars, as a rule, two types of network technologies are used: CAN and FlexRay.  FlexRay is CAN successor.  The main advantage of FlexRay is that you can accurately determine the time of transmission of a particular signal, that is, the protocol is deterministic.  Using this network, individual vehicle systems, whether brake, steering, or other smart sensor units, continuously exchange the necessary information, which guarantees uninterrupted operation of the car. <br><a name="habracut"></a><br>  The usual FlexRay protocol launch scheme is a process of allocating time to slots, each of which is responsible for sending specific signals or indicators.  The protocol sets its rhythm in the course of measuring physical parameters, sending and processing information, as well as regulating the operation of sensors.  In the diagram you can see the repetitive FlexRay slots, thanks to which data is transmitted via the bus. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2d/c99/fcb/c2dc99fcb7fd989d61f3ac94d55de8bc.png" alt="image"><br><br>  So, the steering angle sensor should send the current figures, when the corresponding slot is in line, not a second sooner or later.  Since the standard data sending time is 10 milliseconds, the above diagram had to greatly exaggerate the possible change in the position of the rudder.  And the driver will not be able to turn the steering wheel by 5 ¬∞ so quickly.  But for clarity, we stick to this example. <br><br>  In our microcontroller, a FlexRay controller is provided that accepts values ‚Äã‚Äãperiodically coming from the rudder position sensor.  As you have probably guessed, the program for which the processor is responsible also reads and processes FlexRay data from time to time.  In this case, processing refers to determining the position of the toothed rack (see diagram above) depending on the angle of rotation of the steering wheel.  The mathematical formula allows you to calculate the appropriate mode of operation of the engine, based on the position of the rail.  And here even gear shifting is taken into account. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a24/e23/cd7/a24e23cd71b68734facf14fdc489c364.png" alt="image"><br>  <i>Position Sensor - FlexRay - FlexRay Controller - Processor - PWM - Transmission - Steering rail</i> <br><br>  You may have noticed the unfamiliar PWM block.  This is pulse-width modulation (PWM), which allows to regulate the current supply to the power amplifier - it is also responsible for the motor power supply.  But what is PWM? <br><br>  PWM - pulse width modulation, a great way to control the power of various electrical devices.  In other words, you regulate the ratio of electricity and maximum power, where 0% is the lack of power and 100% is the total power that the power amplifier provides to the engine.  And, as always, more information can be found <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2580%25D0%25BE%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25B8%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F">on Wikipedia</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8aa/3fa/773/8aa3fa773f9e749e9dde0aabdb0dc047.png" alt="image"><br><br>  <i>Pulse width modulation (PWM, pulse-width modulation (PWM)) is the process of controlling the power supplied to the load by changing the pulse duty cycle at a constant frequency.</i>  <i>There are analog PWM and digital PWM, binary (two-level) PWM, and ternary (three-level) PWM.</i> <br><br>  What happens when the driver turns the steering wheel?  At some point, the software running on the processor receives information about the new steering position and generates the PWM value that is needed to start the engine.  He, in turn, moves the steering rack.  In the example below, the driver turns the steering wheel by 5 ¬∞ (1).  The sensor analyzes the position and sends the corresponding value on the FlexRay channel (2).  Our FlexRay controller receives data (3), on the basis of which the program calculates the appropriate PWM parameters (4) and sets them to the PWM module of the microcontroller (5).  The PWM module regulates the flow of electricity, which in turn sets the engine power determined by the power amplifier (6).  The current drives the motor (7), and it moves the steering rack (8). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5cb/55d/e49/5cb55de4929dab712f0f33ce8754ac8c.png" alt="image"><br>  <i>Position Sensor-FlexRay- controller FlexRay-Processor-PWM-Transmission-Steering Rack</i> <br><br>  Now you know that the previous example involved many different physical calculations and elements.  For example, somehow you need to bring% PWM from the degree of rotation of the steering wheel.  It is important to consider the current position of the engine, because it is only so clear in which direction and with which speed the engine will have to be started.  But, unfortunately, this is a topic of control technology, which I did not plan to cover in this article. <br><br>  Although I am an architect by profession, software development gives me great pleasure, though, of course, most of all I like to study software architecture that supports the functioning of the system as a whole.  Gradually, you realize that the software architecture has to adapt to the rhythm of the system, and it would probably be easier if everything was reduced to a single rhythm.  But, no, there are several of them, and they are closely interrelated.  For example, the rhythm corresponding to the engine is much faster than the rhythm of the communication channel, so that when you turn the steering wheel, the movement is smooth, without jerks. <br>  Rhythmic software architecture <br><br>  Thus, the software environment requires rhythmic signal processing.  Rhythm implies the existence of certain cycles in the program.  Have you ever considered the architecture of an embedded application?  If not, do not be alarmed.  We start the dive. <br><br>  Let's analyze how we can separate our program running on the processor from the image above (see illustration of the steering wheel rotation).  If you think about the tasks of the application components, you will obviously notice that we are dealing with 3 blocks: one for receiving the FlexRay signal, one for determining the PWM value based on the FlexRay data and one for adjusting the total PWM power.  In the following diagram, these components are superimposed on the microcontroller and voila, the multi-tier software architecture is ready. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3c1/019/eee/3c1019eee251a73dc1d459536ebb5d70.png" alt="image"><br><br>  ‚ÄúCom‚Äù is used to denote communication lines: this element reads the signal from the FlexRay controller that is part of the microcontroller.  It also checks the correctness of the signal transmission (for example, by auto-summarizing data) and transfers it to the rest of the program's components in the form of rudder position indicators.  Thanks to a smart algorithm, which had to work hard over one year, the element ‚ÄúSteering‚Äù takes this value and calculates the necessary PWM parameters.  I'm not kidding, the development of such an algorithm can take a lot of time, because driving is at stake.  And, therefore, it is necessary to take into account the mass of variables relevant to certain driving conditions.  But back to multi-tier architecture - PWM remained.  This PWM component reads the received information about sets the total power of the PWM microcontroller. <br><br>  And a couple of words about the concept of synchronization.  New data comes in every time FlexRay receives a corresponding signal and if it is every 10 milliseconds, the picture is as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a5/199/163/4a519916314fa614a4ea60a0471c61b8.png" alt="image"><br><br>  Receiving a FlexRay signal triggers 3 interdependent functions or components.  Then determined the total power of the PWM.  And all this is repeated every 10 milliseconds.  Here you have the rhythm of the software. <br><br>  Having received the total values ‚Äã‚Äãfrom the program, calculated on the basis of the initial data, we get the following diagram: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f1/405/bb0/2f1405bb0689f20f65cae970b952a6f3.png" alt="image"><br><br>  PWM is calculated and adjusted every 10 milliseconds, which means that we coped with the first stage.  Now you can turn the car! <br><br>  As you may have guessed, with such results, the engine obviously will not work smoothly.  So it's better: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/751/da4/48d/751da448d263a0fff7b9c50eb66b2cda.png" alt="image"><br><br>  In the meantime, the driver clearly does not like the trembling of the front wheels when turning the steering wheel.  We'll have to refine the architecture of the program.  This is what we devote to the new section of the series.  I hope you liked the prepared materials, and you will continue to follow the news.  Moreover, I am sure that now you, with more, have figured out the principles of building software architecture for cars.  As we said, it is determined by the environment or context of the system. <br><hr><br>  <i>From the translator:</i> <i><br><br></i>  <i>While this is the second and last post about the automotive software from the author of the original text, but I will closely follow the updates in his blog on Medium.</i> <i><br><br></i>  <i>Thanks for attention.</i> </div><p>Source: <a href="https://habr.com/ru/post/277315/">https://habr.com/ru/post/277315/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277305/index.html">Here it is, mutated algorithm. Or what can not "Lisp"</a></li>
<li><a href="../277307/index.html">Russian call center: Ekaterinburg Naumen + SIP-Gateway assembly Novosibirsk, the results</a></li>
<li><a href="../277309/index.html">CodingFuture + Puppet. Part II: Access and Standard Environment (cfauth + cfsystem)</a></li>
<li><a href="../277311/index.html">Why are mobile web apps so slow?</a></li>
<li><a href="../277313/index.html">How I made a mistake when writing a hash table and what conclusions did I make of it</a></li>
<li><a href="../277317/index.html">Advanced internal SEO for e-commerce</a></li>
<li><a href="../277319/index.html">Azure-IaaS-Digest number 1 (January \ February)</a></li>
<li><a href="../277321/index.html">Decorators and reflection in TypeScript: from beginner to expert (Part 2)</a></li>
<li><a href="../277323/index.html">I am a web developer and for 10 days I can not write the simplest application</a></li>
<li><a href="../277329/index.html">Reflection and code generation in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>