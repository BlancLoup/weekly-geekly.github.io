<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recipes for Android: Selectable sauce for LayoutManager'a</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The user does not like to waste time, the user does not like to rewrite the text. User wants to copy-paste. And he wants to do it even in the applicat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recipes for Android: Selectable sauce for LayoutManager'a</h1><div class="post__text post__text-html js-mediator-article">  The user does not like to waste time, the user does not like to rewrite the text.  User wants to copy-paste.  And he wants to do it even in the application on a mobile device.  And he wants this function to be convenient for work with a finger on a small screen.  Manufacturers of operating systems implement this function in different ways, trying to please users.  Do not fall behind and application developers. <br><br><img src="https://habrastorage.org/files/b1f/9f1/8f0/b1f9f18f050f459eacef62890405234c.jpg"><br><br>  We, too, were not spared by this topic, and in one of the applications we had to work hard to make the most convenient function of selecting and copying text.  The secret of this recipe we want to share with the public. <br><a name="habracut"></a><br><h2>  So let's go! </h2><br>  If you come across a text selection task, then you know that a TextView has a <a href="https://developer.android.com/reference/android/widget/TextView.html">setTextIsSelectable</a> method <a href="https://developer.android.com/reference/android/widget/TextView.html">(boolean selectable)</a> , which allows you to select text within a single TextView.  But what if you have text on multiple screens (for example, a news article)?  Placing all the text in one TextView and scrolling all this is at least irrational.  Therefore, they usually create a RecyclerView, break the text into paragraphs, and by paragraph begin to add it to RecyclerView. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Forcing the user to select the text in a paragraph is not very ‚Äúfriendly‚Äù.  The question is: how to select two or more paragraphs at once?  And what if there is a picture or some other element in the text? <br><br><img src="https://habrastorage.org/files/a5c/8d5/545/a5c8d5545f43417e9b5f371b4a950f81.gif"><br><br><h2>  Total control </h2><br>  The first thing to begin with is to create a class that will manage the allocation process and control all its stages.  It needs to be initialized in our custom SelectableRecyclerView, and in the future to transfer the status of recyclerView and its LayoutManager to our controller.  To begin with, we pass the ViewGroup to the SelectionController constructor, in which the text will be selected. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectionController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ViewGroup selectableViewGroup; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectionController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewGroup selectableViewGroup)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectableViewGroup = selectableViewGroup; } }</code> </pre> <br>  Our custom LayoutManager: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectableLayoutManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LinearLayoutManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SelectionController sh; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableLayoutManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableLayoutManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> orientation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reverseLayout)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, orientation, reverseLayout); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableLayoutManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleAttr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleRes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs, defStyleAttr, defStyleRes); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSelectionController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SelectionController selectionController)</span></span></span><span class="hljs-function"> </span></span>{ sh = selectionController; } }</code> </pre><br>  Our custom RecyclerView: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectableRecyclerView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SelectionController sh; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableRecyclerView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableRecyclerView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableRecyclerView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyle)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs, defStyle); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFinishInflate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onFinishInflate(); sh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SelectionController(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLayoutManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutManager layout)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setLayoutManager(layout); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (layout <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SelectableLayoutManager) { ((SelectableLayoutManager) layout).setSelectionController(sh); } } }</code> </pre><br><h2>  We follow the user </h2><br>  Typically, the text selection mode is activated by a long tap, therefore, we need to define a long tap over our SelectableRecyclerView.  GestureDetector will help us with this, which will be initialized in the SelectionController'a constructor and inform us that it‚Äôs time to turn on the text selection mode. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initGesture</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ gestureDetector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GestureDetector(selectableViewGroup.getContext(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GestureDetector.SimpleOnGestureListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLongPress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MotionEvent event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectInProcess) { startSelection(event); } } }); }</code> </pre><br>  Now we have determined that the user wants to start text selection, and we have a MotionEvent that knows where the user wants to start. <br><br>  Through easy manipulations, we can determine where the user tapped on the screen: <br><br><pre> <code class="java hljs">selectableViewGroup.getLocationOnScreen(location); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> evX = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (event.getX() + location[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> evY = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (event.getY() + location[<span class="hljs-number"><span class="hljs-number">1</span></span>]);</code> </pre><br>  Now we have coordinates and we need to determine on which TextView the user has got, for this we will create our SelectableTextView, which will have a method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isInside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> evX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> evY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] location = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; getLocationOnScreen(location); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> left = location[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> right = left + getWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> top = location[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bottom = top + getHeight(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> left &lt;= evX &amp;&amp; right &gt;= evX &amp;&amp; top &lt;= evY &amp;&amp; bottom &gt;= evY; }</code> </pre><br>  We remember that RecyclerView is a Viewgroup, so we take all its child'ov, iterate over them and check what kind of child we got into. <br><br><h2>  Too easy, huh? </h2><br>  Surely you thought, if the child is not SelectableTextView, and in general RecyclerView is all so dynamic and the child can change it, it is also <a href="http://habrahabr.ru/company/eastbanctech/blog/267497/">controlled by the LayoutManager</a> , and it will all <a href="http://habrahabr.ru/company/eastbanctech/blog/267497/">go away</a> .  Right thought, so we will look at it a little later =) <br><br>  For now let's continue ... <br><br>  So, we have found the SelectableTextView we need and know where the user has tapped.  We need to select the text, and for this it is necessary to find the symbol in the text, from which the selection will be read. <br><br>  Let's start. <br><br>  Get the string in the text at the y coordinate: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLineAtCoordinate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ y -= getTotalPaddingTop(); y = Math.max(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, y); y = Math.min(getHeight() - getTotalPaddingBottom() - <span class="hljs-number"><span class="hljs-number">1</span></span>, y); y += getScrollY(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getLayout().getLineForVertical((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) y); }</code> </pre><br>  Found a line, now by it and the x coordinate in this line we find the position (for those who are embarrassed by the <a href="https://developer.android.com/reference/android/widget/TextView.html">getlayout ()</a> method): <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOffsetAtCoordinate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> line, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ x = convertToLocalHorizontalCoordinate(x); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getLayout().getOffsetForHorizontal(line, x); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToLocalHorizontalCoordinate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ x -= getTotalPaddingLeft(); x = Math.max(<span class="hljs-number"><span class="hljs-number">0.0f</span></span>, x); x = Math.min(getWidth() - getTotalPaddingRight() - <span class="hljs-number"><span class="hljs-number">1</span></span>, x); x += getScrollX(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; }</code> </pre><br>  If you have read the documentation, you should remember that getLayout () can return null, so the method for getting a position in the text looks like: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOffsetForPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getLayout() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> line = getLineAtCoordinate(y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getOffsetAtCoordinate(line, x); }</code> </pre><br>  Finally, we ended up with SelectableTextView, got a position in the text, and can return to the SelectionController. <br><br>  Most often, the user does not specifically aim at the beginning or end of the word, but wants to select it entirely, so we will try to select the entire word and return the starting and ending positions (using the method in the SelectionController): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] getHandlesPosition(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String text, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pos) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] handlesPosition = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> textLength = text.length(); handlesPosition[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = pos; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!LetterDigitPattern.matcher(String.valueOf(text.charAt(i))).matches()){ handlesPosition[<span class="hljs-number"><span class="hljs-number">0</span></span>] = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } handlesPosition[<span class="hljs-number"><span class="hljs-number">1</span></span>] = textLength - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = pos; i &lt; textLength; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!LetterDigitPattern.matcher(String.valueOf(text.charAt(i))).matches()){ handlesPosition[<span class="hljs-number"><span class="hljs-number">1</span></span>] = i; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handlesPosition; }</code> </pre><br>  As a result, we got the initial and final position of the selection, so we get the coordinates of these positions and draw our cursors: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ canvas.drawBitmap(handleImage, x, y, paint); }</code> </pre><br>  But we draw them with SelectionController, and he, in turn, has nothing to do with draw and canvas.  Therefore, override the dispatchDraw method in SelectionRecyclerView and ask SelectionController.drawHandles to draw the cursors for the SelectionRecyclerView: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatchDraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.dispatchDraw(canvas); sh.drawHandles(canvas); } SelectionController.<span class="hljs-function"><span class="hljs-function">java </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawHandles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectInProcess) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; rightHandle.draw(canvas); leftHandle.draw(canvas); }</code> </pre><br>  Here's what we got: <br><br><img src="https://habrastorage.org/files/ea8/9ed/f98/ea89edf9865749a8b843b9472ac0b639.png"><br><br>  Now mark the selected area so that it looks like the selected text, we can do it in two ways: <br>  1. Through SpannableString; <br>  2. Draw a Canvas. <br><br>  Since SpannableString is rendered for quite a long time, with a large amount of selected text, you can forget about the smooth movement of cursors, so we will draw everything with a canvas.  We have the coordinates of the initial and final positions, so it is easy to calculate what area you need to paint over. <br><br><img src="https://habrastorage.org/files/e95/332/9c4/e953329c4b7c484db9658381d03918dd.png"><br><br><h2>  Movement is life! </h2><br>  Finally, the user is satisfied, but now he wants to select more text by moving the cursors.  Therefore, we need to calculate the new coordinates for the cursor, which should follow the movement of the finger: <br><br>  1. We look where the cursor has moved (onTouchEvent). <br>  2. Find what position in the text the cursor hits. <br>  3. Find the coordinates of this position to drag the cursor to it. <br>  4. Draw. <br><br>  It looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gestureDetector != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) gestureDetector.onTouchEvent(ev); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> dispatched = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectInProcess) { <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> right = rightHandleListener.onTouchHandle(ev); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> left = leftHandleListener.onTouchHandle(ev); dispatched = right || left; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dispatched; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchHandle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MotionEvent event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (event.getAction() &amp; MotionEvent.ACTION_MASK) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_DOWN: <span class="hljs-comment"><span class="hljs-comment">//      handle.isMoving = handle.contains(event.getX(), event.getY()); if (handle.isMoving) { //       yDelta = (int) (event.getY() - handle.y + 1); xDelta = (int) (event.getX() - handle.x + handle.correctX); //  ,  parent'    touchevent'  selectableViewGroup.getParent().requestDisallowInterceptTouchEvent(true); } break; case MotionEvent.ACTION_UP: handle.isMoving = false; selectableViewGroup.getParent().requestDisallowInterceptTouchEvent(false); break; case MotionEvent.ACTION_POINTER_DOWN: break; case MotionEvent.ACTION_POINTER_UP: break; case MotionEvent.ACTION_MOVE: if (handle.isMoving) { //   x = (int) (event.getRawX() - xDelta); y = (int) (event.getRawY() - yDelta); int oldHandlePos = handle.position; //      handle.position = getCursorPosition(x, y, handle.position); if (handle.position != oldHandlePos) { //       setHandleCoordinate(handle); //    ,     setSelectionText(); //    backround  , //              checkBackground(); //   selectableViewGroup.invalidate(); } } break; } return handle.isMoving; }</span></span></code> </pre><br>  For a single tapu GestureDetector.onSingleTapUp turn off the text selection mode, go over all the SelectableTextView, copy the selected text from them and put it on the clipboard. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSingleTapUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MotionEvent e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectInProcess) { copyToClipBoard(stopSelection().toString()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onSingleTapUp(e); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyToClipBoard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span><span class="hljs-function"> </span></span>{ ClipboardManager clipboard = (ClipboardManager) selectableViewGroup.getContext().getSystemService(Context.CLIPBOARD_SERVICE); ClipData clip = ClipData.newPlainText(<span class="hljs-string"><span class="hljs-string">"Article"</span></span>, s); clipboard.setPrimaryClip(clip); Toast.makeText(selectableViewGroup.getContext(), <span class="hljs-string"><span class="hljs-string">"Text was copied to clipboard"</span></span>, Toast.LENGTH_LONG).show(); }</code> </pre><br><h2>  Everything is so dynamic </h2><br>  Now, remember that we have a RecyclerView, LayoutManager, a large number of elements, everything is scrolled, all views are reused, and in general magic is created. <br><br>  Because of what 2 serious problems arise: <br>  1. How to keep selection in views when scrolling, if they are reused? <br>  2. How to move cursors along with scrolling? <br><br>  Let's start with a simple problem - moving the cursors along with scrolling.  If you read an article about <a href="http://habrahabr.ru/company/eastbanctech/blog/267497/">LayoutManager</a> , then you know what is responsible for the LayoutManager scroll, which calls the offsetChildrenVertical (int dy) method.  Therefore, we will redefine it and inform our SelectionController that the content will scroll and need to move the cursors.  The coordinates of the views have changed, but the positions in the text.  Therefore, we use the well-known algorithm: <br><br>  <s>1. We look where the cursor has moved (onTouchEvent).</s> <s><br></s>  <s>2. Find what position in the text the cursor hits.</s> <br>  3. Find the coordinates of this position to drag the cursor to it. <br>  4. Draw: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkHandlesPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectInProcess) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; setHandleCoordinate(rightHandle); setHandleCoordinate(leftHandle); selectableViewGroup.postInvalidate(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setHandleCoordinate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Handle handle)</span></span></span><span class="hljs-function"> </span></span>{ Selectable textView = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> totalPos = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SelectableInfo selectableInfo : selectableInfos) { String text = selectableInfo.getText().toString(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = text.length(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handle.position &gt;= totalPos &amp;&amp; handle.position &lt; totalPos + length) { textView = selectableInfo.getSelectable(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } totalPos += length; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (textView == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { handle.visible = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isSvgParent((View)textView)) { handle.visible = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; checkSelectableList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } handle.visible = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[] coordinate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; coordinate = textView.getPositionForOffset(handle.position - totalPos, coordinate); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] location = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; selectableViewGroup.getLocationOnScreen(location); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (coordinate[<span class="hljs-number"><span class="hljs-number">0</span></span>] == -<span class="hljs-number"><span class="hljs-number">1</span></span> || coordinate[<span class="hljs-number"><span class="hljs-number">1</span></span>] == -<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; handle.x = coordinate[<span class="hljs-number"><span class="hljs-number">0</span></span>] - location[<span class="hljs-number"><span class="hljs-number">0</span></span>] + handle.correctX; handle.y = coordinate[<span class="hljs-number"><span class="hljs-number">1</span></span>] - location[<span class="hljs-number"><span class="hljs-number">1</span></span>]; }</code> </pre><br>  There are wonderful selectableInfos in the code, they will help us to solve the problem 1. SelectableInfo contains information about the selected text, about what it was and SelectableTextView and what text was in it. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectableInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> end; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String selectedText; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String text; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String key; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Selectable selectable; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SelectableInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Selectable selectable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.end = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectedText = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectable = selectable; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = selectable.getText(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.key = selectable.getKey(); } }</code> </pre><br><h2>  ‚ÄúHey, View!  You do not go there, you go here! ‚Äù </h2><br>  We remember that content is scrolled and views are reused.  Every time a view is deleted or added to a RecyclerView, we save its state and a reference to it (Selectable) in SelectableInfos. <br><br><pre> <code class="java hljs">Selectable - ,    SelectableTextView. <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Selectable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOffsetForPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getVisibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">CharSequence </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSequence text)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocationOnScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] location)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWidth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[] getPositionForOffset(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>[] position); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selectText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">CharSequence </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSelectedText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isInside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> evX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> evY)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setColor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> selectionColor)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStartSelection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEndSelection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span></span>; }</code> </pre><br>  Thus, we keep the actual data array of the selected text. <br><br>  But how do we associate it with views that are reused? <br><br>  To do this, we need to determine that the view that has now been added belongs to a specific SelectableInfo.  Therefore, we add a key (Selectable.getKey () / setKey (String key)), by which we will understand that the view that we need.  We will install this key to the view during the binding of the holder at the LayoutManager. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBindViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VHolder viewHolder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span><span class="hljs-function"> </span></span>{ viewHolder.textView.setText(sampleText); viewHolder.textView.setKey(<span class="hljs-string"><span class="hljs-string">" pos: "</span></span> + position + sampleText); }</code> </pre><br>  The question is about at what point in time the LayoutManager adds views to RecyclerView, and it does this by calling the addView (View child, int index) method, which we will override: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View child, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.addView(child, index); sh.addViewToSelectable(child); }</code> </pre><br>  You also need to remember that the views that we add to RecyclerView may not only be a TextView, but also have a complex layout.  It can contain several TextViews at different levels, so we recursively walk around the entire tree of views, if there is one: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addViewToSelectable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ checkSelectableList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Selectable){ addSelectableToSelectableInfos((Selectable) view); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ViewGroup){ findSelectableTextView((ViewGroup) view); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findSelectableTextView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewGroup viewGroup)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; viewGroup.getChildCount(); i++){ View view = viewGroup.getChildAt(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Selectable){ addSelectableToSelectableInfos((Selectable) view); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ViewGroup){ findSelectableTextView((ViewGroup) view); } } }</code> </pre><br>  Adding a view is easy.  If we have information on its getKey (), then we simply save its link (selectable).  If not, create a new SelectableInfo and add it to our list of selectableInfos: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSelectableToSelectableInfos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Selectable selectable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> found = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SelectableInfo selectableInfo : selectableInfos) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectableInfo.getKey().equals(selectable.getKey())) { selectableInfo.setSelectable(selectable); found = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!found) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SelectableInfo selectableInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SelectableInfo(selectable); selectableInfos.add(selectableInfo); } }</code> </pre><br>  We remember that views are reused, so at the time of reuse you need to erase the link to it selectableInfo.removeSelectable () in the old SelectableInfo. <br><br>  It is best to check for the relevance of our list while adding a new view.  We have two cases in which the link to the view is irrelevant: <br>  1. The view has already been reused, and the new values ‚Äã‚Äãare new, and accordingly the new key (getKey ()). <br>  2. The view went to the pool and waits until it is needed - we also do not need it, because the user is unlikely to be able to select text from the view that is not on the screen =). <br><br>  Therefore, we need to check whether the key is such in the view as we expect, and for the second case, check for the presence of the parent in it: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSelectableList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SelectableInfo selectableInfo : selectableInfos) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectableInfo.getSelectable() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectableInfo.getSelectable().getKey().equals(selectableInfo.getKey())) { selectableInfo.removeSelectable(); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isSvgParent((View) selectableInfo.getSelectable())) { selectableInfo.removeSelectable(); } } } }</code> </pre><br>  Thus, we have obtained an up-to-date list of information about the view (SelectableInfo), in which there is all the data in order to restore the text selection when scrolling. <br><br><h2>  Seals at the end! </h2><br>  Since we did a recursive search of all the SelectableTextView in our view, we can make different layouts with different arrangement of text, and even images.  Selecting text will still work! <br><br><img src="https://habrastorage.org/files/fb8/9ca/beb/fb89cabeba7c4a4ea2abd1d07677396b.gif"><br><br>  In conclusion, it can be said that a seemingly large and complex task is solved quite simply with knowledge of the View life cycle and how the RecyclerView-LayoutManager works.  We hope that this article will help developers to adopt an interesting way to implement the selection of the text.  Have a good day and good luck in your development. <br><br>  Related Links: <br><br>  Link to the project with an example <a href="">https://github.com/qw1nz/TextSelection.git</a> </div><p>Source: <a href="https://habr.com/ru/post/268501/">https://habr.com/ru/post/268501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268485/index.html">PostgreSQL and related tasks on HighLoad ++</a></li>
<li><a href="../268491/index.html">Mastering the Data Science specialty on Coursera: personal experience (part 1)</a></li>
<li><a href="../268493/index.html">Security Week 41: censorship research, hacking Outlook Web Access, data loss at the joints</a></li>
<li><a href="../268495/index.html">Conflict for SHA-1 for $ 100 thousand</a></li>
<li><a href="../268497/index.html">Meet Otto, the heir to Vagrant</a></li>
<li><a href="../268503/index.html">Load load testing service</a></li>
<li><a href="../268505/index.html">High School of Economics. About marketing. Is free</a></li>
<li><a href="../268507/index.html">Phase portraits "on the fingers" or what can be found out about diffraction solutions without solving it</a></li>
<li><a href="../268509/index.html">Differentiation of access rights to Jenkins</a></li>
<li><a href="../268513/index.html">Ant optimization and network algorithms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>