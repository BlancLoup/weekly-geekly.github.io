<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Geonames, Google Maps, Geocoding, time zones and everything, everything, everything</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Users do not want to deal with the features of the coordinates, time zones. Some do not even know how these coordinates are expressed, and what time z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Geonames, Google Maps, Geocoding, time zones and everything, everything, everything</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/27c/7cf/ab4/27c7cfab456e467f0afe155184c96ae9.jpg"><br>  Users do not want to deal with the features of the coordinates, time zones.  Some do not even know how these coordinates are expressed, and what time zones are. <br>  How to make the user feel good? <br><br>  This article will explain how to work with coordinates and time zones: <br>  Namely, <br><ol><li>  Installing Google Maps, considered a small functionality with an example. </li><li>  Search for a time zone with coordinates (Geonames.org). </li><li>  Search for coordinates and time zone by city name (Geonames.org). </li><li>  Determining the name of the area by coordinates. </li></ol><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, <br>  User wants: <br><br><ol><li>  It is not enough to think. </li><li>  Few click. </li></ol><br><br>  Therefore, we just have to teach the phone: <br><ol><li>  Find the coordinates and time zone for the name of the city. </li><li>  Find time zone by coordinates, if maps are used. </li><li>  Find out the current position of the user. </li><li>  Find out the exact address by coordinates. </li></ol><br><br>  For a hurry: <a href="https://habr.com/ru/post/209050/">click the link</a> to go directly to the application and description of the code with comments. <br>  For others.  Let's go in order. <br><br><h4>  Introduction </h4><br><div class="spoiler">  <b class="spoiler_title">For a start, what are time zones (time zones).</b>  <b class="spoiler_title">In principle, all this is available on Wikipedia.org, but you can briefly look here</b> <div class="spoiler_text"> Point on the globe can be determined using two coordinates - latitude and longitude.  And this is quite a known fact.  But with time zones there is a snag: anywhere in the world there can be absolutely any time zone.  It all depends on the level of imagination of a manager in a particular territory. <br>  For example, for clarity, now in European Russia the true noon, which is supposed to be at 12:00, appears almost 2 hours later.  On the day of the writing of the article, the true afternoon - the Sun at its zenith in Moscow - was at 13:38.  In some territories of Russia, a shift in the passage of the Sun along the zenith is obtained by as much as 3 hours. <br>  Let's go back to the numbers.  The world <s>government</s> community was taken for the zero meridian - Greenwich.  Time zones are calculated relative to it and as follows.  The time zone is the local time shift at some point on the planet relative to the Greenwich meridian.  The whole globe is divided into 24 parts along the meridians.  That is, the base meridians of 0 ¬∞, 15 ¬∞, 30 ¬∞, etc. are taken, and time zones of ¬± 7.5 ¬∞ are counted from them.  Thus, the +00: 00 time zone - and it is denoted differently: both UTC, and GMT, and GMT + 00: 00 (there is a difference between UTC and GMT, but in practice in most cases this does not apply) - is from 7.5 ¬∞ W. to 7.5 ¬∞ E, GMT + 01: 00 - from 7.5 ¬∞ E  up to 22.5 ¬∞ east  and so on.  But, besides this, there are also state borders, as well as some of the states are in the so-called middle zone, where it is economically feasible to make a shift of +01: 00 in the summer (usually).  In the southern hemisphere, summer shift occurs when it is winter in northern.  In Russia, the maternity time was also applied, due to which the clock was moved another hour forward.  On the seas and oceans, the time zone is used, which is calculated from the position in the usual way.  And in Antarctica, in general, a separate story, how to calculate this business.  Due to all these socio-economic and political reasons, several hundreds of time zones accumulated on the planet.  And if the program also needs to use time (and time zones change in time), then with all these shifts, you can get confused. <br><br>  By the way, it happens that the <code>Calendar</code> class in <code>Java</code> generates an error with an hour shift, if you initialize, for example, with the current time and time zone, and then set the time before we switched exclusively to summer time, for example, 1988, then the calendar will display the clock with a shift of 1 hour.  This is treated if constantly reinstalling the calendar when installing new milliseconds.  <code>SimpleDateFormat</code> always produces a similar error, therefore I do not advise using it for old dates. <br></div></div><br>  <a href="http://ru.wikipedia.org/w/index.php%3Ftitle%3D%25D0%25A7%25D0%25B0%25D1%2581%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B9_%25D0%25BF%25D0%25BE%25D1%258F%25D1%2581%26oldid%3D60197098">Link to the ‚Äútime zone‚Äù article on Wikipedia</a> <br><br>  <a href="http://www.geonames.org/">Geonames.org</a> is a great resource.  There you can both download databases and use the native API for this resource.  In this article I will use just the API. <br><br>  To work with Geonames, you need to register a user with which you will have access to the API.  And also <b>do not forget to activate it</b> .  To do this, <a href="http://www.geonames.org/manageaccount">go to your account</a> and click on the link: <u>Click here to enable</u> . <br>  <a href="http://www.geonames.org/export/web-services.html">Here is the documentation</a> <br>  <a href="http://www.geonames.org/export/client-libraries.html">There is even a library for access</a> , but I personally do not use the library, because sometimes errors occur.  Directly with the API via http-request work more clearly. <br>  <a href="http://www.geonames.org/about.html">License</a> .  You can use this product for free. <br><br>  Everyone knows about Google Maps. <br>  You can general help on using Google Maps <a href="https://developers.google.com/maps/documentation/android/start">can be found here</a> . <br><br>  There is also such a feature as GeoCoder.  You can find the address by coordinates.  But time zones, for some reason there is not. <br>  I will also use <a href="http://www.geonames.org/">Geonames.org</a> to search for time zones on a click. <br><br><h4>  Setting up Google Maps </h4><br>  For beginners, a brief editing algorithm <code>AndroidManifest.xml</code> , what to get from, to work Google Maps and determine the position of the phone. <br>  Who is not interested - <a href="https://habr.com/ru/post/209050/">click here to scroll directly to the description of the features of the application</a> . <br><br>  one. <br>  inside <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.example.android.permission.MAPS_RECEIVE"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:protectionLevel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"signature"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.providers.gsf.permission.READ_GSERVICES"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- The following two permissions are not required to use Google Maps Android API v2, but are recommended. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_COARSE_LOCATION"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_FINE_LOCATION"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:glEsVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0x00020000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br><br>  2 <br>  inside <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  : <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.gms.version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@integer/google_play_services_version"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.maps.v2.API_KEY"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"API_KEY"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br><br>  To get android: value = "API_KEY" ( <a href="">link where it is in the code</a> ), you need: <br><ul><li>  <a href="https://code.google.com/apis/console/b/0/">here</a> </li><li> <code>APIs &amp; auth &gt; Credentials &gt; Create new KEY &gt; Android key</code> </li> <li>  In the field we write the following SHA-1-KEY; com.example.android.mapexample </li></ul><br>  Pictures for android: value = "API_KEY" <br><div class="spoiler">  <b class="spoiler_title">Picture 1: Open console</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/5c4/441/d35/5c4441d35fcce7717d92775369e1f818.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Picture 2: Enter key</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/605/956/c2b/605956c2b5ef12d650b11d400c6a81b5.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Picture 3: get API_KEY</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/ed6/021/2d7ed6021bdd11767d1c6200b7bf3100.png"></div></div><br>  features of receiving SHA-1-KEY <br><ul><li>  it happens either debug or release.  It is obtained from the certificate file. </li><li>  file certificate for debug - taken from% USERPROFILE% \. android \ debug.keystore.  It is tied to the computer and Eclipse. </li><li>  file certificate for release is my-release-key.keystore, which is used to digitally sign the application.  Every developer knows about it.  You can get it like this: <a href="http://developer.android.com/tools/publishing/app-signing.html">developer.android.com/tools/publishing/app-signing.html#cert</a> </li><li>  in order to get debug-key.  <a href="https://developers.google.com/maps/documentation/android/start">open the documentation</a> , and then there is the section Displaying the debug certificate fingerprint and see how to do it </li><li>  to get a release-key, you need <a href="https://developers.google.com/maps/documentation/android/start">to open the documentation</a> , there is a section Displaying the release certificate certificate fingerprint </li><li>  In the current version of api-console, you can make several combinations of SHA-1-KEY; com.example.android.mapexample for one output API_KEY.  Conveniently with one key on multiple computers. </li></ul><br><br>  For Google Maps to work, add an Android library to your project.  The path is: <code>&lt;Android-SDK-Path&gt;\extras\google\google_play_services\</code> .  You need to add this: <code>File&gt;New&gt;Project&gt;Android&gt;Android Prject from Existing Code&gt;Next</code> <br>  Do not forget to add the <code>google_play_services</code> project as a library in the <code>google_play_services</code> main project <code>habrtimezone</code> .  This should be done in <code>Project&gt;Properties&gt;Android&gt;Library&gt;Add...</code> <br><br>  You need to build a project for Google APIs 4.4.2 (you can&gt; 4.0).  To do this, check the corresponding list item in <code>Project&gt;Properties&gt;Android&gt;Project Build Target</code> .  If there is no such item, then you need to install Google APIs through the Android SDK Manager. <br><br><div class="spoiler">  <b class="spoiler_title">A picture that shows where and what to include.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/784/4b8/2b8/7844b82b8981db2cf465d65abd8d1afa.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">What to download in the Android SDK Manager.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/9db/808/77b/9db80877b3930332fa09e4c2e6ad6386.png"><br></div></div><br><br><h4>  Application code </h4><br><a name="Next0"></a><br>  <b>Below is an example of an application</b> that is available on <a href="https://play.google.com/store/apps/details%3Fid%3Dru.ps.habrtimezone">Google Play</a> , the source code is on <a href="https://github.com/yurevich1/habrtimezone">GitHub</a> . <br>  There will be comments on the features of the application. <br><div class="spoiler">  <b class="spoiler_title">QR for application</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/98c/359/a6a/98c359a6ae4613fb96d9af411e2c8459.gif"></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Screenshot Eclipse with the project.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/cf0/52e/138/cf052e138c110e69cca53a7c36226187.png"><br></div></div><br>  So, what can the application: <br>  1. Determine current coordinates <br>  2. Work with the card <br>  3. Determine the position of the city and its time zone by its name. <br><br>  I will not explain all aspects of the application, but only show the main details and features.  <a href="https://github.com/yurevich1/habrtimezone">In the presence of a code</a> with trifles it is not difficult to figure it out. <br><br><h4>  Class AMain.  First screen </h4><br>  The application starts working with <code>AMain</code> Activity <br>  Class <code>AMain.java</code> .  <a href="">Class code</a> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AMain</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnClickListener</span></span></span></span></code> </pre> <br>  ( <a href="">link</a> ) <br><br>  OnClickListener - for handling clicks.  In my opinion, it is better to handle clicks this way, since the memory will be consumed in smaller quantities if you use <pre> <code class="java hljs"> button.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre>  , but not <pre> <code class="java hljs">button.setOnClickListener(&lt; Listener&gt;);</code> </pre>  This effect is especially noticeable when using a large number of clickable objects. <br>  ( <a href="">link for button</a> and <a href="">link for handler</a> ) <br><br>  What's going on here: <br>  There is a search for the coordinates of the phone in space using GSM towers, as well as GPS. <br>  Through this window you can open: <br>  1. Map.  For markers on this map, the current position of the phone and the position (latitude / longitude), which is recorded in the <code>AGMap</code> text fields, will be <code>AGMap</code> <br>  2. Search for cities via the Internet. <code>ACityListOnline</code> <br><br>  The search for coordinates was made using the following main objects: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocationManager lm = (LocationManager) getSystemService(Context.LOCATION_SERVICE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocationListener gpsLocationListener; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocationListener networkLocationListener;</code> </pre><br>  ( <a href="">link</a> ) <br>  As the coordinates and / or time change, the event will be processed using the <code>LocListener implements LocationListener</code> ( <a href="">link</a> ) in <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLocationChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Location location)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre><br>  ( <a href="">link</a> ) <br>  Work with the card <br><br><h4>  Class AGMap.  Screen to work with the map </h4><br>  In order for the map to be in the application, you need to create the following block in the resources in the <code>agmap.xml</code> file ( <a href="">link</a> ): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/map"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.gms.maps.SupportMapFragment"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Which is the map. ( <a href="">link</a> ) <br><br>  Activity class: <code>AGMap.java</code> <a href="">Class code</a> . <br><br>  What's going on here. <br>  1. The map opens, <br>  2. Coordinates from the previous screen are transferred to it. <br>  3. There are 2 markers - the current coordinates, and a marker in the center of the screen. <br>  4. You can move the map, when you click on the Save button, the coordinates of the center of the map will be applied, the name of the region will be determined, the time zone will be determined using Geonames.org. <br><br>  Features of setting and using the card. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AGMap</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnCameraChangeListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnClickListener</span></span></span></span></code> </pre>  ( <a href="">link</a> ) <br>  <code>FragmentActivity</code> - since the card is included in this Activity, from the parent one should use this class. <br>  <code>OnCameraChangeListener</code> - needed to handle the movement of the map <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GoogleMap mMap; <span class="hljs-comment"><span class="hljs-comment">//  (),</span></span></code> </pre> <br>  which is initialized as follows: <br><pre> <code class="java hljs">mMap = ((SupportMapFragment) getSupportFragmentManager().findFragmentById(R.id.map)).getMap();</code> </pre>  ( <a href="">link</a> ) <br><br>  Positions of objects (pointers on the map) are stored in <br><pre> <code class="java hljs">LatLng HEREIAM = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   LatLng pos = null; //    </span></span></code> </pre>  ( <a href="">link</a> ) <br>  In order to draw a marker, you need to make an object with marker settings <br><pre> <code class="java hljs">mo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> markerOptions(... <span class="hljs-comment"><span class="hljs-comment">//  , ,  ..</span></span></code> </pre>  ( <a href="">link</a> ) <br>  and apply it to the map: <br><pre> <code class="java hljs">mar = mMap.addMarker(mo);</code> </pre> <br>  the output will be <code>Marker mar</code> ( <a href="">link</a> ) <br><br>  I noticed that on some devices, when initializing the map, an error occurs in <code>onCreate()</code> , so you have to wrap the error in <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(NullPointerException e){}</code> </pre>  ( <a href="">link</a> ) <br><br>  All map settings are <br><pre> <code class="java hljs">GoogleMapOptions options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleMapOptions();<span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre><br>  ( <a href="">link</a> ) <br>  Map marker centering: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCameraChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CameraPosition cp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// TODO Auto-generated method stub pos = cp.target; mar1.setPosition(pos); }</span></span></code> </pre><br>  ( <a href="">link</a> ) <br>  Initially, the result processing functions have been added to this function. <br><pre> <code class="java hljs">uniqueExec(); <span class="hljs-comment"><span class="hljs-comment">//   uniqueExecTZ(pos); //  </span></span></code> </pre><br>  But in case of a bad connection, everything will slow down.  It is inconvenient to use. <br><br>  The search for the position name is as follows: <br><br><pre> <code class="java hljs">Geocoder geoCoder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Geocoder(getBaseContext(), Locale.getDefault()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { List&lt;Address&gt; addresses = geoCoder.getFromLocation(point.latitude, point.longitude, <span class="hljs-number"><span class="hljs-number">1</span></span>);<span class="hljs-comment"><span class="hljs-comment">//      } catch (IOException e) { e.printStackTrace(); } return address; }</span></span></code> </pre>  ( <a href="">link</a> ) <br>  To be fair, it‚Äôs worth adding that the ‚ÄúService not Available‚Äù error sometimes occurs.  In this case, it is better to supplement this function by checking the form. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Geocoder.isPresent()){} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{}</code> </pre><br>  and in <code>else</code> make a direct request by <code>URL</code> : <br><pre> <code class="java hljs">String googleMapUrl = <span class="hljs-string"><span class="hljs-string">"http://maps.googleapis.com/maps/api/geocode/json?latlng="</span></span> + point.latitude + <span class="hljs-string"><span class="hljs-string">","</span></span> + point.longitude + <span class="hljs-string"><span class="hljs-string">"&amp;sensor=false&amp;language="</span></span> + Locale.getDefault().getLanguage();</code> </pre><br>  In this case, <a href="">it will be necessary to</a> add an <code>if-else</code> condition <a href="">here</a> . <br><br>  The output will be a JSON object, which is also broken down into pieces, as is the case with GeoNames. ( <a href="https://habr.com/ru/post/209050/">See just below</a> ) <br>  Unfortunately, there is a limit to 2500 requests per day in the case of the free option. <br><br>  <a href="https://developers.google.com/maps/documentation/geocoding/%3Fhl%3Dru">More here</a> <br><br>  When you click the save button ( <a href="">link</a> ), the following happens: <br>  1. search for the name of the area by coordinates in the center of the screen.  Done using <code>geocodertask extends AsyncTask&lt;Void, Integer, Void&gt;</code> ( <a href="">link</a> ) in the function <code>uniqueExec();</code>  ( <a href="">link</a> ) <br>  2. Search for a time zone by coordinates in the center of the screen.  Done using <code>TimeZoneTask extends AsyncTask&lt;Double, Integer, Void&gt;</code> ( <a href="">link</a> ) in the function <code>uniqueExecTZ(pos);</code>  ( <a href="">link</a> ) <br><br>  Requests for http for <code>Geocoder</code> and <code>Time Zone</code> wrapped in <code>AsyncTask</code> ( <a href="">link 1</a> and <a href="">link 2</a> ), because access to the Internet must occur asynchronously, without clogging the main thread. <br><br>  In fact, the main part of the application and this article is a few requests on Geonames.org.  Here is the first one. <br><a name="JSONExpl"></a><br><pre> <code class="java hljs">String[] urlString = {<span class="hljs-string"><span class="hljs-string">"http://api.geonames.org/findNearbyJSON?lat="</span></span>,<span class="hljs-string"><span class="hljs-string">"&amp;lng="</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;radius=50&amp;username="</span></span>,<span class="hljs-string"><span class="hljs-string">"&amp;style=full&amp;maxRows=1"</span></span>}; outURL = urlString[<span class="hljs-number"><span class="hljs-number">0</span></span>] + f.format(lat).replace(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">"."</span></span>) + urlString[<span class="hljs-number"><span class="hljs-number">1</span></span>] + f.format(lon).replace(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">"."</span></span>) + urlString[<span class="hljs-number"><span class="hljs-number">2</span></span>] + _.names1[r.nextInt(_.names1.length)] + urlString[<span class="hljs-number"><span class="hljs-number">3</span></span>];</code> </pre><br>  ( <a href="">link 1</a> ) <br>  ( <a href="">reference 2</a> ) <br>  The request searches for any one object at a distance closer than 50 km. If this object has a time zone, this is the result.  If not, or such objects are not detected (for example, located somewhere in the ocean), then the time zone is calculated by the current latitude and longitude with the usual division of the globe into 24 parts ( <a href="">link</a> ).  Perhaps the object is not chosen arbitrarily, but the closest one is taken, but I did not check it in detail. <br>  The result is displayed in JSON format.  Therefore, in parallel, you can pull out and other information. <br><br>  The <code>names1</code> array ( <a href="">reference</a> ) from the <code>_.java</code> class stores logins on Geonames.org.  You can store one login, but several are better, since there is a limit on the number of requests per hour.  In this case, by increasing the number of users and choosing them randomly, it will be possible to proportionally increase the number of requests in such an artificial way.  The choice of the user through which the connection occurs, occurs randomly using r.nextInt () ( <a href="">which is r</a> ).  In the license I did not find restrictions for a similar trick. <br><br>  Once again I will write.  <b>Attention</b> , do not forget to <b>activate the user</b> .  To do this, <a href="http://www.geonames.org/manageaccount">go to your account</a> and click on the link: <u>Click here to enable</u> . <br><br>  The method, of course, is not absolutely accurate, but it is working.  And usually this method is quite enough.  No complaints from end users yet. <br><br><h4>  Class ACityListOnline.  On this screen, cities are searched by name. </h4><br><br>  Activity <code>ACityListOnline.java</code> <a href="">Class code</a> . <br><br>  Also used by Geonames.org in <br><pre> <code class="java hljs">CityTask extends AsyncTask&lt;String, Integer, Void&gt;</code> </pre>  ( <a href="">reference to class</a> ) <br>  ( <a href="">this is the launch of the CityTask class object</a> ) <br>  Here the requests are similar to <code>AGMap.java</code> , but the search is performed by name. <br>  Here is the second of those queries that work with GeoNames: <br><br><pre> <code class="java hljs">String[] urlString = {<span class="hljs-string"><span class="hljs-string">"http://api.geonames.org/searchJSON?q="</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;username="</span></span>,<span class="hljs-string"><span class="hljs-string">"&amp;style=full"</span></span>}; outURL = urlString[<span class="hljs-number"><span class="hljs-number">0</span></span>] + URLEncoder.encode(str, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) + urlString[<span class="hljs-number"><span class="hljs-number">1</span></span>] + _.names1[r.nextInt(_.names1.length)] + urlString[<span class="hljs-number"><span class="hljs-number">2</span></span>];</code> </pre><br>  ( <a href="">link 1</a> ) <br>  ( <a href="">reference 2</a> ) <br>  If the result is found, it is stored in an object of class <code>_Info</code> <br>  ( <a href="">reference to class</a> ) <br>  ( <a href="">link to the list of class objects that store search results</a> ) <br>  Further details can be viewed in another Activity by clicking on the <code>ListView</code> item. <br>  Now the object of class <code>_Info</code> stores the latitude, longitude, time zone and the international name of the region.  If you want to pull out other information (it is also available), you can take it from the JSON object yourself.  Everything is simple and tedious. <br><br><h4>  results </h4><br>  According to the main functionality everything. <br>  Once again link to <a href="https://play.google.com/store/apps/details%3Fid%3Dru.ps.habrtimezone">google play</a> . <br><div class="spoiler">  <b class="spoiler_title">QR for application</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/98c/359/a6a/98c359a6ae4613fb96d9af411e2c8459.gif"></div></div><br>  Before you use the code on <a href="https://github.com/yurevich1/habrtimezone">GitHub,</a> pay <b>attention to</b> : <br>  There are no Geonames.org users in this code. <br>  Namely, it will be necessary to insert user names into the variable <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] names1 = {<span class="hljs-string"><span class="hljs-string">"your_account_1"</span></span>,<span class="hljs-string"><span class="hljs-string">"your_account_2"</span></span>};</code> </pre>  in the <code>_.java</code> class ( <a href="">link</a> ), and also insert your <code>API_KEY</code> .  in <code>AndroidManifest.xml</code> ( <a href="">link</a> ) <br>  How to get these values, I explained above. <br>  In order for the project with GitHub to gather, you need to add this file to <code>Project&gt;Properties&gt;Java Build Path&gt;Libraries&gt;Add External JARs</code> : <code>Android_SDK_Path\extras\android\support\v4\android-support-v4.jar</code> .  Then go to <code>Project&gt;Properties&gt;Java Build Path&gt;Order and Export</code> and include this file. <br>  If there is interest in such an article, I can tell you next time how this can be done locally without an internet connection. </div><p>Source: <a href="https://habr.com/ru/post/209050/">https://habr.com/ru/post/209050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209034/index.html">Launching a platform for public discussions of legislative initiatives in the IT sphere - # We speak for the Internet</a></li>
<li><a href="../209038/index.html">Google simplified image search by license type</a></li>
<li><a href="../209040/index.html">Import data to online stores</a></li>
<li><a href="../209042/index.html">The results of the study of authentication methods and some mechanisms of protection against WEB-attacks on the example of Google, VK and others</a></li>
<li><a href="../209048/index.html">Use new reports in the structured data dashboard to fix markup errors.</a></li>
<li><a href="../209056/index.html">The Power of Objective-C 2.0. Effective programming for iOS and OS X</a></li>
<li><a href="../209060/index.html">Samsung branded retail in the province: we test and wonder</a></li>
<li><a href="../209062/index.html">IT Tree with Hackspace</a></li>
<li><a href="../209066/index.html">The programmer remembers his mistakes</a></li>
<li><a href="../209068/index.html">Programmer gets investment: our experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>