<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Type paper dissertation without allocations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. In addition to my previous article, there was an interesting dialogue with kirill_danshin . In the end we did it. Meet - efaceconv , tool for g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Type paper dissertation without allocations</h1><div class="post__text post__text-html js-mediator-article">  Hello.  In addition to my <a href="https://habrahabr.ru/post/315566/">previous</a> article, there was an interesting dialogue with <a href="https://habrahabr.ru/users/kirill_danshin/" class="user_link">kirill_danshin</a> .  In the end we did it.  Meet - <a href="https://github.com/t0pep0/efaceconv">efaceconv</a> , tool for go generate, with which you can bring types from interface {} without allocations and ~ 4 times faster. <br><a name="habracut"></a><br><h4>  How to work with it? </h4><br>  It's simple: <br><br><ol><li>  Install: go get github.com/t0pep0/efaceconv </li><li>  Add go generate to your sources go generate // go: generate efaceconv </li><li>  Describe the types, the conversion of which is necessary (more on that below) </li><li>  Run go generate and enjoy (ZY as a bonus - tests with 100% coverage on the generated code) </li></ol><br><h4>  How to describe types </h4><br>  Again, everything is simple.  Types are described in the comments.  The description format is as follows: <br><br><pre><code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//ec: ( ):: </span></span></code> </pre> <br>  Example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//ec:net/http:http.ResponseWriter:ResWriter //ec::string:String</span></span></code> </pre> <br>  After go generate will work in the package directory there will be 2 new files: <br><br>  efaceconv_generated.go - generated methods <br>  efaceconv_generated_test.go - tests and benchmarks for them <br><br>  Example demo.go: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//go:generate efaceconv //ec::string:String //ec::[]uint64:SUint64 package demo</span></span></code> </pre><br>  efaceconv_generated.go: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//generated by efaceconv DO NOT EDIT! package demo import ( "github.com/t0pep0/efaceconv/ecutils" ) var ( _StringKind uintptr _SUint64Kind uintptr ) func init(){ var sString string _StringKind = ecutils.GetKind(sString) var sSUint64 []uint64 _SUint64Kind = ecutils.GetKind(sSUint64) } // Eface2String returns pointer to string and true if arg is a string // or nil and false otherwise func Eface2String(arg interface{}) (*string, bool) { if ecutils.GetKind(arg) == _StringKind { return (*string)(ecutils.GetDataPtr(arg)), true } return nil, false } // Eface2SUint64 returns pointer to []uint64 and true if arg is a string // or nil and false otherwise func Eface2SUint64(arg interface{}) (*[]uint64, bool) { if ecutils.GetKind(arg) == _SUint64Kind { return (*[]uint64)(ecutils.GetDataPtr(arg)), true } return nil, false }</span></span></code> </pre><br>  efaceconv_generated_test.go: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//generated by efaceconv DO NOT EDIT! package demo import ( "reflect" "testing" ) func TestEface2String(t *testing.T) { var String string res, ok := Eface2String(String) if !ok { t.Error("Wrong type!") } if !reflect.DeepEqual(*res, String) { t.Error("Not equal") } _, ok = Eface2String(ok) if ok { t.Error("Wrong type!") } } func benchmarkEface2String(b *testing.B) { var String string var v *string var ok bool for n := 0; n &lt; bN; n++ { v, ok = Eface2String(String) } b.Log(v, ok) //For don't use compiler optimization } func _StringClassic(arg interface{}) (v string, ok bool) { v, ok = arg.(string) return v, ok } func benchmarkStringClassic(b *testing.B) { var String string var v string var ok bool for n := 0; n &lt; bN; n++ { v, ok = _StringClassic(String) } b.Log(v, ok) //For don't use compiler optimization } func TestEface2SUint64(t *testing.T) { var SUint64 []uint64 res, ok := Eface2SUint64(SUint64) if !ok { t.Error("Wrong type!") } if !reflect.DeepEqual(*res, SUint64) { t.Error("Not equal") } _, ok = Eface2SUint64(ok) if ok { t.Error("Wrong type!") } } func benchmarkEface2SUint64(b *testing.B) { var SUint64 []uint64 var v *[]uint64 var ok bool for n := 0; n &lt; bN; n++ { v, ok = Eface2SUint64(SUint64) } b.Log(v, ok) //For don't use compiler optimization } func _SUint64Classic(arg interface{}) (v []uint64, ok bool) { v, ok = arg.([]uint64) return v, ok } func benchmarkSUint64Classic(b *testing.B) { var SUint64 []uint64 var v []uint64 var ok bool for n := 0; n &lt; bN; n++ { v, ok = _SUint64Classic(SUint64) } b.Log(v, ok) //For don't use compiler optimization }</span></span></code> </pre><br>  As you can see, efaceconv generates methods like <br><br><pre> <code class="hljs cs">Eface2&lt;  &gt;(arg <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) (*&lt; &gt;, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)</code> </pre> <br>  Together with the documentation to them, tests and benchmarks, benchmarks are also generated for the classical cast type (v, ok: = arg. (Type)) so that you can compare the performance gain. <br><br><h4>  How it works </h4><br>  As we know (from my <a href="https://habrahabr.ru/post/315260/">previous</a> article) empty interfaces are simply a structure with two fields - * TypeDescriptor and a pointer to an object.  TypeDescriptor is generated at runtime, in a single instance for each type, respectively, for all empty interfaces from one type * TypeDescriptor will be equal and there is no need to parse TypeDescriptor itself.  We can simply compare the numeric value of the pointer, and already if they match, we can return a pointer to the object, being sure that it has the type we need. <br><br><h4>  Why is it faster than the standard method? </h4><br>  The standard type conversion method after comparing TypeDescriptors copies data by value, we just give a pointer to the original object. <br><br><h4>  Then why did not the authors of Go? </h4><br>  It's not safe.  More precisely not so, it is safe exactly as long as you use immutable data types (strings, slices, arrays).  In the case of using non-immutable data types, side-by-side writing is not neat. <br><br><h4>  Somewhere already in use? </h4><br>  <a href="https://habrahabr.ru/users/kirill_danshin/" class="user_link">kirill_danshin</a> implemented the first version in his production, I don‚Äôt know the results reliably, but judging by the <a href="https://github.com/t0pep0/efaceconv/commits/master%3Fauthor%3DkirillDanshin">commits</a> he is satisfied <br><br><h4>  Where are the numbers?  Pro performance and allocation </h4><br><pre> <code class="hljs go">BenchmarkEface2SByte<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">100000000</span></span> <span class="hljs-number"><span class="hljs-number">11.8</span></span> ns/op <span class="hljs-number"><span class="hljs-number">0</span></span> B/op <span class="hljs-number"><span class="hljs-number">0</span></span> allocs/op --- BENCH: BenchmarkEface2SByte<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> BenchmarkSByteClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">30000000</span></span> <span class="hljs-number"><span class="hljs-number">50.4</span></span> ns/op <span class="hljs-number"><span class="hljs-number">32</span></span> B/op <span class="hljs-number"><span class="hljs-number">1</span></span> allocs/op --- BENCH: BenchmarkSByteClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> BenchmarkEface2String<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">100000000</span></span> <span class="hljs-number"><span class="hljs-number">11.1</span></span> ns/op <span class="hljs-number"><span class="hljs-number">0</span></span> B/op <span class="hljs-number"><span class="hljs-number">0</span></span> allocs/op --- BENCH: BenchmarkEface2String<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>: <span class="hljs-number"><span class="hljs-number">0xc42003f</span></span>ee8 <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>: <span class="hljs-number"><span class="hljs-number">0xc420043ea8</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>: <span class="hljs-number"><span class="hljs-number">0xc420043ea8</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>: <span class="hljs-number"><span class="hljs-number">0xc420043ea8</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">76</span></span>: <span class="hljs-number"><span class="hljs-number">0xc420043ea8</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> BenchmarkStringClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">30000000</span></span> <span class="hljs-number"><span class="hljs-number">45.3</span></span> ns/op <span class="hljs-number"><span class="hljs-number">16</span></span> B/op <span class="hljs-number"><span class="hljs-number">1</span></span> allocs/op --- BENCH: BenchmarkStringClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> BenchmarkEface2SInt<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">100000000</span></span> <span class="hljs-number"><span class="hljs-number">11.6</span></span> ns/op <span class="hljs-number"><span class="hljs-number">0</span></span> B/op <span class="hljs-number"><span class="hljs-number">0</span></span> allocs/op --- BENCH: BenchmarkEface2SInt<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">119</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">119</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">119</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">119</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">119</span></span>: &amp;[] <span class="hljs-literal"><span class="hljs-literal">true</span></span> BenchmarkSIntClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> <span class="hljs-number"><span class="hljs-number">30000000</span></span> <span class="hljs-number"><span class="hljs-number">50.5</span></span> ns/op <span class="hljs-number"><span class="hljs-number">32</span></span> B/op <span class="hljs-number"><span class="hljs-number">1</span></span> allocs/op --- BENCH: BenchmarkSIntClassic<span class="hljs-number"><span class="hljs-number">-4</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">134</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">134</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">134</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">134</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> efaceconv_generated_test.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">134</span></span>: [] <span class="hljs-literal"><span class="hljs-literal">true</span></span> PASS</code> </pre><br><br><h4>  Villains!  I did everything as written for the mutable type and I got strange behavior in the code! </h4><br>  <abbr title="Himself a vicious Buratino">CVDF</abbr> <br><br>  <b>UPD:</b> <a href="https://gist.github.com/t0pep0/a14f56c8fde80a3b5e351c44c3584238">About possible problems, if not to think</a> . </div><p>Source: <a href="https://habr.com/ru/post/315752/">https://habr.com/ru/post/315752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315738/index.html">Stacker: Nginx, DB (Mysql, Pgsql, Redis), PHP7 + xDebug in 5 minutes</a></li>
<li><a href="../315740/index.html">LEGO MINDSTORMS Education EV3 in career guidance</a></li>
<li><a href="../315744/index.html">Lenovo fixed vulnerabilities in the firmware of their computers</a></li>
<li><a href="../315748/index.html">Report from Moscow CocoaHeads Meetup October 28</a></li>
<li><a href="../315750/index.html">ITMO University Developments: Blockchain-Based Drone Management</a></li>
<li><a href="../315754/index.html">Selection of useful slides about Linux</a></li>
<li><a href="../315756/index.html">Protect the diploma. Five minutes of shame or decent performance</a></li>
<li><a href="../315758/index.html">The ‚ÄúUltimate‚Äù SSL Digest: The best practical materials on Habr√© and not only</a></li>
<li><a href="../315760/index.html">React Testing</a></li>
<li><a href="../315762/index.html">Crowd funding will help develop an ATX motherboard for IBM's Power8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>