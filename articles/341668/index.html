<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>R, Asterisk and wardrobe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is a continuation of previous publications . The main purpose of publications is to demonstrate the capabilities of R in solving various ‚Äúroutine‚Äù ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>R, Asterisk and wardrobe</h1><div class="post__text post__text-html js-mediator-article"><p>  It is a continuation of <a href="https://habrahabr.ru/post/335576/">previous publications</a> .  The main purpose of publications is to demonstrate the capabilities of R in solving various ‚Äúroutine‚Äù tasks of processing data arising in business.  The main focus is on creating a complete solution for the end user, and not on the fundamental solution of a particular task by typing commands in the console.  A schematic prototype and product from the conveyor have more differences than similarities. </p><br><p>  On the fine mechanics of R there are a huge number of specialized blogs, books, and also github.  But they usually turn to them only after they see that the solution of the problem by means of R is possible and very elegant. </p><br><a name="habracut"></a><br><h1 id="s-chego-vse-nachinalos">  How it all began </h1><br><p>  In general, the initial situation is very typical for companies that have at least some semblance of a call center serving the requests of external users.  There is a PBX (in our case - several geographically separated Asterisk instances, version 13LTS).  There is an information system / system in which operators contribute what they have heard from users.  And there is a pile of automated business processes for processing user requests. </p><br><p>  There is also a vertical of leadership from the head of the call center to top management, as well as related units, for example, marketing, which for strategic management require a summary of how people live, how KPIs behave and where business goes.  And here the wishes and capabilities of each other find themselves very weakly. </p><br><p>  If in part of the desk service some report generator already existed, then Asterisk initially had nothing but logs and cdr. </p><br><h1 id="shag-1">  Step # 1 </h1><br><p>  We tried to follow the standard path, we looked at the existing Asterisk tools.  As a first approximation, we stopped at free software versions: </p><br><ul><li>  <a href="https://asterisk-pbx.ru/wiki/soft/call_center/asternic-call-center-stats">Asterisk Call Center Stats</a> ; </li><li>  <a href="http://prog-it.github.io/Asterisk-CDR-Viewer-Mod/">Asterisk CDR Viewer Mod</a> . </li></ul><br><p>  It got a little better.  The required analytical report was finally prepared by the responsible employees.  However, the quality of this reporting was very poor for several reasons: </p><br><ol><li>  Processing scripts in asterisk were very complex and written through macros.  Normally, CDR files are generated with a focus on minimizing the number of records.  Therefore, in the resulting CDRs, when the internal transfers and shoulders were collapsing, a number of important data was lost.  Both A numbers (due to macros) and B numbers (when combining the shoulders initiated by the operator). </li><li>  Queues also contain incomplete information.  No IVR records, no information on transfer to the outside.  And a lot of things not. </li><li>  The programs themselves can and produce generally accepted statistics on call centers, but in relation to our tasks, more than half of the output results were not very useful for business, because they did not answer the right questions. </li><li>  Free versions are trimmed by functionality + I had to ‚Äúfinish my‚Äù php with my hands, so that at least it did not fall.  I ignore the wrong duration calculations, because of their insignificance (~ 10%).  For simplicity, I write it off on our specific asterisk settings. </li><li>  Data from external directories and systems can not be attached.  Everything is just hands in excel.  For example, to submit a report not by numbers, but by the name of the operator, taking into account the shift schedule. </li><li>  There is no graphic representation, and those that are offered in paid versions are far from what is required. </li><li>  Different systems almost always gave different numerical results.  Sometimes the difference reached hundreds of percent.  Obviously, this was due to the complexity of calls, as well as differences in the algorithms of calculations embedded in the programs. </li></ol><br><h1 id="shag-2">  Step 2 </h1><br><p>  Undertook the independent analysis of cdr and log files.  R. was used as an analysis tool. In fact, the data itself is not very much.  Several thousand calls to the CNN result in 1-2 GB records in packed form for a year of work.  For modern laptops - this is complete nonsense, not to mention the server hardware. </p><br><p>  And here began interesting things.  Even the most cursory glance various data cuts caused a lot of technical issues leading to the tuning of asterisks. </p><br><ul><li>  Why don't macros give out the right information for certain types of conversations? </li><li>  Why are identifiers sometimes lost, allowing us to link tripartite sessions in which the operator is an intermediary? </li><li>  Why do the time metrics in cdr not always coincide with real time events?  The time in the IVR is not always and not in full must be considered (depending on logic), and the IVR may be different. </li><li>  Why are there not a number of required parameters in the queues? </li></ul><br><p>  But this is only the technical side of the issue.  After a careful study of the data, it was decided to abandon the use of cdr (too incomplete and unreliable data were recorded there, and radically modifying the logic of cdr formation on production did not inspire anyone in optimism. Therefore, they switched to the call-flow analysis model based on data obtained from the log queues (queue log) with the following logic: </p><br><ol><li>  we reconstruct all events within the call flow using the identifiers of the primary session and linked sessions; </li><li>  we perform event thinning based on the kpi business logic (multiple RING NO ANSWER; multiple ENTER QUEUE in the same queue or to another; ATTENDENT TRANSFER \ BLIND TRANSFER to external numbers, etc.); </li><li>  for lined up cleared call flow we recalculate the real duration of all events based on their time stamps; </li><li>  We are enriching the call-flow with data from external sources, in particular, from the schedule of duty shift operators, in order to get a full name from the operator number; </li><li>  we get a "clean" set of "raw" data for which we are already building all the necessary reporting. </li></ol><br><p><img src="https://habrastorage.org/webt/59/f1/96/59f19690099cd073186691.png" alt="call-flow"></p><br><p>  In general, automatic generation of a set of business artifacts follows: dashboards, reports, uploads (xls, pdf, csv, doc, ppt, ...) <br>  The AWP itself for the head of the call center is built on Shiny. </p><br><p><img src="https://habrastorage.org/webt/59/f1/96/59f1968feb815171487957.png" alt="dashboard"></p><br><p>  It is important that after such a ‚Äúcleansing‚Äù of data one could sit at the table with the business and discuss the metrics (KPI) and the method of their calculation.  Does the subscriber's time in the internal IVR count as the duration of the call or not?  Does CONNECT consider the subsequent instant return to the queue as the response of the operator or not?  How to decompose KPI operators and queues subscriber in multiple queues?  How to compare the average waiting time in the queue with the time of day and the number of operators in a shift?  What are the typical "optimization" scenarios for operators?  And a lot of other questions.  The best part is that all questions can be given a clear and unequivocal answer. </p><br><p>  An additional advantage to switching to call-flow event analysis is the possibility of studying call center operation scenarios.  In fact, reverse engineering of business processes by their tracks in the call center logs.  Curious things show up! </p><br><p><img src="https://habrastorage.org/webt/59/f1/96/59f196902739a746173851.png" alt="process mining"></p><br><h1 id="shag-3">  Step 3 </h1><br><p>  Transition to the analysis of AMI events.  In general, this is the most universal way, but it requires a little more computing power.  After an insignificant adjustment of the queue logs, the sharpness in the AMI analysis disappeared for an individual asterisk, but storing them in the context of the asterisk's historical work (troubleshooting) remains useful.  Also, working with AMI ensures independence from the individual settings of an individual asterisk, which will be relevant when connecting the following.  To ensure the speed of working with AMI, we "dump" all 151 event types with 619 possible fields in ClickHouse. </p><br><h1 id="posleslovie">  Afterword </h1><br><p>  As many may say, the task is very private, the data volumes are small.  But from this, the importance of this task for the business does not diminish.  The use of the same R allowed to solve it quickly and elegantly, while creating a comfortable workplace for ordinary business users.  And from the point of view of industrial programming, everything is also ok: packaging, documenting functions using roxygen, autotests, logging, everything that can be done online with checks and assertions. </p><br><p>  Now, having a solid foundation, you can safely move on to forecasting and operational analytics. </p><br><p>  The answer to the question ‚Äúwhat does the wardrobe have to do with?‚Äù Is, alas, quite prosaic.  Because from it came the skeletons, which were carefully hidden by call center operators.  And R + Shiny served as a key to open it. </p><br><p>  Previous Post: <a href="https://habrahabr.ru/post/340316/">Do you already apply R in business?</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341668/">https://habr.com/ru/post/341668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341656/index.html">We invite to the conference FPConf 2017</a></li>
<li><a href="../341660/index.html">Streaming and analyzing Java application logs in MS Azure using Log4j and Stream Analytics</a></li>
<li><a href="../341662/index.html">Report - overview of the capabilities and architecture of CppComet comets</a></li>
<li><a href="../341664/index.html">Crash browser warnings with pseudo-password fields</a></li>
<li><a href="../341666/index.html">Joker 2017 conference: amazing stories</a></li>
<li><a href="../341670/index.html">Let's try to evaluate Kubernetes</a></li>
<li><a href="../341672/index.html">Do you have a student syndrome?</a></li>
<li><a href="../341676/index.html">No, I do not have third-party projects to show you</a></li>
<li><a href="../341678/index.html">Telegram-bot for home video surveillance from scrap materials</a></li>
<li><a href="../341680/index.html">And you still do not pay a premium for on time made projects?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>