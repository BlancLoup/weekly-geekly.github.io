<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithms for video processing processor TI DM368</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We begin a series of articles on Habr√©, dedicated to video processors TI DM368, DM369 and the development of algorithms based on them. 
 Let's conside...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithms for video processing processor TI DM368</h1><div class="post__text post__text-html js-mediator-article">  We begin a series of articles on Habr√©, dedicated to video processors TI DM368, DM369 and the development of algorithms based on them. <br>  Let's consider the main processing units of the video stream from the sensor to the network ‚Äúbroadcaster‚Äù, we‚Äôll discuss in more detail the algorithms of autoexposure, white balance and autofocus (3A), gamma correction, as well as HDR or WDR extended dynamic range, and, finally, motion detection and analytics its basis. <br>  Examples of pictures will be presented for the SONY <a href="http://www.sony.net/Products/SC-HP/cx_news/vol68/pdf/imx136lqj_llj.pdf">IMX136</a> sensor, the algorithm is also tested on Aptina <a href="http://www.aptina.com/products/image_sensors/mt9p006i12stc/">MT9P006</a> , <a href="http://www.aptina.com/products/image_sensors/ar0331/">AR0331</a> , <a href="http://www.aptina.com/products/image_sensors/mt9m034/">MT9M034 sensors</a> . <br><table><tbody><tr><td>  Before </td><td>  After </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/b47/627/6de/b476276ded18a9d487641481b0ba59a6.jpg" width="400"></td><td><img src="https://habrastorage.org/getpro/habr/post_images/528/6cc/139/5286cc139ff5d7eebad46cabfedbf1f4.jpg" width="400"></td></tr></tbody></table><br><a name="habracut"></a><br>  The main players in the processor market for video surveillance ip are 3 companies <a href="http://www.ti.com/">TI</a> , <a href="http://www.ambarella.com/">Ambarella</a> and <a href="http://www.hisilicon.com/">Hisilicon</a> .  All of them have chips of a different price range, the most popular on the market today are the ability to encode FHD (1920x1080) video stream up to 30 frames per second DM368 (TI), A5 (Ambarella), Hi3516 (Hisilicon) at prices from $ 10 to $ 20 and more powerful up to 60 frames per second DM385 (TI), A7 (Ambarella), Hi3517 (Hisilicon) at prices ranging from $ 20 to $ 40.  The characteristics of these chips are about the same. <br>  Since TI is a fairly open company, all the documentation on hardware is on the site, it‚Äôs easiest to work with them.  To get the software and the entire design, it is enough to buy a camera from <a href="http://www.appropho.com/">Appro</a> for $ 1000 and go.  To obtain documentation from HiSilicon, you must sign an NDA, and the cost of support and reference fee is $ 5000.  The most expensive was Ambarella, to get the documentation and support you need to pay $ 25,400. <br><br>  So back to DM368: <br><img src="https://habrastorage.org/getpro/habr/post_images/d2c/2ea/7f8/d2c2ea7f8ce481768d8089dd04277196.png"><br>  As can be seen in the diagram, the processor has everything you need for an ip camera and not only for it.  Video Processing deals with Video Processing Subsystem (VPSS), in turn, it consists of two Video FE (Front End) and Video BE (Back End) blocks.  Video FE is responsible for inputting and processing the video signal, and Video BE for encoding and outputting to various devices.  Hardware support for 3A algorithms is located in the Video FE module. <br><br>  Consider it in more detail: <br><img src="https://habrastorage.org/getpro/habr/post_images/51b/89c/955/51b89c95509951c8ec58242222e1c9db.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The input IPIPEIF (Image Pipe Interface) receives a ‚Äúraw‚Äù raw 12 bit image in <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%2591%25D0%25B0%25D0%25B9%25D0%25B5%25D1%2580%25D0%25B0">Bayer</a> format from the sensor.  This unit itself does nothing particularly useful, it is mainly used to synchronize the work of ISIF and IPIPE, it can also subtract from each new dark frame stored in memory, but we do not use it. <br>  The Image Sensor Interface (ISIF) can convert Bayer to various formats, multiply, subtract, etc., for more information about the possibilities, see the <a href="">documentation</a> .  We from this block for our algorithms use: <br>  1. A ‚Äúsubtractor‚Äù of a constant value from all colors, with our two sensors, in total darkness, not 0, but a constant, is issued for SONY 176, but for Aptina 172. This must be taken into account for correct color balancing, especially in the dark. <br>  2. Gain and Offset - we make them white balance.  For each color, you can set your multiplication factor from 0 to (7 + 511/512), in the standard format for all hardware ‚Äúmultipliers‚Äù: OUT = IN * G &gt;&gt; 9, where IN is the input color value, G is the ‚Äúmultiplier‚Äù from 0 until 4095. <br>  The next Image Pipe (IPIPE) block is used by us for everything else. <br><img src="https://habrastorage.org/getpro/habr/post_images/785/6a8/e3f/7856a8e3f9ba256bbf3eb41e4c1e6bd2.png"><br><br>  Let's start in order: <br>  1. Defect Correction can process ‚Äúbroken‚Äù pixels, but before processing it needs to know their coordinates, and in order to specify them, each sensor needs to be calibrated in the dark, which greatly complicates production.  Not too many defective sensors come across, and if caught, it is easier to replace. <br>  2. The next White Balance block consists of 3 multipliers and 3 subtractors, one for each color, we use it as a global multiplication factor and a threshold subtractor, the same for all colors. <br><img src="https://habrastorage.org/getpro/habr/post_images/d72/128/442/d72128442765ec94f97e19537ba85557.png"><br>  the format is the same as in the ISIF block, only the multiplication range is twice as large. <br>  3. CFA Interpolation converts from <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%2591%25D0%25B0%25D0%25B9%25D0%25B5%25D1%2580%25D0%25B0">Bayer</a> format <br><table><tbody><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/12a/8c2/592/12a8c2592cc8a6a76ae6ac394ff8b4ef.png"></td><td>  in RGB </td><td><img src="https://habrastorage.org/getpro/habr/post_images/ec5/c41/030/ec5c410305f58eed9cec3b9d7a73e88d.png"></td></tr></tbody></table><br><br>  What interpolation algorithm is used, we have not found. <br>  4. RGB2RGB blending module passes each pixel of RGB through the matrix <br><img src="https://habrastorage.org/getpro/habr/post_images/eb3/822/67e/eb382267e51335ff75b9fa058e6f1878.png"><br>  where gain can vary from -8 to +7.996 with a step of 1/256 = 0.004, a offset from -4096 to 4095. <br>  Moreover, these blocks turned out to be two, one after another, and we both use them in our algorithms.  Each manufacturer provides a table for their sensors.  Honestly, I don‚Äôt quite understand how it works and how colors can mix, but the picture really gets better.  Soon everyone will see for yourself. <br><br>  5. The <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B0-%25D0%25BA%25D0%25BE%25D1%2580%25D1%2580%25D0%25B5%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">gamma correction</a> block consists of 3 LUTs (look-up-table), one for each color. <br><img src="https://habrastorage.org/getpro/habr/post_images/012/2f6/c7b/0122f6c7b901cbfeafdc3aa035e08ce2.png"><br>  You can choose a table size from 512 to 64 values, we use 512. Each element of the table consists of two 10 bit words Offset and Slope. <br><img src="https://habrastorage.org/getpro/habr/post_images/a38/439/896/a3843989611494c840c4e666b1477c6c.png"><br>  The input is 12-bit IN data, then it is split into two parts: HIGH = IN &gt;&gt; 3, LOW = IN &amp; 7, the upper 9 bits and the lower 3 bits.  The output value is calculated using the following formula OUT = (Offset [HIGH] &lt;&lt; 3) + (Slope [HIGH] &gt;&gt; 3) * LOW.  That is, the gamma curve is approximated by a piecewise smooth function. <br><img src="https://habrastorage.org/getpro/habr/post_images/e2a/f5a/325/e2af5a3257d31eb8e54ebde9c2d1e5b8.png"><br>  6. The <a href="http://ru.wikipedia.org/wiki/YCbCr">RGB2YCbCr</a> unit translates the RGB color space to YCbCr. <br>  7. 4: 2: 2 Conversion Module halves the color components of Cb and Cr <br>  horizontally. <br><img src="https://habrastorage.org/getpro/habr/post_images/9cc/834/d73/9cc834d730cbb356751b0cb346eb53ab.png"><br>  8. 2D Edge Enhancer, this is a two-dimensional 5x5 filter that improves the contrast of the image - this is a separate topic for the article, here I will give only examples of its work: <br>  2D EE is turned off: <br><img src="https://habrastorage.org/getpro/habr/post_images/d63/513/29e/d6351329ed89535a30f0eb8bc2348f0d.jpg"><br>  2D EE included: <br><img src="https://habrastorage.org/getpro/habr/post_images/5b4/93c/26e/5b493c26e0612f95cab825bf24fb7d26.jpg"><br>  That is a very useful thing. <br>  9. Resizer reduces the picture vertically and horizontally for the second and third streams, and also converts YCbCr 422 to YCbCr 420 for the encoder. <br><br>  Separately from the entire video processing path, there is a block of H3A statistics.  It is needed to implement all the algorithms.  On the basis of the data obtained from it, the exposure, gain factors and shifts are set. <br>  1. Statistics for the exposure and color balance is obtained by dividing the image into cells up to 56 horizontally and 128 vertically.  For each cell, you can get the sum of all pixels for each color, the minimum and maximum values. <br>  2. The block for autofocus also breaks the picture into cells up to 12 horizontally and 128 vertically.  And for each cell gives the maximum value of the focus. <br>  But this is not explained.  Studying the software didn‚Äôt really clarify anything, it only became known that it was a kind of RIF filter, in which you can change the coefficients and thresholds, but it didn‚Äôt help much, and autofocus didn‚Äôt work stably. <br><br>  So, why did we undertake this and what did not suit us in the existing algorithms?  The main problem of the existing algorithm is the incomplete use of dynamic range. <br>  An example of the algorithm for cloudy weather: <br><img src="https://habrastorage.org/getpro/habr/post_images/aef/da6/382/aefda63828707766a93764bf1f0eff22.jpg"><br>  In the mornings and evenings, as a rule, the white balance floats: <br><img src="https://habrastorage.org/getpro/habr/post_images/137/94e/7eb/13794e7eb44f7034551f95d928937d15.jpg"><br>  And this example with our algorithm: <br><img src="https://habrastorage.org/getpro/habr/post_images/d37/1f9/728/d371f972839fbb08a26f5021583c7e41.jpg"><br>  And so that everything worked well with different sensors, we decided not to edit a bunch of other people's software, but to write ours from scratch.  Another task is to transfer the algorithm as easily as possible to other platforms.  On luck, the DM368 had a very useful hardware unit, the so-called Boxcar.  Nothing less than an averager in 8x8 or 16x16 blocks <br><img src="https://habrastorage.org/getpro/habr/post_images/6ba/446/4e3/6ba4464e34da3e4a83c202af99a6eeeb.png"><br>  That is, at the output of boxcar, we get a 16 times reduced raw image on each axis.  If the input resolution is 1920x1080, then for statistics we have 120x68. <br>  We took this block as a source of statistics. <br><br>  Let us draw a block diagram of the operation of our algorithm and proceed to the code. <br><img src="https://habrastorage.org/getpro/habr/post_images/c24/9b0/fd1/c249b0fd14214d5fd6950033984690b5.jpg"><br>  Live broadcast from our and other cameras can be viewed <a href="http://www.sigrand.com/index.php%3Foption%3Dcom_banners%26task%3Dclick%26id%3D3%26lang%3Dru">here</a> . <br>  To be continued‚Ä¶ </div><p>Source: <a href="https://habr.com/ru/post/217317/">https://habr.com/ru/post/217317/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217303/index.html">Dell PowerEdge R820 12G server overview</a></li>
<li><a href="../217305/index.html">Modification for the "Master"</a></li>
<li><a href="../217307/index.html">Steve Jobs has banned Google from hiring even former Apple employees</a></li>
<li><a href="../217309/index.html">How to catch a hedgehog</a></li>
<li><a href="../217315/index.html">Photo report from the exhibition of retrocomputers in Minsk</a></li>
<li><a href="../217319/index.html">Computer vision library CCV 0.6 with new image classifier</a></li>
<li><a href="../217321/index.html">PVS-Studio now supports any build system on Windows and any compiler. Easy and out of the box</a></li>
<li><a href="../217325/index.html">Automatic update of C # programs</a></li>
<li><a href="../217327/index.html">Attacks in time - a fairy tale or a real threat?</a></li>
<li><a href="../217331/index.html">Enigma algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>