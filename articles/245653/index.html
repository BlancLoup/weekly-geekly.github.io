<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electrofocus on the base of the Arduino Uno debug board, part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue the description of the electrofocus with the control unit based on the Arduino. The third part is devoted to the microcontroller code, as w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electrofocus on the base of the Arduino Uno debug board, part 3</h1><div class="post__text post__text-html js-mediator-article">  I continue the description of the electrofocus with the control unit based on the Arduino.  The third part is devoted to the microcontroller code, as well as some of the subtleties of assembly and configuration. <br>  The first part is <a href="http://habrahabr.ru/post/245265/">here</a> , the second part is <a href="http://habrahabr.ru/post/245355/">here</a> . <br><br>  This text is aimed at those who will understand the code for the purpose of its partial or full use and at those who solve similar problems and can learn something useful.  The code is commented, so I will limit myself to a description of the structure and general logic, plus I will note important details. <br><a name="habracut"></a><br><br><h2>  Microcontroller code </h2><br>  The microcontroller code was developed and debugged in the Arduino 1.0.5-r2 environment, the latest version is available on <a href="https://github.com/flyeye/AstroTools/tree/master/Focuser/FocuserFirmware">githab  ªe</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the task of managing only one focuser was initially set forth, I did not use the features of the PLO.  Only stepper motor control is allocated to a separate class in the StepperClass library. <br><br>  Based on the task, the microcontroller should perform the following main functions: <br><ol><li>  Initialize focuser - Setup (); </li><li>  Periodically remove the status of the buttons and the potentiometer from the remote control, control the status indication with the LEDs; </li><li>  Communicate with software on a laptop via RS232 - serialEvent () and SendCmd (); </li><li>  And control the stepper motor, rotating it at a given speed in a given direction, counting the steps taking into account the microstep mode, if necessary, controlling the output beyond the specified boundaries - StepperClass; </li></ol><br><br><h3>  A few words about Loop () </h3><br>  The potentiometer is <i>polled</i> at the interval specified in <i>CheckSpeedTime</i> (100 ms by default).  The buttons interrogate each time, although this is of course redundant, you can also bind to <i>CheckSpeedTime</i> . <br><br>  The motor rotates through a call to the global function Roll (), which translates it further to StepperClass.Roll (), while flashing the LED on the <i>motorled</i> pin. <br>  When changing the current speed in any way, the brightness of the LED on the <i>speedled</i> pin <i>changes</i> . <br><br>  With a sufficiently long inactivity (set in <i>ReleaseTime</i> ), the voltage is removed from the engine (SMs tend to actively eat the current and heat up).  Undoubtedly, this option is "an amateur."  In an amicable way, after precise focusing, the focus can not be touched.  Ideally, it should be mechanically fixed, if it is provided for by the construction of the focus.  If this is not done, then removing the current from the SM, we can get a small shift in the position of the focuser, that is, a small defocusing.  In each particular case, it is necessary to check whether the stress relieves the focuser shift, and if so, turn off the automatic stress relief in the sketch and either manually remove it (having previously locked the focuser with the fixer), or not at all. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression on the topic of the SD library management</b> <div class="spoiler_text">  There are quite a few libraries that allow you to literally immediately start working with the SD, without understanding the details.  I tried several different ones, most of all I liked <a href="http://www.airspayce.com/mikem/arduino/AccelStepper/">AccelStepper</a> .  It is quite popular, has official offshoots, for example from <a href="https://github.com/adafruit/AccelStepper">Adafruit</a> .  For this and all such tasks, it is quite suitable, I used it for about half a year.  The library is universal, it is not focused on any specific SD driver.  During initialization, we specify the control pins - and more.  Recommend! <br><br>  But she also has flaws.  Chief among them is no microstep support.  In a number of tasks, this is extremely inconvenient.  The speeds in the library are set in revolutions per second, and the position in steps.  Obviously, if we change the micro-step mode, we will get a different speed, and the wrong position.  If the microstep mode does not change - do not worry, once we introduce the correction factors.  But if the micro-step mode dynamically switches, the situation becomes much more complicated.  One option is to make a wrapper, which remembers the mode and automatically recalculates the coordinates and speeds.  What I did for the time being. <br><br>  In this project, the use of AccelStepper is quite acceptable and justified.  I encountered some oddities and at least one bug (if you set the speed to 0 and take a step - the control does not return, we hang), but in general - I recommend to use it. <br><br>  Developing your own class for controlling the SD is a forced step.  In another project, working with a microstep became critical for me, and how much time I wrote my library was much simpler, but with microstage support and focused on working with the Polulu driver line (A4988, DRV8825).  The library is very small, posted on <a href="https://github.com/flyeye/AstroTools/tree/master/StepperClass">github</a> , the heading text contains comments. <br><br>  The library will be updated and updated.  In honesty, there are plans for substantial refinement of the Roll () function in order to improve the accuracy and smoothness of the course (taking into account the steps missed <u>in time</u> , the ‚Äúcatch up‚Äù mode). <br><br>  I did not want to use different libraries in close projects, so the focuser was also transferred to StepperClass. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">And one more lyrical digression about units</b> <div class="spoiler_text">  In this case, accurate knowledge of the rotation speed gives the user absolutely nothing.  It is possible to draw an analogy with the volume control in everyday life - to us it does not matter in what units this or that pen, linear scale or logarithmic one.  It is important to us that if the slider at the bottom is quiet, and at the top it is loud. <br><br>  In this project, I decided not to complicate life and adhere to the same principle.  As such, the speed is not calculated at all.  Left quickly, right - slowly.  While the microcontroller code everywhere operates not with speed, but with the interval between the steps of the engine, which in practice is somewhat more convenient. <br></div></div><br><br><h2>  RS232 Concentrator Control Protocol </h2><br>  I did not find anything standard or generally accepted in the management of focusing devices (although I honestly did not dig deeply).  In the future, I plan to write an ASCOM driver and use it with BackyardEOS, and with something else I hardly have to integrate.  Therefore, I decided to use my very simple protocol: <br><table><tbody><tr><td>  168 </td><td>  Team ID (1 byte) </td><td>  command parameter </td><td>  13 </td><td>  ten </td></tr></tbody></table><br><br>  There is no checksum, the command size is unlimited (only a reasonable size of the receive buffer is 255 bytes) and is not predefined in the package.  When a command is received, the buffer accumulates until the end ID of command # 13 # 10 arrives.  After that, the command ID and the command parameter are allocated from the buffer and the command is executed.  Omitting the ID of the beginning or end of a command may result in the omission of one command.  In practice, this is not critical.  I will describe the commands and parameters in more detail in the next section, here it is not so important. <br><br>  Any command received is necessarily confirmed either by a response (for example, if it was a speed request, then the same command identifier is used), or by confirmation of the execution of the action (then there may be several packages with different identifiers). <br><br>  All commands except FOCUSER_GO_TO_POSITION are executed immediately.  The transition to a given position is performed in the main loop, so this operation can be performed for a long time, but we need to keep the possibility of canceling the operation. <br>  In fact, the protocol completely simulates the operation of the remote control and even a little more. <br><br><h2>  The subtleties of adaptation and configuration, as well as some rakes </h2><br><br><h3>  Current adjustment on A4988 and skip steps </h3><br>  The SD driver A4988 has a built-in current limiter supplied to the SD.  The stuff is very useful and important.  How to use it is described <a href="http://www.pololu.com/product/1182">on the developer's site</a> .  But she has one interesting effect.  As we know, when the current decreases, the torque drops.  Strangely enough, specifically on the A4988 in the microstep mode, this can be expressed in the regular 100% skipping of steps at a certain phase.  Therefore, in the 1/16 mode, you can easily get together 16 steps, only 4, or 8. Add current - and everything is fine. <br><br><h3>  Stepper Connection </h3><br>  When connecting the SD to the driver, it is advisable not to confuse the taps between the pairs (see bipolar SD connection diagrams).  To confuse the bends inside the pair is not scary, get the rotation in the other direction.  I recommend the first thing to ring a pair of taps and check the resistance of the windings, if it matches what was promised to you. <br>  Once I was sold a SD for a nominal voltage of 12V, but it turned out that in fact it was designed for 2.8V.  And I was surprised - why he somehow walks strangely with me, the driver heats up, the arduink sometimes turns off ... <br><br><h3>  Maximum rotation speed, pause between steps and microstep </h3><br>  Any SD has a maximum rotation speed.  Usually - this is hundreds of revolutions per second.  From the point of view of controlling the SD, this means that there is a certain minimum time interval between steps.  Trying to take steps in the thicket is not only useless, but even harmful - the SD will twitch, whistle, buzz, but will not walk normally.  This is another opportunity to get SD, not wanting to walk normally.  The manufacturer does not always indicate the maximum speed, so it is quite likely that it will have to be determined by practical consideration. <br><br>  An important and interesting point, which is usually not written about - how the use of microstep mode affects the maximum speed and the minimum duration of the pause between steps, respectively.  The answer is - the use of microstep has almost no effect on the maximum rotational speed.  At least, not essential in this work.  But the duration of the pause between steps is very much affected.  The smaller step we use, the more often we need to give a command to the next step.  As an experiment, I tested one of my engines and got this picture: <br><img src="https://habrastorage.org/files/960/f30/289/960f302897024673865d5f022ba0cbaa.jpg"><br>  Horizontal is the size of the pause between steps in microseconds, vertically is the microstep mode.  In the cells, the rotation speed in the angular measure per unit of time, obtained experimentally, corresponding to the specified mode and the specified pause value.  The absolute value of speed in this case is not important (measured speed on the shaft attached to the motor through a worm gear and gearbox), the ratio between different cells is important. <br><br>  It is easy to see that the maximum speed of <b>0.161</b> was achieved in the 1/8 microstep mode with an interval between steps of 125 microseconds (pure luck, at a full step, it would also certainly be possible to get it with an interval of about 1200).  A slightly lower speed of <b>0.139</b> was obtained twice, in full step mode with an interval of 1250 microseconds, and in 1/16 step mode with an interval of 50 microseconds.  A close speed of <b>0.135</b> was obtained in the 1/4 microstep mode with an interval of 300 microseconds.  It turns out that when going from full step to 1/16 step to save the current speed, the interval between steps needs to be reduced exactly 25 times (but not 16!). <br>  It is also clear that in the 1/32 microstep mode the maximum speed would be impossible to obtain.  In this case, we are limited to the execution time of loop (), which on Arduino Uno is about 30 microseconds on an empty loop (at least it was on the ‚ÄúChinese‚Äù where I conducted the experiments). <br><br>  From all this it follows one simple conclusion - in our case it is reasonable to choose the microstep mode as much as possible, but considering the possible loss of torque.  At maximum speed, we will not lose, smoothness and accuracy at low speeds will increase. <br><br><h3>  What needs to be changed in the sketch to adapt to another engine </h3><br><ul><li>  Maximum and minimum speed values.  Set in MIN_SPEED_DELAY and MAX_SPEED_DELAY as the interval between steps in microseconds.  You can grope empirically; </li><li>  Mikroshag.  Set based on engine capabilities in DEFAULT_MS.  If there is enough torque, it is better to leave 1/16; </li><li>  The number of steps per revolution is set in STEP_PER_REVOLUTION; </li><li>  Is it necessary to remove the voltage from the motor at idle and idle time in IsRelease and ReleaseTime, respectively. </li></ul><br><br>  This is probably all.  The application for Windows for remote control remained unlit - a software focus control panel.  Perhaps set out in the 4th part, but for now there are doubts about the feasibility. </div><p>Source: <a href="https://habr.com/ru/post/245653/">https://habr.com/ru/post/245653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245641/index.html">Comparing the speed of building linear models in R and Eviews</a></li>
<li><a href="../245643/index.html">SPA architecture for CRM systems: part 2</a></li>
<li><a href="../245645/index.html">ActivityManager report generator. Another bike, but in profile</a></li>
<li><a href="../245647/index.html">How was the Dell Solution Forum 2014 in Moscow</a></li>
<li><a href="../245651/index.html">Installation, configuration and testing of Fedora 21 Workstation on a personal or gaming computer</a></li>
<li><a href="../245657/index.html">IPv6: How many addresses do you need for happiness?</a></li>
<li><a href="../245659/index.html">Perl. 27 years later</a></li>
<li><a href="../245661/index.html">Transparent authentication in Redmine</a></li>
<li><a href="../245663/index.html">Transfer Windows to another computer using Linux</a></li>
<li><a href="../245665/index.html">One-page store with shopping cart at Phalcon + AngularJS + Zurb Foundation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>