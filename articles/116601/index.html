<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fix performance drop when copying / uploading files to Ubuntu</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don‚Äôt remember when the performance problems started when copying files, but then I didn‚Äôt attach much importance to it as I rarely copied files. Re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fix performance drop when copying / uploading files to Ubuntu</h1><div class="post__text post__text-html js-mediator-article">  I don‚Äôt remember when the performance problems started when copying files, but then I didn‚Äôt attach much importance to it as I rarely copied files.  Relatively recently, I had a high-speed connection to the Internet at my disposal, and now I often copy / download large files and the problem of performance loss has become very urgent for me. <br><br>  I didn‚Äôt get results from googlegle and I started digging deeper, it turned out that many of the ubuntuaters have high CPU load, but not everyone has a high search problem, so I decided to write a small how-to to eliminate high load on processor when copying files. <br><a name="habracut"></a><br><h4>  Problem </h4>  With high-speed torrent downloads, multithreaded copying from disk to disk, to flash drives, the processor load surpasses 100%, <a href="http://en.wikipedia.org/wiki/Load_(computing)">LA is</a> growing rapidly. <br><br>  At the same time, everything works well on file operations with a small number of threads. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  A bit of theory </h4>  There are such things in the operating system, called <a href="http://en.wikipedia.org/wiki/I/O_scheduling">IO schedulers</a> ( <a href="http://en.wikipedia.org/wiki/I/O_scheduling">IO schedulers</a> ), which are a layer between block devices and low-level drivers.  The task of the scheduler is to provide the process with optimal access to the requested disk device.  In the case of a hard disk, this means minimizing the movements of the read head. <br>  The activity of the planners is reduced to the following aspects: <br><ul><li>  Increase performance by reordering and merging queries </li><li>  Prevent freezes and chafing of read data by writing </li><li>  Honest allocation of access time to resources for different processes </li></ul>  There are many planners and, as it turned out, the problem solved by this post was connected with them. <br>  Consider briefly the most common. <br><br><h5>  <a href="http://en.wikipedia.org/wiki/Noop_scheduler">Noop</a> </h5>  The simplest scheduler that works on the principle of <a href="http://en.wikipedia.org/wiki/FIFO">FIFO</a> .  There is no reordering, only requests that are nearby in the queue can be merged.  Good for random access devices like Flash memory. <br><br><h5>  <a href="http://en.wikipedia.org/wiki/Deadline_scheduler">Deadline</a> </h5> A scheduler that puts a higher priority on read requests than on write requests.  Requests are reordered, but the request processing time must not exceed the specified limits (by default, 0.5 s for reading, 5 s for writing) <br><br>  4 queues are used for implementation: 2 <code>sorted-by-start-sector</code> queues (for reading and writing) and 2 FIFO queues (for reading and writing too).  Usually, requests are taken from sorted queues, but if the deadline (timeout) of the first request from the FIFO queue is pressed, the query processing continues on the sorted queues from this element. <br><br>  Best suited for organizing databases. <br><br><h5>  <a href="http://en.wikipedia.org/wiki/CFQ">CFQ</a> - Completely Fair Queuing </h5>  The goal of this scheduler is to honestly allocate access time to the resource for all requesters.  CFQ can be configured to equalize processes, groups of processes, users. <br><br>  By implementation, CFQ implies one FIFO queue per request initiator and switches between queues using the <a href="http://ru.wikipedia.org/wiki/Round-robin_(%25D0%25B0%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC)">Round-robin</a> algorithm. <br><br>  I do not know who needs such honesty, but there is no reordering of requests to minimize the movement of the hard disk read head in this scheduler. <br><br><h5>  <a href="http://en.wikipedia.org/wiki/Anticipatory_scheduling">Anticipatory</a> </h5>  The key idea is that before processing requests you can wait a bit, relax.  But in these few milliseconds, information will gather in advance, which will allow us to make more balanced decisions on the order in which the requests will be executed. <br><br>  Anticipatory scheduler is based on Deadline.  Suitable for desktops, because  The responsiveness of the I / O subsystem is maintained.  Not suitable for RAID, <a href="http://en.wikipedia.org/wiki/Tagged_Command_Queuing">TCQ</a> .  It is not suitable in situations where synchronous requests are sent by different processes. <br><br><h4>  Decision </h4>  The default scheduler in Ubuntu 10.10 is CFQ, but as practice shows, it is this scheduler that causes a high load on the CPU when multi-threaded copying.  We change the scheduler to another, for example, to Deadline and voila - there is no more CPU loading at 100%. <br><br>  For SSD drives and Flash memory in general, as noted above, it is recommended to use Noop. <br><br><h4>  Some practice </h4><br><h5>  Learn active scheduler </h5>  To view all available schedulers in the system and find out which of them is active, we execute: <br> <code>$ cat /sys/block/{DEVICE-NAME}/queue/scheduler</code> <br>  Here <code>{DEVICE-NAME}</code> is the name of the block device, for example, <code>sda</code> . <br>  For example, if the disk is <code>sda</code> , then you need to run: <br> <code>$ cat /sys/block/sda/queue/scheduler</code> <br>  At the output we get a line like this: <br> <code>noop anticipatory deadline [cfq]</code> <br>  In square brackets the current scheduler is indicated. <br><br><h5>  Change scheduler on the fly </h5>  To change the scheduler in real time without restarting execute: <br> <code>$ sudo -i <br> # echo {SCHEDULER-NAME} &gt; /sys/block/{DEVICE-NAME}/queue/scheduler</code> <br> <br>  Here <code>{SCHEDULER-NAME}</code> is one of the schedulers present in the system, I have this: <code>noop anticipatory deadline cfq</code> .  For example, to put the <code>deadline</code> scheduler, we execute <br> <code>$ sudo -i <br> # echo deadline &gt; /sys/block/sda/queue/scheduler</code> <br> <br><h5>  Fixing Scheduler Settings </h5>  Next, we need to force Ubuntu to use our chosen scheduler after rebooting.  To do this, add the line <code>GRUB_CMDLINE_LINUX_DEFAULT="elevator={SCHEDULER-NAME}"</code> to the GRUB 2 config. <br> <code>$ sudo nano /etc/default/grub</code> <br> <br>  <b>UPD:</b> After making the changes, you need to update the grub configuration: <br> <code>$ sudo update-grub</code> <br> <br>  If you have grub, not grub2, then add the line <code>elevator={SCHEDULER-NAME}</code> to / boot / grub / grub.conf. <br><br><h5>  Help in choosing a planner </h5>  On Habr√© already <a href="http://habrahabr.ru/blogs/linux/81504/">wrote</a> about the automated choice of the scheduler.  Of course, a simple check of the reading speed is not enough for an optimal choice, but it can give some idea. <br><br><h4>  useful links </h4>  Links used in writing the post: <br>  <a href="http://www.cs.ccu.edu.tw/~lhr89/linux-kernel/Linux%2520IO%2520Schedulers.pdf">Linux I / O Schedulers Presentation</a> <br>  <a href="http://www.wlug.org.nz/LinuxIoScheduler">Linux Io Scheduler - Waikato Linux Users Group</a> <br>  <a href="http://planet.admon.org/a-comparison-of-io-schedulers/">A comparison of I / O Schedulers</a> <br>  <a href="http://www.opennet.ru/base/sys/io_scheduler_linux.txt.html">Linux I / O schedulers (linux kernel io schedule optimization tune)</a> <br>  <a href="http://ru.wikibooks.org/wiki/Grub_2">Book about Grub 2</a> <br><br>  Having told friends about this tweak, I was surprised that no one knew about it, decided to post on Habr√©, suddenly someone would come in handy. <br><br><h4>  PS </h4><br>  <b>UPD:</b> <br>  This article told only about one, in fact the simplest way to solve a problem related, c so-called.  <a href="https://bugzilla.kernel.org/show_bug.cgi%3Fid%3D12309">bug 12309</a> .  There are more tips to solve this problem: <br>  - do not change the CFQ scheduler, but <a href="http://publib.boulder.ibm.com/infocenter/lnxinfo/v3r0m0/index.jsp%3Ftopic%3D/liaat/liaatbpcfq.htm">configure</a> <br>  - put the <a href="https://wiki.ubuntu.com/ZenKernel">zen core</a> <br>  - <a href="http://www.opennet.ru/base/sys/io_cfq_scheduler.txt.html">adjust swap aggressivity</a> <br>  - buy a hard disk with a hardware scheduler and a lot of RAM (so as not to leave Swap) <br><br> <font color="grey"><img src="https://habrastorage.org/storage/e87d9238/e34a0b5c/71441fbf/9d2981ff.png"></font>  <font color="grey">This text is distributed under the terms of the license <a href="">CC BY-SA</a></font> <font color="grey"><br></font>  <font color="grey">Original author (problem, solution) - <a href="https://habrahabr.ru/users/g3n1uss/" class="user_link">g3n1uss</a> .</font>  <font color="grey">Co-author (theory, design) - Your humble servant.</font> </div><p>Source: <a href="https://habr.com/ru/post/116601/">https://habr.com/ru/post/116601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116594/index.html">What kind of people are needed in UX teams. Great hunt!</a></li>
<li><a href="../116595/index.html">Basics of Clojure Web Applications</a></li>
<li><a href="../116596/index.html">BugDNS - April Fools Internet</a></li>
<li><a href="../116599/index.html">Author Chrome Adblock released for beta testing gadget glasses that block the usual advertising on the streets</a></li>
<li><a href="../116600/index.html">Bromine Behavior Innovations</a></li>
<li><a href="../116602/index.html">Simple OCR for .NET</a></li>
<li><a href="../116603/index.html">Fingerprint recognition methods and implementation by means of Python</a></li>
<li><a href="../116604/index.html">Streaming video a hundred years ago</a></li>
<li><a href="../116605/index.html">Correction of the spirit of Internet traffic</a></li>
<li><a href="../116606/index.html">Attention, filmophiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>