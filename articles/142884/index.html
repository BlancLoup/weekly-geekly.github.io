<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Technical preparation of one game created by independent developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, severe, but fair habr! 

 I want together with you to dissect one game, which I wrote together with my good friend. In terms of mechanics, a ga...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Technical preparation of one game created by independent developers</h1><div class="post__text post__text-html js-mediator-article">  Hello, severe, but fair habr! <br><br>  I want together with you to dissect one game, which I wrote together with my good friend.  In terms of mechanics, a game is a real-time battle between two players, each with a deck of cards.  And the cards, in turn, generate fighters who already independently rod on the enemy's bunker, incidentally crumbling to the mince of enemy soldiers.  In addition to the battle in the game there is a shop with cards;  headquarters where you can build a deck and swing characters;  an arena where you can run a quest or a real battle;  Well, the bank where you can get game currency.  Let me remind you, we are independent developers, therefore we are limited in resources and many solutions are not perfect. <br>  How to start inventing the game here: <a href="http://habrahabr.ru/post/142490/">habrahabr.ru/post/142490</a> <br><br>  Let's start the preparation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h5>  Social platform </h5><br>  Following the principle of KISS, we decided to immediately make a game for social networks because there is already a ready authorization mechanism and wide distribution possibilities.  In general, the easiest way to be heard in them.  We chose Vkontakte because of a younger audience and more experience with this network specifically with us. <br>  All interaction with the social network was carried out in a separate module with a singleton, in order to change social networks like gloves.  To do this, we have a single interface that each specific class must implement for each social network.  The game interacts with the social network through a singleton with this interface. <br><br><h5>  Flash platform </h5><br>  Choosing Vkontakte, we have two technologies left to choose from: flash and iframe (html + javascript).  To be honest, I do not digest games on html, besides, I have been a flash developer for many years.  Therefore, there was not even a discussion here: we immediately selected flash. <br><br><h5>  Flex </h5><br>  Inside the flash-technology there was a choice: whether to write on pure actionscript or to use the flex-framework.  Pure actionscript gives faster code, and flex has the advantage of quick and flexible development for interfaces.  For example, adding a window with statistics in the flex architecture is faster, simpler and more reliable than on pure actionscript.  We chose the Solomonic solution: all the interfaces and the environment of the game were made on flex, and the battle itself (the main action in the game) on pure actionscript. <br>  In the direction of 3d engines did not look, they decided not to complicate, but very interesting, of course. <br><br>  <i>The following information for flash players.</i>  <i>(It‚Äôs flushists, for the flasher in the jargon is a dude who walks naked in a raincoat in the parks ... and then you know).</i>  <i>If you are not a flash player, you can proceed to the next section.</i> <br><br>  When building interfaces on flex, we immediately made skinned components.  To do this, each component must be inherited from SkinnableComponent. <br><pre><code class="actionscript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *  . * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SkinnableComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/**    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _model:CardModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CardModel(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value:CardModel)</span></span></span><span class="hljs-function">:void </span></span>{ _model = value; modelChanged = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.invalidateProperties(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:CardModel </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _model; } <span class="hljs-comment"><span class="hljs-comment">/** ,     .   .   commitProperties */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modelChanged:Boolean = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; [SkinPart(required=<span class="hljs-string"><span class="hljs-string">"true"</span></span>)] <span class="hljs-comment"><span class="hljs-comment">/**  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nameLabel:Label; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Card</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-comment"><span class="hljs-comment">/** * @private */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partName:String, instance:Object)</span></span></span><span class="hljs-function">:void </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.partAdded(partName, instance); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == nameLabel) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(model) nameLabel.text = model.name; } } <span class="hljs-comment"><span class="hljs-comment">/** * @private */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commitProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:void </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.commitProperties(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.modelChanged) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(model) nameLabel.text = model.name; } }</code> </pre> <br><br>  Here you should pay attention to the following pieces of code: <br><pre> <code class="actionscript hljs">[SkinPart(required=<span class="hljs-string"><span class="hljs-string">"true"</span></span>)] <span class="hljs-comment"><span class="hljs-comment">/**  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nameLabel:Label;</code> </pre><br>  This is an interface element that will be in a specific skin.  This fact is marked by the SkinPart meta tag.  The required meta tag parameter indicates whether this particular component should be implemented in a skin or can be omitted. <br><br>  This method must be redefined to initialize the elements of our skin.  How to do it, I think, is clear from the code. <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(partName:String, instance:Object)</span></span></span><span class="hljs-function">:void</span></span></code> </pre><br><br>  It also makes sense to override this method: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commitProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:void</span></span></code> </pre><br><br>  When changing data, it is best to assign new data values ‚Äã‚Äãto the components in this method.  This will affect the performance of these components for the better.  The fact is that this method is called only when the screen is redrawn, thus postponing the resource-intensive change of the component until it is really needed. <br><br>  We store data separately from components, in models: <br><pre> <code class="actionscript hljs"> <span class="hljs-comment"><span class="hljs-comment">/**    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _model:CardModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CardModel(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value:CardModel)</span></span></span><span class="hljs-function">:void </span></span>{ _model = value; modelChanged = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.invalidateProperties(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:CardModel </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _model; }</code> </pre><br><br>  Notice, when data changes, we just save them, mark the data model with the changed one and call the invalidateProperties () method.  This method tells flex that the data has changed and you need to call commitProperties ().  You cannot call commitProperties () by yourself, it will be called, as I said, when you redraw the screen. <br><br>  Our data model is simply a structure with fields describing the model. <br><pre> <code class="actionscript hljs"> <span class="hljs-comment"><span class="hljs-comment">/** *    . * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CardModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/**  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name:String = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre><br><br>  Skin might look like this: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s:Skin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:fx</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ns.adobe.com/mxml/2009"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:s</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"library://ns.adobe.com/flex/spark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:mx</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"library://ns.adobe.com/flex/mx"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:components</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"view.components.*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- host component --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fx:Metadata</span></span></span><span class="hljs-tag">&gt;</span></span> [HostComponent("view.components.Card")] <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fx:Metadata</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s:Label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nameLabel"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s:Skin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Here it is worth paying attention to the Metadata block.  Here you can see the ‚Äúnative‚Äù component for the skin. <br><br>  Using the scheme with the separation of the component on its mechanics and skin, we refuse to bind (Binding), which is considered bad practice.  And we can now have several presentation options for one component, change them on the fly, and painlessly easily redo them, up to a complete change of design. <br><br><h5>  Flash XML Graphics </h5><br>  Another technology we used is FXG or Flash XML Graphics.  This is a vector format for graphics that is developed by Adobe, based on XML.  It is convenient in mxml.  Having a picture in this format, it is added to the mxml code with one single tag.  Well, using vector graphics, the size of the application we got 3 MB.  True brakes, crud.  In order not to slow down, they hung all the value of cashAsBitmap equal to true. <br><br><h5>  Architecture </h5><br>  When building the architecture, we aimed to quickly create clones of the game in the future.  Therefore, we divided the game into the following levels: <br><ul><li>  Core </li><li>  Logics </li><li>  Data models </li><li>  Representation </li><li>  Skins </li></ul><br>  The kernel takes over the communication with the server.  Logic stores game mechanics - the basis for clones.  Models describe the data and nothing else.  Representation is the level of interfaces and interface mechanics.  And skins - this is what you see. <br>  The mvc architecture is viewed here, but we didn‚Äôt use ready-made frameworks (pureMVC, mate) that implement this architecture to simplify development.  We decided only to adhere ideologically to the principle of separation of logic and representation. <br><br><h5>  Mathematical model of combat </h5><br>  Here the question of synchronization of the game world with two clients is interesting.  After all, our game units do not walk in cages.  They have real coordinates on the plane, different sizes, collide with each other and bypass the obstacles that arise. <br>  For synchronization, we use the exact simulation of the events of the game world, which is achieved by two points: <br><ol><li>  Any condition mat.  models are described by integer data </li><li>  The time is cut for fixed intervals of 20 ms, and the recalculation of the mat.  Models are only possible for +20 ms.  If you need more - mat.  The model is recalculated several times.  If less, it is not recalculated at all. </li></ol><br>  Mat.  the model works for us separately in its own way; it has nothing to do with the representation of the battle on the screen.  Thus, we can absolutely calmly make another presentation on other technologies, and when it is ready, give the client a choice.  For example, we plan to make sprite graphics through stage3d in the future. <br><br><h5>  Server </h5><br>  We decided to do the server part in PHP.  In fact, the next choice was to implement client-server protocol on sockets or HTTP.  And having made a choice in favor of speed of development and guarantee of stable work for the client, you chose the latter.  Namely PHP - because  We have a great deal of experience in this area. <br><br>  The transfer of messages from the server to the clients, and from the client to another client, occurs through the mechanism of periodic polling of the server.  As the online gaming grows, this places a heavy load on the server, so we allocated all the polling mechanisms to separate servers.  In total, we have 3 types of servers: <br><ol><li>  Main server.  He is so alone with us.  It stores the data of all the players, processes the changes of this data (for example, when buying something in the game in the store), and distributes the players who entered the game across the Lobby- and Battle-servers. </li><li>  Lobby server.  Each player who enters the game is immediately assigned the least loaded of available Lobby-servers.  However, each client receives a complete list of all Lobby servers, and sends their Lobby server number to all of them.  Thus, if some other client wants to send us (the client) a message, let‚Äôs have an invitation to join the battle, he will know from his Lobby server which server we are on and then send the message specifically to our Lobby- server.  We, in turn, simply polling our Lobby server every 5 seconds, find out about the incoming message.  Similarly, the Main Server can send the required message to any player. </li><li>  Battle server.  When there are two players on the Main Server who wish to fight each other, they are assigned the least loaded Battle Server available.  After that, through the mechanism of Lobby-servers, they are sent invitations to join the battle, indicating the specific Battle-server, the keys to the already created battle, and everything else.  On this Battle server, players are already quietly exchanging information with a polling frequency of 2 seconds, and do not interfere with the work of the rest of the server system at all. </li></ol><br><br>  The servers also communicate with each other via the http protocol.  But there is one subtlety - in many cases sending an http request without waiting for a response is used.  For example, when creating a battle: we create a unique guid-key, send a command to the selected Battle-server to create a battle with this key, without waiting for an answer, send Lobby-servers of players an invitation to battle to the selected Battle-server with the same key, and again without waiting for an answer , we finish processing the request. <br><br>  Thanks to such a system, we are able to dynamically change the performance of the server platform (with the exception of the Main server).  We simply commission additional servers if necessary.  And thus, we are hosted on cheap VPS servers, and we do not need to pay in advance for an expensive and powerful server.  In addition, a hoster for an additional charge can increase the performance of a VPS without even turning it off. <br><br>  To the account of the Main server: we hope that we removed the most part of the load from it, having entered the system from the Battle and Lobby servers, and in the beginning only the most powerful VPS will suffice for it, then it will be transferred to the real server hardware.  Well, the campaign of collecting statistics, we understand whether there is a need for further optimization of the server part of the game. <br><br><h5>  MMO technology </h5><br>  In our game there is the possibility of playing over the network either with a friend or with a random opponent. <br>  Fight with a friend is created through the mechanism of invitations to fight.  I can throw an invite to my friend, he, in turn, can either accept or reject it. <br><br>  It‚Äôs interesting here that this time we decided to abandon the tables of the invites themselves, the lists of the missed invites and other Labuda.  Already ate with this in the past project.  The fact is that it seems that it is simple, but in practice there is a huge number of unforeseen situations.  And if the player is offline?  And if he is sort of like online, but he just had the Internet cut and nobody knows about it yet?  And if he deleted the application at all, but remained in the database?  And if he pressed to take an invite, but I managed to cancel and already threw another player?  And if I threw an invite and updated the page?  Well, etc.  There is quite a lot of confusion. <br><br>  Therefore, we made everything easier: we have only two fields in the table of players: state and opponentId.  state determines whether a player is free, whether he threw an invite, whether he sees a message about an incoming invite, or whether he is in a battle.  opponentId - I suppose, I understand why.  Throw an invite can only free players.  And even after a sudden reload of the browser page, the client quickly restores all the dialogs concerning invitations to battle. <br><br>  Fight with a random opponent is realized through the selection of the enemy by rating.  The player sends a request.  The application is in the database for 15 seconds, after which it is processed.  Processing is a script that fires every 10 seconds.  This script selects pairs of applications with the nearest ratings.  But not exactly the closest - is used randomly in a certain range.  And the range is gradually expanding.  First of all, applications with the lowest rating are processed in order to ensure the best processing of newly arrived customers.  Because  applications diverge very quickly, this script does not require optimization.  Therefore, I will not write about the algorithms here - everything is simple and linear. <br>  A delay of 15 seconds is needed because  without it, every second application will start the fight with the first one, and no ratings will be taken into account. <br><br><h5>  In custody </h5><br>  Forgive, Habr, sinful head for the lack of pictures, graphs and tables, but all the guts of our game in front of you.  Advise you if you can.  Yes, I forgot to say.  The next article I will write about monetization, how much that cost and show the first results. </div><p>Source: <a href="https://habr.com/ru/post/142884/">https://habr.com/ru/post/142884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142877/index.html">Photo report from Mobile First! Conference</a></li>
<li><a href="../142878/index.html">CloudConf 2012: May will tighten "clouds"</a></li>
<li><a href="../142880/index.html">Samsung revealed the secret SGS3 processor</a></li>
<li><a href="../142881/index.html">My little CakePHP web service</a></li>
<li><a href="../142883/index.html">Unpleasant features of the browser from Yandex (browser "Internet")</a></li>
<li><a href="../142886/index.html">American musician set to music Tau math constant</a></li>
<li><a href="../142887/index.html">TUTS + also launched their hub</a></li>
<li><a href="../142888/index.html">The insides of jQuery. Search for event code</a></li>
<li><a href="../142890/index.html">Prototype data model</a></li>
<li><a href="../142892/index.html">Live Broadcast ALM Summit 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>