<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generate one-time passwords using a smartphone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue: this article was prepared during the last week and was sent as an article for the sandbox on Sunday night. Today I received an invite, but I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generate one-time passwords using a smartphone</h1><div class="post__text post__text-html js-mediator-article">  <b>Prologue:</b> this article was prepared during the last week and was sent as an article for the sandbox on Sunday night.  Today I received an invite, but I also found an article with a similar theme - <a href="http://habrahabr.ru/company/symantec/blog/122855/">On the issue of two-factor authentication using mobile devices</a> , so I completely agree with the author of this article - ‚Äúthat there have been too many recent coincidences‚Äù.  I decided to publish the article as it was originally conceived, adding only links to the sources. <br><br>  After recent publications on Habrahabr devoted to security, passwords, brute force passwords, etc.  I came up with the idea of ‚Äã‚Äãauthorization using one-time passwords generated by a special application on users' smartphones.  The idea is very similar to the idea used in SecureID devices (and which were also recently covered in Habrahabr).  Modern smartphones are available to more and more people and their capabilities are enough to implement such a scheme.  In this article, I want to describe the idea of ‚Äã‚Äãinteraction between the smartphone + web site and some implementation features and show a working prototype. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea is simple - when registering on the site, the user can optionally be given the opportunity to use a special application installed on the smartphone for authorization to generate one-time passwords.  To do this, on the server side each user is generated a unique secret key, which must be transferred to the smartphone.  Further, on the basis of this key, the application on the side of the smartphone will generate one-time passwords.  The lifetime of each password is limited.  Because  All modern smartphones are equipped with cameras, the easiest way to transfer a secret key, in my opinion, is to read and recognize a QR code that contains a secret key using a smartphone‚Äôs camera.  You can of course enter the key manually, send it via SMS, download the key file using the link generated by the server, but such solutions are not always convenient.  This method does not claim to be the main method of authorization on sites, but can be used as an optional authorization tool. <br><br>  The sequence of user actions during registration on the site is as follows: <br><ul><li>  when registering on the site (or after registration), the user can select an additional authentication option using one-time passwords. </li><li>  if this option is selected, the server generates a secret key, stores it in the database and associates it with the user. </li><li>  After creating the secret key, the user generates an image with a QR code that contains the secret key. </li><li>  the user reads the value of the secret key using the camera of the smartphone. </li><li>  The application on the smartphone saves the secret key, associates it with the site and uses it to generate one-time passwords. </li></ul><br><br>  <a href="http://ru.wikipedia.org/wiki/QR-%25D0%25BA%25D0%25BE%25D0%25B4">QR codes</a> were chosen because of a fairly widespread occurrence, using QR codes you can also transfer quite large amounts of data (hundreds and thousands of characters), but nothing prevents you from using any other methods of data coding. <br>  The <a href="http://en.wikipedia.org/wiki/HOTP">HOTP</a> algorithm was taken as the basis for generating one-time passwords.  The algorithm is an open standard and is freely available.  There is also a corresponding <a href="http://tools.ietf.org/html/rfc4226">RFC 4226</a> for it. <br><br>  To implement and test the idea, a bunch of Google App Engine + Android-based smartphone was chosen.  The demo version of the site is located at <a href="http://grey-box.appspot.com/">http://grey-box.appspot.com/</a> there is also a link to a small demo application for a smartphone based on Android, Android OS versions 1.6 and higher are supported.  Both applications are quite simple, so I will not describe them in detail, I will focus only on the most interesting points. <br><br>  The basis of both applications is the calculation of one-time passwords.  Every time a user wants to log in to the site, he generates a one-time password on the smartphone using a special application.  Passwords are time bound and have a limited duration.  When a user enters a created password, the server performs the same actions ‚Äî it generates a password on its side.  If the passwords match, then the authorization is successful.  To generate the same passwords, the server and the smartphone must create passwords based on the same initial data.  This initial data is the user's secret key and current time.  When the server generates a secret key, it also saves at what point in time the key was generated (as a unix timestamp).  The secret key and the key generation time are encoded into a QR code and transmitted to the smartphone.  The application on the smartphone reads the secret key and the key generation time and calculates the difference between the time on the server side and the side of the smartphone.  In the future, this difference is used to synchronize the time. <br><br>  On the server side, 3 basic actions should be performed: <br><ul><li>  private key generation </li><li>  QR code generation </li><li>  generation and verification of a one-time password </li></ul><br>  Below are the relevant parts of the Python code. <br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   . import time import hmac from hashlib import sha1 ... OTP_TTL = 300 #    ,   #   username = request.get(‚Äúusername‚Äù) timestamp = int(time.time()) / OTP_TTL #    secret_key = hmac.new(str(timestamp) + username, digestmod=sha1).hexdigest().upper() #       ..</span></span></code> </pre> <br><br>  To generate a picture with a QR code, the simplest option is to use any service to generate various bar codes.  There are quite a few such services; in this system, a service was provided by Google - <a href="https://chart.googleapis.com/">Google Charts Tools</a> .  This service allows you to generate various graphs, charts and various bar codes as well.  This method was used solely for reasons of ease of implementation; for real systems, it is better to generate bar codes on the server side. <br><br><pre> <code class="python hljs">QR_TPL = <span class="hljs-string"><span class="hljs-string">"https://chart.googleapis.com/chart?chs=100x100&amp;cht=qr&amp;chl=%s&amp;choe=UTF-8"</span></span> qr_url = QR_TPL % (<span class="hljs-string"><span class="hljs-string">'%s:%s'</span></span> % (secret_key, timestamp)) <span class="hljs-comment"><span class="hljs-comment">#      HTML   . ...</span></span></code> </pre><br><br>  Generate a one-time password. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hmac <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> hashlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sha1 ‚Ä¶ OTP_TTL = <span class="hljs-number"><span class="hljs-number">300</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,   TRUNCATE_MASK = 0x7FFFFFFF #       MOD = 1000000 #         #   username = request.get("username") password = request.get("password") #       st = storage.gql("where user = :1", username).get() secret_key =st.secret_key #  timestamp timestamp = int(time.time()) / OTP_TTL #    ... one_time_password = str((int(hmac.new(secret_key, str(timestamp), sha1).hexdigest(), 16) &amp; TRUNCATE_MASK) % MOD) # ...         if password == one_time_password: #   else: # </span></span></code> </pre><br><br>  On the side of the smartphone, there are 2 main actions: <br><ul><li>  reading and recognition of a QR code with the subsequent saving of data </li><li>  one-time password generation </li></ul><br>  For reading and recognizing barcodes, there are several libraries, perhaps the most widely used and popular is the open source <a href="http://code.google.com/p/zxing/">Zxing</a> library.  This library supports a number of platforms, including Google Android and Apple iOS.  Based on this library, the open- <b>source Barcode Scanner</b> application is also implemented, this application is also quite common and is often pre-installed on many modern Android-based smartphones.  It was originally intended to integrate this library into the application, but after a long search in the Internet and documentation, it came to the realization that this is not the fastest and easiest way.  It was decided to use the intent call mechanism which is provided by the Android platform.  With this approach, it is much easier to integrate the necessary functionality into the application, although users will have to additionally install <b>Barcode Scanner</b> if necessary.  This is a drawback of this approach, but there are also pluses - you don‚Äôt have to accompany and support all possible smartphone models, current and future ones - the <b>Zxing</b> development team is engaged in this.  You can also implement support for other barcode recognition applications and not be limited to <b>Barcode Scanner</b> . <br><br>  The following is a small snippet of Java code that is used to invoke and process a response from the <b>Barcode Scanner</b> application. <br><pre> <code class="java hljs">... <span class="hljs-comment"><span class="hljs-comment">//  Barcode Scanner Intent,      Intent intent = new Intent("com.google.zxing.client.android.SCAN"); intent.putExtra("SCAN_MODE", "QR_CODE_MODE"); startActivityForResult(intent, 0); ... //           Barcode Scanner public void onActivityResult(int requestCode, int resultCode, Intent intent) { if (requestCode == 0) { if (resultCode == RESULT_OK) { //      String contents = intent.getStringExtra("SCAN_RESULT"); // ‚Ä¶      ‚Ä¶ } } } ...</span></span></code> </pre><br><br>  Generate a one-time password. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   import java.math.BigInteger; import java.security.InvalidKeyException; import java.security.NoSuchAlgorithmException; import javax.crypto.Mac; import javax.crypto.spec.SecretKeySpec; ... // ,       long OTP_TTL = 300; long TRUNCATE_MASK = 0x7FFFFFFF; long MOD = 1000000; ... //     String secret_key = key_storage.getString("secret_key", ""); //     long time_delta = key_storage.getLong("time_delta", 0); long local_time = (System.currentTimeMillis()/1000) / TIME_MASK; long server_time = local_time + time_delta; try { SecretKeySpec keySpec = new SecretKeySpec(secret_key.getBytes(), "HmacSHA1"); Mac mac = Mac.getInstance("HmacSHA1"); mac.init(keySpec); byte[] result = mac.doFinal(Long.toString(server_time).getBytes()); password = Long.toString((new BigInteger(1, result).intValue() &amp; TRUNCATE_MASK) % MOD); } catch (NoSuchAlgorithmException e) { ... } catch (InvalidKeyException e) { ... } //     ...</span></span></code> </pre><br><br>  A simple prototype of the site and a demo application for smartphones is available at <a href="http://grey-box.appspot.com/">http://grey-box.appspot.com/</a> .  The Android application is called <b>Auth ID</b> and does not require any special permissions or access rights to work.  The only requirement is the availability of the <b>Barcode Scanner</b> application, which is used to scan QR codes.  At the moment, the functionality of the <b>Auth ID</b> application is minimal, the application can only store the key for one user and only for the demo site.  If you register under a different user, the secret key will be overwritten by the existing one.  In the future, you can add key saving for various sites and users, all this of course, provided that this authorization scheme will be distributed.  I will be glad to any comments and suggestions. <br><br>  References: <br>  <a href="http://ru.wikipedia.org/wiki/QR-%25D0%25BA%25D0%25BE%25D0%25B4">http://ru.wikipedia.org/wiki/QR-%D0%BA%D0%BE%D0%B4</a> - what are QR codes <br>  <a href="http://en.wikipedia.org/wiki/HOTP">http://en.wikipedia.org/wiki/HOTP</a> - description of the HOTP algorithm <br>  <a href="http://tools.ietf.org/html/rfc4226">http://tools.ietf.org/html/rfc4226</a> - RFC 4226 for the HOTP algorithm <br>  <a href="https://chart.googleapis.com/">https://chart.googleapis.com</a> - Google Chart Tools <br>  <a href="http://code.google.com/p/zxing/">http://code.google.com/p/zxing/</a> - Zxing library for scanning and recognizing various barcodes. <br>  <a href="http://grey-box.appspot.com/">http://grey-box.appspot.com/</a> - demo site and applications illustrating the idea. <br><br>  PS Source codes are available after test registration and login.  The test code was created solely to test the performance of the idea; it is not recommended for actual use. </div><p>Source: <a href="https://habr.com/ru/post/122927/">https://habr.com/ru/post/122927/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122919/index.html">Functional programming in Java</a></li>
<li><a href="../122920/index.html">Nesting icons with pseudo-elements and css clip properties</a></li>
<li><a href="../122923/index.html">Object Representation</a></li>
<li><a href="../122925/index.html">Will United Russia ban outsourcing?</a></li>
<li><a href="../122926/index.html">Oracle. Start</a></li>
<li><a href="../122928/index.html">Microsoft patent for listening to VoIP telephony</a></li>
<li><a href="../122929/index.html">Using procedures and functions in Delphi</a></li>
<li><a href="../122930/index.html">It is important for us to know which topics are most relevant, and what you wanted to know, but were afraid to ask:</a></li>
<li><a href="../122931/index.html">Create For Millions - competition for developers and users of mobile applications</a></li>
<li><a href="../122933/index.html">Developing games with Intel: GPA and the first July webinar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>