<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bored mail or how to send messages from the site to Telegram via Node.js (Express)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After several emails sent from the site to my email, I realized that it was rather inconvenient, not modern (perhaps), at least not cool. I set out to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bored mail or how to send messages from the site to Telegram via Node.js (Express)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/02/fq/j_/02fqj_d_wkez5gtea5wyzkz2mns.jpeg" alt="logicSchema"></div><br>  After several emails sent from the site to my email, I realized that it was rather inconvenient, not modern (perhaps), at least not cool.  I set out to abandon the use of smtp for the form in favor of api Telegram. <br><br>  Since my application runs on a node, I thought why not pump the form.  The general logic is painfully simple.  When the form is sent, a request is made to the api application, where the bot token is stored, data is processed, and then a request is made to the api telegram, which sends a message to the chat. <br><br>  But let's get everything in order. <br><a name="habracut"></a><br>  To begin with, of course, you need to create a bot that will receive data from the form and send it to you.  In fact, it is only an <i>intermediary</i> between you and the api telegram. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we knock on the parent of all bots, namely to <b>@BotFather</b> and ask him to create one for us (enter <b>/ newbot</b> ).  Enter the name, nickname and <u>get the</u> bot <u>token</u> .  Just we need it.  Note that the bot nickname must be &lt; <i>your</i> &gt; _bot or &lt; <i>Your</i> &gt; Bot. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gc/5s/le/gc5sle03hvcp1avtiteq29lgue8.jpeg" alt="@BotFather"></div><br>  They created it, well, but you have to revive it.  We look for it in search by nickname and write <b>/ start</b> .  Everything, now we can address it through api. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/go/sm/df/gosmdfld5kkkx1tek1w6qexetnw.png" alt="@BotFather"></div><br>  Next, you need to create a group where the bot will throw messages, do not forget to <u>add</u> it to the chat. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pk/-m/ds/pk-mdsbzbu3ewk3hvuiekms0m6i.png" alt="createChat"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xa/xw/vy/xaxwvygismdkeegtueomf40wx9e.png" alt="addMembers"></div><br><br>  We <i>enter</i> <b>/ join</b> @ <i>nick_bota</i> in the created chat, because it happens that a record about the bot's invitation to the group is not added to the logs. <br><br>  Go to the browser and enter in the address bar: <br><br><pre><code class="hljs objectivec">https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/botXXXXXXXXXXXXXXXXXXXXXXX/getUpdates</span></span></code> </pre> <br>  where <b>XXXXXXXXXXXXXXXXXXXXXXXX</b> is a bot token that kindly gave you <b>@BotFather</b> . <br><br>  If everything went well, we will get something like a sheet of letters, where you need to find the <b>‚Äúchat‚Äù</b> object <b>: {‚Äúid: XXXXXXXXXX ...}</b> .  Usually the group chat id starts with a minus. <br><br><img src="https://habrastorage.org/webt/-l/vk/fu/-lvkfusywekhwmbrhsfmlx6et1s.png" alt="getUpdates"><br><br>  Ok, we got a <u>bot token</u> and <u>chat id</u> where messages will come. <br>  Now let's get down to the application. <br><br><h2>  Front </h2><br>  Let's start first from the front. <br><br>  I used Node to work with the <b>Express</b> wrapper, which in turn can render files of various template engines.  Decided to use <a href="https://github.com/pugjs/pug">Pug</a> .  It is quite simple to learn, so if you come across it for the first time, it‚Äôs hard to get to know it.  For example, did not use collectors, so the scripts are connected in the old manner. <br>  <u>The structure of the application is generated using the <a href="http://expressjs.com/en/starter/generator.html"><b>Express Generator</b></a> .</u> <br><br><h4>  Markup form </h4><br>  <i>views / layout.pug:</i> <br><br><pre> <code class="markdown hljs">doctype html html head title= title link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css") link(rel='stylesheet', href='/stylesheets/style.css') body block content</code> </pre><br>  <i>views / index.pug:</i> <br><br><pre> <code class="markdown hljs">extends layout block content .wrapper .wrapper<span class="hljs-strong"><span class="hljs-strong">__bg img.wrapper__</span></span>bg-img(src='/images/bg.jpg' alt='bg') form(action="/telegram", method="post" class="form" id='telegramForm' enctype="application/x-www-form-urlencoded") .form<span class="hljs-strong"><span class="hljs-strong">__container .form__</span></span>blur .form<span class="hljs-strong"><span class="hljs-strong">__title .form__</span></span>title-line h3.form<span class="hljs-strong"><span class="hljs-strong">__title-text    .form__</span></span>title-line .form<span class="hljs-strong"><span class="hljs-strong">__inputs input(type="text" name='name' placeholder="" class="form__</span></span>input" required) input(type="email" name='email' placeholder="Email" class="form<span class="hljs-strong"><span class="hljs-strong">__input" required) textarea(name="text" placeholder=" " class="form__</span></span>input form<span class="hljs-strong"><span class="hljs-strong">__message" required) .form__</span></span>buttons input(type="submit" class="form<span class="hljs-strong"><span class="hljs-strong">__submit" value="") .form__</span></span>clean  script(src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js") script(src="/javascripts/app.js")</code> </pre><br>  Do not forget that <u>in Pug the nesting of elements is defined by indents</u> , as in python, so consider this. <br><br>  We add styles and this is how I got it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hr/d6/jd/hrd6jdwhyo3nvj3t3ycrpavozzo.png" alt="form"></div><br>  The message will be sent without reloading the page, so we hang the handler on the form, collect the data, convert it to json and send it asynchronously to ourselves in api + display the message about the status of the request. <br><br>  <i>public / javascripts / app.js:</i> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> formId = <span class="hljs-string"><span class="hljs-string">'telegramForm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> form = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(formId) <span class="hljs-comment"><span class="hljs-comment">//         JSON- function toJSONString(form) { var obj = {} var elements = form.querySelectorAll('input, select, textarea') for (var i = 0; i &lt; elements.length; ++i) { var element = elements[i] var name = element.name var value = element.value if (name) { obj[ name ] = value } } return JSON.stringify(obj) } if (form) { form.addEventListener('submit', event =&gt; { event.preventDefault() //    const json = toJSONString(form) //  const formReq = new XMLHttpRequest() formReq.open('POST', '/telegram', true) /////////////////////////////////// /////////////SweetAlert////////// /////////////////////////////////// //   formReq.onload = function(oEvent) { if (formReq.status === 200) { swal({ title: ' !', icon: 'success', timer: 2000 }) document.querySelector('.sa-success').style.display = 'block' document.querySelector('.sa-button-container').style.opacity = '0' } if (formReq.status !== 200) { swal({ title: ' !', icon: 'error', timer: 2000 }) document.querySelector('.sa-error').style.display = 'block' document.querySelector('.sa-button-container').style.opacity = '0' } } //////////////////////////// //////////////////////////// formReq.setRequestHeader('Content-Type', 'application/json') // formReq.send(json) }) }</span></span></code> </pre><br><h2>  Back </h2><br>  On the server side, first you need <u>to catch the request from the client</u> , for this we write in the router: <br><br>  <i>routes / index.js:</i> <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//        const ctrlTelegram = require('../api/telegramMsg'); router.post('/telegram', ctrlTelegram.sendMsg);</span></span></code> </pre><br>  <i>api / telegramMsg.js:</i> <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.sendMsg = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  id    config.json const config = require('../config/config.json'); let http = require('request') let reqBody = req.body //      let fields = [ '&lt;b&gt;Name&lt;/b&gt;: ' + reqBody.name, '&lt;b&gt;Email&lt;/b&gt;: ' + reqBody.email, reqBody.text ] let msg = '' //         fields.forEach(field =&gt; { msg += field + '\n' }); //   ,    msg = encodeURI(msg) //  http.post(`https://api.telegram.org/bot${config.telegram.token}/sendMessage?chat_id=${config.telegram.chat}&amp;parse_mode=html&amp;text=${msg}`, function (error, response, body) { //    console.log('error:', error); console.log('statusCode:', response &amp;&amp; response.statusCode); console.log('body:', body); if(response.statusCode===200){ res.status(200).json({status: 'ok', message: ' !'}); } if(response.statusCode!==200){ res.status(400).json({status: 'error', message: ' !'}); } }); }</span></span></code> </pre><br>  To simplify the request process, the ' <i><a href="https://www.npmjs.com/package/request">request</a></i> ' package is installed. <br><br><pre> <code class="bash hljs">npm i request</code> </pre> <br>  <i>Ôøºconfig / config.json:</i> <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"telegram"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"token"</span></span>: <span class="hljs-string"><span class="hljs-string">"bot_token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"chat"</span></span>: <span class="hljs-string"><span class="hljs-string">"chat_id"</span></span> } }</code> </pre><br><h4>  So what happens here? </h4><br>  In the request, we passed json, so on the server side we can work with data as with a regular object. <br><br>  For convenience, we push each value of the object into an array. <br>  <a href="https://core.telegram.org/bots/api">The API telegram</a> allows you to transfer data via text in the address bar, so we go through the array and create a long string.  In order to transfer HTML tags, <u>it is necessary to encode a string into a universal identifier</u> ( <b>encodeURI ()</b> method) in order to avoid an error. <br><br>  Now you can finally send it all to the server telegram.  We make a <i>request</i> (press the 'Send' button) and voila, the message has been sent.  <b>Do not forget to process the answer</b> , but then you <b>never</b> know what. <br><br>  After all the manipulations, the answer comes to the front and notifies if all the rules have passed or not. <br>  Due to the fact that for example I did not use the collector, and the library of the pop-up was designed for a modular assembly, I had to do a bit when calling it on the front. <br><br><div style="text-align:center;"><img src="https://media.giphy.com/media/xThta3HxApJjJe56zm/giphy.gif" alt="formSent"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/df/_x/c_/df_xc_unfyht5vi2vx3lbw4xczu.png" alt="message"></div><br>  If you look at the application logs on the server, you can see something like the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v_/bm/lq/v_bmlqx2gcsjxit7exce-orvlnq.png" alt="image"></div><br>  Congratulations!  Now you know how to send messages from your site to Telegram. <br><br>  <b>I described only the general concept of this process, so I strongly recommend that you familiarize yourself with the <a href="https://github.com/RomaTur/telegramMsg"><u>source code of</u></a> this <a href="http://romatur.xyz:3003/"><u>example</u></a> .</b> </div><p>Source: <a href="https://habr.com/ru/post/348332/">https://habr.com/ru/post/348332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348320/index.html">As I prepared a visual novel</a></li>
<li><a href="../348324/index.html">In defense of swap [in Linux]: common misconceptions</a></li>
<li><a href="../348326/index.html">Big Migration: How we raised a private cloud at RISC</a></li>
<li><a href="../348328/index.html">Creating a bonus system in Unity</a></li>
<li><a href="../348330/index.html">AI @ MIPT: ‚ÄúNeuromorphic computations and brain mechanisms‚Äù</a></li>
<li><a href="../348334/index.html">Game design to life. An example of the analysis of the mechanics of the game</a></li>
<li><a href="../348336/index.html">Animations in Android on the shelves (Part 2. Complex animations)</a></li>
<li><a href="../348338/index.html">Implementing a parallel quick sort using ForkJoinPool</a></li>
<li><a href="../348340/index.html">29% of websites are vulnerable to a DOS attack even by one machine (CVE-2018-6389)</a></li>
<li><a href="../348344/index.html">Leakpocalypse: Rust can surprise unpleasantly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>