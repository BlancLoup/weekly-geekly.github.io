<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Versioned data storage in Cach√© Persistent classes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the standard Cach√© stored classes, when modifying a record, the previous property values ‚Äã‚Äãdisappear irrevocably. But there are cases when it is un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Versioned data storage in Cach√© Persistent classes</h1><div class="post__text post__text-html js-mediator-article">  In the standard Cach√© stored classes, when modifying a record, the previous property values ‚Äã‚Äãdisappear irrevocably.  But there are cases when it is undesirable when "all moves must be recorded."  First of all, of course, such a requirement arises when developing applications for materially responsible persons, for whom the possibility is critical, for example, to cancel an erroneous action and restore the document state for a specified time, or, more importantly, to investigate an attacker‚Äôs attempt to ‚Äúcover up "In the database. <br>  This article demonstrates how to implement version storage and recovery for Cach√© objects. <br><a name="habracut"></a><br>  This functionality can be added to Persistent-classes using the% OnBeforeSave () method and SQL trigger on the Update event.  Since in the overwhelming majority of cases of using Persistent-classes, the entire record, including the values ‚Äã‚Äãof properties - arrays and lists, is stored in the global storage node of the form ^ ClassData (id), before overwriting an object, it is possible to save the previous version of the record in some secluded place - like a "basket" in Windows. <br>  Attached to this article is an example of using the above described feature, consisting of the abstract class PersHist - the heir of% Persistent, to which the necessary methods are added, and the demonstration class TestPersHist, in which there is absolutely nothing unusual except that he is the heir of PersHist, and not directly% Persistent.  In exactly the same way, it is possible to create and modify records in it, both by object and by SQL access, but the overwritten data does not disappear there without a trace and can be restored. <br><br><div class="spoiler">  <b class="spoiler_title">PersHist class source</b> <div class="spoiler_text">  <font color="#000080">/// This ancestor of the% Persistent class</font> <font color="#000080"><br></font>  <font color="#000080">/// contains triggers to enable updates history recording.</font> <font color="#000080"><br></font>  <font color="#000080">Class PersHist Extends% Persistent</font> <font color="#000000">[</font> <font color="#000080">Abstract</font> <font color="#000000">,</font> <font color="#000080">ClassType</font> <font color="#000000">= "",</font> <font color="#000080">ProcedureBlock</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">/// This callback method is invoked by the &lt;METHOD&gt;% Save &lt;/ METHOD&gt; method to</font> <font color="#000080"><br></font>  <font color="#000080">/// provide notification that the object is being saved.</font>  <font color="#000080">It is called before</font> <font color="#000080"><br></font>  <font color="#000080">/// any data is written to disk.</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// &lt;P&gt; &lt;VAR&gt; insert &lt;/ VAR&gt; will be set to 1 if this object is being saved for the first time.</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// &lt;P&gt; If this method returns to &lt;METHOD&gt;% Save &lt;/ METHOD&gt; will fail.</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">% OnBeforeSave (</font> <font color="#ff00ff">insert</font> <font color="#000080">As% Boolean</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">Final</font> <font color="#000000">,</font> <font color="#000080">Private</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">insert</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">q</font> <font color="#000000">: '..</font> <font color="#0000ff">% ObjectModified</font> <font color="#000000">()</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">q</font> <font color="#000000">..</font> <font color="#0000ff">SaveLastRevision</font> <font color="#000000">(..</font> <font color="#0000ff">% Id</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </font>  <font color="#000080">/// This callback method is invoked by the &lt;METHOD&gt;% Delete &lt;/ METHOD&gt; method to</font> <font color="#000080"><br></font>  <font color="#000080">/// provide notification that the object is defined by &lt;VAR&gt; oid &lt;/ VAR&gt; is being deleted.</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// &lt;P&gt; If this is a method then it will not be deleted.</font> <font color="#000080"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">% OnDelete (</font> <font color="#ff00ff">oid</font> <font color="#000080">As% ObjectIdentity</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">Final</font> <font color="#000000">,</font> <font color="#000080">Private</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">oid</font> <font color="#000000">)</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">SaveLastRevision</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">q $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">GetDataLocation ()</font> <font color="#000080">As% String</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">ix</font> <font color="#000000">=</font> <font color="#000080">## Class</font> <font color="#000000">(</font> <font color="#008080">% ClassDefinition</font> <font color="#000000">).</font>  <font color="#0000ff">% OpenId</font> <font color="#000000">(..</font> <font color="#0000ff">% ClassName</font> <font color="#000000">())</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">ix</font> <font color="#000000">.</font>  <font color="#0000ff">Storages</font> <font color="#000000">.</font>  <font color="#0000ff">Count</font> <font color="#000000">() '= 1</font> <font color="#008000">"";</font>  <font color="#008000">sofisticated storages not supported</font> <font color="#008000"><br></font>  <font color="#0000ff">q</font> <font color="#800000">ix</font> <font color="#000000">.</font>  <font color="#0000ff">Storages</font> <font color="#000000">.</font>  <font color="#0000ff">GetAt</font> <font color="#000000">(1).</font>  <font color="#0000ff">Datalocation</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">/// Returns next or previuos (similar to $ o ()) id of saved revision</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">OrderIdSave (</font> <font color="#ff00ff">ids</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#800080">""</font> <font color="#000000">,</font> <font color="#ff00ff">Direction</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">)</font> <font color="#000080">As% String</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">"" ""</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">= ..</font> <font color="#0000ff">% Id</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">q $ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">),</font> <font color="#800000">Direction</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">/// Returns timestamp of saved revision</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">GetTimeStampByIdSave (</font> <font color="#ff00ff">ids</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% String</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">"" ""</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">= ..</font> <font color="#0000ff">% Id</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#0000ff">$ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">)) &lt;10</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">q $ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">/// Makes revision saved at</font> <font color="#000080"><br></font>  <font color="#000080">/// and load it.</font>  <font color="#000080">All unsaved changes will be lost.</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">MakeActual (</font> <font color="#ff00ff">timestamp</font> <font color="#000080">As% StringTimeStamp</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#008000">;</font>  <font color="#008000">unsupported storage</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">= ..</font> <font color="#0000ff">% Id</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#000000">0</font> <font color="#008000">;</font>  <font color="#008000">never saved</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#800000">timestamp</font> <font color="#800000"><br></font>  <font color="#008000">;</font>  <font color="#008000">searching saved revision with zts&gt; = timestamp</font> <font color="#008000"><br></font>  <font color="#0000ff">i $ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#008000">"ZI"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">))</font> <font color="#0000ff">s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#008000">"ZI"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">), - 1)</font> <font color="#000000"><br></font>  <font color="#0000ff">e s</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#008000">"ZI"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">))</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#0000ff">s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#008000">"ZI"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">q $ s</font> <font color="#000000">(</font> <font color="#800000">ids</font> <font color="#000000">: ..</font> <font color="#0000ff">MakeActualByIdSave</font> <font color="#000000">(</font> <font color="#800000">ids</font> <font color="#000000">), 1: 0)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">/// Makes a saved revision.</font> <font color="#000080"><br></font>  <font color="#000080">/// All unsaved changes will be lost.</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">MakeActualByIdSave (</font> <font color="#ff00ff">ids</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#008000">;</font>  <font color="#008000">unsupported storage</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">= ..</font> <font color="#0000ff">% Id</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#000000">0</font> <font color="#008000">;</font>  <font color="#008000">never saved</font> <font color="#008000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#0000ff">$ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">)) &lt;10 0</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">))</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">SaveLastRevision</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">k</font> <font color="#000000">@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#0000ff">m</font> <font color="#000000">@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">) = @</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">% Reload</font> <font color="#000000">()</font> <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">% SetModified</font> <font color="#000000">(1)</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">..</font> <font color="#0000ff">% Save</font> <font color="#000000">()</font> <font color="#008000">;</font>  <font color="#008000">save again to make indices correct</font> <font color="#008000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">/// returns next or previous (similar to $ o ()) id of deleted record</font> <font color="#000080"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">OrderDeletedId (</font> <font color="#ff00ff">id</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#800080">""</font> <font color="#000000">,</font> <font color="#ff00ff">Direction</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#000080">1</font> <font color="#000000">)</font> <font color="#000080">As% String</font> <font color="#000000">[</font> <font color="#000080">Final</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">f s</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">),</font> <font color="#800000">Direction</font> <font color="#000000">)</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#0000ff">$ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#800000">id</font> <font color="#800000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">SaveLastRevision (</font> <font color="#ff00ff">id</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">Final</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#0000ff">$ g</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#0000ff">$$$ OK</font> <font color="#008000">;</font>  <font color="#008000">no previous revision to save</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#0000ff">$ i</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">)),</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#0000ff">$ zu</font> <font color="#000000">(188)</font> <font color="#008000">;</font>  <font color="#008000">$ ZTIMESTAMP in local timezone</font> <font color="#008000"><br></font>  <font color="#0000ff">m</font> <font color="#000000">@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">) = @</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#000000">@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#008000">"ZI"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">q $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">UnDeleteId (</font> <font color="#ff00ff">id</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">Final</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">dl</font> <font color="#000000">= ..</font> <font color="#0000ff">GetDataLocation</font> <font color="#000000">()</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">dl</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#0000ff">$ g</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">) 0</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#0000ff">$ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">)) 0</font> <font color="#008000">;</font>  <font color="#008000">not deleted</font> <font color="#008000"><br></font>  <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#0000ff">$ d</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">)) '&gt; 1 0</font> <font color="#008000">;</font>  <font color="#008000">no saved revisions</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">searching latest revision</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">), - 1)</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">ids</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#0000ff">$ o</font> <font color="#000000">(@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">), - 1)</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">zts</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">0</font> <font color="#000000"><br></font>  <font color="#0000ff">m</font> <font color="#000000">@</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#800000">id</font> <font color="#000000">) = @</font> <font color="#800000">dl</font> <font color="#000000">@ (</font> <font color="#008000">"History"</font> <font color="#000000">,</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ids</font> <font color="#000000">,</font> <font color="#800000">zts</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">ix</font> <font color="#000000">= ..</font> <font color="#0000ff">% OpenId</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#0000ff">d</font> <font color="#800000">ix</font> <font color="#000000">.</font>  <font color="#0000ff">% SetModified</font> <font color="#000000">(1)</font> <font color="#0000ff">s</font> <font color="#800000">res</font> <font color="#000000">=</font> <font color="#800000">ix</font> <font color="#000000">.</font>  <font color="#0000ff">% Save</font> <font color="#000000">()</font> <font color="#0000ff">k</font> <font color="#800000">ix</font> <font color="#800000"><br></font>  <font color="#0000ff">q</font> <font color="#800000">res</font> <font color="#800000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">Trigger</font> <font color="#000000">OnBeforeDeleteForSQL [</font> <font color="#000080">Event</font> <font color="#000000">= DELETE]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">n</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ix</font> <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#800080">{id}</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#800000"><br></font>  <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">SaveLastRevision</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">Trigger</font> <font color="#000000">OnBeforeSaveForSQL [</font> <font color="#000080">Event</font> <font color="#000000">= UPDATE]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">n</font> <font color="#800000">id</font> <font color="#000000">,</font> <font color="#800000">ix</font> <font color="#0000ff">s</font> <font color="#800000">id</font> <font color="#000000">=</font> <font color="#800080">{id}</font> <font color="#0000ff">q</font> <font color="#000000">: '</font> <font color="#800000">id</font> <font color="#800000"><br></font>  <font color="#0000ff">d</font> <font color="#000000">..</font> <font color="#0000ff">SaveLastRevision</font> <font color="#000000">(</font> <font color="#800000">id</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">q</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </div></div><br><div class="spoiler">  <b class="spoiler_title">Source Class TestPersHist</b> <div class="spoiler_text">  <font color="#000080">/// How to Test</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// // Create and initialize an instance:</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// s ix = ## class (TestPersHist).% New ()</font> <font color="#000080"><br></font>  <font color="#000080">/// s ix.TestVal = $ H</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.TestArray.SetAt ("Abra", 1)</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.TestArray.SetAt ("Shvabra", 2)</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.TestList.InsertAt ("Cadabra", 1)</font> <font color="#000080"><br></font>  <font color="#000080">/// s id = ix.% Id ()</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.% Save () k ix</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// // Try to update</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// s ix = ## class (TestPersHist).% OpenId (id)</font> <font color="#000080"><br></font>  <font color="#000080">/// s ix.TestVal = $ J</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.TestArray.SetAt ("Swim", 3)</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// w ix.% Save () k ix</font> <font color="#000080"><br></font>  <font color="#000080">///</font> <font color="#000080"><br></font>  <font color="#000080">/// // Look at the global ^ User.TestPersHistD.</font>  <font color="#000080">All changes recorded!</font> <font color="#000080"><br></font>  <font color="#000080">Class TestPersHist Extends PersHist</font> <font color="#000000">[</font> <font color="#000080">ClassType</font> <font color="#000000">= persistent,</font> <font color="#000080">ProcedureBlock</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">TestArray</font> <font color="#000080">As array of% String</font> <font color="#000000">(</font> <font color="#000080">MAXLEN</font> <font color="#000000">=</font> <font color="#000080">255</font> <font color="#000000">);</font>  <font color="#008000">// [Collection = array];</font> <font color="#008000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">TestList</font> <font color="#000080">As list of% String</font> <font color="#000000">;</font>  <font color="#008000">// [Collection = list];</font> <font color="#008000"><br><br></font>  <font color="#000080">Property</font> <font color="#000000">TestVal</font> <font color="#000080">As% String</font> <font color="#000000">(</font> <font color="#000080">MAXLEN</font> <font color="#000000">=</font> <font color="#000080">255</font> <font color="#000000">) [</font> <font color="#000080">Required</font> <font color="#000000">];</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> </div></div><br>  I will briefly comment on the methods added to the PersHist class. <br>  Class method GetDataLocation () - reads the description of a class-successor and returns the name of the storage global. <br>  The class method SaveLastRevision (id) is the central figure of our class.  In an amicable way, it should be made private, but in this case it cannot be called from the SQL trigger.  This method copies the record from the global node ^ ClassData (id) to ^ ClassData ("History", id, saved_version_id, $ ZTIMESTAMP).  Naturally, instead of ^ ClassData, the real name of the storage global returned by the GetDataLocation () method is used. <br>  The private method% OnBeforeSave () - calls SaveLastRevision () only when the% Save () method performs the actual modification of the record already stored in the database. <br>  The OnBeforeSaveForSQL () SQL trigger does the same. <br>  And, finally, to restore data to a state that is current at a given point in time in the $ ZTIMESTAMP format (more precisely, $ ZU (188) - local time $ ZTIMESTAMP), the MakeActual (timestamp) method is used.  This method looks at whether the record was updated exactly at the specified time or after it, and, if overwritten, saves the current version of the record and restores the previously saved one.  For example, <br><br>  <font color="#0000ff">do</font> <font color="#800000">oref</font> <font color="#000000">.</font>  <font color="#0000ff">MakeActual</font> <font color="#000000">((</font> <font color="#0000ff">$ h</font> <font color="#000000">-7) _</font> <font color="#008000">","</font> <font color="#000000">_ (12.5 * 3600))</font> <br><br>  will return the record to the state in which it was a week ago at 12:30, and, of course, it will save a copy of the state of this record at the time of its appeal. <br>  If you need a complete list of saves of this object, then the following sequence of calls is proposed. <br><br>  <font color="#0000ff">s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#0000ff">f s</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#800000">oref</font> <font color="#000000">.</font>  <font color="#0000ff">OrderIdSave</font> <font color="#000000">(</font> <font color="#800000">ids</font> <font color="#000000">)</font> <font color="#0000ff">q</font> <font color="#000000">:</font> <font color="#800000">ids</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#0000ff">w</font> <font color="#800000">ids,!</font> <br><br>  will give all identifiers of the saved versions.  And the method <br><br>  <font color="#0000ff">write</font> <font color="#800000">oref</font> <font color="#000000">.</font>  <font color="#0000ff">GetTimeStampByIdSave</font> <font color="#000000">(</font> <font color="#800000">ids</font> <font color="#000000">)</font> <br><br>  will return the exact time saving the version of interest.  However, you can restore it directly by the identifier: <br><br>  <font color="#0000ff">do</font> <font color="#800000">oref</font> <font color="#000000">.</font>  <font color="#0000ff">MakeActualByIdSave</font> <font color="#000000">(</font> <font color="#800000">ids</font> <font color="#000000">)</font> <br><br>  But it would be illogical to save all changes when modifying a record, and at the same time allow it to permanently lose this record in case of its deletion.  The% OnDelete () private method and the OnBeforeDeleteForSQL SQL trigger insure against this trouble, which will allow you to restore a deleted record using the class method UndeleteId (id) if necessary. <br>  How to calculate the identifier of the record to be restored is a non-trivial question, and it should be decided, apparently, at the discretion of the developer of the final application.  But in any case, you need the ability to navigate through remote records.  And this opportunity is provided by the OrderDeletedId (id, dir) method, which, similarly to the well-known $ ORDER () function, returns the nearest next or previous (with dir = -1) record identifier deleted but kept in history. <br><br>  The TestPersHist demonstration class inherited from PersHist contains nothing but properties in the format of a regular field, list, and array.  It is proposed to randomly create and modify entries of this class (for example, in the class comments), then direct viewing the storage global ^ User.TestPersHistD using Cach√© regular tools to monitor changes in the content of the storage global and see for yourself that all editions of all properties are stored in the ^ User branch .TestPersHistD ("History"). <br><br>  The code for the classes PersHist and TestPersHist in the form ready for import into Cach√© is available for download at <a href="http://yadi.sk/d/vy6i_T314AGPA">this link</a> : in CDL format for Cach√© version 5.0 and earlier, in XML format for modern ones. </div><p>Source: <a href="https://habr.com/ru/post/174655/">https://habr.com/ru/post/174655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174641/index.html">Pebble Kickstarter Review</a></li>
<li><a href="../174643/index.html">Cyberbunker vs Spamhaus</a></li>
<li><a href="../174647/index.html">Wrapper Interceptor Library</a></li>
<li><a href="../174649/index.html">Habr's export to FB2</a></li>
<li><a href="../174651/index.html">Bitcoin: How to get 25+ Mhash / s for free without SMS</a></li>
<li><a href="../174657/index.html">Cach√© Globals Bitmap Indexes</a></li>
<li><a href="../174661/index.html">Simultaneous work of several Android on one device</a></li>
<li><a href="../174667/index.html">New Facebook home on Android: April 4</a></li>
<li><a href="../174669/index.html">April 12-13 on Strike! in Ulyanovsk</a></li>
<li><a href="../174671/index.html">Dual core brain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>