<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúDo not call and do not write me more !!!!‚Äù - came sms from my girlfriend Katie. After a couple of hours, I realized that now I had a lot of free time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/912/ce1/f48/912ce1f48a75415fb529d933668ed3bd.jpeg"><br><br><p>  ‚ÄúDo not call and do not write me more !!!!‚Äù - came sms from my girlfriend Katie.  After a couple of hours, I realized that now I had a lot of free time and I decided to rewrite Dcoin to Go. </p><br><a name="habracut"></a><br><h3>  Introduction </h3><br>  4.5 years ago I had the imprudence to start writing my cryptocurrency in a completely inappropriate language for this business - in PHP.  As a result, of course, I wrote (I am stubborn), but it turned out to be a crutch on a crutch and that it worked at all was just some kind of magic. <br>  I just want to warn you, I‚Äôm a self-taught programmer and I write code, to say the least, imperfectly. <br><br><p>  For those who are interested in what's up with Katya, I made spoilers, and who are not interested, just do not pay attention to Katya. </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  A total of 8 months: the application runs on Win ( <a href="">64/32</a> ), OSX (64/32), Linux (64/32), FreeBSD (64/32), <a href="">Android</a> , <a href="http://dcoin.club/ru/ios.html">IOS</a> (it will be cool if someone throws on the App Store ). <br>  General code ~ 73k lines, code for different OS somewhere a few hundred lines. <br>  40k - processing / generation of blocks / tr-y, 17.5k - controllers for the interface, 15.5k - templates <br>  PostgreSQL, SQLite, MySQL are supported. </p><br><br><p>  Those who will test my creation, I warn you - there may be bugs, and if you have time, write about them, please, at <a href="">darwin@dcoin.club</a> or in a personal on Habr√©.  Suggestions and advice are also welcome. </p><br><br><p>  Well, now I‚Äôll tell my story, how I wrote all this, what I learned new, etc. I hope someone will get something useful for myself from my articles. </p><br><br><h3>  Start </h3><br><p>  It took several hours after sms-ki.  The decision to rewrite Dcoin has already been made.  It was necessary to start somewhere.  Began to google how to study Go from scratch.  Somewhere for 2-3 days I studied <a href="http://golang-book.ru/">http://golang-book.ru/</a> and <a href="https://tour.golang.org/">https://tour.golang.org/</a> , then I downloaded <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D4538370">this book</a> , it took about 2 weeks, performed only examples, independent work missed.  It was difficult, but interesting.  I wanted to start rewriting my PHP sources as soon as possible. </p><br><br><p>  I have not learned anything new for a long time, the brain has not become accustomed to such a regime.  I bought Omega-3 and Nootropil in the pharmacy, I remember the infa better under them, although it may be a self-suggestion. </p><br><br><p>  I read the last chapter.  Finally, it was possible to get down to the most interesting. <br>  The task is quite clear: rewrite several tens of thousands of lines of PHP-code.  But where to start is completely unclear.  I decided to start with the simplest - from a web server. </p><br><br><div class="spoiler">  <b class="spoiler_title">About Katya</b> <div class="spoiler_text">  I'll tell you first how it all began.  I met her on the Internet on a dating site in early 2015.  Fell in love almost immediately.  It hurt outwardly she was in my taste.  We walked in the park, joked, laughed, made fun, it became cold, we did not want to part.  He called me to watch cartoons.  We got into a taxi, we arrived.  Turned on "Three heroes: Knight's move", a very funny cartoon, lay on the bed, laughing to tears. </div></div><br><br><h3>  Revel </h3><br><p>  According to the description, I didn‚Äôt really understand why.  Put, experimented, it became clear - definitely not suitable.  Revel for sites. </p><br><br><h3>  Beego </h3><br><p>  Works on modules.  There are quite good <a href="http://beego.me/docs/intro/">docks in Russian</a> .  I took 2 config and session modules. </p><br><br><h3>  Gorilla </h3><br><p>  <a href="http://www.gorillatoolkit.org/pkg/mux">mux</a> is a good thing, but I could not find any applications for myself. </p><br><br><p>  As a result, stopped on a clean <a href="http/">net / http</a> + <a href="https://golang.org/pkg/html/template/">html / template</a> </p><br><br><h3>  Web server </h3><br><p>  It's easy to raise your web server in Go.  Here is an example of a file server: <br><br></p><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { changeHeaderThenServe := <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(h http.Handler)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandlerFunc</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { h.ServeHTTP(w, r) } } http.Handle(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, changeHeaderThenServe(http.FileServer(http.Dir(<span class="hljs-string"><span class="hljs-string">"."</span></span>)))) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8000"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) }</code> </pre> <br>  Error handling removed for simplicity.  At the 8000th port in the root you will have a listing of the directory where the application is running with the ability to download any file. <br><img src="https://habrastorage.org/files/fdc/e59/daa/fdce59daadea40b58bf7baedeeda27bd.png"><h3>  Call the controller by the transferred name </h3><br><p>  I got <a href="https://github.com/c-darwin/dcoin-go/tree/master/packages/controllers">170 controllers</a> .  Each controller is called through one of 6 HandleFunc, for example <a href="">content.go</a> .  The name of the controller in HandleFunc is taken from a POST or GET request like this tplName: = r.FormValue ("tpl_name").  Then <a href="">CallController (c, tplName)</a> is called, which calls one of 170 controllers, which in turn issues ready-made html-code, and content.go receives HTML and writes it through w.Write ([] byte (html)) and issues it to the browser.  Well, something like this. </p><br><br><div class="spoiler">  <b class="spoiler_title">About Katya</b> <div class="spoiler_text">  Late evening, I am sure that Katya will stay overnight.  But for some reason she began to repeat that she needed to go home.  I said I wanted to feed her breakfast in bed.  Agree that tomorrow morning she will arrive for breakfast.  Called a taxi, she left.  I fell asleep happy because  I found a beautiful girl with whom it is fun and interesting.  The next day, a text message came from her ‚ÄúHello.  What are you doing?".  I remember my feelings, because I wrote a girl who I really like, it was kayfovo.  And soon we were to meet with her again ... <br></div></div><br><br><h3>  Sessions </h3><br><p>  Thanks to the beego session module, everything is very simple. </p><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//      ,        globalSessions, _ = session.NewManager("memory", `{"cookieName":"gosessionid","gclifetime":86400}`) go globalSessions.GC() //    sess.Set("username", 1000) sess, _ := globalSessions.SessionStart(w, r) defer sess.SessionRelease(w) //    username := sess.Get("username")</span></span></code> </pre> <br><br><h3>  File processing </h3><br><p>  In the <a href="">upload_video.go</a> controller <a href="">,</a> I needed to accept the file. <br></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//    . 32Mb r.ParseMultipartForm(32 &lt;&lt; 20) //    multipart.File file, _, _ := r.FormFile("file") buffer := new(bytes.Buffer) //    _, err = io.Copy(buffer, file) defer file.Close() //   binaryFile = buffer.Bytes() //   fileName := r.MultipartForm.File["file"][0].Filename // Content-Type contentType := r.MultipartForm.File["file"][0].Header.Get("Content-Type")</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Server code that receives 3gp from the client and returns mp4 (it will suddenly come in handy for someone)</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"io"</span></span> <span class="hljs-string"><span class="hljs-string">"io/ioutil"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"net"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/c-darwin/dcoin-go/packages/utils"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"os/exec"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn net.Conn)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   buf := make([]byte, 4) n, err := conn.Read(buf) if err != nil { fmt.Printf("%v", utils.ErrInfo(err)) } size := utils.BinToDec(buf) fmt.Printf("get data size: %v / n: %v\n", size, n) if size &lt; 10485760 { //   binaryData := make([]byte, size) n, err = io.ReadFull(conn, binaryData) fmt.Printf("n: %v\n", n) if err != nil { fmt.Printf("%v", utils.ErrInfo(err)) } gp3, err := ioutil.TempFile(os.TempDir(), "temp") if err != nil { fmt.Printf("%v", utils.ErrInfo(err)) } mp4, err := ioutil.TempFile(os.TempDir(), "temp") if err != nil { fmt.Printf("%v", utils.ErrInfo(err)) } err = ioutil.WriteFile(gp3.Name()+".3gp", binaryData, 0644) if err != nil { fmt.Printf("%v", utils.ErrInfo(err)) } out, err := exec.Command("/usr/bin/ffmpeg", "-i", gp3.Name()+".3gp", mp4.Name()+".mp4").Output() if err != nil { fmt.Println("/usr/bin/ffmpeg", "-i", gp3.Name()+".3gp", mp4.Name()+".mp4") fmt.Printf("%v\n", utils.ErrInfo(err)) } fmt.Printf("out: %v\n", out) data, err := ioutil.ReadFile(mp4.Name()+".mp4") if err != nil { fmt.Println(err) } //  4-    ,    size := utils.DecToBin(len(data), 4) n, err = conn.Write(size) if err != nil { fmt.Println(err) } fmt.Printf("n: %v\n", n) //     n, err = conn.Write(data) if err != nil { fmt.Println(err) } fmt.Printf("n: %v\n", n) } } func main() { //   TCP-     l, err := net.Listen("tcp", ":8099") if err != nil { fmt.Printf("Error listening: %v\n", err) panic(err) os.Exit(1) } defer l.Close() for { conn, err := l.Accept() if err != nil { fmt.Println("Error accepting: ", err.Error()) os.Exit(1) } go handleRequest(conn) } }</span></span></code> </pre><br></div></div><br><br><h3>  Convert Base64 to Image </h3><br><p>  In <a href="">crop_photo.go,</a> I needed to take a picture in base64 and get an ordinary png from it </p><br><br><pre> <code class="go hljs">b64, _ := base64.StdEncoding.DecodeString(r.FormValue(<span class="hljs-string"><span class="hljs-string">"b64Img"</span></span>)) img, _, _ := image.Decode(bytes.NewReader(b64)) out, _ := os.Create(<span class="hljs-string"><span class="hljs-string">"img.png"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  img.png    png.Encode(out, img)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">About Katya</b> <div class="spoiler_text">  That day we never met.  And the next one too.  I do not know what was going on in her head, but she constantly endured dating.  Not even congratulated on February 23. <br>  I decided to shake it up somehow.  Wrote Kate sms-ku: "I will soon, of course, grab" <br>  She replied: "in a sense?" <br>  I: ‚ÄúOops, not there‚Äù <br>  She: "that means how" <br>  She got jealous.  A day later offered to meet, she agreed. </div></div><br><br><h3>  Bindata </h3><br><p>  When the web server was compiled and transferred to one of the nodes, nothing worked.  It turned out that all templates, images, etc., are not packed into the binary themselves. </p><br><p>  Puguglil, found <a href="https://github.com/jteeuwen/go-bindata">https://github.com/jteeuwen/go-bindata</a> </p><br><p>  Tulsa is very convenient and simple, it generates a go-file, where templates, images, etc. are written to variables as a set of bytes.  As a result, after compilation, one binary is obtained. </p><p></p><p>  If you want the files to be taken from disk, you need to add the parameter "-debug = true". <br>  I use a simple bash script to not enter the path where to put the go-file each time. </p><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [ $# -gt 0 ] &amp;&amp; [ $1 = "debug" ] then DEBUG="-debug=true" fi go-bindata -o="packages/static/static.go" -pkg="static" $DEBUG static/...</span></span></code> </pre><br>  Then it took me so that the files from the static directory could be obtained by a request <a href="http://localhost/">localhost</a> : 8089 / static / img.png.  For this there is a <a href="https://github.com/elazarl/go-bindata-assetfs">go-bindata-assetfs</a> .  Here is an example for the static directory: <br><br><pre> <code class="go hljs">http.Handle(<span class="hljs-string"><span class="hljs-string">"/static/"</span></span>, http.FileServer(&amp;assetfs.AssetFS{Asset: static.Asset, AssetDir: static.AssetDir, Prefix: <span class="hljs-string"><span class="hljs-string">""</span></span>}))</code> </pre><br><div class="spoiler">  <b class="spoiler_title">About Katya</b> <div class="spoiler_text">  After analyzing her behavior and, a little googling, I came across this book " <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D4813201">New rules. Secrets of successful relationships for modern girls</a> " <br>  During the evening I read and understood that for some reason she fell in love with herself using the advice from the book. <br>  Continued in the next part. </div></div><br><br><h3>  Conclusion </h3><br><p>  In the next articles I will talk about html / template, database, smooth application termination via signals, blockchain block processing, GO encryption and JS decryption, how I changed gomobile a little, adding notifications and work in the background for IOS and Android applications. </p></div><p>Source: <a href="https://habr.com/ru/post/272695/">https://habr.com/ru/post/272695/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272677/index.html">Perl5 plugin for IntelliJ IDEA v1.2: Moose and Signatures</a></li>
<li><a href="../272679/index.html">Neural network in Python, part 2: gradient descent</a></li>
<li><a href="../272681/index.html">Compare Swift and Rust</a></li>
<li><a href="../272689/index.html">Own index types in Cach√© DBMS</a></li>
<li><a href="../272693/index.html">Microsoft fixed a dangerous vulnerability in Windows Server</a></li>
<li><a href="../272697/index.html">Optimizing hyperparameters in Vowpal Wabbit with the new vw-hyperopt module</a></li>
<li><a href="../272701/index.html">How to graze cats. The history of building a system of control and accounting of working time for an IT company</a></li>
<li><a href="../272703/index.html">The WikiLeaks Revolution: The Digest of Mishaps</a></li>
<li><a href="../272705/index.html">Record and video processing on Android</a></li>
<li><a href="../272707/index.html">Bit magic: getting the next lexicographic combination</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>