<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operation Liberpy: Attackers Used Spyware in Latin America</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In mid-April 2015, our anti-virus laboratory received an executable PE file called Liberty2-0.exe, which is detected by our anti-virus products as Pyt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operation Liberpy: Attackers Used Spyware in Latin America</h1><div class="post__text post__text-html js-mediator-article">  In mid-April 2015, our anti-virus laboratory received an executable PE file called Liberty2-0.exe, which is detected by our anti-virus products as <b>Python / Liberpy.A</b> .  This program was a keylogger (keylogger), which sent information to the attackers about the keys pressed by the user on the keyboard, as well as the movements of the mouse cursor. <br><br><img src="https://habrastorage.org/files/d03/0b7/5b0/d030b75b02a14f199aa28ab692344b86.jpeg"><br><br>  We were able to find in our file collection another executable file with a similar name - ‚ÄúLiberty1-0.exe‚Äù.  This file has been detected by our anti-virus products like <b>Python / Spy.Keylogger.G</b> .  The first keylogger sample we mentioned provided us with important clues about the origin of this campaign, which we were able to confirm with our own data. <br><a name="habracut"></a><br>  According to our ESET Live Grid cloud technology, 98% of all detections of this threat came from Venezuela.  Later, our analysis confirmed that the attackers aimed it at the users of this country.  In a broader sense, this malicious software was used by attackers to compromise Latin American users in an operation we called Liberpy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Distribution and statistics</b> <br><br>  Attackers used phishing emails to spread their malware.  It was placed in the message as an attachment.  An example of such a message is shown below. <br><br><img src="https://habrastorage.org/files/b9b/22f/172/b9b22f172868464694d29709306d3369.png"><br>  Fig.  An example of a phishing email that was used by attackers to spread malware.  It is seen that it uses the theme of postal delivery. <br><br>  When a user becomes infected with malware, it will automatically infect removable USB storage devices connected to the computer.  In the future, these media will be used for the subsequent distribution of the malicious program.  Thus, this infection method is another Python / Liberpy distribution vector that is not the only malware with such a distribution mechanism.  Similar methods are used in such malicious programs as <b>Win32 / Dorkbot</b> , <b>JS / Bondat</b> and <b>VBS / Agent.NDH</b> . <br><br><img src="https://habrastorage.org/files/cc4/cd9/4ba/cc4cd94ba51046de97252d312389fb6e.jpeg"><br>  Fig.  Scheme of the malware. <br><br>  The infected computer constantly interacts with its C &amp; C server manager to transfer user data to attackers.  The frequency of this interaction depends on the version of the bot.  In the case of the first version, the frequency is 10 minutes, in the case of the second, an hour. <br><br>  The steps for infecting a user are shown above in the picture, below they are itemized. <br><br><ul><li>  Attackers initiate a malicious campaign to spread fake emails with a link to malware. </li><li>  The user receives an email and follows the link that leads to the installation of malware. </li><li>  The bot begins to send the attackers information from the computer. </li><li>  As soon as the user connects a removable USB device, Liberpy infects it, and places its files in a hidden folder along with the user's files that were already there. </li><li>  In the next step, the compromised media gets to another user, who also becomes infected (subject to weak security settings in Windows). </li></ul><br>  As we already mentioned, the Liberpy bot is written in Python and communicates with the C &amp; C server manager via the HTTP protocol on port 80.  Using this port significantly masks its activity, since this port is quite common and will not cause suspicion to the user.  On the other hand, the malware does not use traffic encryption when working with a remote server.  Both of these factors, that is, the use of a fixed port number, as well as the transmission of traffic in open form, greatly simplify the analysis of the mechanisms of interaction between the bot and the C &amp; C server.  This allowed us also to carry out a botnet dismantling operation, as well as to count the number of bots in the botnet. <br><br>  Using the DNS redirection algorithm for IP addresses used by attackers (sinkhole), as well as analyzing the first 600 bytes sent by the server to port 80, which is listened by the bot, we were able to analyze the botnet's activity in detail.  It is important to note that in order to implement the sinkhole operation, we only had access to the first 600 bytes that were sent between the bot and the server, i.e.  we did not have access to the personal data sent by the bot.  Using this method, we were able to obtain information about the frequency of bot interaction with the C &amp; C server, geographic location of bots, as well as information about the operating systems used. <br><br>  We used the sinkhole for 48 hours.  During this time, we managed to obtain sufficient information about the work of the botnet, as well as calculate the number of bots - 2 thousand machines.  When a bot interacts with the manager of the C &amp; C server, it sends it the User Agent parameter, which indicates the type of infected system. <br><br><img src="https://habrastorage.org/files/043/70f/51f/04370f51f0434c26aa462a031d598de1.png"><br>  Fig.  The first stage of the bot's interaction with the C &amp; C server. <br><br>  In the picture above you can see that the bot sends the User Agent parameter, in which the value <i>python-requests / CPython 2.3.0 / 2.7.8 Windows / 7 is specified</i> .  Below are the results of the analysis of our sinkhole service, which provided us with information about operating systems infected with bots. <br><br><img src="https://habrastorage.org/files/9ee/e07/702/9eee07702b1a4e49883c76afbfc9dc07.jpeg"><br>  Fig.  Different versions of bots that were calculated by the User Agent. <br><br>  For 40 hours, during which we monitored botnet activity, we observed only 5 different User Agents.  Below is the statistics of the distribution of bots by version. <br><br><img src="https://habrastorage.org/files/6c9/175/63d/6c917563d1f34ed699c771ccfc7a01ee.jpeg"><br>  Fig.  Distribution of versions of the bot. <br><br>  The obtained data shows that the Liberpy botnet consists of computers running Windows 7, as well as Windows XP c 25% and the remaining 10% belong to Windows 8, Windows Vista and the only system with Windows Server 2012. Most likely, this server system was infected through removable storage device. <br><br>  As we indicated above, Venezuela has become the most affected country of Liberpy, the following chart shows the geographical distribution of bots.  Note that out of 2,047 bots, 1,953 belong to Venezuela. <br><br><img src="https://habrastorage.org/files/fdc/043/30e/fdc04330ea9c45f8ae1d862da8f3069f.jpeg"><br>  Fig.  The geography of malware distribution (ESET Live Grid data). <br><br>  Below is the detailed statistics on the distribution of IP addresses of infected computers (bots) by countries. <br><br><img src="https://habrastorage.org/files/ac5/e26/972/ac5e269722be4dd4a60fc11dbd8d630b.jpeg"><br>  Fig.  Detailed statistics on the distribution of bots by country. <br><br>  Below the same statistics are presented more clearly. <br><br><img src="https://habrastorage.org/files/69b/5d5/412/69b5d541220441208920842973256c6c.png"><br><br>  The data of our sinkhole mechanism coincides with the data of the ESET Live Grid cloud technology.  Below are the data from ESET Live Grid, where you can see that Venezuela is the most infected region. <br><br><img src="https://habrastorage.org/files/5be/2d2/141/5be2d21414024ee582fada1d8cecb056.png"><br>  Fig.  Distribution of malware according to ESET Live Grid. <br><br>  It should be noted that the first version of the bot was distributed by attackers since August 2014, and the second version since January 2015. <br><br>  <b>Malware Analysis</b> <br><br>  An executable PE file called Liberty1-0.exe is one of the first variants of the payload of the malicious program that we discovered.  It is a Python script compiled with the PyInstaller tool ( <a href="https://github.com/pyinstaller/">link</a> ).  This PE file contains all the functions of keylogging and obtaining information about mouse movements. <br><br>  Despite the fact that the malicious file is executable, it was not difficult for us to restore the Python code back and, thus, get access to the original scripts, as well as the libraries that were used by the authors during the development.  Below is the source code of such a script, which shows the installation path of the malicious program, several URLs, as well as comments in Spanish. <br><br><img src="https://habrastorage.org/files/d42/a98/b06/d42a98b06f5d4f98b21ce6280d8f2d12.png"><br>  Fig.  Part of the source code of a malicious program in Python. <br><br>  Thus, when the system is infected with a malicious program, a malicious program will be located in the C: \ MSDcache directory, and files with the received keylogger information (log files) will be stored in another directory C: \ MSDcache \ system.  To store data in these log files, the HTML format is used. <br><br>  The mechanism that allows a malicious program to ensure its survival in the system is trivial and is based on using the registry key <i>HKLM \ SOFTWARE \ Microsoft \ CurrentVersion \ Run</i> . <br><br>  The script itself contains two parameters that are associated with the malware update mechanism.  The first is the update timer, which is set to a time equal to two hours (7,200 seconds) and the second <i>update_url</i> , which is the URL of the update resource.  In the case of the sample malware we are considering, the URL is <i>hxxp: //sapolipon.ddns.net</i> . <br><br>  Then, based on the response from the C &amp; C server and the return <i>value of the get_url ()</i> method, the malware will take the appropriate actions to update the URL of the C &amp; C server or send it information. <br><br><img src="https://habrastorage.org/files/b54/3da/83e/b543da83e7444491b3f62615868e669c.png"><br>  Fig.  The source code of the update function, which contains comments in Spanish. <br><br>  Using the above method and based on the information received from the C &amp; C server, the malicious program will take the appropriate action.  At the same time, the malicious program can update the URLs of the manager of the C &amp; C server or the address to which the data extracted by the malicious program is sent.  For making such requests, the C &amp; C server uses tags and. <br><br>  Below are the various URLs that were used by attackers in the Liberpy operation. <br><br><img src="https://habrastorage.org/files/199/e63/f75/199e63f75c774ba194dcbea8c8f8def0.png"><br><br>  As we have already indicated, the main task of the malware is to collect information about the keys pressed by the user on the keyboard, as well as the movements of the mouse pointer.  The received data is stored in a separate file, the contents of which is then sent to a remote C &amp; C server at fixed intervals.  Information obtained by the attackers in this way can be used to conduct fraudulent transactions with the user's online banking account.  In the version analyzed by us, the malicious program searched for a specific string in the name of the GUI window.  This mechanism is presented below in the figure. <br><br><img src="https://habrastorage.org/files/7a0/625/7ea/7a06257ea05e4660a1634a3bb305118d.png"><br>  Fig.  One of the functions of the keylogger. <br><br>  The screenshot of the malware source function shows that if the title of the window in which the keystroke captures is performed coincides with the string indicated by the malware, the information on the keystrokes is saved to a log file.  Below is another screenshot showing the comments in Spanish. <br><br><img src="https://habrastorage.org/files/c93/208/633/c93208633f504792be4fb075657e46bb.png"><br>  Fig.  Part of the source text of the script with comments in Spanish. <br><br>  The second version of Python / Liberpy.A differs from the previous one in some properties, which are listed below. <br><br><ul><li>  List of URLs of the C &amp; C server manager. </li><li>  Strings related to information obtained by hackers. </li><li>  Some internal functions. </li></ul><br>  In general, the differences between the first and second versions of the malicious program can be represented visually by the information of the WinMerge tool. <br><br><img src="https://habrastorage.org/files/570/1e1/e10/5701e1e109ec416a88da08f6fae6d7af.png"><br>  Fig.  Visual differences in the code between the first and second versions of the malware are highlighted in yellow. <br><br>  The second version of the malware also spreads through phishing emails, as well as infected removable media.  Below is a portion of the Python script code that is used to infect removable media. <br><br><img src="https://habrastorage.org/files/31c/ccc/bdf/31ccccbdfce3492cb0e922bed3ab5cc0.png"><br>  Fig.  The infection function of removable media of the second version of this malicious program. <br><br>  To ensure its survival after a reboot, this version also uses the registry branch <i>HKLM \ SOFTWARE \ Microsoft \ CurrentVersion \ Run</i> . <br><br>  Below are the URLs that attackers used to distribute the second version of malware. <br><br><img src="https://habrastorage.org/files/e65/7ad/038/e657ad0388e14b1e83058cf7e8deebff.png"><br><br>  In the second version of the malware, the authors slightly changed the OnKeyboardEvent keylogger function.  You can see that they removed one comparison condition with the title of the window. <br><br><img src="https://habrastorage.org/files/15c/bc0/498/15cbc04983d54fdb94eb09b76936f685.png"><br>  Fig.  The code of the keylogger function of the second version. <br><br>  Below is the code of the function for tracking mouse movements.  You can see that a few lines of code are commented out.  These lines were not commented out in the previous version. <br><br><img src="https://habrastorage.org/files/17d/e1c/4b9/17de1c4b90e94cc38a7b47dda6a52193.png"><br>  Fig.  The code for tracking mouse movements. <br><br>  More clearly the changes are shown below in the screenshot. <br><br><img src="https://habrastorage.org/files/77e/fbb/130/77efbb13098c4a9e851dd6c9320a1e41.png"><br>  Fig.  Differences in the code of tracking functions of the cursor movement of the first and second versions of the malicious program. <br><br>  The following screenshot shows the differences in the configuration of the two versions of malware.  You can see the differences in the names of the malware files, as well as the URLs of the manager of the C &amp; C server. <br><br><img src="https://habrastorage.org/files/942/9e4/2f5/9429e42f5d5a4749812c9b61636aa6dc.png"><br>  Fig.  Differences in the configuration parameters of the first and second versions of the malicious program. <br><br>  Both versions use the same AES encryption key, which is used when increasing the size of the log file to a certain threshold. <br><br>  The following are the differences in the keylogger function code. <br><br><img src="https://habrastorage.org/files/ff5/b40/46b/ff5b4046b98e4adc92759fc23a9af593.png"><br>  Fig.  Differences in the code of the keylogger functions between the first and second versions of the malicious program. <br><br>  The second version of the malware has two new features related to updating it and downloading other malicious files.  These features allow attackers to update the malware more dynamically through active monitoring of infected systems (described below).  In addition, these new features allow attackers to install other malware on the computer. <br><br>  The update function of the second version is as follows. <br><br><img src="https://habrastorage.org/files/414/8b4/02e/4148b402e7e440d994f1f19a3324b9b5.png"><br>  Fig.  The update function of the second version of the malware. <br><br>  Below is the code of the second version of the malicious program, which specializes in downloading new executable files into the system.  This is a significant difference from the first version, which allows attackers to install other malicious programs or tools to steal confidential user information into the system. <br><br><img src="https://habrastorage.org/files/d04/961/290/d04961290ddf4980baa20d72c7f0b094.png"><br>  Fig.  A feature that specializes in loading other malware into the system. <br><br>  For the analysis of Liberpy, we used the compromised system to control various actions, as well as to view the log file with information captured by the keylogger data.  Below is a screenshot of the log file. <br><br><img src="https://habrastorage.org/files/374/2af/831/3742af831d3c4662b5c02d7fd102f935.png"><br>  Fig.  The contents of the log file with captured keylogger data. <br><br>  The malware directory stores a hidden directory. <br><br><img src="https://habrastorage.org/files/e5a/bc2/523/e5abc2523a3b4039a082adc15036a423.png"><br>  Fig.  Hidden directory with keylogger file. <br><br>  When information is sent to attackers, the malware scans the file size; if the maximum size is exceeded, the data is compressed and encrypted using the AES key (identical for both versions). <br><br><img src="https://habrastorage.org/files/454/bda/f5a/454bdaf5a9324055954f3769be2be2a9.png"><br>  Fig.  Data encryption function. <br><br>  Below is a fragment of the interaction of the malicious program with the manager of the C &amp; C server (Wireshark). <br><br><img src="https://habrastorage.org/files/c68/8bb/6af/c688bb6afa064e42b1bd2e3d035e2c87.png"><br>  Fig.  Part of the data exchange session between the C &amp; C server and the bot. <br><br>  The following is a fragment of a bot request to a C &amp; C server to update or receive new instructions. <br><br><img src="https://habrastorage.org/files/ae8/8f4/25b/ae88f425bb1b41f7970a49a61a346d0c.png"><br>  Fig.  Request a bot to the server. <br><br>  The following screenshot shows the process of sending encrypted data from a log file by a bot to a remote server.  For this, a HTTP protocol POST request is used, and a checksum of the data is also sent so that you can check their integrity on the receiving side. <br><br><img src="https://habrastorage.org/files/587/857/3e9/5878573e9a8845e3a6e101a83e3bcf5d.png"><br>  Fig.  The bot sends the keylogger data to the C &amp; C server. <br><br>  <b>Conclusion</b> <br><br>  The malicious program Liberpy has all the basic properties of a keylogger and bot.  It allows attackers to access information of the infected computer through interaction with the C &amp; C server manager.  The update mechanism allows attackers to reconfigure this malware in time, specifying new domains for updates in the event that the old ones become unavailable or blocked. <br><br>  Using our contacts with other security companies and law enforcement agencies, we were able to dismantle this botnet and also notify users about the infection of their computers.  However, more than 2 thousand computers have become victims of a botnet based on this malicious program.  Their owners could lose various confidential information, including account credentials of accounts of various Internet services. </div><p>Source: <a href="https://habr.com/ru/post/263359/">https://habr.com/ru/post/263359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263345/index.html">Magic of tensor algebra: Part 11 - Acceleration of a point of a body during free movement. Solid Corner Acceleration</a></li>
<li><a href="../263347/index.html">Winium.Desktop: Selenium for desktop applications under Windows</a></li>
<li><a href="../263349/index.html">Modern Internet with the eyes of the blind - Headers</a></li>
<li><a href="../263351/index.html">Seminar on cryptography and PGP Keysigning party</a></li>
<li><a href="../263353/index.html">Short notes: a bunch of Redmine + StatusCake</a></li>
<li><a href="../263363/index.html">Add a hamburger to the Windows 10 application menu</a></li>
<li><a href="../263365/index.html">Porting Unity Editor to Linux: Things You Should Wanna Do in advance</a></li>
<li><a href="../263367/index.html">Cryptocurrency - how to create it?</a></li>
<li><a href="../263369/index.html">Integration of PVS-Studio with the IncrediBuild distributed assembly system</a></li>
<li><a href="../263371/index.html">Refactoring: highlight the method when it makes sense</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>