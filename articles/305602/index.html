<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two in one: USB host and composite USB device</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the article "Pastilde - an open hardware password manager" was published . Since this project is open, we decided that it would be in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two in one: USB host and composite USB device</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/dd0/2c0/eb4/dd02c0eb4d844b25925c82ad37952f9e.jpg" alt="image"></div><br><br><br>  Not so long ago, the article <a href="https://habrahabr.ru/company/thirdpin/blog/305594/">"Pastilde - an open hardware password manager" was published</a> .  Since this project is open, we decided that it would be interesting if we write small notes about the design process, about the tasks that we face and about the difficulties that we face. <br><br>  The main essence of Pastilde is that it is a kind of adapter between the keyboard and the PC.  Thus, she should be able to: <br><ul><li>  be a USB host for the keyboard that connects to it, </li><li>  be a keyboard for a PC, either to redirect messages from a real keyboard, or to be a keyboard itself, </li><li>  be a disk drive so that you can edit the password database in a human-friendly form. </li></ul><br>  This functionality is the skeleton of our project, so the first article will be devoted to him. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>USB host implementation</b> <br><br>  So, first, I needed to implement a host on a USB device so that it could recognize and communicate with the keyboard connected to it.  Since I use the Eclipse + GNU ARM Eclipse + libopencm3 bundle in my work, I really wanted to find something ready-made and preferably written using the libopencm3 library.  My desire was very bold, until the last moment did not believe that my search will be crowned with success.  However, at the end of the working day, scrolling the Internet to the bottom, I suddenly stumbled upon <a href="https://github.com/libusbhost/libusbhost">this</a> .  libusbhost?  Seriously?  And it was not just a usb host based on a libopencm3 usb, it was also written under STM32F4, the one we decided to use in the project.  In general, the stars came together and my joy knew no bounds.  By the way, it turned out that this project was created as part of libopencm3, but it was never added to the library. <br><br>  As a library, I did not compile libusbhost, I just took the sources I needed, wrote the driver for the keyboard and, in general, everything drove!  But first things first. <br><br>  From libusbhost I took the following files: <br><ul><li>  usbh_device_driver.h </li><li>  usbh_config.h </li><li>  usbh_hubbed. [ch] </li><li>  usbh_lld_stm32f4. [ch] </li></ul><br>  There was also a usart_helpers. [Ch] file, with its help it was possible to send all messages coming from the device to the host via the UART via the UART and a lot of different debug information.  I played with this functionality, but removed it from the project. <br><br>  By analogy with usbh_driver_hid_mouse. [Ch], I wrote a driver for the keyboard (usbh_driver_hid_kbd. [Ch]). <br><br>  Next, a simple class was implemented for working with the host: <br><br><div class="spoiler">  <b class="spoiler_title">USB Host Class</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> USB_HOST_TIMER_NUMBER = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> USB_HOST_TIMER_PRESCALER = (<span class="hljs-number"><span class="hljs-number">8400</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> USB_HOST_TIMER_PERIOD = (<span class="hljs-number"><span class="hljs-number">65535</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*redirect)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*control_interception)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> redirect redirect_callback; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> control_interception control_interception_callback; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">USB_host</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: USB_host(redirect redirect_callback, control_interception control_interception_callback); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kbd_in_message_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data_len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hid_kbd_config_t</span></span> kbd_config = { &amp;kbd_in_message_handler }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">usbh_dev_driver_t</span></span> *device_drivers[] = { (<span class="hljs-keyword"><span class="hljs-keyword">usbh_dev_driver_t</span></span> *)&amp;usbh_hid_kbd_driver }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: TIMER_ext *_timer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> get_time_us(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">oth_hs_setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre> <br></div></div><br>  Everything is transparent here.  The device must listen to the keyboard and wait for a special key combination to switch to the login and password selection mode.  This happens in the kbd_in_message_handler keyboard interrupt handler (uint8_t data_len, const uint8_t * data).  There are two options for the development of events: <br><ul><li>  If there is no combination, then we need to skip the message from the keyboard further into the PC.  To handle this event, the _redirect_callback function is passed to the constructor. </li><li>  If the combination is pressed, then we need to notify the system that we have switched to the login and password selection mode, therefore, we no longer broadcast messages from the keyboard to the PC.  Now the device itself is a keyboard, and messages from a real keyboard are now interpreted as commands to the device.  To handle such an event, the _control_interception_callback function is passed to the constructor. </li></ul><br><br>  <b>Implementing a composite USB device</b> <br><br>  Next, I needed to make our device appear in the device manager both as a keyboard and as a disk drive.  Here, all the magic in the descriptors =) <a href="http://sdphca.ucsd.edu/lab_equip_manuals/usb_20.pdf">This</a> document, in Chapter 9, describes in detail the USB Device Framework.  This chapter should be very carefully read and in accordance with it to describe the descriptors of the device.  In my case, the following happened: <br><br><div class="spoiler">  <b class="spoiler_title">Composite USB Descriptors</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyboard_report_descriptor[] = { <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xA1</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-number"><span class="hljs-number">0x19</span></span>, <span class="hljs-number"><span class="hljs-number">0xE0</span></span>, <span class="hljs-number"><span class="hljs-number">0x29</span></span>, <span class="hljs-number"><span class="hljs-number">0xE7</span></span>, <span class="hljs-number"><span class="hljs-number">0x15</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x25</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x75</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x95</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x81</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x95</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x75</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x81</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x95</span></span>, <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-number"><span class="hljs-number">0x75</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x19</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x29</span></span>, <span class="hljs-number"><span class="hljs-number">0x03</span></span>, <span class="hljs-number"><span class="hljs-number">0x91</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x95</span></span>, <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x75</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x91</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x95</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x75</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x15</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x26</span></span>, <span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x07</span></span>, <span class="hljs-number"><span class="hljs-number">0x19</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x2A</span></span>, <span class="hljs-number"><span class="hljs-number">0xFF</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x81</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xC0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> usb_strings[][<span class="hljs-number"><span class="hljs-number">30</span></span>] = { <span class="hljs-string"><span class="hljs-string">"Third Pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"Composite Device"</span></span>, <span class="hljs-string"><span class="hljs-string">"Pastilda"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">usb_device_descriptor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class"> = {</span></span> USB_DT_DEVICE_SIZE, <span class="hljs-comment"><span class="hljs-comment">//bLength USB_DT_DEVICE, //bDescriptorType 0x0110, //bcdUSB 0x0, //bDeviceClass 0x00, //bDeviceSubClass 0x00, //bDeviceProtocol 64, //bMaxPacketSize0 0x0483, //idVendor 0x5741, //idProduct 0x0200, //bcdDevice 1, //iManufacturer 2, //iProduct 3, //iSerialNumber 1 //bNumConfigurations }; typedef struct __attribute__((packed)) { struct usb_hid_descriptor hid_descriptor; struct { uint8_t bReportDescriptorType; uint16_t wDescriptorLength; } __attribute__((packed)) hid_report; } type_hid_function; static constexpr type_hid_function keyboard_hid_function = { { 9, //bLength USB_DT_HID, //bDescriptorType 0x0111, //bcdHID 0, //bCountryCode 1 //bNumDescriptors }, { USB_DT_REPORT, sizeof(keyboard_report_descriptor) } }; static constexpr struct usb_endpoint_descriptor hid_endpoint = { USB_DT_ENDPOINT_SIZE, //bLength USB_DT_ENDPOINT, //bDescriptorType Endpoint::E_KEYBOARD, //bEndpointAddress USB_ENDPOINT_ATTR_INTERRUPT, //bmAttributes 64, //wMaxPacketSize 0x20 //bInterval }; static constexpr struct usb_endpoint_descriptor msc_endpoint[] = { { USB_DT_ENDPOINT_SIZE, //bLength USB_DT_ENDPOINT, //bDescriptorType Endpoint::E_MASS_STORAGE_IN, //bEndpointAddress USB_ENDPOINT_ATTR_BULK, //bmAttributes 64, //wMaxPacketSize 0 //bInterval }, { USB_DT_ENDPOINT_SIZE, //bLength USB_DT_ENDPOINT, //bDescriptorType Endpoint::E_MASS_STORAGE_OUT, //bEndpointAddress USB_ENDPOINT_ATTR_BULK, //bmAttributes 64, //wMaxPacketSize 0 //bInterval } }; static constexpr struct usb_interface_descriptor iface[] = { { USB_DT_INTERFACE_SIZE, //bLength USB_DT_INTERFACE, //bDescriptorType Interface::I_KEYBOARD, //bInterfaceNumber 0, //bAlternateSetting 1, //bNumEndpoints USB_CLASS_HID, //bInterfaceClass 1, //bInterfaceSubClass 1, //bInterfaceProtocol 0, //iInterface &amp;hid_endpoint, &amp;keyboard_hid_function, sizeof(keyboard_hid_function) }, { USB_DT_INTERFACE_SIZE, //bLength USB_DT_INTERFACE, //bDescriptorType Interface::I_MASS_STORAGE, //bInterfaceNumber 0, //bAlternateSetting 2, //bNumEndpoints USB_CLASS_MSC, //bInterfaceClass USB_MSC_SUBCLASS_SCSI, //bInterfaceSubClass USB_MSC_PROTOCOL_BBB, //bInterfaceProtocol 0x00, //iInterface msc_endpoint, 0, 0 }, }; static constexpr struct usb_config_descriptor::usb_interface ifaces[] { { (uint8_t *)0, //cur_altsetting 1, //num_altsetting (usb_iface_assoc_descriptor*)0, //iface_assoc &amp;iface[Interface::I_KEYBOARD] //altsetting }, { (uint8_t *)0, //cur_altsetting 1, //num_altsetting (usb_iface_assoc_descriptor*)0, //iface_assoc &amp;iface[Interface::I_MASS_STORAGE] //altsetting }, }; static constexpr struct usb_config_descriptor config_descr = { USB_DT_CONFIGURATION_SIZE, //bLength USB_DT_CONFIGURATION, //bDescriptorType 0, //wTotalLength 2, //bNumInterfaces 1, //bConfigurationValue 0, //iConfiguration 0x80, //bmAttributes 0x50, //bMaxPower ifaces };</span></span></code> </pre><br></div></div><br>  <b>The keyboard_report_descriptor</b> was taken from the <a href="http://www.usb.org/developers/hidpage/HID1_11.pdf">Device Class Definition for Human Interface Devices (HID)</a> document, Appendix E.6 Report Descriptor (Keyboard).  Honestly, I didn‚Äôt understand much about the structure of the report, I believed the document) In general, here are a couple of points that need special attention: <br><ul><li>  <b>usb_config_descriptor</b> : the <u>bNumInterfaces</u> field should reflect as many interfaces as actually implemented.  In our case, two: HID and MSD </li><li>  <b>usb_interface_descriptor</b> : the <u>bInterfaceNumber</u> field indicates the interface number, but the countdown starts from zero, therefore, the first interface number is 0. </li></ul><br>  Here, from a descriptive point of view, probably, that's all.  I cannot fail to note how well the descriptors are described in the library (their description is in the usbstd.h file).  Everything is clear on the documentation.  I suppose this greatly simplified my task, since there were no questions like ‚ÄúHow can I describe a composite device?‚Äù.  Everything was immediately clear. <br><br>  To work with the composite device, the USB_composite class has been written, presented below. <br><br><div class="spoiler">  <b class="spoiler_title">Composite USB Class</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USB_OTG_IRQ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USB_control_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, struct usb_setup_data *req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *len, usbd_control_complete_callback *complete)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USB_set_config_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wValue)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyboard_protocol = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyboard_idle = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> keyboard_leds = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">USB_composite</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> usbd_control_buffer[<span class="hljs-number"><span class="hljs-number">500</span></span>]; UsbCompositeDescriptors *descriptors; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> usb_ready = <span class="hljs-number"><span class="hljs-number">0</span></span>; usbd_device *my_usb_device; USB_composite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> block_count, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*read_block)(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> lba, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *copy_to), <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*write_block)(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> lba, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *copy_from)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">usb_send_packet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hid_control_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, struct usb_setup_data *req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (**complete)(usbd_device *usbd_dev, struct usb_setup_data *req))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hid_set_config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wValue)</span></span></span></span>; };</code> </pre><br></div></div><br>  Key features in this class are two functions: <br><ul><li>  The <b>hid_control_request</b> function <b>is</b> needed for <b>Pastilda</b> to communicate as a keyboard with a host (in this case, the host is a PC).  Outside the class, this function is called via USB_control_callback. </li><li>  The <b>hid_set_config</b> function <b>is</b> needed in order to configure endpoints and register the USB_control_callback described in the previous paragraph.  Outside the class, this function is called via USB_set_config_callback. </li></ul><br>  Below is a variant of their implementation: <br><br><div class="spoiler">  <b class="spoiler_title">Callbacks</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> USB_composite::hid_control_request(usbd_device *usbd_dev, struct usb_setup_data *req, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> **buf, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *len, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (**complete)(usbd_device *usbd_dev, struct usb_setup_data *req)) { (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)complete; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)usbd_dev; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((req-&gt;bmRequestType &amp; USB_REQ_TYPE_DIRECTION) == USB_REQ_TYPE_IN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((req-&gt;bmRequestType &amp; USB_REQ_TYPE_TYPE) == USB_REQ_TYPE_STANDARD) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == USB_REQ_GET_DESCRIPTOR) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;wValue == <span class="hljs-number"><span class="hljs-number">0x2200</span></span>) { *buf = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)descriptors-&gt;keyboard_report_descriptor; *len = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(descriptors-&gt;keyboard_report_descriptor); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;wValue == <span class="hljs-number"><span class="hljs-number">0x2100</span></span>) { *buf = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)&amp;descriptors-&gt;keyboard_hid_function; *len = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(descriptors-&gt;keyboard_hid_function); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_NOTSUPP); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((req-&gt;bmRequestType &amp; USB_REQ_TYPE_TYPE) == USB_REQ_TYPE_CLASS) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::GET_REPORT) { *buf = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)&amp;boot_key_report; *len = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(boot_key_report); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::GET_IDLE) { *buf = &amp;keyboard_idle; *len = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(keyboard_idle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::GET_PROTOCOL) { *buf = &amp;keyboard_protocol; *len = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(keyboard_protocol); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_NOTSUPP); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((req-&gt;bmRequestType &amp; USB_REQ_TYPE_TYPE) == USB_REQ_TYPE_CLASS) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::SET_REPORT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*len == <span class="hljs-number"><span class="hljs-number">1</span></span>) { keyboard_leds = (*buf)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::SET_IDLE) { keyboard_idle = req-&gt;wValue &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req-&gt;bRequest == HidRequest::SET_PROTOCOL) { keyboard_protocol = req-&gt;wValue; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_HANDLED); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_NOTSUPP); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (USBD_REQ_NEXT_CALLBACK); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USB_control_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, struct usb_setup_data *req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *len, usbd_control_complete_callback *complete)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(usb_pointer-&gt;hid_control_request(usbd_dev, req, buf, len, complete)); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> USB_composite::hid_set_config(usbd_device *usbd_dev, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> wValue) { (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)wValue; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)usbd_dev; usbd_ep_setup(usbd_dev, Endpoint::E_KEYBOARD, USB_ENDPOINT_ATTR_INTERRUPT, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); usbd_register_control_callback(usbd_dev, USB_REQ_TYPE_INTERFACE, USB_REQ_TYPE_RECIPIENT, USB_control_callback ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USB_set_config_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(usbd_device *usbd_dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wValue)</span></span></span><span class="hljs-function"> </span></span>{ usb_pointer-&gt;hid_set_config(usbd_dev, wValue) ; }</code> </pre><br></div></div><br>  As a rule, the control_request and set_config functions must be explicitly described for each device.  However, there is an exception to this rule: Mass Storage Device.  So, let's deal with the constructor of the class USB_Composite. <br><br>  First, we initialize the USB OTG FS legs: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GPIO_ext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uf_p</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PA11)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">GPIO_ext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uf_m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PA12)</span></span></span></span>; uf_p.mode_setup(Mode::ALTERNATE_FUNCTION, PullMode::NO_PULL); uf_m.mode_setup(Mode::ALTERNATE_FUNCTION, PullMode::NO_PULL); uf_p.set_af(AF_Number::AF10); uf_m.set_af(AF_Number::AF10);</code> </pre><br>  Secondly, we need to initialize our composite device, register USB_set_config_callback, which was discussed above, and enable the interrupt: <br><pre> <code class="cpp hljs"> my_usb_device = usbd_init(&amp;otgfs_usb_driver, &amp;(UsbCompositeDescriptors::dev), &amp;(UsbCompositeDescriptors::config_descr), (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>**)UsbCompositeDescriptors::usb_strings, <span class="hljs-number"><span class="hljs-number">3</span></span>, usbd_control_buffer, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(usbd_control_buffer)); usbd_register_set_config_callback(my_usb_device, USB_set_config_callback); nvic_enable_irq(NVIC_OTG_FS_IRQ);</code> </pre><br>  This is enough for the device manager to recognize our device: <br><ul><li>  In the ‚ÄúUSB Controllers‚Äù tab: as a composite device, </li><li>  In the same tab as ‚ÄúUSB storage device‚Äù, </li><li>  In the tab "Keyboard" as "Keyboard HID". </li></ul><br>  However, the ‚ÄúUSB Mass Storage Device‚Äù will be flagged with a warning that the device is not working properly.  The thing is that unlike other USB devices, Mass Storage is initialized a little differently, through the usb_msc_init function, described in the usb_msc.c file of the libopencm3 library.  I mentioned earlier that for MSD there is no need to explicitly describe the control_request and set_config functions.  This is because the usb_msc_init function will do everything for us: it will configure both endpoints and register all callbacks.  Thus, we need to add one more line to the constructor: <br><pre> <code class="cpp hljs"> usb_msc_init(my_usb_device, Endpoint::E_MASS_STORAGE_IN, <span class="hljs-number"><span class="hljs-number">64</span></span>, Endpoint::E_MASS_STORAGE_OUT, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-string"><span class="hljs-string">"ThirdPin"</span></span>, <span class="hljs-string"><span class="hljs-string">"Pastilda"</span></span>, <span class="hljs-string"><span class="hljs-string">"0.00"</span></span>, block_count, read_block, write_block);</code> </pre><br>  Here you can see that when MSD is initialized, we need to give it a minimal API for working with memory: <br><ul><li>  block_count: number of memory sectors, </li><li>  read_block: function to read the sector, </li><li>  write_block: function for writing sector. </li></ul><br>  <i>In Pastilde, we use external flash SST25VF064C.</i>  <i>The driver for this chip can be found <a href="https://github.com/thirdpin/pastilda/tree/master/emb/pastilda/flash/drv">here</a> .</i>  <i>In the future, based on this driver, the file system will be implemented in the flash.</i>  <i>Most likely, my colleague will write about this in some detail.</i>  <i>But since I wanted to quickly test the work of MSD, I wrote the germ of the file system =) You can cry on it <a href="https://github.com/thirdpin/pastilda/tree/master/emb/pastilda/flash">here</a> .</i> <br><br>  So here.  Now that the USB_Composite class constructor has been added, you can build a project, flash the device and see that the USB Mass Storage Device is no longer flagged with a warning, and you can find the ThirdPin Pastilda USB Device tab in the Disk Devices tab.  And, it would seem, all is well.  But no =) There are more problems: <br><br>  1. It is impossible to enter the disc.  When you try to do this, everything hangs, dies, the computer is very bad. <br>  2. Recognizing a device as a disk takes more than 2 minutes. <br><br>  About these problems and how to solve them without harm to health is written here: <a href="https://habrahabr.ru/post/304924/">USB mass storage device and libopencm3</a> . <br><br>  And, oh, a miracle!  No stains =) Now everything works.  We have a USB host and a composite USB device.  It remains only to combine their work. <br><br>  <b>Combining the host and composite device</b> <br><br>  Our goal: <br><ul><li>  To broadcast messages from the keyboard to the PC until the Ctrl + Shift + ~ combination is pressed. </li><li>  After pressing the Ctrl + Shift + ~ combination, Pastilde should take control and send a message to the PC as a keyboard, after which we return to the broadcast mode and again wait for the combination. </li></ul><br><br>  The code that implements all of this is as simple as a stick: <br><br><div class="spoiler">  <b class="spoiler_title">App.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">App *app_pointer; App::App() { app_pointer = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; clock_setup(); systick_init(); _leds_api = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LEDS_api(); _flash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlashMemory(); usb_host = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> USB_host(redirect, control_interception); usb_composite = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> USB_composite(_flash-&gt;flash_blocks(), _flash-&gt;flash_read, _flash-&gt;flash_write); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> App::process() { _leds_api-&gt;toggle(); usb_host-&gt;poll(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> App::redirect(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *data, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> len) { app_pointer-&gt;usb_composite-&gt;usb_send_packet(data, len); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> App::control_interception() { <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(app_pointer-&gt;key, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">2</span></span>] = KEY_W; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">3</span></span>] = KEY_O; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">4</span></span>] = KEY_N; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">5</span></span>] = KEY_D; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">6</span></span>] = KEY_E; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">7</span></span>] = KEY_R; app_pointer-&gt;usb_composite-&gt;usb_send_packet(app_pointer-&gt;key, <span class="hljs-number"><span class="hljs-number">8</span></span>); app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;usb_composite-&gt;usb_send_packet(app_pointer-&gt;key, <span class="hljs-number"><span class="hljs-number">8</span></span>); app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">2</span></span>] = KEY_SPACEBAR; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">3</span></span>] = KEY_W; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">4</span></span>] = KEY_O; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">5</span></span>] = KEY_M; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">6</span></span>] = KEY_A; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">7</span></span>] = KEY_N; app_pointer-&gt;usb_composite-&gt;usb_send_packet(app_pointer-&gt;key, <span class="hljs-number"><span class="hljs-number">8</span></span>); app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;key[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; app_pointer-&gt;usb_composite-&gt;usb_send_packet(app_pointer-&gt;key, <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre><br></div></div><br>  In the constructor, we initialize everything that is needed: <br><ol><li>  LEDs to blink; </li><li>  Flash, so you can create files on the disk / delete; </li><li>  Host, passing it the redirect function (what to do if there is no combination) and control_interception (what to do if the combination is pressed); </li><li>  Composite device, passing it the function of reading / writing memory; </li></ol><br>  And so, in fact, that's all.  A start, the skeleton of our device is created.  Very soon the file system will be finalized, by pressing the Ctrl + Shift + ~ combination, we will get into the one-line menu, and our encrypted password database will be stored in the flash. <br><br>  I will be glad to any comments and suggestions. <br><br>  And, of course, the <a href="https://github.com/thirdpin/pastilda">github</a> link. <br><br>  UPD Jun 27, 2017: <br><ol><li>  The Pastilda project repository moved <a href="https://bitbucket.org/thirdpin_team/pastilda">here</a> .  The release 1.0 was recently published. </li><li>  Latest news on the project can be viewed <a href="https://www.crowdsupply.com/third-pin/pastilda">here</a> . </li><li>  And we finally launched <a href="http://www.pastilda.com/">the project site</a> ! </li></ol></div><p>Source: <a href="https://habr.com/ru/post/305602/">https://habr.com/ru/post/305602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305590/index.html">Hidden e-commerce hazards and valid SSL certificates</a></li>
<li><a href="../305594/index.html">Pastilde - open hardware password manager</a></li>
<li><a href="../305596/index.html">iOS 10: new in creating animations</a></li>
<li><a href="../305598/index.html">Citrix and OpenStack History</a></li>
<li><a href="../305600/index.html">Short cheat sheet on locks when reading and changing data depending on the transaction isolation level in MSSQL</a></li>
<li><a href="../305604/index.html">Self-learning chess program</a></li>
<li><a href="../305606/index.html">The final hackathon of the contest "BudgetApps"</a></li>
<li><a href="../305608/index.html">OSX / Keydnap malware used to steal credentials on Apple OS X</a></li>
<li><a href="../305610/index.html">Network Infrastructure Virtualization and SDN Solution</a></li>
<li><a href="../305614/index.html">Go Way: how garbage collection accelerated</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>