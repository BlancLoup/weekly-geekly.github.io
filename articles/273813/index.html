<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing traffic between two NATs on different providers on the same cisco physical router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the classical scheme of connecting two ISPs to one router, it is possible to use two channels at once for the NATRation of internal clients with ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing traffic between two NATs on different providers on the same cisco physical router</h1><div class="post__text post__text-html js-mediator-article">  With the classical scheme of connecting two ISPs to one router, it is possible to use two channels at once for the NATRation of internal clients with load balancing, and not just for a faylover if one of the providers fails. <br><a name="habracut"></a><br>  This is done as follows: <br>  <b>using vrf:</b> <br><div class="spoiler">  <b class="spoiler_title">vrf description for the first provider:</b> <div class="spoiler_text">  we export our tag ‚Äú100: 0‚Äù, <br>  import label from vrf of second provider ‚Äú100: 1‚Äù <br></div></div><br><pre><code class="bash hljs">ip vrf ISPA rd 100:0 route-target <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> 100:0 route-target import 100:1</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">vrf description for the second provider:</b> <div class="spoiler_text">  export our 100: 1 label, <br>  import the label from the vrf of the first provider ‚Äú100: 0‚Äù <br></div></div><br><pre> <code class="bash hljs">ip vrf ISPB rd 100:1 route-target <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> 100:1 route-target import 100:0</code> </pre><br><div class="spoiler">  <b class="spoiler_title">vrf description for client network:</b> <div class="spoiler_text">  we import both tags from vrf of two providers "100: 0" and "100: 1" <br></div></div><br><pre> <code class="bash hljs">ip vrf LAN rd 100:100 route-target import 100:0 route-target import 100:1</code> </pre><br><br>  Interface configuration: <br><div class="spoiler">  <b class="spoiler_title">to the first provider:</b> <div class="spoiler_text">  configure the correct vrf <pre> <code class="bash hljs">ip vrf forwarding ISPA</code> </pre> <br>  include nat <pre> <code class="bash hljs">ip nat outside</code> </pre> <br></div></div><br><pre> <code class="bash hljs">interface FastEthernet0/0 ip vrf forwarding ISPA ip address 50.0.0.1 255.0.0.0 ip nat outside</code> </pre><br><div class="spoiler">  <b class="spoiler_title">to the second provider:</b> <div class="spoiler_text">  configure the correct vrf <pre> <code class="bash hljs">ip vrf forwarding ISPB</code> </pre> <br>  include nat <pre> <code class="bash hljs">ip nat outside</code> </pre> <br></div></div><br><pre> <code class="bash hljs">interface FastEthernet1/0 ip vrf forwarding ISPB ip address 60.0.0.1 255.0.0.0 ip nat outside</code> </pre><br><div class="spoiler">  <b class="spoiler_title">interface looking to the local network:</b> <div class="spoiler_text">  configure the correct vrf <pre> <code class="bash hljs">ip vrf forwarding LAN</code> </pre> <br>  include nat <pre> <code class="bash hljs"> ip nat inside</code> </pre> <br></div></div><br><pre> <code class="bash hljs">interface FastEthernet1/1 ip vrf forwarding LAN ip address 192.168.0.1 255.255.255.0 ip nat inside</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Default routes to providers:</b> <div class="spoiler_text">  showing vrf for each route <br></div></div><br><pre> <code class="bash hljs">ip route vrf ISPA 0.0.0.0 0.0.0.0 50.0.0.2 ip route vrf ISPB 0.0.0.0 0.0.0.0 60.0.0.2</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Setting up BGP for mutual redistribution of routes between vrf:</b> <div class="spoiler_text">  distribute connected networks from interfaces: <pre> <code class="bash hljs">redistribute connected</code> </pre> <br>  distribute static default routes to providers: <pre> <code class="bash hljs"> redistribute static default-information originate</code> </pre> <br>  in client vrf we allow load sharing: <pre> <code class="bash hljs">maximum-paths 2</code> </pre> <br></div></div><br><pre> <code class="bash hljs">router bgp 65000 address-family ipv4 vrf ISPA redistribute connected redistribute static default-information originate address-family ipv4 vrf ISPB redistribute connected redistribute static default-information originate address-family ipv4 vrf LAN redistribute connected maximum-paths 2</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Rules for NAT:</b> <div class="spoiler_text">  we include NAT on both external interfaces in client vrf <br></div></div><br><pre> <code class="bash hljs">ip nat inside <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> route-map A interface FastEthernet0/0 vrf LAN overload ip nat inside <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> route-map B interface FastEthernet1/0 vrf LAN overload</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Access list and route-map for NAT rules:</b> <div class="spoiler_text">  we use route-map for two purposes: <br>  - IOS would not allow to create two different NAT rules for one access-list <br>  - identification by the outgoing interface <br></div></div><br><pre> <code class="bash hljs">route-map A permit 10 match ip address 1 match interface FastEthernet0/0 route-map B permit 10 match ip address 1 match interface FastEthernet1/0 access-list 1 permit 192.168.0.0 0.0.0.255</code> </pre><br><br>  To verify that route balancing has happened, we will use the traceroute command: <br><pre> <code class="bash hljs">R1<span class="hljs-comment"><span class="hljs-comment">#traceroute vrf LAN 8.8.8.8 source fa 1/1 Type escape sequence to abort. Tracing the route to 8.8.8.8 VRF info: (vrf in name/id, vrf out name/id) 1 50.0.0.2 132 msec 60.0.0.2 44 msec 50.0.0.2 24 msec</span></span></code> </pre><br>  as can be seen from the incoming responses, two providers respond. <br><br>  The NAT table after these responses confirms the generated matches: <br><pre> <code class="bash hljs">R1<span class="hljs-comment"><span class="hljs-comment">#show ip nat translations Pro Inside global Inside local Outside local Outside global udp 50.0.0.1:49162 192.168.0.1:49162 8.8.8.8:33434 8.8.8.8:33434 udp 60.0.0.1:49163 192.168.0.1:49163 8.8.8.8:33435 8.8.8.8:33435 udp 50.0.0.1:49164 192.168.0.1:49164 8.8.8.8:33436 8.8.8.8:33436</span></span></code> </pre><br><br>  The routing table for client vrf looks like this: <br><pre> <code class="bash hljs">R1<span class="hljs-comment"><span class="hljs-comment">#show ip route vrf LAN B* 0.0.0.0/0 [20/0] via 60.0.0.2 (ISPB), 00:00:20 [20/0] via 50.0.0.2 (ISPA), 00:00:20 50.0.0.0/8 is variably subnetted, 2 subnets, 2 masks B 50.0.0.0/8 is directly connected (ISPA), 00:00:22, FastEthernet0/0 L 50.0.0.1/32 is directly connected, FastEthernet0/0 60.0.0.0/8 is variably subnetted, 2 subnets, 2 masks B 60.0.0.0/8 is directly connected (ISPB), 00:00:20, FastEthernet1/0 L 60.0.0.1/32 is directly connected, FastEthernet1/0 192.168.0.0/24 is variably subnetted, 2 subnets, 2 masks C 192.168.0.0/24 is directly connected, FastEthernet1/1 L 192.168.0.1/32 is directly connected, FastEthernet1/1</span></span></code> </pre><br><br>  <b>without using vrf:</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    interface FastEthernet0/0 ip address 50.0.0.1 255.0.0.0 ip nat outside #    interface FastEthernet1/0 ip address 60.0.0.1 255.0.0.0 ip nat outside #    interface FastEthernet1/1 ip address 192.168.0.1 255.255.255.0 ip nat inside #PBR              ip local policy route-map PBR #NAT         ip nat inside source route-map A interface FastEthernet0/0 overload ip nat inside source route-map B interface FastEthernet1/0 overload ip route 0.0.0.0 0.0.0.0 50.0.0.2 ip route 0.0.0.0 0.0.0.0 60.0.0.2 #PBR        route-map PBR permit 10 match ip address 10 set ip next-hop 50.0.0.2 #PBR        route-map PBR permit 20 match ip address 11 set ip next-hop 60.0.0.2 # NAT    route-map A permit 10 match ip address 1 match interface FastEthernet0/0 # NAT    route-map B permit 10 match ip address 1 match interface FastEthernet1/0 # acl access-list 1 permit 192.168.0.0 0.0.0.255 access-list 10 permit 50.0.0.1 access-list 11 permit 60.0.0.1</span></span></code> </pre><br><br>  <b>!</b> <br><pre> <code class="bash hljs">ip cef    </code> </pre> <br>  Thank you all for your attention, waiting for your comments. <br><br>  PS <br>  The ecmp file (thanks to <a href="http://habrahabr.ru/users/vasilevkirill/">vasilevkirill for noticing</a> ) does not happen thanks to the hash algorithm used in cef, <br>  more about this on the official website <br>  www.isisco.com/c/en/us/support/docs/ip/express-forwarding-cef/116376-technote-cef-00.html </div><p>Source: <a href="https://habr.com/ru/post/273813/">https://habr.com/ru/post/273813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273803/index.html">IBM FlashSystem 900 storage system overview</a></li>
<li><a href="../273805/index.html">Zabbix + SoapUI = monitoring web services</a></li>
<li><a href="../273807/index.html">Parse HTML in .NET and Survive: Analyzing and Comparing Libraries</a></li>
<li><a href="../273809/index.html">Comparison of free software accounting traffic SQUID</a></li>
<li><a href="../273811/index.html">New Year's release of PVS-Studio 6.00: check Roslyn</a></li>
<li><a href="../273815/index.html">A bit about container virtualization</a></li>
<li><a href="../273817/index.html">7 games in 7 days: rewarded video</a></li>
<li><a href="../273819/index.html">Electronic board of the bank and EDS: integration experience</a></li>
<li><a href="../273823/index.html">New 3CX Phone v14 client details</a></li>
<li><a href="../273825/index.html">Hub AI & BigData meetup # 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>