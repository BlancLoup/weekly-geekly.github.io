<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Keyboard input using IME</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In Asian language cultures there are a large number of characters that do not always fit on a standard keyboard layout. To enter these ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Keyboard input using IME</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In Asian language cultures there are a large number of characters that do not always fit on a standard keyboard layout.  To enter these characters, a special technology was developed, which was called the Input Manager Editor (Rus. ‚ÄúInput Method Editors‚Äù).  The Input Method Editor (IME) is a program or component of the operating system that allows users to enter characters that are not physically present on the keyboard. <br>  Although the term ‚Äúinput method editor‚Äù (IME) was originally used only in Microsoft Windows, it is currently used in other operating systems, when it is important to distinguish the input method from the program functionality that provides it and general support for input methods. operating system. <br>  The term ‚Äúinput method‚Äù usually means a certain input method from a keyboard in a language, such as Cantse, input using Pinyin or using ‚Äúdead‚Äù keys. ‚Äù <br>  The term ‚Äúinput method editor‚Äù usually means a specific program that allows you to use an input method (for example, SCIM or Microsoft IME). <a name="habracut"></a><br><br><h4>  Default IME system </h4><br>  If the language culture contains no more than 100 characters, then when typing from the keyboard, it is not necessary to convert several keystrokes to a single character, as was the case with typewriters.  For modern keyboards, this rule is relevant, for example, QWERTY keyboards contain 102 keys and several modifiers.  However, if more than 100 characters are present in the language, then it is necessary to provide for the conversion of a combination of the entered characters before using them in the application.  This process is called the ‚Äúcommunication process‚Äù (FEP) and IME is the standard way for FEP in Windows. <br>  As standard, IME uses a syllable phonetic input card for the selected language.  In the normal scenario, the user enters Latin characters that are included in the pronunciation of a particular syllable.  If IME recognizes the syllable entered, it displays to the user a list of words or phrases of candidates from which the user can choose the final version.  The selected word is then sent to the application through a series of Microsoft Windows messages - WM_CHAR.  Since the IME operates at a level below the normal application (by intercepting keyboard input), the presence of the IME is transparent to the application.  Almost all application windows can easily take advantage of IME, not knowing about its existence and not requiring special coding. <br>  Entering a single word can occur in two or three stages, depending on the chosen language system. <br>  For example, the script for the Japanese language: <br><ol><li>  The user enters the designation of syllables in Latin.  For example, the word "tsunami" is typed as "tsunami". </li><li>  Introduced syllables in the Latin alphabet are automatically replaced with symbols from hiragana or katakana.  Hiragana and Katakana are syllabary alphabets in which each sound of the Japanese language has its own hieroglyph.  For example, if the user selects hiragana: ‚ÄúTsu‚Äù is automatically replaced with ‚Äú„Å§‚Äù, ‚Äúna‚Äù -&gt; ‚Äú„Å™‚Äù, ‚Äúmi‚Äù -&gt; ‚Äú„Åø‚Äù. </li><li>  The user can leave the word written in hiragana, and can convert to a hieroglyph.  Converting to hieroglyphs is similar to the T9 input system: in the worst case, the user is presented with a list of options from which he must choose one option.  In the example with the ‚Äútsunami‚Äù, the hiragana ‚Äú„Å§ „Å™ „Åø‚Äù turns into hieroglyphs ‚ÄúÊ¥• Ê≥¢‚Äù.  At the third stage, you can control the conversion, usually using the keys "Space", "Enter", arrows, "numpad".  For example, Space converts from hiragana to hieroglyphs, another Space shows a list with replacement options, ‚ÄúEnter‚Äù means to finish the conversion and leave the entered characters ‚Äúas is‚Äù. </li></ol><br><br><img src="https://habrastorage.org/storage2/c4d/82e/f3d/c4d82ef3d0b95b622b4a342351faf435.png"><br>  The first screenshot shows how the user enters a sequence of characters called the ‚Äúcomposition string‚Äù (en. ‚ÄúComposition string‚Äù).  It should be noted that the sequence of the two proposed characters was converted to one ‚ÄúF‚Äù symbol in a notebook. <br>  The second screenshot shows that the user has completed the input of syllables, and the IME system prompts you to select the appropriate word (The user clicked ‚Äúspace‚Äù).  The user can confirm the input of a word by pressing ‚ÄúEnter‚Äù. <br>  After pressing ‚ÄúEnter‚Äù to confirm the entered word, the application (in the example, notepad) receives the resulting string as a WM_IME_CHAR message.  Subsequently, if the application does not process this message, it will receive a standard WM_CHAR message from the IME system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Overriding default IME behavior </h4><br><img src="https://habrastorage.org/storage2/2f7/576/d91/2f7576d91f46c9e80f047587d97e28c0.png"><br>  Typically, IME uses standard Windows procedures for creating windows (using WinAPI). <br>  Note: When an application is running in full-screen mode, as is customary, for example, for games, standard windows do not work and cannot be displayed over the application.  To solve this problem, an application must process IME messages on its own, rather than rely on IME windows to accomplish this task. <br>  As a standard, an application can use the IME library directly, by processing IME-related messages and invoking an input method manager (IMM). <br>  When a user uses an IME layout to enter complex characters, IMM sends messages to the application to notify him of important events, such as launching a composition window or ‚Äúshow a list of candidate words‚Äù.  An application typically ignores these messages and sends them, by default, to a Windows message handler, which causes the IME library to be called. <br>  The process diagram (Fig. 2) shows how the text input process occurs: <br><ol><li>  When the IMM receives keystrokes from the keyboard driver, it sends virtual characters to the IME system, calling the ‚ÄúImeProcessKey‚Äù function.  If the result of this function is ‚Äú0‚Äù, then the keystroke must be handled by the operating system and the application itself.  WM_KEYDOWN and WM_KEYUP messages will be sent to the application, and then WM_CHAR or WM_COMMAND. </li><li>  If the IME system returned a result other than "0", then IMM will transmit the pressed characters by calling the IME library's "ImeToAsciiEx" function. </li><li>  The IME system returns the "lpdwTransBuf" parameter, which contains the Windows messages that must be passed to the application.  The IME system also takes hIMC, as a parameter, where the ‚Äúcomposition string‚Äù is indicated.  During operation, the IME system will change the contents of the hIMC memory area. </li><li>  Each time IMM receives the "lpdwTransBuf" parameter, it checks whether this buffer contains messages for the application.  Usually the buffer contains a WM_IME_COMPOSITION message that must be sent to the application each time the composition string changes. </li><li>  If the application does not support IME, then it will not process the WM_IME_COMPOSITION message.  Thus, the user will not see the input.  In this case, the message is transmitted to the corresponding IME UI window (which is created by the IME system during initialization in the ‚ÄúImeInquire‚Äù function), which is always created if the IME is activated.  The IME window will show the composition string as entered by the user. </li><li>  If the application supports IME, then it will process the WM_IME_COMPOSITION message.  If you want to get the contents of the composition string, the application calls the function ‚ÄúImmGetCompositionString‚Äù from the library ‚ÄúImm32.dll‚Äù.  The WM_IME_COMPOSITION message can also notify the application that a string has been formed. </li><li>  If an application receives a composition string from IMM, then it should call the DefWindowProc function for the WM_IME_CHAR message, since  further processing can generate this message again. </li><li>  If the application does not support IME, then it will receive a WM_IME_CHAR message.  If the application supports Unicode, then the Unicode character will be passed in the parameters; if not, the application will receive a WM_CHAR message, but it will know that it is necessary to convert the character. </li><li>  As a result, the application always receives the WM_CHAR message and knows whether to convert the character. </li></ol><br><br>  The IME library is a regular DLL file, usually with the extension ‚Äú.ime‚Äù.  Each IME system must be registered in Microsoft Windows in the registry: "HKEY_LOCAL_MACHINE \ SYSTEM \ ControlSet00X \ Keyboard Layouts".  For any application, you can always get its keyboard context. <br><br><h4>  Potential threat using IME system </h4><br>  Each Keyboard Layout, including IME systems, is always loaded into each process of the operating system.  A normal application running in the user environment cannot prevent the loading of keyboard modules into its address space.  The IME library, as a Windows library, is required to export several functions that can be overridden.  Also, when loading a library, the DLLMain function is always called. <br>  To implement an attack, such as Keylogger, an attacker simply needs to create his own IME system for any keyboard layout (for example, IME for US, UK, RU, CH, JP, KR), which does not display windows and performs character conversion.  Those.  will be invisible to the user. <br>  As mentioned above, the IMM manager always transmits keystroke codes to the selected IME system, calling the ImeProcessKey and ImeToAsciiEx functions exported from the IME library. <br>  The easiest way to intercept keystrokes is to use the ‚ÄúImeProcessKey‚Äù function, which should always return ‚Äú0‚Äù to prevent further processing of messages for a given character.  Since  IME-library is loaded into all processes, the user will not be able to notice suspicious activity by standard means (for example, there will not be a separate process for the IME-library). <br>  Also, if ImeProcessKey returns a nonzero value, then key interception can be performed in the ImeToAsciiEx function, but it is necessary to convert the scan code of the pressed key to a character in the desired encoding, which is a trivial operation. <br><br><h5>  More malicious actions </h5><br>  Signed (legal) IME-library files can be easily deleted from the user's computer.  If an IME library is created by hackers, then it can be added instead of a legal library.  This can lead to the following threats: <br><ul><li>  Malicious IMEs can change the standard IME of all users; </li><li>  Even if the user changes the default IME, IME editors that have already been selected will not be changed.  The user must log in to the OS or restart the computer. </li><li>  If the IME-library is running in a separate thread, then it can continue to work.  The user will not be able to complete it with standard means. </li><li>  Malicious users may set special registry change rights to make it difficult to remove the IME library. </li><li>  IME is loaded even in 16-bit applications and applications from the command line. </li><li>  IME can download the WinSock subsystem to access the Internet. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/183858/">https://habr.com/ru/post/183858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../183848/index.html">Beautiful CSS3 menu</a></li>
<li><a href="../183850/index.html">Musical rehearsals: now and through the Internet</a></li>
<li><a href="../183852/index.html">Convenient music download from vkontakte</a></li>
<li><a href="../183854/index.html">Introduction to Spring Frameworks: Spring MVC</a></li>
<li><a href="../183856/index.html">STM32F3DISCOVERY, accelerometers, stepper motors and a bit of magic</a></li>
<li><a href="../183862/index.html">SCO resumes litigation against IBM over UNIX rights</a></li>
<li><a href="../183864/index.html">NASA is asking for help in finding dangerous asteroids to neutralize them</a></li>
<li><a href="../183866/index.html">Watch MKV on Apple TV from Plex</a></li>
<li><a href="../183868/index.html">Add links to site pages in CKEDITOR 4</a></li>
<li><a href="../183872/index.html">A network of "solar" charging stations is being created in New York</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>