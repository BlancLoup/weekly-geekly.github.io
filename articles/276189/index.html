<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moxy - MVP implementation for Android with a pinch of magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is MVP 
 MVP is a way of sharing responsibility in the application code. Model provides data for Presenter . View performs two functions: it resp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moxy - MVP implementation for Android with a pinch of magic</h1><div class="post__text post__text-html js-mediator-article"><h2>  What is <i>MVP</i> </h2><br>  <i>MVP</i> is a way of sharing responsibility in the application code.  <i>Model</i> provides data for <i>Presenter</i> .  <i>View</i> performs two functions: it responds to commands from the user (or from UI elements), sending these events to the <i>Presenter</i> and modifies the gui on demand of the <i>Presenter</i> .  <i>Presenter</i> acts as a link between <i>View</i> and <i>Model</i> .  <i>Presenter</i> receives events from <i>View</i> , processes them (using or not using the <i>Model</i> ), and commands the <i>View</i> about how it should change itself. <br><br>  This approach to the division of responsibility has a number of advantages: <br><ol><li>  Writing tests to the code is greatly simplified. </li><li>  Easy to change a part without breaking another </li><li>  The code is broken into small pieces, due to which it becomes more understandable and readable </li></ol><br>  At the same time, of course, there are also disadvantages: <br><ol><li>  Code gets bigger </li><li>  You need to get used to this approach. </li><li>  At the moment, not very common ( <i>but well-known</i> ) approach, so you have to tell everyone about it </li></ol><br><a name="habracut"></a><br><h2>  <i>MVP</i> in Android </h2><br>  Activity in Android is <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582">God object</a> .  It usually has the following responsibility: <br><ul><li>  Full GUI Management </li><li>  Handling user interaction. </li><li>  Run asynchronous tasks. </li><li>  Processing the result of the asynchronous task. </li></ul><br>  The saddest thing is that our God Object is not immortal - Activity also dies when the configuration changes. <br><br>  <i>MVP</i> removes some of the responsibility for the Activity.  All work with asynchronous tasks goes to <i>Presenter</i> .  All business logic is in <i>Presenter</i> and <i>Model</i> .  Activity, in turn, becomes <i>View</i> .  She starts to simply display what <i>Presenter</i> says and sends events to <i>Presenter</i> so that he can decide what to do next. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before writing our solution, we studied many articles and implementations of the <i>MVP</i> concept in Android (see links at the end of the article).  Based on the analysis, a list of solution requirements has been established: <br><ol><li>  <i>View</i> should bind to existing <i>Presenter</i> when changing configuration </li><li>  After binding the <i>View</i> to an existing <i>Presenter</i> , the <i>View</i> should display the current state of the <i>Presenter.</i> </li><li>  <i>Presenter</i> should be able to ( <i>if necessary</i> ) live no matter who subscribes to it or unsubscribes from it. </li></ol><br>  At the moment, none of the existing solutions can do all these points at the same time.  As it seemed to us at first, the <a href="http://hannesdorfmann.com/mosby/">Mosby</a> library was the most suitable for us.  But later it turned out that when using it, we would have to write too much code every time.  Especially, for the implementation of the first two points from our list of requirements.  Therefore, it was decided to develop their own decision. <br><br><h2>  Moxy - theory </h2><br>  Our solution is very different from all the others (even the <i>MVP</i> concept itself was modernized) in that <i>ViewState was</i> mixed up between <i>View</i> and <i>Presenter</i> .  And it is absolutely necessary there.  He is responsible for ensuring that each <i>View</i> always looks exactly as the <i>Presenter</i> wants.  <i>ViewState</i> stores a list of commands that were transferred from <i>Presenter</i> to <i>View</i> .  And when the ‚Äúnew‚Äù <i>View</i> joins the <i>Presenter</i> , the <i>ViewState</i> automatically applies to it all the commands that the <i>Presenter</i> issued earlier.  Thus, it turns out that no matter what happens with <i>View</i> due to the fault of Android, <i>View</i> will remain in the correct state anyway.  To do this, you will only need to get used to changing the <i>View</i> solely by the commands from the <i>Presenter</i> .  Note that this is one of the basic rules of <i>MVP</i> and applies not only to Moxy. <br><br>  A schematic illustration of how this works: <br><img src="https://habrastorage.org/files/ac7/e3c/6f5/ac7e3c6f5eec4f498ab50e597606faa5.gif"><br>  What happens on this scheme: <br><ol><li>  In the <i>View</i> event occurs <img src="https://habrastorage.org/files/88e/47f/0d5/88e47f0d5767494c9dc56879b2281d28.png">  that is passed to the <i>presenter</i> </li><li>  <i>Presenter</i> passes command <img src="https://habrastorage.org/files/b0c/d57/199/b0cd57199d4f4bcea465aefb21061461.png">  in <i>viewstate</i> </li><li>  <i>Presenter</i> starts an asynchronous request <img src="https://habrastorage.org/files/998/8b1/57f/9988b157f9b544fd89b4af4aea061f87.png">  in <i>Model</i> </li><li>  <i>ViewState</i> adds command <img src="https://habrastorage.org/files/b0c/d57/199/b0cd57199d4f4bcea465aefb21061461.png">  in the queue of commands, and then passes it to the <i>View</i> </li><li>  <i>View</i> brings itself to the state specified in the command. <img src="https://habrastorage.org/files/b0c/d57/199/b0cd57199d4f4bcea465aefb21061461.png"></li><li>  <i>Presenter</i> gets query result <img src="https://habrastorage.org/files/998/8b1/57f/9988b157f9b544fd89b4af4aea061f87.png">  from <i>model</i> </li><li>  <i>Presenter</i> passes two commands to <i>ViewState</i> <img src="https://habrastorage.org/files/9bd/23f/e0c/9bd23fe0c88c4d8f8b4a498474a6ad09.png">  and <img src="https://habrastorage.org/files/70c/231/d6b/70c231d6bf6b432ba83d5ecf2e97aafd.png"></li><li>  <i>ViewState</i> saves commands <img src="https://habrastorage.org/files/9bd/23f/e0c/9bd23fe0c88c4d8f8b4a498474a6ad09.png">  and <img src="https://habrastorage.org/files/70c/231/d6b/70c231d6bf6b432ba83d5ecf2e97aafd.png">  to the command queue and send them to the <i>View</i> </li><li>  <i>View</i> brings itself to the state specified in the commands. <img src="https://habrastorage.org/files/9bd/23f/e0c/9bd23fe0c88c4d8f8b4a498474a6ad09.png">  and <img src="https://habrastorage.org/files/70c/231/d6b/70c231d6bf6b432ba83d5ecf2e97aafd.png"></li><li>  New / recreated <i>View</i> joins an existing <i>Presenter</i> </li><li>  <i>ViewState</i> transfers the saved command list to a new / recreated <i>View.</i> </li><li>  New / recreated <i>View</i> brings itself to the state specified in the commands <img src="https://habrastorage.org/files/b0c/d57/199/b0cd57199d4f4bcea465aefb21061461.png">  , <img src="https://habrastorage.org/files/9bd/23f/e0c/9bd23fe0c88c4d8f8b4a498474a6ad09.png">  and <img src="https://habrastorage.org/files/70c/231/d6b/70c231d6bf6b432ba83d5ecf2e97aafd.png"></li></ol><br><br><h2>  Moxy - features </h2><br>  Moxy has several significant advantages over other solutions: <ul><li>  <i>Presenter</i> does not re-create when recreating an Activity (this simplifies working with multithreading at times) </li><li>  Automate the full recovery of what the user sees when recreating an Activity (including when dynamically adding Android View elements) </li><li>  Ability to change several <i>Views</i> from one <i>Presenter at</i> once (in practice it turned out to be extremely convenient) </li></ul><br>  To do this, Moxy has several mechanisms that can be combined with each other as you please.  The most powerful mechanisms are annotations, on the basis of which the code is generated.  And during the execution of the program, the tool called <code>MvpDelegate</code> begins to fully use the generated code. <br><br>  The following annotations are available: <br><ul><li>  @InjectPresenter - abstract for the management of the life cycle <i>Presenter</i> </li><li>  @InjectViewState - an annotation for binding <i>ViewState</i> to <i>Presenter</i> </li><li>  @StateStrategyType - summary for managing the strategy of adding and removing commands from the command queue in <i>ViewState</i> </li><li>  <font color="#999999"><abbr title="Obsolete, not used anymore">@GenerateViewState</abbr></font> - annotation for generating <i>ViewState</i> code for a specific <i>View</i> interface </li></ul><br>  All this further. <br><br><h4>  Moxy - <code>MvpPresenter</code> </h4><br>  Each application contains some business logic.  In the <i>MVP</i> concept, all business logic is located in the <i>Presenter</i> and in the <i>Model</i> .  In fact, this means that you practically do not program in <i>View</i> .  In order for your <i>Presenter</i> <b>not to</b> become a God Object, you need to separate each separate block of business logic into a separate <i>Presenter</i> .  In this case, you will get a lot of <i>Presenter</i> , but they will be very simple and understandable.  For example, if you had two business logic on one screen, and then they split into 2 different screens, then you simply change the View.  A <i>Presenter</i> what they were, and will remain so.  Also, in this case, you can easily reuse one <i>Presenter</i> in several places (for example, BasketPresenter, pass-through through the entire application).  It also simplifies code testing - you just check a small <i>Presenter</i> that it does everything right. <br><br>  For <i>Presenter</i> in Moxy the class <code>MvpPresenter&lt;View extends MvpView&gt;</code> .  <code>MvpPresenter</code> contains an instance of <i>ViewState</i> , which at the same time must implement the same type of <code>View</code> that came in <code>MvpPresenter</code> .  This <i>ViewState</i> instance can be accessed from the <code>public View getViewState()</code> method.  And during development you do not think that you are working with <i>ViewState</i> , but simply give commands for <i>View</i> through this method how to change it.  There are also methods for attaching / decoupling <i>View</i> from <i>Presenter</i> ( <code>public void attachView(View view)</code> and <code>public void detachView(View view)</code> ).  Note that multiple <i>views</i> can be <i>associated</i> with one <i>Presenter</i> .  They will always be up to date (at the expense of <i>ViewState</i> ).  And if you want the <i>View</i> binding / decoupling to pass not through the standard <i>ViewState</i> field, you can redefine these methods and work with the incoming <i>View</i> as you wish.  <i>For example, you might want to use a non-standard <i>ViewState</i> , which does not implement the <code>View</code> interface, if you need to.</i> <br><br>  In the class <code>MvpPresenter</code> is also an interesting method <code>protected void onFirstViewAttach()</code> .  It is very important to understand when this method will be called and why it is needed.  This method is called when any <i>View</i> is bound to a specific <i>Presenter</i> instance for the first time.  And when <i>another</i> <i>View</i> is attached to this <i>Presenter</i> , the state from <i>ViewState</i> will be applied to it.  And here it does not matter, this <i>new View</i> is a completely different <i>View</i> , or recreated as a result of a configuration change.  This method is suitable, for example, to load a news list when you first open the news list screen. <br><br>  At the moment when the command came to <i>View</i> , you may need to understand, is this a new command, or is it a command to restore the state?  For example, if this is a fresh command, then you need to apply a command with animation.  Otherwise, do not apply animation.  This can be done through different StateStrategy, or through complex flags in the <code>Bundle savedState</code> .  But the correct solution would be to use the <i>Presenter</i> (or <i>ViewState</i> ) method. <code>public boolean isInRestoreState(View view)</code> , which tells you what state the particular <i>View is in</i> .  This way you can understand whether you need animation or not. <br><br><h4>  Moxy - <code>MvpView</code> and <code>MvpViewState</code> </h4><br>  The simplest component of <i>MVP</i> is <i>View</i> .  You need to create an interface that is inherited from the <code>MvpView</code> interface marker and describe in it methods that the <code>MvpView</code> will be able to perform.  In addition to <i>View</i> , our library has a <i>ViewState</i> entity, which is directly related to <i>View</i> .  <i>ViewState</i> is a descendant of <code>MvpViewState&lt;View extends MvpView&gt;</code> .  It manages one, or several, <i>View</i> (all of one type <code>View</code> ).  And every time a team from the <i>Presenter</i> comes to <i>ViewState</i> , <i>ViewState</i> sends it to all the <i>View</i> he knows about.  Also, <code>MvpViewState</code> has a <code>protected abstract void restoreState(View view)</code> method, <code>protected abstract void restoreState(View view)</code> , which will be called when any <i>View</i> is recreated, or when a new <i>View</i> is bound to the <i>Presenter</i> to the <i>ViewState</i> .  After this method is completed, the ‚Äúnew‚Äù <i>View</i> will take the desired state. <br><br>  It is worth noting that <code>MvpViewState</code> stores a list of all <i>View</i> attached to it.  And it will be good if you do not forget to untie the <i>View</i> that has already been destroyed.  But if you suddenly forget to do this, do not worry much - <code>MvpViewState</code> does not store direct links to the <i>View</i> , but the <code>WeakReference</code> , which will still help the GC.  And if you use a mechanism such as <i>MvpDelegate</i> , then you can not worry about it - it binds the <i>View</i> to the <i>Presenter</i> and untie them. <br><br><h4>  Moxy - <abbr title="Obsolete, not used anymore">@GenerateViewState</abbr> and @InjectViewState </h4><br>  Since <i>ViewState</i> in most cases is a rather monotonous layer between <i>View</i> and <i>Presenter</i> , a code generator was written that does all the dirty work for you.  By applying the <font color="#999999">@GenerateViewState</font> annotation to your View interface, you will get the generated <i>ViewState</i> class.  And so that you don‚Äôt have to independently search and create an instance of this class in <i>Presenter</i> , there is the @InjectViewState annotation.  Simply apply it to your <i>Presenter</i> class.  Further <code>MvpPresenter</code> will do everything itself - it will create an instance of this <i>ViewState</i> , fold it to itself as a field and use it everywhere.  You just need to work with the <code>public View getViewState()</code> <code>MvpPresenter</code> from <code>MvpPresenter</code> . <br><br>  In case you do not want to use <font color="#999999">@GenerateViewState</font> , but your <i>ViewState</i> implements the <i>View</i> interface, you can still use the @InjectViewState annotation.  In this case, pass to this annotation, as a parameter, the class of your <i>ViewState</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Be careful when applying the @InjectViewState annotation to a typed Presenter.</b> <div class="spoiler_text">  For example, if you have this code: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@InjectViewState</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyPresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MvpView</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MvpPresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// pass }</span></span></code> </pre>  The Annotation processor will not correctly understand the <i>View</i> class, whose <i>ViewState</i> should be used.  In this case, you can explicitly pass the <i>View</i> class to the view parameter of the @InjectViewState annotation. </div></div><br><div class="spoiler">  <b class="spoiler_title">Also note that an interface annotated with @GenerateViewState must be non-typed.</b> <div class="spoiler_text">  The catch lies in the fact that when generating code, we need to know the types of all parameters of all methods.  Otherwise, the resulting code will not work. <br><br>  Therefore, <u>you can</u> write such code: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GenerateViewState</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConcreteInterface</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractInterface</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// pass }</span></span></code> </pre><br>  You <u>cannot</u> write such code: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GenerateViewState</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConcreteInterface</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractInterface</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// pass }</span></span></code> </pre> </div></div><br><h4>  Moxy - <code>StateStrategy</code> for commands in <i>ViewState</i> </h4><br>  By default, all commands for the <i>View</i> are saved in <i>ViewState</i> simply in the order in which they arrived there.  And after the teams have been applied, they continue to lie in this queue.  But this behavior can be changed by applying the @StateStrategyType annotation to the <i>View</i> interface and to its methods.  At the input, this annotation receives a parameter in which you must specify the <code>StateStrategy</code> class that you want to use.  If you apply this annotation to the entire <i>View</i> interface, then those methods for which a strategy is not specified will use this strategy. <br><br>  StateStrategy manages the command queue through two methods: <code>void beforeApply</code> and <code>void afterApply</code> .  The first method will be called before the command is sent to the <i>View</i> (the <code>beforeApply</code> method will be called as soon as a command from the <i>Presenter</i> arrives).  At this point, in the default strategy, the command is added to the queue.  The second <code>afterApply</code> method will be called each time the command is applied to the <i>View</i> .  Both in the first and in the second method you can change the list of commands as you like. <br><br>  Let's look at strategies that are already implemented in Moxy: <br><ul><li>  AddToEndStrategy - adds the incoming command to the end of the queue.  <i>Used by default</i> </li><li>  AddToEndSingleStrategy - adds the incoming command to the end of the command queue.  Moreover, if a team of this type is already in the queue, the existing one will be deleted. </li><li>  SingleStateStrategy - clear the entire queue of commands, then add itself to it </li><li>  SkipStrategy - the command will not be added to the queue, and will not change the queue </li></ul><br>  If you have some specific logic and you lack these strategies, then you can make your own strategy.  In this case, the method of tagging methods will help you.  You can pass the tag parameter to the @StateStrategyType annotation (the default is the name of the method).  Then, using this tag, you can see in the <code>void beforeApply(List&lt;ViewCommand&lt;View&gt;&gt; currentState, ViewCommand&lt;View&gt; incomingCommand)</code> and <code>void afterApply(List&lt;ViewCommand&lt;View&gt;&gt; currentState, ViewCommand&lt;View&gt; incomingCommand)</code> that for <code>ViewComand</code> came to you (from the <code>ViewCommand</code> <code>String getTag()</code> method). <br><br>  Before writing your strategies, look at the code already implemented - maybe it will be useful to you. <br><br><h4>  Moxy - <code>MvpDelegate</code> and the life cycle of <code>MvpPresenter</code> </h4><br>  By itself, the <i>Presenter is</i> not created anywhere, is not stored anywhere, and is not available anywhere.  And so that you do not have to invent anything to solve these problems, we made a mechanism such as <code>MvpDelegate</code> .  He ensures that, where his copy is, all <i>Presenters are</i> correctly initialized.  For this, all you have to do is to transfer to it all the main points of the life cycle of your <i>View</i> .  You can see which methods to invoke when in the <code>MvpActivity</code> or <code>MvpFragment</code> . <br><br>  In order for <code>MvpDelegate</code> find all the <i>Presenters</i> , you must annotate them with @InjectPresenter.  This annotation is very powerful.  Through it, you can control how long the <i>Presenter</i> will live.  If you want the <i>Presenter to</i> live for as long as there is a <i>View</i> in which it is contained (+ while the configuration is changing), simply add this annotation to the <i>Presenter</i> field.  In case you want <i>Presenter to</i> live no matter who subscribes to it, you will need to do two things.  The first is to inform <code>MvpDelegate</code> that the <i>Presenter is</i> not tied to the life cycle of the one who requested it.  For this, you need to set the value of the type parameter of the annotation @InjectPresenter as PresenterType.GLOBAL.  The second is that you must pass information to <code>MvpDelegate</code> on which he can find the <i>Presenter</i> you need in the repository of all <i>Presenter</i> .  There are two options for how to do this: <br><br>  First option.  In the @InjectPresenter annotation you set the value for the tag parameter.  Then <i>MvpDelegate</i> will try to find the global <i>Presenter</i> with the tag.  If he finds it, then simply install it in this field.  Otherwise, it will create a suitable <i>Presenter</i> , add it to the repository, and install it in this field.  Taking into account the fact that several <i>Views</i> can be linked to one <i>Presenter</i> , this mechanism opens up many possibilities in front of you. <br><br>  The second option (for the parzimerizirovannogo tag).  In fact, it is similar to the first option.  The only difference is that in the second case you cannot know in advance which <i>Presenter</i> tag will be.  Those.  tag must be generated dynamically.  Then you have to try a little: <br><ol><li>  Create your own <code>PresenterFactory</code> implementation </li><li>  In the @InjectPresenter annotation, set the parameters: <br><ul><li>  In factory, set your <code>PresenterFactory</code> class </li><li>  In presenterId, set the <i>Presenter</i> string identifier (this is necessary to distinguish <i>Presenter</i> classes with the same factories in the same class) </li></ul></li><li>  Get your own interface containing one and only one method that will return a parameter for the desired type of factory: <br><ul><li>  Annotate this interface as @ParamsProvider (PresenterFactoryClass), passing annotations, as a parameter, to the class of your <code>PresenterFactory</code> </li><li>  Describe the method that will return the parameter, should receive one <code>String</code> parameter as input (this parameter will contain the same presenterId parameter from the @InjectPresenter annotation) </li></ul></li><li>  The object that contains a <i>Presenter</i> , in the annotation @InjectPresenter of which this <code>PresenterFactory</code> is indicated, must implement the one created in par.  3. interface </li></ol><br>  Here you should know that you did not think that this place is too confusing.  So it is, it is confused.  Just know that if you need this functionality, follow this short list of rules, and you will understand everything and you will succeed. <br><br>  In addition to the above functionality, <code>MvpDelegate</code> can be a parent / child delegate for another.  This is necessary so that you can automate the <i>Presenter</i> life cycle not only within the Activity / Fragment, but also within other elements that do not have an independent life cycle (for example, in the adapter or even in the <code>ViewHolder</code> of the adapter element).  If you set one <code>MvpDelegate</code> as the parent of another <code>MvpDelegate</code> , then the child delegate will receive all the events of the life cycle of the parent delegate.  To do this, simply call the <code>public void setParentDelegate(MvpDelegate delegate, String childId)</code> method on the target <code>MvpDelegate</code> .  As a <code>delegate</code> he expects to receive the parent <code>MvpDelegate</code> .  As <code>childId</code> , you must specify a unique identifier by which the local <i>Presenter of</i> one delegate-child will differ from the local <i>Presenter of</i> another delegate-child. <br><br>  Note that if the <code>MvpDelegate</code> has already been called on the <code>onCreate</code> .  then you need to call the <code>onCreate</code> method on the <code>onCreate</code> delegate <code>onCreate</code> .  Why is it important?  To understand this, let's see how <code>MvpDelegate</code> works. <br><br>  <code>MvpDelegate</code> in addition to controlling the initialization of the <i>Presenter</i> fields, does another very important thing.  He binds and untips <i>View</i> from <i>Presenter</i> .  Binding the <i>View</i> to the <i>Presenter</i> occurs in the <code>onStart</code> method, and <code>onDestroy</code> in the <code>onDestroy</code> method.  <i><code>Fragment</code> little different, see <a href="">github</a> .</i> <br><div class="spoiler">  <b class="spoiler_title">Why in these methods?</b> <div class="spoiler_text">  After calling <code>onCreate</code> <code>MvpDelegate</code> , all fields marked with the @InjectPresenter annotation are ready to work.  But <i>View</i> is not yet attached to them.  <i>The view</i> will be bound to the <i>Presenter</i> after the <code>MvpDelegate</code> method <code>MvpDelegate</code> <code>void onStart()</code> . <br><br>  After that, the <i>Presenter</i> can interact with the <i>View</i> (and then, if the <i>Presenter was</i> first attached to this <i>View</i> , the <i>Presenter</i> <code>void onFirstViewAttached()</code> method will be called).  After calling <code>void onDestroy()</code> on <code>MvpDelegate</code> , the <i>View</i> will be decoupled from the <i>Presenter</i> .  And then there are two questions.  First, why is <i>View not</i> bound to <i>Presenter</i> in <code>onCreate</code> , but in <code>onStart</code> ?  Secondly, once the binding has happened in <code>onStart</code> , then why is the <code>onStop</code> not in <code>onStop</code> , but in <code>onDestroy</code> ?  Quite reasonable questions.  And the answer to them is that it is a) more convenient, and b) easier.  More conveniently, <i>ViewState</i> is applied to the <i>View</i> as soon as the <i>View has</i> been bound to the <i>Presenter</i> .  And if you bind the <i>View</i> to the <i>Presenter</i> in <code>onCreate</code> , it turns out that you will need to call the <code>onCreate</code> delegate method yourself in the Activity after you complete all the Android View initialization <code>onCreate</code> Activity.  It is not comfortable.  It is convenient to simply make one Activity from which all the activities of your application will inherit, and in the <code>onCreate</code> method of this Activity simply execute the <code>onCreate</code> delegate <code>onCreate</code> .  And taking into account that the view is bound in <code>onStart</code> , there will be no problems.  Secondly, if you unbind the <i>View</i> in <code>onStop</code> , then the binding will definitely happen every time <code>onStart</code> (now the binding of the <i>View</i> occurs in <code>onStart</code> , only if <code>onCreate</code> was done <code>onCreate</code> ).  This means that <i>ViewState</i> will be restored with every <code>onStart</code> .  This means that the entire state will be rolled back anew, even if the Activity View was not destroyed, but simply became invisible for a while.  Therefore, decoupling the <i>View</i> from the <i>Presenter</i> occurs in <code>onDestroy</code> .  <i>Note: <code>onDestroy</code> will not be called if Android decides to kill the Activity process, but in this case the <i>Presenter</i> will be destroyed.</i> </div></div><br>  <code>MvpDelegate</code> uses special storage for the <i>Presenter</i> .  Access to this repository is obtained through <code>MvpFacade</code> .  <code>MvpFacade</code> - contains the <i>Presenter</i> storage and some other elements designed to help <i>MvpDelegate</i> to do its job optimally.  <i>Although MvpFacade</i> is a singleton, it would be great if you run its <code>public static void init()</code> method, for example, in the Application's <code>onCreate()</code> method.  Or you can inherit your Application from <code>MvpApplication</code> supplied in Moxy.  Then at the moment when <code>MvpDelegate</code> turns to this singleton, it will be ready for work. <br><br><h4>  Moxy - <i>Model</i> </h4><br>  An important element of <i>MVP</i> is <i>Model</i> .  But in Moxy, this part of the <i>MVP is</i> in no way affected.  The thing is that this makes no sense.  Each project has its own requirements for <i>Model</i> .  In some <i>places, Model</i> is just a set of classes for working with an API and the work itself with an API (for example, via Retrofit).  Somewhere in the <i>Model also</i> includes additional business logic.  In some projects, the use of the Clean Architecture approach is relevant.  In this case, additional entities appear inside the <i>Model</i> , for example, <i>Interactor</i> and <i>Repository</i> .  And given the fact that <i>Presenter is</i> completely untied from the Activity life cycle, you can safely create an instance of a specific <i>Model</i> inside the <i>Presenter</i> and work with it.  Using DI you can connect the desired <i>Model</i> in <i>Presenter</i> .  And in the future, using the same DI, quietly replace <i>Model</i> for tests. <br><br>  In any case, it is extremely convenient to use Rx to work with the <i>Model</i> .  Then you can make <i>Model's</i> public methods return <code>Observable</code> .  In this case, it will be easy to make the interaction of <i>Model</i> ‚áí <i>Presenter</i> , and at the same time <i>Model</i> ‚áî <i>Model</i> .  This will make it possible to easily make parallel execution of queries from <i>Presenter</i> to <i>Model</i> . <br><br><h2>  Moxy - total </h2><br>  As a result, we have a library that solves all the problems of the life cycle.  You will always show the user exactly the state that is relevant to him, and at the same time, you will not have to do anything extra.  Just describe all the commands for <i>View by</i> separate methods.  And avoid changing the <i>View</i> from the <i>View</i> itself.  If you showed a dialogue with a team from <i>Presenter</i> , then when closing the dialogue, there should be a command from <i>Presenter</i> .  Otherwise, <i>ViewState</i> will show you the dialog again after changing the configuration. <br><br>  I would like to note that the library does not limit you in any way in choosing the implementation of multithreading in your application.  You can use Rx, AsyncTask, Thread, Executor.  The main thing is to be careful, work with <i>View</i> only from the main stream.  Also, Moxy will not solve problems with <code>commit()</code> fragments after running <code>onSaveInstanceState()</code> .  Therefore, remember to close the transaction using <code>commitAllowingStateLoss()</code> .  Also, it will not solve problems with memory leaks - if you pass the link to Context / Activity / Fragment to <i>Presenter</i> (and then to <i>ViewState</i> ), then the memory may leak.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Be careful. </font></font><br><br><h4>  Useful materials </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Moxy would not have turned out the way it turned out if it were not for the numerous works of other people. </font></font> Here are some of them: <br><ul><li> <a href="https://www.youtube.com/watch%3Fv%3DBlkJzgjzL0c"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android Application Architecture (Android Dev Summit 2015)</font></font></a> </li><li> <a href="https://codelabs.developers.google.com/codelabs/android-testing/index.html%3Findex%3D..%252F..%252Fandroid-dev-summit%26viewga%3DUA-69243313-1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android Testing Codelab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> theme is </font><font style="vertical-align: inherit;">not affected much, but you can learn something for yourself. </font><font style="vertical-align: inherit;">You can also see how to test </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li> <a href="https://github.com/konmik/nucleus"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nucleus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an example of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementation </font><font style="vertical-align: inherit;">, with a zamashkoy on the processing of the life cycle.</font></font></li><li> <a href="http://hannesdorfmann.com/mosby/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mosby</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the best </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementation </font><font style="vertical-align: inherit;">before the Moxy release. </font><font style="vertical-align: inherit;">The principles of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which are critical to understand, are </font><font style="vertical-align: inherit;">perfectly written </font><font style="vertical-align: inherit;">.</font></font></li><li> <a href="http://hannesdorfmann.com/android/mosby"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Old Mosby</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a guide to the first version of Mosby. </font><font style="vertical-align: inherit;">Extremely useful for understanding what </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li> <a href="http://hannesdorfmann.com/android/mosby-playbook">STINSON'S PLAYBOOK FOR MOSBY</a> ‚Äì  ,         <i>MVP</i> .    ,   ,    . </li><li> <a href="https://events.yandex.ru/lib/talks/3280/">Android Reactive MVP: </a> ‚Äì   ,     Android-,   <i>MVP</i> </li><li> <a href="https://github.com/android10/Android-CleanArchitecture">Andrtoid Clean Architecture</a> ‚Äì  ,   ,       . </li><li> <a href="https://www.youtube.com/watch%3Fv%3D2zpW2c5NkIQ"> . Speaker Clean Architecture  MVP</a> ‚Äì    Clean Architecture,     . </li><li> <a href="https://github.com/sockeqwe/mosby/issues/85">Mosby issues 85</a> ‚Äì  ,      Repository. </li></ul><br><h4> Moxy ‚Äì   </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To connect Moxy to your project, just add it in dependencies. </font><font style="vertical-align: inherit;">Moxy consists of three parts. </font><font style="vertical-align: inherit;">One of them is responsible for providing you with a Moxy SDK. </font><font style="vertical-align: inherit;">It's pretty easy to connect:</font></font><br><pre> <code class="bash hljs">dependencies{ ... compile <span class="hljs-string"><span class="hljs-string">'com.arello-mobile:moxy:1.1.1'</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to have access to such auxiliary classes as </font></font><code>MvpApplication</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MvpActivity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>MvpFragment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, also connect </font></font><code>moxy-android</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="bash hljs">dependencies{ ... compile <span class="hljs-string"><span class="hljs-string">'com.arello-mobile:moxy-android:1.1.1'</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The other part is responsible for handling annotations and generating code. </font><font style="vertical-align: inherit;">And here you need to decide. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you do not have any special requirements, your project is a normal Android project, and you do not want the generated code to be available from your when, then connect the dependency like this:</font></font><br><pre> <code class="bash hljs">dependencies{ ... provided <span class="hljs-string"><span class="hljs-string">'com.arello-mobile:moxy-compiler:1.1.1'</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to have direct access to the generated code, then you should use </font></font><a href="https://bitbucket.org/hvisser/android-apt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">android-apt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modify your project's build.gradle: </font></font><br><pre> <code class="bash hljs">buildscript { dependencies { classpath <span class="hljs-string"><span class="hljs-string">'com.neenbedankt.gradle.plugins:android-apt:1.4'</span></span> } }</code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modify your application's build.gradle: </font></font><br><pre> <code class="bash hljs">apply plugin: <span class="hljs-string"><span class="hljs-string">'com.neenbedankt.android-apt'</span></span> dependencies { ... apt <span class="hljs-string"><span class="hljs-string">'com.arello-mobile:moxy-compiler:1.1.1'</span></span> }</code> </pre> </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Library sources can be found on Github: </font></font><a href="https://github.com/Arello-Mobile/Moxy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Arello-Mobile/Moxy</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A full example application using Moxy: </font></font><a href="https://github.com/Arello-Mobile/Moxy/tree/master/sample-github"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Arello-Mobile/Moxy/tree/master/sample-github</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At the moment when we compile a representative list of questions on our library, on how to use it, on MVP as a whole, a separate article will be made, which will highlight the most popular / interesting questions. Questions can be asked here in the comments, write to me (@senneco) and another author of the library - </font></font><a href="https://habrahabr.ru/users/xanderblinov/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xanderblinov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Or you can contact the entire Android development </font></font><a href="http://www.arello-mobile.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">department at Arello Mobile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by writing to </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">java-developers@arello-mobile.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the authors of the Moxy </font><a href="https://habrahabr.ru/users/senneco/" class="user_link"><font style="vertical-align: inherit;">senneco</font></a><font style="vertical-align: inherit;"> library</font></font><br> <a href="https://habrahabr.ru/users/senneco/" class="user_link"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><a href="https://habrahabr.ru/users/xanderblinov/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xanderblinov</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/276189/">https://habr.com/ru/post/276189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276171/index.html">Break Windows to fix it: ‚ÄúSeveral attempts were made, but the cause of the problem could not be determined‚Äù</a></li>
<li><a href="../276175/index.html">Automatic installation and configuration of PostgreSQL using Wix #</a></li>
<li><a href="../276179/index.html">WLAN architecture: what to choose?</a></li>
<li><a href="../276185/index.html">XAML Developer Chips: Embedded Converters</a></li>
<li><a href="../276187/index.html">We are implementing an analogue of Apple iCloud Voicemail using free grammars from Yandex</a></li>
<li><a href="../276193/index.html">Finite Volume method - implementation on the example of thermal conductivity</a></li>
<li><a href="../276195/index.html">Algorithms for searching palindromes</a></li>
<li><a href="../276205/index.html">Add instructions to the microprocessor MIPS, which work in the pipeline as his own</a></li>
<li><a href="../276209/index.html">Millimetric is back. Now - Open Source</a></li>
<li><a href="../276211/index.html">The study of common Malvari under Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>