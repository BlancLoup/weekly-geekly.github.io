<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Server optimization for Drupal with measurement results</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="By itself, instructions on where to tweak something on the server so that Drupal can work faster can be found on the Internet in varying degrees of de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Server optimization for Drupal with measurement results</h1><div class="post__text post__text-html js-mediator-article">  By itself, instructions on where to tweak something on the server so that Drupal can work faster can be found on the Internet in varying degrees of detail.  However, all the articles I have encountered had a slight flaw: I did not encounter any real measurements that accompanied the setting.  How does the page generation speed change numerically?  How does memory usage change?  What happens when the number of parallel queries increases?  Let's do an experiment.  Some of the recommendations outlined in the article are general in nature and may be useful for other CMS. <a name="habracut"></a><br><br><h4>  Instead of the preface </h4><br>  The basis of this article is a selection of materials <a href="https://drupal.org/node/2601">Server tuning considerations</a> , posted on the official website of Drupal.  From it, it selects what is most universal in nature and can be applied to an arbitrary server on which Drupal is planned to be used (in particular, sections dealing with the configuration of PHP and MySQL).  This article does not cover the fine tuning of the CMS itself. <br><br><h4>  Experimental model </h4><br>  To test the load, a certain standard heavy site was created.  Drupal 7 and several popular modules were used for this, including Views and Pathauto.  A numeric field was added to one of the types of material, which could take a value from 1 to 10. Using the content generation function of the Devel module, about 10 thousand pages of material of this type were created and from 0 to 15 comments to each post. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, the Views block was created and placed on the main page, selecting 100 random pages, where the field took the value 5 (that is, according to probability theory, 100 out of 1000 pages) along with comments to them.  Global: Random filtering criterion was used to ensure that the page is guaranteed to be re-generated every time it is loaded.  On a personal test server, the generation time of such a page was approximately 10 seconds.  Also, during the preparation, a test online store based on Commerce Kickstarter was raised and about 5 thousand products were generated.  However, it turned out that Global: Random is not at all friendly with the Search API, and without randomization, the page with 96 products loaded significantly faster than the previous test page.  Therefore, measurements on the speed of the online store were not conducted.  Test sites have been moved to ... <br><br><h4>  Experimental equipment </h4><br>  For the experiments, I borrowed the newly installed <a href="http://ua-hosting.com.ua/vds.html">Intel Xeon E3-1230 3.2GHz / 2-3 GB RAM / 30 GB SSD</a> and <a href="http://ua-hosting.com.ua/nl-servers.html">Intel Xeon E3-1230 / 8GB DDR3 / 4x1TB SATA2 / 100Mbps</a> Unmetered <a href="http://ua-hosting.com.ua/vds.html">VPS</a> for several days in the Netherlands (VPS and E3-1230 respectively).  The servers have been configured LAMP + Nginx.  The main part of the measurements was performed by the <a href="httpd.apache.org/docs/2.2/programs/ab.html">ab</a> utility with a total of 1000 queries and the number of parallel queries from 10 to 50. At the end, several Loadimpact tests were also launched. <br><br><h4>  Raw server data </h4><br>  The first measurement was made before the start of any optimization.  Actually, in these measurements I stopped at 40 parallel queries.  The results look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/510/6ba/ffd/5106baffd3deb3e42e473c392da48b47.png"><br>  On this and subsequent graphs on the X axis there will be a share of requests that were served in a time not exceeding the corresponding value on the Y axis. <br><br>  In addition, for the sake of interest, I launched the free Loadimpact test, but it did not create any significant load. <br><br><h4>  PHP optimization </h4><br>  The first thing to do on the server under Drupal is to set the memory_limit value at least 256M in php.ini.  As a rule, this is quite enough for most sites.  But sometimes 128M is not enough.  However, this cannot be called optimization, it is rather a vital necessity. <br><br>  To speed up websites at the PHP level, developers recommend using various caching optimizers.  In other sources, APC is most often mentioned, because I turned to him.  How to put it, you can read in the <a href="http://www.php.net/manual/ru/apc.installation.php">instructions</a> .  Now we are interested in key settings.  Actually, the main parameter is the size of the cache memory segment, apc.shm_size.  The heavier the page, the more different files are connected during execution, the greater must be the value.  For example, 64M was enough for a test site.  And the test store at this value gave an error: <br><br><pre><code class="apache hljs">[<span class="hljs-attribute"><span class="hljs-attribute">Mon</span></span> Jan 13 21:41:46 2014]<span class="hljs-meta"><span class="hljs-meta"> [error] [client 176.36.31.190] PHP Warning: Unknown: Unable to allocate memory for pool. in Unknown on line 0, referer: http://s2shop.1b1.info/products?page=2</span></span></code> </pre> <br>  Raising the value to 256M in an instant removed this problem.  According to the Devel module, for one-time site views, the inclusion of caching affected the following parameters: <br><ul><li>  page generation time was reduced by a half to two times; </li><li>  Peak memory consumption was reduced from approximately 50-55 MB to 30-32 MB for a test site and from approximately 65-70 MB to 30-32 MB for a test store. </li></ul><br>  How the inclusion of APC influenced the results of the bombing with ab will be discussed a little later.  According to publicly available public information, using php-fpm instead of Apache + mod_php gives remarkable results.  However, I have not tried to compare these two configurations yet. <br><br><h4>  MySQL optimization </h4><br>  One of the easiest ways to optimize MySQL is to replace my.cnf with my-huge.cnf.  This file is designed for systems with sufficient (2 GB and above) amount of RAM and large-scale use of MySQL.  In addition, it differs from the standard config file by a significantly larger buffer size (key_buffer_size) and the inclusion of query caching (query_cache_size). <br><br>  The overall change in recoil rate for sequential use looks like this. <br><br>  E3-1230, 10 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/88d/85c/282/88d85c2828f2b4cfb9c0f9dce453f50c.png"><br><br>  VPS, 10 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/c9c/a00/3ec/c9ca003ec2ededb368fc959002971fae.png"><br><br>  E3-1230, 30 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/e45/180/f41/e45180f415d2d88c4ef28594bf73af5a.png"><br><br>  VPS, 30 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/014/270/584/0142705844d7f1a83a67ec13d074d4d6.png"><br><br>  As you can see, the gap between non-optimized MySQL and optimized is more noticeable on VPS than on E3-1230.  I dare to suggest that this is due to the use of SSD drives on a VPS.  Nowadays, server configurations in which databases are placed on SSDs are becoming more and more popular.  Considering how much they have fallen in price recently, such a decision doesn‚Äôt afford much and in many cases makes it possible to significantly speed up the operation of sites.  A plus in favor of SSD, in my opinion, are the two following graphs. <br><br>  E3-1230, 50 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/aa5/774/93a/aa577493a6a964a636f261963af449f3.png"><br><br>  VPS, 50 parallel requests <br><img src="https://habrastorage.org/getpro/habr/post_images/253/9a2/f2a/2539a2f2a115803d8c0bc99ec7cb4f11.png"><br><br>  As you can see, on a server with SATA disks, buffering with caching starts to choke very quickly.  At the same time, on the VPS with SSD disks, the general trend continues.  On the VPS, I tried to further increase the key_buffer_size and query_cache_size values, due to which I received a slight but stable performance increase (MySQL 2 curve).  However, at this stage in both configurations, the processor is already beginning to choke. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f3f/ed9/9b3/f3fed99b399d2f82b5f3452b05aa8f9e.png"><br><br><h4>  LoadImpact Tests </h4><br>  The tests carried out with the help of the ab utility do not show the actual loading of the site pages, but rather a qualitative change in performance.  For some data closer to life, I conducted a couple of tests with <a href="http://loadimpact.com/">Loadimpact</a> . <br><br><ol><li>  The main page of the test site was set on up to 100 SBU, roughly evenly distributed in 5 different locations (2 in the USA, 2 in Europe, 1 in Australia).  The summary graph does not allow you to see if the server has strained this load at least a little. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59a/7c8/26a/59a7c826a51272b94384c35aa85a9375.png"><br><br>  But the increase in load becomes more noticeable if you look at the graphs only on European points, with which connectivity is better. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cc/7f9/357/2cc7f93570a028781ac28211c9b95698.png"><br><br>  At the same time, the total data flow was close to 90 Mbps.  I wanted to catch up with the channel to the shelf, but there were no credits left. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/853/297/ee0/853297ee05c7cec307d685be7aa2bc2e.png"><br><br>  The load on the processor becomes noticeable, however, Load average cannot be compared with ab tests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/29b/a8e/f9f/29ba8ef9f4b6aa82148cbe7f6fb9677b.png"><br></li><li>  In conclusion, I inclined the usual small information SDL and set Loadimpact from 8 different points on it.  All test points accessed different pages of the site.  In 10 minutes the number of SBU also reached 100. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/553/236/1fd/5532361fd74f6a2a07fefd5a2df0ec1b.png"><br><br>  The payoff was very even, with no apparent slowdowns. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/378/0d6/a15/3780d6a15e6b365a4bf3f9b0ae0215a5.png"><br><br>  At the same time, the server of this test almost did not notice. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/493/3db/d0e/4933dbd0e4dd1cd6dfa77fdbbd7282f0.png"></li></ol><br><br><h4>  Instead of conclusion </h4><br>  I considered the impact on the speed of the site only two essential parameters, because I will be grateful to everyone who can give additional useful tips on the subject.  In addition, somewhere 5 days after the publication, the test environments will still be alive, and if you have any other optimization recommendations or testing proposals, I will try to bring them to life and add them to the article during this period.  I urge everyone to share their own optimization experience and their tricks.  And thank you for reading it patiently. </div><p>Source: <a href="https://habr.com/ru/post/208986/">https://habr.com/ru/post/208986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208968/index.html">LED workplace lighting</a></li>
<li><a href="../208970/index.html">The first steps to the universe MeteorJS</a></li>
<li><a href="../208978/index.html">The future of javascript MVC frameworks</a></li>
<li><a href="../208982/index.html">NameTag face recognition program defenders called "creepy"</a></li>
<li><a href="../208984/index.html">Advertising Management (android)</a></li>
<li><a href="../208988/index.html">Google bought the manufacturer of thermostats for $ 3.2 billion</a></li>
<li><a href="../208990/index.html">The transport problem with the partisanship ("with trailers")</a></li>
<li><a href="../208992/index.html">This is Science: Blow and Get Electricity</a></li>
<li><a href="../208994/index.html">Terminology or laid out on the shelves</a></li>
<li><a href="../209000/index.html">Psychological reasons for the emergence of WEB 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>