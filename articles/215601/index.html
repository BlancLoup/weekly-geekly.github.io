<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is there life after the code?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What happens to the code after it is written? In many areas of software development, his life is just beginning. For example, in web development, an a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is there life after the code?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/bf2/b23/074/bf2b23074d5c9d21dbe19af68192eaf5.jpg" align="right">  What happens to the code after it is written?  In many areas of software development, his life is just beginning.  For example, in web development, an application runs somewhere on the server.  So, after writing the code, the task is to integrate it into the application and deliver it to the final machine.  This is the process we will discuss today. <br><br>  This text is intended for a wide circle of developers and is designed for those who are not familiar with the code layout process.  Also this text can be useful to those who build a deployment system and are in search of ideas. <br><br>  The article is written on the basis of materials of the internal seminar of the Aori company, and tells about the principles of deployment using the example of the process that was built with us. <br><a name="habracut"></a><br><br clear="all"><h2>  Where does the deployment begin </h2><br>  In the most general approximation after writing the code, there is one single task - to send the written somewhere, where it will be launched.  That is, roughly speaking, upload it via ftp or ssh. <br>  <i><b>NB</b> If you upload the update site about cats by ftp, this is also deployment.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we do not have cats, but there is Linux, a console and we upload everything via ssh.  This means that the deployment process will be as follows: <br><br><ol><li>  Pack project to archive </li><li>  Send it via ssh to a remote machine </li><li>  Unpack it in the folder where the web server is installed. </li></ol><br><br><h3>  There is a nuance </h3><br>  When we unpack the project on a remote server, we actually overwrite the contents of the folder with a new one.  In an amicable way, you should first clear the folder.  However, then the service during the calculations will be unavailable. <br><br>  Besides, what will we do if we roll out the project with an error?  We will have to roll back the local version, re-perform all the manipulations with the archive upload, and there is a high probability of screwing up in a hurry. <br><br>  There is a very simple solution to these problems - the calculation takes place every time into a new folder, to which the symlink of the same name switches every time: <br><ol><li>  On the remote machine in the home folder of the user, on behalf of whom we work on ssh, creates a directory, for example, versions.  With each build, we create a subdirectory in versions, and unpack the project there. </li><li>  After that we create a symlink to this folder by the name, say, current.  Our web server looks at this symlink.  Thus, switching a project is simply switching a symlink. </li></ol><br><pre><code class="bash hljs">ln -nsf /home/project/versions/{0} /home/project/current</code> </pre> <br>  <i>It is convenient to call the subdirectories versions by the sequence number of the calculation procedure.</i> <br><br><h2>  And one more thing </h2><br>  Most likely, configs for the remote machine need their own.  This means that before packing the project it is necessary to roll the battle configs. <br><br>  Well, if an error occurred during the calculation of one of the steps, the calculation must be stopped. <br><br>  It turns out that in order to lay out the project on a remote machine, the minimum necessary steps will be as follows: <br><ol><li>  Roll up battle configs </li><li>  Pack project </li><li>  Upload project to remote machine </li><li>  Unzip to new folder </li><li>  Switch simlink </li></ol><br>  If any of the steps fail, stop. <br><br><h2>  Automation </h2><br>  It is clear that you do not have to perform these tasks manually, we need some kind of automation, something like a bash script, which we will run for display. <br>  <i><b>NB</b> Basically, a bash script will do as well.</i> <br><br>  In Aori, we use <a href="http://docs.fabfile.org/en/1.8/">Fabric</a> for the final deployment.  This is a python library that allows you to solve the problems listed above using very simple tools. <br><br>  Of the amenities I would like to mention the so-called roles - named groups of machines that allow you to perform some deployment points not on all machines, but only on some.  Let's say we have three roles in the battle environment: statics, web application and scripts.  Accordingly, warming up the cache on machines with statics is not needed, and you need to update the crontab only on scripting machines. <br><br>  Here is a piece of our factory script for an example: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@parallel @roles('web', 'script', 'static') def switch(id): run('ln -nsf /home/project/versions/{0} /home/project/current'.format(id)) @roles('script') def crontab(id): run('crontab /home/project/versions/{0}/build/crontab'.format(id)) @parallel @roles('web', 'script', 'static') def clear(id): with cd('/home/project/versions'): run("ls -1 | grep -E '^[0-9]+$' | sort -n | head -n -3 | xargs -rt rm -rf") def deploy(id): execute(prepare) execute(upload) execute(upload_static, id) execute(build, id) execute(migrate, id) execute(switch, id) execute(crontab, id) execute(clear, id)</span></span></code> </pre><br><br><h3>  Do not forget about git </h3><br>  If you use branches, you at least have a master for the ready-to-send production code, and development, in which everything is committed, is tested and poured into the master as it stabilizes. <br><br>  In this case, development is also laid out somewhere, and it needs its own separate factory script. <br><br><h3>  And about unit tests </h3><br>  Before sending the code, you need to run the tests somewhere, because it is senseless to post a knowingly broken code. <br><br>  So, the list of actions for the calculation of the code increases. <br><br><ol><li>  Set branch for calculations. </li><li>  Set the build number for this thread </li><li>  Pull changes to this thread from the common repository </li><li>  Run unit tests </li><li>  Roll configs for this branch </li><li>  Pack project </li><li>  Pour to the remote machine corresponding to this thread </li><li>  Unzip to new folder </li><li>  Switch simlink </li></ol><br>  If at any of the stages an error occurred, stop. <br><br>  Well, once we do everything in the mind, then <br><ol><li>  Developers should not have ssh access on production machines </li><li>  Developers should not have access to production configs </li><li>  The deployment branch should roll out immediately after the commit so that the test application is always available for testing. </li><li>  If an error occurs during the display, the letter should fall into the mail of the developers. </li></ol><br>  It seems that we need another tool, because to carry out all these actions with our hands, even with a set of factories, is unthinkable. <br><br><h2>  Another tool </h2><br>  The tool that will help us is called <a href="http://en.wikipedia.org/wiki/Continuous_integration">Continuous Integration Server</a> and, in fact, deals with the fact that on command, on schedule or on external event, it extracts the fresh code of the specified repository, and then executes the listed set of commands.  We use <a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529">Jenkins</a> as a tool for CI. <br><br>  It is important to understand that the continuous integration server itself of the above tasks is able to do only the increment counter of assemblies and send a letter in case of failure.  To run unit tests, roll up configs and other useful things you need another tool that performs advanced functions of the bash script. <br><br><h2>  Separate build scripts </h2><br>  If for deployment we took factories, then for the tasks of assembling a project we use <a href="http://www.phing.info/">Phing</a> .  Firstly, it is convenient, secondly, jenkins integrates well with it, and, in the third, it has happened historically. <br><br>  Here are examples of the tasks our Fing solves: <br>  <code>phing build</code> - project build <br>  <code>phing gerrit-phpcs</code> - check for code standards <br>  <code>phing copy-production-configs</code> - get production-machine configs from a closed repository <br>  <code>phing write-version</code> - save to the timestamp file of the current build. <br><br>  But the full path of our code from the development branch to the test server: <br><br>  Fing works first.  All actions occur in the jenkins local folder: <br><ol><li>  Make checkout branches </li><li>  We look at the changes between the last successful build and this one (the sha of the last successful build, as well as many other useful information, can be obtained via jenkins api and <a href="https://wiki.jenkins-ci.org/display/JENKINS/Building%2Ba%2Bsoftware%2Bproject">jenkins variables</a> ). </li><li>  If the changes concern only js-applications, we do not run unit tests. </li><li>  If not, create an empty test database with a unique name.  This allows you to run assemblies in parallel. </li><li>  We roll migration.  The structure of the database and their changes we keep in the form of migrations </li><li>  We run tests </li><li>  Remove the base </li><li>  We roll configs </li><li>  We write the timestamp of the current assembly.  This is needed to invalidate the cache. </li><li>  Run the factories </li></ol><br>  The factory is responsible for sending the code to the end machines.  The sequence of actions is as follows: <br><ol><li>  We pack the project </li><li>  We spread on cars </li><li>  Starting migrations </li><li>  Switch the symlink </li><li>  We update crontab </li><li>  Remove old versions except last three </li></ol><br><br><h2>  Codream </h2><br>  In conclusion, I would like to talk about solutions for code inspections. <br><br>  In the simplest form, a review can be carried out over the shoulder of your employee and give comments orally.  You can also watch the developer commit, and write comments on the ticket.  In principle, in some cases this is sufficient, but there are specialized tools that allow to simplify the inspection process and combine it with automatic checks. <br><br>  We use <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529">Gerrit</a> in our development. <br><br>  The main advantage of Gerrit is that it integrates closely with git, becoming, in fact, a git-server.  After that, through Gerrit's web interface, you can not only perform the actual review, but also manage the rights to git.  Thus, ordinary developers do not have the right to direct push to development or master, they can only send changesets for review by running the script <code><a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529"></a> <a href="http://habrahabr.ru/post/114745/"></a> <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529"></a> <a href="http://habrahabr.ru/company/badoo/blog/147508/"></a> <a href="http://docs.fabfile.org/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://www.phing.info/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://en.wikipedia.org/wiki/Continuous_integration"></a> git review <br> <i><b>NB</b>    ,    ,  -  ,       .  ,    ,    submit     ,      git review.</i> <br> <br>      -.        ,     :   "   ,  "        .       -     . <br> <br>  <br>       ,        - . , github          .   , ,   , -  ,   ,      ,        . <br> <br>   <br> Jenkins - Wikipedia <br> Jenkins + Python -     <br> Gerrit - Wikipedia <br> Gerrit   -         <br> Fabric -    <br>   Fabric <br> Phing -   <br>    Phing   <br> Continuous Integration - Wikipedia</code> <h2> <code><a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529"></a> <a href="http://habrahabr.ru/post/114745/"></a> <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529"></a> <a href="http://habrahabr.ru/company/badoo/blog/147508/"></a> <a href="http://docs.fabfile.org/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://www.phing.info/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://en.wikipedia.org/wiki/Continuous_integration"></a> git review <br> <i><b>NB</b>    ,    ,  -  ,       .  ,    ,    submit     ,      git review.</i> <br> <br>      -.        ,     :   "   ,  "        .       -     . <br> <br>  <br>       ,        - . , github          .   , ,   , -  ,   ,      ,        . <br> <br>   <br> Jenkins - Wikipedia <br> Jenkins + Python -     <br> Gerrit - Wikipedia <br> Gerrit   -         <br> Fabric -    <br>   Fabric <br> Phing -   <br>    Phing   <br> Continuous Integration - Wikipedia</code> </h2> <code><a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529"></a> <a href="http://habrahabr.ru/post/114745/"></a> <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529"></a> <a href="http://habrahabr.ru/company/badoo/blog/147508/"></a> <a href="http://docs.fabfile.org/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://www.phing.info/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://en.wikipedia.org/wiki/Continuous_integration"></a> git review <br> <i><b>NB</b>    ,    ,  -  ,       .  ,    ,    submit     ,      git review.</i> <br> <br>      -.        ,     :   "   ,  "        .       -     . <br> <br>  <br>       ,        - . , github          .   , ,   , -  ,   ,      ,        . <br> <br>   <br> Jenkins - Wikipedia <br> Jenkins + Python -     <br> Gerrit - Wikipedia <br> Gerrit   -         <br> Fabric -    <br>   Fabric <br> Phing -   <br>    Phing   <br> Continuous Integration - Wikipedia</code> <h2> <code><a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529"></a> <a href="http://habrahabr.ru/post/114745/"></a> <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529"></a> <a href="http://habrahabr.ru/company/badoo/blog/147508/"></a> <a href="http://docs.fabfile.org/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://www.phing.info/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://en.wikipedia.org/wiki/Continuous_integration"></a> git review <br> <i><b>NB</b>    ,    ,  -  ,       .  ,    ,    submit     ,      git review.</i> <br> <br>      -.        ,     :   "   ,  "        .       -     . <br> <br>  <br>       ,        - . , github          .   , ,   , -  ,   ,      ,        . <br> <br>   <br> Jenkins - Wikipedia <br> Jenkins + Python -     <br> Gerrit - Wikipedia <br> Gerrit   -         <br> Fabric -    <br>   Fabric <br> Phing -   <br>    Phing   <br> Continuous Integration - Wikipedia</code> </h2> <code><a href="http://en.wikipedia.org/wiki/Jenkins_%2528software%2529"></a> <a href="http://habrahabr.ru/post/114745/"></a> <a href="http://en.wikipedia.org/wiki/Gerrit_%2528software%2529"></a> <a href="http://habrahabr.ru/company/badoo/blog/147508/"></a> <a href="http://docs.fabfile.org/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://www.phing.info/"></a> <a href="http://habrahabr.ru/post/141271/"></a> <a href="http://en.wikipedia.org/wiki/Continuous_integration"></a> git review <br> <i><b>NB</b>    ,    ,  -  ,       .  ,    ,    submit     ,      git review.</i> <br> <br>      -.        ,     :   "   ,  "        .       -     . <br> <br>  <br>       ,        - . , github          .   , ,   , -  ,   ,      ,        . <br> <br>   <br> Jenkins - Wikipedia <br> Jenkins + Python -     <br> Gerrit - Wikipedia <br> Gerrit   -         <br> Fabric -    <br>   Fabric <br> Phing -   <br>    Phing   <br> Continuous Integration - Wikipedia</code> </div><p>Source: <a href="https://habr.com/ru/post/215601/">https://habr.com/ru/post/215601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215581/index.html">As I bought, I finished and set up a Chinese 3D printer Wanhao Duplicator 4</a></li>
<li><a href="../215585/index.html">Network detectives: looking for the causes of traffic surges and load</a></li>
<li><a href="../215587/index.html">About the correct work of BA in a financial institution</a></li>
<li><a href="../215591/index.html">Automate the installation of many apk files on Android</a></li>
<li><a href="../215597/index.html">The note. On the lag of information progress from technological</a></li>
<li><a href="../215603/index.html">Spritz speed reading on any site</a></li>
<li><a href="../215605/index.html">Beginner Patterns: MVC vs MVP vs MVVM</a></li>
<li><a href="../215607/index.html">AngularJS and ReactJS or how to make your application faster</a></li>
<li><a href="../215611/index.html">Natural language highlighting</a></li>
<li><a href="../215613/index.html">On the role of Albanian in testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>