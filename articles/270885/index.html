<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flytouch 2 / Superpad III and an attempt to save bytes in the Linux kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had planned to write this article a long time ago, but in the last months I could not find enough time. While I was pondering over the article, maki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flytouch 2 / Superpad III and an attempt to save bytes in the Linux kernel</h1><div class="post__text post__text-html js-mediator-article">  I had planned to write this article a long time ago, but in the last months I could not find enough time.  While I was pondering over the article, making examples and checking my guesses, constancy was already discussed on Habr√© - <sup><a name="cite_ref-abbyy-circle"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[one]</a></sup> <sup><a name="cite_ref-unique-consts"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[2]</a></sup> . <br><br>  For fun, let's try to make such savings not with a spherical project in a vacuum, but with the most living and ambitious project - with the Linux kernel! <br><a name="habracut"></a><br>  The article has the following structure: <br><ol><li><a name="toc-intro"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">Prehistory</a> </li><li><a name="toc-flytouch2"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">Flytouch 2 / Superpad III Tablet</a> <br><ul><li><a name="toc-firmware"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">firmware</a> </li><li><a name="toc-kernel"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">kernel assembly</a> </li></ul></li><li><a name="toc-constness"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">Constancy</a> </li><li><a name="toc-measurement"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">Measurements</a> </li><li><a name="toc-conclusion"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">Conclusion</a> </li><li><a name="toc-sources"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">List of sources</a> </li></ol><br>  In theory, the article could be divided into two parts: the technical details about the tablet and the use of extern const in the Linux kernel.  It seems to me that then full-fledged publications would not work, so I combined all the material into one article. <br><br><a name="intro"></a><h4>  <font color="#2B7BAE">Background</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br>  Back in 2011, I was reading a lot of reviews about Chinese countries - <sup><a name="cite_ref-zt180"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[3]</a></sup> <sup><a name="cite_ref-zt180-10"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[four]</a></sup> <sup><a name="cite_ref-wowpad"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[5]</a></sup> .  Naturally, I wanted such a miracle and I ordered it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I played a little, looked at the cinema, thought about mahjong and ... And soon my opinion became alternative to the previous one - <sup><a name="cite_ref-good-review"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[6]</a></sup> . <br><br>  After that, it was decided to study the tablet from the programmer's point of view, namely, to install the usual Linux there, to compile something. <br><br><a name="flytouch2"></a><h4>  <font color="#2B7BAE">Flytouch 2 / Superpad III</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br>  Everything described above is valid for a china card with such identifying signs: <div class="spoiler">  <b class="spoiler_title">to show</b> <div class="spoiler_text">  DF-MID10-IX210-V1.1 <br>  2010-01-20 <br><br>  XW11070501B512M03101 <br></div></div><br>  Here <sup><a name="cite_ref-geek-porn"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[8]</a></sup> Geek porn available.  In the pictures you can clearly see the findings of JTAG &amp; USART.  Also note the labeling. <br><br><a name="firmware"></a><h5>  <font color="#2B7BAE">Firmware</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h5><br>  To flash the device, you need to upload files with the names firmware2, firmware-discovery, bootloader-discovery onto the SD card with the FAT file system;  Insert it into the slot and turn on the tablet.  (It worked for me with a 256MB flash drive and a W95 FAT32 file system - identifier 0xB in fdisk). <br><br>  You will need a working firmware.  Although the subject of the article has long been outdated, you can still find a working version here - <sup><a name="cite_ref-review-firmwares"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[12]</a></sup> .  I took the version of Axlien. <br><br>  Files Purpose: <ol><li>  * -discovery files are just zip archives with the necessary data for updating.  firmware-discovery contains everything related to Android.  I can‚Äôt say anything about the bootloader - it didn‚Äôt come across to me, but one can guess from the name that this is an update of the bootloader - it‚Äôs not clear which one; </li><li>  firmware2 file is of the greatest interest.  At that time, I did not find any references to the format of this file anywhere on the network.  I thought, well, the Chinese cannot, and even for such cheap junk, create a powerful system based on cryptography ... and it turned out to be right!  The first 192 bytes are just garbage.  You can take firmware2 from the working firmware and wipe the specified header with zeros - the firmware update process will still start <sup><a name="cite_ref-firmware2"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[10]</a></sup> .  Next comes the usual U-Boot image, the parameters of which can be obtained using mkimage. </li></ol><br>  Thus, if you build your own working core (zImage) for a tablet, create a U-Boot image with the same parameters and add a 192-byte header, you will be able to load your version of Linux. <br><br>  It is also possible to play with the "official" firmware2.  There are tools for unpacking and back-packing the zImage file <sup><a name="cite_ref-zimage-tools"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[9]</a></sup> .  You can unpack and examine the device update scripts, in particular, to understand what is updating the bootloader-discovery and how.  On the other hand, it is possible to disable the mentioned scripts and be in the busybox shell. <br><br><a name="kernel"></a><h5>  <font color="#2B7BAE">Kernel build</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h5><br>  In search of the kernel sources for this processor, I came across a discussion <sup><a name="cite_ref-zt180-sources"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[13]</a></sup> , where someone atp_uestc reported the discovery of the kernel sources for the ZT-180 tablet. <br><br>  Now it is difficult for me to remember the chronology of events and what core I tried to load first: either ‚Äúvanilla‚Äù from here - <sup><a name="cite_ref-atpboy444-zt-180"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[14]</a></sup> , whether modified from here - <sup><a name="cite_ref-dandel-linux"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[15]</a></sup> .  Only the result was remembered - it did not work, the boot process froze on the ‚ÄúDecompressing kernel ...‚Äù <br><br>  After some time, yuray appeared in the discussion, adding support for this processor to the third version of the Linux kernel.  It was this version of the kernel that I was able to launch in Chinese. <br><br>  Download source 3.4.x kernel sources from <a href="http://kernel.org/">kernel.org</a> .  At the time of this writing, version 3.4.108 and below was successfully compiled.  Download and apply kernel patches from yuray from here <a href="">rtck.org/zt180/patches/zt180_b0_3.4.patch.xz</a> : <pre><code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/linux-3.4.x $ patch -p1 -i /path/to/zt180_b0_3.4.patch</code> </pre> <br>  Configure the config.  I haven‚Äôt met the correct config for this Chinese, so I suggest taking the dot-config from here <sup><a name="cite_ref-helper-scripts"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[19]</a></sup> : <pre> <code class="bash hljs">$ make V=1 ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- oldconfig</code> </pre><br>  Kernel will require initramfs.  I am a user of the Slackware GNU / Linux OS, so it was decided to take the installer's initrd out of it in order to later install the slak on the tablet.  Load uinitrd-kirkwood.img <sup><a name="cite_ref-ftp-slackwarearm"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[16]</a></sup> , there are also commands for unpacking the image in the kernels / README.txt file.  From the original, the image is weak;  contains binaries for x86 / amd64, but we need them for ARM. <br><br>  Create a folder, unpack the image into it: <pre> <code class="bash hljs">$ mkdir -p /path/to/uinitrd.extracted $ <span class="hljs-built_in"><span class="hljs-built_in">pushd</span></span> !$ $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/path/to/uinitrd-kirkwood.img bs=64 skip=1 | gzip -dc | sudo cpio -div $ <span class="hljs-built_in"><span class="hljs-built_in">popd</span></span></code> </pre><br>  Specify the path to the folder with the image in the config: <br>  # ... <br>  CONFIG_BLK_DEV_INITRD = y <br>  CONFIG_INITRAMFS_SOURCE = "/ path / to / uinitrd.extracted" <br>  CONFIG_INITRAMFS_ROOT_UID = 0 <br>  CONFIG_INITRAMFS_ROOT_GID = 0 <br>  # ... <br><br>  Compile the kernel in two passes: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># clean initrd directory $ sudo rm -rf /path/to/uinitrd.extracted/lib/{modules, firmware} # build kernel for the first time $ make KALLSYMS_EXTRA_PASS=1 ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- -j2 zImage # build modules against the kernel $ make KALLSYMS_EXTRA_PASS=1 ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- -j2 modules # install modules into initramfs dir $ sudo make ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- -j2 modules_install INSTALL_MOD_PATH=/path/to/uinitrd.extracted/ # install firmware to initramfs folder $ sudo make ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- -j2 firmware_install INSTALL_MOD_PATH=/path/to/uinitrd.extracted/ # remove unnecessary files $ sudo rm -rf /path/to/uinitrd.extracted/lib/modules/3.4.*/{build,source} # build the kernel again, with initramfs dir contains modules $ make KALLSYMS_EXTRA_PASS=1 ARCH=arm CROSS_COMPILE=/path/to/toolchain/arm-infotm-linux-gnueabi- -j2 zImage</span></span></code> </pre><br>  Can get out the error <sup><a name="cite_ref-build-issue-1"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[17]</a></sup> <sup><a name="cite_ref-build-issue-2"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[18]</a></sup> .  I was helped by the solution that is proposed in the text of the error: the parameter KALLSYMS_EXTRA_PASS = 1. <br><br>  Then we create firmware2: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make u-boot image $ /path/to/mkimage -A arm -C none -O linux -T kernel -a 0x40008000 -e 0x40008000 -n linux-3.4 -d arch/arm/boot/zImage arch/arm/boot/uImage # make firmware2 $ cat /path/to/firmware2.header arch/arm/boot/uImage &gt; firmware2</span></span></code> </pre>  and load the tablet from it. <br><br>  A script was written to automate the build. <sup><a name="cite_ref-helper-scripts-2"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[19]</a></sup> .  The following command was used: <pre> <code class="bash hljs">$ ( time ./my_build.sh ) |&amp; tee `date +%M%H_%F`-build-log.txt</code> </pre><br>  Loaded - YUSB does not work, more precisely, there was no power at the ports.  I asked for help from yuray, to which he replied that most likely the layout of my china map has a different layout, different from the ZT-180. <br><br>  Then I found this great article. <sup><a name="cite_ref-disassembly"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[11]</a></sup> how to disassemble parts of the working core.  I decided to restore the code of functions of the ‚Äúoriginal‚Äù firmware related to USB and compare them with the versions in the source code.  To my disappointment, the functions matched up to digraphs.  However, the working core had functions that were not in the source code.  Apparently there lies some magic that inspires life in USB ports, but I left it under the veil of secrecy ... <br><br>  In the process of studying the restored assembler code, I noticed one interesting point: in many functions, strange instructions followed their epilogue: <pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> c039e32c: e59f0030 ldr r0, [pc, <span class="hljs-meta"><span class="hljs-meta">#48] ; c039e364 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;_binary_0xc039e2e8_imapx200_decode_suspend_start+0x7c&gt;</span></span></span><span class="hljs-meta"> /* ... */ c039e360: e89da800 ldm sp, {fp, sp, pc} c039e364: f0200000 undefined instruction 0xf0200000 c039e368: c24b1c9c subgt r1, fp, #39936 ; 0x9c00</span></span></code> </pre><br>  See the 0xF0200000?  Strange vague instructions ... and even found in several places.  This is a kind of base address, I thought, which means that theoretically it is possible to save 4 (four!) Bytes with each such function: place this value in one place, and all functions will load it at one address - get a constant! <br><br><a name="constness"></a><h4>  <font color="#2B7BAE">Constancy</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br>  By meyers <sup><a name="cite_ref-scott-meyers"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[20]</a></sup> everything is very well written.  I will give only some explanations. <br><br>  Compilers of C and C ++ languages ‚Äã‚Äãare one-pass, and therefore cannot independently optimize constants.  At a minimum, help from the linker is required, for example, the / Gw parameter <sup><a name="cite_ref-abbyy-circle-2"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[1]</a></sup> . <br><br>  The same one-pass weakness can play into the hands: use extern const <sup><a name="cite_ref-abbyy-circle-3"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[1]</a></sup> .  The idea is to describe the constant in the header file as follows: <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> MY_CONST_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MY_CONST_H extern const int my_constant; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* MY_CONST_H */</span></span></span></span></code> </pre><br>  Then write a line in some file: <pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> my_constant = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre>  This can be placed in any translation unit.  Now the compiler will not be able to sew the value of the constant into the code, but will have to make some reference to it.  The linker will receive only one object file, in which there will be a constant value, and then substitute the final addresses into the code.  Of course there may be options, but in general, the compiler alone is helpless before such a trick and is forced to do what is described above.  However, there is a small nuance <sup><a name="cite_ref-global-order"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[21]</a></sup> . <br><br>  For the experiment, you will need to make the following edits. <sup><a name="cite_ref-helper-scripts-3"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[19]</a></sup> : <div class="spoiler">  <b class="spoiler_title">to show</b> <div class="spoiler_text"><pre> <code class="diff hljs">diff -ru ./linux-3.4.108/arch/arm/mach-imapx200/Makefile ../linux-3.4.108/arch/arm/mach-imapx200/Makefile --- ./linux-3.4.108/arch/arm/mach-imapx200/Makefile 2015-09-09 12:17:52.483020878 +0300 +++ ../linux-3.4.108/arch/arm/mach-imapx200/Makefile 2015-09-08 17:11:45.775035963 +0300 @@ -6,7 +6,7 @@ #IMAPX200 support files -obj-$(CONFIG_CPU_IMAPX200) += irq.o clock.o time.o devices.o pwm.o +obj-$(CONFIG_CPU_IMAPX200) += irq.o clock.o time.o devices.o pwm.o constants.o diff -ru ./linux-3.4.108/arch/arm/mach-imapx200/include/mach/imapx_base_reg.h ../linux-3.4.108/arch/arm/mach-imapx200/include/mach/imapx_base_reg.h --- ./linux-3.4.108/arch/arm/mach-imapx200/include/mach/imapx_base_reg.h 2015-09-09 12:17:52.498020874 +0300 +++ ../linux-3.4.108/arch/arm/mach-imapx200/include/mach/imapx_base_reg.h 2015-09-08 17:11:45.778035706 +0300 @@ -15,13 +15,23 @@ #define IMAPX200_SDRAM_PA (0x40000000) /<span class="hljs-comment"><span class="hljs-comment">************************Virtual address for peripheral*************************/ -#define IMAP_VA_SYSMGR IMAP_ADDR(0x00200000) -#define IMAP_VA_IRQ IMAP_ADDR(0x00000000) -#define IMAP_VA_TIMER IMAP_ADDR(0x00300000) -#define IMAP_VA_WATCHDOG IMAP_ADDR(0x00600000) -#define IMAP_VA_GPIO IMAP_ADDR(0x00400000) -#define IMAP_VA_NAND IMAP_ADDR(0x00500000) -#define IMAP_VA_FB IMAP_ADDR(0x00700000) +#if defined(IMAP_USE_MACRO_CONSTANTS) || defined(__ASSEMBLY__) +# define IMAP_VA_SYSMGR IMAP_ADDR(0x00200000) +# define IMAP_VA_IRQ IMAP_ADDR(0x00000000) +# define IMAP_VA_TIMER IMAP_ADDR(0x00300000) +# define IMAP_VA_WATCHDOG IMAP_ADDR(0x00600000) +# define IMAP_VA_GPIO IMAP_ADDR(0x00400000) +# define IMAP_VA_NAND IMAP_ADDR(0x00500000) +# define IMAP_VA_FB IMAP_ADDR(0x00700000) +#else +extern const void __iomem __force * const IMAP_VA_SYSMGR; +extern const void __iomem __force * const IMAP_VA_IRQ; +extern const void __iomem __force * const IMAP_VA_TIMER; +extern const void __iomem __force * const IMAP_VA_WATCHDOG; +extern const void __iomem __force * const IMAP_VA_GPIO; +extern const void __iomem __force * const IMAP_VA_NAND; +extern const void __iomem __force * const IMAP_VA_FB; +#endif /* defined(IMAP_USE_MACRO_CONSTANTS) || defined(__ASSEMBLY__) */ #define PERIPHERAL_BASE_ADDR_PA (0x20C00000) diff -ru ./linux-3.4.108/arch/arm/plat-imap/cpu.c ../linux-3.4.108/arch/arm/plat-imap/cpu.c --- ./linux-3.4.108/arch/arm/plat-imap/cpu.c 2015-09-09 12:17:52.607021038 +0300 +++ ../linux-3.4.108/arch/arm/plat-imap/cpu.c 2015-09-08 17:18:30.646035384 +0300 @@ -1,3 +1,5 @@ +#define IMAP_USE_MACRO_CONSTANTS + /******************************************************************************** ** linux-2.6.28.5/arch/arm/plat-imap/cpu.c ** diff -ru ./linux-3.4.108/arch/arm/plat-imap/gpio.c ../linux-3.4.108/arch/arm/plat-imap/gpio.c --- ./linux-3.4.108/arch/arm/plat-imap/gpio.c 2015-09-09 12:17:52.614020935 +0300 +++ ../linux-3.4.108/arch/arm/plat-imap/gpio.c 2015-09-08 17:18:38.566035206 +0300 @@ -1,3 +1,5 @@ +#define IMAP_USE_MACRO_CONSTANTS + /* arch/arm/plat-imapx200/gpiolib.c * * Copyright 2008 Openmoko, Inc. diff -ru ./linux-3.4.108/arch/arm/plat-imap/pm_imapx200.c ../linux-3.4.108/arch/arm/plat-imap/pm_imapx200.c --- ./linux-3.4.108/arch/arm/plat-imap/pm_imapx200.c 2015-09-09 12:17:52.631020886 +0300 +++ ../linux-3.4.108/arch/arm/plat-imap/pm_imapx200.c 2015-09-08 17:18:52.102036874 +0300 @@ -1,3 +1,5 @@ +#define IMAP_USE_MACRO_CONSTANTS + #include &lt;linux/init.h&gt; #include &lt;linux/suspend.h&gt; #include &lt;linux/serial_core.h&gt; diff -ru ./linux-3.4.108/drivers/video/infotm/imapfb.c ../linux-3.4.108/drivers/video/infotm/imapfb.c --- ./linux-3.4.108/drivers/video/infotm/imapfb.c 2015-09-09 12:17:53.350020920 +0300 +++ ../linux-3.4.108/drivers/video/infotm/imapfb.c 2015-09-08 17:34:34.814042727 +0300 @@ -1,3 +1,5 @@ +#define IMAP_USE_MACRO_CONSTANTS + /***************************************************************************** ** drivers/video/infotm/imapfb.c ** diff -ru --new-file ./linux-3.4.108/arch/arm/mach-imapx200/constants.c ../linux-3.4.108/arch/arm/mach-imapx200/constants.c --- ./linux-3.4.108/arch/arm/mach-imapx200/constants.c 1970-01-01 03:00:00.000000000 +0300 +++ ../linux-3.4.108/arch/arm/mach-imapx200/constants.c 2015-09-09 14:56:53.513487879 +0300 @@ -0,0 +1,11 @@ +#include &lt;linux/compiler.h&gt; + +#include &lt;mach/imapx_base_reg.h&gt; + +const void __iomem __force * const IMAP_VA_SYSMGR = IMAP_ADDR(0x00200000); +const void __iomem __force * const IMAP_VA_IRQ = IMAP_ADDR(0x00000000); +const void __iomem __force * const IMAP_VA_TIMER = IMAP_ADDR(0x00300000); +const void __iomem __force * const IMAP_VA_WATCHDOG = IMAP_ADDR(0x00600000); +const void __iomem __force * const IMAP_VA_GPIO = IMAP_ADDR(0x00400000); +const void __iomem __force * const IMAP_VA_NAND = IMAP_ADDR(0x00500000); +const void __iomem __force * const IMAP_VA_FB = IMAP_ADDR(0x00700000);</span></span></code> </pre></div></div><br><a name="measurement"></a><h4>  <font color="#2B7BAE">Measurements</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br>  It was decided to measure two indicators: <ul><li>  vmlinux kernel file size; </li><li>  calculate the size of the functions directly during the operating system. </li></ul><br>  A script that counts the size of all functions containing an imap subword is here. <sup><a name="cite_ref-helper-scripts-4"></a></sup>  <sup><a href="https://habr.com/ru/company/simbirsoft/blog/270885/">[19]</a></sup> . <br><br>  The results are as follows: <div class="spoiler">  <b class="spoiler_title">to show</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># diff -ru 1.log 2.log</span></span></code> </pre> <pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- 1.log 2015-09-11 16:57:28.430158628 +0300 +++ 2.log 2015-09-11 16:57:20.627161803 +0300 @@ -1,4 +1,4 @@ -Data Size: 17844272 Bytes = 17426.05 kB = 17.02 MB +Data Size: 17843856 Bytes = 17425.64 kB = 17.02 MB Load Address: 0x40008000 Entry Point: 0x40008000 --- 22012015-rom/sizes.txt 2015-01-28 15:25:51.107945315 +0300 +++ 28012015-rom/sizes.txt 2015-01-28 15:15:48.052949785 +0300 @@ -1,25 +1,25 @@ -imapx200_timer_mask - 44 -imapx200_timer_unmask - 52 -imapx200_timer_ack - 44 +imapx200_timer_mask - 52 +imapx200_timer_unmask - 60 +imapx200_timer_ack - 52 imapx200_irq_add - 24 imapx200_irq_init - 32 imapx200_irq_wake - 44 -imapx200_irq_unmask - 136 -imapx200_irq_mask - 132 -imapx200_irq_ack - 120 +imapx200_irq_unmask - 172 +imapx200_irq_mask - 160 +imapx200_irq_ack - 152 imap_clk_enable - 60 imap_clkcon_enable - 76 -imapx200_gettimeoffset - 64 -imapx200_timer_setup - 164 -imapx200_timer_interrupt - 64 +imapx200_gettimeoffset - 68 +imapx200_timer_setup - 168 +imapx200_timer_interrupt - 76 imap_pwm_suspend - 188 imap_pwm_resume - 184 imap_pwm_start - 164 imap_timer_setup - 404 imap_default_idle - 20 -imapx_poweroff - 56 -imapx_reset - 64 -imapx200_idle - 52 +imapx_poweroff - 88 +imapx_reset - 68 +imapx200_idle - 48 imap_set_board - 112 imapx200_gpio_setpull_updown - 56 imapx200_gpio_getpull_updown - 36 @@ -48,7 +48,7 @@ imapx200_pm_prepare - 24 imapx200_pm_finish - 20 imapx200_pm_do_save - 88 -imapx200_pm_enter - 436 +imapx200_pm_enter - 500 imapx200_pm_configure_extint - 20 imapx200_pm_prepare - 24 imapx200_pm_init - 80 @@ -86,8 +86,8 @@ imapfb_resume - 196 imapfb_suspend - 204 imapfb_backlight_power_supply - 20 -imapfb_set_clk - 44 -imapfb_set_gpio - 88 +imapfb_set_clk - 52 +imapfb_set_gpio - 96 imapfb_set_brightness - 36 imapfb_lcd_power_supply - 32 con_get_unimap - 360 @@ -153,7 +153,7 @@ imap_nand_irq - 92 ehci_imapx200_drv_remove - 80 ehci_imapx200_init - 1148 -ehci_imapx200_drv_probe - 552 +ehci_imapx200_drv_probe - 556 ohci_hcd_imapx200_drv_remove - 80 ohci_imapx200_start - 100 ohci_hcd_imapx200_drv_probe - 512 @@ -196,22 +196,22 @@ imapx200_i2c_probe - 824 imapx200_i2c_irq - 920 imapx200_decode_poll - 184 -imapx200_decode_suspend - 132 +imapx200_decode_suspend - 44 imapx200_decode_resume - 68 -imapx200_decode_release - 192 +imapx200_decode_release - 104 imapx200_decode_open - 124 imapx200_decode_remove - 208 imapx200_decode_ioctl - 384 -imapx200_decode_probe - 908 +imapx200_decode_probe - 816 imapx200_decode_irq_handle - 264 imapx200_encode_poll - 84 -imapx200_encode_suspend - 116 +imapx200_encode_suspend - 28 imapx200_encode_ioctl - 348 imapx200_encode_resume - 68 -imapx200_encode_release - 188 +imapx200_encode_release - 100 imapx200_encode_open - 120 imapx200_encode_remove - 232 -imapx200_encode_probe - 1080 +imapx200_encode_probe - 988 imapx200_encode_irq_handle - 136 sdhci_imap_set_clk_src - 52 sdhci_imap_resume - 36 @@ -220,7 +220,7 @@ sdhci_imap_get_timeout_clk - 40 imapfb_probe - 2952 imapfb_init - 28 -sdhci_imap_probe - 604 +sdhci_imap_probe - 608 sdhci_imap_remove - 20 name_imapx200 - 12 imapfb_a1rgb232_8 - 48 @@ -342,8 +342,8 @@ __kstrtab_imap_get_reservemem_paddr - 26 __kstrtab_con_copy_unimap - 16 __kstrtab_con_set_default_unimap - 23 -imapx200_init_clocks - 1120 -imapx200_timer_init - 120 +imapx200_init_clocks - 1104 +imapx200_timer_init - 124 imapx200_register_device - 56 imap_init_pwm - 308 imapx200_fixup - 36 @@ -542,7 +542,7 @@ imapx200_i2c_driver - 116 imapx200_i2c_driver - 116 imapx200_decode_driver - 80 -imapx200_decode_fops - 144 +imapx200_decode_fops - 148 imapx200_encode_driver - 80 imapx200_encode_fops - 180 sdhci_imap_driver - 80</span></span></code> </pre></div></div><br>  The size of the core as a whole decreased by 416, but the gain was not the way I expected it: some functions gained weight. <br><br>  Perhaps a more experienced reader knows the reason, but at that time I was not so clear.  Consider the source code of the imapx200_timer_ack function assembler, the size of which increased by 8 bytes after modification: <br><div class="spoiler">  <b class="spoiler_title">to show</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- 0xc0019c40-t-imapx200_timer_ack-2.listing 2015-11-18 22:12:24.196113878 +0300 +++ 0xc0019c50-imapx200_timer_ack-2.listing 2015-11-18 22:12:24.297113880 +0300 @@ -9,10 +9,12 @@ XXXXXXXX: e92dd800 push {fp, ip, lr, pc} XXXXXXXX: e24cb004 sub fp, ip, #4 ; 0x4 XXXXXXXX: e1a00000 nop (mov r0,r0) +c0019c60: e59f2018 ldr r2, [pc, #24] ; c0019c80 &lt;_binary_0xc0019c50_imapx200_timer_ack_start+0x30&gt; XXXXXXXX: e590Y000 ldr rY, [r0] XXXXXXXX: e3a0X001 mov rX, #1 ; 0x1 -c0019c58: e3a0120f mov r1, #-268435456 ; 0xf0000000 +c0019c6c: e5921000 ldr r1, [r2] XXXXXXXX: e1a0XX1Y lsl rX, rX, rY XXXXXXXX: e581X010 str rX, [r1, #16] XXXXXXXX: e581X000 str rX, [r1] XXXXXXXX: e89da800 ldm sp, {fp, sp, pc} +c0019c80: c04e858c subgt r8, lr, ip, lsl #11</span></span></code> </pre></div></div><br>  The first thing that catches your eye: the base address itself is so good that the entry in the register fits into four bytes of the mov command: <pre> <code class="hljs objectivec">c0019c58: e3a0120f mov r1, <span class="hljs-meta"><span class="hljs-meta">#-268435456 ; 0xf0000000</span></span></code> </pre><br>  Second: after modification, the compiler had to add the address of our new constant after the epilog of the function;  its less convenient value is four bytes times. <br><br>  One last thing: it is impossible to read values ‚Äã‚Äãdirectly from memory, therefore, the address of the constant is first written to the register: <pre> <code class="hljs objectivec">c0019c60: e59f2018 ldr r2, [pc, <span class="hljs-meta"><span class="hljs-meta">#24] ; c0019c80</span></span></code> </pre>  - four bytes two. <br><br><a name="conclusion"></a><h4>  <font color="#2B7BAE">Conclusion</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br>  I think that the objective conclusion will be what you need to know about the consequences of defining constants both in the form of macros and using const variables. <br><br>  Personally, I dream that the compiler (albeit in conjunction with the linker) independently made the decision to embed the value of a constant without difficulties with extern const. <br><br>  Thanks for attention! <br><br><a name="sources"></a><h4>  <font color="#2B7BAE">List of sources</font> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> </h4><br><ol><li><a name="cite_note-abbyy-circle"></a>  ^ <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">1</a> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">2</a> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">3</a> <a href="http://habrahabr.ru/company/abbyy/blog/252871/">Calculate the circumference</a> </li><li><a name="cite_note-unique-consts"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://habrahabr.ru/post/254077/">And once again about unique constants</a> </li><li><a name="cite_note-zt180"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://geektimes.ru/post/107796/">Purchase history and experience using the Zenithink ZT-180 Tablet PC</a> </li><li><a name="cite_note-zt180-10"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://geektimes.ru/post/105744/">Zenithink Zt-180 10 "Tablet Review</a> </li><li><a name="cite_note-wowpad"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> page is no longer available, look in various web archives for <a href="http://habrahabr.ru/blogs/iTablet/110714/">habrahabr.ru/blogs/iTablet/110714</a> </li><li><a name="cite_note-good-review"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> page is no longer available, look in various web archives for request <a href="http://www.good-review.ru/pandawill/2011/02/21/obzor-kitayskogo-plansheta-zenithink-zt-180-10.html">www.good-review.ru/pandawill/2011/02/21/obzor-kitayskogo-plansheta-zenithink-zt-180-10.html</a> </li><li>  <a href="http://habrahabr.ru/post/132448/">Relocation of the soul: linux on android tablet</a> </li><li><a name="cite_note-geek-porn"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://www.androidtablets.net/threads/pix-of-inside-my-dead-flytouch-3.12053/">Photos of entrails</a> </li><li><a name="cite_note-zimage-tools"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D740631%26page%3D121">Zimage unpack and pack tools</a> </li><li><a name="cite_note-firmware2"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://www.apad.tv/apadforum/showthread.php%3F1324-Decompiling-firmware2-and-firmware_discovery%26p%3D12538%26viewfull%3D1">Decompiling 'firmware2' and 'firmware_discovery'</a> </li><li><a name="cite_note-disassembly"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="https://code.google.com/p/milestone-overclock/wiki/Disassembly">Disassembly: Smashing the Android Kernel for Fun and Overclock</a> </li><li><a name="cite_note-review-firmwares"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://forum.china-iphone.ru/planshet-superpad-2-flytouch-3-s-pitaniem-5v-t10333-4080.html">Topic on forum.china-iphone.ru, dedicated to the tablet</a> </li><li><a name="cite_note-zt180-sources"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://www.slatedroid.com/topic/20377-open-source-project/">Open source project</a> </li><li><a name="cite_note-atpboy444-zt-180"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="https://github.com/atpboy444/ZT-180">github.com/atpboy444/ZT-180</a> </li><li><a name="cite_note-dandel-linux"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="">github.com/dandel/linux-2.6.32.y</a> </li><li><a name="cite_note-ftp-slackwarearm"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="">SlackwareARM-14.1</a> </li><li><a name="cite_note-build-issue-1"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="https://github.com/djwillis/meta-raspberrypi/issues/38">https://github.com/djwillis/meta-raspberrypi/issues/38</a> </li><li><a name="cite_note-build-issue-2"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="https://lkml.org/lkml/2012/7/6/260">https://lkml.org/lkml/2012/7/6/260</a> </li><li><a name="cite_note-helper-scripts"></a>  ^ <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">1</a> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">2</a> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">3</a> <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">4</a> <a href="https://github.com/gshep/flytouch2-helper-scripts">github.com/gshep/flytouch2-helper-scripts</a> </li><li><a name="cite_note-scott-meyers"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> Scott Mayers.  Effective use of C ++.  55 sure tips to improve the structure and code of your programs </li><li><a name="cite_note-global-order"></a>  <a href="https://habr.com/ru/company/simbirsoft/blog/270885/">^</a> <a href="http://stackoverflow.com/questions/3746238/c-global-initialization-order-ignores-dependencies">Initialization order of globals</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/270885/">https://habr.com/ru/post/270885/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270875/index.html">Project Naptha - select, copy and translate texts from any pictures</a></li>
<li><a href="../270877/index.html">Samba and forbidden characters</a></li>
<li><a href="../270879/index.html">Aggregation and awareness</a></li>
<li><a href="../270881/index.html">Translation: Ethics Code Review</a></li>
<li><a href="../270883/index.html">HighLoad ++ 2015 through the eyes of a foreign speaker</a></li>
<li><a href="../270887/index.html">We are switching from STM32 to the Russian K1986BE92QI microcontroller. Practical application: control LED brightness (PWM)</a></li>
<li><a href="../270889/index.html">The best reports of the DotNext 2015 Piter conference: Part 2 (Video inside)</a></li>
<li><a href="../270891/index.html">Incorrectly used mobile interface patterns</a></li>
<li><a href="../270895/index.html">Analysis of price changes in Russian online stores</a></li>
<li><a href="../270897/index.html">IBM Corporation opens the Bluemix blog on Habrahabr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>