<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog engine with Phoenix and Elixir / Part 7. Add comments / New Year's announcement in the conclusion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: ‚Äú Elixir and Phoenix are a great example of where modern web development is heading. Already, these tools provide high-quality ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog engine with Phoenix and Elixir / Part 7. Add comments / New Year's announcement in the conclusion</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/eed/27a/d0a/eed27ad0a9d3451890ccc4e3680dc23c.png"><br><br>  From the translator: ‚Äú <i>Elixir and Phoenix are a great example of where modern web development is heading.</i>  <i>Already, these tools provide high-quality access to real-time technologies for web applications.</i>  <i>Sites with increased interactivity, multiplayer browser games, microservices - those areas in which these technologies will serve a good service.</i>  <i>The following is a translation of a series of 11 articles that describe in detail the aspects of development on the Phoenix framework that would seem such a trivial thing as a blog engine.</i>  <i>But do not hurry to sulk, it will be really interesting, especially if the articles encourage you to pay attention to the Elixir or become its followers.</i> <i><br><br></i>  <i>In this part, we will prepare a foundation for comments, to then revive them using Phoenix channels.</i> <br><a name="habracut"></a><br>  At the moment, our application is based on: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>Elixir</b> : v1.3.1 </li><li>  <b>Phoenix</b> : v1.2.0 </li><li>  <b>Ecto</b> : v2.0.2 </li></ul><br><h2>  Where did we leave off </h2><br>  Now the engine supports the use of a small Markdown-editor to decorate posts, so our craft becomes like a full-fledged project!  However, we still have no way to get feedback on the posts that we write.  The good news: adding this feature is quite simple.  All work will be built on what we have already done. <br><br>  Let's start with the simple.  Instead of the requirement to register, we will create new comments in the pending approval status.  Comments will be visible on the post page immediately after checking, or by clicking "Show unconfirmed". <br><br><h2>  Add a comment model </h2><br>  Let's start by adding a model for comments.  Comments will be: <br><br><ul><li>  Author (string type) </li><li>  Message (text type) </li><li>  Sign of approved comment (boolean type, false by default) </li><li>  Post to which the comment relates (link to the table with posts) </li></ul><br>  We do not need a full set of templates and the rest of the charms, so we use the <code>mix phoenix.gen.model</code> . <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">mix</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">phoenix</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gen</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.model</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Comment</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">author</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:text</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">approved</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:boolean</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">post_id</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:references</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:posts</span></span></code> </pre> <br>  Then we will migrate: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mix</span></span> ecto.migrate</code> </pre> <br><h2>  Link comments with posts </h2><br>  In the <code>web/models/comment.ex</code> you can see that comments are already associated with posts, but there is not enough connection in the opposite direction. <br><br>  So add the following code to the ‚Äúposts‚Äù schema definition in the <code>web/models/post.ex</code> file: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">has_many</span></span> <span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:comments</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Pxblog</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Comment</span></span></code> </pre> <br>  After executing the <code>mix test</code> command, everything should still be green!  Now let's check the link between posts and comments. <br><br>  To do this, open the <code>test/support/factory.ex</code> file and add the Comment factory.  Write this line to the top of the file, following the rest of the aliases: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span></code> </pre> <br>  And then this code to the bottom: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">def</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comment_factory</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> %<span class="hljs-selector-tag"><span class="hljs-selector-tag">Comment</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">author</span></span>: <span class="hljs-string"><span class="hljs-string">"Test User"</span></span>, body: <span class="hljs-string"><span class="hljs-string">"This is a sample comment"</span></span>, approved: false, post: <span class="hljs-built_in"><span class="hljs-built_in">build</span></span>(:post) } <span class="hljs-selector-tag"><span class="hljs-selector-tag">end</span></span></code> </pre> <br>  Accordingly, it is necessary to create several tests for the factory to become useful.  Open the file <code>test/models/comment_test.exs</code> and add the following code to it: <br><br><pre> <code class="hljs lua">import Pxblog.Factory # ... test <span class="hljs-string"><span class="hljs-string">"creates a comment associated with a post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> comment = <span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(:comment) <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> comment.post_id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Run the tests again.  They should stay green! <br><br><h2>  Adding routes for comments </h2><br>  Let's start by creating the main routes for comments.  Open the <code>web/router.ex</code> : <br><br><pre> <code class="hljs pgsql">resources "/posts", PostController, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> resources "/comments", CommentController, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [:<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Comments make sense only in the context of posts, so we put them inside.  At the same time, in other routes that we have already identified, posts are embedded in users!  I do not want to create extra routes for posts, so we will use the parameter <code>only: []</code> .  Then add comment resources to allow them to create, delete and update them.  <code>:create</code> - to add comments by unauthorized users (created by unconfirmed).  <code>:delete</code> - allows the author of the post and administrators to delete comments, and <code>:update</code> - approve them for display to the public. <br><br><h2>  Adding Controllers and Views </h2><br>  Now that our models are configured, we need to create a controller with a couple of methods.  The display of comments will be implemented through the post controller, but the creation / update / deletion must be implemented in their own controller.  Let's start by creating the <code>web/controllers/comment_controller.ex</code> file: <br><br><pre> <code class="hljs sql">defmodule Pxblog.CommentController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.Web, :controller <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  We will also create a view in the web / views / comment_view.ex file, as Phoenix wants. <br><br><pre> <code class="hljs sql">defmodule Pxblog.CommentView <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.Web, :<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Now let's go back to the controller and add the basic structure of the three actions: <code>create</code> , <code>update</code> and <code>delete</code> . <br><br><pre> <code class="hljs sql">def <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span></code> </pre> <br>  Then you need to create a template for adding a comment in the new directory, which we will place on the post display page: <br><br><pre> <code class="bash hljs">$ mkdir web/templates/comment</code> </pre> <br><h2>  Allowing users to post comments. </h2><br>  Let's start by creating the <code>web/templates/comment/form.html.eex</code> : <br><br><pre> <code class="hljs scala">&lt;%= form_for <span class="hljs-meta"><span class="hljs-meta">@changeset</span></span>, <span class="hljs-meta"><span class="hljs-meta">@action</span></span>, fn f -&gt; %&gt; &lt;%= <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-meta"><span class="hljs-meta">@changeset</span></span>.action do %&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"alert alert-danger"</span></span>&gt; &lt;p&gt;<span class="hljs-type"><span class="hljs-type">Oops</span></span>, something went wrong! <span class="hljs-type"><span class="hljs-type">Please</span></span> check the errors below.&lt;/p&gt; &lt;/div&gt; &lt;% end %&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"form-group"</span></span>&gt; &lt;%= label f, :author, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"control-label"</span></span> %&gt; &lt;%= text_input f, :author, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"form-control"</span></span> %&gt; &lt;%= error_tag f, :author %&gt; &lt;/div&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"form-group"</span></span>&gt; &lt;%= label f, :body, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"control-label"</span></span> %&gt; &lt;%= textarea f, :body, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"form-control"</span></span>, id: <span class="hljs-string"><span class="hljs-string">"body-editor"</span></span> %&gt; &lt;%= error_tag f, :body %&gt; &lt;/div&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"form-group"</span></span>&gt; &lt;%= submit <span class="hljs-string"><span class="hljs-string">"Submit"</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-string"><span class="hljs-string">"btn btn-primary"</span></span> %&gt; &lt;/div&gt; &lt;% end %&gt;</code> </pre> <br>  The usual form, there is nothing to discuss. <br><br>  Now let's move on to the <code>web/templates/post/show.html.eex</code> file, to which we will add a link to this form.  Please note that in this template we use two variables <code>@changeset</code> and <code>@action</code> .  We will come back to this later in the <code>web/controllers/post_controller.ex</code> .  Now let's continue working with the template.  After the list of post attributes, add the following line: <br><br><pre> <code class="hljs mel">&lt;%= <span class="hljs-keyword"><span class="hljs-keyword">render</span></span> Pxblog.CommentView, <span class="hljs-string"><span class="hljs-string">"form.html"</span></span>, changeset: @comment_changeset, action: post_comment_path(@conn, :create, @post) %&gt;</code> </pre> <br>  We need to refer to ‚Äúform.html‚Äù inside the <code>CommentView</code> , so we <code>CommentView</code> pass the name to the first argument in the <code>render</code> call.  We need to transfer there <code>@comment_changeset</code> (which we have not yet determined, but we will do it soon) and <code>@action</code> is the way to send comments. <br><br>  Now we can go to the <code>web/controllers/post_controller.ex</code> and make everything work.  Change the show function according to the code: <br><br><pre> <code class="hljs sql">def <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(assoc(conn.assigns[:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>], :posts), <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) comment_changeset = post |&gt; build_assoc(:comments) |&gt; Pxblog.Comment.changeset() render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"show.html"</span></span>, post: post, comment_changeset: comment_changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Now let's go back to CommentController ( <code>web/controllers/comment_controller.ex</code> file) and fill the contents with the create function.  Right in front of the functions, add the following code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Post plug :scrub_params, "comment" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [:<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>]</code> </pre> <br>  Including update in the scrub_params call will come in handy later.  Now, jump to the create function and place the following code in it: <br><br><pre> <code class="hljs sql">def <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"comment"</span></span> =&gt; comment_params, <span class="hljs-string"><span class="hljs-string">"post_id"</span></span> =&gt; post_id}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, post_id) |&gt; Repo.preload([:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, :comments]) changeset = post |&gt; build_assoc(:comments) |&gt; Comment.changeset(comment_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.insert(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, _comment} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"Comment created successfully!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.user, post)) {:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, changeset} -&gt; render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, Pxblog.PostView, <span class="hljs-string"><span class="hljs-string">"show.html"</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: post.user, comment_changeset: changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  We will now create a comment when we receive the comment_params parameters and the post_id post identifier, as they are required.  First, we take the linked post (do not forget to preload the user and comments, as the template will soon begin to refer to them), on the basis of which we will create a new changeset.  To do this, starting with the post, go along the chain to the <code>build_assoc</code> function to create a linked scheme, which is determined by the atom.  In our case, an associated <code>comment</code> is created.  The result, together with comment_params, is passed to the Comment.changeset function.  The rest of the work is standard with one exception. <br><br>  The error condition is a bit more complicated, because we use a different view render.  First we pass the connection connection, then the associated View View (in our case <code>Pxblog.PostView</code> ), the template for the render, and all the variables used in the template: <code>@post</code> , <code>@user</code> , and <code>@comment_changeset</code> .  Now you can test: if you send a comment with errors, you will see a list of them directly on the page.  If there are no errors when sending a comment, you will receive a blue flash message at the top of the page. We are making progress! <br><br><h2>  Comment output </h2><br>  Now we need to display comments on the post page.  To do this, we will create a general comment template that can be used in any places for different purposes.  Create a file <code>web/templates/comment/comment.html.eex</code> and fill it with the following: <br><br><pre> <code class="hljs javascript">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"comment"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"col-xs-4"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.author</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"col-xs-4"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">em</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.inserted_at</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">em</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"col-xs-4 text-right"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unless</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.approved</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-primary approve"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Approve</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-danger delete"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Delete</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"row"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"col-xs-12"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.body</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; &lt;/</span></span>div&gt;</code> </pre> <br>  Here everything is clear without explanation.  The approve / delete buttons are not yet connected.  We will address this issue in the following sections.  We also need to change the controller to preload comments, and include the comment list itself in the show template.  Let's start with updating the controller.  Add a line to the <code>show</code> function from the <code>web/controllers/post_controller.ex</code> immediately after the line with the receipt of posts: <br><br><pre> <code class="hljs pgsql">post = Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>!(assoc(conn.assigns[:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>], :posts), id) |&gt; Repo.preload(:comments)</code> </pre> <br>  Thus, we will provide the loading of comments as part of the post.  Finally, open the <code>web/templates/post/show.html.eex</code> file and add a template section that displays comments: <br><br><pre> <code class="hljs javascript">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Comments</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;%= <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> comment &lt;- @post.comments <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">render</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Pxblog.CommentView</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.html</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><h2>  Add controller tests </h2><br>  You can not stop until some conditions are not covered by tests.  We need to test the create function for success and failure, since code can be executed along any of these paths. <br><br>  Create the file <code>test/controllers/comment_controller_test.exs</code> and proceed: <br><br><pre> <code class="hljs sql">defmodule Pxblog.CommentControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Pxblog.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Pxblog.Factory @valid_attrs %{author: <span class="hljs-string"><span class="hljs-string">"Some Person"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>: <span class="hljs-string"><span class="hljs-string">"This is a sample comment"</span></span>} @invalid_attrs %{} setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) post = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:post, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: build_conn(), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"creates resource and redirects when data is valid"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, post_comment_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>, post), <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: @valid_attrs assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.user, post) assert Repo.get_by(assoc(post, :comments), @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"does not create resource and renders errors when data is invalid"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, post_comment_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>, post), <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: @invalid_attrs assert html_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Oops, something went wrong"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Use the Pxblog.Factory factory again.  We will also set the two variables of the <code>@valid_attrs</code> and <code>@invalid_attrs</code> in the same way as we did before.  Add a setup block, inside which we set up a default user and a post to work with. <br><br>  Let's start with a test to successfully add a comment.  We send a POST request to the embedded path with valid attributes and check that, as expected, the redirection worked, and a comment was added to the post. <br><br>  Now let's do the same, but with invalid data, and check that we received the message ‚ÄúOops, something went wrong‚Äù in the form of HTML.  Done! <br><br><img src="https://habrastorage.org/files/7d5/af1/f1e/7d5af1f1e47843ebbbcefdc6e10f3a4c.png"><br><br><h2>  Further steps </h2><br>  We have prepared an excellent foundation for comments, which we can definitely continue to develop.  For example, we still do not have the ability to approve and delete comments.  In the next few parts, we will work a little more to improve the comments before moving on to the Phoenix-based live comment system. <br><br><h2>  Other series articles </h2><br><ol><li>  <a href="https://habrahabr.ru/post/311088/">Introduction</a> </li><li>  <a href="https://habrahabr.ru/post/313482/">Authorization</a> </li><li>  <a href="https://habrahabr.ru/post/315252/">Adding Roles</a> </li><li>  <a href="https://habrahabr.ru/post/316368/">Process roles in controllers</a> </li><li>  <a href="https://habrahabr.ru/post/316996/">We connect ExMachina</a> </li><li>  <a href="https://habrahabr.ru/post/317550/">Markdown support</a> </li><li>  Add comments </li><li>  <a href="https://habrahabr.ru/post/323462/">We finish with comments</a> </li><li>  <a href="https://habrahabr.ru/post/332094/">Channels</a> </li><li>  <a href="https://habrahabr.ru/post/333020/">Channel testing</a> </li><li>  <a href="https://habrahabr.ru/post/335048/">Conclusion</a> </li></ol><br><br><h2>  Conclusion from the Wuns </h2><br>  In the two months that we had this year, we managed to take the first steps in popularizing the Elixir.  First of all, <a href="https://wunsh.ru/">we founded the Russian-speaking community Wunsh.ru</a> , for which a dozen and a half of the most interesting articles about Elixir and functional programming were translated into Russian. <br><br>  At the beginning of the week, we updated the site and shared five articles.  We hope they will provoke you and convince you to try the language.  For example, write a simple application in the winter holidays.  <b>Tomorrow we will send subscribers a full set of published articles.</b>  <b>So <a href="https://wunsh.ru/">sign up today</a> and invite your friends</b> .  We will be glad to such a gift! <br><br>  The next step of the project is to write a serious introduction for newbies, translate official documentation and answer frequently asked questions in detail: <br><br><ul><li>  Where to begin? </li><li>  How to deploy a project? </li><li>  Which editor to use? </li><li>  What tasks to solve? </li></ul><br>  Other‚Ä¶ <br><br>  Next year will be filled with the rapid movement of the language itself.  Its introduction to Russian companies.  About the language will not just know, it will begin massively (as far as possible) to use. <br><br>  Thanks for coming into our materials.  If you are a subscriber, invite your friends. <br><br>  Happy New Year! </div><p>Source: <a href="https://habr.com/ru/post/318790/">https://habr.com/ru/post/318790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318780/index.html">Approaches to design in virtual reality</a></li>
<li><a href="../318782/index.html">Java socket framework</a></li>
<li><a href="../318784/index.html">Can your code reason?</a></li>
<li><a href="../318786/index.html">Competitiveness: Cooperativeness</a></li>
<li><a href="../318788/index.html">42% of people who do not buy your product</a></li>
<li><a href="../318792/index.html">FBI, CIA and Obama against PHP script</a></li>
<li><a href="../318796/index.html">Sending a GPS track via SMS</a></li>
<li><a href="../318798/index.html">We want to give you a New Year's gift, but we need your help.</a></li>
<li><a href="../318800/index.html">Creating music interfaces</a></li>
<li><a href="../318802/index.html">20 harmful tips on developing games on Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>