<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bookmarklet: Analysis of Essential Points, Part One</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, a bookmarklet is a small javascript code which, being stored in browser bookmarks , is used to perform any actions on the contents of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bookmarklet: Analysis of Essential Points, Part One</h1><div class="post__text post__text-html js-mediator-article">  As you know, a bookmarklet is a small javascript code which, being stored in browser <i>bookmarks</i> , is used to perform any actions on the contents of the current web page. <br><br>  But why in the title of the post: <b>part one</b> ?  Because the modern bookmarklet ‚Äúwith blackjack and whores‚Äù <sup>*</sup> usually <i>consists of several interacting</i> parts: <br><ol><li>  <i>The first part of the</i> bookmarklet, which is actually a bookmarklet, is a compact javscript code - no more than 2000 characters, the main, but not the only task of which is to download the <i>second part</i> ; </li><li>  <i>The second part of the</i> bookmarklet: this is a javscript code of arbitrary size that does the rest of the work; </li><li>  <i>backup part of the</i> bookmark - which is launched into action, if the <i>second part of the</i> bookmarklet has not been loaded. </li></ol><br>  And, as you probably already guessed, this publication will discuss the <i>first part of the</i> bookmarklet, <br><br>  <i>Part one</i> usually performs the following simple actions: <br><a name="habracut"></a><br><ol><li>  Defines the variables to be used in the bookmarklet. </li><li>  Initiates the start of work of the bookmarklet or stops its work with the cleaning of everything embedded on another page in the incl mode.  on / off and also checks for the special conditions of the bookmarklet. </li><li>  Turns on <i>the load indicator</i> so that the user is not nervous, while all the wealth of functionality continues to load. </li><li>  It loads the <i>second part of the bookmarklet</i> that ensures the implementation of all further work. </li><li>  If the <i>second part of the</i> bookmarklet cannot be loaded, it receives the data on the current page, which is necessary for transfer to the <i>backup part of the</i> bookmarklet. </li><li>  It calls the <i>backup part of the</i> bookmarklet and transfers the necessary data to it. </li></ol><br>  For brevity, the subject of the publication of the <i>first part of the bookmarklet</i> will be simply called: <i>bookmarklet</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Real example </h2><br>  As an example, ‚Äúfrom real life‚Äù we will use <a href="http://www.theonlypage.com/">TheOnlyPage bookmarklet</a> (a service for storing bookmarks, notes and html fragments). <br><br>  To install the bookmarklet in your browser, simply go to <a href="http://help.theonlypage.com/ru_bookmarklet.html">the TheOnlyPage help system page</a> and drag the corresponding link to the browser's bookmarks bar. <br><br>  You can proceed to the bookmarklet by completing the following 4 steps: <br><br>  Step 1: Click on the bookmarklet link, if you have not already entered <a href="http://www.theonlypage.com/">TheOnlyPage</a> , then go to Step 2, if you have already entered, then go directly to the final Step 4. <br><br>  Step 2: Click on the <b>Login to TheOnlyPage button</b> in the form that opens. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9df/10f/94c/9df10f94c4cffa8cb17f6d27352e5433.png" alt="image"><br><br>  Step 3: As a result, the login form is displayed in a separate window.  For quick registration / login, you can use the login buttons through social services. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/425/3e4/e0f/4253e4e0f8bb55a5b6cf2a29cfbdd282.png" alt="image"><br><br>  Step 4: The form for saving a bookmark / note / html fragment (image) received from the currently viewed page is displayed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/366/4f4/4c5/3664f44c5a9656b5f0db491570c2f5ef.png" alt="image"><br><br>  Now let's go through the javascript code of the bookmarklet and see how it all happens. <br><br>  The bookmarklet code is as follows: <br><br><pre><code class="javascript hljs">javascript:(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> w=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,d=w.document,l=w.location,u=l.hostname,s=w.getSelection(),g=d.getElementById(<span class="hljs-string"><span class="hljs-string">'theonlypageAjaxLoaderGif'</span></span>),e=<span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>,i,r,c=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u===<span class="hljs-string"><span class="hljs-string">'www.theonlypage.com'</span></span>){<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>);}<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(g){g.parentNode.removeChild(g);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>);}g=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image();d.body.appendChild(g);g.id=<span class="hljs-string"><span class="hljs-string">'theonlypageAjaxLoaderGif'</span></span>;g.style.cssText=<span class="hljs-string"><span class="hljs-string">'position:fixed;z-index:2147483647'</span></span>;g.style.left=<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((w.innerWidth<span class="hljs-number"><span class="hljs-number">-66</span></span>)/<span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>;g.style.top=<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((w.innerHeight<span class="hljs-number"><span class="hljs-number">-66</span></span>)/<span class="hljs-number"><span class="hljs-number">3</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>;g.src=<span class="hljs-string"><span class="hljs-string">'//d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif'</span></span>;r=d.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>);r.src=<span class="hljs-string"><span class="hljs-string">'//d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js'</span></span>;r.async=<span class="hljs-literal"><span class="hljs-literal">true</span></span>;r.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(s.rangeCount){c=d.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;s.rangeCount;i+=<span class="hljs-number"><span class="hljs-number">1</span></span>){c.appendChild(s.getRangeAt(i).cloneContents());}c=c.innerHTML;}l.assign(<span class="hljs-string"><span class="hljs-string">'http://www.theonlypage.com/b/?t='</span></span>+e(d.title)+<span class="hljs-string"><span class="hljs-string">'&amp;h='</span></span>+e(l.href)+<span class="hljs-string"><span class="hljs-string">'&amp;c='</span></span>+e(c)+<span class="hljs-string"><span class="hljs-string">'&amp;u='</span></span>+e(u))},<span class="hljs-literal"><span class="hljs-literal">true</span></span>);d.body.appendChild(r);})()</code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">The same code is readable.</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> w=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, d=w.document, l=w.location, u=l.hostname, s=w.getSelection(), g=d.getElementById(<span class="hljs-string"><span class="hljs-string">'theonlypageAjaxLoaderGif'</span></span>), e=<span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>, i, r, c=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u===<span class="hljs-string"><span class="hljs-string">'www.theonlypage.com'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(g){ g.parentNode.removeChild(g);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } g=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); d.body.appendChild(g); g.id=<span class="hljs-string"><span class="hljs-string">'theonlypageAjaxLoaderGif'</span></span>; g.style.cssText=<span class="hljs-string"><span class="hljs-string">'position:fixed;z-index:2147483647'</span></span>; g.style.left=<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((w.innerWidth<span class="hljs-number"><span class="hljs-number">-66</span></span>)/<span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>; g.style.top=<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((w.innerHeight<span class="hljs-number"><span class="hljs-number">-66</span></span>)/<span class="hljs-number"><span class="hljs-number">3</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>; g.src=<span class="hljs-string"><span class="hljs-string">'//d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif'</span></span>; r=d.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>); r.src=<span class="hljs-string"><span class="hljs-string">'//d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js'</span></span>; r.async=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; r.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(s.rangeCount){ c=d.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;s.rangeCount;i+=<span class="hljs-number"><span class="hljs-number">1</span></span>){ c.appendChild(s.getRangeAt(i).cloneContents()); } c=c.innerHTML; } l.assign(<span class="hljs-string"><span class="hljs-string">'http://www.theonlypage.com/b/?t='</span></span>+e(d.title)+<span class="hljs-string"><span class="hljs-string">'&amp;h='</span></span>+e(l.href)+<span class="hljs-string"><span class="hljs-string">'&amp;c='</span></span>+e(c)+<span class="hljs-string"><span class="hljs-string">'&amp;u='</span></span>+e(u))},<span class="hljs-literal"><span class="hljs-literal">true</span></span>); d.body.appendChild(r); })()</code> </pre><br></div></div><br><br>  <b>The important point</b> is to prevent bookmarklet code conflicts with executable scripts on the current page.  Standard approaches are used for this: <br><ul><li>  placing all the code inside <i>an anonymous function</i> ; </li><li>  using only local variables declared inside this function, which excludes the possibility of conflicts with the external environment. </li></ul><br>  It would be possible to isolate the code like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   var bookmarlet_code = function() { //     } //    bookmarlet_code();</span></span></code> </pre><br>  but this creates the <code>bookmarlet_code</code> variable, which is a potential source of conflict with the scripts on the current page.  To prevent the emergence of a global variable, the <i>declaration</i> and <i>execution of the</i> function combine: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//           ( function() { //     })();</span></span></code> </pre><br><h2>  Variable definition </h2><br>  The main thing, when declaring variables, is saving, you should try to meet the 2000 allotted characters, and for this: <br><ol><li>  all variables are declared in one place, one <code>var</code> keyword; </li><li>  variable names are specified by one character; </li><li>  global variables, parameters, and functions that will be used repeatedly should be assigned single-character aliases. </li></ol><br>  Of course, you can not bother with manually compressing the code, but use one of the many available utilities for compressing javascript code. <br><br>  In our example, variables are declared as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   var         //   window   w //    this     widow var w=this, //      w=window //   window.document   d d=w.document, //   window.location   l l=w.location, //    //   window.location.hostname   u u=l.hostname, //     //            s=w.getSelection(), // ,   id='theonlypageAjaxLoaderGif',      g=d.getElementById('theonlypageAjaxLoaderGif'), //     encodeURIComponent   e e=encodeURIComponent, //    i     for i, //   r          r, //      html    c='';</span></span></code> </pre><br><h2>  Turn on / off, check special bookmarklet conditions </h2><br>  Perhaps the bookmarklet should not work on certain pages, for example, the bookmarklet of the web service <a href="http://www.theonlypage.com/">TheOnlyPage</a> cannot work on the pages of its own website <a href="http://www.theonlypage.com/">www.theonlypage.com</a> . <br><br>  These restrictions are implemented by checking and shutting down, when the completion conditions are met. <br>  In our example, if the hostname of the current document is: <code><a href="http://www.theonlypage.com/"></a> www.theonlypage.com</code>  <code><a href="http://www.theonlypage.com/"></a> www.theonlypage.com</code> - the bookmarklet ends work by returning an empty value: <code>void(0)</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u===<span class="hljs-string"><span class="hljs-string">'www.theonlypage.com'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br>  <b>The important point</b> is to return exactly the empty value of <code>void(0)</code> .  Because otherwise, the current document, that is, the content of the viewed web page will be replaced with the <i>return value</i> . <br><br>  The on / off mechanism is used to ensure that repeated clicks of the bookmarklet link do not launch the bookmarklet again and again.  It is much more convenient, on the contrary, to be able to repeat the work of this bookmarklet by repeated clicking on the same link. <br><br>  The on / off mechanism, in our example, is implemented as follows. <br><br>  If you <i>clicked the first time</i> : we introduce a picture-indicator of loading into the document you are viewing. <br><br>  If you <i>clicked a second time</i> : we find an already loaded picture-indicator of the load, delete this picture and complete the work by returning an empty value: void (0). <br><br>  We determined the loading indicator picture at the beginning when declaring all variables. <br><br><pre> <code class="javascript hljs">g=d.getElementById(<span class="hljs-string"><span class="hljs-string">'theonlypageAjaxLoaderGif'</span></span>)</code> </pre><br>  If you <i>clicked the first time</i> , there are no images yet, <code>g=undefined</code> <br><br>  If the <i>second time</i> , then the variable <code>g</code> contains a picture and the work is completed as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(g){ <span class="hljs-comment"><span class="hljs-comment">//   ‚Ä¶ // ‚Ä¶  g.parentNode.removeChild(g); // ‚Ä¶       return void(0); }</span></span></code> </pre><br><h2>  Connecting the download indicator </h2><br>  Connecting the download indicator <img src="http://help.theonlypage.com/habrahabr/ajax-loader.gif" alt="image">  in our example, as follows <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   - g = new Image(); //     //  id g.id='theonlypageAjaxLoaderGif'; //    z-index //     g.style.cssText='position:fixed;z-index:2147483647'; //    g.style.left=Math.floor((w.innerWidth-66)/2)+'px'; g.style.top=Math.floor((w.innerHeight-66)/3)+'px'; //    g.src='//d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif'; //      d.body.appendChild(g);</span></span></code> </pre><br>  When creating the load indicator, we assigned it an <code>id</code> to be able to: <br><ol><li>  in the code of the <i>second part of the bookmarklet</i> , after the download is finished, detect the download indicator and disable it; </li><li>  when you click the bookmarklet link again, find the download indicator and turn it off. </li></ol><br>  It is necessary to take into account that when introducing a new element onto another page, its <code>id</code> should not coincide with the <code>id</code> any element already present on the page.  <b>The important point</b> is the choice of such an <code>id</code> which, almost certainly, no one except you will use, for example, containing the name of your service.  So, in our example, the <code>id</code> is the string <code>'theonlypageAjaxLoaderGif'</code> <br><br>  Another <b>important point</b> is the fact that if the image address protocol is <code>http://</code> then errors will occur when working on the current page, the protocol of which address is <code>https://</code> .  The reason for this is: restrictions imposed on <i>mixed passive display content</i> ( <i>mixed passive / display content</i> ), which, in particular, prohibit uploading pictures from unprotected addresses to a document protected by TLS (SSL) protocol.  There are 2 ways to guarantee a normal load: <br><ol><li>  or place it at the address with the <code>https://</code> protocol </li><li>  or use a special <code>//</code> notation, for example: <br> <code>script.src='//d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif'</code> <br>  which means using the same protocol as the parent document.  Then, depending on the protocol of the current web page <code>http://</code> or <code>https://</code> , the corresponding address will be used: <br> <code><a href=""></a> d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif</code> <br>  or <br> <code><a href=""></a> d2wlh3lh0sssu9.cloudfront.net/img/ajax-loader.gif</code> </li> </ol><br><h2>  Loading the second part of the bookmarklet </h2><br>  To download the javascript code of the <i>second part of the bookmarklet</i> , you should do actions similar to those in the case of embedding the picture-indicator of the load. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    script r=d.createElement('script'); //  ,        r.src='//d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js'; //     ‚Ä¶ // ‚Ä¶         r.async=true; //         d.body.appendChild(r);</span></span></code> </pre><br>  <b>The important point</b> is to attach the script to the body ( <code>body</code> ), and not to the header ( <code>head</code> ) of the document.  For HTML 5, the header is not a required attribute and problems are possible if <code>document.body.appendChild</code> used instead of <code>document.head.appendChild</code> . <br><br>  Another <b>important point</b> is the fact that if the downloadable javascript code contains the address protocol: <code>http://</code> then there will be errors when working on the current page, the address protocol of which is: <code>https://</code> .  The reason for this is: restrictions imposed on <i>mixed active content</i> ( <i>mixed active content</i> ), which prohibit downloading code from unprotected addresses into a document protected by TLS (SSL).  There are 2 ways to ensure that the javascript code loads normally: <br><ol><li>  or place it at the address with the <code>https://</code> protocol </li><li>  or use a special <code>//</code> notation, for example: <br> <code>script.src='//d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js'</code> <br>  which means using the same protocol as the parent document.  Then, depending on the protocol of the current web page <code>http://</code> or <code>https://</code> , the corresponding address will be used: <br> <code><a href=""></a> d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js</code> <br>  or <br> <code><a href=""></a> d2wlh3lh0sssu9.cloudfront.net/js/mini.bookmarklet.js</code> </li> </ol><br><h2>  Backing up bookmarklet </h2><br>  Unfortunately, there are situations when, in principle, the script of the <i>second part of the bookmarklet</i> cannot be attached to the current document. <br><br>  In addition to exotic cases, such as viewing a <code>pdf</code> file by the <b>Firefox</b> browser, the main cause of the script loading error is a new security mechanism for Web pages <a href="http://www.html5rocks.com/en/tutorials/security/content-security-policy/">Content Security Policy</a> . <br><br>  The main purpose of the new <b>Content Security Policy</b> standard is to protect the user from cross-site scripting.  It is fully supported by <b>Firefox</b> and <b>Google Chrome</b> browsers. <br><br>  Among website builders, this standard is not used very widely, special HTTP headers are used for its implementation, which goes beyond the usual scope of duties.  But some advanced experts have already involved this standard.  For example, the following sites prohibit the use of scripts from foreign servers: <a href="http://www.facebook.com/">www.facebook.com</a> and <a href="http://github.com/">GitHub.com</a> . <br><br>  What can not but grieve, and sometimes cause bewilderment and fair anger from the creator of the bookmarklet.  Of course, you can advise <b>Opera</b> browser as an alternative, in which this standard has not yet been implemented, but a solution is also needed for dedicated users of <b>Firefox</b> and <b>Google Chrome</b> browsers. <br><br>  It is worth noting that if the site is equipped with <b>Content Security Policy</b> then the ‚Äúblackjack with whores‚Äù <sup>*</sup> will not always succeed in stirring up, but some backup option, with reduced <i>functionality</i> and <i>presentability</i> is possible. <br><br>  For clarity, let's go, for example, on the page <a href="http://www.facebook.com/">www.facebook.com</a> and click on the link of the bookmarklet <b>TheOnlyPage</b> .  The bookmarklet will work, but not in the usual way. <br><br>  This time, the bookmarklet form does not appear directly above the current page of the site, but instead loads a new page at: <br><br>  <a href="https%253A%252F%252Fwww.facebook.com%252F%26c%3D%26u%3Dwww.facebook.com">http://www.theonlypage.com/b/?t=(3)%20Facebook&amp;h=https%3A%2F%2Fwww.facebook.com%2F&amp;c=&amp;u=www.facebook.com</a> <br><br>  That is, we get to a special page of the web service <a href="http://www.theonlypage.com/">TheOnlyPage</a> , on which a very familiar form is displayed, to create a new bookmark, note, or picture. <br><br><img src="http://help.theonlypage.com/habrahabr/reserve_bookmarklet_bookmark.png" alt="image"><br><br>  As you can see, the parameters for the <i>backup part of the bookmarklet</i> are transmitted in the <i>address bar</i> .  In our case, the following 4 parameters were passed: <br><br><ol><li>  Coded signature line: <code>(3) Facebook</code> : <br> <code>t=(3)%20Facebok</code> </li> <li>  encoded address line of the page being viewed <code><a href="https://www.facebook.com/"></a> www.facebook.com</code> <br> <code>h=https%A%2F%2Fwww.facebookcom%2F</code> </li> <li>  Html-code of the selected area - nothing is selected, no data <br> <code>=</code> </li> <li>  hostname of the page <br> <code>u=www.facebook.com</code> </li> </ol><br>  We made sure that the <i>fallback</i> works, it remains to see how it gets started in the code in the bookmarklet. <br><br>  It is absolutely clear that the <i>backup version of the bookmarklet is</i> launched for execution only if it was not possible to attach the code for the <i>second part of the bookmarklet</i> .  In order to catch the script loading error, install the appropriate <code>error</code> event handler. <br><br><pre> <code class="javascript hljs">r.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        //    if( s.rangeCount ){ //  -   ‚Äì    //    html- c=d.createElement('div'); for(i=0;i&lt;s.rangeCount;i+=1){ c.appendChild(s.getRangeAt(i).cloneContents()); } c=c.innerHTML; } //        , //       l.assign('http://www.theonlypage.com/b/?t='+e(d.title)+'&amp;h='+e(l.href)+'&amp;c='+e(c)+'&amp;u='+e(u)) }, true);</span></span></code> </pre><br>  And, in conclusion, another <b>important point</b> that needs to be considered when writing the bookmarklet code.  When displaying a bookmarklet code in <i>html markup</i> , for example, so that the user can copy the code presented on the page and use it to create a bookmarklet, do not forget to replace the characters: <br><ul><li>  <code>&lt;</code> on <code>&amp;lt;</code> </li><li>  <code>&gt;</code> to <code>&amp;gt;</code> </li><li>  <code>"</code> on <code>&amp;quot;</code> </li></ul><br>  if such characters are found in the javascript code of the bookmarklet. <br><br>  <i>The second (loadable)</i> part and the <i>backup</i> part of the bookmarklet will be discussed separately, in subsequent posts on <a href="http://habrahabr.ru/">habrahabr.ru</a> <br><br><hr><br>  ‚ÄúWith blackjack and hookers‚Äù <sup>*</sup> (with blackjack and hookers) is the phrase of the robot Bender from the second episode of the first season of ‚ÄúFuturama‚Äù. </div><p>Source: <a href="https://habr.com/ru/post/234427/">https://habr.com/ru/post/234427/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234409/index.html">BaasCMS - no backend needed</a></li>
<li><a href="../234411/index.html">The digest of interesting news and materials from the world of PHP No. 46 (August 3 - 24, 2014)</a></li>
<li><a href="../234413/index.html">How to display 350 million rows from a database on a web form</a></li>
<li><a href="../234415/index.html">Complain about health: as we understood that the main thing is support</a></li>
<li><a href="../234417/index.html">Some interesting and useful things for web developer # 26</a></li>
<li><a href="../234429/index.html">Doctors from Peking University for the first time implanted a vertebra printed on a 3D printer to a man</a></li>
<li><a href="../234431/index.html">Interorbital tug</a></li>
<li><a href="../234433/index.html">A magic object for storing and transmitting heterogeneous data with type and value checking</a></li>
<li><a href="../234437/index.html">Low-cost multi-camera FullHD video recording of the concert with their own hands</a></li>
<li><a href="../234439/index.html">Run objective-c code on Android devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>