<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linq To Tasks and the continuation monad</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the announcement of C # 5.0 with its async and await, I had a slight interest in asynchronous programming, digging towards which was the origin ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linq To Tasks and the continuation monad</h1><div class="post__text post__text-html js-mediator-article">  After the announcement of C # 5.0 with its async and await, I had a slight interest in asynchronous programming, digging towards which was the origin of this text. <br>  In the process of reading the article, you learn / mind. <br><ul><li>  What is a monad on the example of Maybe. </li><li>  What is CPS and the continuation monad. </li><li>  How to associate it with the Task class from the TPL. </li></ul><br><a name="habracut"></a><br><h4>  Monads </h4><br>  The monad is essentially composed of three parts. <br><ul><li>  A container that contains something. </li><li>  The function with which you can put something in a container. </li><li>  The function that allows you to pull something out of the container and apply another function that will return the new container. </li></ul><br>  Usually these two functions are called return and bind, but in Sharp we will call them To [Monad Name] and SelectMany. <br><br><h5>  Maybe monad </h5><br>  Consider the Maybe monad, the twin brother of Nullable.  A container that can either contain a value or contain nothing. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Maybe&lt;T&gt; Nothing = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Maybe&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Maybe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { HasValue = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Maybe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; HasValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HasValue) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Nothing"</span></span>; } }</code> </pre> <br>  <b>One of the useful properties of this monad, if somewhere in the expression met Nothing, then the whole expression will be Nothing.</b> <br>  Here are our two functions. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MaybeEx</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Maybe&lt;T&gt; ToMaybe&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> T <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Maybe&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Maybe&lt;U&gt; SelectMany&lt;T, U&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Maybe&lt;T&gt; m, Func&lt;T, Maybe&lt;U&gt;&gt; k) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m.HasValue) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> k(m.Value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Maybe&lt;U&gt;.Nothing; } }</code> </pre><br>  With ToMaybe, everything is clear, with SelectMany, it seems, too, take the container m, and apply the function k to its contents if there is a value. <br>  Suppose we want to add two numbers <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-number"><span class="hljs-number">1.</span></span>ToMaybe(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing; Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; k = x =&gt; b.SelectMany(y =&gt; (y + x).ToMaybe()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = a.SelectMany(k); <span class="hljs-comment"><span class="hljs-comment">//result == Nothing,   b = 2.ToMaybe()  3</span></span></code> </pre><br>  We see that before folding we had to use SelectMany to pull the values ‚Äã‚Äãout of the container twice.  To get rid of the clutter, there is sugar in some languages, in Haskell do notation, F # computation expressions, well, we can remember that the expression <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> x + y;</code> </pre><br>  it <br><pre> <code class="cs hljs">a.SelectMany(x =&gt; b, (x, y) =&gt; x + y);</code> </pre><br>  That is, by implementing an additional SelectMany view <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Maybe&lt;V&gt; SelectMany&lt;T, U, V&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Maybe&lt;T&gt; m, Func&lt;T, Maybe&lt;U&gt;&gt; k, Func&lt;T, U, V&gt; s) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m.SelectMany(x =&gt; k(x).SelectMany(y =&gt; s(x, y).ToMaybe())); }</code> </pre><br>  which just in itself also contains that double disclosure of containers, can write operations with Maybe in the form. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span>ToMaybe() <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>ToMaybe() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> x + y;</code> </pre><br><br><h4>  CPS (Continuation-passing style) </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CPS is essentially work with callbacks, that is, instead of using the normal calculation order <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = GetPage(<span class="hljs-string"><span class="hljs-string">"http://habrahabr.ru"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = Translate(x); Display(y);<span class="hljs-comment"><span class="hljs-comment">// Display  Console.WriteLine</span></span></code> </pre><br>  Each function has an additional parameter to which we pass the function to continue the calculation. <br><pre> <code class="cs hljs">GetPage(<span class="hljs-string"><span class="hljs-string">"http://habrahabr.ru"</span></span>, x =&gt; Translate(x, y =&gt; Display(y)));</code> </pre><br>  Often used if the function makes an asynchronous request somewhere and we do not want the thread to idle or to get a gui. <br>  Mixing the monad and CPS we get <br><h5>  Continuation monad </h5><br>  A more or less standard version of the monad, this is a function that accepts another function as input, we restrict ourselves to the simple case when the output from the continuation is void.  Then the monad can be represented as such delegates. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Cont&lt;T&gt;(Action&lt;T&gt; k);</code> </pre><br>  Functions at the input is a function k (continued), into which something like T is already transmitted. Here are our three familiar functions. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ContEx</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cont&lt;T&gt; ToCont&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> T <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> k =&gt; k(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cont&lt;T1&gt; SelectMany&lt;T, T1&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Cont&lt;T&gt; c, Func&lt;T, Cont&lt;T1&gt;&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> k =&gt; c(r =&gt; f(r )(k)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cont&lt;T2&gt; SelectMany&lt;T, T1, T2&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Cont&lt;T&gt; c, Func&lt;T, Cont&lt;T1&gt;&gt; f, Func&lt;T, T1, T2&gt; s) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.SelectMany(x =&gt; f(x).SelectMany(y =&gt; s(x, y).ToCont())); } }</code> </pre><br>  ToCont - in the continuation of k just pass the value.  SelectMany - we pull out r from the monad, pass it to the function f and call the new monad with the general continuation k. <br><br><h5>  Task </h5><br>  It's time to remember what Task is.  This is a container that contains a certain action in itself, the result of which can be obtained using the Result property by blocking the stream, or using the ContinueWith method in CPS. <br>  Create a task. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task = Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Factory.StartNew(() =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  10</span></span></code> </pre><br>  We get the result <br><pre> <code class="cs hljs">task.ContinueWith(task =&gt; Display(task.Result));</code> </pre><br>  Once there is a CPS in Task, you can try one to convert to another. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cont&lt;T&gt; ToCont&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Task&lt;T&gt; task) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> k =&gt; task.ContinueWith(task =&gt; k(task.Result)); }</code> </pre><br><br><h4>  Example task </h4><br>  Suppose we have three asynchronous services.  Get the content of the page by url, translate the text and make an analysis of the text the result of which will be a number. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;.Factory.StartNew(() =&gt; { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"get page start "</span></span> + url); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"get page complete"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"page content"</span></span>; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Translate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;.Factory.StartNew(() =&gt; { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"translate start"</span></span>); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"translate complete"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"text translation"</span></span>; }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Factory.StartNew(() =&gt; { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"analyse start"</span></span>); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">3000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"analyse complete"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>; }); }</code> </pre><br><br>  Imagine in your mind how the passage through these three functions in CPS will look like, horrified, and immediately use the link, converting the tasks into monads. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"www.example.com"</span></span></span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> y </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Translate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> z </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">y</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> z</span></span>; result(Display);</code> </pre><br>  If we need to get the translated page by url somewhere else, it can be put into a separate method <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Cont&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPageTranslation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> y </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Translate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> y</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPageTranslation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"http://habrahabr.ru"</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> a </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCont</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> a</span></span>; result(Display);</code> </pre><br>  Since ToCont is used everywhere, then why not try to get rid of the redundant entity. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Task&lt;T1&gt; SelectMany&lt;T, T1&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Task&lt;T&gt; c, Func&lt;T, Task&lt;T1&gt;&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.ContinueWith(task =&gt; f(task.Result)).Unwrap(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Task&lt;T2&gt; SelectMany&lt;T, T1, T2&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Task&lt;T&gt; c, Func&lt;T, Task&lt;T1&gt;&gt; f, Func&lt;T, T1, T2&gt; s) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.ContinueWith(t =&gt; f(t.Result).ContinueWith(x =&gt; s(t.Result, x.Result))).Unwrap(); }</code> </pre><br>  Unwrap is needed to deploy a type. <pre> <code class="cs hljs">Task&lt;Task&lt;T&gt;&gt;</code> </pre>  which is obtained by combining two tasks. <br>  Now removing all ToCont, you can get the same result. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTranslation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> y </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Translate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> y</span></span>; }</code> </pre><br>  So, we can assume that Task is essentially a continuation monad. <br>  Well and for example we will write function which returns for the list of url, the list of values ‚Äã‚ÄãAnalyze.  Think how it looked in CPS. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Task&lt;IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; Analyse(IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; list) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> url </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> list </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTranslation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> a </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Analyse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> a</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.Factory.ContinueWhenAll(result.ToArray(), x =&gt; x.Select(y =&gt; y.Result)); }</code> </pre><br>  ContinueWhenAll - waiting for all tasks to complete, to get all the results. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urls = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {<span class="hljs-string"><span class="hljs-string">"url1"</span></span>, <span class="hljs-string"><span class="hljs-string">"url2"</span></span>, <span class="hljs-string"><span class="hljs-string">"url3"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = Analyse(urls); r.ContinueWith(x =&gt; Console.WriteLine(x.Result.Sum()));</code> </pre><br><br><h4>  Conclusion </h4><br>  It is unlikely that all of this has any practical meaning, therefore this text can be considered as information for reflection from the category of abnormal programming.  Also, everyone can reflect on the interfaces IObservable and IObserver and the method IObserver.OnNext (T value) <br><br>  PS For good, it wouldn‚Äôt hurt to touch on the very same async with await, but I don‚Äôt have the desire to put ctp, so I have quite superficial ideas about them, but I think the point is not much different from the above, i.e. with tasks, but instead of a link, the computation flow conversion is used by the compiler. </div><p>Source: <a href="https://habr.com/ru/post/112464/">https://habr.com/ru/post/112464/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112458/index.html">A few tips on working with VBA in Excel</a></li>
<li><a href="../112459/index.html">How in the Ulyanovsk region "selected" the Minister of IT</a></li>
<li><a href="../112461/index.html">ArchBang Release 2011.01 - Symbiosis</a></li>
<li><a href="../112462/index.html">How do you feel about team building training for IT teams (extreme, rope courses)?</a></li>
<li><a href="../112463/index.html">Google Voice in Gmail</a></li>
<li><a href="../112466/index.html">AspectJ, Spring, Maven</a></li>
<li><a href="../112467/index.html">Give me the iron! Part 2</a></li>
<li><a href="../112468/index.html">Clean SEO. rest in peace</a></li>
<li><a href="../112469/index.html">Hosting 3D Viewpot Models</a></li>
<li><a href="../112470/index.html">British providers are going to make pay for warnings of users about copyright infringement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>