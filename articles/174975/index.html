<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ranking in Yandex: how to put machine learning on stream (post # 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue a series of publications about our FML framework , which automated the work with machine learning and allowed Yandex developers to use it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ranking in Yandex: how to put machine learning on stream (post # 2)</h1><div class="post__text post__text-html js-mediator-article"><img src="http://cho.justos.org:9119/counter.gif" width="1" height="1">  We continue a <a href="http://habrahabr.ru/search/%3Fq%3D%255BFML%255D%26target_type%3Dposts">series of publications about our FML framework</a> , which automated the work with machine learning and allowed Yandex developers to use it in their tasks easier and more often.  <a href="http://habrahabr.ru/company/yandex/blog/174213/">The previous post</a> talked about what the ranking function is and how we learned to build it, having only a fairly large number of assessments from assessors and a rather diverse set of features (factors) of documents for a large number of queries. <br><br>  From this post you will learn: <br><ol><li>  Why do we need to select a new ranking formula very often, and how exactly does FML help us in this; </li><li>  How we develop new factors and evaluate their effectiveness. </li></ol><img src="https://habrastorage.org/getpro/habr/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif"><br><img src="https://habrastorage.org/getpro/habr/post_images/845/329/b26/845329b261cc5bd13cf908f521cc1ba6.png" alt="image"><br><a name="habracut"></a><br><br><h4><a name="Formula"></a>  Selection of ranking formula </h4><br>  It's one thing to pick up a formula once, and quite another to do it very often.  And we will talk about the reasons why the second is so necessary in our realities. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As already <a href="http://habrahabr.ru/company/yandex/blog/174213/">mentioned</a> , the Internet is changing rapidly and we need to constantly improve the quality of search.  Our developers are constantly looking for new factors that could help us with this.  Our assessors evaluate thousands of documents every day in order to promptly teach algorithms for new types of patterns appearing on the Internet and take into account changes in the usefulness of previously evaluated documents.  The search robot collects a lot of fresh documents on the Internet, which constantly changes the average values ‚Äã‚Äãof factors.  Values ‚Äã‚Äãcan change even with fixed documents, as the algorithms for calculating factors and their implementation are constantly being improved. <br><br>  To quickly take into account in the ranking formula this stream of changes, we need a whole technological conveyor.  It is desirable that he did not require the participation of a person or was as simple as possible for him.  And it is very important that making some changes does not interfere with the assessment of the usefulness of others.  This is the pipeline that became FML.  While MatrixNet acts as the ‚Äúbrain‚Äù of machine learning, FML is a convenient service based on it, the use of which requires much less specialized knowledge and experience.  This is due to what is achieved. <br><br>  Firstly, for each specific task with which the developer comes to us, the FML recommends the launch parameters of MatrixNet, which best suit the conditions and constraints of the task.  The service itself selects settings that are optimal for a specific scope of assessments ‚Äî for example, it helps to select the objective function ( <a href="http://en.wikipedia.org/wiki/Learning_to_rank">pointwise or pairwise</a> ) depending on the size of the training sample. <br><br>  Secondly, FML provides transparent multitasking.  Each iteration of formula selection is a multi-hour calculation that requires a full load of several dozen servers.  As a rule, a dozen different formulas are selected at the same time, and the FML controls the load and ensures that each developer isolates his calculations from those of his colleagues so that they do not interfere with each other. <br><br>  Thirdly, unlike Matriksnet, which needs to be started manually, FML provides distributed execution of resource-intensive tasks on a cluster.  This includes the use of a single and most recent version of machine learning libraries by everyone, the layout of the program for all machines, the handling of failures that have occurred, the preservation of calculations already performed, and verification of the results in case of restarting calculations. <br><br>  Finally, we took advantage of the fact that on computationally demanding tasks, you can get very significant performance gains if you run them on graphics processors (GPUs) instead of general purpose processors (CPUs).  To do this, we adapted Matriksnet for GPU, due to which we received more than 20-fold gain in speed of calculations per unit cost of equipment.  The features of our implementation of the decision tree construction algorithm allow us to use the high degree of parallelism available on the GPU.  Due to the fact that we retained the software interfaces used by FML, we were able to provide our colleagues working on the factors with new computational capabilities without changing the usual development processes. <br><br><div class="spoiler">  <b class="spoiler_title">A few words about the GPU</b> <div class="spoiler_text">  In general, the advantage of GPU processors over the CPU is revealed on tasks with a large proportion of floating-point calculations, and machine learning is not distinguished from them.  Computational performance is measured in IOPS for integer calculations and FLOPS for floating point calculations.  And, if we take out for brackets all the costs of I / O, including communication with memory, it is precisely in the FLOPS parameter that the graphics processors have long gone far ahead compared to conventional ones.  On some classes of tasks, the performance gain compared to general-purpose processors (CPUs) is hundreds of times. <br><br>  But <a href="http://superuser.com/questions/308771/why-are-we-still-using-cpus-instead-of-gpus">precisely because</a> not all popular algorithms are suitable for the computing architecture of the GPU and not all programs need a large number of floating point calculations, the entire industry continues to use the CPU, and does not switch to the GPU. </div></div><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed9/5ee/126/ed95ee1265294c434644a1bee904b5c6.jpg" alt="image"><br><br><a name="GPUcluster"></a><div class="spoiler">  <b class="spoiler_title">About our GPU cluster and supercomputers</b> <div class="spoiler_text">  Right now, the performance of a GPU cluster in Yandex is 80 Tflops, but soon we plan to expand it to 300 Tflops.  We do not call our cluster a <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2583%25D0%25BF%25D0%25B5%25D1%2580%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580">supercomputer</a> , although in essence it is one.  For example, in terms of element base, it is very close to the Lomonosov supercomputer, the most powerful in Russia and Eastern Europe.  A number of components in our case, even more modern.  And although we are inferior to Lomonosov in the number of compute nodes (and therefore performance), after expansion, our cluster is likely to be included in the first hundred of the most powerful in the <a href="http://www.top500.org/lists/2012/11/">world TOP500 Supercomputer Sites world ranking</a> and in the top five of the <a href="http://www.top500.org/statistics/sublist/">most powerful supercomputers in Russia</a> . </div></div><br><br><h4><a name="Factors"></a>  Development of new factors and assessment of their effectiveness </h4><br>  Factors in ranking play an even more important role than the ability to select a formula.  After all, the more diverse the signs will be to distinguish between different documents, the more effective the ranking function can be.  In an effort to improve the quality of the search, we are constantly looking for what new factors could help us. <br><br>  Their creation is a very complicated process.  Not every idea stands the test of practice in it.  Sometimes it can take several months to develop and set up a good factor, and the percentage of hypotheses that have been proven by practice is extremely small.  Like Mayakovsky: <a href="http://yandex.ru/yandsearch%3Flr%3D213%26msid%3D22878.11995.1363348343.69812%26text%3D%25D0%25B2%2B%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%2B%25D0%25B4%25D0%25BE%25D0%25B1%25D1%258B%25D1%2587%25D0%25B0%252C%2B%25D0%25B2%2B%25D0%25B3%25D0%25BE%25D0%25B4%2B%25D1%2582%25D1%2580%25D1%2583%25D0%25B4%25D1%258B">"In gram production, in the year of labor</a> . <a href="http://yandex.ru/yandsearch%3Flr%3D213%26msid%3D22878.11995.1363348343.69812%26text%3D%25D0%25B2%2B%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%2B%25D0%25B4%25D0%25BE%25D0%25B1%25D1%258B%25D1%2587%25D0%25B0%252C%2B%25D0%25B2%2B%25D0%25B3%25D0%25BE%25D0%25B4%2B%25D1%2582%25D1%2580%25D1%2583%25D0%25B4%25D1%258B">"</a>  For the first year of operation, FML for tens of thousands of checks of various factors with different combinations of parameters were allowed to be implemented only a few hundred. <br><br>  For a long time in Yandex, in order to work on the factors, it was necessary, firstly, to deeply understand the search device in general and ours in particular, and, secondly, to have a good knowledge of machine learning and information search in general.  The emergence of FML allowed to get rid of the first requirement, significantly reducing the threshold for entering the development of factors.  The number of specialists who can now deal with it has increased by an order of magnitude. <br><br>  But in a large team, the transparency of the development process was required.  Previously, each was limited to only checks that he himself considered sufficient, and the quality was measured by eye.  As a result, obtaining a good factor turned out to be rather an object of art.  And if the factor hypothesis was rejected, then after the passage of time it was impossible to get acquainted with the tests for which the decision was made. <br><br>  With the advent of FML, development of factors has become a standard, measurable and controllable process in a large team.  There was a cross-transparency, when everyone could see what their colleagues were doing, and the ability to control the quality of previous experiments.  In addition, we received such a quality control system of the produced factors, which allows for a poor result with a much lower probability than at the world's leading conferences in the field of information retrieval. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f99/11c/c51/f9911cc51fdd53163f0a2ade99a05d01.png" alt="image"><br><br>  To assess the quality of the factor, we do the following.  We divide (each time in a new random way) the set of assessments we have into two parts: the training and the test.  According to the training estimates, we select two formulas - the old one (without the tested factor) and the new one (with it), and by the test formulas - we see which of these formulas is better.  The procedure is repeated many times on a large number of different partitions of our estimates.  In statistics, this process is called <a href="http://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> .  It allows us to make sure that the quality of the new formula is better than the old one.  In machine learning, this method is known as <a href="http://en.wikipedia.org/wiki/Feature_selection">dimension reduction using wrappers</a> .  If it turns out that, on average, a new formula gives a noticeable improvement in quality compared to the old one, a new factor may become a candidate for implementation. <br><br>  But even if the factor has proved its usefulness, you need to understand what the price of its implementation and use.  It includes not only the time that the developer spent on the elaboration of the idea, its implementation and customization.  Many factors need to be calculated directly at the time of the search - for each of the thousands of documents found on request.  Therefore, each new factor is a potential slowdown in the speed of the response of the search engine, and we make sure that it remains in a very rigid framework.  This means that the introduction of each new factor should be ensured by an increase in the power of the cluster that responds to user requests.  There are other hardware resources that cannot be used endlessly.  For example, the cost of storing in memory of each additional <i>byte</i> per document on the search cluster is about $ 10,000 per year. <br><br>  Thus, it is important for us to select from many potential factors only those in which the ratio of quality gains to equipment costs will be the best - and discard the rest.  It is precisely in the measurement of the increase in quality and the assessment of the volume of additional costs that the task of the FML following the selection of formulas consists. <br><br><div class="spoiler">  <b class="spoiler_title">Price of measurement and its accuracy</b> <div class="spoiler_text">  According to our statistics, the assessment of the quality of factors before their introduction takes significantly more computational time than the selection of the formulas themselves.  Including because the ranking formula needs to be repeatedly picked up for each factor.  For example, over the past year, about 10 million machine hours were spent on about 50,000 checks, and about 2 million on the selection of ranking formulas. That is, most of the cluster time is spent on research, rather than on regular reassignment of formulas. <br><br>  As in any mature market, each new improvement is given much harder than the previous one, and each next ‚Äúnine‚Äù in quality is multiply more expensive than the previous one.  We account for tenths and hundredths of a percent of the target quality metric (in our case, this is <a href="http://romip.ru/romip2009/15_yandex.pdf">pFound</a> ).  In such conditions, quality measurement devices must be sufficiently accurate to confidently record even such small changes. </div></div><br>  Speaking of hardware resources, we estimate three components: the computational cost, the disk size and the amount of RAM.  Over time, we even developed ‚Äúexchange rates‚Äù: how much we can degrade performance, how many bytes of disk or RAM are willing to pay for quality improvement by 1%.  Memory consumption is estimated experimentally, the quality gain is taken from FML, and the decrease in performance is estimated from the results of individual load testing.  However, some aspects cannot be estimated automatically - for example, does the factor not bring in a strong feedback.  For this reason, there is expert advice, which has the right of veto on the introduction of the factor. <br><br>  When it comes time to implement a formula built using new factors, we conduct <a href="http://en.wikipedia.org/wiki/A/B_testing">A / B testing</a> - an experiment on a small percentage of users.  It is needed to make sure that the new rankings ‚Äúlike‚Äù them more than the current one.  The final implementation decision is made based on <a href="http://www.cs.cornell.edu/people/tj/publications/chapelle_etal_12a.pdf">custom quality metrics</a> .  Dozens of experiments are being conducted at Yandex at any time, and we are trying to make this process invisible to search engine users.  Thus, we achieve not only the mathematical validity of the decisions made, but also the usefulness of innovations in practice. <img src="https://habrastorage.org/getpro/habr/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif"><br><br>  So, FML allowed putting on stream development of factors in Yandex and enabled their developers to get an answer to the question of whether a new factor is good enough for consideration for implementation in a understandable and regulated manner and relatively small efforts.  How we make sure that the quality of the factor does not degrade over time, we will tell in the <a href="http://habrahabr.ru/company/yandex/blog/175917/">next - last - post</a> .  From it you will learn about <a href="http://habrahabr.ru/company/yandex/blog/175917/">where</a> our machine learning technology is <a href="http://habrahabr.ru/company/yandex/blog/175917/">still applicable</a> . </div><p>Source: <a href="https://habr.com/ru/post/174975/">https://habr.com/ru/post/174975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174965/index.html">25-dollar Raspberry Pi went on sale in the USA</a></li>
<li><a href="../174967/index.html">Festo developers have created a dragonfly robot (video)</a></li>
<li><a href="../174969/index.html">Nokia Lumia 920 against the spring sun</a></li>
<li><a href="../174971/index.html">Layout letters. Bugs again</a></li>
<li><a href="../174973/index.html">New version of Yandex.Navigator: Expanded coverage of 3D map mode</a></li>
<li><a href="../174977/index.html">Paginator (page navigation) on XSLT</a></li>
<li><a href="../174979/index.html">Yii2 migrates from PHP to Ruby (April Fool's joke)</a></li>
<li><a href="../174983/index.html">Presentation of RADWARE equipment in Kiev</a></li>
<li><a href="../174987/index.html">ACE: the most functional code editor</a></li>
<li><a href="../174991/index.html">Bitcoin: now for $ 100 each (not April 1st), and Avalon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>